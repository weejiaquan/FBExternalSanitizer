{"created_by":"Tampermonkey","version":"1","scripts":[{"name":"Local YouTube Downloader","options":{"awareOfChrome":false,"check_for_updates":true,"comment":null,"compat_arrayleft":false,"compat_foreach":false,"compat_forvarin":false,"compat_metadata":false,"compat_uW_gmonkey":false,"compat_wrappedjsobject":false,"compatopts_for_requires":true,"noframes":null,"override":{"merge_connects":true,"merge_excludes":true,"merge_includes":true,"merge_matches":true,"orig_connects":["googlevideo.com"],"orig_excludes":[],"orig_includes":[],"orig_matches":["https://*.youtube.com/*"],"orig_noframes":null,"orig_run_at":"document-idle","use_blockers":[],"use_connects":[],"use_excludes":[],"use_includes":[],"use_matches":[]},"run_at":null},"storage":{"ts":1579671942971,"data":{}},"enabled":true,"position":1,"file_url":"https://greasyfork.org/scripts/369400-local-youtube-downloader/code/Local%20YouTube%20Downloader.user.js","uuid":"6e3eaf92-9084-44f3-8c2e-f4c62e7e834e","source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICBMb2NhbCBZb3VUdWJlIERvd25sb2FkZXIKLy8gQG5hbWU6emgtVFcgICDmnKzlnLAgWW91VHViZSDkuIvovInlmagKLy8gQG5hbWU6emgtQ04gICDmnKzlnLAgWW91VHViZSDkuIvovb3lmagKLy8gQG5hbWVzcGFjZSAgICBodHRwczovL2Jsb2cubWFwbGUzMTQyLm5ldC8KLy8gQHZlcnNpb24gICAgICAwLjkuMTcKLy8gQGRlc2NyaXB0aW9uICBHZXQgeW91dHViZSByYXcgbGluayB3aXRob3V0IGV4dGVybmFsIHNlcnZpY2UuCi8vIEBkZXNjcmlwdGlvbjp6aC1UVyAg5LiN6ZyA6KaB6YCP6YGO56ys5LiJ5pa555qE5pyN5YuZ5bCx6IO95LiL6LyJIFlvdVR1YmUg5b2x54mH44CCCi8vIEBkZXNjcmlwdGlvbjp6aC1DTiAg5LiN6ZyA6KaB6YCP6L+H56ys5LiJ5pa555qE5pyN5Yqh5bCx6IO95LiL6L29IFlvdVR1YmUg5b2x54mH44CCCi8vIEBhdXRob3IgICAgICAgbWFwbGUzMTQyCi8vIEBtYXRjaCAgICAgICAgaHR0cHM6Ly8qLnlvdXR1YmUuY29tLyoKLy8gQHJlcXVpcmUgICAgICBodHRwczovL3VucGtnLmNvbS92dWVAMi42LjEwL2Rpc3QvdnVlLmpzCi8vIEByZXF1aXJlICAgICAgaHR0cHM6Ly91bnBrZy5jb20veGZldGNoLWpzQDAuMy40L3hmZXRjaC5taW4uanMKLy8gQHJlcXVpcmUgICAgICBodHRwczovL3VucGtnLmNvbS9AZmZtcGVnL2ZmbXBlZ0AwLjUuMi9kaXN0L2ZmbXBlZy5taW4uanMKLy8gQGdyYW50ICAgICAgICBHTV94bWxodHRwUmVxdWVzdAovLyBAY29ubmVjdCAgICAgIGdvb2dsZXZpZGVvLmNvbQovLyBAY29tcGF0aWJsZSAgIGZpcmVmb3ggPj01MgovLyBAY29tcGF0aWJsZSAgIGNocm9tZSA+PTU1Ci8vIEBsaWNlbnNlICAgICAgTUlUCi8vID09L1VzZXJTY3JpcHQ9PQoKOyhmdW5jdGlvbigpIHsKCSd1c2Ugc3RyaWN0JwoJY29uc3QgREVCVUcgPSB0cnVlCgljb25zdCBSRVNUT1JFX09SSUdJTkFMX1RJVExFX0ZPUl9DVVJSRU5UX1ZJREVPID0gdHJ1ZQoJY29uc3QgY3JlYXRlTG9nZ2VyID0gKGNvbnNvbGUsIHRhZykgPT4KCQlPYmplY3Qua2V5cyhjb25zb2xlKQoJCQkubWFwKGsgPT4gWwoJCQkJaywKCQkJCSguLi5hcmdzKSA9PgoJCQkJCURFQlVHCgkJCQkJCT8gY29uc29sZVtrXSh0YWcgKyAnOiAnICsgYXJnc1swXSwgLi4uYXJncy5zbGljZSgxKSkKCQkJCQkJOiB2b2lkIDAKCQkJXSkKCQkJLnJlZHVjZSgoYWNjLCBbaywgZm5dKSA9PiAoKGFjY1trXSA9IGZuKSwgYWNjKSwge30pCgljb25zdCBsb2dnZXIgPSBjcmVhdGVMb2dnZXIoY29uc29sZSwgJ1lUREwnKQoJY29uc3Qgc2xlZXAgPSBtcyA9PiBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIG1zKSkKCgljb25zdCBMQU5HX0ZBTExCQUNLID0gJ2VuJwoJY29uc3QgTE9DQUxFID0gewoJCWVuOiB7CgkJCXRvZ2dsZWxpbmtzOiAnU2hvdy9IaWRlIExpbmtzJywKCQkJc3RyZWFtOiAnU3RyZWFtJywKCQkJYWRhcHRpdmU6ICdBZGFwdGl2ZScsCgkJCXZpZGVvaWQ6ICdWaWRlbyBJZDogJywKCQkJaW5icm93c2VyX2FkYXB0aXZlX21lcmdlcjoKCQkJCSdJbiBicm93c2VyIGFkYXB0aXZlIHZpZGVvICYgYXVkaW8gbWVyZ2VyIChGRm1wZWcpJywKCQkJZGxtcDQ6ICdEb3dubG9hZCBoaWdoZXN0IHJlc29sdXRpb24gbXA0IGluIG9uZSBjbGljaycKCQl9LAoJCSd6aC10dyc6IHsKCQkJdG9nZ2xlbGlua3M6ICfpoa/npLogLyDpmrHol4/pgKPntZAnLAoJCQlzdHJlYW06ICfkuLLmtYEgU3RyZWFtJywKCQkJYWRhcHRpdmU6ICfoh6rpganmh4kgQWRhcHRpdmUnLAoJCQl2aWRlb2lkOiAn5b2x54mHIElEOiAnLAoJCQlpbmJyb3dzZXJfYWRhcHRpdmVfbWVyZ2VyOgoJCQkJJ+eAj+imveWZqOeJiOiHqumBqeaHieW9seeJh+WPiuiBsumfs+WQiOaIkOWZqCAoRkZtcGVnKScsCgkJCWRsbXA0OiAn5LiA6Y215LiL6LyJ6auY55Wr6LOqIG1wNCcKCQl9LAoJCXpoOiB7CgkJCXRvZ2dsZWxpbmtzOiAn5pi+56S6IC8g6ZqQ6JeP6ZO+5o6lJywKCQkJc3RyZWFtOiAn5Liy5rWBIFN0cmVhbScsCgkJCWFkYXB0aXZlOiAn6Ieq6YCC5bqUIEFkYXB0aXZlJywKCQkJdmlkZW9pZDogJ+inhumikSBJRDogJywKCQkJaW5icm93c2VyX2FkYXB0aXZlX21lcmdlcjoKCQkJCSfmtY/op4jlmajniYjoh6rpgILlupTop4bpopHlj4rlo7Dpn7PlkIjmiJDlmaggKEZGbXBlZyknLAoJCQlkbG1wNDogJ+S4gOmUruS4i+i9vemrmOeUu+i0qCBtcDQnCgkJfSwKCQlrcjogewoJCQl0b2dnbGVsaW5rczogJ+unge2BrCDrs7TsnbTquLAv7Iio6riw6riwJywKCQkJc3RyZWFtOiAn7Iqk7Yq466as67CNJywKCQkJYWRhcHRpdmU6ICfsobDsoJUg6rCA64ql7ZWcJywKCQkJdmlkZW9pZDogJ1ZpZGVvIElkOiAnCgkJfSwKCQllczogewoJCQl0b2dnbGVsaW5rczogJ01vc3RyYXIvT2N1bHRhciBMaW5rcycsCgkJCXN0cmVhbTogJ1N0cmVhbScsCgkJCWFkYXB0aXZlOiAnQWRhcHRhYmxlJywKCQkJdmlkZW9pZDogJ0lkIGRlbCBWaWRlbzogJywKCQkJaW5icm93c2VyX2FkYXB0aXZlX21lcmdlcjogJ0Fjb3BsYXIgQXVkaW8gYSBWaWRlbyAoRkZtcGVnKScKCQl9LAoJCWhlOiB7CgkJCXRvZ2dsZWxpbmtzOiAn15TXpteSL9eU16HXqteoINen15nXqdeV16jXmdedJywKCQkJc3RyZWFtOiAn16HXmNeo15nXnScsCgkJCWFkYXB0aXZlOiAn15DXk9ek15jXmdeR15knLAoJCQl2aWRlb2lkOiAn157XlteU15Qg16HXqNeY15XXnzogJwoJCX0KCX0KCWNvbnN0IGZpbmRMYW5nID0gbCA9PiB7CgkJLy8gbGFuZ3VhZ2UgcmVzb2x1dGlvbiBsb2dpYzogemgtdHcgLS0oaWYgbm90IGV4aXN0cyktLT4gemggLS0oaWYgbm90IGV4aXN0cyktLT4gTEFOR19GQUxMQkFDSyhlbikKCQlsID0gbC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ18nLCAnLScpCgkJaWYgKGwgaW4gTE9DQUxFKSByZXR1cm4gbAoJCWVsc2UgaWYgKGwubGVuZ3RoID4gMikgcmV0dXJuIGZpbmRMYW5nKGwuc3BsaXQoJy0nKVswXSkKCQllbHNlIHJldHVybiBMQU5HX0ZBTExCQUNLCgl9Cgljb25zdCAkID0gKHMsIHggPSBkb2N1bWVudCkgPT4geC5xdWVyeVNlbGVjdG9yKHMpCgljb25zdCAkZWwgPSAodGFnLCBvcHRzKSA9PiB7CgkJY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZykKCQlPYmplY3QuYXNzaWduKGVsLCBvcHRzKQoJCXJldHVybiBlbAoJfQoJY29uc3QgZXNjYXBlUmVnRXhwID0gcyA9PiBzLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXVxcXS9nLCAnXFwkJicpCgljb25zdCBwYXJzZURlY3NpZyA9IGRhdGEgPT4gewoJCXRyeSB7CgkJCWlmIChkYXRhLnN0YXJ0c1dpdGgoJ3ZhciBzY3JpcHQnKSkgewoJCQkJLy8gdGhleSBpbmplY3QgdGhlIHNjcmlwdCB2aWEgc2NyaXB0IHRhZwoJCQkJY29uc3Qgb2JqID0ge30KCQkJCWNvbnN0IGRvY3VtZW50ID0gewoJCQkJCWNyZWF0ZUVsZW1lbnQ6ICgpID0+IG9iaiwKCQkJCQloZWFkOiB7IGFwcGVuZENoaWxkOiAoKSA9PiB7fSB9CgkJCQl9CgkJCQlldmFsKGRhdGEpCgkJCQlkYXRhID0gb2JqLmlubmVySFRNTAoJCQl9CgkJCWNvbnN0IGZubmFtZXJlc3VsdCA9IC89KFthLXpBLVowLTlcJF0rPylcKGRlY29kZVVSSUNvbXBvbmVudC8uZXhlYygKCQkJCWRhdGEKCQkJKQoJCQljb25zdCBmbm5hbWUgPSBmbm5hbWVyZXN1bHRbMV0KCQkJY29uc3QgX2FyZ25hbWVmbmJvZHlyZXN1bHQgPSBuZXcgUmVnRXhwKAoJCQkJZXNjYXBlUmVnRXhwKGZubmFtZSkgKyAnPWZ1bmN0aW9uXFwoKC4rPylcXCl7KC4rPyl9JwoJCQkpLmV4ZWMoZGF0YSkKCQkJY29uc3QgW18sIGFyZ25hbWUsIGZuYm9keV0gPSBfYXJnbmFtZWZuYm9keXJlc3VsdAoJCQljb25zdCBoZWxwZXJuYW1lcmVzdWx0ID0gLzsoLis/KVwuLis/XCgvLmV4ZWMoZm5ib2R5KQoJCQljb25zdCBoZWxwZXJuYW1lID0gaGVscGVybmFtZXJlc3VsdFsxXQoJCQljb25zdCBoZWxwZXJyZXN1bHQgPSBuZXcgUmVnRXhwKAoJCQkJJ3ZhciAnICsgZXNjYXBlUmVnRXhwKGhlbHBlcm5hbWUpICsgJz17W1xcc1xcU10rP307JwoJCQkpLmV4ZWMoZGF0YSkKCQkJY29uc3QgaGVscGVyID0gaGVscGVycmVzdWx0WzBdCgkJCWxvZ2dlci5sb2coCgkJCQlgcGFyc2VkZWNzaWcgcmVzdWx0OiAlcz0+eyVzXG4lc31gLAoJCQkJYXJnbmFtZSwKCQkJCWhlbHBlciwKCQkJCWZuYm9keQoJCQkpCgkJCXJldHVybiBuZXcgRnVuY3Rpb24oW2FyZ25hbWVdLCBoZWxwZXIgKyAnXG4nICsgZm5ib2R5KQoJCX0gY2F0Y2ggKGUpIHsKCQkJbG9nZ2VyLmVycm9yKCdwYXJzZWRlY3NpZyBlcnJvcjogJW8nLCBlKQoJCQlsb2dnZXIuaW5mbygnc2NyaXB0IGNvbnRlbnQ6ICVzJywgZGF0YSkKCQkJbG9nZ2VyLmluZm8oCgkJCQknSWYgeW91IGVuY291bnRlciB0aGlzIGVycm9yLCBwbGVhc2UgY29weSB0aGUgZnVsbCAic2NyaXB0IGNvbnRlbnQiIHRvIGh0dHBzOi8vcGFzdGViaW4uY29tLyBmb3IgbWUuJwoJCQkpCgkJfQoJfQoJY29uc3QgcGFyc2VRdWVyeSA9IHMgPT4KCQlbLi4ubmV3IFVSTFNlYXJjaFBhcmFtcyhzKS5lbnRyaWVzKCldLnJlZHVjZSgKCQkJKGFjYywgW2ssIHZdKSA9PiAoKGFjY1trXSA9IHYpLCBhY2MpLAoJCQl7fQoJCSkKCWNvbnN0IGdldFZpZGVvID0gYXN5bmMgKGlkLCBkZWNzaWcpID0+IHsKCQlyZXR1cm4geGYKCQkJLmdldCgKCQkJCWBodHRwczovL3d3dy55b3V0dWJlLmNvbS9nZXRfdmlkZW9faW5mbz92aWRlb19pZD0ke2lkfSZlbD1kZXRhaWxwYWdlYAoJCQkpCgkJCS50ZXh0KCkKCQkJLnRoZW4oYXN5bmMgZGF0YSA9PiB7CgkJCQljb25zdCBvYmogPSBwYXJzZVF1ZXJ5KGRhdGEpCgkJCQljb25zdCBwbGF5ZXJSZXNwb25zZSA9IEpTT04ucGFyc2Uob2JqLnBsYXllcl9yZXNwb25zZSkKCQkJCWxvZ2dlci5sb2coYHZpZGVvICVzIGRhdGE6ICVvYCwgaWQsIG9iaikKCQkJCWxvZ2dlci5sb2coYHZpZGVvICVzIHBsYXllclJlc3BvbnNlOiAlb2AsIGlkLCBwbGF5ZXJSZXNwb25zZSkKCQkJCWlmIChvYmouc3RhdHVzID09PSAnZmFpbCcpIHsKCQkJCQl0aHJvdyBvYmoKCQkJCX0KCQkJCWxldCBzdHJlYW0gPSBbXQoJCQkJaWYgKHBsYXllclJlc3BvbnNlLnN0cmVhbWluZ0RhdGEuZm9ybWF0cykgewoJCQkJCXN0cmVhbSA9IHBsYXllclJlc3BvbnNlLnN0cmVhbWluZ0RhdGEuZm9ybWF0cy5tYXAoeCA9PgoJCQkJCQlPYmplY3QuYXNzaWduKHgsIHBhcnNlUXVlcnkoeC5jaXBoZXIpKQoJCQkJCSkKCQkJCQlsb2dnZXIubG9nKGB2aWRlbyAlcyBzdHJlYW06ICVvYCwgaWQsIHN0cmVhbSkKCQkJCQlpZiAoc3RyZWFtWzBdLnNwICYmIHN0cmVhbVswXS5zcC5pbmNsdWRlcygnc2lnJykpIHsKCQkJCQkJc3RyZWFtID0gc3RyZWFtCgkJCQkJCQkubWFwKHggPT4gKHsgLi4ueCwgczogZGVjc2lnKHgucykgfSkpCgkJCQkJCQkubWFwKHggPT4gKHsgLi4ueCwgdXJsOiB4LnVybCArIGAmc2lnPSR7eC5zfWAgfSkpCgkJCQkJfQoJCQkJfQoKCQkJCWxldCBhZGFwdGl2ZSA9IFtdCgkJCQlpZiAocGxheWVyUmVzcG9uc2Uuc3RyZWFtaW5nRGF0YS5hZGFwdGl2ZUZvcm1hdHMpIHsKCQkJCQlhZGFwdGl2ZSA9IHBsYXllclJlc3BvbnNlLnN0cmVhbWluZ0RhdGEuYWRhcHRpdmVGb3JtYXRzLm1hcCgKCQkJCQkJeCA9PiBPYmplY3QuYXNzaWduKHgsIHBhcnNlUXVlcnkoeC5jaXBoZXIpKQoJCQkJCSkKCQkJCQlsb2dnZXIubG9nKGB2aWRlbyAlcyBhZGFwdGl2ZTogJW9gLCBpZCwgYWRhcHRpdmUpCgkJCQkJaWYgKGFkYXB0aXZlWzBdLnNwICYmIGFkYXB0aXZlWzBdLnNwLmluY2x1ZGVzKCdzaWcnKSkgewoJCQkJCQlhZGFwdGl2ZSA9IGFkYXB0aXZlCgkJCQkJCQkubWFwKHggPT4gKHsgLi4ueCwgczogZGVjc2lnKHgucykgfSkpCgkJCQkJCQkubWFwKHggPT4gKHsgLi4ueCwgdXJsOiB4LnVybCArIGAmc2lnPSR7eC5zfWAgfSkpCgkJCQkJfQoJCQkJfQoJCQkJbG9nZ2VyLmxvZyhgdmlkZW8gJXMgcmVzdWx0OiAlb2AsIGlkLCB7IHN0cmVhbSwgYWRhcHRpdmUgfSkKCQkJCXJldHVybiB7IHN0cmVhbSwgYWRhcHRpdmUsIG1ldGE6IG9iaiB9CgkJCX0pCgl9Cgljb25zdCBnZXRWaWRlb0RldGFpbHMgPSBpZCA9PgoJCXhmCgkJCS5nZXQoJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3lvdXR1YmUvdjMvdmlkZW9zJywgewoJCQkJcXM6IHsKCQkJCQlrZXk6ICdBSXphU3lBX3pkZndFeTJVTGZQQ1Rsd2s5RGZoQlZzMkg1cUdOVTgnLAoJCQkJCXBhcnQ6ICdzbmlwcGV0JywKCQkJCQlpZAoJCQkJfQoJCQl9KQoJCQkuanNvbihyID0+IHIuaXRlbXNbMF0pCgljb25zdCB3b3JrZXJNZXNzYWdlSGFuZGxlciA9IGFzeW5jIGUgPT4gewoJCWNvbnN0IGRlY3NpZyA9IGF3YWl0IHhmLmdldChlLmRhdGEucGF0aCkudGV4dChwYXJzZURlY3NpZykKCQljb25zdCByZXN1bHQgPSBhd2FpdCBnZXRWaWRlbyhlLmRhdGEuaWQsIGRlY3NpZykKCQlzZWxmLnBvc3RNZXNzYWdlKHJlc3VsdCkKCX0KCWNvbnN0IHl0ZGxXb3JrZXJDb2RlID0gYAppbXBvcnRTY3JpcHRzKCdodHRwczovL3VucGtnLmNvbS94ZmV0Y2gtanNAMC4zLjQveGZldGNoLm1pbi5qcycpCmNvbnN0IERFQlVHPSR7REVCVUd9CmNvbnN0IGxvZ2dlcj0oJHtjcmVhdGVMb2dnZXJ9KShjb25zb2xlLCAnWVRETCcpCmNvbnN0IGVzY2FwZVJlZ0V4cD0ke2VzY2FwZVJlZ0V4cH0KY29uc3QgcGFyc2VRdWVyeT0ke3BhcnNlUXVlcnl9CmNvbnN0IHBhcnNlRGVjc2lnPSR7cGFyc2VEZWNzaWd9CmNvbnN0IGdldFZpZGVvPSR7Z2V0VmlkZW99CnNlbGYub25tZXNzYWdlPSR7d29ya2VyTWVzc2FnZUhhbmRsZXJ9YAoJY29uc3QgeXRkbFdvcmtlciA9IG5ldyBXb3JrZXIoCgkJVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbeXRkbFdvcmtlckNvZGVdKSkKCSkKCWNvbnN0IHdvcmtlckdldFZpZGVvID0gKGlkLCBwYXRoKSA9PiB7CgkJbG9nZ2VyLmxvZyhgd29ya2VyR2V0VmlkZW8gc3RhcnQ6ICVzICVzYCwgaWQsIHBhdGgpCgkJcmV0dXJuIG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4gewoJCQljb25zdCBjYWxsYmFjayA9IGUgPT4gewoJCQkJeXRkbFdvcmtlci5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgY2FsbGJhY2spCgkJCQlsb2dnZXIubG9nKCd3b3JrZXJHZXRWaWRlbyBlbmQ6ICVvJywgZS5kYXRhKQoJCQkJcmVzKGUuZGF0YSkKCQkJfQoJCQl5dGRsV29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBjYWxsYmFjaykKCQkJeXRkbFdvcmtlci5wb3N0TWVzc2FnZSh7IGlkLCBwYXRoIH0pCgkJfSkKCX0KCgkvLyB2aWRlbyBkb3dubG9hZGVyCgljb25zdCB4aHJEb3dubG9hZEJ1ZmZlciA9ICh1cmwsIHByb2dyZXNzQ2IpID0+IHsKCQlsZXQgY29udHJvbCwgb3V0cmVqCgkJY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4gewoJCQlpZiAodHlwZW9mIEdNX3htbGh0dHBSZXF1ZXN0ID09PSAndW5kZWZpbmVkJykgewoJCQkJcmV0dXJuIGFsZXJ0KAoJCQkJCSJZb3VyIHVzZXJzY3JpcHQgbWFuYWdlciBkb2Vzbid0IHN1cHBvcnQgdGhpcyBmZWF0dXJlLiIKCQkJCSkKCQkJfQoJCQkvLyB1c2UgZ214aHIgdG8gYnlwYXNzIENPUlMgcHJvYmxlbSB3aGVuIGNvbWluZyBmcm9tIGhvbWUgcGFnZQoJCQljb25zdCBzdGFydCA9IERhdGUubm93KCkKCQkJY29uc3QgeGhyID0ge30KCQkJeGhyLnJlc3BvbnNlVHlwZSA9ICdhcnJheWJ1ZmZlcicKCQkJeGhyLm9ubG9hZCA9IHJlc3AgPT4gcmVzKHJlc3AucmVzcG9uc2UpCgkJCXhoci5vbmVycm9yID0gcmVqCgkJCXhoci5vbnByb2dyZXNzID0gZSA9PiB7CgkJCQlpZiAoIWUubGVuZ3RoQ29tcHV0YWJsZSkgcmV0dXJuCgkJCQljb25zdCBkdCA9IChEYXRlLm5vdygpIC0gc3RhcnQpIC8gMTAwMCAvLyB1bml0OiBzZWNvbmQKCQkJCXByb2dyZXNzQ2IoewoJCQkJCXRvdGFsOiBlLnRvdGFsLCAvLyBieXRlcwoJCQkJCWxvYWRlZDogZS5sb2FkZWQsIC8vIGJ5dGVzCgkJCQkJc3BlZWQ6IGUubG9hZGVkIC8gZHQgLy8gYnl0ZXMvcwoJCQkJfSkKCQkJfQoJCQl4aHIubWV0aG9kID0gJ0dFVCcKCQkJeGhyLnVybCA9IHVybAoKCQkJLy8gYWJvcnQgaGFjawoJCQljb250cm9sID0gR01feG1saHR0cFJlcXVlc3QoeGhyKQoJCQlvdXRyZWogPSByZWoKCQl9KQoJCXByb21pc2UuYWJvcnQgPSAoKSA9PiB7CgkJCWNvbnRyb2wuYWJvcnQoKQoJCQlvdXRyZWooJ2Fib3J0ZWQnKQoJCX0KCQlyZXR1cm4gcHJvbWlzZQoJfQoKCWNvbnN0IGZmV29ya2VyID0gRkZtcGVnLmNyZWF0ZVdvcmtlcih7CgkJbG9nZ2VyOiBERUJVRyA/IG0gPT4gbG9nZ2VyLmxvZyhtLm1lc3NhZ2UpIDogKCkgPT4ge30KCX0pCglsZXQgZmZXb3JrZXJMb2FkZWQgPSBmYWxzZQoJY29uc3QgbWVyZ2VWaWRlbyA9IGFzeW5jICh2aWRlbywgYXVkaW8pID0+IHsKCQlpZiAoIWZmV29ya2VyTG9hZGVkKSBhd2FpdCBmZldvcmtlci5sb2FkKCkKCQlhd2FpdCBmZldvcmtlci53cml0ZSgndmlkZW8ubXA0JywgdmlkZW8pCgkJYXdhaXQgZmZXb3JrZXIud3JpdGUoJ2F1ZGlvLm1wNCcsIGF1ZGlvKQoJCWF3YWl0IGZmV29ya2VyLnJ1bigKCQkJJy1pIC9kYXRhL3ZpZGVvLm1wNCAtaSAvZGF0YS9hdWRpby5tcDQgLWMgY29weSBvdXRwdXQubXA0JywKCQkJewoJCQkJaW5wdXQ6IFsndmlkZW8ubXA0JywgJ2F1ZGlvLm1wNCddLAoJCQkJb3V0cHV0OiAnb3V0cHV0Lm1wNCcKCQkJfQoJCSkKCQljb25zdCB7IGRhdGEgfSA9IGF3YWl0IGZmV29ya2VyLnJlYWQoJ291dHB1dC5tcDQnKQoJCXJldHVybiBkYXRhCgl9Cgljb25zdCB0cmlnZ2VyRG93bmxvYWQgPSAodXJsLCBmaWxlbmFtZSkgPT4gewoJCWNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJykKCQlhLmhyZWYgPSB1cmwKCQlhLmRvd25sb2FkID0gZmlsZW5hbWUKCQlkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpCgkJYS5jbGljaygpCgkJYS5yZW1vdmUoKQoJfQoJY29uc3QgZGxNb2RhbFRlbXBsYXRlID0gYAo8ZGl2IHN0eWxlPSJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlOyI+Cgk8ZGl2IHYtaWY9Im1lcmdpbmciIHN0eWxlPSJoZWlnaHQ6IDEwMCU7IHdpZHRoOiAxMDAlOyBkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgZm9udC1zaXplOiAyNHB4OyI+TWVyZ2luZyB2aWRlbywgcGxlYXNlIHdhaXQuLi48L2Rpdj4KCTxkaXYgdi1lbHNlIHN0eWxlPSJoZWlnaHQ6IDEwMCU7IHdpZHRoOiAxMDAlOyBkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyI+CiAJCTxkaXYgc3R5bGU9ImZsZXg6IDE7IG1hcmdpbjogMTBweDsiPgoJCQk8cCBzdHlsZT0iZm9udC1zaXplOiAyNHB4OyI+VmlkZW88L3A+CgkJCTxwcm9ncmVzcyBzdHlsZT0id2lkdGg6IDEwMCU7IiA6dmFsdWU9InZpZGVvLnByb2dyZXNzIiBtaW49IjAiIG1heD0iMTAwIj48L3Byb2dyZXNzPgoJCQk8ZGl2IHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47Ij4KCQkJCTxzcGFuPnt7dmlkZW8uc3BlZWR9fSBrQi9zPC9zcGFuPgoJCQkJPHNwYW4+e3t2aWRlby5sb2FkZWR9fS97e3ZpZGVvLnRvdGFsfX0gTUI8L3NwYW4+CgkJCTwvZGl2PgoJCTwvZGl2PgoJCTxkaXYgc3R5bGU9ImZsZXg6IDE7IG1hcmdpbjogMTBweDsiPgoJCQk8cCBzdHlsZT0iZm9udC1zaXplOiAyNHB4OyI+QXVkaW88L3A+CgkJCTxwcm9ncmVzcyBzdHlsZT0id2lkdGg6IDEwMCU7IiA6dmFsdWU9ImF1ZGlvLnByb2dyZXNzIiBtaW49IjAiIG1heD0iMTAwIj48L3Byb2dyZXNzPgoJCQk8ZGl2IHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47Ij4KCQkJCTxzcGFuPnt7YXVkaW8uc3BlZWR9fSBrQi9zPC9zcGFuPgoJCQkJPHNwYW4+e3thdWRpby5sb2FkZWR9fS97e2F1ZGlvLnRvdGFsfX0gTUI8L3NwYW4+CgkJCTwvZGl2PgoJCTwvZGl2PgoJPC9kaXY+CjwvZGl2PgpgCglmdW5jdGlvbiBvcGVuRG93bmxvYWRNb2RlbChhZGFwdGl2ZSwgdGl0bGUpIHsKCQljb25zdCB3aW4gPSBvcGVuKAoJCQknJywKCQkJJ1ZpZGVvIERvd25sb2FkJywKCQkJYHRvb2xiYXI9bm8saGVpZ2h0PSR7c2NyZWVuLmhlaWdodCAvIDJ9LHdpZHRoPSR7c2NyZWVuLndpZHRoIC8KCQkJCTJ9LGxlZnQ9JHtzY3JlZW5MZWZ0fSx0b3A9JHtzY3JlZW5Ub3B9YAoJCSkKCQljb25zdCBkaXYgPSB3aW4uZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCQl3aW4uZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkaXYpCgkJd2luLmRvY3VtZW50LnRpdGxlID0gYERvd25sb2FkaW5nICIke3RpdGxlfSJgCgkJY29uc3QgZGxNb2RhbEFwcCA9IG5ldyBWdWUoewoJCQl0ZW1wbGF0ZTogZGxNb2RhbFRlbXBsYXRlLAoJCQlkYXRhKCkgewoJCQkJcmV0dXJuIHsKCQkJCQl2aWRlbzogewoJCQkJCQlwcm9ncmVzczogMCwKCQkJCQkJdG90YWw6IDAsCgkJCQkJCWxvYWRlZDogMCwKCQkJCQkJc3BlZWQ6IDAKCQkJCQl9LAoJCQkJCWF1ZGlvOiB7CgkJCQkJCXByb2dyZXNzOiAwLAoJCQkJCQl0b3RhbDogMCwKCQkJCQkJbG9hZGVkOiAwLAoJCQkJCQlzcGVlZDogMAoJCQkJCX0sCgkJCQkJbWVyZ2luZzogZmFsc2UKCQkJCX0KCQkJfSwKCQkJbWV0aG9kczogewoJCQkJYXN5bmMgc3RhcnQoYWRhcHRpdmUsIHRpdGxlKSB7CgkJCQkJd2luLm9uYmVmb3JldW5sb2FkID0gKCkgPT4gdHJ1ZQoJCQkJCS8vIFlvdVR1YmUncyBkZWZhdWx0IG9yZGVyIGlzIGRlc2NlbmRpbmcgYnkgdmlkZW8gcXVhbGl0eQoJCQkJCWNvbnN0IHZVcmwgPSBhZGFwdGl2ZQoJCQkJCQkuZmlsdGVyKHggPT4geC5taW1lVHlwZS5pbmNsdWRlcygndmlkZW8vbXA0JykpCgkJCQkJCS5tYXAodiA9PiB7CgkJCQkJCQljb25zdCBbXywgcXVhbGl0eSwgZnBzXSA9IC8oXGQrKXAoXGQqKS8uZXhlYygKCQkJCQkJCQl2LnF1YWxpdHlMYWJlbAoJCQkJCQkJKQoJCQkJCQkJdi5xdWFsaXR5TnVtID0gcGFyc2VJbnQocXVhbGl0eSkKCQkJCQkJCXYuZnBzID0gZnBzID8gcGFyc2VJbnQoZnBzKSA6IDMwCgkJCQkJCQlyZXR1cm4gdgoJCQkJCQl9KQoJCQkJCQkuc29ydCgoYSwgYikgPT4gewoJCQkJCQkJaWYgKGEucXVhbGl0eU51bSA9PT0gYi5xdWFsaXR5TnVtKQoJCQkJCQkJCXJldHVybiBiLmZwcyAtIGEuZnBzIC8vIGV4OiAzMC02MD0tMzAsIHRoZW4gYSB3aWxsIGJlIHB1dCBiZWZvcmUgYgoJCQkJCQkJcmV0dXJuIGIucXVhbGl0eU51bSAtIGEucXVhbGl0eU51bQoJCQkJCQl9KVswXS51cmwKCQkJCQljb25zdCBhVXJsID0gYWRhcHRpdmUuZmluZCh4ID0+CgkJCQkJCXgubWltZVR5cGUuaW5jbHVkZXMoJ2F1ZGlvL21wNCcpCgkJCQkJKS51cmwKCQkJCQljb25zdCB2UHJvbWlzZSA9IHhockRvd25sb2FkQnVmZmVyKHZVcmwsIGUgPT4gewoJCQkJCQl0aGlzLnZpZGVvLnByb2dyZXNzID0gKGUubG9hZGVkIC8gZS50b3RhbCkgKiAxMDAKCQkJCQkJdGhpcy52aWRlby5sb2FkZWQgPSAoZS5sb2FkZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKQoJCQkJCQl0aGlzLnZpZGVvLnRvdGFsID0gKGUudG90YWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKQoJCQkJCQl0aGlzLnZpZGVvLnNwZWVkID0gKGUuc3BlZWQgLyAxMDI0KS50b0ZpeGVkKDIpCgkJCQkJfSkKCQkJCQljb25zdCBhUHJvbWlzZSA9IHhockRvd25sb2FkQnVmZmVyKGFVcmwsIGUgPT4gewoJCQkJCQl0aGlzLmF1ZGlvLnByb2dyZXNzID0gKGUubG9hZGVkIC8gZS50b3RhbCkgKiAxMDAKCQkJCQkJdGhpcy5hdWRpby5sb2FkZWQgPSAoZS5sb2FkZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKQoJCQkJCQl0aGlzLmF1ZGlvLnRvdGFsID0gKGUudG90YWwgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKQoJCQkJCQl0aGlzLmF1ZGlvLnNwZWVkID0gKGUuc3BlZWQgLyAxMDI0KS50b0ZpeGVkKDIpCgkJCQkJfSkKCQkJCQl3aW4ub251bmxvYWQgPSAoKSA9PiB7CgkJCQkJCS8vIGJlY2F1c2UgR01feG1saHR0cFJlcXVlc3Qgd29uJ3QgYXV0b21hdGljYWxseSBzdG9wIHdoZW4gd2luZG93IGNsb3NlcwoJCQkJCQl2UHJvbWlzZS5hYm9ydCgpCgkJCQkJCWFQcm9taXNlLmFib3J0KCkKCQkJCQl9CgkJCQkJY29uc3QgW3ZidWYsIGFidWZdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3ZQcm9taXNlLCBhUHJvbWlzZV0pCgkJCQkJdGhpcy5tZXJnaW5nID0gdHJ1ZQoJCQkJCWNvbnN0IHZhcnIgPSBuZXcgVWludDhBcnJheSh2YnVmKQoJCQkJCWNvbnN0IGFhcnIgPSBuZXcgVWludDhBcnJheShhYnVmKQoJCQkJCWNvbnN0IHJlc3VsdCA9IGF3YWl0IFByb21pc2UucmFjZShbCgkJCQkJCW1lcmdlVmlkZW8odmFyciwgYWFyciksCgkJCQkJCXNsZWVwKDEwMDAgKiAyNSkudGhlbigoKSA9PiBudWxsKQoJCQkJCV0pCgkJCQkJaWYgKCFyZXN1bHQpIHsKCQkJCQkJYWxlcnQoJ0FuIGVycm9yIGhhcyBvY2N1cnJlZCB3aGVuIG1lcmdpbmcgdmlkZW8nKQoJCQkJCQljb25zdCBidnVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3ZhcnJdKSkKCQkJCQkJY29uc3QgYmF1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFthYXJyXSkpCgkJCQkJCXRyaWdnZXJEb3dubG9hZChidnVybCwgdGl0bGUgKyAnLXZpZGVvb25seS5tcDQnKQoJCQkJCQl0cmlnZ2VyRG93bmxvYWQoYmF1cmwsIHRpdGxlICsgJy1hdWRpb29ubHkubXA0JykKCQkJCQkJcmV0dXJuIHRoaXMuY2xvc2UoKQoJCQkJCX0KCQkJCQl0aGlzLm1lcmdpbmcgPSBmYWxzZQoJCQkJCWNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3Jlc3VsdF0pKQoJCQkJCXRyaWdnZXJEb3dubG9hZCh1cmwsIHRpdGxlICsgJy5tcDQnKQoJCQkJCXdpbi5vbmJlZm9yZXVubG9hZCA9IG51bGwKCQkJCQl3aW4uY2xvc2UoKQoJCQkJfQoJCQl9CgkJfSkuJG1vdW50KGRpdikKCQlkbE1vZGFsQXBwLnN0YXJ0KGFkYXB0aXZlLCB0aXRsZSkKCX0KCgljb25zdCB0ZW1wbGF0ZSA9IGAKPGRpdiBjbGFzcz0iYm94IiA6Y2xhc3M9InsnZGFyayc6ZGFya30iPgoJPGRpdiB2LWlmPSJhZGFwdGl2ZS5sZW5ndGgiIGNsYXNzPSJvZi1oIHQtY2VudGVyIGMtcG9pbnRlciBsaC0yMCI+CgkJPGEgY2xhc3M9ImZzLTE0cHgiIEBjbGljaz0iZGxtcDQiIHYtdGV4dD0ic3RyaW5ncy5kbG1wNCI+PC9hPgoJPC9kaXY+Cgk8ZGl2IEBjbGljaz0iaGlkZT0haGlkZSIgY2xhc3M9ImJveC10b2dnbGUgZGl2LWEgdC1jZW50ZXIgZnMtMTRweCBjLXBvaW50ZXIgbGgtMjAiIHYtdGV4dD0ic3RyaW5ncy50b2dnbGVsaW5rcyI+PC9kaXY+Cgk8ZGl2IDpjbGFzcz0ieydoaWRlJzpoaWRlfSI+CgkJPGRpdiBjbGFzcz0idC1jZW50ZXIgZnMtMTRweCIgdi10ZXh0PSJzdHJpbmdzLnZpZGVvaWQraWQiPjwvZGl2PgoJCTxkaXYgY2xhc3M9ImQtZmxleCI+CgkJCTxkaXYgY2xhc3M9ImYtMSBvZi1oIj4KCQkJCTxkaXYgY2xhc3M9InQtY2VudGVyIGZzLTE0cHgiIHYtdGV4dD0ic3RyaW5ncy5zdHJlYW0iPjwvZGl2PgoJCQkJPGEgY2xhc3M9Inl0ZGwtbGluay1idG4gZnMtMTRweCIgdGFyZ2V0PSJfYmxhbmsiIHYtZm9yPSJ2aWQgaW4gc3RyZWFtIiA6aHJlZj0idmlkLnVybCIgOnRpdGxlPSJ2aWQudHlwZSIgdi10ZXh0PSJ2aWQucXVhbGl0eXx8dmlkLnR5cGUiPjwvYT4KCQkJPC9kaXY+CgkJCTxkaXYgY2xhc3M9ImYtMSBvZi1oIj4KCQkJCTxkaXYgY2xhc3M9InQtY2VudGVyIGZzLTE0cHgiIHYtdGV4dD0ic3RyaW5ncy5hZGFwdGl2ZSI+PC9kaXY+CgkJCQk8YSBjbGFzcz0ieXRkbC1saW5rLWJ0biBmcy0xNHB4IiB0YXJnZXQ9Il9ibGFuayIgdi1mb3I9InZpZCBpbiBhZGFwdGl2ZSIgOmhyZWY9InZpZC51cmwiIDp0aXRsZT0idmlkLnR5cGUiIHYtdGV4dD0iW3ZpZC5xdWFsaXR5TGFiZWwsdmlkLm1pbWVUeXBlXS5maWx0ZXIoeD0+eCkuam9pbignOicpIj48L2E+CgkJCTwvZGl2PgoJCTwvZGl2PgoJCTxkaXYgY2xhc3M9Im9mLWggdC1jZW50ZXIiPgoJCQk8YSBjbGFzcz0iZnMtMTRweCIgaHJlZj0iaHR0cHM6Ly9tYXBsZTMxNDIuZ2l0aHViLmlvL21lcmdlbXA0LyIgdGFyZ2V0PSJfYmxhbmsiIHYtdGV4dD0ic3RyaW5ncy5pbmJyb3dzZXJfYWRhcHRpdmVfbWVyZ2VyIj48L2E+CgkJPC9kaXY+Cgk8L2Rpdj4KPC9kaXY+CmAuc2xpY2UoMSkKCWNvbnN0IGFwcCA9IG5ldyBWdWUoewoJCWRhdGEoKSB7CgkJCXJldHVybiB7CgkJCQloaWRlOiB0cnVlLAoJCQkJaWQ6ICcnLAoJCQkJc3RyZWFtOiBbXSwKCQkJCWFkYXB0aXZlOiBbXSwKCQkJCW1ldGE6IG51bGwsCgkJCQlkYXJrOiBmYWxzZSwKCQkJCWxhbmc6IGZpbmRMYW5nKG5hdmlnYXRvci5sYW5ndWFnZSkKCQkJfQoJCX0sCgkJY29tcHV0ZWQ6IHsKCQkJc3RyaW5ncygpIHsKCQkJCXJldHVybiBMT0NBTEVbdGhpcy5sYW5nLnRvTG93ZXJDYXNlKCldCgkJCX0KCQl9LAoJCW1ldGhvZHM6IHsKCQkJZGxtcDQoKSB7CgkJCQljb25zdCByID0gSlNPTi5wYXJzZSh0aGlzLm1ldGEucGxheWVyX3Jlc3BvbnNlKQoJCQkJb3BlbkRvd25sb2FkTW9kZWwodGhpcy5hZGFwdGl2ZSwgci52aWRlb0RldGFpbHMudGl0bGUpCgkJCX0KCQl9LAoJCXRlbXBsYXRlCgl9KQoJbG9nZ2VyLmxvZyhgZGVmYXVsdCBsYW5ndWFnZTogJXNgLCBhcHAubGFuZykKCgkvLyBhdHRhY2ggZWxlbWVudAoJY29uc3Qgc2hhZG93SG9zdCA9ICRlbCgnZGl2JykKCWNvbnN0IHNoYWRvdyA9IHNoYWRvd0hvc3QuYXR0YWNoU2hhZG93CgkJPyBzaGFkb3dIb3N0LmF0dGFjaFNoYWRvdyh7IG1vZGU6ICdjbG9zZWQnIH0pCgkJOiBzaGFkb3dIb3N0IC8vIG5vIHNoYWRvdyBkb20KCWxvZ2dlci5sb2coJ3NoYWRvd0hvc3Q6ICVvJywgc2hhZG93SG9zdCkKCWNvbnN0IGNvbnRhaW5lciA9ICRlbCgnZGl2JykKCXNoYWRvdy5hcHBlbmRDaGlsZChjb250YWluZXIpCglhcHAuJG1vdW50KGNvbnRhaW5lcikKCglpZiAoREVCVUcgJiYgdHlwZW9mIHVuc2FmZVdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkvLyBleHBvc2Ugc29tZSBmdW5jdGlvbnMgZm9yIGRlYnVnZ2luZwoJCXVuc2FmZVdpbmRvdy4kYXBwID0gYXBwCgkJdW5zYWZlV2luZG93LnBhcnNlUXVlcnkgPSBwYXJzZVF1ZXJ5CgkJdW5zYWZlV2luZG93LnBhcnNlRGVjc2lnID0gcGFyc2VEZWNzaWcKCQl1bnNhZmVXaW5kb3cuZ2V0VmlkZW8gPSBnZXRWaWRlbwoJfQoKCWNvbnN0IGdldExhbmdDb2RlID0gKCkgPT4gewoJCWlmICh0eXBlb2YgeXRwbGF5ZXIgIT09ICd1bmRlZmluZWQnICYmIHl0cGxheWVyLmNvbmZpZykgewoJCQlyZXR1cm4geXRwbGF5ZXIuY29uZmlnLmFyZ3MuaG9zdF9sYW5ndWFnZQoJCX0gZWxzZSBpZiAodHlwZW9mIHl0ICE9PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4geXQuY29uZmlnXy5HQVBJX0xPQ0FMRQoJCX0gZWxzZSB7CgkJCXJldHVybiBuYXZpZ2F0b3IubGFuZ3VhZ2UKCQl9CgkJcmV0dXJuIG51bGwKCX0KCWNvbnN0IHRleHRUb0h0bWwgPSB0ID0+IHsKCQkvLyBVUkxzIHN0YXJ0aW5nIHdpdGggaHR0cDovLywgaHR0cHM6Ly8KCQl0ID0gdC5yZXBsYWNlKAoJCQkvKFxiKGh0dHBzPyk6XC9cL1stQS1aMC05KyZAI1wvJT89fl98ITosLjtdKlstQS1aMC05KyZAI1wvJT1+X3xdKS9naW0sCgkJCSc8YSBocmVmPSIkMSIgdGFyZ2V0PSJfYmxhbmsiPiQxPC9hPicKCQkpCgkJdCA9IHQucmVwbGFjZSgvXG4vZywgJzxicj4nKQoJCXJldHVybiB0Cgl9Cgljb25zdCBhcHBseU9yaWdpbmFsVGl0bGUgPSBtZXRhID0+IHsKCQljb25zdCBkYXRhID0gZXZhbChgKCR7bWV0YS5wbGF5ZXJfcmVzcG9uc2V9KWApLnZpZGVvRGV0YWlscyAvLyBub3QgYSB2YWxpZCBqc29uLCBzbyBKU09OLnBhcnNlIHdvbid0IHdvcmsKCQlpZiAoJCgnI2Vvdy10aXRsZScpKSB7CgkJCS8vIGxlZ2FjeSB5b3V0dWJlCgkJCSQoJyNlb3ctdGl0bGUnKS50ZXh0Q29udGVudCA9IGRhdGEudGl0bGUKCQkJJCgnI2Vvdy1kZXNjcmlwdGlvbicpLmlubmVySFRNTCA9IHRleHRUb0h0bWwoZGF0YS5zaG9ydERlc2NyaXB0aW9uKQoJCX0gZWxzZSBpZiAoJCgnaDEudGl0bGUnKSkgewoJCQkvLyBuZXcgeW91dHViZSAocG9seW1lcikKCQkJJCgnaDEudGl0bGUnKS50ZXh0Q29udGVudCA9IGRhdGEudGl0bGUKCQkJJCgneXQtZm9ybWF0dGVkLXN0cmluZy5jb250ZW50JykuaW5uZXJIVE1MID0gdGV4dFRvSHRtbCgKCQkJCWRhdGEuc2hvcnREZXNjcmlwdGlvbgoJCQkpCgkJfQoJfQoJY29uc3QgbG9hZCA9IGFzeW5jIGlkID0+IHsKCQl0cnkgewoJCQljb25zdCBiYXNlanMgPQoJCQkJdHlwZW9mIHl0cGxheWVyICE9PSAndW5kZWZpbmVkJyAmJiB5dHBsYXllci5jb25maWcKCQkJCQk/ICdodHRwczovLycgKyBsb2NhdGlvbi5ob3N0ICsgeXRwbGF5ZXIuY29uZmlnLmFzc2V0cy5qcwoJCQkJCTogJCgnc2NyaXB0W3NyYyQ9ImJhc2UuanMiXScpLnNyYwoJCQljb25zdCBkYXRhID0gYXdhaXQgd29ya2VyR2V0VmlkZW8oaWQsIGJhc2VqcykKCQkJbG9nZ2VyLmxvZygndmlkZW8gbG9hZGVkOiAlcycsIGlkKQoJCQlpZiAoUkVTVE9SRV9PUklHSU5BTF9USVRMRV9GT1JfQ1VSUkVOVF9WSURFTykgewoJCQkJdHJ5IHsKCQkJCQlhcHBseU9yaWdpbmFsVGl0bGUoZGF0YS5tZXRhKQoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCS8vIGp1c3QgbWFrZSBzdXJlIHRoZSBtYWluIGZ1bmN0aW9uIHdpbGwgd29yayBldmVuIGlmIG9yaWdpbmFsIHRpdGxlIGFwcGxpZXIgZG9lc24ndCB3b3JrCgkJCQl9CgkJCX0KCQkJYXBwLmlkID0gaWQKCQkJYXBwLnN0cmVhbSA9IGRhdGEuc3RyZWFtCgkJCWFwcC5hZGFwdGl2ZSA9IGRhdGEuYWRhcHRpdmUKCQkJYXBwLm1ldGEgPSBkYXRhLm1ldGEKCgkJCWNvbnN0IGFjdExhbmcgPSBnZXRMYW5nQ29kZSgpCgkJCWlmIChhY3RMYW5nICE9PSBudWxsKSB7CgkJCQljb25zdCBsYW5nID0gZmluZExhbmcoYWN0TGFuZykKCQkJCWxvZ2dlci5sb2coJ3lvdXR1YmUgdWkgbGFuZzogJXMnLCBhY3RMYW5nKQoJCQkJbG9nZ2VyLmxvZygneXRkbCBsYW5nOicsIGxhbmcpCgkJCQlhcHAubGFuZyA9IGxhbmcKCQkJfQoJCX0gY2F0Y2ggKGVycikgewoJCQlsb2dnZXIuZXJyb3IoJ2xvYWQnLCBlcnIpCgkJfQoJfQoJbGV0IHByZXYgPSBudWxsCglzZXRJbnRlcnZhbCgoKSA9PiB7CgkJY29uc3QgZWwgPQoJCQkkKCcjaW5mby1jb250ZW50cycpIHx8CgkJCSQoJyN3YXRjaC1oZWFkZXInKSB8fAoJCQkkKAoJCQkJJy5wYWdlLWNvbnRhaW5lcjpub3QoW2hpZGRlbl0pIHl0bS1pdGVtLXNlY3Rpb24tcmVuZGVyZXI+bGF6eS1saXN0JwoJCQkpCgkJaWYgKGVsICYmICFlbC5jb250YWlucyhzaGFkb3dIb3N0KSkgewoJCQllbC5hcHBlbmRDaGlsZChzaGFkb3dIb3N0KQoJCX0KCQlpZiAobG9jYXRpb24uaHJlZiAhPT0gcHJldikgewoJCQlsb2dnZXIubG9nKGBwYWdlIGNoYW5nZTogJHtwcmV2fSAtPiAke2xvY2F0aW9uLmhyZWZ9YCkKCQkJcHJldiA9IGxvY2F0aW9uLmhyZWYKCQkJaWYgKGxvY2F0aW9uLnBhdGhuYW1lID09PSAnL3dhdGNoJykgewoJCQkJc2hhZG93SG9zdC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJwoJCQkJY29uc3QgaWQgPSBwYXJzZVF1ZXJ5KGxvY2F0aW9uLnNlYXJjaCkudgoJCQkJbG9nZ2VyLmxvZygnc3RhcnQgbG9hZGluZyBuZXcgdmlkZW86ICVzJywgaWQpCgkJCQlhcHAuaGlkZSA9IHRydWUgLy8gZm9sZCBpdAoJCQkJbG9hZChpZCkKCQkJfSBlbHNlIHsKCQkJCXNoYWRvd0hvc3Quc3R5bGUuZGlzcGxheSA9ICdub25lJwoJCQl9CgkJfQoJfSwgMTAwMCkKCgkvLyBsaXN0ZW4gdG8gZGFyayBtb2RlIHRvZ2dsZQoJY29uc3QgJGh0bWwgPSAkKCdodG1sJykKCW5ldyBNdXRhdGlvbk9ic2VydmVyKCgpID0+IHsKCQlhcHAuZGFyayA9ICRodG1sLmdldEF0dHJpYnV0ZSgnZGFyaycpID09PSAndHJ1ZScKCX0pLm9ic2VydmUoJGh0bWwsIHsgYXR0cmlidXRlczogdHJ1ZSB9KQoJYXBwLmRhcmsgPSAkaHRtbC5nZXRBdHRyaWJ1dGUoJ2RhcmsnKSA9PT0gJ3RydWUnCgoJY29uc3QgY3NzID0gYAouaGlkZXsKCWRpc3BsYXk6IG5vbmU7Cn0KLnQtY2VudGVyewoJdGV4dC1hbGlnbjogY2VudGVyOwp9Ci5kLWZsZXh7CglkaXNwbGF5OiBmbGV4Owp9Ci5mLTF7CglmbGV4OiAxOwp9Ci5mcy0xNHB4ewoJZm9udC1zaXplOiAxNHB4Owp9Ci5vZi1oewoJb3ZlcmZsb3c6IGhpZGRlbjsKfQouYm94ewoJYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLXl0LWJvcmRlci1jb2xvcik7Cglmb250LWZhbWlseTogQXJpYWw7Cn0KLmJveC10b2dnbGV7CgltYXJnaW46IDNweDsKCXVzZXItc2VsZWN0OiBub25lOwoJLW1vei11c2VyLXNlbGVjdDogLW1vei1ub25lOwp9Ci55dGRsLWxpbmstYnRuewoJZGlzcGxheTogYmxvY2s7Cglib3JkZXI6IDFweCBzb2xpZCAhaW1wb3J0YW50OwoJYm9yZGVyLXJhZGl1czogM3B4OwoJdGV4dC1kZWNvcmF0aW9uOiBub25lICFpbXBvcnRhbnQ7CglvdXRsaW5lOiAwOwoJdGV4dC1hbGlnbjogY2VudGVyOwoJcGFkZGluZzogMnB4OwoJbWFyZ2luOiA1cHg7Cgljb2xvcjogYmxhY2s7Cn0KYSwgLmRpdi1hewoJdGV4dC1kZWNvcmF0aW9uOiBub25lOwoJY29sb3I6IHZhcigtLXl0LWJ1dHRvbi1jb2xvciwgaW5oZXJpdCk7Cn0KYTpob3ZlciwgLmRpdi1hOmhvdmVyewoJY29sb3I6IHZhcigtLXl0LXNwZWMtY2FsbC10by1hY3Rpb24sIGJsdWUpOwp9Ci5ib3guZGFya3sKCWNvbG9yOiB2YXIoLS15dGQtdmlkZW8tcHJpbWFyeS1pbmZvLXJlbmRlcmVyLXRpdGxlLWNvbG9yLCB2YXIoLS15dC1wcmltYXJ5LXRleHQtY29sb3IpKTsKfQouYm94LmRhcmsgLnl0ZGwtbGluay1idG57Cgljb2xvcjogdmFyKC0teXRkLXZpZGVvLXByaW1hcnktaW5mby1yZW5kZXJlci10aXRsZS1jb2xvciwgdmFyKC0teXQtcHJpbWFyeS10ZXh0LWNvbG9yKSk7Cn0KLmJveC5kYXJrIC55dGRsLWxpbmstYnRuOmhvdmVyewoJY29sb3I6IHJnYmEoMjAwLCAyMDAsIDI1NSwgMC44KTsKfQouYm94LmRhcmsgLmJveC10b2dnbGU6aG92ZXJ7Cgljb2xvcjogcmdiYSgyMDAsIDIwMCwgMjU1LCAwLjgpOwp9Ci5jLXBvaW50ZXJ7CgljdXJzb3I6IHBvaW50ZXI7Cn0KLmxoLTIwewoJbGluZS1oZWlnaHQ6IDIwcHg7Cn0KYAoJc2hhZG93LmFwcGVuZENoaWxkKCRlbCgnc3R5bGUnLCB7IHRleHRDb250ZW50OiBjc3MgfSkpCn0pKCkK","requires":[{"meta":{"name":"vue.js","url":"https://unpkg.com/vue@2.6.10/dist/vue.js","ts":1582701382361,"mimetype":"text/javascript"},"source":"LyohCiAqIFZ1ZS5qcyB2Mi42LjEwCiAqIChjKSAyMDE0LTIwMTkgRXZhbiBZb3UKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKi8KKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6CiAgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDoKICAoZ2xvYmFsID0gZ2xvYmFsIHx8IHNlbGYsIGdsb2JhbC5WdWUgPSBmYWN0b3J5KCkpOwp9KHRoaXMsIGZ1bmN0aW9uICgpIHsgJ3VzZSBzdHJpY3QnOwoKICAvKiAgKi8KCiAgdmFyIGVtcHR5T2JqZWN0ID0gT2JqZWN0LmZyZWV6ZSh7fSk7CgogIC8vIFRoZXNlIGhlbHBlcnMgcHJvZHVjZSBiZXR0ZXIgVk0gY29kZSBpbiBKUyBlbmdpbmVzIGR1ZSB0byB0aGVpcgogIC8vIGV4cGxpY2l0bmVzcyBhbmQgZnVuY3Rpb24gaW5saW5pbmcuCiAgZnVuY3Rpb24gaXNVbmRlZiAodikgewogICAgcmV0dXJuIHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsCiAgfQoKICBmdW5jdGlvbiBpc0RlZiAodikgewogICAgcmV0dXJuIHYgIT09IHVuZGVmaW5lZCAmJiB2ICE9PSBudWxsCiAgfQoKICBmdW5jdGlvbiBpc1RydWUgKHYpIHsKICAgIHJldHVybiB2ID09PSB0cnVlCiAgfQoKICBmdW5jdGlvbiBpc0ZhbHNlICh2KSB7CiAgICByZXR1cm4gdiA9PT0gZmFsc2UKICB9CgogIC8qKgogICAqIENoZWNrIGlmIHZhbHVlIGlzIHByaW1pdGl2ZS4KICAgKi8KICBmdW5jdGlvbiBpc1ByaW1pdGl2ZSAodmFsdWUpIHsKICAgIHJldHVybiAoCiAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwKICAgICAgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fAogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgdHlwZW9mIHZhbHVlID09PSAnc3ltYm9sJyB8fAogICAgICB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJwogICAgKQogIH0KCiAgLyoqCiAgICogUXVpY2sgb2JqZWN0IGNoZWNrIC0gdGhpcyBpcyBwcmltYXJpbHkgdXNlZCB0byB0ZWxsCiAgICogT2JqZWN0cyBmcm9tIHByaW1pdGl2ZSB2YWx1ZXMgd2hlbiB3ZSBrbm93IHRoZSB2YWx1ZQogICAqIGlzIGEgSlNPTi1jb21wbGlhbnQgdHlwZS4KICAgKi8KICBmdW5jdGlvbiBpc09iamVjdCAob2JqKSB7CiAgICByZXR1cm4gb2JqICE9PSBudWxsICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnCiAgfQoKICAvKioKICAgKiBHZXQgdGhlIHJhdyB0eXBlIHN0cmluZyBvZiBhIHZhbHVlLCBlLmcuLCBbb2JqZWN0IE9iamVjdF0uCiAgICovCiAgdmFyIF90b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgogIGZ1bmN0aW9uIHRvUmF3VHlwZSAodmFsdWUpIHsKICAgIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpCiAgfQoKICAvKioKICAgKiBTdHJpY3Qgb2JqZWN0IHR5cGUgY2hlY2suIE9ubHkgcmV0dXJucyB0cnVlCiAgICogZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cy4KICAgKi8KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0IChvYmopIHsKICAgIHJldHVybiBfdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBPYmplY3RdJwogIH0KCiAgZnVuY3Rpb24gaXNSZWdFeHAgKHYpIHsKICAgIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2KSA9PT0gJ1tvYmplY3QgUmVnRXhwXScKICB9CgogIC8qKgogICAqIENoZWNrIGlmIHZhbCBpcyBhIHZhbGlkIGFycmF5IGluZGV4LgogICAqLwogIGZ1bmN0aW9uIGlzVmFsaWRBcnJheUluZGV4ICh2YWwpIHsKICAgIHZhciBuID0gcGFyc2VGbG9hdChTdHJpbmcodmFsKSk7CiAgICByZXR1cm4gbiA+PSAwICYmIE1hdGguZmxvb3IobikgPT09IG4gJiYgaXNGaW5pdGUodmFsKQogIH0KCiAgZnVuY3Rpb24gaXNQcm9taXNlICh2YWwpIHsKICAgIHJldHVybiAoCiAgICAgIGlzRGVmKHZhbCkgJiYKICAgICAgdHlwZW9mIHZhbC50aGVuID09PSAnZnVuY3Rpb24nICYmCiAgICAgIHR5cGVvZiB2YWwuY2F0Y2ggPT09ICdmdW5jdGlvbicKICAgICkKICB9CgogIC8qKgogICAqIENvbnZlcnQgYSB2YWx1ZSB0byBhIHN0cmluZyB0aGF0IGlzIGFjdHVhbGx5IHJlbmRlcmVkLgogICAqLwogIGZ1bmN0aW9uIHRvU3RyaW5nICh2YWwpIHsKICAgIHJldHVybiB2YWwgPT0gbnVsbAogICAgICA/ICcnCiAgICAgIDogQXJyYXkuaXNBcnJheSh2YWwpIHx8IChpc1BsYWluT2JqZWN0KHZhbCkgJiYgdmFsLnRvU3RyaW5nID09PSBfdG9TdHJpbmcpCiAgICAgICAgPyBKU09OLnN0cmluZ2lmeSh2YWwsIG51bGwsIDIpCiAgICAgICAgOiBTdHJpbmcodmFsKQogIH0KCiAgLyoqCiAgICogQ29udmVydCBhbiBpbnB1dCB2YWx1ZSB0byBhIG51bWJlciBmb3IgcGVyc2lzdGVuY2UuCiAgICogSWYgdGhlIGNvbnZlcnNpb24gZmFpbHMsIHJldHVybiBvcmlnaW5hbCBzdHJpbmcuCiAgICovCiAgZnVuY3Rpb24gdG9OdW1iZXIgKHZhbCkgewogICAgdmFyIG4gPSBwYXJzZUZsb2F0KHZhbCk7CiAgICByZXR1cm4gaXNOYU4obikgPyB2YWwgOiBuCiAgfQoKICAvKioKICAgKiBNYWtlIGEgbWFwIGFuZCByZXR1cm4gYSBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYSBrZXkKICAgKiBpcyBpbiB0aGF0IG1hcC4KICAgKi8KICBmdW5jdGlvbiBtYWtlTWFwICgKICAgIHN0ciwKICAgIGV4cGVjdHNMb3dlckNhc2UKICApIHsKICAgIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdmFyIGxpc3QgPSBzdHIuc3BsaXQoJywnKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICBtYXBbbGlzdFtpXV0gPSB0cnVlOwogICAgfQogICAgcmV0dXJuIGV4cGVjdHNMb3dlckNhc2UKICAgICAgPyBmdW5jdGlvbiAodmFsKSB7IHJldHVybiBtYXBbdmFsLnRvTG93ZXJDYXNlKCldOyB9CiAgICAgIDogZnVuY3Rpb24gKHZhbCkgeyByZXR1cm4gbWFwW3ZhbF07IH0KICB9CgogIC8qKgogICAqIENoZWNrIGlmIGEgdGFnIGlzIGEgYnVpbHQtaW4gdGFnLgogICAqLwogIHZhciBpc0J1aWx0SW5UYWcgPSBtYWtlTWFwKCdzbG90LGNvbXBvbmVudCcsIHRydWUpOwoKICAvKioKICAgKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUuCiAgICovCiAgdmFyIGlzUmVzZXJ2ZWRBdHRyaWJ1dGUgPSBtYWtlTWFwKCdrZXkscmVmLHNsb3Qsc2xvdC1zY29wZSxpcycpOwoKICAvKioKICAgKiBSZW1vdmUgYW4gaXRlbSBmcm9tIGFuIGFycmF5LgogICAqLwogIGZ1bmN0aW9uIHJlbW92ZSAoYXJyLCBpdGVtKSB7CiAgICBpZiAoYXJyLmxlbmd0aCkgewogICAgICB2YXIgaW5kZXggPSBhcnIuaW5kZXhPZihpdGVtKTsKICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICByZXR1cm4gYXJyLnNwbGljZShpbmRleCwgMSkKICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogQ2hlY2sgd2hldGhlciBhbiBvYmplY3QgaGFzIHRoZSBwcm9wZXJ0eS4KICAgKi8KICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogIGZ1bmN0aW9uIGhhc093biAob2JqLCBrZXkpIHsKICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KQogIH0KCiAgLyoqCiAgICogQ3JlYXRlIGEgY2FjaGVkIHZlcnNpb24gb2YgYSBwdXJlIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIGNhY2hlZCAoZm4pIHsKICAgIHZhciBjYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICByZXR1cm4gKGZ1bmN0aW9uIGNhY2hlZEZuIChzdHIpIHsKICAgICAgdmFyIGhpdCA9IGNhY2hlW3N0cl07CiAgICAgIHJldHVybiBoaXQgfHwgKGNhY2hlW3N0cl0gPSBmbihzdHIpKQogICAgfSkKICB9CgogIC8qKgogICAqIENhbWVsaXplIGEgaHlwaGVuLWRlbGltaXRlZCBzdHJpbmcuCiAgICovCiAgdmFyIGNhbWVsaXplUkUgPSAvLShcdykvZzsKICB2YXIgY2FtZWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNhbWVsaXplUkUsIGZ1bmN0aW9uIChfLCBjKSB7IHJldHVybiBjID8gYy50b1VwcGVyQ2FzZSgpIDogJyc7IH0pCiAgfSk7CgogIC8qKgogICAqIENhcGl0YWxpemUgYSBzdHJpbmcuCiAgICovCiAgdmFyIGNhcGl0YWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogICAgcmV0dXJuIHN0ci5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0ci5zbGljZSgxKQogIH0pOwoKICAvKioKICAgKiBIeXBoZW5hdGUgYSBjYW1lbENhc2Ugc3RyaW5nLgogICAqLwogIHZhciBoeXBoZW5hdGVSRSA9IC9cQihbQS1aXSkvZzsKICB2YXIgaHlwaGVuYXRlID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShoeXBoZW5hdGVSRSwgJy0kMScpLnRvTG93ZXJDYXNlKCkKICB9KTsKCiAgLyoqCiAgICogU2ltcGxlIGJpbmQgcG9seWZpbGwgZm9yIGVudmlyb25tZW50cyB0aGF0IGRvIG5vdCBzdXBwb3J0IGl0LAogICAqIGUuZy4sIFBoYW50b21KUyAxLnguIFRlY2huaWNhbGx5LCB3ZSBkb24ndCBuZWVkIHRoaXMgYW55bW9yZQogICAqIHNpbmNlIG5hdGl2ZSBiaW5kIGlzIG5vdyBwZXJmb3JtYW50IGVub3VnaCBpbiBtb3N0IGJyb3dzZXJzLgogICAqIEJ1dCByZW1vdmluZyBpdCB3b3VsZCBtZWFuIGJyZWFraW5nIGNvZGUgdGhhdCB3YXMgYWJsZSB0byBydW4gaW4KICAgKiBQaGFudG9tSlMgMS54LCBzbyB0aGlzIG11c3QgYmUga2VwdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4KICAgKi8KCiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICBmdW5jdGlvbiBwb2x5ZmlsbEJpbmQgKGZuLCBjdHgpIHsKICAgIGZ1bmN0aW9uIGJvdW5kRm4gKGEpIHsKICAgICAgdmFyIGwgPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICByZXR1cm4gbAogICAgICAgID8gbCA+IDEKICAgICAgICAgID8gZm4uYXBwbHkoY3R4LCBhcmd1bWVudHMpCiAgICAgICAgICA6IGZuLmNhbGwoY3R4LCBhKQogICAgICAgIDogZm4uY2FsbChjdHgpCiAgICB9CgogICAgYm91bmRGbi5fbGVuZ3RoID0gZm4ubGVuZ3RoOwogICAgcmV0dXJuIGJvdW5kRm4KICB9CgogIGZ1bmN0aW9uIG5hdGl2ZUJpbmQgKGZuLCBjdHgpIHsKICAgIHJldHVybiBmbi5iaW5kKGN0eCkKICB9CgogIHZhciBiaW5kID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQKICAgID8gbmF0aXZlQmluZAogICAgOiBwb2x5ZmlsbEJpbmQ7CgogIC8qKgogICAqIENvbnZlcnQgYW4gQXJyYXktbGlrZSBvYmplY3QgdG8gYSByZWFsIEFycmF5LgogICAqLwogIGZ1bmN0aW9uIHRvQXJyYXkgKGxpc3QsIHN0YXJ0KSB7CiAgICBzdGFydCA9IHN0YXJ0IHx8IDA7CiAgICB2YXIgaSA9IGxpc3QubGVuZ3RoIC0gc3RhcnQ7CiAgICB2YXIgcmV0ID0gbmV3IEFycmF5KGkpOwogICAgd2hpbGUgKGktLSkgewogICAgICByZXRbaV0gPSBsaXN0W2kgKyBzdGFydF07CiAgICB9CiAgICByZXR1cm4gcmV0CiAgfQoKICAvKioKICAgKiBNaXggcHJvcGVydGllcyBpbnRvIHRhcmdldCBvYmplY3QuCiAgICovCiAgZnVuY3Rpb24gZXh0ZW5kICh0bywgX2Zyb20pIHsKICAgIGZvciAodmFyIGtleSBpbiBfZnJvbSkgewogICAgICB0b1trZXldID0gX2Zyb21ba2V5XTsKICAgIH0KICAgIHJldHVybiB0bwogIH0KCiAgLyoqCiAgICogTWVyZ2UgYW4gQXJyYXkgb2YgT2JqZWN0cyBpbnRvIGEgc2luZ2xlIE9iamVjdC4KICAgKi8KICBmdW5jdGlvbiB0b09iamVjdCAoYXJyKSB7CiAgICB2YXIgcmVzID0ge307CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICBpZiAoYXJyW2ldKSB7CiAgICAgICAgZXh0ZW5kKHJlcywgYXJyW2ldKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi8KCiAgLyoqCiAgICogUGVyZm9ybSBubyBvcGVyYXRpb24uCiAgICogU3R1YmJpbmcgYXJncyB0byBtYWtlIEZsb3cgaGFwcHkgd2l0aG91dCBsZWF2aW5nIHVzZWxlc3MgdHJhbnNwaWxlZCBjb2RlCiAgICogd2l0aCAuLi5yZXN0IChodHRwczovL2Zsb3cub3JnL2Jsb2cvMjAxNy8wNS8wNy9TdHJpY3QtRnVuY3Rpb24tQ2FsbC1Bcml0eS8pLgogICAqLwogIGZ1bmN0aW9uIG5vb3AgKGEsIGIsIGMpIHt9CgogIC8qKgogICAqIEFsd2F5cyByZXR1cm4gZmFsc2UuCiAgICovCiAgdmFyIG5vID0gZnVuY3Rpb24gKGEsIGIsIGMpIHsgcmV0dXJuIGZhbHNlOyB9OwoKICAvKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovCgogIC8qKgogICAqIFJldHVybiB0aGUgc2FtZSB2YWx1ZS4KICAgKi8KICB2YXIgaWRlbnRpdHkgPSBmdW5jdGlvbiAoXykgeyByZXR1cm4gXzsgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYSBzdHJpbmcgY29udGFpbmluZyBzdGF0aWMga2V5cyBmcm9tIGNvbXBpbGVyIG1vZHVsZXMuCiAgICovCiAgZnVuY3Rpb24gZ2VuU3RhdGljS2V5cyAobW9kdWxlcykgewogICAgcmV0dXJuIG1vZHVsZXMucmVkdWNlKGZ1bmN0aW9uIChrZXlzLCBtKSB7CiAgICAgIHJldHVybiBrZXlzLmNvbmNhdChtLnN0YXRpY0tleXMgfHwgW10pCiAgICB9LCBbXSkuam9pbignLCcpCiAgfQoKICAvKioKICAgKiBDaGVjayBpZiB0d28gdmFsdWVzIGFyZSBsb29zZWx5IGVxdWFsIC0gdGhhdCBpcywKICAgKiBpZiB0aGV5IGFyZSBwbGFpbiBvYmplY3RzLCBkbyB0aGV5IGhhdmUgdGhlIHNhbWUgc2hhcGU/CiAgICovCiAgZnVuY3Rpb24gbG9vc2VFcXVhbCAoYSwgYikgewogICAgaWYgKGEgPT09IGIpIHsgcmV0dXJuIHRydWUgfQogICAgdmFyIGlzT2JqZWN0QSA9IGlzT2JqZWN0KGEpOwogICAgdmFyIGlzT2JqZWN0QiA9IGlzT2JqZWN0KGIpOwogICAgaWYgKGlzT2JqZWN0QSAmJiBpc09iamVjdEIpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgaXNBcnJheUEgPSBBcnJheS5pc0FycmF5KGEpOwogICAgICAgIHZhciBpc0FycmF5QiA9IEFycmF5LmlzQXJyYXkoYik7CiAgICAgICAgaWYgKGlzQXJyYXlBICYmIGlzQXJyYXlCKSB7CiAgICAgICAgICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoICYmIGEuZXZlcnkoZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICAgICAgcmV0dXJuIGxvb3NlRXF1YWwoZSwgYltpXSkKICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIGlmIChhIGluc3RhbmNlb2YgRGF0ZSAmJiBiIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgcmV0dXJuIGEuZ2V0VGltZSgpID09PSBiLmdldFRpbWUoKQogICAgICAgIH0gZWxzZSBpZiAoIWlzQXJyYXlBICYmICFpc0FycmF5QikgewogICAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMoYSk7CiAgICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhiKTsKICAgICAgICAgIHJldHVybiBrZXlzQS5sZW5ndGggPT09IGtleXNCLmxlbmd0aCAmJiBrZXlzQS5ldmVyeShmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGFba2V5XSwgYltrZXldKQogICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIWlzT2JqZWN0QSAmJiAhaXNPYmplY3RCKSB7CiAgICAgIHJldHVybiBTdHJpbmcoYSkgPT09IFN0cmluZyhiKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQoKICAvKioKICAgKiBSZXR1cm4gdGhlIGZpcnN0IGluZGV4IGF0IHdoaWNoIGEgbG9vc2VseSBlcXVhbCB2YWx1ZSBjYW4gYmUKICAgKiBmb3VuZCBpbiB0aGUgYXJyYXkgKGlmIHZhbHVlIGlzIGEgcGxhaW4gb2JqZWN0LCB0aGUgYXJyYXkgbXVzdAogICAqIGNvbnRhaW4gYW4gb2JqZWN0IG9mIHRoZSBzYW1lIHNoYXBlKSwgb3IgLTEgaWYgaXQgaXMgbm90IHByZXNlbnQuCiAgICovCiAgZnVuY3Rpb24gbG9vc2VJbmRleE9mIChhcnIsIHZhbCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGxvb3NlRXF1YWwoYXJyW2ldLCB2YWwpKSB7IHJldHVybiBpIH0KICAgIH0KICAgIHJldHVybiAtMQogIH0KCiAgLyoqCiAgICogRW5zdXJlIGEgZnVuY3Rpb24gaXMgY2FsbGVkIG9ubHkgb25jZS4KICAgKi8KICBmdW5jdGlvbiBvbmNlIChmbikgewogICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBTU1JfQVRUUiA9ICdkYXRhLXNlcnZlci1yZW5kZXJlZCc7CgogIHZhciBBU1NFVF9UWVBFUyA9IFsKICAgICdjb21wb25lbnQnLAogICAgJ2RpcmVjdGl2ZScsCiAgICAnZmlsdGVyJwogIF07CgogIHZhciBMSUZFQ1lDTEVfSE9PS1MgPSBbCiAgICAnYmVmb3JlQ3JlYXRlJywKICAgICdjcmVhdGVkJywKICAgICdiZWZvcmVNb3VudCcsCiAgICAnbW91bnRlZCcsCiAgICAnYmVmb3JlVXBkYXRlJywKICAgICd1cGRhdGVkJywKICAgICdiZWZvcmVEZXN0cm95JywKICAgICdkZXN0cm95ZWQnLAogICAgJ2FjdGl2YXRlZCcsCiAgICAnZGVhY3RpdmF0ZWQnLAogICAgJ2Vycm9yQ2FwdHVyZWQnLAogICAgJ3NlcnZlclByZWZldGNoJwogIF07CgogIC8qICAqLwoKCgogIHZhciBjb25maWcgPSAoewogICAgLyoqCiAgICAgKiBPcHRpb24gbWVyZ2Ugc3RyYXRlZ2llcyAodXNlZCBpbiBjb3JlL3V0aWwvb3B0aW9ucykKICAgICAqLwogICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICBvcHRpb25NZXJnZVN0cmF0ZWdpZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRvIHN1cHByZXNzIHdhcm5pbmdzLgogICAgICovCiAgICBzaWxlbnQ6IGZhbHNlLAoKICAgIC8qKgogICAgICogU2hvdyBwcm9kdWN0aW9uIG1vZGUgdGlwIG1lc3NhZ2Ugb24gYm9vdD8KICAgICAqLwogICAgcHJvZHVjdGlvblRpcDogImRldmVsb3BtZW50IiAhPT0gJ3Byb2R1Y3Rpb24nLAoKICAgIC8qKgogICAgICogV2hldGhlciB0byBlbmFibGUgZGV2dG9vbHMKICAgICAqLwogICAgZGV2dG9vbHM6ICJkZXZlbG9wbWVudCIgIT09ICdwcm9kdWN0aW9uJywKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdG8gcmVjb3JkIHBlcmYKICAgICAqLwogICAgcGVyZm9ybWFuY2U6IGZhbHNlLAoKICAgIC8qKgogICAgICogRXJyb3IgaGFuZGxlciBmb3Igd2F0Y2hlciBlcnJvcnMKICAgICAqLwogICAgZXJyb3JIYW5kbGVyOiBudWxsLAoKICAgIC8qKgogICAgICogV2FybiBoYW5kbGVyIGZvciB3YXRjaGVyIHdhcm5zCiAgICAgKi8KICAgIHdhcm5IYW5kbGVyOiBudWxsLAoKICAgIC8qKgogICAgICogSWdub3JlIGNlcnRhaW4gY3VzdG9tIGVsZW1lbnRzCiAgICAgKi8KICAgIGlnbm9yZWRFbGVtZW50czogW10sCgogICAgLyoqCiAgICAgKiBDdXN0b20gdXNlciBrZXkgYWxpYXNlcyBmb3Igdi1vbgogICAgICovCiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIGtleUNvZGVzOiBPYmplY3QuY3JlYXRlKG51bGwpLAoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgYSB0YWcgaXMgcmVzZXJ2ZWQgc28gdGhhdCBpdCBjYW5ub3QgYmUgcmVnaXN0ZXJlZCBhcyBhCiAgICAgKiBjb21wb25lbnQuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uCiAgICAgKi8KICAgIGlzUmVzZXJ2ZWRUYWc6IG5vLAoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgYXMgYSBjb21wb25lbnQKICAgICAqIHByb3AuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uCiAgICAgKi8KICAgIGlzUmVzZXJ2ZWRBdHRyOiBubywKCiAgICAvKioKICAgICAqIENoZWNrIGlmIGEgdGFnIGlzIGFuIHVua25vd24gZWxlbWVudC4KICAgICAqIFBsYXRmb3JtLWRlcGVuZGVudC4KICAgICAqLwogICAgaXNVbmtub3duRWxlbWVudDogbm8sCgogICAgLyoqCiAgICAgKiBHZXQgdGhlIG5hbWVzcGFjZSBvZiBhbiBlbGVtZW50CiAgICAgKi8KICAgIGdldFRhZ05hbWVzcGFjZTogbm9vcCwKCiAgICAvKioKICAgICAqIFBhcnNlIHRoZSByZWFsIHRhZyBuYW1lIGZvciB0aGUgc3BlY2lmaWMgcGxhdGZvcm0uCiAgICAgKi8KICAgIHBhcnNlUGxhdGZvcm1UYWdOYW1lOiBpZGVudGl0eSwKCiAgICAvKioKICAgICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBtdXN0IGJlIGJvdW5kIHVzaW5nIHByb3BlcnR5LCBlLmcuIHZhbHVlCiAgICAgKiBQbGF0Zm9ybS1kZXBlbmRlbnQuCiAgICAgKi8KICAgIG11c3RVc2VQcm9wOiBubywKCiAgICAvKioKICAgICAqIFBlcmZvcm0gdXBkYXRlcyBhc3luY2hyb25vdXNseS4gSW50ZW5kZWQgdG8gYmUgdXNlZCBieSBWdWUgVGVzdCBVdGlscwogICAgICogVGhpcyB3aWxsIHNpZ25pZmljYW50bHkgcmVkdWNlIHBlcmZvcm1hbmNlIGlmIHNldCB0byBmYWxzZS4KICAgICAqLwogICAgYXN5bmM6IHRydWUsCgogICAgLyoqCiAgICAgKiBFeHBvc2VkIGZvciBsZWdhY3kgcmVhc29ucwogICAgICovCiAgICBfbGlmZWN5Y2xlSG9va3M6IExJRkVDWUNMRV9IT09LUwogIH0pOwoKICAvKiAgKi8KCiAgLyoqCiAgICogdW5pY29kZSBsZXR0ZXJzIHVzZWQgZm9yIHBhcnNpbmcgaHRtbCB0YWdzLCBjb21wb25lbnQgbmFtZXMgYW5kIHByb3BlcnR5IHBhdGhzLgogICAqIHVzaW5nIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9odG1sNTMvc2VtYW50aWNzLXNjcmlwdGluZy5odG1sI3BvdGVudGlhbGN1c3RvbWVsZW1lbnRuYW1lCiAgICogc2tpcHBpbmcgXHUxMDAwMC1cdUVGRkZGIGR1ZSB0byBpdCBmcmVlemluZyB1cCBQaGFudG9tSlMKICAgKi8KICB2YXIgdW5pY29kZVJlZ0V4cCA9IC9hLXpBLVpcdTAwQjdcdTAwQzAtXHUwMEQ2XHUwMEQ4LVx1MDBGNlx1MDBGOC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjAzRi1cdTIwNDBcdTIwNzAtXHUyMThGXHUyQzAwLVx1MkZFRlx1MzAwMS1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZGRC87CgogIC8qKgogICAqIENoZWNrIGlmIGEgc3RyaW5nIHN0YXJ0cyB3aXRoICQgb3IgXwogICAqLwogIGZ1bmN0aW9uIGlzUmVzZXJ2ZWQgKHN0cikgewogICAgdmFyIGMgPSAoc3RyICsgJycpLmNoYXJDb2RlQXQoMCk7CiAgICByZXR1cm4gYyA9PT0gMHgyNCB8fCBjID09PSAweDVGCiAgfQoKICAvKioKICAgKiBEZWZpbmUgYSBwcm9wZXJ0eS4KICAgKi8KICBmdW5jdGlvbiBkZWYgKG9iaiwga2V5LCB2YWwsIGVudW1lcmFibGUpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICB2YWx1ZTogdmFsLAogICAgICBlbnVtZXJhYmxlOiAhIWVudW1lcmFibGUsCiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2Ugc2ltcGxlIHBhdGguCiAgICovCiAgdmFyIGJhaWxSRSA9IG5ldyBSZWdFeHAoKCJbXiIgKyAodW5pY29kZVJlZ0V4cC5zb3VyY2UpICsgIi4kX1xcZF0iKSk7CiAgZnVuY3Rpb24gcGFyc2VQYXRoIChwYXRoKSB7CiAgICBpZiAoYmFpbFJFLnRlc3QocGF0aCkpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICByZXR1cm4gZnVuY3Rpb24gKG9iaikgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlZ21lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCFvYmopIHsgcmV0dXJuIH0KICAgICAgICBvYmogPSBvYmpbc2VnbWVudHNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiBvYmoKICAgIH0KICB9CgogIC8qICAqLwoKICAvLyBjYW4gd2UgdXNlIF9fcHJvdG9fXz8KICB2YXIgaGFzUHJvdG8gPSAnX19wcm90b19fJyBpbiB7fTsKCiAgLy8gQnJvd3NlciBlbnZpcm9ubWVudCBzbmlmZmluZwogIHZhciBpbkJyb3dzZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJzsKICB2YXIgaW5XZWV4ID0gdHlwZW9mIFdYRW52aXJvbm1lbnQgIT09ICd1bmRlZmluZWQnICYmICEhV1hFbnZpcm9ubWVudC5wbGF0Zm9ybTsKICB2YXIgd2VleFBsYXRmb3JtID0gaW5XZWV4ICYmIFdYRW52aXJvbm1lbnQucGxhdGZvcm0udG9Mb3dlckNhc2UoKTsKICB2YXIgVUEgPSBpbkJyb3dzZXIgJiYgd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKICB2YXIgaXNJRSA9IFVBICYmIC9tc2llfHRyaWRlbnQvLnRlc3QoVUEpOwogIHZhciBpc0lFOSA9IFVBICYmIFVBLmluZGV4T2YoJ21zaWUgOS4wJykgPiAwOwogIHZhciBpc0VkZ2UgPSBVQSAmJiBVQS5pbmRleE9mKCdlZGdlLycpID4gMDsKICB2YXIgaXNBbmRyb2lkID0gKFVBICYmIFVBLmluZGV4T2YoJ2FuZHJvaWQnKSA+IDApIHx8ICh3ZWV4UGxhdGZvcm0gPT09ICdhbmRyb2lkJyk7CiAgdmFyIGlzSU9TID0gKFVBICYmIC9pcGhvbmV8aXBhZHxpcG9kfGlvcy8udGVzdChVQSkpIHx8ICh3ZWV4UGxhdGZvcm0gPT09ICdpb3MnKTsKICB2YXIgaXNDaHJvbWUgPSBVQSAmJiAvY2hyb21lXC9cZCsvLnRlc3QoVUEpICYmICFpc0VkZ2U7CiAgdmFyIGlzUGhhbnRvbUpTID0gVUEgJiYgL3BoYW50b21qcy8udGVzdChVQSk7CiAgdmFyIGlzRkYgPSBVQSAmJiBVQS5tYXRjaCgvZmlyZWZveFwvKFxkKykvKTsKCiAgLy8gRmlyZWZveCBoYXMgYSAid2F0Y2giIGZ1bmN0aW9uIG9uIE9iamVjdC5wcm90b3R5cGUuLi4KICB2YXIgbmF0aXZlV2F0Y2ggPSAoe30pLndhdGNoOwoKICB2YXIgc3VwcG9ydHNQYXNzaXZlID0gZmFsc2U7CiAgaWYgKGluQnJvd3NlcikgewogICAgdHJ5IHsKICAgICAgdmFyIG9wdHMgPSB7fTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdHMsICdwYXNzaXZlJywgKHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCAoKSB7CiAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgICAgc3VwcG9ydHNQYXNzaXZlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pKTsgLy8gaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zsb3cvaXNzdWVzLzI4NQogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndGVzdC1wYXNzaXZlJywgbnVsbCwgb3B0cyk7CiAgICB9IGNhdGNoIChlKSB7fQogIH0KCiAgLy8gdGhpcyBuZWVkcyB0byBiZSBsYXp5LWV2YWxlZCBiZWNhdXNlIHZ1ZSBtYXkgYmUgcmVxdWlyZWQgYmVmb3JlCiAgLy8gdnVlLXNlcnZlci1yZW5kZXJlciBjYW4gc2V0IFZVRV9FTlYKICB2YXIgX2lzU2VydmVyOwogIHZhciBpc1NlcnZlclJlbmRlcmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChfaXNTZXJ2ZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKCFpbkJyb3dzZXIgJiYgIWluV2VleCAmJiB0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIC8vIGRldGVjdCBwcmVzZW5jZSBvZiB2dWUtc2VydmVyLXJlbmRlcmVyIGFuZCBhdm9pZAogICAgICAgIC8vIFdlYnBhY2sgc2hpbW1pbmcgdGhlIHByb2Nlc3MKICAgICAgICBfaXNTZXJ2ZXIgPSBnbG9iYWxbJ3Byb2Nlc3MnXSAmJiBnbG9iYWxbJ3Byb2Nlc3MnXS5lbnYuVlVFX0VOViA9PT0gJ3NlcnZlcic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgX2lzU2VydmVyID0gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBfaXNTZXJ2ZXIKICB9OwoKICAvLyBkZXRlY3QgZGV2dG9vbHMKICB2YXIgZGV2dG9vbHMgPSBpbkJyb3dzZXIgJiYgd2luZG93Ll9fVlVFX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgZnVuY3Rpb24gaXNOYXRpdmUgKEN0b3IpIHsKICAgIHJldHVybiB0eXBlb2YgQ3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiAvbmF0aXZlIGNvZGUvLnRlc3QoQ3Rvci50b1N0cmluZygpKQogIH0KCiAgdmFyIGhhc1N5bWJvbCA9CiAgICB0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTeW1ib2wpICYmCiAgICB0eXBlb2YgUmVmbGVjdCAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUmVmbGVjdC5vd25LZXlzKTsKCiAgdmFyIF9TZXQ7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovIC8vICRmbG93LWRpc2FibGUtbGluZQogIGlmICh0eXBlb2YgU2V0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTZXQpKSB7CiAgICAvLyB1c2UgbmF0aXZlIFNldCB3aGVuIGF2YWlsYWJsZS4KICAgIF9TZXQgPSBTZXQ7CiAgfSBlbHNlIHsKICAgIC8vIGEgbm9uLXN0YW5kYXJkIFNldCBwb2x5ZmlsbCB0aGF0IG9ubHkgd29ya3Mgd2l0aCBwcmltaXRpdmUga2V5cy4KICAgIF9TZXQgPSAvKkBfX1BVUkVfXyovKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gU2V0ICgpIHsKICAgICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIH0KICAgICAgU2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiBoYXMgKGtleSkgewogICAgICAgIHJldHVybiB0aGlzLnNldFtrZXldID09PSB0cnVlCiAgICAgIH07CiAgICAgIFNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gYWRkIChrZXkpIHsKICAgICAgICB0aGlzLnNldFtrZXldID0gdHJ1ZTsKICAgICAgfTsKICAgICAgU2V0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyICgpIHsKICAgICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIH07CgogICAgICByZXR1cm4gU2V0OwogICAgfSgpKTsKICB9CgogIC8qICAqLwoKICB2YXIgd2FybiA9IG5vb3A7CiAgdmFyIHRpcCA9IG5vb3A7CiAgdmFyIGdlbmVyYXRlQ29tcG9uZW50VHJhY2UgPSAobm9vcCk7IC8vIHdvcmsgYXJvdW5kIGZsb3cgY2hlY2sKICB2YXIgZm9ybWF0Q29tcG9uZW50TmFtZSA9IChub29wKTsKCiAgewogICAgdmFyIGhhc0NvbnNvbGUgPSB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCc7CiAgICB2YXIgY2xhc3NpZnlSRSA9IC8oPzpefFstX10pKFx3KS9nOwogICAgdmFyIGNsYXNzaWZ5ID0gZnVuY3Rpb24gKHN0cikgeyByZXR1cm4gc3RyCiAgICAgIC5yZXBsYWNlKGNsYXNzaWZ5UkUsIGZ1bmN0aW9uIChjKSB7IHJldHVybiBjLnRvVXBwZXJDYXNlKCk7IH0pCiAgICAgIC5yZXBsYWNlKC9bLV9dL2csICcnKTsgfTsKCiAgICB3YXJuID0gZnVuY3Rpb24gKG1zZywgdm0pIHsKICAgICAgdmFyIHRyYWNlID0gdm0gPyBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSA6ICcnOwoKICAgICAgaWYgKGNvbmZpZy53YXJuSGFuZGxlcikgewogICAgICAgIGNvbmZpZy53YXJuSGFuZGxlci5jYWxsKG51bGwsIG1zZywgdm0sIHRyYWNlKTsKICAgICAgfSBlbHNlIGlmIChoYXNDb25zb2xlICYmICghY29uZmlnLnNpbGVudCkpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCgiW1Z1ZSB3YXJuXTogIiArIG1zZyArIHRyYWNlKSk7CiAgICAgIH0KICAgIH07CgogICAgdGlwID0gZnVuY3Rpb24gKG1zZywgdm0pIHsKICAgICAgaWYgKGhhc0NvbnNvbGUgJiYgKCFjb25maWcuc2lsZW50KSkgewogICAgICAgIGNvbnNvbGUud2FybigiW1Z1ZSB0aXBdOiAiICsgbXNnICsgKAogICAgICAgICAgdm0gPyBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSA6ICcnCiAgICAgICAgKSk7CiAgICAgIH0KICAgIH07CgogICAgZm9ybWF0Q29tcG9uZW50TmFtZSA9IGZ1bmN0aW9uICh2bSwgaW5jbHVkZUZpbGUpIHsKICAgICAgaWYgKHZtLiRyb290ID09PSB2bSkgewogICAgICAgIHJldHVybiAnPFJvb3Q+JwogICAgICB9CiAgICAgIHZhciBvcHRpb25zID0gdHlwZW9mIHZtID09PSAnZnVuY3Rpb24nICYmIHZtLmNpZCAhPSBudWxsCiAgICAgICAgPyB2bS5vcHRpb25zCiAgICAgICAgOiB2bS5faXNWdWUKICAgICAgICAgID8gdm0uJG9wdGlvbnMgfHwgdm0uY29uc3RydWN0b3Iub3B0aW9ucwogICAgICAgICAgOiB2bTsKICAgICAgdmFyIG5hbWUgPSBvcHRpb25zLm5hbWUgfHwgb3B0aW9ucy5fY29tcG9uZW50VGFnOwogICAgICB2YXIgZmlsZSA9IG9wdGlvbnMuX19maWxlOwogICAgICBpZiAoIW5hbWUgJiYgZmlsZSkgewogICAgICAgIHZhciBtYXRjaCA9IGZpbGUubWF0Y2goLyhbXi9cXF0rKVwudnVlJC8pOwogICAgICAgIG5hbWUgPSBtYXRjaCAmJiBtYXRjaFsxXTsKICAgICAgfQoKICAgICAgcmV0dXJuICgKICAgICAgICAobmFtZSA/ICgiPCIgKyAoY2xhc3NpZnkobmFtZSkpICsgIj4iKSA6ICI8QW5vbnltb3VzPiIpICsKICAgICAgICAoZmlsZSAmJiBpbmNsdWRlRmlsZSAhPT0gZmFsc2UgPyAoIiBhdCAiICsgZmlsZSkgOiAnJykKICAgICAgKQogICAgfTsKCiAgICB2YXIgcmVwZWF0ID0gZnVuY3Rpb24gKHN0ciwgbikgewogICAgICB2YXIgcmVzID0gJyc7CiAgICAgIHdoaWxlIChuKSB7CiAgICAgICAgaWYgKG4gJSAyID09PSAxKSB7IHJlcyArPSBzdHI7IH0KICAgICAgICBpZiAobiA+IDEpIHsgc3RyICs9IHN0cjsgfQogICAgICAgIG4gPj49IDE7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlcwogICAgfTsKCiAgICBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlID0gZnVuY3Rpb24gKHZtKSB7CiAgICAgIGlmICh2bS5faXNWdWUgJiYgdm0uJHBhcmVudCkgewogICAgICAgIHZhciB0cmVlID0gW107CiAgICAgICAgdmFyIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CiAgICAgICAgd2hpbGUgKHZtKSB7CiAgICAgICAgICBpZiAodHJlZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBsYXN0ID0gdHJlZVt0cmVlLmxlbmd0aCAtIDFdOwogICAgICAgICAgICBpZiAobGFzdC5jb25zdHJ1Y3RvciA9PT0gdm0uY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UrKzsKICAgICAgICAgICAgICB2bSA9IHZtLiRwYXJlbnQ7CiAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UgPiAwKSB7CiAgICAgICAgICAgICAgdHJlZVt0cmVlLmxlbmd0aCAtIDFdID0gW2xhc3QsIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZV07CiAgICAgICAgICAgICAgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdHJlZS5wdXNoKHZtKTsKICAgICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICdcblxuZm91bmQgaW5cblxuJyArIHRyZWUKICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKHZtLCBpKSB7IHJldHVybiAoIiIgKyAoaSA9PT0gMCA/ICctLS0+ICcgOiByZXBlYXQoJyAnLCA1ICsgaSAqIDIpKSArIChBcnJheS5pc0FycmF5KHZtKQogICAgICAgICAgICAgID8gKChmb3JtYXRDb21wb25lbnROYW1lKHZtWzBdKSkgKyAiLi4uICgiICsgKHZtWzFdKSArICIgcmVjdXJzaXZlIGNhbGxzKSIpCiAgICAgICAgICAgICAgOiBmb3JtYXRDb21wb25lbnROYW1lKHZtKSkpOyB9KQogICAgICAgICAgLmpvaW4oJ1xuJykKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gKCJcblxuKGZvdW5kIGluICIgKyAoZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkpICsgIikiKQogICAgICB9CiAgICB9OwogIH0KCiAgLyogICovCgogIHZhciB1aWQgPSAwOwoKICAvKioKICAgKiBBIGRlcCBpcyBhbiBvYnNlcnZhYmxlIHRoYXQgY2FuIGhhdmUgbXVsdGlwbGUKICAgKiBkaXJlY3RpdmVzIHN1YnNjcmliaW5nIHRvIGl0LgogICAqLwogIHZhciBEZXAgPSBmdW5jdGlvbiBEZXAgKCkgewogICAgdGhpcy5pZCA9IHVpZCsrOwogICAgdGhpcy5zdWJzID0gW107CiAgfTsKCiAgRGVwLnByb3RvdHlwZS5hZGRTdWIgPSBmdW5jdGlvbiBhZGRTdWIgKHN1YikgewogICAgdGhpcy5zdWJzLnB1c2goc3ViKTsKICB9OwoKICBEZXAucHJvdG90eXBlLnJlbW92ZVN1YiA9IGZ1bmN0aW9uIHJlbW92ZVN1YiAoc3ViKSB7CiAgICByZW1vdmUodGhpcy5zdWJzLCBzdWIpOwogIH07CgogIERlcC5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gZGVwZW5kICgpIHsKICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgIERlcC50YXJnZXQuYWRkRGVwKHRoaXMpOwogICAgfQogIH07CgogIERlcC5wcm90b3R5cGUubm90aWZ5ID0gZnVuY3Rpb24gbm90aWZ5ICgpIHsKICAgIC8vIHN0YWJpbGl6ZSB0aGUgc3Vic2NyaWJlciBsaXN0IGZpcnN0CiAgICB2YXIgc3VicyA9IHRoaXMuc3Vicy5zbGljZSgpOwogICAgaWYgKCFjb25maWcuYXN5bmMpIHsKICAgICAgLy8gc3VicyBhcmVuJ3Qgc29ydGVkIGluIHNjaGVkdWxlciBpZiBub3QgcnVubmluZyBhc3luYwogICAgICAvLyB3ZSBuZWVkIHRvIHNvcnQgdGhlbSBub3cgdG8gbWFrZSBzdXJlIHRoZXkgZmlyZSBpbiBjb3JyZWN0CiAgICAgIC8vIG9yZGVyCiAgICAgIHN1YnMuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gYS5pZCAtIGIuaWQ7IH0pOwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBzdWJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBzdWJzW2ldLnVwZGF0ZSgpOwogICAgfQogIH07CgogIC8vIFRoZSBjdXJyZW50IHRhcmdldCB3YXRjaGVyIGJlaW5nIGV2YWx1YXRlZC4KICAvLyBUaGlzIGlzIGdsb2JhbGx5IHVuaXF1ZSBiZWNhdXNlIG9ubHkgb25lIHdhdGNoZXIKICAvLyBjYW4gYmUgZXZhbHVhdGVkIGF0IGEgdGltZS4KICBEZXAudGFyZ2V0ID0gbnVsbDsKICB2YXIgdGFyZ2V0U3RhY2sgPSBbXTsKCiAgZnVuY3Rpb24gcHVzaFRhcmdldCAodGFyZ2V0KSB7CiAgICB0YXJnZXRTdGFjay5wdXNoKHRhcmdldCk7CiAgICBEZXAudGFyZ2V0ID0gdGFyZ2V0OwogIH0KCiAgZnVuY3Rpb24gcG9wVGFyZ2V0ICgpIHsKICAgIHRhcmdldFN0YWNrLnBvcCgpOwogICAgRGVwLnRhcmdldCA9IHRhcmdldFN0YWNrW3RhcmdldFN0YWNrLmxlbmd0aCAtIDFdOwogIH0KCiAgLyogICovCgogIHZhciBWTm9kZSA9IGZ1bmN0aW9uIFZOb2RlICgKICAgIHRhZywKICAgIGRhdGEsCiAgICBjaGlsZHJlbiwKICAgIHRleHQsCiAgICBlbG0sCiAgICBjb250ZXh0LAogICAgY29tcG9uZW50T3B0aW9ucywKICAgIGFzeW5jRmFjdG9yeQogICkgewogICAgdGhpcy50YWcgPSB0YWc7CiAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMuZWxtID0gZWxtOwogICAgdGhpcy5ucyA9IHVuZGVmaW5lZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICB0aGlzLmZuQ29udGV4dCA9IHVuZGVmaW5lZDsKICAgIHRoaXMuZm5PcHRpb25zID0gdW5kZWZpbmVkOwogICAgdGhpcy5mblNjb3BlSWQgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmtleSA9IGRhdGEgJiYgZGF0YS5rZXk7CiAgICB0aGlzLmNvbXBvbmVudE9wdGlvbnMgPSBjb21wb25lbnRPcHRpb25zOwogICAgdGhpcy5jb21wb25lbnRJbnN0YW5jZSA9IHVuZGVmaW5lZDsKICAgIHRoaXMucGFyZW50ID0gdW5kZWZpbmVkOwogICAgdGhpcy5yYXcgPSBmYWxzZTsKICAgIHRoaXMuaXNTdGF0aWMgPSBmYWxzZTsKICAgIHRoaXMuaXNSb290SW5zZXJ0ID0gdHJ1ZTsKICAgIHRoaXMuaXNDb21tZW50ID0gZmFsc2U7CiAgICB0aGlzLmlzQ2xvbmVkID0gZmFsc2U7CiAgICB0aGlzLmlzT25jZSA9IGZhbHNlOwogICAgdGhpcy5hc3luY0ZhY3RvcnkgPSBhc3luY0ZhY3Rvcnk7CiAgICB0aGlzLmFzeW5jTWV0YSA9IHVuZGVmaW5lZDsKICAgIHRoaXMuaXNBc3luY1BsYWNlaG9sZGVyID0gZmFsc2U7CiAgfTsKCiAgdmFyIHByb3RvdHlwZUFjY2Vzc29ycyA9IHsgY2hpbGQ6IHsgY29uZmlndXJhYmxlOiB0cnVlIH0gfTsKCiAgLy8gREVQUkVDQVRFRDogYWxpYXMgZm9yIGNvbXBvbmVudEluc3RhbmNlIGZvciBiYWNrd2FyZHMgY29tcGF0LgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgcHJvdG90eXBlQWNjZXNzb3JzLmNoaWxkLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvbmVudEluc3RhbmNlCiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoIFZOb2RlLnByb3RvdHlwZSwgcHJvdG90eXBlQWNjZXNzb3JzICk7CgogIHZhciBjcmVhdGVFbXB0eVZOb2RlID0gZnVuY3Rpb24gKHRleHQpIHsKICAgIGlmICggdGV4dCA9PT0gdm9pZCAwICkgdGV4dCA9ICcnOwoKICAgIHZhciBub2RlID0gbmV3IFZOb2RlKCk7CiAgICBub2RlLnRleHQgPSB0ZXh0OwogICAgbm9kZS5pc0NvbW1lbnQgPSB0cnVlOwogICAgcmV0dXJuIG5vZGUKICB9OwoKICBmdW5jdGlvbiBjcmVhdGVUZXh0Vk5vZGUgKHZhbCkgewogICAgcmV0dXJuIG5ldyBWTm9kZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBTdHJpbmcodmFsKSkKICB9CgogIC8vIG9wdGltaXplZCBzaGFsbG93IGNsb25lCiAgLy8gdXNlZCBmb3Igc3RhdGljIG5vZGVzIGFuZCBzbG90IG5vZGVzIGJlY2F1c2UgdGhleSBtYXkgYmUgcmV1c2VkIGFjcm9zcwogIC8vIG11bHRpcGxlIHJlbmRlcnMsIGNsb25pbmcgdGhlbSBhdm9pZHMgZXJyb3JzIHdoZW4gRE9NIG1hbmlwdWxhdGlvbnMgcmVseQogIC8vIG9uIHRoZWlyIGVsbSByZWZlcmVuY2UuCiAgZnVuY3Rpb24gY2xvbmVWTm9kZSAodm5vZGUpIHsKICAgIHZhciBjbG9uZWQgPSBuZXcgVk5vZGUoCiAgICAgIHZub2RlLnRhZywKICAgICAgdm5vZGUuZGF0YSwKICAgICAgLy8gIzc5NzUKICAgICAgLy8gY2xvbmUgY2hpbGRyZW4gYXJyYXkgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgaW4gY2FzZSBvZiBjbG9uaW5nCiAgICAgIC8vIGEgY2hpbGQuCiAgICAgIHZub2RlLmNoaWxkcmVuICYmIHZub2RlLmNoaWxkcmVuLnNsaWNlKCksCiAgICAgIHZub2RlLnRleHQsCiAgICAgIHZub2RlLmVsbSwKICAgICAgdm5vZGUuY29udGV4dCwKICAgICAgdm5vZGUuY29tcG9uZW50T3B0aW9ucywKICAgICAgdm5vZGUuYXN5bmNGYWN0b3J5CiAgICApOwogICAgY2xvbmVkLm5zID0gdm5vZGUubnM7CiAgICBjbG9uZWQuaXNTdGF0aWMgPSB2bm9kZS5pc1N0YXRpYzsKICAgIGNsb25lZC5rZXkgPSB2bm9kZS5rZXk7CiAgICBjbG9uZWQuaXNDb21tZW50ID0gdm5vZGUuaXNDb21tZW50OwogICAgY2xvbmVkLmZuQ29udGV4dCA9IHZub2RlLmZuQ29udGV4dDsKICAgIGNsb25lZC5mbk9wdGlvbnMgPSB2bm9kZS5mbk9wdGlvbnM7CiAgICBjbG9uZWQuZm5TY29wZUlkID0gdm5vZGUuZm5TY29wZUlkOwogICAgY2xvbmVkLmFzeW5jTWV0YSA9IHZub2RlLmFzeW5jTWV0YTsKICAgIGNsb25lZC5pc0Nsb25lZCA9IHRydWU7CiAgICByZXR1cm4gY2xvbmVkCiAgfQoKICAvKgogICAqIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aAogICAqIGR5bmFtaWNhbGx5IGFjY2Vzc2luZyBtZXRob2RzIG9uIEFycmF5IHByb3RvdHlwZQogICAqLwoKICB2YXIgYXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZTsKICB2YXIgYXJyYXlNZXRob2RzID0gT2JqZWN0LmNyZWF0ZShhcnJheVByb3RvKTsKCiAgdmFyIG1ldGhvZHNUb1BhdGNoID0gWwogICAgJ3B1c2gnLAogICAgJ3BvcCcsCiAgICAnc2hpZnQnLAogICAgJ3Vuc2hpZnQnLAogICAgJ3NwbGljZScsCiAgICAnc29ydCcsCiAgICAncmV2ZXJzZScKICBdOwoKICAvKioKICAgKiBJbnRlcmNlcHQgbXV0YXRpbmcgbWV0aG9kcyBhbmQgZW1pdCBldmVudHMKICAgKi8KICBtZXRob2RzVG9QYXRjaC5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgIC8vIGNhY2hlIG9yaWdpbmFsIG1ldGhvZAogICAgdmFyIG9yaWdpbmFsID0gYXJyYXlQcm90b1ttZXRob2RdOwogICAgZGVmKGFycmF5TWV0aG9kcywgbWV0aG9kLCBmdW5jdGlvbiBtdXRhdG9yICgpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgd2hpbGUgKCBsZW4tLSApIGFyZ3NbIGxlbiBdID0gYXJndW1lbnRzWyBsZW4gXTsKCiAgICAgIHZhciByZXN1bHQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgdmFyIG9iID0gdGhpcy5fX29iX187CiAgICAgIHZhciBpbnNlcnRlZDsKICAgICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgICBjYXNlICdwdXNoJzoKICAgICAgICBjYXNlICd1bnNoaWZ0JzoKICAgICAgICAgIGluc2VydGVkID0gYXJnczsKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAnc3BsaWNlJzoKICAgICAgICAgIGluc2VydGVkID0gYXJncy5zbGljZSgyKTsKICAgICAgICAgIGJyZWFrCiAgICAgIH0KICAgICAgaWYgKGluc2VydGVkKSB7IG9iLm9ic2VydmVBcnJheShpbnNlcnRlZCk7IH0KICAgICAgLy8gbm90aWZ5IGNoYW5nZQogICAgICBvYi5kZXAubm90aWZ5KCk7CiAgICAgIHJldHVybiByZXN1bHQKICAgIH0pOwogIH0pOwoKICAvKiAgKi8KCiAgdmFyIGFycmF5S2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGFycmF5TWV0aG9kcyk7CgogIC8qKgogICAqIEluIHNvbWUgY2FzZXMgd2UgbWF5IHdhbnQgdG8gZGlzYWJsZSBvYnNlcnZhdGlvbiBpbnNpZGUgYSBjb21wb25lbnQncwogICAqIHVwZGF0ZSBjb21wdXRhdGlvbi4KICAgKi8KICB2YXIgc2hvdWxkT2JzZXJ2ZSA9IHRydWU7CgogIGZ1bmN0aW9uIHRvZ2dsZU9ic2VydmluZyAodmFsdWUpIHsKICAgIHNob3VsZE9ic2VydmUgPSB2YWx1ZTsKICB9CgogIC8qKgogICAqIE9ic2VydmVyIGNsYXNzIHRoYXQgaXMgYXR0YWNoZWQgdG8gZWFjaCBvYnNlcnZlZAogICAqIG9iamVjdC4gT25jZSBhdHRhY2hlZCwgdGhlIG9ic2VydmVyIGNvbnZlcnRzIHRoZSB0YXJnZXQKICAgKiBvYmplY3QncyBwcm9wZXJ0eSBrZXlzIGludG8gZ2V0dGVyL3NldHRlcnMgdGhhdAogICAqIGNvbGxlY3QgZGVwZW5kZW5jaWVzIGFuZCBkaXNwYXRjaCB1cGRhdGVzLgogICAqLwogIHZhciBPYnNlcnZlciA9IGZ1bmN0aW9uIE9ic2VydmVyICh2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgdGhpcy5kZXAgPSBuZXcgRGVwKCk7CiAgICB0aGlzLnZtQ291bnQgPSAwOwogICAgZGVmKHZhbHVlLCAnX19vYl9fJywgdGhpcyk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgaWYgKGhhc1Byb3RvKSB7CiAgICAgICAgcHJvdG9BdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvcHlBdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMsIGFycmF5S2V5cyk7CiAgICAgIH0KICAgICAgdGhpcy5vYnNlcnZlQXJyYXkodmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy53YWxrKHZhbHVlKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBXYWxrIHRocm91Z2ggYWxsIHByb3BlcnRpZXMgYW5kIGNvbnZlcnQgdGhlbSBpbnRvCiAgICogZ2V0dGVyL3NldHRlcnMuIFRoaXMgbWV0aG9kIHNob3VsZCBvbmx5IGJlIGNhbGxlZCB3aGVuCiAgICogdmFsdWUgdHlwZSBpcyBPYmplY3QuCiAgICovCiAgT2JzZXJ2ZXIucHJvdG90eXBlLndhbGsgPSBmdW5jdGlvbiB3YWxrIChvYmopIHsKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBkZWZpbmVSZWFjdGl2ZSQkMShvYmosIGtleXNbaV0pOwogICAgfQogIH07CgogIC8qKgogICAqIE9ic2VydmUgYSBsaXN0IG9mIEFycmF5IGl0ZW1zLgogICAqLwogIE9ic2VydmVyLnByb3RvdHlwZS5vYnNlcnZlQXJyYXkgPSBmdW5jdGlvbiBvYnNlcnZlQXJyYXkgKGl0ZW1zKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGl0ZW1zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBvYnNlcnZlKGl0ZW1zW2ldKTsKICAgIH0KICB9OwoKICAvLyBoZWxwZXJzCgogIC8qKgogICAqIEF1Z21lbnQgYSB0YXJnZXQgT2JqZWN0IG9yIEFycmF5IGJ5IGludGVyY2VwdGluZwogICAqIHRoZSBwcm90b3R5cGUgY2hhaW4gdXNpbmcgX19wcm90b19fCiAgICovCiAgZnVuY3Rpb24gcHJvdG9BdWdtZW50ICh0YXJnZXQsIHNyYykgewogICAgLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KICAgIHRhcmdldC5fX3Byb3RvX18gPSBzcmM7CiAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXByb3RvICovCiAgfQoKICAvKioKICAgKiBBdWdtZW50IGEgdGFyZ2V0IE9iamVjdCBvciBBcnJheSBieSBkZWZpbmluZwogICAqIGhpZGRlbiBwcm9wZXJ0aWVzLgogICAqLwogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgZnVuY3Rpb24gY29weUF1Z21lbnQgKHRhcmdldCwgc3JjLCBrZXlzKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICBkZWYodGFyZ2V0LCBrZXksIHNyY1trZXldKTsKICAgIH0KICB9CgogIC8qKgogICAqIEF0dGVtcHQgdG8gY3JlYXRlIGFuIG9ic2VydmVyIGluc3RhbmNlIGZvciBhIHZhbHVlLAogICAqIHJldHVybnMgdGhlIG5ldyBvYnNlcnZlciBpZiBzdWNjZXNzZnVsbHkgb2JzZXJ2ZWQsCiAgICogb3IgdGhlIGV4aXN0aW5nIG9ic2VydmVyIGlmIHRoZSB2YWx1ZSBhbHJlYWR5IGhhcyBvbmUuCiAgICovCiAgZnVuY3Rpb24gb2JzZXJ2ZSAodmFsdWUsIGFzUm9vdERhdGEpIHsKICAgIGlmICghaXNPYmplY3QodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgb2I7CiAgICBpZiAoaGFzT3duKHZhbHVlLCAnX19vYl9fJykgJiYgdmFsdWUuX19vYl9fIGluc3RhbmNlb2YgT2JzZXJ2ZXIpIHsKICAgICAgb2IgPSB2YWx1ZS5fX29iX187CiAgICB9IGVsc2UgaWYgKAogICAgICBzaG91bGRPYnNlcnZlICYmCiAgICAgICFpc1NlcnZlclJlbmRlcmluZygpICYmCiAgICAgIChBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BsYWluT2JqZWN0KHZhbHVlKSkgJiYKICAgICAgT2JqZWN0LmlzRXh0ZW5zaWJsZSh2YWx1ZSkgJiYKICAgICAgIXZhbHVlLl9pc1Z1ZQogICAgKSB7CiAgICAgIG9iID0gbmV3IE9ic2VydmVyKHZhbHVlKTsKICAgIH0KICAgIGlmIChhc1Jvb3REYXRhICYmIG9iKSB7CiAgICAgIG9iLnZtQ291bnQrKzsKICAgIH0KICAgIHJldHVybiBvYgogIH0KCiAgLyoqCiAgICogRGVmaW5lIGEgcmVhY3RpdmUgcHJvcGVydHkgb24gYW4gT2JqZWN0LgogICAqLwogIGZ1bmN0aW9uIGRlZmluZVJlYWN0aXZlJCQxICgKICAgIG9iaiwKICAgIGtleSwKICAgIHZhbCwKICAgIGN1c3RvbVNldHRlciwKICAgIHNoYWxsb3cKICApIHsKICAgIHZhciBkZXAgPSBuZXcgRGVwKCk7CgogICAgdmFyIHByb3BlcnR5ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSk7CiAgICBpZiAocHJvcGVydHkgJiYgcHJvcGVydHkuY29uZmlndXJhYmxlID09PSBmYWxzZSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBjYXRlciBmb3IgcHJlLWRlZmluZWQgZ2V0dGVyL3NldHRlcnMKICAgIHZhciBnZXR0ZXIgPSBwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5nZXQ7CiAgICB2YXIgc2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuc2V0OwogICAgaWYgKCghZ2V0dGVyIHx8IHNldHRlcikgJiYgYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICB2YWwgPSBvYmpba2V5XTsKICAgIH0KCiAgICB2YXIgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUodmFsKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gcmVhY3RpdmVHZXR0ZXIgKCkgewogICAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKG9iaikgOiB2YWw7CiAgICAgICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgICAgIGRlcC5kZXBlbmQoKTsKICAgICAgICAgIGlmIChjaGlsZE9iKSB7CiAgICAgICAgICAgIGNoaWxkT2IuZGVwLmRlcGVuZCgpOwogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBkZXBlbmRBcnJheSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gcmVhY3RpdmVTZXR0ZXIgKG5ld1ZhbCkgewogICAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKG9iaikgOiB2YWw7CiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tc2VsZi1jb21wYXJlICovCiAgICAgICAgaWYgKG5ld1ZhbCA9PT0gdmFsdWUgfHwgKG5ld1ZhbCAhPT0gbmV3VmFsICYmIHZhbHVlICE9PSB2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXNlbGYtY29tcGFyZSAqLwogICAgICAgIGlmIChjdXN0b21TZXR0ZXIpIHsKICAgICAgICAgIGN1c3RvbVNldHRlcigpOwogICAgICAgIH0KICAgICAgICAvLyAjNzk4MTogZm9yIGFjY2Vzc29yIHByb3BlcnRpZXMgd2l0aG91dCBzZXR0ZXIKICAgICAgICBpZiAoZ2V0dGVyICYmICFzZXR0ZXIpIHsgcmV0dXJuIH0KICAgICAgICBpZiAoc2V0dGVyKSB7CiAgICAgICAgICBzZXR0ZXIuY2FsbChvYmosIG5ld1ZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbCA9IG5ld1ZhbDsKICAgICAgICB9CiAgICAgICAgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUobmV3VmFsKTsKICAgICAgICBkZXAubm90aWZ5KCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICogU2V0IGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBBZGRzIHRoZSBuZXcgcHJvcGVydHkgYW5kCiAgICogdHJpZ2dlcnMgY2hhbmdlIG5vdGlmaWNhdGlvbiBpZiB0aGUgcHJvcGVydHkgZG9lc24ndAogICAqIGFscmVhZHkgZXhpc3QuCiAgICovCiAgZnVuY3Rpb24gc2V0ICh0YXJnZXQsIGtleSwgdmFsKSB7CiAgICBpZiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkKICAgICkgewogICAgICB3YXJuKCgiQ2Fubm90IHNldCByZWFjdGl2ZSBwcm9wZXJ0eSBvbiB1bmRlZmluZWQsIG51bGwsIG9yIHByaW1pdGl2ZSB2YWx1ZTogIiArICgodGFyZ2V0KSkpKTsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgICB0YXJnZXQubGVuZ3RoID0gTWF0aC5tYXgodGFyZ2V0Lmxlbmd0aCwga2V5KTsKICAgICAgdGFyZ2V0LnNwbGljZShrZXksIDEsIHZhbCk7CiAgICAgIHJldHVybiB2YWwKICAgIH0KICAgIGlmIChrZXkgaW4gdGFyZ2V0ICYmICEoa2V5IGluIE9iamVjdC5wcm90b3R5cGUpKSB7CiAgICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgICByZXR1cm4gdmFsCiAgICB9CiAgICB2YXIgb2IgPSAodGFyZ2V0KS5fX29iX187CiAgICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCAob2IgJiYgb2Iudm1Db3VudCkpIHsKICAgICAgd2FybigKICAgICAgICAnQXZvaWQgYWRkaW5nIHJlYWN0aXZlIHByb3BlcnRpZXMgdG8gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArCiAgICAgICAgJ2F0IHJ1bnRpbWUgLSBkZWNsYXJlIGl0IHVwZnJvbnQgaW4gdGhlIGRhdGEgb3B0aW9uLicKICAgICAgKTsKICAgICAgcmV0dXJuIHZhbAogICAgfQogICAgaWYgKCFvYikgewogICAgICB0YXJnZXRba2V5XSA9IHZhbDsKICAgICAgcmV0dXJuIHZhbAogICAgfQogICAgZGVmaW5lUmVhY3RpdmUkJDEob2IudmFsdWUsIGtleSwgdmFsKTsKICAgIG9iLmRlcC5ub3RpZnkoKTsKICAgIHJldHVybiB2YWwKICB9CgogIC8qKgogICAqIERlbGV0ZSBhIHByb3BlcnR5IGFuZCB0cmlnZ2VyIGNoYW5nZSBpZiBuZWNlc3NhcnkuCiAgICovCiAgZnVuY3Rpb24gZGVsICh0YXJnZXQsIGtleSkgewogICAgaWYgKGlzVW5kZWYodGFyZ2V0KSB8fCBpc1ByaW1pdGl2ZSh0YXJnZXQpCiAgICApIHsKICAgICAgd2FybigoIkNhbm5vdCBkZWxldGUgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIgKyAoKHRhcmdldCkpKSk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpICYmIGlzVmFsaWRBcnJheUluZGV4KGtleSkpIHsKICAgICAgdGFyZ2V0LnNwbGljZShrZXksIDEpOwogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBvYiA9ICh0YXJnZXQpLl9fb2JfXzsKICAgIGlmICh0YXJnZXQuX2lzVnVlIHx8IChvYiAmJiBvYi52bUNvdW50KSkgewogICAgICB3YXJuKAogICAgICAgICdBdm9pZCBkZWxldGluZyBwcm9wZXJ0aWVzIG9uIGEgVnVlIGluc3RhbmNlIG9yIGl0cyByb290ICRkYXRhICcgKwogICAgICAgICctIGp1c3Qgc2V0IGl0IHRvIG51bGwuJwogICAgICApOwogICAgICByZXR1cm4KICAgIH0KICAgIGlmICghaGFzT3duKHRhcmdldCwga2V5KSkgewogICAgICByZXR1cm4KICAgIH0KICAgIGRlbGV0ZSB0YXJnZXRba2V5XTsKICAgIGlmICghb2IpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBvYi5kZXAubm90aWZ5KCk7CiAgfQoKICAvKioKICAgKiBDb2xsZWN0IGRlcGVuZGVuY2llcyBvbiBhcnJheSBlbGVtZW50cyB3aGVuIHRoZSBhcnJheSBpcyB0b3VjaGVkLCBzaW5jZQogICAqIHdlIGNhbm5vdCBpbnRlcmNlcHQgYXJyYXkgZWxlbWVudCBhY2Nlc3MgbGlrZSBwcm9wZXJ0eSBnZXR0ZXJzLgogICAqLwogIGZ1bmN0aW9uIGRlcGVuZEFycmF5ICh2YWx1ZSkgewogICAgZm9yICh2YXIgZSA9ICh2b2lkIDApLCBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBlID0gdmFsdWVbaV07CiAgICAgIGUgJiYgZS5fX29iX18gJiYgZS5fX29iX18uZGVwLmRlcGVuZCgpOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgICAgIGRlcGVuZEFycmF5KGUpOwogICAgICB9CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgLyoqCiAgICogT3B0aW9uIG92ZXJ3cml0aW5nIHN0cmF0ZWdpZXMgYXJlIGZ1bmN0aW9ucyB0aGF0IGhhbmRsZQogICAqIGhvdyB0byBtZXJnZSBhIHBhcmVudCBvcHRpb24gdmFsdWUgYW5kIGEgY2hpbGQgb3B0aW9uCiAgICogdmFsdWUgaW50byB0aGUgZmluYWwgdmFsdWUuCiAgICovCiAgdmFyIHN0cmF0cyA9IGNvbmZpZy5vcHRpb25NZXJnZVN0cmF0ZWdpZXM7CgogIC8qKgogICAqIE9wdGlvbnMgd2l0aCByZXN0cmljdGlvbnMKICAgKi8KICB7CiAgICBzdHJhdHMuZWwgPSBzdHJhdHMucHJvcHNEYXRhID0gZnVuY3Rpb24gKHBhcmVudCwgY2hpbGQsIHZtLCBrZXkpIHsKICAgICAgaWYgKCF2bSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAib3B0aW9uIFwiIiArIGtleSArICJcIiBjYW4gb25seSBiZSB1c2VkIGR1cmluZyBpbnN0YW5jZSAiICsKICAgICAgICAgICdjcmVhdGlvbiB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkLicKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBkZWZhdWx0U3RyYXQocGFyZW50LCBjaGlsZCkKICAgIH07CiAgfQoKICAvKioKICAgKiBIZWxwZXIgdGhhdCByZWN1cnNpdmVseSBtZXJnZXMgdHdvIGRhdGEgb2JqZWN0cyB0b2dldGhlci4KICAgKi8KICBmdW5jdGlvbiBtZXJnZURhdGEgKHRvLCBmcm9tKSB7CiAgICBpZiAoIWZyb20pIHsgcmV0dXJuIHRvIH0KICAgIHZhciBrZXksIHRvVmFsLCBmcm9tVmFsOwoKICAgIHZhciBrZXlzID0gaGFzU3ltYm9sCiAgICAgID8gUmVmbGVjdC5vd25LZXlzKGZyb20pCiAgICAgIDogT2JqZWN0LmtleXMoZnJvbSk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGtleSA9IGtleXNbaV07CiAgICAgIC8vIGluIGNhc2UgdGhlIG9iamVjdCBpcyBhbHJlYWR5IG9ic2VydmVkLi4uCiAgICAgIGlmIChrZXkgPT09ICdfX29iX18nKSB7IGNvbnRpbnVlIH0KICAgICAgdG9WYWwgPSB0b1trZXldOwogICAgICBmcm9tVmFsID0gZnJvbVtrZXldOwogICAgICBpZiAoIWhhc093bih0bywga2V5KSkgewogICAgICAgIHNldCh0bywga2V5LCBmcm9tVmFsKTsKICAgICAgfSBlbHNlIGlmICgKICAgICAgICB0b1ZhbCAhPT0gZnJvbVZhbCAmJgogICAgICAgIGlzUGxhaW5PYmplY3QodG9WYWwpICYmCiAgICAgICAgaXNQbGFpbk9iamVjdChmcm9tVmFsKQogICAgICApIHsKICAgICAgICBtZXJnZURhdGEodG9WYWwsIGZyb21WYWwpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdG8KICB9CgogIC8qKgogICAqIERhdGEKICAgKi8KICBmdW5jdGlvbiBtZXJnZURhdGFPckZuICgKICAgIHBhcmVudFZhbCwKICAgIGNoaWxkVmFsLAogICAgdm0KICApIHsKICAgIGlmICghdm0pIHsKICAgICAgLy8gaW4gYSBWdWUuZXh0ZW5kIG1lcmdlLCBib3RoIHNob3VsZCBiZSBmdW5jdGlvbnMKICAgICAgaWYgKCFjaGlsZFZhbCkgewogICAgICAgIHJldHVybiBwYXJlbnRWYWwKICAgICAgfQogICAgICBpZiAoIXBhcmVudFZhbCkgewogICAgICAgIHJldHVybiBjaGlsZFZhbAogICAgICB9CiAgICAgIC8vIHdoZW4gcGFyZW50VmFsICYgY2hpbGRWYWwgYXJlIGJvdGggcHJlc2VudCwKICAgICAgLy8gd2UgbmVlZCB0byByZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgICAgIC8vIG1lcmdlZCByZXN1bHQgb2YgYm90aCBmdW5jdGlvbnMuLi4gbm8gbmVlZCB0bwogICAgICAvLyBjaGVjayBpZiBwYXJlbnRWYWwgaXMgYSBmdW5jdGlvbiBoZXJlIGJlY2F1c2UKICAgICAgLy8gaXQgaGFzIHRvIGJlIGEgZnVuY3Rpb24gdG8gcGFzcyBwcmV2aW91cyBtZXJnZXMuCiAgICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWREYXRhRm4gKCkgewogICAgICAgIHJldHVybiBtZXJnZURhdGEoCiAgICAgICAgICB0eXBlb2YgY2hpbGRWYWwgPT09ICdmdW5jdGlvbicgPyBjaGlsZFZhbC5jYWxsKHRoaXMsIHRoaXMpIDogY2hpbGRWYWwsCiAgICAgICAgICB0eXBlb2YgcGFyZW50VmFsID09PSAnZnVuY3Rpb24nID8gcGFyZW50VmFsLmNhbGwodGhpcywgdGhpcykgOiBwYXJlbnRWYWwKICAgICAgICApCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWRJbnN0YW5jZURhdGFGbiAoKSB7CiAgICAgICAgLy8gaW5zdGFuY2UgbWVyZ2UKICAgICAgICB2YXIgaW5zdGFuY2VEYXRhID0gdHlwZW9mIGNoaWxkVmFsID09PSAnZnVuY3Rpb24nCiAgICAgICAgICA/IGNoaWxkVmFsLmNhbGwodm0sIHZtKQogICAgICAgICAgOiBjaGlsZFZhbDsKICAgICAgICB2YXIgZGVmYXVsdERhdGEgPSB0eXBlb2YgcGFyZW50VmFsID09PSAnZnVuY3Rpb24nCiAgICAgICAgICA/IHBhcmVudFZhbC5jYWxsKHZtLCB2bSkKICAgICAgICAgIDogcGFyZW50VmFsOwogICAgICAgIGlmIChpbnN0YW5jZURhdGEpIHsKICAgICAgICAgIHJldHVybiBtZXJnZURhdGEoaW5zdGFuY2VEYXRhLCBkZWZhdWx0RGF0YSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGRlZmF1bHREYXRhCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBzdHJhdHMuZGF0YSA9IGZ1bmN0aW9uICgKICAgIHBhcmVudFZhbCwKICAgIGNoaWxkVmFsLAogICAgdm0KICApIHsKICAgIGlmICghdm0pIHsKICAgICAgaWYgKGNoaWxkVmFsICYmIHR5cGVvZiBjaGlsZFZhbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHdhcm4oCiAgICAgICAgICAnVGhlICJkYXRhIiBvcHRpb24gc2hvdWxkIGJlIGEgZnVuY3Rpb24gJyArCiAgICAgICAgICAndGhhdCByZXR1cm5zIGEgcGVyLWluc3RhbmNlIHZhbHVlIGluIGNvbXBvbmVudCAnICsKICAgICAgICAgICdkZWZpbml0aW9ucy4nLAogICAgICAgICAgdm0KICAgICAgICApOwoKICAgICAgICByZXR1cm4gcGFyZW50VmFsCiAgICAgIH0KICAgICAgcmV0dXJuIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCkKICAgIH0KCiAgICByZXR1cm4gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSkKICB9OwoKICAvKioKICAgKiBIb29rcyBhbmQgcHJvcHMgYXJlIG1lcmdlZCBhcyBhcnJheXMuCiAgICovCiAgZnVuY3Rpb24gbWVyZ2VIb29rICgKICAgIHBhcmVudFZhbCwKICAgIGNoaWxkVmFsCiAgKSB7CiAgICB2YXIgcmVzID0gY2hpbGRWYWwKICAgICAgPyBwYXJlbnRWYWwKICAgICAgICA/IHBhcmVudFZhbC5jb25jYXQoY2hpbGRWYWwpCiAgICAgICAgOiBBcnJheS5pc0FycmF5KGNoaWxkVmFsKQogICAgICAgICAgPyBjaGlsZFZhbAogICAgICAgICAgOiBbY2hpbGRWYWxdCiAgICAgIDogcGFyZW50VmFsOwogICAgcmV0dXJuIHJlcwogICAgICA/IGRlZHVwZUhvb2tzKHJlcykKICAgICAgOiByZXMKICB9CgogIGZ1bmN0aW9uIGRlZHVwZUhvb2tzIChob29rcykgewogICAgdmFyIHJlcyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAocmVzLmluZGV4T2YoaG9va3NbaV0pID09PSAtMSkgewogICAgICAgIHJlcy5wdXNoKGhvb2tzW2ldKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgTElGRUNZQ0xFX0hPT0tTLmZvckVhY2goZnVuY3Rpb24gKGhvb2spIHsKICAgIHN0cmF0c1tob29rXSA9IG1lcmdlSG9vazsKICB9KTsKCiAgLyoqCiAgICogQXNzZXRzCiAgICoKICAgKiBXaGVuIGEgdm0gaXMgcHJlc2VudCAoaW5zdGFuY2UgY3JlYXRpb24pLCB3ZSBuZWVkIHRvIGRvCiAgICogYSB0aHJlZS13YXkgbWVyZ2UgYmV0d2VlbiBjb25zdHJ1Y3RvciBvcHRpb25zLCBpbnN0YW5jZQogICAqIG9wdGlvbnMgYW5kIHBhcmVudCBvcHRpb25zLgogICAqLwogIGZ1bmN0aW9uIG1lcmdlQXNzZXRzICgKICAgIHBhcmVudFZhbCwKICAgIGNoaWxkVmFsLAogICAgdm0sCiAgICBrZXkKICApIHsKICAgIHZhciByZXMgPSBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKICAgIGlmIChjaGlsZFZhbCkgewogICAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICAgICAgcmV0dXJuIGV4dGVuZChyZXMsIGNoaWxkVmFsKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHJlcwogICAgfQogIH0KCiAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgc3RyYXRzW3R5cGUgKyAncyddID0gbWVyZ2VBc3NldHM7CiAgfSk7CgogIC8qKgogICAqIFdhdGNoZXJzLgogICAqCiAgICogV2F0Y2hlcnMgaGFzaGVzIHNob3VsZCBub3Qgb3ZlcndyaXRlIG9uZQogICAqIGFub3RoZXIsIHNvIHdlIG1lcmdlIHRoZW0gYXMgYXJyYXlzLgogICAqLwogIHN0cmF0cy53YXRjaCA9IGZ1bmN0aW9uICgKICAgIHBhcmVudFZhbCwKICAgIGNoaWxkVmFsLAogICAgdm0sCiAgICBrZXkKICApIHsKICAgIC8vIHdvcmsgYXJvdW5kIEZpcmVmb3gncyBPYmplY3QucHJvdG90eXBlLndhdGNoLi4uCiAgICBpZiAocGFyZW50VmFsID09PSBuYXRpdmVXYXRjaCkgeyBwYXJlbnRWYWwgPSB1bmRlZmluZWQ7IH0KICAgIGlmIChjaGlsZFZhbCA9PT0gbmF0aXZlV2F0Y2gpIHsgY2hpbGRWYWwgPSB1bmRlZmluZWQ7IH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCFjaGlsZFZhbCkgeyByZXR1cm4gT2JqZWN0LmNyZWF0ZShwYXJlbnRWYWwgfHwgbnVsbCkgfQogICAgewogICAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICAgIH0KICAgIGlmICghcGFyZW50VmFsKSB7IHJldHVybiBjaGlsZFZhbCB9CiAgICB2YXIgcmV0ID0ge307CiAgICBleHRlbmQocmV0LCBwYXJlbnRWYWwpOwogICAgZm9yICh2YXIga2V5JDEgaW4gY2hpbGRWYWwpIHsKICAgICAgdmFyIHBhcmVudCA9IHJldFtrZXkkMV07CiAgICAgIHZhciBjaGlsZCA9IGNoaWxkVmFsW2tleSQxXTsKICAgICAgaWYgKHBhcmVudCAmJiAhQXJyYXkuaXNBcnJheShwYXJlbnQpKSB7CiAgICAgICAgcGFyZW50ID0gW3BhcmVudF07CiAgICAgIH0KICAgICAgcmV0W2tleSQxXSA9IHBhcmVudAogICAgICAgID8gcGFyZW50LmNvbmNhdChjaGlsZCkKICAgICAgICA6IEFycmF5LmlzQXJyYXkoY2hpbGQpID8gY2hpbGQgOiBbY2hpbGRdOwogICAgfQogICAgcmV0dXJuIHJldAogIH07CgogIC8qKgogICAqIE90aGVyIG9iamVjdCBoYXNoZXMuCiAgICovCiAgc3RyYXRzLnByb3BzID0KICBzdHJhdHMubWV0aG9kcyA9CiAgc3RyYXRzLmluamVjdCA9CiAgc3RyYXRzLmNvbXB1dGVkID0gZnVuY3Rpb24gKAogICAgcGFyZW50VmFsLAogICAgY2hpbGRWYWwsCiAgICB2bSwKICAgIGtleQogICkgewogICAgaWYgKGNoaWxkVmFsICYmICJkZXZlbG9wbWVudCIgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICAgIH0KICAgIGlmICghcGFyZW50VmFsKSB7IHJldHVybiBjaGlsZFZhbCB9CiAgICB2YXIgcmV0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIGV4dGVuZChyZXQsIHBhcmVudFZhbCk7CiAgICBpZiAoY2hpbGRWYWwpIHsgZXh0ZW5kKHJldCwgY2hpbGRWYWwpOyB9CiAgICByZXR1cm4gcmV0CiAgfTsKICBzdHJhdHMucHJvdmlkZSA9IG1lcmdlRGF0YU9yRm47CgogIC8qKgogICAqIERlZmF1bHQgc3RyYXRlZ3kuCiAgICovCiAgdmFyIGRlZmF1bHRTdHJhdCA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsKSB7CiAgICByZXR1cm4gY2hpbGRWYWwgPT09IHVuZGVmaW5lZAogICAgICA/IHBhcmVudFZhbAogICAgICA6IGNoaWxkVmFsCiAgfTsKCiAgLyoqCiAgICogVmFsaWRhdGUgY29tcG9uZW50IG5hbWVzCiAgICovCiAgZnVuY3Rpb24gY2hlY2tDb21wb25lbnRzIChvcHRpb25zKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5jb21wb25lbnRzKSB7CiAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShrZXkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdmFsaWRhdGVDb21wb25lbnROYW1lIChuYW1lKSB7CiAgICBpZiAoIW5ldyBSZWdFeHAoKCJeW2EtekEtWl1bXFwtXFwuMC05XyIgKyAodW5pY29kZVJlZ0V4cC5zb3VyY2UpICsgIl0qJCIpKS50ZXN0KG5hbWUpKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ0ludmFsaWQgY29tcG9uZW50IG5hbWU6ICInICsgbmFtZSArICciLiBDb21wb25lbnQgbmFtZXMgJyArCiAgICAgICAgJ3Nob3VsZCBjb25mb3JtIHRvIHZhbGlkIGN1c3RvbSBlbGVtZW50IG5hbWUgaW4gaHRtbDUgc3BlY2lmaWNhdGlvbi4nCiAgICAgICk7CiAgICB9CiAgICBpZiAoaXNCdWlsdEluVGFnKG5hbWUpIHx8IGNvbmZpZy5pc1Jlc2VydmVkVGFnKG5hbWUpKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ0RvIG5vdCB1c2UgYnVpbHQtaW4gb3IgcmVzZXJ2ZWQgSFRNTCBlbGVtZW50cyBhcyBjb21wb25lbnQgJyArCiAgICAgICAgJ2lkOiAnICsgbmFtZQogICAgICApOwogICAgfQogIH0KCiAgLyoqCiAgICogRW5zdXJlIGFsbCBwcm9wcyBvcHRpb24gc3ludGF4IGFyZSBub3JtYWxpemVkIGludG8gdGhlCiAgICogT2JqZWN0LWJhc2VkIGZvcm1hdC4KICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemVQcm9wcyAob3B0aW9ucywgdm0pIHsKICAgIHZhciBwcm9wcyA9IG9wdGlvbnMucHJvcHM7CiAgICBpZiAoIXByb3BzKSB7IHJldHVybiB9CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgaSwgdmFsLCBuYW1lOwogICAgaWYgKEFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICAgIGkgPSBwcm9wcy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICB2YWwgPSBwcm9wc1tpXTsKICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG5hbWUgPSBjYW1lbGl6ZSh2YWwpOwogICAgICAgICAgcmVzW25hbWVdID0geyB0eXBlOiBudWxsIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm4oJ3Byb3BzIG11c3QgYmUgc3RyaW5ncyB3aGVuIHVzaW5nIGFycmF5IHN5bnRheC4nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChwcm9wcykpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgICAgdmFsID0gcHJvcHNba2V5XTsKICAgICAgICBuYW1lID0gY2FtZWxpemUoa2V5KTsKICAgICAgICByZXNbbmFtZV0gPSBpc1BsYWluT2JqZWN0KHZhbCkKICAgICAgICAgID8gdmFsCiAgICAgICAgICA6IHsgdHlwZTogdmFsIH07CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcInByb3BzXCI6IGV4cGVjdGVkIGFuIEFycmF5IG9yIGFuIE9iamVjdCwgIiArCiAgICAgICAgImJ1dCBnb3QgIiArICh0b1Jhd1R5cGUocHJvcHMpKSArICIuIiwKICAgICAgICB2bQogICAgICApOwogICAgfQogICAgb3B0aW9ucy5wcm9wcyA9IHJlczsKICB9CgogIC8qKgogICAqIE5vcm1hbGl6ZSBhbGwgaW5qZWN0aW9ucyBpbnRvIE9iamVjdC1iYXNlZCBmb3JtYXQKICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemVJbmplY3QgKG9wdGlvbnMsIHZtKSB7CiAgICB2YXIgaW5qZWN0ID0gb3B0aW9ucy5pbmplY3Q7CiAgICBpZiAoIWluamVjdCkgeyByZXR1cm4gfQogICAgdmFyIG5vcm1hbGl6ZWQgPSBvcHRpb25zLmluamVjdCA9IHt9OwogICAgaWYgKEFycmF5LmlzQXJyYXkoaW5qZWN0KSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluamVjdC5sZW5ndGg7IGkrKykgewogICAgICAgIG5vcm1hbGl6ZWRbaW5qZWN0W2ldXSA9IHsgZnJvbTogaW5qZWN0W2ldIH07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChpbmplY3QpKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBpbmplY3QpIHsKICAgICAgICB2YXIgdmFsID0gaW5qZWN0W2tleV07CiAgICAgICAgbm9ybWFsaXplZFtrZXldID0gaXNQbGFpbk9iamVjdCh2YWwpCiAgICAgICAgICA/IGV4dGVuZCh7IGZyb206IGtleSB9LCB2YWwpCiAgICAgICAgICA6IHsgZnJvbTogdmFsIH07CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcImluamVjdFwiOiBleHBlY3RlZCBhbiBBcnJheSBvciBhbiBPYmplY3QsICIgKwogICAgICAgICJidXQgZ290ICIgKyAodG9SYXdUeXBlKGluamVjdCkpICsgIi4iLAogICAgICAgIHZtCiAgICAgICk7CiAgICB9CiAgfQoKICAvKioKICAgKiBOb3JtYWxpemUgcmF3IGZ1bmN0aW9uIGRpcmVjdGl2ZXMgaW50byBvYmplY3QgZm9ybWF0LgogICAqLwogIGZ1bmN0aW9uIG5vcm1hbGl6ZURpcmVjdGl2ZXMgKG9wdGlvbnMpIHsKICAgIHZhciBkaXJzID0gb3B0aW9ucy5kaXJlY3RpdmVzOwogICAgaWYgKGRpcnMpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGRpcnMpIHsKICAgICAgICB2YXIgZGVmJCQxID0gZGlyc1trZXldOwogICAgICAgIGlmICh0eXBlb2YgZGVmJCQxID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBkaXJzW2tleV0gPSB7IGJpbmQ6IGRlZiQkMSwgdXBkYXRlOiBkZWYkJDEgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGFzc2VydE9iamVjdFR5cGUgKG5hbWUsIHZhbHVlLCB2bSkgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICB3YXJuKAogICAgICAgICJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCIiICsgbmFtZSArICJcIjogZXhwZWN0ZWQgYW4gT2JqZWN0LCAiICsKICAgICAgICAiYnV0IGdvdCAiICsgKHRvUmF3VHlwZSh2YWx1ZSkpICsgIi4iLAogICAgICAgIHZtCiAgICAgICk7CiAgICB9CiAgfQoKICAvKioKICAgKiBNZXJnZSB0d28gb3B0aW9uIG9iamVjdHMgaW50byBhIG5ldyBvbmUuCiAgICogQ29yZSB1dGlsaXR5IHVzZWQgaW4gYm90aCBpbnN0YW50aWF0aW9uIGFuZCBpbmhlcml0YW5jZS4KICAgKi8KICBmdW5jdGlvbiBtZXJnZU9wdGlvbnMgKAogICAgcGFyZW50LAogICAgY2hpbGQsCiAgICB2bQogICkgewogICAgewogICAgICBjaGVja0NvbXBvbmVudHMoY2hpbGQpOwogICAgfQoKICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2hpbGQgPSBjaGlsZC5vcHRpb25zOwogICAgfQoKICAgIG5vcm1hbGl6ZVByb3BzKGNoaWxkLCB2bSk7CiAgICBub3JtYWxpemVJbmplY3QoY2hpbGQsIHZtKTsKICAgIG5vcm1hbGl6ZURpcmVjdGl2ZXMoY2hpbGQpOwoKICAgIC8vIEFwcGx5IGV4dGVuZHMgYW5kIG1peGlucyBvbiB0aGUgY2hpbGQgb3B0aW9ucywKICAgIC8vIGJ1dCBvbmx5IGlmIGl0IGlzIGEgcmF3IG9wdGlvbnMgb2JqZWN0IHRoYXQgaXNuJ3QKICAgIC8vIHRoZSByZXN1bHQgb2YgYW5vdGhlciBtZXJnZU9wdGlvbnMgY2FsbC4KICAgIC8vIE9ubHkgbWVyZ2VkIG9wdGlvbnMgaGFzIHRoZSBfYmFzZSBwcm9wZXJ0eS4KICAgIGlmICghY2hpbGQuX2Jhc2UpIHsKICAgICAgaWYgKGNoaWxkLmV4dGVuZHMpIHsKICAgICAgICBwYXJlbnQgPSBtZXJnZU9wdGlvbnMocGFyZW50LCBjaGlsZC5leHRlbmRzLCB2bSk7CiAgICAgIH0KICAgICAgaWYgKGNoaWxkLm1peGlucykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hpbGQubWl4aW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgcGFyZW50ID0gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQubWl4aW5zW2ldLCB2bSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgIHZhciBrZXk7CiAgICBmb3IgKGtleSBpbiBwYXJlbnQpIHsKICAgICAgbWVyZ2VGaWVsZChrZXkpOwogICAgfQogICAgZm9yIChrZXkgaW4gY2hpbGQpIHsKICAgICAgaWYgKCFoYXNPd24ocGFyZW50LCBrZXkpKSB7CiAgICAgICAgbWVyZ2VGaWVsZChrZXkpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBtZXJnZUZpZWxkIChrZXkpIHsKICAgICAgdmFyIHN0cmF0ID0gc3RyYXRzW2tleV0gfHwgZGVmYXVsdFN0cmF0OwogICAgICBvcHRpb25zW2tleV0gPSBzdHJhdChwYXJlbnRba2V5XSwgY2hpbGRba2V5XSwgdm0sIGtleSk7CiAgICB9CiAgICByZXR1cm4gb3B0aW9ucwogIH0KCiAgLyoqCiAgICogUmVzb2x2ZSBhbiBhc3NldC4KICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgYmVjYXVzZSBjaGlsZCBpbnN0YW5jZXMgbmVlZCBhY2Nlc3MKICAgKiB0byBhc3NldHMgZGVmaW5lZCBpbiBpdHMgYW5jZXN0b3IgY2hhaW4uCiAgICovCiAgZnVuY3Rpb24gcmVzb2x2ZUFzc2V0ICgKICAgIG9wdGlvbnMsCiAgICB0eXBlLAogICAgaWQsCiAgICB3YXJuTWlzc2luZwogICkgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAodHlwZW9mIGlkICE9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBhc3NldHMgPSBvcHRpb25zW3R5cGVdOwogICAgLy8gY2hlY2sgbG9jYWwgcmVnaXN0cmF0aW9uIHZhcmlhdGlvbnMgZmlyc3QKICAgIGlmIChoYXNPd24oYXNzZXRzLCBpZCkpIHsgcmV0dXJuIGFzc2V0c1tpZF0gfQogICAgdmFyIGNhbWVsaXplZElkID0gY2FtZWxpemUoaWQpOwogICAgaWYgKGhhc093bihhc3NldHMsIGNhbWVsaXplZElkKSkgeyByZXR1cm4gYXNzZXRzW2NhbWVsaXplZElkXSB9CiAgICB2YXIgUGFzY2FsQ2FzZUlkID0gY2FwaXRhbGl6ZShjYW1lbGl6ZWRJZCk7CiAgICBpZiAoaGFzT3duKGFzc2V0cywgUGFzY2FsQ2FzZUlkKSkgeyByZXR1cm4gYXNzZXRzW1Bhc2NhbENhc2VJZF0gfQogICAgLy8gZmFsbGJhY2sgdG8gcHJvdG90eXBlIGNoYWluCiAgICB2YXIgcmVzID0gYXNzZXRzW2lkXSB8fCBhc3NldHNbY2FtZWxpemVkSWRdIHx8IGFzc2V0c1tQYXNjYWxDYXNlSWRdOwogICAgaWYgKHdhcm5NaXNzaW5nICYmICFyZXMpIHsKICAgICAgd2FybigKICAgICAgICAnRmFpbGVkIHRvIHJlc29sdmUgJyArIHR5cGUuc2xpY2UoMCwgLTEpICsgJzogJyArIGlkLAogICAgICAgIG9wdGlvbnMKICAgICAgKTsKICAgIH0KICAgIHJldHVybiByZXMKICB9CgogIC8qICAqLwoKCgogIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcCAoCiAgICBrZXksCiAgICBwcm9wT3B0aW9ucywKICAgIHByb3BzRGF0YSwKICAgIHZtCiAgKSB7CiAgICB2YXIgcHJvcCA9IHByb3BPcHRpb25zW2tleV07CiAgICB2YXIgYWJzZW50ID0gIWhhc093bihwcm9wc0RhdGEsIGtleSk7CiAgICB2YXIgdmFsdWUgPSBwcm9wc0RhdGFba2V5XTsKICAgIC8vIGJvb2xlYW4gY2FzdGluZwogICAgdmFyIGJvb2xlYW5JbmRleCA9IGdldFR5cGVJbmRleChCb29sZWFuLCBwcm9wLnR5cGUpOwogICAgaWYgKGJvb2xlYW5JbmRleCA+IC0xKSB7CiAgICAgIGlmIChhYnNlbnQgJiYgIWhhc093bihwcm9wLCAnZGVmYXVsdCcpKSB7CiAgICAgICAgdmFsdWUgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IGh5cGhlbmF0ZShrZXkpKSB7CiAgICAgICAgLy8gb25seSBjYXN0IGVtcHR5IHN0cmluZyAvIHNhbWUgbmFtZSB0byBib29sZWFuIGlmCiAgICAgICAgLy8gYm9vbGVhbiBoYXMgaGlnaGVyIHByaW9yaXR5CiAgICAgICAgdmFyIHN0cmluZ0luZGV4ID0gZ2V0VHlwZUluZGV4KFN0cmluZywgcHJvcC50eXBlKTsKICAgICAgICBpZiAoc3RyaW5nSW5kZXggPCAwIHx8IGJvb2xlYW5JbmRleCA8IHN0cmluZ0luZGV4KSB7CiAgICAgICAgICB2YWx1ZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBjaGVjayBkZWZhdWx0IHZhbHVlCiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICB2YWx1ZSA9IGdldFByb3BEZWZhdWx0VmFsdWUodm0sIHByb3AsIGtleSk7CiAgICAgIC8vIHNpbmNlIHRoZSBkZWZhdWx0IHZhbHVlIGlzIGEgZnJlc2ggY29weSwKICAgICAgLy8gbWFrZSBzdXJlIHRvIG9ic2VydmUgaXQuCiAgICAgIHZhciBwcmV2U2hvdWxkT2JzZXJ2ZSA9IHNob3VsZE9ic2VydmU7CiAgICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICAgICAgb2JzZXJ2ZSh2YWx1ZSk7CiAgICAgIHRvZ2dsZU9ic2VydmluZyhwcmV2U2hvdWxkT2JzZXJ2ZSk7CiAgICB9CiAgICB7CiAgICAgIGFzc2VydFByb3AocHJvcCwga2V5LCB2YWx1ZSwgdm0sIGFic2VudCk7CiAgICB9CiAgICByZXR1cm4gdmFsdWUKICB9CgogIC8qKgogICAqIEdldCB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhIHByb3AuCiAgICovCiAgZnVuY3Rpb24gZ2V0UHJvcERlZmF1bHRWYWx1ZSAodm0sIHByb3AsIGtleSkgewogICAgLy8gbm8gZGVmYXVsdCwgcmV0dXJuIHVuZGVmaW5lZAogICAgaWYgKCFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgICByZXR1cm4gdW5kZWZpbmVkCiAgICB9CiAgICB2YXIgZGVmID0gcHJvcC5kZWZhdWx0OwogICAgLy8gd2FybiBhZ2FpbnN0IG5vbi1mYWN0b3J5IGRlZmF1bHRzIGZvciBPYmplY3QgJiBBcnJheQogICAgaWYgKGlzT2JqZWN0KGRlZikpIHsKICAgICAgd2FybigKICAgICAgICAnSW52YWxpZCBkZWZhdWx0IHZhbHVlIGZvciBwcm9wICInICsga2V5ICsgJyI6ICcgKwogICAgICAgICdQcm9wcyB3aXRoIHR5cGUgT2JqZWN0L0FycmF5IG11c3QgdXNlIGEgZmFjdG9yeSBmdW5jdGlvbiAnICsKICAgICAgICAndG8gcmV0dXJuIHRoZSBkZWZhdWx0IHZhbHVlLicsCiAgICAgICAgdm0KICAgICAgKTsKICAgIH0KICAgIC8vIHRoZSByYXcgcHJvcCB2YWx1ZSB3YXMgYWxzbyB1bmRlZmluZWQgZnJvbSBwcmV2aW91cyByZW5kZXIsCiAgICAvLyByZXR1cm4gcHJldmlvdXMgZGVmYXVsdCB2YWx1ZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSB3YXRjaGVyIHRyaWdnZXIKICAgIGlmICh2bSAmJiB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgJiYKICAgICAgdm0uJG9wdGlvbnMucHJvcHNEYXRhW2tleV0gPT09IHVuZGVmaW5lZCAmJgogICAgICB2bS5fcHJvcHNba2V5XSAhPT0gdW5kZWZpbmVkCiAgICApIHsKICAgICAgcmV0dXJuIHZtLl9wcm9wc1trZXldCiAgICB9CiAgICAvLyBjYWxsIGZhY3RvcnkgZnVuY3Rpb24gZm9yIG5vbi1GdW5jdGlvbiB0eXBlcwogICAgLy8gYSB2YWx1ZSBpcyBGdW5jdGlvbiBpZiBpdHMgcHJvdG90eXBlIGlzIGZ1bmN0aW9uIGV2ZW4gYWNyb3NzIGRpZmZlcmVudCBleGVjdXRpb24gY29udGV4dAogICAgcmV0dXJuIHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicgJiYgZ2V0VHlwZShwcm9wLnR5cGUpICE9PSAnRnVuY3Rpb24nCiAgICAgID8gZGVmLmNhbGwodm0pCiAgICAgIDogZGVmCiAgfQoKICAvKioKICAgKiBBc3NlcnQgd2hldGhlciBhIHByb3AgaXMgdmFsaWQuCiAgICovCiAgZnVuY3Rpb24gYXNzZXJ0UHJvcCAoCiAgICBwcm9wLAogICAgbmFtZSwKICAgIHZhbHVlLAogICAgdm0sCiAgICBhYnNlbnQKICApIHsKICAgIGlmIChwcm9wLnJlcXVpcmVkICYmIGFic2VudCkgewogICAgICB3YXJuKAogICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIHByb3A6ICInICsgbmFtZSArICciJywKICAgICAgICB2bQogICAgICApOwogICAgICByZXR1cm4KICAgIH0KICAgIGlmICh2YWx1ZSA9PSBudWxsICYmICFwcm9wLnJlcXVpcmVkKSB7CiAgICAgIHJldHVybgogICAgfQogICAgdmFyIHR5cGUgPSBwcm9wLnR5cGU7CiAgICB2YXIgdmFsaWQgPSAhdHlwZSB8fCB0eXBlID09PSB0cnVlOwogICAgdmFyIGV4cGVjdGVkVHlwZXMgPSBbXTsKICAgIGlmICh0eXBlKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0eXBlKSkgewogICAgICAgIHR5cGUgPSBbdHlwZV07CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0eXBlLmxlbmd0aCAmJiAhdmFsaWQ7IGkrKykgewogICAgICAgIHZhciBhc3NlcnRlZFR5cGUgPSBhc3NlcnRUeXBlKHZhbHVlLCB0eXBlW2ldKTsKICAgICAgICBleHBlY3RlZFR5cGVzLnB1c2goYXNzZXJ0ZWRUeXBlLmV4cGVjdGVkVHlwZSB8fCAnJyk7CiAgICAgICAgdmFsaWQgPSBhc3NlcnRlZFR5cGUudmFsaWQ7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIXZhbGlkKSB7CiAgICAgIHdhcm4oCiAgICAgICAgZ2V0SW52YWxpZFR5cGVNZXNzYWdlKG5hbWUsIHZhbHVlLCBleHBlY3RlZFR5cGVzKSwKICAgICAgICB2bQogICAgICApOwogICAgICByZXR1cm4KICAgIH0KICAgIHZhciB2YWxpZGF0b3IgPSBwcm9wLnZhbGlkYXRvcjsKICAgIGlmICh2YWxpZGF0b3IpIHsKICAgICAgaWYgKCF2YWxpZGF0b3IodmFsdWUpKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICdJbnZhbGlkIHByb3A6IGN1c3RvbSB2YWxpZGF0b3IgY2hlY2sgZmFpbGVkIGZvciBwcm9wICInICsgbmFtZSArICciLicsCiAgICAgICAgICB2bQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBzaW1wbGVDaGVja1JFID0gL14oU3RyaW5nfE51bWJlcnxCb29sZWFufEZ1bmN0aW9ufFN5bWJvbCkkLzsKCiAgZnVuY3Rpb24gYXNzZXJ0VHlwZSAodmFsdWUsIHR5cGUpIHsKICAgIHZhciB2YWxpZDsKICAgIHZhciBleHBlY3RlZFR5cGUgPSBnZXRUeXBlKHR5cGUpOwogICAgaWYgKHNpbXBsZUNoZWNrUkUudGVzdChleHBlY3RlZFR5cGUpKSB7CiAgICAgIHZhciB0ID0gdHlwZW9mIHZhbHVlOwogICAgICB2YWxpZCA9IHQgPT09IGV4cGVjdGVkVHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAvLyBmb3IgcHJpbWl0aXZlIHdyYXBwZXIgb2JqZWN0cwogICAgICBpZiAoIXZhbGlkICYmIHQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgdmFsaWQgPSB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnT2JqZWN0JykgewogICAgICB2YWxpZCA9IGlzUGxhaW5PYmplY3QodmFsdWUpOwogICAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdBcnJheScpIHsKICAgICAgdmFsaWQgPSBBcnJheS5pc0FycmF5KHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgdmFsaWQ6IHZhbGlkLAogICAgICBleHBlY3RlZFR5cGU6IGV4cGVjdGVkVHlwZQogICAgfQogIH0KCiAgLyoqCiAgICogVXNlIGZ1bmN0aW9uIHN0cmluZyBuYW1lIHRvIGNoZWNrIGJ1aWx0LWluIHR5cGVzLAogICAqIGJlY2F1c2UgYSBzaW1wbGUgZXF1YWxpdHkgY2hlY2sgd2lsbCBmYWlsIHdoZW4gcnVubmluZwogICAqIGFjcm9zcyBkaWZmZXJlbnQgdm1zIC8gaWZyYW1lcy4KICAgKi8KICBmdW5jdGlvbiBnZXRUeXBlIChmbikgewogICAgdmFyIG1hdGNoID0gZm4gJiYgZm4udG9TdHJpbmcoKS5tYXRjaCgvXlxzKmZ1bmN0aW9uIChcdyspLyk7CiAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnCiAgfQoKICBmdW5jdGlvbiBpc1NhbWVUeXBlIChhLCBiKSB7CiAgICByZXR1cm4gZ2V0VHlwZShhKSA9PT0gZ2V0VHlwZShiKQogIH0KCiAgZnVuY3Rpb24gZ2V0VHlwZUluZGV4ICh0eXBlLCBleHBlY3RlZFR5cGVzKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZXhwZWN0ZWRUeXBlcykpIHsKICAgICAgcmV0dXJuIGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlcywgdHlwZSkgPyAwIDogLTEKICAgIH0KICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBleHBlY3RlZFR5cGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGlmIChpc1NhbWVUeXBlKGV4cGVjdGVkVHlwZXNbaV0sIHR5cGUpKSB7CiAgICAgICAgcmV0dXJuIGkKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xCiAgfQoKICBmdW5jdGlvbiBnZXRJbnZhbGlkVHlwZU1lc3NhZ2UgKG5hbWUsIHZhbHVlLCBleHBlY3RlZFR5cGVzKSB7CiAgICB2YXIgbWVzc2FnZSA9ICJJbnZhbGlkIHByb3A6IHR5cGUgY2hlY2sgZmFpbGVkIGZvciBwcm9wIFwiIiArIG5hbWUgKyAiXCIuIiArCiAgICAgICIgRXhwZWN0ZWQgIiArIChleHBlY3RlZFR5cGVzLm1hcChjYXBpdGFsaXplKS5qb2luKCcsICcpKTsKICAgIHZhciBleHBlY3RlZFR5cGUgPSBleHBlY3RlZFR5cGVzWzBdOwogICAgdmFyIHJlY2VpdmVkVHlwZSA9IHRvUmF3VHlwZSh2YWx1ZSk7CiAgICB2YXIgZXhwZWN0ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSk7CiAgICB2YXIgcmVjZWl2ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIHJlY2VpdmVkVHlwZSk7CiAgICAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgZXhwZWN0ZWQgdmFsdWUKICAgIGlmIChleHBlY3RlZFR5cGVzLmxlbmd0aCA9PT0gMSAmJgogICAgICAgIGlzRXhwbGljYWJsZShleHBlY3RlZFR5cGUpICYmCiAgICAgICAgIWlzQm9vbGVhbihleHBlY3RlZFR5cGUsIHJlY2VpdmVkVHlwZSkpIHsKICAgICAgbWVzc2FnZSArPSAiIHdpdGggdmFsdWUgIiArIGV4cGVjdGVkVmFsdWU7CiAgICB9CiAgICBtZXNzYWdlICs9ICIsIGdvdCAiICsgcmVjZWl2ZWRUeXBlICsgIiAiOwogICAgLy8gY2hlY2sgaWYgd2UgbmVlZCB0byBzcGVjaWZ5IHJlY2VpdmVkIHZhbHVlCiAgICBpZiAoaXNFeHBsaWNhYmxlKHJlY2VpdmVkVHlwZSkpIHsKICAgICAgbWVzc2FnZSArPSAid2l0aCB2YWx1ZSAiICsgcmVjZWl2ZWRWYWx1ZSArICIuIjsKICAgIH0KICAgIHJldHVybiBtZXNzYWdlCiAgfQoKICBmdW5jdGlvbiBzdHlsZVZhbHVlICh2YWx1ZSwgdHlwZSkgewogICAgaWYgKHR5cGUgPT09ICdTdHJpbmcnKSB7CiAgICAgIHJldHVybiAoIlwiIiArIHZhbHVlICsgIlwiIikKICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ051bWJlcicpIHsKICAgICAgcmV0dXJuICgiIiArIChOdW1iZXIodmFsdWUpKSkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAoIiIgKyB2YWx1ZSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzRXhwbGljYWJsZSAodmFsdWUpIHsKICAgIHZhciBleHBsaWNpdFR5cGVzID0gWydzdHJpbmcnLCAnbnVtYmVyJywgJ2Jvb2xlYW4nXTsKICAgIHJldHVybiBleHBsaWNpdFR5cGVzLnNvbWUoZnVuY3Rpb24gKGVsZW0pIHsgcmV0dXJuIHZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IGVsZW07IH0pCiAgfQoKICBmdW5jdGlvbiBpc0Jvb2xlYW4gKCkgewogICAgdmFyIGFyZ3MgPSBbXSwgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIHdoaWxlICggbGVuLS0gKSBhcmdzWyBsZW4gXSA9IGFyZ3VtZW50c1sgbGVuIF07CgogICAgcmV0dXJuIGFyZ3Muc29tZShmdW5jdGlvbiAoZWxlbSkgeyByZXR1cm4gZWxlbS50b0xvd2VyQ2FzZSgpID09PSAnYm9vbGVhbic7IH0pCiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaGFuZGxlRXJyb3IgKGVyciwgdm0sIGluZm8pIHsKICAgIC8vIERlYWN0aXZhdGUgZGVwcyB0cmFja2luZyB3aGlsZSBwcm9jZXNzaW5nIGVycm9yIGhhbmRsZXIgdG8gYXZvaWQgcG9zc2libGUgaW5maW5pdGUgcmVuZGVyaW5nLgogICAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVleC9pc3N1ZXMvMTUwNQogICAgcHVzaFRhcmdldCgpOwogICAgdHJ5IHsKICAgICAgaWYgKHZtKSB7CiAgICAgICAgdmFyIGN1ciA9IHZtOwogICAgICAgIHdoaWxlICgoY3VyID0gY3VyLiRwYXJlbnQpKSB7CiAgICAgICAgICB2YXIgaG9va3MgPSBjdXIuJG9wdGlvbnMuZXJyb3JDYXB0dXJlZDsKICAgICAgICAgIGlmIChob29rcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlID0gaG9va3NbaV0uY2FsbChjdXIsIGVyciwgdm0sIGluZm8pID09PSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChjYXB0dXJlKSB7IHJldHVybiB9CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgZ2xvYmFsSGFuZGxlRXJyb3IoZSwgY3VyLCAnZXJyb3JDYXB0dXJlZCBob29rJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGdsb2JhbEhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pOwogICAgfSBmaW5hbGx5IHsKICAgICAgcG9wVGFyZ2V0KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyAoCiAgICBoYW5kbGVyLAogICAgY29udGV4dCwKICAgIGFyZ3MsCiAgICB2bSwKICAgIGluZm8KICApIHsKICAgIHZhciByZXM7CiAgICB0cnkgewogICAgICByZXMgPSBhcmdzID8gaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKSA6IGhhbmRsZXIuY2FsbChjb250ZXh0KTsKICAgICAgaWYgKHJlcyAmJiAhcmVzLl9pc1Z1ZSAmJiBpc1Byb21pc2UocmVzKSAmJiAhcmVzLl9oYW5kbGVkKSB7CiAgICAgICAgcmVzLmNhdGNoKGZ1bmN0aW9uIChlKSB7IHJldHVybiBoYW5kbGVFcnJvcihlLCB2bSwgaW5mbyArICIgKFByb21pc2UvYXN5bmMpIik7IH0pOwogICAgICAgIC8vIGlzc3VlICM5NTExCiAgICAgICAgLy8gYXZvaWQgY2F0Y2ggdHJpZ2dlcmluZyBtdWx0aXBsZSB0aW1lcyB3aGVuIG5lc3RlZCBjYWxscwogICAgICAgIHJlcy5faGFuZGxlZCA9IHRydWU7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8pOwogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gZ2xvYmFsSGFuZGxlRXJyb3IgKGVyciwgdm0sIGluZm8pIHsKICAgIGlmIChjb25maWcuZXJyb3JIYW5kbGVyKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGNvbmZpZy5lcnJvckhhbmRsZXIuY2FsbChudWxsLCBlcnIsIHZtLCBpbmZvKQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy8gaWYgdGhlIHVzZXIgaW50ZW50aW9uYWxseSB0aHJvd3MgdGhlIG9yaWdpbmFsIGVycm9yIGluIHRoZSBoYW5kbGVyLAogICAgICAgIC8vIGRvIG5vdCBsb2cgaXQgdHdpY2UKICAgICAgICBpZiAoZSAhPT0gZXJyKSB7CiAgICAgICAgICBsb2dFcnJvcihlLCBudWxsLCAnY29uZmlnLmVycm9ySGFuZGxlcicpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbG9nRXJyb3IoZXJyLCB2bSwgaW5mbyk7CiAgfQoKICBmdW5jdGlvbiBsb2dFcnJvciAoZXJyLCB2bSwgaW5mbykgewogICAgewogICAgICB3YXJuKCgiRXJyb3IgaW4gIiArIGluZm8gKyAiOiBcIiIgKyAoZXJyLnRvU3RyaW5nKCkpICsgIlwiIiksIHZtKTsKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAoKGluQnJvd3NlciB8fCBpbldlZXgpICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgaXNVc2luZ01pY3JvVGFzayA9IGZhbHNlOwoKICB2YXIgY2FsbGJhY2tzID0gW107CiAgdmFyIHBlbmRpbmcgPSBmYWxzZTsKCiAgZnVuY3Rpb24gZmx1c2hDYWxsYmFja3MgKCkgewogICAgcGVuZGluZyA9IGZhbHNlOwogICAgdmFyIGNvcGllcyA9IGNhbGxiYWNrcy5zbGljZSgwKTsKICAgIGNhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3BpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29waWVzW2ldKCk7CiAgICB9CiAgfQoKICAvLyBIZXJlIHdlIGhhdmUgYXN5bmMgZGVmZXJyaW5nIHdyYXBwZXJzIHVzaW5nIG1pY3JvdGFza3MuCiAgLy8gSW4gMi41IHdlIHVzZWQgKG1hY3JvKSB0YXNrcyAoaW4gY29tYmluYXRpb24gd2l0aCBtaWNyb3Rhc2tzKS4KICAvLyBIb3dldmVyLCBpdCBoYXMgc3VidGxlIHByb2JsZW1zIHdoZW4gc3RhdGUgaXMgY2hhbmdlZCByaWdodCBiZWZvcmUgcmVwYWludAogIC8vIChlLmcuICM2ODEzLCBvdXQtaW4gdHJhbnNpdGlvbnMpLgogIC8vIEFsc28sIHVzaW5nIChtYWNybykgdGFza3MgaW4gZXZlbnQgaGFuZGxlciB3b3VsZCBjYXVzZSBzb21lIHdlaXJkIGJlaGF2aW9ycwogIC8vIHRoYXQgY2Fubm90IGJlIGNpcmN1bXZlbnRlZCAoZS5nLiAjNzEwOSwgIzcxNTMsICM3NTQ2LCAjNzgzNCwgIzgxMDkpLgogIC8vIFNvIHdlIG5vdyB1c2UgbWljcm90YXNrcyBldmVyeXdoZXJlLCBhZ2Fpbi4KICAvLyBBIG1ham9yIGRyYXdiYWNrIG9mIHRoaXMgdHJhZGVvZmYgaXMgdGhhdCB0aGVyZSBhcmUgc29tZSBzY2VuYXJpb3MKICAvLyB3aGVyZSBtaWNyb3Rhc2tzIGhhdmUgdG9vIGhpZ2ggYSBwcmlvcml0eSBhbmQgZmlyZSBpbiBiZXR3ZWVuIHN1cHBvc2VkbHkKICAvLyBzZXF1ZW50aWFsIGV2ZW50cyAoZS5nLiAjNDUyMSwgIzY2OTAsIHdoaWNoIGhhdmUgd29ya2Fyb3VuZHMpCiAgLy8gb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lIGV2ZW50ICgjNjU2NikuCiAgdmFyIHRpbWVyRnVuYzsKCiAgLy8gVGhlIG5leHRUaWNrIGJlaGF2aW9yIGxldmVyYWdlcyB0aGUgbWljcm90YXNrIHF1ZXVlLCB3aGljaCBjYW4gYmUgYWNjZXNzZWQKICAvLyB2aWEgZWl0aGVyIG5hdGl2ZSBQcm9taXNlLnRoZW4gb3IgTXV0YXRpb25PYnNlcnZlci4KICAvLyBNdXRhdGlvbk9ic2VydmVyIGhhcyB3aWRlciBzdXBwb3J0LCBob3dldmVyIGl0IGlzIHNlcmlvdXNseSBidWdnZWQgaW4KICAvLyBVSVdlYlZpZXcgaW4gaU9TID49IDkuMy4zIHdoZW4gdHJpZ2dlcmVkIGluIHRvdWNoIGV2ZW50IGhhbmRsZXJzLiBJdAogIC8vIGNvbXBsZXRlbHkgc3RvcHMgd29ya2luZyBhZnRlciB0cmlnZ2VyaW5nIGEgZmV3IHRpbWVzLi4uIHNvLCBpZiBuYXRpdmUKICAvLyBQcm9taXNlIGlzIGF2YWlsYWJsZSwgd2Ugd2lsbCB1c2UgaXQ6CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQsICRmbG93LWRpc2FibGUtbGluZSAqLwogIGlmICh0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJvbWlzZSkpIHsKICAgIHZhciBwID0gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICB0aW1lckZ1bmMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHAudGhlbihmbHVzaENhbGxiYWNrcyk7CiAgICAgIC8vIEluIHByb2JsZW1hdGljIFVJV2ViVmlld3MsIFByb21pc2UudGhlbiBkb2Vzbid0IGNvbXBsZXRlbHkgYnJlYWssIGJ1dAogICAgICAvLyBpdCBjYW4gZ2V0IHN0dWNrIGluIGEgd2VpcmQgc3RhdGUgd2hlcmUgY2FsbGJhY2tzIGFyZSBwdXNoZWQgaW50byB0aGUKICAgICAgLy8gbWljcm90YXNrIHF1ZXVlIGJ1dCB0aGUgcXVldWUgaXNuJ3QgYmVpbmcgZmx1c2hlZCwgdW50aWwgdGhlIGJyb3dzZXIKICAgICAgLy8gbmVlZHMgdG8gZG8gc29tZSBvdGhlciB3b3JrLCBlLmcuIGhhbmRsZSBhIHRpbWVyLiBUaGVyZWZvcmUgd2UgY2FuCiAgICAgIC8vICJmb3JjZSIgdGhlIG1pY3JvdGFzayBxdWV1ZSB0byBiZSBmbHVzaGVkIGJ5IGFkZGluZyBhbiBlbXB0eSB0aW1lci4KICAgICAgaWYgKGlzSU9TKSB7IHNldFRpbWVvdXQobm9vcCk7IH0KICAgIH07CiAgICBpc1VzaW5nTWljcm9UYXNrID0gdHJ1ZTsKICB9IGVsc2UgaWYgKCFpc0lFICYmIHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyICE9PSAndW5kZWZpbmVkJyAmJiAoCiAgICBpc05hdGl2ZShNdXRhdGlvbk9ic2VydmVyKSB8fAogICAgLy8gUGhhbnRvbUpTIGFuZCBpT1MgNy54CiAgICBNdXRhdGlvbk9ic2VydmVyLnRvU3RyaW5nKCkgPT09ICdbb2JqZWN0IE11dGF0aW9uT2JzZXJ2ZXJDb25zdHJ1Y3Rvcl0nCiAgKSkgewogICAgLy8gVXNlIE11dGF0aW9uT2JzZXJ2ZXIgd2hlcmUgbmF0aXZlIFByb21pc2UgaXMgbm90IGF2YWlsYWJsZSwKICAgIC8vIGUuZy4gUGhhbnRvbUpTLCBpT1M3LCBBbmRyb2lkIDQuNAogICAgLy8gKCM2NDY2IE11dGF0aW9uT2JzZXJ2ZXIgaXMgdW5yZWxpYWJsZSBpbiBJRTExKQogICAgdmFyIGNvdW50ZXIgPSAxOwogICAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZmx1c2hDYWxsYmFja3MpOwogICAgdmFyIHRleHROb2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoU3RyaW5nKGNvdW50ZXIpKTsKICAgIG9ic2VydmVyLm9ic2VydmUodGV4dE5vZGUsIHsKICAgICAgY2hhcmFjdGVyRGF0YTogdHJ1ZQogICAgfSk7CiAgICB0aW1lckZ1bmMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGNvdW50ZXIgPSAoY291bnRlciArIDEpICUgMjsKICAgICAgdGV4dE5vZGUuZGF0YSA9IFN0cmluZyhjb3VudGVyKTsKICAgIH07CiAgICBpc1VzaW5nTWljcm9UYXNrID0gdHJ1ZTsKICB9IGVsc2UgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKHNldEltbWVkaWF0ZSkpIHsKICAgIC8vIEZhbGxiYWNrIHRvIHNldEltbWVkaWF0ZS4KICAgIC8vIFRlY2hpbmljYWxseSBpdCBsZXZlcmFnZXMgdGhlIChtYWNybykgdGFzayBxdWV1ZSwKICAgIC8vIGJ1dCBpdCBpcyBzdGlsbCBhIGJldHRlciBjaG9pY2UgdGhhbiBzZXRUaW1lb3V0LgogICAgdGltZXJGdW5jID0gZnVuY3Rpb24gKCkgewogICAgICBzZXRJbW1lZGlhdGUoZmx1c2hDYWxsYmFja3MpOwogICAgfTsKICB9IGVsc2UgewogICAgLy8gRmFsbGJhY2sgdG8gc2V0VGltZW91dC4KICAgIHRpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgICAgc2V0VGltZW91dChmbHVzaENhbGxiYWNrcywgMCk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbmV4dFRpY2sgKGNiLCBjdHgpIHsKICAgIHZhciBfcmVzb2x2ZTsKICAgIGNhbGxiYWNrcy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGNiKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNiLmNhbGwoY3R4KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlLCBjdHgsICduZXh0VGljaycpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChfcmVzb2x2ZSkgewogICAgICAgIF9yZXNvbHZlKGN0eCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFwZW5kaW5nKSB7CiAgICAgIHBlbmRpbmcgPSB0cnVlOwogICAgICB0aW1lckZ1bmMoKTsKICAgIH0KICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgaWYgKCFjYiAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgX3Jlc29sdmUgPSByZXNvbHZlOwogICAgICB9KQogICAgfQogIH0KCiAgLyogICovCgogIHZhciBtYXJrOwogIHZhciBtZWFzdXJlOwoKICB7CiAgICB2YXIgcGVyZiA9IGluQnJvd3NlciAmJiB3aW5kb3cucGVyZm9ybWFuY2U7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICgKICAgICAgcGVyZiAmJgogICAgICBwZXJmLm1hcmsgJiYKICAgICAgcGVyZi5tZWFzdXJlICYmCiAgICAgIHBlcmYuY2xlYXJNYXJrcyAmJgogICAgICBwZXJmLmNsZWFyTWVhc3VyZXMKICAgICkgewogICAgICBtYXJrID0gZnVuY3Rpb24gKHRhZykgeyByZXR1cm4gcGVyZi5tYXJrKHRhZyk7IH07CiAgICAgIG1lYXN1cmUgPSBmdW5jdGlvbiAobmFtZSwgc3RhcnRUYWcsIGVuZFRhZykgewogICAgICAgIHBlcmYubWVhc3VyZShuYW1lLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgICBwZXJmLmNsZWFyTWFya3Moc3RhcnRUYWcpOwogICAgICAgIHBlcmYuY2xlYXJNYXJrcyhlbmRUYWcpOwogICAgICAgIC8vIHBlcmYuY2xlYXJNZWFzdXJlcyhuYW1lKQogICAgICB9OwogICAgfQogIH0KCiAgLyogbm90IHR5cGUgY2hlY2tpbmcgdGhpcyBmaWxlIGJlY2F1c2UgZmxvdyBkb2Vzbid0IHBsYXkgd2VsbCB3aXRoIFByb3h5ICovCgogIHZhciBpbml0UHJveHk7CgogIHsKICAgIHZhciBhbGxvd2VkR2xvYmFscyA9IG1ha2VNYXAoCiAgICAgICdJbmZpbml0eSx1bmRlZmluZWQsTmFOLGlzRmluaXRlLGlzTmFOLCcgKwogICAgICAncGFyc2VGbG9hdCxwYXJzZUludCxkZWNvZGVVUkksZGVjb2RlVVJJQ29tcG9uZW50LGVuY29kZVVSSSxlbmNvZGVVUklDb21wb25lbnQsJyArCiAgICAgICdNYXRoLE51bWJlcixEYXRlLEFycmF5LE9iamVjdCxCb29sZWFuLFN0cmluZyxSZWdFeHAsTWFwLFNldCxKU09OLEludGwsJyArCiAgICAgICdyZXF1aXJlJyAvLyBmb3IgV2VicGFjay9Ccm93c2VyaWZ5CiAgICApOwoKICAgIHZhciB3YXJuTm9uUHJlc2VudCA9IGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgewogICAgICB3YXJuKAogICAgICAgICJQcm9wZXJ0eSBvciBtZXRob2QgXCIiICsga2V5ICsgIlwiIGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBpbnN0YW5jZSBidXQgIiArCiAgICAgICAgJ3JlZmVyZW5jZWQgZHVyaW5nIHJlbmRlci4gTWFrZSBzdXJlIHRoYXQgdGhpcyBwcm9wZXJ0eSBpcyByZWFjdGl2ZSwgJyArCiAgICAgICAgJ2VpdGhlciBpbiB0aGUgZGF0YSBvcHRpb24sIG9yIGZvciBjbGFzcy1iYXNlZCBjb21wb25lbnRzLCBieSAnICsKICAgICAgICAnaW5pdGlhbGl6aW5nIHRoZSBwcm9wZXJ0eS4gJyArCiAgICAgICAgJ1NlZTogaHR0cHM6Ly92dWVqcy5vcmcvdjIvZ3VpZGUvcmVhY3Rpdml0eS5odG1sI0RlY2xhcmluZy1SZWFjdGl2ZS1Qcm9wZXJ0aWVzLicsCiAgICAgICAgdGFyZ2V0CiAgICAgICk7CiAgICB9OwoKICAgIHZhciB3YXJuUmVzZXJ2ZWRQcmVmaXggPSBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsKICAgICAgd2FybigKICAgICAgICAiUHJvcGVydHkgXCIiICsga2V5ICsgIlwiIG11c3QgYmUgYWNjZXNzZWQgd2l0aCBcIiRkYXRhLiIgKyBrZXkgKyAiXCIgYmVjYXVzZSAiICsKICAgICAgICAncHJvcGVydGllcyBzdGFydGluZyB3aXRoICIkIiBvciAiXyIgYXJlIG5vdCBwcm94aWVkIGluIHRoZSBWdWUgaW5zdGFuY2UgdG8gJyArCiAgICAgICAgJ3ByZXZlbnQgY29uZmxpY3RzIHdpdGggVnVlIGludGVybmFscycgKwogICAgICAgICdTZWU6IGh0dHBzOi8vdnVlanMub3JnL3YyL2FwaS8jZGF0YScsCiAgICAgICAgdGFyZ2V0CiAgICAgICk7CiAgICB9OwoKICAgIHZhciBoYXNQcm94eSA9CiAgICAgIHR5cGVvZiBQcm94eSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJveHkpOwoKICAgIGlmIChoYXNQcm94eSkgewogICAgICB2YXIgaXNCdWlsdEluTW9kaWZpZXIgPSBtYWtlTWFwKCdzdG9wLHByZXZlbnQsc2VsZixjdHJsLHNoaWZ0LGFsdCxtZXRhLGV4YWN0Jyk7CiAgICAgIGNvbmZpZy5rZXlDb2RlcyA9IG5ldyBQcm94eShjb25maWcua2V5Q29kZXMsIHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldCAodGFyZ2V0LCBrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAoaXNCdWlsdEluTW9kaWZpZXIoa2V5KSkgewogICAgICAgICAgICB3YXJuKCgiQXZvaWQgb3ZlcndyaXRpbmcgYnVpbHQtaW4gbW9kaWZpZXIgaW4gY29uZmlnLmtleUNvZGVzOiAuIiArIGtleSkpOwogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRhcmdldFtrZXldID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICB2YXIgaGFzSGFuZGxlciA9IHsKICAgICAgaGFzOiBmdW5jdGlvbiBoYXMgKHRhcmdldCwga2V5KSB7CiAgICAgICAgdmFyIGhhcyA9IGtleSBpbiB0YXJnZXQ7CiAgICAgICAgdmFyIGlzQWxsb3dlZCA9IGFsbG93ZWRHbG9iYWxzKGtleSkgfHwKICAgICAgICAgICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkuY2hhckF0KDApID09PSAnXycgJiYgIShrZXkgaW4gdGFyZ2V0LiRkYXRhKSk7CiAgICAgICAgaWYgKCFoYXMgJiYgIWlzQWxsb3dlZCkgewogICAgICAgICAgaWYgKGtleSBpbiB0YXJnZXQuJGRhdGEpIHsgd2FyblJlc2VydmVkUHJlZml4KHRhcmdldCwga2V5KTsgfQogICAgICAgICAgZWxzZSB7IHdhcm5Ob25QcmVzZW50KHRhcmdldCwga2V5KTsgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaGFzIHx8ICFpc0FsbG93ZWQKICAgICAgfQogICAgfTsKCiAgICB2YXIgZ2V0SGFuZGxlciA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQgKHRhcmdldCwga2V5KSB7CiAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmICEoa2V5IGluIHRhcmdldCkpIHsKICAgICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0LiRkYXRhKSB7IHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSk7IH0KICAgICAgICAgIGVsc2UgeyB3YXJuTm9uUHJlc2VudCh0YXJnZXQsIGtleSk7IH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhcmdldFtrZXldCiAgICAgIH0KICAgIH07CgogICAgaW5pdFByb3h5ID0gZnVuY3Rpb24gaW5pdFByb3h5ICh2bSkgewogICAgICBpZiAoaGFzUHJveHkpIHsKICAgICAgICAvLyBkZXRlcm1pbmUgd2hpY2ggcHJveHkgaGFuZGxlciB0byB1c2UKICAgICAgICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogICAgICAgIHZhciBoYW5kbGVycyA9IG9wdGlvbnMucmVuZGVyICYmIG9wdGlvbnMucmVuZGVyLl93aXRoU3RyaXBwZWQKICAgICAgICAgID8gZ2V0SGFuZGxlcgogICAgICAgICAgOiBoYXNIYW5kbGVyOwogICAgICAgIHZtLl9yZW5kZXJQcm94eSA9IG5ldyBQcm94eSh2bSwgaGFuZGxlcnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHZtLl9yZW5kZXJQcm94eSA9IHZtOwogICAgICB9CiAgICB9OwogIH0KCiAgLyogICovCgogIHZhciBzZWVuT2JqZWN0cyA9IG5ldyBfU2V0KCk7CgogIC8qKgogICAqIFJlY3Vyc2l2ZWx5IHRyYXZlcnNlIGFuIG9iamVjdCB0byBldm9rZSBhbGwgY29udmVydGVkCiAgICogZ2V0dGVycywgc28gdGhhdCBldmVyeSBuZXN0ZWQgcHJvcGVydHkgaW5zaWRlIHRoZSBvYmplY3QKICAgKiBpcyBjb2xsZWN0ZWQgYXMgYSAiZGVlcCIgZGVwZW5kZW5jeS4KICAgKi8KICBmdW5jdGlvbiB0cmF2ZXJzZSAodmFsKSB7CiAgICBfdHJhdmVyc2UodmFsLCBzZWVuT2JqZWN0cyk7CiAgICBzZWVuT2JqZWN0cy5jbGVhcigpOwogIH0KCiAgZnVuY3Rpb24gX3RyYXZlcnNlICh2YWwsIHNlZW4pIHsKICAgIHZhciBpLCBrZXlzOwogICAgdmFyIGlzQSA9IEFycmF5LmlzQXJyYXkodmFsKTsKICAgIGlmICgoIWlzQSAmJiAhaXNPYmplY3QodmFsKSkgfHwgT2JqZWN0LmlzRnJvemVuKHZhbCkgfHwgdmFsIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAodmFsLl9fb2JfXykgewogICAgICB2YXIgZGVwSWQgPSB2YWwuX19vYl9fLmRlcC5pZDsKICAgICAgaWYgKHNlZW4uaGFzKGRlcElkKSkgewogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIHNlZW4uYWRkKGRlcElkKTsKICAgIH0KICAgIGlmIChpc0EpIHsKICAgICAgaSA9IHZhbC5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsgX3RyYXZlcnNlKHZhbFtpXSwgc2Vlbik7IH0KICAgIH0gZWxzZSB7CiAgICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICBpID0ga2V5cy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsgX3RyYXZlcnNlKHZhbFtrZXlzW2ldXSwgc2Vlbik7IH0KICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgbm9ybWFsaXplRXZlbnQgPSBjYWNoZWQoZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBwYXNzaXZlID0gbmFtZS5jaGFyQXQoMCkgPT09ICcmJzsKICAgIG5hbWUgPSBwYXNzaXZlID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgICB2YXIgb25jZSQkMSA9IG5hbWUuY2hhckF0KDApID09PSAnfic7IC8vIFByZWZpeGVkIGxhc3QsIGNoZWNrZWQgZmlyc3QKICAgIG5hbWUgPSBvbmNlJCQxID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgICB2YXIgY2FwdHVyZSA9IG5hbWUuY2hhckF0KDApID09PSAnISc7CiAgICBuYW1lID0gY2FwdHVyZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogICAgcmV0dXJuIHsKICAgICAgbmFtZTogbmFtZSwKICAgICAgb25jZTogb25jZSQkMSwKICAgICAgY2FwdHVyZTogY2FwdHVyZSwKICAgICAgcGFzc2l2ZTogcGFzc2l2ZQogICAgfQogIH0pOwoKICBmdW5jdGlvbiBjcmVhdGVGbkludm9rZXIgKGZucywgdm0pIHsKICAgIGZ1bmN0aW9uIGludm9rZXIgKCkgewogICAgICB2YXIgYXJndW1lbnRzJDEgPSBhcmd1bWVudHM7CgogICAgICB2YXIgZm5zID0gaW52b2tlci5mbnM7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGZucykpIHsKICAgICAgICB2YXIgY2xvbmVkID0gZm5zLnNsaWNlKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbG9uZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNsb25lZFtpXSwgbnVsbCwgYXJndW1lbnRzJDEsIHZtLCAidi1vbiBoYW5kbGVyIik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIHJldHVybiBoYW5kbGVyIHJldHVybiB2YWx1ZSBmb3Igc2luZ2xlIGhhbmRsZXJzCiAgICAgICAgcmV0dXJuIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGZucywgbnVsbCwgYXJndW1lbnRzLCB2bSwgInYtb24gaGFuZGxlciIpCiAgICAgIH0KICAgIH0KICAgIGludm9rZXIuZm5zID0gZm5zOwogICAgcmV0dXJuIGludm9rZXIKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUxpc3RlbmVycyAoCiAgICBvbiwKICAgIG9sZE9uLAogICAgYWRkLAogICAgcmVtb3ZlJCQxLAogICAgY3JlYXRlT25jZUhhbmRsZXIsCiAgICB2bQogICkgewogICAgdmFyIG5hbWUsIGRlZiQkMSwgY3VyLCBvbGQsIGV2ZW50OwogICAgZm9yIChuYW1lIGluIG9uKSB7CiAgICAgIGRlZiQkMSA9IGN1ciA9IG9uW25hbWVdOwogICAgICBvbGQgPSBvbGRPbltuYW1lXTsKICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgaWYgKGlzVW5kZWYoY3VyKSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAiSW52YWxpZCBoYW5kbGVyIGZvciBldmVudCBcIiIgKyAoZXZlbnQubmFtZSkgKyAiXCI6IGdvdCAiICsgU3RyaW5nKGN1ciksCiAgICAgICAgICB2bQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGQpKSB7CiAgICAgICAgaWYgKGlzVW5kZWYoY3VyLmZucykpIHsKICAgICAgICAgIGN1ciA9IG9uW25hbWVdID0gY3JlYXRlRm5JbnZva2VyKGN1ciwgdm0pOwogICAgICAgIH0KICAgICAgICBpZiAoaXNUcnVlKGV2ZW50Lm9uY2UpKSB7CiAgICAgICAgICBjdXIgPSBvbltuYW1lXSA9IGNyZWF0ZU9uY2VIYW5kbGVyKGV2ZW50Lm5hbWUsIGN1ciwgZXZlbnQuY2FwdHVyZSk7CiAgICAgICAgfQogICAgICAgIGFkZChldmVudC5uYW1lLCBjdXIsIGV2ZW50LmNhcHR1cmUsIGV2ZW50LnBhc3NpdmUsIGV2ZW50LnBhcmFtcyk7CiAgICAgIH0gZWxzZSBpZiAoY3VyICE9PSBvbGQpIHsKICAgICAgICBvbGQuZm5zID0gY3VyOwogICAgICAgIG9uW25hbWVdID0gb2xkOwogICAgICB9CiAgICB9CiAgICBmb3IgKG5hbWUgaW4gb2xkT24pIHsKICAgICAgaWYgKGlzVW5kZWYob25bbmFtZV0pKSB7CiAgICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgICByZW1vdmUkJDEoZXZlbnQubmFtZSwgb2xkT25bbmFtZV0sIGV2ZW50LmNhcHR1cmUpOwogICAgICB9CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gbWVyZ2VWTm9kZUhvb2sgKGRlZiwgaG9va0tleSwgaG9vaykgewogICAgaWYgKGRlZiBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICAgIGRlZiA9IGRlZi5kYXRhLmhvb2sgfHwgKGRlZi5kYXRhLmhvb2sgPSB7fSk7CiAgICB9CiAgICB2YXIgaW52b2tlcjsKICAgIHZhciBvbGRIb29rID0gZGVmW2hvb2tLZXldOwoKICAgIGZ1bmN0aW9uIHdyYXBwZWRIb29rICgpIHsKICAgICAgaG9vay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAvLyBpbXBvcnRhbnQ6IHJlbW92ZSBtZXJnZWQgaG9vayB0byBlbnN1cmUgaXQncyBjYWxsZWQgb25seSBvbmNlCiAgICAgIC8vIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrCiAgICAgIHJlbW92ZShpbnZva2VyLmZucywgd3JhcHBlZEhvb2spOwogICAgfQoKICAgIGlmIChpc1VuZGVmKG9sZEhvb2spKSB7CiAgICAgIC8vIG5vIGV4aXN0aW5nIGhvb2sKICAgICAgaW52b2tlciA9IGNyZWF0ZUZuSW52b2tlcihbd3JhcHBlZEhvb2tdKTsKICAgIH0gZWxzZSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoaXNEZWYob2xkSG9vay5mbnMpICYmIGlzVHJ1ZShvbGRIb29rLm1lcmdlZCkpIHsKICAgICAgICAvLyBhbHJlYWR5IGEgbWVyZ2VkIGludm9rZXIKICAgICAgICBpbnZva2VyID0gb2xkSG9vazsKICAgICAgICBpbnZva2VyLmZucy5wdXNoKHdyYXBwZWRIb29rKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBleGlzdGluZyBwbGFpbiBob29rCiAgICAgICAgaW52b2tlciA9IGNyZWF0ZUZuSW52b2tlcihbb2xkSG9vaywgd3JhcHBlZEhvb2tdKTsKICAgICAgfQogICAgfQoKICAgIGludm9rZXIubWVyZ2VkID0gdHJ1ZTsKICAgIGRlZltob29rS2V5XSA9IGludm9rZXI7CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gZXh0cmFjdFByb3BzRnJvbVZOb2RlRGF0YSAoCiAgICBkYXRhLAogICAgQ3RvciwKICAgIHRhZwogICkgewogICAgLy8gd2UgYXJlIG9ubHkgZXh0cmFjdGluZyByYXcgdmFsdWVzIGhlcmUuCiAgICAvLyB2YWxpZGF0aW9uIGFuZCBkZWZhdWx0IHZhbHVlcyBhcmUgaGFuZGxlZCBpbiB0aGUgY2hpbGQKICAgIC8vIGNvbXBvbmVudCBpdHNlbGYuCiAgICB2YXIgcHJvcE9wdGlvbnMgPSBDdG9yLm9wdGlvbnMucHJvcHM7CiAgICBpZiAoaXNVbmRlZihwcm9wT3B0aW9ucykpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgYXR0cnMgPSBkYXRhLmF0dHJzOwogICAgdmFyIHByb3BzID0gZGF0YS5wcm9wczsKICAgIGlmIChpc0RlZihhdHRycykgfHwgaXNEZWYocHJvcHMpKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICAgIHZhciBhbHRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKICAgICAgICB7CiAgICAgICAgICB2YXIga2V5SW5Mb3dlckNhc2UgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAga2V5ICE9PSBrZXlJbkxvd2VyQ2FzZSAmJgogICAgICAgICAgICBhdHRycyAmJiBoYXNPd24oYXR0cnMsIGtleUluTG93ZXJDYXNlKQogICAgICAgICAgKSB7CiAgICAgICAgICAgIHRpcCgKICAgICAgICAgICAgICAiUHJvcCBcIiIgKyBrZXlJbkxvd2VyQ2FzZSArICJcIiBpcyBwYXNzZWQgdG8gY29tcG9uZW50ICIgKwogICAgICAgICAgICAgIChmb3JtYXRDb21wb25lbnROYW1lKHRhZyB8fCBDdG9yKSkgKyAiLCBidXQgdGhlIGRlY2xhcmVkIHByb3AgbmFtZSBpcyIgKwogICAgICAgICAgICAgICIgXCIiICsga2V5ICsgIlwiLiAiICsKICAgICAgICAgICAgICAiTm90ZSB0aGF0IEhUTUwgYXR0cmlidXRlcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZSBhbmQgY2FtZWxDYXNlZCAiICsKICAgICAgICAgICAgICAicHJvcHMgbmVlZCB0byB1c2UgdGhlaXIga2ViYWItY2FzZSBlcXVpdmFsZW50cyB3aGVuIHVzaW5nIGluLURPTSAiICsKICAgICAgICAgICAgICAidGVtcGxhdGVzLiBZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIgKyBhbHRLZXkgKyAiXCIgaW5zdGVhZCBvZiBcIiIgKyBrZXkgKyAiXCIuIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjaGVja1Byb3AocmVzLCBwcm9wcywga2V5LCBhbHRLZXksIHRydWUpIHx8CiAgICAgICAgY2hlY2tQcm9wKHJlcywgYXR0cnMsIGtleSwgYWx0S2V5LCBmYWxzZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXMKICB9CgogIGZ1bmN0aW9uIGNoZWNrUHJvcCAoCiAgICByZXMsCiAgICBoYXNoLAogICAga2V5LAogICAgYWx0S2V5LAogICAgcHJlc2VydmUKICApIHsKICAgIGlmIChpc0RlZihoYXNoKSkgewogICAgICBpZiAoaGFzT3duKGhhc2gsIGtleSkpIHsKICAgICAgICByZXNba2V5XSA9IGhhc2hba2V5XTsKICAgICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgICBkZWxldGUgaGFzaFtrZXldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9IGVsc2UgaWYgKGhhc093bihoYXNoLCBhbHRLZXkpKSB7CiAgICAgICAgcmVzW2tleV0gPSBoYXNoW2FsdEtleV07CiAgICAgICAgaWYgKCFwcmVzZXJ2ZSkgewogICAgICAgICAgZGVsZXRlIGhhc2hbYWx0S2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICAvKiAgKi8KCiAgLy8gVGhlIHRlbXBsYXRlIGNvbXBpbGVyIGF0dGVtcHRzIHRvIG1pbmltaXplIHRoZSBuZWVkIGZvciBub3JtYWxpemF0aW9uIGJ5CiAgLy8gc3RhdGljYWxseSBhbmFseXppbmcgdGhlIHRlbXBsYXRlIGF0IGNvbXBpbGUgdGltZS4KICAvLwogIC8vIEZvciBwbGFpbiBIVE1MIG1hcmt1cCwgbm9ybWFsaXphdGlvbiBjYW4gYmUgY29tcGxldGVseSBza2lwcGVkIGJlY2F1c2UgdGhlCiAgLy8gZ2VuZXJhdGVkIHJlbmRlciBmdW5jdGlvbiBpcyBndWFyYW50ZWVkIHRvIHJldHVybiBBcnJheTxWTm9kZT4uIFRoZXJlIGFyZQogIC8vIHR3byBjYXNlcyB3aGVyZSBleHRyYSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZDoKCiAgLy8gMS4gV2hlbiB0aGUgY2hpbGRyZW4gY29udGFpbnMgY29tcG9uZW50cyAtIGJlY2F1c2UgYSBmdW5jdGlvbmFsIGNvbXBvbmVudAogIC8vIG1heSByZXR1cm4gYW4gQXJyYXkgaW5zdGVhZCBvZiBhIHNpbmdsZSByb290LiBJbiB0aGlzIGNhc2UsIGp1c3QgYSBzaW1wbGUKICAvLyBub3JtYWxpemF0aW9uIGlzIG5lZWRlZCAtIGlmIGFueSBjaGlsZCBpcyBhbiBBcnJheSwgd2UgZmxhdHRlbiB0aGUgd2hvbGUKICAvLyB0aGluZyB3aXRoIEFycmF5LnByb3RvdHlwZS5jb25jYXQuIEl0IGlzIGd1YXJhbnRlZWQgdG8gYmUgb25seSAxLWxldmVsIGRlZXAKICAvLyBiZWNhdXNlIGZ1bmN0aW9uYWwgY29tcG9uZW50cyBhbHJlYWR5IG5vcm1hbGl6ZSB0aGVpciBvd24gY2hpbGRyZW4uCiAgZnVuY3Rpb24gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4gKGNoaWxkcmVuKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuW2ldKSkgewogICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuY29uY2F0LmFwcGx5KFtdLCBjaGlsZHJlbikKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNoaWxkcmVuCiAgfQoKICAvLyAyLiBXaGVuIHRoZSBjaGlsZHJlbiBjb250YWlucyBjb25zdHJ1Y3RzIHRoYXQgYWx3YXlzIGdlbmVyYXRlZCBuZXN0ZWQgQXJyYXlzLAogIC8vIGUuZy4gPHRlbXBsYXRlPiwgPHNsb3Q+LCB2LWZvciwgb3Igd2hlbiB0aGUgY2hpbGRyZW4gaXMgcHJvdmlkZWQgYnkgdXNlcgogIC8vIHdpdGggaGFuZC13cml0dGVuIHJlbmRlciBmdW5jdGlvbnMgLyBKU1guIEluIHN1Y2ggY2FzZXMgYSBmdWxsIG5vcm1hbGl6YXRpb24KICAvLyBpcyBuZWVkZWQgdG8gY2F0ZXIgdG8gYWxsIHBvc3NpYmxlIHR5cGVzIG9mIGNoaWxkcmVuIHZhbHVlcy4KICBmdW5jdGlvbiBub3JtYWxpemVDaGlsZHJlbiAoY2hpbGRyZW4pIHsKICAgIHJldHVybiBpc1ByaW1pdGl2ZShjaGlsZHJlbikKICAgICAgPyBbY3JlYXRlVGV4dFZOb2RlKGNoaWxkcmVuKV0KICAgICAgOiBBcnJheS5pc0FycmF5KGNoaWxkcmVuKQogICAgICAgID8gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbikKICAgICAgICA6IHVuZGVmaW5lZAogIH0KCiAgZnVuY3Rpb24gaXNUZXh0Tm9kZSAobm9kZSkgewogICAgcmV0dXJuIGlzRGVmKG5vZGUpICYmIGlzRGVmKG5vZGUudGV4dCkgJiYgaXNGYWxzZShub2RlLmlzQ29tbWVudCkKICB9CgogIGZ1bmN0aW9uIG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4gKGNoaWxkcmVuLCBuZXN0ZWRJbmRleCkgewogICAgdmFyIHJlcyA9IFtdOwogICAgdmFyIGksIGMsIGxhc3RJbmRleCwgbGFzdDsKICAgIGZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBjID0gY2hpbGRyZW5baV07CiAgICAgIGlmIChpc1VuZGVmKGMpIHx8IHR5cGVvZiBjID09PSAnYm9vbGVhbicpIHsgY29udGludWUgfQogICAgICBsYXN0SW5kZXggPSByZXMubGVuZ3RoIC0gMTsKICAgICAgbGFzdCA9IHJlc1tsYXN0SW5kZXhdOwogICAgICAvLyAgbmVzdGVkCiAgICAgIGlmIChBcnJheS5pc0FycmF5KGMpKSB7CiAgICAgICAgaWYgKGMubGVuZ3RoID4gMCkgewogICAgICAgICAgYyA9IG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4oYywgKChuZXN0ZWRJbmRleCB8fCAnJykgKyAiXyIgKyBpKSk7CiAgICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgICBpZiAoaXNUZXh0Tm9kZShjWzBdKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIChjWzBdKS50ZXh0KTsKICAgICAgICAgICAgYy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmVzLnB1c2guYXBwbHkocmVzLCBjKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNQcmltaXRpdmUoYykpIHsKICAgICAgICBpZiAoaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgICAgLy8gdGhpcyBpcyBuZWNlc3NhcnkgZm9yIFNTUiBoeWRyYXRpb24gYmVjYXVzZSB0ZXh0IG5vZGVzIGFyZQogICAgICAgICAgLy8gZXNzZW50aWFsbHkgbWVyZ2VkIHdoZW4gcmVuZGVyZWQgdG8gSFRNTCBzdHJpbmdzCiAgICAgICAgICByZXNbbGFzdEluZGV4XSA9IGNyZWF0ZVRleHRWTm9kZShsYXN0LnRleHQgKyBjKTsKICAgICAgICB9IGVsc2UgaWYgKGMgIT09ICcnKSB7CiAgICAgICAgICAvLyBjb252ZXJ0IHByaW1pdGl2ZSB0byB2bm9kZQogICAgICAgICAgcmVzLnB1c2goY3JlYXRlVGV4dFZOb2RlKGMpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzVGV4dE5vZGUoYykgJiYgaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgYy50ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gZGVmYXVsdCBrZXkgZm9yIG5lc3RlZCBhcnJheSBjaGlsZHJlbiAobGlrZWx5IGdlbmVyYXRlZCBieSB2LWZvcikKICAgICAgICAgIGlmIChpc1RydWUoY2hpbGRyZW4uX2lzVkxpc3QpICYmCiAgICAgICAgICAgIGlzRGVmKGMudGFnKSAmJgogICAgICAgICAgICBpc1VuZGVmKGMua2V5KSAmJgogICAgICAgICAgICBpc0RlZihuZXN0ZWRJbmRleCkpIHsKICAgICAgICAgICAgYy5rZXkgPSAiX192bGlzdCIgKyBuZXN0ZWRJbmRleCArICJfIiArIGkgKyAiX18iOwogICAgICAgICAgfQogICAgICAgICAgcmVzLnB1c2goYyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdFByb3ZpZGUgKHZtKSB7CiAgICB2YXIgcHJvdmlkZSA9IHZtLiRvcHRpb25zLnByb3ZpZGU7CiAgICBpZiAocHJvdmlkZSkgewogICAgICB2bS5fcHJvdmlkZWQgPSB0eXBlb2YgcHJvdmlkZSA9PT0gJ2Z1bmN0aW9uJwogICAgICAgID8gcHJvdmlkZS5jYWxsKHZtKQogICAgICAgIDogcHJvdmlkZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaXRJbmplY3Rpb25zICh2bSkgewogICAgdmFyIHJlc3VsdCA9IHJlc29sdmVJbmplY3Qodm0uJG9wdGlvbnMuaW5qZWN0LCB2bSk7CiAgICBpZiAocmVzdWx0KSB7CiAgICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICAgIE9iamVjdC5rZXlzKHJlc3VsdCkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgICAgICB7CiAgICAgICAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwga2V5LCByZXN1bHRba2V5XSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICJBdm9pZCBtdXRhdGluZyBhbiBpbmplY3RlZCB2YWx1ZSBkaXJlY3RseSBzaW5jZSB0aGUgY2hhbmdlcyB3aWxsIGJlICIgKwogICAgICAgICAgICAgICJvdmVyd3JpdHRlbiB3aGVuZXZlciB0aGUgcHJvdmlkZWQgY29tcG9uZW50IHJlLXJlbmRlcnMuICIgKwogICAgICAgICAgICAgICJpbmplY3Rpb24gYmVpbmcgbXV0YXRlZDogXCIiICsga2V5ICsgIlwiIiwKICAgICAgICAgICAgICB2bQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZUluamVjdCAoaW5qZWN0LCB2bSkgewogICAgaWYgKGluamVjdCkgewogICAgICAvLyBpbmplY3QgaXMgOmFueSBiZWNhdXNlIGZsb3cgaXMgbm90IHNtYXJ0IGVub3VnaCB0byBmaWd1cmUgb3V0IGNhY2hlZAogICAgICB2YXIgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdmFyIGtleXMgPSBoYXNTeW1ib2wKICAgICAgICA/IFJlZmxlY3Qub3duS2V5cyhpbmplY3QpCiAgICAgICAgOiBPYmplY3Qua2V5cyhpbmplY3QpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgLy8gIzY1NzQgaW4gY2FzZSB0aGUgaW5qZWN0IG9iamVjdCBpcyBvYnNlcnZlZC4uLgogICAgICAgIGlmIChrZXkgPT09ICdfX29iX18nKSB7IGNvbnRpbnVlIH0KICAgICAgICB2YXIgcHJvdmlkZUtleSA9IGluamVjdFtrZXldLmZyb207CiAgICAgICAgdmFyIHNvdXJjZSA9IHZtOwogICAgICAgIHdoaWxlIChzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UuX3Byb3ZpZGVkICYmIGhhc093bihzb3VyY2UuX3Byb3ZpZGVkLCBwcm92aWRlS2V5KSkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IHNvdXJjZS5fcHJvdmlkZWRbcHJvdmlkZUtleV07CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CiAgICAgICAgICBzb3VyY2UgPSBzb3VyY2UuJHBhcmVudDsKICAgICAgICB9CiAgICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICAgIGlmICgnZGVmYXVsdCcgaW4gaW5qZWN0W2tleV0pIHsKICAgICAgICAgICAgdmFyIHByb3ZpZGVEZWZhdWx0ID0gaW5qZWN0W2tleV0uZGVmYXVsdDsKICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB0eXBlb2YgcHJvdmlkZURlZmF1bHQgPT09ICdmdW5jdGlvbicKICAgICAgICAgICAgICA/IHByb3ZpZGVEZWZhdWx0LmNhbGwodm0pCiAgICAgICAgICAgICAgOiBwcm92aWRlRGVmYXVsdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdhcm4oKCJJbmplY3Rpb24gXCIiICsga2V5ICsgIlwiIG5vdCBmb3VuZCIpLCB2bSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQKICAgIH0KICB9CgogIC8qICAqLwoKCgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciByZXNvbHZpbmcgcmF3IGNoaWxkcmVuIFZOb2RlcyBpbnRvIGEgc2xvdCBvYmplY3QuCiAgICovCiAgZnVuY3Rpb24gcmVzb2x2ZVNsb3RzICgKICAgIGNoaWxkcmVuLAogICAgY29udGV4dAogICkgewogICAgaWYgKCFjaGlsZHJlbiB8fCAhY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgIHJldHVybiB7fQogICAgfQogICAgdmFyIHNsb3RzID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgdmFyIGRhdGEgPSBjaGlsZC5kYXRhOwogICAgICAvLyByZW1vdmUgc2xvdCBhdHRyaWJ1dGUgaWYgdGhlIG5vZGUgaXMgcmVzb2x2ZWQgYXMgYSBWdWUgc2xvdCBub2RlCiAgICAgIGlmIChkYXRhICYmIGRhdGEuYXR0cnMgJiYgZGF0YS5hdHRycy5zbG90KSB7CiAgICAgICAgZGVsZXRlIGRhdGEuYXR0cnMuc2xvdDsKICAgICAgfQogICAgICAvLyBuYW1lZCBzbG90cyBzaG91bGQgb25seSBiZSByZXNwZWN0ZWQgaWYgdGhlIHZub2RlIHdhcyByZW5kZXJlZCBpbiB0aGUKICAgICAgLy8gc2FtZSBjb250ZXh0LgogICAgICBpZiAoKGNoaWxkLmNvbnRleHQgPT09IGNvbnRleHQgfHwgY2hpbGQuZm5Db250ZXh0ID09PSBjb250ZXh0KSAmJgogICAgICAgIGRhdGEgJiYgZGF0YS5zbG90ICE9IG51bGwKICAgICAgKSB7CiAgICAgICAgdmFyIG5hbWUgPSBkYXRhLnNsb3Q7CiAgICAgICAgdmFyIHNsb3QgPSAoc2xvdHNbbmFtZV0gfHwgKHNsb3RzW25hbWVdID0gW10pKTsKICAgICAgICBpZiAoY2hpbGQudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgICBzbG90LnB1c2guYXBwbHkoc2xvdCwgY2hpbGQuY2hpbGRyZW4gfHwgW10pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzbG90LnB1c2goY2hpbGQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAoc2xvdHMuZGVmYXVsdCB8fCAoc2xvdHMuZGVmYXVsdCA9IFtdKSkucHVzaChjaGlsZCk7CiAgICAgIH0KICAgIH0KICAgIC8vIGlnbm9yZSBzbG90cyB0aGF0IGNvbnRhaW5zIG9ubHkgd2hpdGVzcGFjZQogICAgZm9yICh2YXIgbmFtZSQxIGluIHNsb3RzKSB7CiAgICAgIGlmIChzbG90c1tuYW1lJDFdLmV2ZXJ5KGlzV2hpdGVzcGFjZSkpIHsKICAgICAgICBkZWxldGUgc2xvdHNbbmFtZSQxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNsb3RzCiAgfQoKICBmdW5jdGlvbiBpc1doaXRlc3BhY2UgKG5vZGUpIHsKICAgIHJldHVybiAobm9kZS5pc0NvbW1lbnQgJiYgIW5vZGUuYXN5bmNGYWN0b3J5KSB8fCBub2RlLnRleHQgPT09ICcgJwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3RzICgKICAgIHNsb3RzLAogICAgbm9ybWFsU2xvdHMsCiAgICBwcmV2U2xvdHMKICApIHsKICAgIHZhciByZXM7CiAgICB2YXIgaGFzTm9ybWFsU2xvdHMgPSBPYmplY3Qua2V5cyhub3JtYWxTbG90cykubGVuZ3RoID4gMDsKICAgIHZhciBpc1N0YWJsZSA9IHNsb3RzID8gISFzbG90cy4kc3RhYmxlIDogIWhhc05vcm1hbFNsb3RzOwogICAgdmFyIGtleSA9IHNsb3RzICYmIHNsb3RzLiRrZXk7CiAgICBpZiAoIXNsb3RzKSB7CiAgICAgIHJlcyA9IHt9OwogICAgfSBlbHNlIGlmIChzbG90cy5fbm9ybWFsaXplZCkgewogICAgICAvLyBmYXN0IHBhdGggMTogY2hpbGQgY29tcG9uZW50IHJlLXJlbmRlciBvbmx5LCBwYXJlbnQgZGlkIG5vdCBjaGFuZ2UKICAgICAgcmV0dXJuIHNsb3RzLl9ub3JtYWxpemVkCiAgICB9IGVsc2UgaWYgKAogICAgICBpc1N0YWJsZSAmJgogICAgICBwcmV2U2xvdHMgJiYKICAgICAgcHJldlNsb3RzICE9PSBlbXB0eU9iamVjdCAmJgogICAgICBrZXkgPT09IHByZXZTbG90cy4ka2V5ICYmCiAgICAgICFoYXNOb3JtYWxTbG90cyAmJgogICAgICAhcHJldlNsb3RzLiRoYXNOb3JtYWwKICAgICkgewogICAgICAvLyBmYXN0IHBhdGggMjogc3RhYmxlIHNjb3BlZCBzbG90cyB3LyBubyBub3JtYWwgc2xvdHMgdG8gcHJveHksCiAgICAgIC8vIG9ubHkgbmVlZCB0byBub3JtYWxpemUgb25jZQogICAgICByZXR1cm4gcHJldlNsb3RzCiAgICB9IGVsc2UgewogICAgICByZXMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5JDEgaW4gc2xvdHMpIHsKICAgICAgICBpZiAoc2xvdHNba2V5JDFdICYmIGtleSQxWzBdICE9PSAnJCcpIHsKICAgICAgICAgIHJlc1trZXkkMV0gPSBub3JtYWxpemVTY29wZWRTbG90KG5vcm1hbFNsb3RzLCBrZXkkMSwgc2xvdHNba2V5JDFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8vIGV4cG9zZSBub3JtYWwgc2xvdHMgb24gc2NvcGVkU2xvdHMKICAgIGZvciAodmFyIGtleSQyIGluIG5vcm1hbFNsb3RzKSB7CiAgICAgIGlmICghKGtleSQyIGluIHJlcykpIHsKICAgICAgICByZXNba2V5JDJdID0gcHJveHlOb3JtYWxTbG90KG5vcm1hbFNsb3RzLCBrZXkkMik7CiAgICAgIH0KICAgIH0KICAgIC8vIGF2b3JpYXogc2VlbXMgdG8gbW9jayBhIG5vbi1leHRlbnNpYmxlICRzY29wZWRTbG90cyBvYmplY3QKICAgIC8vIGFuZCB3aGVuIHRoYXQgaXMgcGFzc2VkIGRvd24gdGhpcyB3b3VsZCBjYXVzZSBhbiBlcnJvcgogICAgaWYgKHNsb3RzICYmIE9iamVjdC5pc0V4dGVuc2libGUoc2xvdHMpKSB7CiAgICAgIChzbG90cykuX25vcm1hbGl6ZWQgPSByZXM7CiAgICB9CiAgICBkZWYocmVzLCAnJHN0YWJsZScsIGlzU3RhYmxlKTsKICAgIGRlZihyZXMsICcka2V5Jywga2V5KTsKICAgIGRlZihyZXMsICckaGFzTm9ybWFsJywgaGFzTm9ybWFsU2xvdHMpOwogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gbm9ybWFsaXplU2NvcGVkU2xvdChub3JtYWxTbG90cywga2V5LCBmbikgewogICAgdmFyIG5vcm1hbGl6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciByZXMgPSBhcmd1bWVudHMubGVuZ3RoID8gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKSA6IGZuKHt9KTsKICAgICAgcmVzID0gcmVzICYmIHR5cGVvZiByZXMgPT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHJlcykKICAgICAgICA/IFtyZXNdIC8vIHNpbmdsZSB2bm9kZQogICAgICAgIDogbm9ybWFsaXplQ2hpbGRyZW4ocmVzKTsKICAgICAgcmV0dXJuIHJlcyAmJiAoCiAgICAgICAgcmVzLmxlbmd0aCA9PT0gMCB8fAogICAgICAgIChyZXMubGVuZ3RoID09PSAxICYmIHJlc1swXS5pc0NvbW1lbnQpIC8vICM5NjU4CiAgICAgICkgPyB1bmRlZmluZWQKICAgICAgICA6IHJlcwogICAgfTsKICAgIC8vIHRoaXMgaXMgYSBzbG90IHVzaW5nIHRoZSBuZXcgdi1zbG90IHN5bnRheCB3aXRob3V0IHNjb3BlLiBhbHRob3VnaCBpdCBpcwogICAgLy8gY29tcGlsZWQgYXMgYSBzY29wZWQgc2xvdCwgcmVuZGVyIGZuIHVzZXJzIHdvdWxkIGV4cGVjdCBpdCB0byBiZSBwcmVzZW50CiAgICAvLyBvbiB0aGlzLiRzbG90cyBiZWNhdXNlIHRoZSB1c2FnZSBpcyBzZW1hbnRpY2FsbHkgYSBub3JtYWwgc2xvdC4KICAgIGlmIChmbi5wcm94eSkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9ybWFsU2xvdHMsIGtleSwgewogICAgICAgIGdldDogbm9ybWFsaXplZCwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBub3JtYWxpemVkCiAgfQoKICBmdW5jdGlvbiBwcm94eU5vcm1hbFNsb3Qoc2xvdHMsIGtleSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsgcmV0dXJuIHNsb3RzW2tleV07IH0KICB9CgogIC8qICAqLwoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHYtZm9yIGxpc3RzLgogICAqLwogIGZ1bmN0aW9uIHJlbmRlckxpc3QgKAogICAgdmFsLAogICAgcmVuZGVyCiAgKSB7CiAgICB2YXIgcmV0LCBpLCBsLCBrZXlzLCBrZXk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpIHx8IHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldCA9IG5ldyBBcnJheSh2YWwubGVuZ3RoKTsKICAgICAgZm9yIChpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICByZXRbaV0gPSByZW5kZXIodmFsW2ldLCBpKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICByZXQgPSBuZXcgQXJyYXkodmFsKTsKICAgICAgZm9yIChpID0gMDsgaSA8IHZhbDsgaSsrKSB7CiAgICAgICAgcmV0W2ldID0gcmVuZGVyKGkgKyAxLCBpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc09iamVjdCh2YWwpKSB7CiAgICAgIGlmIChoYXNTeW1ib2wgJiYgdmFsW1N5bWJvbC5pdGVyYXRvcl0pIHsKICAgICAgICByZXQgPSBbXTsKICAgICAgICB2YXIgaXRlcmF0b3IgPSB2YWxbU3ltYm9sLml0ZXJhdG9yXSgpOwogICAgICAgIHZhciByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgICAgd2hpbGUgKCFyZXN1bHQuZG9uZSkgewogICAgICAgICAgcmV0LnB1c2gocmVuZGVyKHJlc3VsdC52YWx1ZSwgcmV0Lmxlbmd0aCkpOwogICAgICAgICAgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBrZXlzID0gT2JqZWN0LmtleXModmFsKTsKICAgICAgICByZXQgPSBuZXcgQXJyYXkoa2V5cy5sZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICAgIHJldFtpXSA9IHJlbmRlcih2YWxba2V5XSwga2V5LCBpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICghaXNEZWYocmV0KSkgewogICAgICByZXQgPSBbXTsKICAgIH0KICAgIChyZXQpLl9pc1ZMaXN0ID0gdHJ1ZTsKICAgIHJldHVybiByZXQKICB9CgogIC8qICAqLwoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIDxzbG90PgogICAqLwogIGZ1bmN0aW9uIHJlbmRlclNsb3QgKAogICAgbmFtZSwKICAgIGZhbGxiYWNrLAogICAgcHJvcHMsCiAgICBiaW5kT2JqZWN0CiAgKSB7CiAgICB2YXIgc2NvcGVkU2xvdEZuID0gdGhpcy4kc2NvcGVkU2xvdHNbbmFtZV07CiAgICB2YXIgbm9kZXM7CiAgICBpZiAoc2NvcGVkU2xvdEZuKSB7IC8vIHNjb3BlZCBzbG90CiAgICAgIHByb3BzID0gcHJvcHMgfHwge307CiAgICAgIGlmIChiaW5kT2JqZWN0KSB7CiAgICAgICAgaWYgKCFpc09iamVjdChiaW5kT2JqZWN0KSkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgJ3Nsb3Qgdi1iaW5kIHdpdGhvdXQgYXJndW1lbnQgZXhwZWN0cyBhbiBPYmplY3QnLAogICAgICAgICAgICB0aGlzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBwcm9wcyA9IGV4dGVuZChleHRlbmQoe30sIGJpbmRPYmplY3QpLCBwcm9wcyk7CiAgICAgIH0KICAgICAgbm9kZXMgPSBzY29wZWRTbG90Rm4ocHJvcHMpIHx8IGZhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgbm9kZXMgPSB0aGlzLiRzbG90c1tuYW1lXSB8fCBmYWxsYmFjazsKICAgIH0KCiAgICB2YXIgdGFyZ2V0ID0gcHJvcHMgJiYgcHJvcHMuc2xvdDsKICAgIGlmICh0YXJnZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJywgeyBzbG90OiB0YXJnZXQgfSwgbm9kZXMpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbm9kZXMKICAgIH0KICB9CgogIC8qICAqLwoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIGZpbHRlcnMKICAgKi8KICBmdW5jdGlvbiByZXNvbHZlRmlsdGVyIChpZCkgewogICAgcmV0dXJuIHJlc29sdmVBc3NldCh0aGlzLiRvcHRpb25zLCAnZmlsdGVycycsIGlkLCB0cnVlKSB8fCBpZGVudGl0eQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGlzS2V5Tm90TWF0Y2ggKGV4cGVjdCwgYWN0dWFsKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShleHBlY3QpKSB7CiAgICAgIHJldHVybiBleHBlY3QuaW5kZXhPZihhY3R1YWwpID09PSAtMQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGV4cGVjdCAhPT0gYWN0dWFsCiAgICB9CiAgfQoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3IgY2hlY2tpbmcga2V5Q29kZXMgZnJvbSBjb25maWcuCiAgICogZXhwb3NlZCBhcyBWdWUucHJvdG90eXBlLl9rCiAgICogcGFzc2luZyBpbiBldmVudEtleU5hbWUgYXMgbGFzdCBhcmd1bWVudCBzZXBhcmF0ZWx5IGZvciBiYWNrd2FyZHMgY29tcGF0CiAgICovCiAgZnVuY3Rpb24gY2hlY2tLZXlDb2RlcyAoCiAgICBldmVudEtleUNvZGUsCiAgICBrZXksCiAgICBidWlsdEluS2V5Q29kZSwKICAgIGV2ZW50S2V5TmFtZSwKICAgIGJ1aWx0SW5LZXlOYW1lCiAgKSB7CiAgICB2YXIgbWFwcGVkS2V5Q29kZSA9IGNvbmZpZy5rZXlDb2Rlc1trZXldIHx8IGJ1aWx0SW5LZXlDb2RlOwogICAgaWYgKGJ1aWx0SW5LZXlOYW1lICYmIGV2ZW50S2V5TmFtZSAmJiAhY29uZmlnLmtleUNvZGVzW2tleV0pIHsKICAgICAgcmV0dXJuIGlzS2V5Tm90TWF0Y2goYnVpbHRJbktleU5hbWUsIGV2ZW50S2V5TmFtZSkKICAgIH0gZWxzZSBpZiAobWFwcGVkS2V5Q29kZSkgewogICAgICByZXR1cm4gaXNLZXlOb3RNYXRjaChtYXBwZWRLZXlDb2RlLCBldmVudEtleUNvZGUpCiAgICB9IGVsc2UgaWYgKGV2ZW50S2V5TmFtZSkgewogICAgICByZXR1cm4gaHlwaGVuYXRlKGV2ZW50S2V5TmFtZSkgIT09IGtleQogICAgfQogIH0KCiAgLyogICovCgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciBtZXJnaW5nIHYtYmluZD0ib2JqZWN0IiBpbnRvIGEgVk5vZGUncyBkYXRhLgogICAqLwogIGZ1bmN0aW9uIGJpbmRPYmplY3RQcm9wcyAoCiAgICBkYXRhLAogICAgdGFnLAogICAgdmFsdWUsCiAgICBhc1Byb3AsCiAgICBpc1N5bmMKICApIHsKICAgIGlmICh2YWx1ZSkgewogICAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAndi1iaW5kIHdpdGhvdXQgYXJndW1lbnQgZXhwZWN0cyBhbiBPYmplY3Qgb3IgQXJyYXkgdmFsdWUnLAogICAgICAgICAgdGhpcwogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IHRvT2JqZWN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc2g7CiAgICAgICAgdmFyIGxvb3AgPSBmdW5jdGlvbiAoIGtleSApIHsKICAgICAgICAgIGlmICgKICAgICAgICAgICAga2V5ID09PSAnY2xhc3MnIHx8CiAgICAgICAgICAgIGtleSA9PT0gJ3N0eWxlJyB8fAogICAgICAgICAgICBpc1Jlc2VydmVkQXR0cmlidXRlKGtleSkKICAgICAgICAgICkgewogICAgICAgICAgICBoYXNoID0gZGF0YTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZGF0YS5hdHRycyAmJiBkYXRhLmF0dHJzLnR5cGU7CiAgICAgICAgICAgIGhhc2ggPSBhc1Byb3AgfHwgY29uZmlnLm11c3RVc2VQcm9wKHRhZywgdHlwZSwga2V5KQogICAgICAgICAgICAgID8gZGF0YS5kb21Qcm9wcyB8fCAoZGF0YS5kb21Qcm9wcyA9IHt9KQogICAgICAgICAgICAgIDogZGF0YS5hdHRycyB8fCAoZGF0YS5hdHRycyA9IHt9KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjYW1lbGl6ZWRLZXkgPSBjYW1lbGl6ZShrZXkpOwogICAgICAgICAgdmFyIGh5cGhlbmF0ZWRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKICAgICAgICAgIGlmICghKGNhbWVsaXplZEtleSBpbiBoYXNoKSAmJiAhKGh5cGhlbmF0ZWRLZXkgaW4gaGFzaCkpIHsKICAgICAgICAgICAgaGFzaFtrZXldID0gdmFsdWVba2V5XTsKCiAgICAgICAgICAgIGlmIChpc1N5bmMpIHsKICAgICAgICAgICAgICB2YXIgb24gPSBkYXRhLm9uIHx8IChkYXRhLm9uID0ge30pOwogICAgICAgICAgICAgIG9uWygidXBkYXRlOiIgKyBrZXkpXSA9IGZ1bmN0aW9uICgkZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhbHVlW2tleV0gPSAkZXZlbnQ7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgbG9vcCgga2V5ICk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkYXRhCiAgfQoKICAvKiAgKi8KCiAgLyoqCiAgICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyBzdGF0aWMgdHJlZXMuCiAgICovCiAgZnVuY3Rpb24gcmVuZGVyU3RhdGljICgKICAgIGluZGV4LAogICAgaXNJbkZvcgogICkgewogICAgdmFyIGNhY2hlZCA9IHRoaXMuX3N0YXRpY1RyZWVzIHx8ICh0aGlzLl9zdGF0aWNUcmVlcyA9IFtdKTsKICAgIHZhciB0cmVlID0gY2FjaGVkW2luZGV4XTsKICAgIC8vIGlmIGhhcyBhbHJlYWR5LXJlbmRlcmVkIHN0YXRpYyB0cmVlIGFuZCBub3QgaW5zaWRlIHYtZm9yLAogICAgLy8gd2UgY2FuIHJldXNlIHRoZSBzYW1lIHRyZWUuCiAgICBpZiAodHJlZSAmJiAhaXNJbkZvcikgewogICAgICByZXR1cm4gdHJlZQogICAgfQogICAgLy8gb3RoZXJ3aXNlLCByZW5kZXIgYSBmcmVzaCB0cmVlLgogICAgdHJlZSA9IGNhY2hlZFtpbmRleF0gPSB0aGlzLiRvcHRpb25zLnN0YXRpY1JlbmRlckZuc1tpbmRleF0uY2FsbCgKICAgICAgdGhpcy5fcmVuZGVyUHJveHksCiAgICAgIG51bGwsCiAgICAgIHRoaXMgLy8gZm9yIHJlbmRlciBmbnMgZ2VuZXJhdGVkIGZvciBmdW5jdGlvbmFsIGNvbXBvbmVudCB0ZW1wbGF0ZXMKICAgICk7CiAgICBtYXJrU3RhdGljKHRyZWUsICgiX19zdGF0aWNfXyIgKyBpbmRleCksIGZhbHNlKTsKICAgIHJldHVybiB0cmVlCiAgfQoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3Igdi1vbmNlLgogICAqIEVmZmVjdGl2ZWx5IGl0IG1lYW5zIG1hcmtpbmcgdGhlIG5vZGUgYXMgc3RhdGljIHdpdGggYSB1bmlxdWUga2V5LgogICAqLwogIGZ1bmN0aW9uIG1hcmtPbmNlICgKICAgIHRyZWUsCiAgICBpbmRleCwKICAgIGtleQogICkgewogICAgbWFya1N0YXRpYyh0cmVlLCAoIl9fb25jZV9fIiArIGluZGV4ICsgKGtleSA/ICgiXyIgKyBrZXkpIDogIiIpKSwgdHJ1ZSk7CiAgICByZXR1cm4gdHJlZQogIH0KCiAgZnVuY3Rpb24gbWFya1N0YXRpYyAoCiAgICB0cmVlLAogICAga2V5LAogICAgaXNPbmNlCiAgKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0cmVlKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyZWUubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodHJlZVtpXSAmJiB0eXBlb2YgdHJlZVtpXSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIG1hcmtTdGF0aWNOb2RlKHRyZWVbaV0sIChrZXkgKyAiXyIgKyBpKSwgaXNPbmNlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG1hcmtTdGF0aWNOb2RlKHRyZWUsIGtleSwgaXNPbmNlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1hcmtTdGF0aWNOb2RlIChub2RlLCBrZXksIGlzT25jZSkgewogICAgbm9kZS5pc1N0YXRpYyA9IHRydWU7CiAgICBub2RlLmtleSA9IGtleTsKICAgIG5vZGUuaXNPbmNlID0gaXNPbmNlOwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGJpbmRPYmplY3RMaXN0ZW5lcnMgKGRhdGEsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUpIHsKICAgICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAndi1vbiB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0IHZhbHVlJywKICAgICAgICAgIHRoaXMKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBvbiA9IGRhdGEub24gPSBkYXRhLm9uID8gZXh0ZW5kKHt9LCBkYXRhLm9uKSA6IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgICAgICAgdmFyIGV4aXN0aW5nID0gb25ba2V5XTsKICAgICAgICAgIHZhciBvdXJzID0gdmFsdWVba2V5XTsKICAgICAgICAgIG9uW2tleV0gPSBleGlzdGluZyA/IFtdLmNvbmNhdChleGlzdGluZywgb3VycykgOiBvdXJzOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGRhdGEKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiByZXNvbHZlU2NvcGVkU2xvdHMgKAogICAgZm5zLCAvLyBzZWUgZmxvdy92bm9kZQogICAgcmVzLAogICAgLy8gdGhlIGZvbGxvd2luZyBhcmUgYWRkZWQgaW4gMi42CiAgICBoYXNEeW5hbWljS2V5cywKICAgIGNvbnRlbnRIYXNoS2V5CiAgKSB7CiAgICByZXMgPSByZXMgfHwgeyAkc3RhYmxlOiAhaGFzRHluYW1pY0tleXMgfTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBzbG90ID0gZm5zW2ldOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShzbG90KSkgewogICAgICAgIHJlc29sdmVTY29wZWRTbG90cyhzbG90LCByZXMsIGhhc0R5bmFtaWNLZXlzKTsKICAgICAgfSBlbHNlIGlmIChzbG90KSB7CiAgICAgICAgLy8gbWFya2VyIGZvciByZXZlcnNlIHByb3h5aW5nIHYtc2xvdCB3aXRob3V0IHNjb3BlIG9uIHRoaXMuJHNsb3RzCiAgICAgICAgaWYgKHNsb3QucHJveHkpIHsKICAgICAgICAgIHNsb3QuZm4ucHJveHkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXNbc2xvdC5rZXldID0gc2xvdC5mbjsKICAgICAgfQogICAgfQogICAgaWYgKGNvbnRlbnRIYXNoS2V5KSB7CiAgICAgIChyZXMpLiRrZXkgPSBjb250ZW50SGFzaEtleTsKICAgIH0KICAgIHJldHVybiByZXMKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBiaW5kRHluYW1pY0tleXMgKGJhc2VPYmosIHZhbHVlcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgdmFyIGtleSA9IHZhbHVlc1tpXTsKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIGtleSkgewogICAgICAgIGJhc2VPYmpbdmFsdWVzW2ldXSA9IHZhbHVlc1tpICsgMV07CiAgICAgIH0gZWxzZSBpZiAoa2V5ICE9PSAnJyAmJiBrZXkgIT09IG51bGwpIHsKICAgICAgICAvLyBudWxsIGlzIGEgc3BlaWNhbCB2YWx1ZSBmb3IgZXhwbGljaXRseSByZW1vdmluZyBhIGJpbmRpbmcKICAgICAgICB3YXJuKAogICAgICAgICAgKCJJbnZhbGlkIHZhbHVlIGZvciBkeW5hbWljIGRpcmVjdGl2ZSBhcmd1bWVudCAoZXhwZWN0ZWQgc3RyaW5nIG9yIG51bGwpOiAiICsga2V5KSwKICAgICAgICAgIHRoaXMKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYmFzZU9iagogIH0KCiAgLy8gaGVscGVyIHRvIGR5bmFtaWNhbGx5IGFwcGVuZCBtb2RpZmllciBydW50aW1lIG1hcmtlcnMgdG8gZXZlbnQgbmFtZXMuCiAgLy8gZW5zdXJlIG9ubHkgYXBwZW5kIHdoZW4gdmFsdWUgaXMgYWxyZWFkeSBzdHJpbmcsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGNhc3QKICAvLyB0byBzdHJpbmcgYW5kIGNhdXNlIHRoZSB0eXBlIGNoZWNrIHRvIG1pc3MuCiAgZnVuY3Rpb24gcHJlcGVuZE1vZGlmaWVyICh2YWx1ZSwgc3ltYm9sKSB7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHN5bWJvbCArIHZhbHVlIDogdmFsdWUKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBpbnN0YWxsUmVuZGVySGVscGVycyAodGFyZ2V0KSB7CiAgICB0YXJnZXQuX28gPSBtYXJrT25jZTsKICAgIHRhcmdldC5fbiA9IHRvTnVtYmVyOwogICAgdGFyZ2V0Ll9zID0gdG9TdHJpbmc7CiAgICB0YXJnZXQuX2wgPSByZW5kZXJMaXN0OwogICAgdGFyZ2V0Ll90ID0gcmVuZGVyU2xvdDsKICAgIHRhcmdldC5fcSA9IGxvb3NlRXF1YWw7CiAgICB0YXJnZXQuX2kgPSBsb29zZUluZGV4T2Y7CiAgICB0YXJnZXQuX20gPSByZW5kZXJTdGF0aWM7CiAgICB0YXJnZXQuX2YgPSByZXNvbHZlRmlsdGVyOwogICAgdGFyZ2V0Ll9rID0gY2hlY2tLZXlDb2RlczsKICAgIHRhcmdldC5fYiA9IGJpbmRPYmplY3RQcm9wczsKICAgIHRhcmdldC5fdiA9IGNyZWF0ZVRleHRWTm9kZTsKICAgIHRhcmdldC5fZSA9IGNyZWF0ZUVtcHR5Vk5vZGU7CiAgICB0YXJnZXQuX3UgPSByZXNvbHZlU2NvcGVkU2xvdHM7CiAgICB0YXJnZXQuX2cgPSBiaW5kT2JqZWN0TGlzdGVuZXJzOwogICAgdGFyZ2V0Ll9kID0gYmluZER5bmFtaWNLZXlzOwogICAgdGFyZ2V0Ll9wID0gcHJlcGVuZE1vZGlmaWVyOwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0ICgKICAgIGRhdGEsCiAgICBwcm9wcywKICAgIGNoaWxkcmVuLAogICAgcGFyZW50LAogICAgQ3RvcgogICkgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgICAvLyBlbnN1cmUgdGhlIGNyZWF0ZUVsZW1lbnQgZnVuY3Rpb24gaW4gZnVuY3Rpb25hbCBjb21wb25lbnRzCiAgICAvLyBnZXRzIGEgdW5pcXVlIGNvbnRleHQgLSB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgY29ycmVjdCBuYW1lZCBzbG90IGNoZWNrCiAgICB2YXIgY29udGV4dFZtOwogICAgaWYgKGhhc093bihwYXJlbnQsICdfdWlkJykpIHsKICAgICAgY29udGV4dFZtID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQpOwogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgY29udGV4dFZtLl9vcmlnaW5hbCA9IHBhcmVudDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRoZSBjb250ZXh0IHZtIHBhc3NlZCBpbiBpcyBhIGZ1bmN0aW9uYWwgY29udGV4dCBhcyB3ZWxsLgogICAgICAvLyBpbiB0aGlzIGNhc2Ugd2Ugd2FudCB0byBtYWtlIHN1cmUgd2UgYXJlIGFibGUgdG8gZ2V0IGEgaG9sZCB0byB0aGUKICAgICAgLy8gcmVhbCBjb250ZXh0IGluc3RhbmNlLgogICAgICBjb250ZXh0Vm0gPSBwYXJlbnQ7CiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICBwYXJlbnQgPSBwYXJlbnQuX29yaWdpbmFsOwogICAgfQogICAgdmFyIGlzQ29tcGlsZWQgPSBpc1RydWUob3B0aW9ucy5fY29tcGlsZWQpOwogICAgdmFyIG5lZWROb3JtYWxpemF0aW9uID0gIWlzQ29tcGlsZWQ7CgogICAgdGhpcy5kYXRhID0gZGF0YTsKICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgdGhpcy5saXN0ZW5lcnMgPSBkYXRhLm9uIHx8IGVtcHR5T2JqZWN0OwogICAgdGhpcy5pbmplY3Rpb25zID0gcmVzb2x2ZUluamVjdChvcHRpb25zLmluamVjdCwgcGFyZW50KTsKICAgIHRoaXMuc2xvdHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcyQxLiRzbG90cykgewogICAgICAgIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKAogICAgICAgICAgZGF0YS5zY29wZWRTbG90cywKICAgICAgICAgIHRoaXMkMS4kc2xvdHMgPSByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIHBhcmVudCkKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzJDEuJHNsb3RzCiAgICB9OwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnc2NvcGVkU2xvdHMnLCAoewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCAoKSB7CiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMuc2xvdHMoKSkKICAgICAgfQogICAgfSkpOwoKICAgIC8vIHN1cHBvcnQgZm9yIGNvbXBpbGVkIGZ1bmN0aW9uYWwgdGVtcGxhdGUKICAgIGlmIChpc0NvbXBpbGVkKSB7CiAgICAgIC8vIGV4cG9zaW5nICRvcHRpb25zIGZvciByZW5kZXJTdGF0aWMoKQogICAgICB0aGlzLiRvcHRpb25zID0gb3B0aW9uczsKICAgICAgLy8gcHJlLXJlc29sdmUgc2xvdHMgZm9yIHJlbmRlclNsb3QoKQogICAgICB0aGlzLiRzbG90cyA9IHRoaXMuc2xvdHMoKTsKICAgICAgdGhpcy4kc2NvcGVkU2xvdHMgPSBub3JtYWxpemVTY29wZWRTbG90cyhkYXRhLnNjb3BlZFNsb3RzLCB0aGlzLiRzbG90cyk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuX3Njb3BlSWQpIHsKICAgICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgdmFyIHZub2RlID0gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKICAgICAgICBpZiAodm5vZGUgJiYgIUFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICAgICAgICB2bm9kZS5mblNjb3BlSWQgPSBvcHRpb25zLl9zY29wZUlkOwogICAgICAgICAgdm5vZGUuZm5Db250ZXh0ID0gcGFyZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm5vZGUKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgeyByZXR1cm4gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsgfTsKICAgIH0KICB9CgogIGluc3RhbGxSZW5kZXJIZWxwZXJzKEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0LnByb3RvdHlwZSk7CgogIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQgKAogICAgQ3RvciwKICAgIHByb3BzRGF0YSwKICAgIGRhdGEsCiAgICBjb250ZXh0Vm0sCiAgICBjaGlsZHJlbgogICkgewogICAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgICB2YXIgcHJvcHMgPSB7fTsKICAgIHZhciBwcm9wT3B0aW9ucyA9IG9wdGlvbnMucHJvcHM7CiAgICBpZiAoaXNEZWYocHJvcE9wdGlvbnMpKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICAgIHByb3BzW2tleV0gPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhIHx8IGVtcHR5T2JqZWN0KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGlzRGVmKGRhdGEuYXR0cnMpKSB7IG1lcmdlUHJvcHMocHJvcHMsIGRhdGEuYXR0cnMpOyB9CiAgICAgIGlmIChpc0RlZihkYXRhLnByb3BzKSkgeyBtZXJnZVByb3BzKHByb3BzLCBkYXRhLnByb3BzKTsgfQogICAgfQoKICAgIHZhciByZW5kZXJDb250ZXh0ID0gbmV3IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0KAogICAgICBkYXRhLAogICAgICBwcm9wcywKICAgICAgY2hpbGRyZW4sCiAgICAgIGNvbnRleHRWbSwKICAgICAgQ3RvcgogICAgKTsKCiAgICB2YXIgdm5vZGUgPSBvcHRpb25zLnJlbmRlci5jYWxsKG51bGwsIHJlbmRlckNvbnRleHQuX2MsIHJlbmRlckNvbnRleHQpOwoKICAgIGlmICh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICAgIHJldHVybiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCkKICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgICAgdmFyIHZub2RlcyA9IG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlKSB8fCBbXTsKICAgICAgdmFyIHJlcyA9IG5ldyBBcnJheSh2bm9kZXMubGVuZ3RoKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXNbaV0gPSBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2Rlc1tpXSwgZGF0YSwgcmVuZGVyQ29udGV4dC5wYXJlbnQsIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiByZXMKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNsb25lQW5kTWFya0Z1bmN0aW9uYWxSZXN1bHQgKHZub2RlLCBkYXRhLCBjb250ZXh0Vm0sIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpIHsKICAgIC8vICM3ODE3IGNsb25lIG5vZGUgYmVmb3JlIHNldHRpbmcgZm5Db250ZXh0LCBvdGhlcndpc2UgaWYgdGhlIG5vZGUgaXMgcmV1c2VkCiAgICAvLyAoZS5nLiBpdCB3YXMgZnJvbSBhIGNhY2hlZCBub3JtYWwgc2xvdCkgdGhlIGZuQ29udGV4dCBjYXVzZXMgbmFtZWQgc2xvdHMKICAgIC8vIHRoYXQgc2hvdWxkIG5vdCBiZSBtYXRjaGVkIHRvIG1hdGNoLgogICAgdmFyIGNsb25lID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICBjbG9uZS5mbkNvbnRleHQgPSBjb250ZXh0Vm07CiAgICBjbG9uZS5mbk9wdGlvbnMgPSBvcHRpb25zOwogICAgewogICAgICAoY2xvbmUuZGV2dG9vbHNNZXRhID0gY2xvbmUuZGV2dG9vbHNNZXRhIHx8IHt9KS5yZW5kZXJDb250ZXh0ID0gcmVuZGVyQ29udGV4dDsKICAgIH0KICAgIGlmIChkYXRhLnNsb3QpIHsKICAgICAgKGNsb25lLmRhdGEgfHwgKGNsb25lLmRhdGEgPSB7fSkpLnNsb3QgPSBkYXRhLnNsb3Q7CiAgICB9CiAgICByZXR1cm4gY2xvbmUKICB9CgogIGZ1bmN0aW9uIG1lcmdlUHJvcHMgKHRvLCBmcm9tKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gZnJvbSkgewogICAgICB0b1tjYW1lbGl6ZShrZXkpXSA9IGZyb21ba2V5XTsKICAgIH0KICB9CgogIC8qICAqLwoKICAvKiAgKi8KCiAgLyogICovCgogIC8qICAqLwoKICAvLyBpbmxpbmUgaG9va3MgdG8gYmUgaW52b2tlZCBvbiBjb21wb25lbnQgVk5vZGVzIGR1cmluZyBwYXRjaAogIHZhciBjb21wb25lbnRWTm9kZUhvb2tzID0gewogICAgaW5pdDogZnVuY3Rpb24gaW5pdCAodm5vZGUsIGh5ZHJhdGluZykgewogICAgICBpZiAoCiAgICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYKICAgICAgICAhdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX2lzRGVzdHJveWVkICYmCiAgICAgICAgdm5vZGUuZGF0YS5rZWVwQWxpdmUKICAgICAgKSB7CiAgICAgICAgLy8ga2VwdC1hbGl2ZSBjb21wb25lbnRzLCB0cmVhdCBhcyBhIHBhdGNoCiAgICAgICAgdmFyIG1vdW50ZWROb2RlID0gdm5vZGU7IC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgICAgICBjb21wb25lbnRWTm9kZUhvb2tzLnByZXBhdGNoKG1vdW50ZWROb2RlLCBtb3VudGVkTm9kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNoaWxkID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjcmVhdGVDb21wb25lbnRJbnN0YW5jZUZvclZub2RlKAogICAgICAgICAgdm5vZGUsCiAgICAgICAgICBhY3RpdmVJbnN0YW5jZQogICAgICAgICk7CiAgICAgICAgY2hpbGQuJG1vdW50KGh5ZHJhdGluZyA/IHZub2RlLmVsbSA6IHVuZGVmaW5lZCwgaHlkcmF0aW5nKTsKICAgICAgfQogICAgfSwKCiAgICBwcmVwYXRjaDogZnVuY3Rpb24gcHJlcGF0Y2ggKG9sZFZub2RlLCB2bm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICAgIHVwZGF0ZUNoaWxkQ29tcG9uZW50KAogICAgICAgIGNoaWxkLAogICAgICAgIG9wdGlvbnMucHJvcHNEYXRhLCAvLyB1cGRhdGVkIHByb3BzCiAgICAgICAgb3B0aW9ucy5saXN0ZW5lcnMsIC8vIHVwZGF0ZWQgbGlzdGVuZXJzCiAgICAgICAgdm5vZGUsIC8vIG5ldyBwYXJlbnQgdm5vZGUKICAgICAgICBvcHRpb25zLmNoaWxkcmVuIC8vIG5ldyBjaGlsZHJlbgogICAgICApOwogICAgfSwKCiAgICBpbnNlcnQ6IGZ1bmN0aW9uIGluc2VydCAodm5vZGUpIHsKICAgICAgdmFyIGNvbnRleHQgPSB2bm9kZS5jb250ZXh0OwogICAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkKSB7CiAgICAgICAgY29tcG9uZW50SW5zdGFuY2UuX2lzTW91bnRlZCA9IHRydWU7CiAgICAgICAgY2FsbEhvb2soY29tcG9uZW50SW5zdGFuY2UsICdtb3VudGVkJyk7CiAgICAgIH0KICAgICAgaWYgKHZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgaWYgKGNvbnRleHQuX2lzTW91bnRlZCkgewogICAgICAgICAgLy8gdnVlLXJvdXRlciMxMjEyCiAgICAgICAgICAvLyBEdXJpbmcgdXBkYXRlcywgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCdzIGNoaWxkIGNvbXBvbmVudHMgbWF5CiAgICAgICAgICAvLyBjaGFuZ2UsIHNvIGRpcmVjdGx5IHdhbGtpbmcgdGhlIHRyZWUgaGVyZSBtYXkgY2FsbCBhY3RpdmF0ZWQgaG9va3MKICAgICAgICAgIC8vIG9uIGluY29ycmVjdCBjaGlsZHJlbi4gSW5zdGVhZCB3ZSBwdXNoIHRoZW0gaW50byBhIHF1ZXVlIHdoaWNoIHdpbGwKICAgICAgICAgIC8vIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgd2hvbGUgcGF0Y2ggcHJvY2VzcyBlbmRlZC4KICAgICAgICAgIHF1ZXVlQWN0aXZhdGVkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZSAvKiBkaXJlY3QgKi8pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95ICh2bm9kZSkgewogICAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNEZXN0cm95ZWQpIHsKICAgICAgICBpZiAoIXZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgICBjb21wb25lbnRJbnN0YW5jZS4kZGVzdHJveSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UsIHRydWUgLyogZGlyZWN0ICovKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICB2YXIgaG9va3NUb01lcmdlID0gT2JqZWN0LmtleXMoY29tcG9uZW50Vk5vZGVIb29rcyk7CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudCAoCiAgICBDdG9yLAogICAgZGF0YSwKICAgIGNvbnRleHQsCiAgICBjaGlsZHJlbiwKICAgIHRhZwogICkgewogICAgaWYgKGlzVW5kZWYoQ3RvcikpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIGJhc2VDdG9yID0gY29udGV4dC4kb3B0aW9ucy5fYmFzZTsKCiAgICAvLyBwbGFpbiBvcHRpb25zIG9iamVjdDogdHVybiBpdCBpbnRvIGEgY29uc3RydWN0b3IKICAgIGlmIChpc09iamVjdChDdG9yKSkgewogICAgICBDdG9yID0gYmFzZUN0b3IuZXh0ZW5kKEN0b3IpOwogICAgfQoKICAgIC8vIGlmIGF0IHRoaXMgc3RhZ2UgaXQncyBub3QgYSBjb25zdHJ1Y3RvciBvciBhbiBhc3luYyBjb21wb25lbnQgZmFjdG9yeSwKICAgIC8vIHJlamVjdC4KICAgIGlmICh0eXBlb2YgQ3RvciAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB7CiAgICAgICAgd2FybigoIkludmFsaWQgQ29tcG9uZW50IGRlZmluaXRpb246ICIgKyAoU3RyaW5nKEN0b3IpKSksIGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGFzeW5jIGNvbXBvbmVudAogICAgdmFyIGFzeW5jRmFjdG9yeTsKICAgIGlmIChpc1VuZGVmKEN0b3IuY2lkKSkgewogICAgICBhc3luY0ZhY3RvcnkgPSBDdG9yOwogICAgICBDdG9yID0gcmVzb2x2ZUFzeW5jQ29tcG9uZW50KGFzeW5jRmFjdG9yeSwgYmFzZUN0b3IpOwogICAgICBpZiAoQ3RvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgbm9kZSBmb3IgYXN5bmMgY29tcG9uZW50LCB3aGljaCBpcyByZW5kZXJlZAogICAgICAgIC8vIGFzIGEgY29tbWVudCBub2RlIGJ1dCBwcmVzZXJ2ZXMgYWxsIHRoZSByYXcgaW5mb3JtYXRpb24gZm9yIHRoZSBub2RlLgogICAgICAgIC8vIHRoZSBpbmZvcm1hdGlvbiB3aWxsIGJlIHVzZWQgZm9yIGFzeW5jIHNlcnZlci1yZW5kZXJpbmcgYW5kIGh5ZHJhdGlvbi4KICAgICAgICByZXR1cm4gY3JlYXRlQXN5bmNQbGFjZWhvbGRlcigKICAgICAgICAgIGFzeW5jRmFjdG9yeSwKICAgICAgICAgIGRhdGEsCiAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgICB0YWcKICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICBkYXRhID0gZGF0YSB8fCB7fTsKCiAgICAvLyByZXNvbHZlIGNvbnN0cnVjdG9yIG9wdGlvbnMgaW4gY2FzZSBnbG9iYWwgbWl4aW5zIGFyZSBhcHBsaWVkIGFmdGVyCiAgICAvLyBjb21wb25lbnQgY29uc3RydWN0b3IgY3JlYXRpb24KICAgIHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMoQ3Rvcik7CgogICAgLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGRhdGEgaW50byBwcm9wcyAmIGV2ZW50cwogICAgaWYgKGlzRGVmKGRhdGEubW9kZWwpKSB7CiAgICAgIHRyYW5zZm9ybU1vZGVsKEN0b3Iub3B0aW9ucywgZGF0YSk7CiAgICB9CgogICAgLy8gZXh0cmFjdCBwcm9wcwogICAgdmFyIHByb3BzRGF0YSA9IGV4dHJhY3RQcm9wc0Zyb21WTm9kZURhdGEoZGF0YSwgQ3RvciwgdGFnKTsKCiAgICAvLyBmdW5jdGlvbmFsIGNvbXBvbmVudAogICAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnMuZnVuY3Rpb25hbCkpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbikKICAgIH0KCiAgICAvLyBleHRyYWN0IGxpc3RlbmVycywgc2luY2UgdGhlc2UgbmVlZHMgdG8gYmUgdHJlYXRlZCBhcwogICAgLy8gY2hpbGQgY29tcG9uZW50IGxpc3RlbmVycyBpbnN0ZWFkIG9mIERPTSBsaXN0ZW5lcnMKICAgIHZhciBsaXN0ZW5lcnMgPSBkYXRhLm9uOwogICAgLy8gcmVwbGFjZSB3aXRoIGxpc3RlbmVycyB3aXRoIC5uYXRpdmUgbW9kaWZpZXIKICAgIC8vIHNvIGl0IGdldHMgcHJvY2Vzc2VkIGR1cmluZyBwYXJlbnQgY29tcG9uZW50IHBhdGNoLgogICAgZGF0YS5vbiA9IGRhdGEubmF0aXZlT247CgogICAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnMuYWJzdHJhY3QpKSB7CiAgICAgIC8vIGFic3RyYWN0IGNvbXBvbmVudHMgZG8gbm90IGtlZXAgYW55dGhpbmcKICAgICAgLy8gb3RoZXIgdGhhbiBwcm9wcyAmIGxpc3RlbmVycyAmIHNsb3QKCiAgICAgIC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgICAgdmFyIHNsb3QgPSBkYXRhLnNsb3Q7CiAgICAgIGRhdGEgPSB7fTsKICAgICAgaWYgKHNsb3QpIHsKICAgICAgICBkYXRhLnNsb3QgPSBzbG90OwogICAgICB9CiAgICB9CgogICAgLy8gaW5zdGFsbCBjb21wb25lbnQgbWFuYWdlbWVudCBob29rcyBvbnRvIHRoZSBwbGFjZWhvbGRlciBub2RlCiAgICBpbnN0YWxsQ29tcG9uZW50SG9va3MoZGF0YSk7CgogICAgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgdm5vZGUKICAgIHZhciBuYW1lID0gQ3Rvci5vcHRpb25zLm5hbWUgfHwgdGFnOwogICAgdmFyIHZub2RlID0gbmV3IFZOb2RlKAogICAgICAoInZ1ZS1jb21wb25lbnQtIiArIChDdG9yLmNpZCkgKyAobmFtZSA/ICgiLSIgKyBuYW1lKSA6ICcnKSksCiAgICAgIGRhdGEsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQsCiAgICAgIHsgQ3RvcjogQ3RvciwgcHJvcHNEYXRhOiBwcm9wc0RhdGEsIGxpc3RlbmVyczogbGlzdGVuZXJzLCB0YWc6IHRhZywgY2hpbGRyZW46IGNoaWxkcmVuIH0sCiAgICAgIGFzeW5jRmFjdG9yeQogICAgKTsKCiAgICByZXR1cm4gdm5vZGUKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlRm9yVm5vZGUgKAogICAgdm5vZGUsIC8vIHdlIGtub3cgaXQncyBNb3VudGVkQ29tcG9uZW50Vk5vZGUgYnV0IGZsb3cgZG9lc24ndAogICAgcGFyZW50IC8vIGFjdGl2ZUluc3RhbmNlIGluIGxpZmVjeWNsZSBzdGF0ZQogICkgewogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIF9pc0NvbXBvbmVudDogdHJ1ZSwKICAgICAgX3BhcmVudFZub2RlOiB2bm9kZSwKICAgICAgcGFyZW50OiBwYXJlbnQKICAgIH07CiAgICAvLyBjaGVjayBpbmxpbmUtdGVtcGxhdGUgcmVuZGVyIGZ1bmN0aW9ucwogICAgdmFyIGlubGluZVRlbXBsYXRlID0gdm5vZGUuZGF0YS5pbmxpbmVUZW1wbGF0ZTsKICAgIGlmIChpc0RlZihpbmxpbmVUZW1wbGF0ZSkpIHsKICAgICAgb3B0aW9ucy5yZW5kZXIgPSBpbmxpbmVUZW1wbGF0ZS5yZW5kZXI7CiAgICAgIG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zID0gaW5saW5lVGVtcGxhdGUuc3RhdGljUmVuZGVyRm5zOwogICAgfQogICAgcmV0dXJuIG5ldyB2bm9kZS5jb21wb25lbnRPcHRpb25zLkN0b3Iob3B0aW9ucykKICB9CgogIGZ1bmN0aW9uIGluc3RhbGxDb21wb25lbnRIb29rcyAoZGF0YSkgewogICAgdmFyIGhvb2tzID0gZGF0YS5ob29rIHx8IChkYXRhLmhvb2sgPSB7fSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzVG9NZXJnZS5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0gaG9va3NUb01lcmdlW2ldOwogICAgICB2YXIgZXhpc3RpbmcgPSBob29rc1trZXldOwogICAgICB2YXIgdG9NZXJnZSA9IGNvbXBvbmVudFZOb2RlSG9va3Nba2V5XTsKICAgICAgaWYgKGV4aXN0aW5nICE9PSB0b01lcmdlICYmICEoZXhpc3RpbmcgJiYgZXhpc3RpbmcuX21lcmdlZCkpIHsKICAgICAgICBob29rc1trZXldID0gZXhpc3RpbmcgPyBtZXJnZUhvb2skMSh0b01lcmdlLCBleGlzdGluZykgOiB0b01lcmdlOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBtZXJnZUhvb2skMSAoZjEsIGYyKSB7CiAgICB2YXIgbWVyZ2VkID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgLy8gZmxvdyBjb21wbGFpbnMgYWJvdXQgZXh0cmEgYXJncyB3aGljaCBpcyB3aHkgd2UgdXNlIGFueQogICAgICBmMShhLCBiKTsKICAgICAgZjIoYSwgYik7CiAgICB9OwogICAgbWVyZ2VkLl9tZXJnZWQgPSB0cnVlOwogICAgcmV0dXJuIG1lcmdlZAogIH0KCiAgLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGluZm8gKHZhbHVlIGFuZCBjYWxsYmFjaykgaW50bwogIC8vIHByb3AgYW5kIGV2ZW50IGhhbmRsZXIgcmVzcGVjdGl2ZWx5LgogIGZ1bmN0aW9uIHRyYW5zZm9ybU1vZGVsIChvcHRpb25zLCBkYXRhKSB7CiAgICB2YXIgcHJvcCA9IChvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwucHJvcCkgfHwgJ3ZhbHVlJzsKICAgIHZhciBldmVudCA9IChvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwuZXZlbnQpIHx8ICdpbnB1dCcKICAgIDsoZGF0YS5hdHRycyB8fCAoZGF0YS5hdHRycyA9IHt9KSlbcHJvcF0gPSBkYXRhLm1vZGVsLnZhbHVlOwogICAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKICAgIHZhciBleGlzdGluZyA9IG9uW2V2ZW50XTsKICAgIHZhciBjYWxsYmFjayA9IGRhdGEubW9kZWwuY2FsbGJhY2s7CiAgICBpZiAoaXNEZWYoZXhpc3RpbmcpKSB7CiAgICAgIGlmICgKICAgICAgICBBcnJheS5pc0FycmF5KGV4aXN0aW5nKQogICAgICAgICAgPyBleGlzdGluZy5pbmRleE9mKGNhbGxiYWNrKSA9PT0gLTEKICAgICAgICAgIDogZXhpc3RpbmcgIT09IGNhbGxiYWNrCiAgICAgICkgewogICAgICAgIG9uW2V2ZW50XSA9IFtjYWxsYmFja10uY29uY2F0KGV4aXN0aW5nKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgb25bZXZlbnRdID0gY2FsbGJhY2s7CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgdmFyIFNJTVBMRV9OT1JNQUxJWkUgPSAxOwogIHZhciBBTFdBWVNfTk9STUFMSVpFID0gMjsKCiAgLy8gd3JhcHBlciBmdW5jdGlvbiBmb3IgcHJvdmlkaW5nIGEgbW9yZSBmbGV4aWJsZSBpbnRlcmZhY2UKICAvLyB3aXRob3V0IGdldHRpbmcgeWVsbGVkIGF0IGJ5IGZsb3cKICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50ICgKICAgIGNvbnRleHQsCiAgICB0YWcsCiAgICBkYXRhLAogICAgY2hpbGRyZW4sCiAgICBub3JtYWxpemF0aW9uVHlwZSwKICAgIGFsd2F5c05vcm1hbGl6ZQogICkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkgfHwgaXNQcmltaXRpdmUoZGF0YSkpIHsKICAgICAgbm9ybWFsaXphdGlvblR5cGUgPSBjaGlsZHJlbjsKICAgICAgY2hpbGRyZW4gPSBkYXRhOwogICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgfQogICAgaWYgKGlzVHJ1ZShhbHdheXNOb3JtYWxpemUpKSB7CiAgICAgIG5vcm1hbGl6YXRpb25UeXBlID0gQUxXQVlTX05PUk1BTElaRTsKICAgIH0KICAgIHJldHVybiBfY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSkKICB9CgogIGZ1bmN0aW9uIF9jcmVhdGVFbGVtZW50ICgKICAgIGNvbnRleHQsCiAgICB0YWcsCiAgICBkYXRhLAogICAgY2hpbGRyZW4sCiAgICBub3JtYWxpemF0aW9uVHlwZQogICkgewogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKChkYXRhKS5fX29iX18pKSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkF2b2lkIHVzaW5nIG9ic2VydmVkIGRhdGEgb2JqZWN0IGFzIHZub2RlIGRhdGE6ICIgKyAoSlNPTi5zdHJpbmdpZnkoZGF0YSkpICsgIlxuIiArCiAgICAgICAgJ0Fsd2F5cyBjcmVhdGUgZnJlc2ggdm5vZGUgZGF0YSBvYmplY3RzIGluIGVhY2ggcmVuZGVyIScsCiAgICAgICAgY29udGV4dAogICAgICApOwogICAgICByZXR1cm4gY3JlYXRlRW1wdHlWTm9kZSgpCiAgICB9CiAgICAvLyBvYmplY3Qgc3ludGF4IGluIHYtYmluZAogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuaXMpKSB7CiAgICAgIHRhZyA9IGRhdGEuaXM7CiAgICB9CiAgICBpZiAoIXRhZykgewogICAgICAvLyBpbiBjYXNlIG9mIGNvbXBvbmVudCA6aXMgc2V0IHRvIGZhbHN5IHZhbHVlCiAgICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCkKICAgIH0KICAgIC8vIHdhcm4gYWdhaW5zdCBub24tcHJpbWl0aXZlIGtleQogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEua2V5KSAmJiAhaXNQcmltaXRpdmUoZGF0YS5rZXkpCiAgICApIHsKICAgICAgewogICAgICAgIHdhcm4oCiAgICAgICAgICAnQXZvaWQgdXNpbmcgbm9uLXByaW1pdGl2ZSB2YWx1ZSBhcyBrZXksICcgKwogICAgICAgICAgJ3VzZSBzdHJpbmcvbnVtYmVyIHZhbHVlIGluc3RlYWQuJywKICAgICAgICAgIGNvbnRleHQKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICAvLyBzdXBwb3J0IHNpbmdsZSBmdW5jdGlvbiBjaGlsZHJlbiBhcyBkZWZhdWx0IHNjb3BlZCBzbG90CiAgICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikgJiYKICAgICAgdHlwZW9mIGNoaWxkcmVuWzBdID09PSAnZnVuY3Rpb24nCiAgICApIHsKICAgICAgZGF0YSA9IGRhdGEgfHwge307CiAgICAgIGRhdGEuc2NvcGVkU2xvdHMgPSB7IGRlZmF1bHQ6IGNoaWxkcmVuWzBdIH07CiAgICAgIGNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICB9CiAgICBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IEFMV0FZU19OT1JNQUxJWkUpIHsKICAgICAgY2hpbGRyZW4gPSBub3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbik7CiAgICB9IGVsc2UgaWYgKG5vcm1hbGl6YXRpb25UeXBlID09PSBTSU1QTEVfTk9STUFMSVpFKSB7CiAgICAgIGNoaWxkcmVuID0gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogICAgfQogICAgdmFyIHZub2RlLCBuczsKICAgIGlmICh0eXBlb2YgdGFnID09PSAnc3RyaW5nJykgewogICAgICB2YXIgQ3RvcjsKICAgICAgbnMgPSAoY29udGV4dC4kdm5vZGUgJiYgY29udGV4dC4kdm5vZGUubnMpIHx8IGNvbmZpZy5nZXRUYWdOYW1lc3BhY2UodGFnKTsKICAgICAgaWYgKGNvbmZpZy5pc1Jlc2VydmVkVGFnKHRhZykpIHsKICAgICAgICAvLyBwbGF0Zm9ybSBidWlsdC1pbiBlbGVtZW50cwogICAgICAgIHZub2RlID0gbmV3IFZOb2RlKAogICAgICAgICAgY29uZmlnLnBhcnNlUGxhdGZvcm1UYWdOYW1lKHRhZyksIGRhdGEsIGNoaWxkcmVuLAogICAgICAgICAgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKCghZGF0YSB8fCAhZGF0YS5wcmUpICYmIGlzRGVmKEN0b3IgPSByZXNvbHZlQXNzZXQoY29udGV4dC4kb3B0aW9ucywgJ2NvbXBvbmVudHMnLCB0YWcpKSkgewogICAgICAgIC8vIGNvbXBvbmVudAogICAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHVua25vd24gb3IgdW5saXN0ZWQgbmFtZXNwYWNlZCBlbGVtZW50cwogICAgICAgIC8vIGNoZWNrIGF0IHJ1bnRpbWUgYmVjYXVzZSBpdCBtYXkgZ2V0IGFzc2lnbmVkIGEgbmFtZXNwYWNlIHdoZW4gaXRzCiAgICAgICAgLy8gcGFyZW50IG5vcm1hbGl6ZXMgY2hpbGRyZW4KICAgICAgICB2bm9kZSA9IG5ldyBWTm9kZSgKICAgICAgICAgIHRhZywgZGF0YSwgY2hpbGRyZW4sCiAgICAgICAgICB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGV4dAogICAgICAgICk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIGRpcmVjdCBjb21wb25lbnQgb3B0aW9ucyAvIGNvbnN0cnVjdG9yCiAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KHRhZywgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICAgIHJldHVybiB2bm9kZQogICAgfSBlbHNlIGlmIChpc0RlZih2bm9kZSkpIHsKICAgICAgaWYgKGlzRGVmKG5zKSkgeyBhcHBseU5TKHZub2RlLCBucyk7IH0KICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7IHJlZ2lzdGVyRGVlcEJpbmRpbmdzKGRhdGEpOyB9CiAgICAgIHJldHVybiB2bm9kZQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKQogICAgfQogIH0KCiAgZnVuY3Rpb24gYXBwbHlOUyAodm5vZGUsIG5zLCBmb3JjZSkgewogICAgdm5vZGUubnMgPSBuczsKICAgIGlmICh2bm9kZS50YWcgPT09ICdmb3JlaWduT2JqZWN0JykgewogICAgICAvLyB1c2UgZGVmYXVsdCBuYW1lc3BhY2UgaW5zaWRlIGZvcmVpZ25PYmplY3QKICAgICAgbnMgPSB1bmRlZmluZWQ7CiAgICAgIGZvcmNlID0gdHJ1ZTsKICAgIH0KICAgIGlmIChpc0RlZih2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2bm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jaGlsZHJlbltpXTsKICAgICAgICBpZiAoaXNEZWYoY2hpbGQudGFnKSAmJiAoCiAgICAgICAgICBpc1VuZGVmKGNoaWxkLm5zKSB8fCAoaXNUcnVlKGZvcmNlKSAmJiBjaGlsZC50YWcgIT09ICdzdmcnKSkpIHsKICAgICAgICAgIGFwcGx5TlMoY2hpbGQsIG5zLCBmb3JjZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICAvLyByZWYgIzUzMTgKICAvLyBuZWNlc3NhcnkgdG8gZW5zdXJlIHBhcmVudCByZS1yZW5kZXIgd2hlbiBkZWVwIGJpbmRpbmdzIGxpa2UgOnN0eWxlIGFuZAogIC8vIDpjbGFzcyBhcmUgdXNlZCBvbiBzbG90IG5vZGVzCiAgZnVuY3Rpb24gcmVnaXN0ZXJEZWVwQmluZGluZ3MgKGRhdGEpIHsKICAgIGlmIChpc09iamVjdChkYXRhLnN0eWxlKSkgewogICAgICB0cmF2ZXJzZShkYXRhLnN0eWxlKTsKICAgIH0KICAgIGlmIChpc09iamVjdChkYXRhLmNsYXNzKSkgewogICAgICB0cmF2ZXJzZShkYXRhLmNsYXNzKTsKICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBpbml0UmVuZGVyICh2bSkgewogICAgdm0uX3Zub2RlID0gbnVsbDsgLy8gdGhlIHJvb3Qgb2YgdGhlIGNoaWxkIHRyZWUKICAgIHZtLl9zdGF0aWNUcmVlcyA9IG51bGw7IC8vIHYtb25jZSBjYWNoZWQgdHJlZXMKICAgIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CiAgICB2YXIgcGFyZW50Vm5vZGUgPSB2bS4kdm5vZGUgPSBvcHRpb25zLl9wYXJlbnRWbm9kZTsgLy8gdGhlIHBsYWNlaG9sZGVyIG5vZGUgaW4gcGFyZW50IHRyZWUKICAgIHZhciByZW5kZXJDb250ZXh0ID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuY29udGV4dDsKICAgIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiwgcmVuZGVyQ29udGV4dCk7CiAgICB2bS4kc2NvcGVkU2xvdHMgPSBlbXB0eU9iamVjdDsKICAgIC8vIGJpbmQgdGhlIGNyZWF0ZUVsZW1lbnQgZm4gdG8gdGhpcyBpbnN0YW5jZQogICAgLy8gc28gdGhhdCB3ZSBnZXQgcHJvcGVyIHJlbmRlciBjb250ZXh0IGluc2lkZSBpdC4KICAgIC8vIGFyZ3Mgb3JkZXI6IHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlLCBhbHdheXNOb3JtYWxpemUKICAgIC8vIGludGVybmFsIHZlcnNpb24gaXMgdXNlZCBieSByZW5kZXIgZnVuY3Rpb25zIGNvbXBpbGVkIGZyb20gdGVtcGxhdGVzCiAgICB2bS5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7IHJldHVybiBjcmVhdGVFbGVtZW50KHZtLCBhLCBiLCBjLCBkLCBmYWxzZSk7IH07CiAgICAvLyBub3JtYWxpemF0aW9uIGlzIGFsd2F5cyBhcHBsaWVkIGZvciB0aGUgcHVibGljIHZlcnNpb24sIHVzZWQgaW4KICAgIC8vIHVzZXItd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zLgogICAgdm0uJGNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgeyByZXR1cm4gY3JlYXRlRWxlbWVudCh2bSwgYSwgYiwgYywgZCwgdHJ1ZSk7IH07CgogICAgLy8gJGF0dHJzICYgJGxpc3RlbmVycyBhcmUgZXhwb3NlZCBmb3IgZWFzaWVyIEhPQyBjcmVhdGlvbi4KICAgIC8vIHRoZXkgbmVlZCB0byBiZSByZWFjdGl2ZSBzbyB0aGF0IEhPQ3MgdXNpbmcgdGhlbSBhcmUgYWx3YXlzIHVwZGF0ZWQKICAgIHZhciBwYXJlbnREYXRhID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuZGF0YTsKCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgewogICAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRhdHRycycsIHBhcmVudERhdGEgJiYgcGFyZW50RGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGF0dHJzIGlzIHJlYWRvbmx5LiIsIHZtKTsKICAgICAgfSwgdHJ1ZSk7CiAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGxpc3RlbmVycycsIG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGxpc3RlbmVycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICAgIH0sIHRydWUpOwogICAgfQogIH0KCiAgdmFyIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CgogIGZ1bmN0aW9uIHJlbmRlck1peGluIChWdWUpIHsKICAgIC8vIGluc3RhbGwgcnVudGltZSBjb252ZW5pZW5jZSBoZWxwZXJzCiAgICBpbnN0YWxsUmVuZGVySGVscGVycyhWdWUucHJvdG90eXBlKTsKCiAgICBWdWUucHJvdG90eXBlLiRuZXh0VGljayA9IGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gbmV4dFRpY2soZm4sIHRoaXMpCiAgICB9OwoKICAgIFZ1ZS5wcm90b3R5cGUuX3JlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgdmFyIHJlZiA9IHZtLiRvcHRpb25zOwogICAgICB2YXIgcmVuZGVyID0gcmVmLnJlbmRlcjsKICAgICAgdmFyIF9wYXJlbnRWbm9kZSA9IHJlZi5fcGFyZW50Vm5vZGU7CgogICAgICBpZiAoX3BhcmVudFZub2RlKSB7CiAgICAgICAgdm0uJHNjb3BlZFNsb3RzID0gbm9ybWFsaXplU2NvcGVkU2xvdHMoCiAgICAgICAgICBfcGFyZW50Vm5vZGUuZGF0YS5zY29wZWRTbG90cywKICAgICAgICAgIHZtLiRzbG90cywKICAgICAgICAgIHZtLiRzY29wZWRTbG90cwogICAgICAgICk7CiAgICAgIH0KCiAgICAgIC8vIHNldCBwYXJlbnQgdm5vZGUuIHRoaXMgYWxsb3dzIHJlbmRlciBmdW5jdGlvbnMgdG8gaGF2ZSBhY2Nlc3MKICAgICAgLy8gdG8gdGhlIGRhdGEgb24gdGhlIHBsYWNlaG9sZGVyIG5vZGUuCiAgICAgIHZtLiR2bm9kZSA9IF9wYXJlbnRWbm9kZTsKICAgICAgLy8gcmVuZGVyIHNlbGYKICAgICAgdmFyIHZub2RlOwogICAgICB0cnkgewogICAgICAgIC8vIFRoZXJlJ3Mgbm8gbmVlZCB0byBtYWludGFpbiBhIHN0YWNrIGJlY2F1ZXMgYWxsIHJlbmRlciBmbnMgYXJlIGNhbGxlZAogICAgICAgIC8vIHNlcGFyYXRlbHkgZnJvbSBvbmUgYW5vdGhlci4gTmVzdGVkIGNvbXBvbmVudCdzIHJlbmRlciBmbnMgYXJlIGNhbGxlZAogICAgICAgIC8vIHdoZW4gcGFyZW50IGNvbXBvbmVudCBpcyBwYXRjaGVkLgogICAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IHZtOwogICAgICAgIHZub2RlID0gcmVuZGVyLmNhbGwodm0uX3JlbmRlclByb3h5LCB2bS4kY3JlYXRlRWxlbWVudCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBoYW5kbGVFcnJvcihlLCB2bSwgInJlbmRlciIpOwogICAgICAgIC8vIHJldHVybiBlcnJvciByZW5kZXIgcmVzdWx0LAogICAgICAgIC8vIG9yIHByZXZpb3VzIHZub2RlIHRvIHByZXZlbnQgcmVuZGVyIGVycm9yIGNhdXNpbmcgYmxhbmsgY29tcG9uZW50CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgICAgICBpZiAodm0uJG9wdGlvbnMucmVuZGVyRXJyb3IpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZub2RlID0gdm0uJG9wdGlvbnMucmVuZGVyRXJyb3IuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50LCBlKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJyZW5kZXJFcnJvciIpOwogICAgICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdm5vZGUgPSB2bS5fdm5vZGU7CiAgICAgICAgfQogICAgICB9IGZpbmFsbHkgewogICAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CiAgICAgIH0KICAgICAgLy8gaWYgdGhlIHJldHVybmVkIGFycmF5IGNvbnRhaW5zIG9ubHkgYSBzaW5nbGUgbm9kZSwgYWxsb3cgaXQKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpICYmIHZub2RlLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZub2RlID0gdm5vZGVbMF07CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIGVtcHR5IHZub2RlIGluIGNhc2UgdGhlIHJlbmRlciBmdW5jdGlvbiBlcnJvcmVkIG91dAogICAgICBpZiAoISh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgJ011bHRpcGxlIHJvb3Qgbm9kZXMgcmV0dXJuZWQgZnJvbSByZW5kZXIgZnVuY3Rpb24uIFJlbmRlciBmdW5jdGlvbiAnICsKICAgICAgICAgICAgJ3Nob3VsZCByZXR1cm4gYSBzaW5nbGUgcm9vdCBub2RlLicsCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB2bm9kZSA9IGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICAgICAgfQogICAgICAvLyBzZXQgcGFyZW50CiAgICAgIHZub2RlLnBhcmVudCA9IF9wYXJlbnRWbm9kZTsKICAgICAgcmV0dXJuIHZub2RlCiAgICB9OwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGVuc3VyZUN0b3IgKGNvbXAsIGJhc2UpIHsKICAgIGlmICgKICAgICAgY29tcC5fX2VzTW9kdWxlIHx8CiAgICAgIChoYXNTeW1ib2wgJiYgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnTW9kdWxlJykKICAgICkgewogICAgICBjb21wID0gY29tcC5kZWZhdWx0OwogICAgfQogICAgcmV0dXJuIGlzT2JqZWN0KGNvbXApCiAgICAgID8gYmFzZS5leHRlbmQoY29tcCkKICAgICAgOiBjb21wCiAgfQoKICBmdW5jdGlvbiBjcmVhdGVBc3luY1BsYWNlaG9sZGVyICgKICAgIGZhY3RvcnksCiAgICBkYXRhLAogICAgY29udGV4dCwKICAgIGNoaWxkcmVuLAogICAgdGFnCiAgKSB7CiAgICB2YXIgbm9kZSA9IGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICAgIG5vZGUuYXN5bmNGYWN0b3J5ID0gZmFjdG9yeTsKICAgIG5vZGUuYXN5bmNNZXRhID0geyBkYXRhOiBkYXRhLCBjb250ZXh0OiBjb250ZXh0LCBjaGlsZHJlbjogY2hpbGRyZW4sIHRhZzogdGFnIH07CiAgICByZXR1cm4gbm9kZQogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZUFzeW5jQ29tcG9uZW50ICgKICAgIGZhY3RvcnksCiAgICBiYXNlQ3RvcgogICkgewogICAgaWYgKGlzVHJ1ZShmYWN0b3J5LmVycm9yKSAmJiBpc0RlZihmYWN0b3J5LmVycm9yQ29tcCkpIHsKICAgICAgcmV0dXJuIGZhY3RvcnkuZXJyb3JDb21wCiAgICB9CgogICAgaWYgKGlzRGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgIHJldHVybiBmYWN0b3J5LnJlc29sdmVkCiAgICB9CgogICAgdmFyIG93bmVyID0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlOwogICAgaWYgKG93bmVyICYmIGlzRGVmKGZhY3Rvcnkub3duZXJzKSAmJiBmYWN0b3J5Lm93bmVycy5pbmRleE9mKG93bmVyKSA9PT0gLTEpIHsKICAgICAgLy8gYWxyZWFkeSBwZW5kaW5nCiAgICAgIGZhY3Rvcnkub3duZXJzLnB1c2gob3duZXIpOwogICAgfQoKICAgIGlmIChpc1RydWUoZmFjdG9yeS5sb2FkaW5nKSAmJiBpc0RlZihmYWN0b3J5LmxvYWRpbmdDb21wKSkgewogICAgICByZXR1cm4gZmFjdG9yeS5sb2FkaW5nQ29tcAogICAgfQoKICAgIGlmIChvd25lciAmJiAhaXNEZWYoZmFjdG9yeS5vd25lcnMpKSB7CiAgICAgIHZhciBvd25lcnMgPSBmYWN0b3J5Lm93bmVycyA9IFtvd25lcl07CiAgICAgIHZhciBzeW5jID0gdHJ1ZTsKICAgICAgdmFyIHRpbWVyTG9hZGluZyA9IG51bGw7CiAgICAgIHZhciB0aW1lclRpbWVvdXQgPSBudWxsCgogICAgICA7KG93bmVyKS4kb24oJ2hvb2s6ZGVzdHJveWVkJywgZnVuY3Rpb24gKCkgeyByZXR1cm4gcmVtb3ZlKG93bmVycywgb3duZXIpOyB9KTsKCiAgICAgIHZhciBmb3JjZVJlbmRlciA9IGZ1bmN0aW9uIChyZW5kZXJDb21wbGV0ZWQpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG93bmVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIChvd25lcnNbaV0pLiRmb3JjZVVwZGF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlbmRlckNvbXBsZXRlZCkgewogICAgICAgICAgb3duZXJzLmxlbmd0aCA9IDA7CiAgICAgICAgICBpZiAodGltZXJMb2FkaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lckxvYWRpbmcpOwogICAgICAgICAgICB0aW1lckxvYWRpbmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRpbWVyVGltZW91dCAhPT0gbnVsbCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJUaW1lb3V0KTsKICAgICAgICAgICAgdGltZXJUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgcmVzb2x2ZSA9IG9uY2UoZnVuY3Rpb24gKHJlcykgewogICAgICAgIC8vIGNhY2hlIHJlc29sdmVkCiAgICAgICAgZmFjdG9yeS5yZXNvbHZlZCA9IGVuc3VyZUN0b3IocmVzLCBiYXNlQ3Rvcik7CiAgICAgICAgLy8gaW52b2tlIGNhbGxiYWNrcyBvbmx5IGlmIHRoaXMgaXMgbm90IGEgc3luY2hyb25vdXMgcmVzb2x2ZQogICAgICAgIC8vIChhc3luYyByZXNvbHZlcyBhcmUgc2hpbW1lZCBhcyBzeW5jaHJvbm91cyBkdXJpbmcgU1NSKQogICAgICAgIGlmICghc3luYykgewogICAgICAgICAgZm9yY2VSZW5kZXIodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG93bmVycy5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB2YXIgcmVqZWN0ID0gb25jZShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICJGYWlsZWQgdG8gcmVzb2x2ZSBhc3luYyBjb21wb25lbnQ6ICIgKyAoU3RyaW5nKGZhY3RvcnkpKSArCiAgICAgICAgICAocmVhc29uID8gKCJcblJlYXNvbjogIiArIHJlYXNvbikgOiAnJykKICAgICAgICApOwogICAgICAgIGlmIChpc0RlZihmYWN0b3J5LmVycm9yQ29tcCkpIHsKICAgICAgICAgIGZhY3RvcnkuZXJyb3IgPSB0cnVlOwogICAgICAgICAgZm9yY2VSZW5kZXIodHJ1ZSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHZhciByZXMgPSBmYWN0b3J5KHJlc29sdmUsIHJlamVjdCk7CgogICAgICBpZiAoaXNPYmplY3QocmVzKSkgewogICAgICAgIGlmIChpc1Byb21pc2UocmVzKSkgewogICAgICAgICAgLy8gKCkgPT4gUHJvbWlzZQogICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICAgICAgcmVzLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzUHJvbWlzZShyZXMuY29tcG9uZW50KSkgewogICAgICAgICAgcmVzLmNvbXBvbmVudC50aGVuKHJlc29sdmUsIHJlamVjdCk7CgogICAgICAgICAgaWYgKGlzRGVmKHJlcy5lcnJvcikpIHsKICAgICAgICAgICAgZmFjdG9yeS5lcnJvckNvbXAgPSBlbnN1cmVDdG9yKHJlcy5lcnJvciwgYmFzZUN0b3IpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc0RlZihyZXMubG9hZGluZykpIHsKICAgICAgICAgICAgZmFjdG9yeS5sb2FkaW5nQ29tcCA9IGVuc3VyZUN0b3IocmVzLmxvYWRpbmcsIGJhc2VDdG9yKTsKICAgICAgICAgICAgaWYgKHJlcy5kZWxheSA9PT0gMCkgewogICAgICAgICAgICAgIGZhY3RvcnkubG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGltZXJMb2FkaW5nID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aW1lckxvYWRpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkgJiYgaXNVbmRlZihmYWN0b3J5LmVycm9yKSkgewogICAgICAgICAgICAgICAgICBmYWN0b3J5LmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICBmb3JjZVJlbmRlcihmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwgcmVzLmRlbGF5IHx8IDIwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNEZWYocmVzLnRpbWVvdXQpKSB7CiAgICAgICAgICAgIHRpbWVyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHRpbWVyVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICAgICAgICAgIHJlamVjdCgKICAgICAgICAgICAgICAgICAgInRpbWVvdXQgKCIgKyAocmVzLnRpbWVvdXQpICsgIm1zKSIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCByZXMudGltZW91dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBzeW5jID0gZmFsc2U7CiAgICAgIC8vIHJldHVybiBpbiBjYXNlIHJlc29sdmVkIHN5bmNocm9ub3VzbHkKICAgICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZwogICAgICAgID8gZmFjdG9yeS5sb2FkaW5nQ29tcAogICAgICAgIDogZmFjdG9yeS5yZXNvbHZlZAogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGlzQXN5bmNQbGFjZWhvbGRlciAobm9kZSkgewogICAgcmV0dXJuIG5vZGUuaXNDb21tZW50ICYmIG5vZGUuYXN5bmNGYWN0b3J5CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gZ2V0Rmlyc3RDb21wb25lbnRDaGlsZCAoY2hpbGRyZW4pIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGMgPSBjaGlsZHJlbltpXTsKICAgICAgICBpZiAoaXNEZWYoYykgJiYgKGlzRGVmKGMuY29tcG9uZW50T3B0aW9ucykgfHwgaXNBc3luY1BsYWNlaG9sZGVyKGMpKSkgewogICAgICAgICAgcmV0dXJuIGMKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdEV2ZW50cyAodm0pIHsKICAgIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdm0uX2hhc0hvb2tFdmVudCA9IGZhbHNlOwogICAgLy8gaW5pdCBwYXJlbnQgYXR0YWNoZWQgZXZlbnRzCiAgICB2YXIgbGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgdXBkYXRlQ29tcG9uZW50TGlzdGVuZXJzKHZtLCBsaXN0ZW5lcnMpOwogICAgfQogIH0KCiAgdmFyIHRhcmdldDsKCiAgZnVuY3Rpb24gYWRkIChldmVudCwgZm4pIHsKICAgIHRhcmdldC4kb24oZXZlbnQsIGZuKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZSQxIChldmVudCwgZm4pIHsKICAgIHRhcmdldC4kb2ZmKGV2ZW50LCBmbik7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVPbmNlSGFuZGxlciAoZXZlbnQsIGZuKSB7CiAgICB2YXIgX3RhcmdldCA9IHRhcmdldDsKICAgIHJldHVybiBmdW5jdGlvbiBvbmNlSGFuZGxlciAoKSB7CiAgICAgIHZhciByZXMgPSBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgICAgX3RhcmdldC4kb2ZmKGV2ZW50LCBvbmNlSGFuZGxlcik7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyAoCiAgICB2bSwKICAgIGxpc3RlbmVycywKICAgIG9sZExpc3RlbmVycwogICkgewogICAgdGFyZ2V0ID0gdm07CiAgICB1cGRhdGVMaXN0ZW5lcnMobGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMgfHwge30sIGFkZCwgcmVtb3ZlJDEsIGNyZWF0ZU9uY2VIYW5kbGVyLCB2bSk7CiAgICB0YXJnZXQgPSB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBldmVudHNNaXhpbiAoVnVlKSB7CiAgICB2YXIgaG9va1JFID0gL15ob29rOi87CiAgICBWdWUucHJvdG90eXBlLiRvbiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXZlbnQpKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZtLiRvbihldmVudFtpXSwgZm4pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAodm0uX2V2ZW50c1tldmVudF0gfHwgKHZtLl9ldmVudHNbZXZlbnRdID0gW10pKS5wdXNoKGZuKTsKICAgICAgICAvLyBvcHRpbWl6ZSBob29rOmV2ZW50IGNvc3QgYnkgdXNpbmcgYSBib29sZWFuIGZsYWcgbWFya2VkIGF0IHJlZ2lzdHJhdGlvbgogICAgICAgIC8vIGluc3RlYWQgb2YgYSBoYXNoIGxvb2t1cAogICAgICAgIGlmIChob29rUkUudGVzdChldmVudCkpIHsKICAgICAgICAgIHZtLl9oYXNIb29rRXZlbnQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdm0KICAgIH07CgogICAgVnVlLnByb3RvdHlwZS4kb25jZSA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgZnVuY3Rpb24gb24gKCkgewogICAgICAgIHZtLiRvZmYoZXZlbnQsIG9uKTsKICAgICAgICBmbi5hcHBseSh2bSwgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBvbi5mbiA9IGZuOwogICAgICB2bS4kb24oZXZlbnQsIG9uKTsKICAgICAgcmV0dXJuIHZtCiAgICB9OwoKICAgIFZ1ZS5wcm90b3R5cGUuJG9mZiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgLy8gYWxsCiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIHJldHVybiB2bQogICAgICB9CiAgICAgIC8vIGFycmF5IG9mIGV2ZW50cwogICAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudCkpIHsKICAgICAgICBmb3IgKHZhciBpJDEgPSAwLCBsID0gZXZlbnQubGVuZ3RoOyBpJDEgPCBsOyBpJDErKykgewogICAgICAgICAgdm0uJG9mZihldmVudFtpJDFdLCBmbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2bQogICAgICB9CiAgICAgIC8vIHNwZWNpZmljIGV2ZW50CiAgICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKICAgICAgaWYgKCFjYnMpIHsKICAgICAgICByZXR1cm4gdm0KICAgICAgfQogICAgICBpZiAoIWZuKSB7CiAgICAgICAgdm0uX2V2ZW50c1tldmVudF0gPSBudWxsOwogICAgICAgIHJldHVybiB2bQogICAgICB9CiAgICAgIC8vIHNwZWNpZmljIGhhbmRsZXIKICAgICAgdmFyIGNiOwogICAgICB2YXIgaSA9IGNicy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBjYiA9IGNic1tpXTsKICAgICAgICBpZiAoY2IgPT09IGZuIHx8IGNiLmZuID09PSBmbikgewogICAgICAgICAgY2JzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2bQogICAgfTsKCiAgICBWdWUucHJvdG90eXBlLiRlbWl0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHsKICAgICAgICB2YXIgbG93ZXJDYXNlRXZlbnQgPSBldmVudC50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChsb3dlckNhc2VFdmVudCAhPT0gZXZlbnQgJiYgdm0uX2V2ZW50c1tsb3dlckNhc2VFdmVudF0pIHsKICAgICAgICAgIHRpcCgKICAgICAgICAgICAgIkV2ZW50IFwiIiArIGxvd2VyQ2FzZUV2ZW50ICsgIlwiIGlzIGVtaXR0ZWQgaW4gY29tcG9uZW50ICIgKwogICAgICAgICAgICAoZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkpICsgIiBidXQgdGhlIGhhbmRsZXIgaXMgcmVnaXN0ZXJlZCBmb3IgXCIiICsgZXZlbnQgKyAiXCIuICIgKwogICAgICAgICAgICAiTm90ZSB0aGF0IEhUTUwgYXR0cmlidXRlcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZSBhbmQgeW91IGNhbm5vdCB1c2UgIiArCiAgICAgICAgICAgICJ2LW9uIHRvIGxpc3RlbiB0byBjYW1lbENhc2UgZXZlbnRzIHdoZW4gdXNpbmcgaW4tRE9NIHRlbXBsYXRlcy4gIiArCiAgICAgICAgICAgICJZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIgKyAoaHlwaGVuYXRlKGV2ZW50KSkgKyAiXCIgaW5zdGVhZCBvZiBcIiIgKyBldmVudCArICJcIi4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgY2JzID0gdm0uX2V2ZW50c1tldmVudF07CiAgICAgIGlmIChjYnMpIHsKICAgICAgICBjYnMgPSBjYnMubGVuZ3RoID4gMSA/IHRvQXJyYXkoY2JzKSA6IGNiczsKICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzLCAxKTsKICAgICAgICB2YXIgaW5mbyA9ICJldmVudCBoYW5kbGVyIGZvciBcIiIgKyBldmVudCArICJcIiI7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjYnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhjYnNbaV0sIHZtLCBhcmdzLCB2bSwgaW5mbyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2bQogICAgfTsKICB9CgogIC8qICAqLwoKICB2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwogIHZhciBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gc2V0QWN0aXZlSW5zdGFuY2Uodm0pIHsKICAgIHZhciBwcmV2QWN0aXZlSW5zdGFuY2UgPSBhY3RpdmVJbnN0YW5jZTsKICAgIGFjdGl2ZUluc3RhbmNlID0gdm07CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBhY3RpdmVJbnN0YW5jZSA9IHByZXZBY3RpdmVJbnN0YW5jZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaXRMaWZlY3ljbGUgKHZtKSB7CiAgICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwoKICAgIC8vIGxvY2F0ZSBmaXJzdCBub24tYWJzdHJhY3QgcGFyZW50CiAgICB2YXIgcGFyZW50ID0gb3B0aW9ucy5wYXJlbnQ7CiAgICBpZiAocGFyZW50ICYmICFvcHRpb25zLmFic3RyYWN0KSB7CiAgICAgIHdoaWxlIChwYXJlbnQuJG9wdGlvbnMuYWJzdHJhY3QgJiYgcGFyZW50LiRwYXJlbnQpIHsKICAgICAgICBwYXJlbnQgPSBwYXJlbnQuJHBhcmVudDsKICAgICAgfQogICAgICBwYXJlbnQuJGNoaWxkcmVuLnB1c2godm0pOwogICAgfQoKICAgIHZtLiRwYXJlbnQgPSBwYXJlbnQ7CiAgICB2bS4kcm9vdCA9IHBhcmVudCA/IHBhcmVudC4kcm9vdCA6IHZtOwoKICAgIHZtLiRjaGlsZHJlbiA9IFtdOwogICAgdm0uJHJlZnMgPSB7fTsKCiAgICB2bS5fd2F0Y2hlciA9IG51bGw7CiAgICB2bS5faW5hY3RpdmUgPSBudWxsOwogICAgdm0uX2RpcmVjdEluYWN0aXZlID0gZmFsc2U7CiAgICB2bS5faXNNb3VudGVkID0gZmFsc2U7CiAgICB2bS5faXNEZXN0cm95ZWQgPSBmYWxzZTsKICAgIHZtLl9pc0JlaW5nRGVzdHJveWVkID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBsaWZlY3ljbGVNaXhpbiAoVnVlKSB7CiAgICBWdWUucHJvdG90eXBlLl91cGRhdGUgPSBmdW5jdGlvbiAodm5vZGUsIGh5ZHJhdGluZykgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB2YXIgcHJldkVsID0gdm0uJGVsOwogICAgICB2YXIgcHJldlZub2RlID0gdm0uX3Zub2RlOwogICAgICB2YXIgcmVzdG9yZUFjdGl2ZUluc3RhbmNlID0gc2V0QWN0aXZlSW5zdGFuY2Uodm0pOwogICAgICB2bS5fdm5vZGUgPSB2bm9kZTsKICAgICAgLy8gVnVlLnByb3RvdHlwZS5fX3BhdGNoX18gaXMgaW5qZWN0ZWQgaW4gZW50cnkgcG9pbnRzCiAgICAgIC8vIGJhc2VkIG9uIHRoZSByZW5kZXJpbmcgYmFja2VuZCB1c2VkLgogICAgICBpZiAoIXByZXZWbm9kZSkgewogICAgICAgIC8vIGluaXRpYWwgcmVuZGVyCiAgICAgICAgdm0uJGVsID0gdm0uX19wYXRjaF9fKHZtLiRlbCwgdm5vZGUsIGh5ZHJhdGluZywgZmFsc2UgLyogcmVtb3ZlT25seSAqLyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gdXBkYXRlcwogICAgICAgIHZtLiRlbCA9IHZtLl9fcGF0Y2hfXyhwcmV2Vm5vZGUsIHZub2RlKTsKICAgICAgfQogICAgICByZXN0b3JlQWN0aXZlSW5zdGFuY2UoKTsKICAgICAgLy8gdXBkYXRlIF9fdnVlX18gcmVmZXJlbmNlCiAgICAgIGlmIChwcmV2RWwpIHsKICAgICAgICBwcmV2RWwuX192dWVfXyA9IG51bGw7CiAgICAgIH0KICAgICAgaWYgKHZtLiRlbCkgewogICAgICAgIHZtLiRlbC5fX3Z1ZV9fID0gdm07CiAgICAgIH0KICAgICAgLy8gaWYgcGFyZW50IGlzIGFuIEhPQywgdXBkYXRlIGl0cyAkZWwgYXMgd2VsbAogICAgICBpZiAodm0uJHZub2RlICYmIHZtLiRwYXJlbnQgJiYgdm0uJHZub2RlID09PSB2bS4kcGFyZW50Ll92bm9kZSkgewogICAgICAgIHZtLiRwYXJlbnQuJGVsID0gdm0uJGVsOwogICAgICB9CiAgICAgIC8vIHVwZGF0ZWQgaG9vayBpcyBjYWxsZWQgYnkgdGhlIHNjaGVkdWxlciB0byBlbnN1cmUgdGhhdCBjaGlsZHJlbiBhcmUKICAgICAgLy8gdXBkYXRlZCBpbiBhIHBhcmVudCdzIHVwZGF0ZWQgaG9vay4KICAgIH07CgogICAgVnVlLnByb3RvdHlwZS4kZm9yY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICAgIHZtLl93YXRjaGVyLnVwZGF0ZSgpOwogICAgICB9CiAgICB9OwoKICAgIFZ1ZS5wcm90b3R5cGUuJGRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIGlmICh2bS5faXNCZWluZ0Rlc3Ryb3llZCkgewogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlRGVzdHJveScpOwogICAgICB2bS5faXNCZWluZ0Rlc3Ryb3llZCA9IHRydWU7CiAgICAgIC8vIHJlbW92ZSBzZWxmIGZyb20gcGFyZW50CiAgICAgIHZhciBwYXJlbnQgPSB2bS4kcGFyZW50OwogICAgICBpZiAocGFyZW50ICYmICFwYXJlbnQuX2lzQmVpbmdEZXN0cm95ZWQgJiYgIXZtLiRvcHRpb25zLmFic3RyYWN0KSB7CiAgICAgICAgcmVtb3ZlKHBhcmVudC4kY2hpbGRyZW4sIHZtKTsKICAgICAgfQogICAgICAvLyB0ZWFyZG93biB3YXRjaGVycwogICAgICBpZiAodm0uX3dhdGNoZXIpIHsKICAgICAgICB2bS5fd2F0Y2hlci50ZWFyZG93bigpOwogICAgICB9CiAgICAgIHZhciBpID0gdm0uX3dhdGNoZXJzLmxlbmd0aDsKICAgICAgd2hpbGUgKGktLSkgewogICAgICAgIHZtLl93YXRjaGVyc1tpXS50ZWFyZG93bigpOwogICAgICB9CiAgICAgIC8vIHJlbW92ZSByZWZlcmVuY2UgZnJvbSBkYXRhIG9iCiAgICAgIC8vIGZyb3plbiBvYmplY3QgbWF5IG5vdCBoYXZlIG9ic2VydmVyLgogICAgICBpZiAodm0uX2RhdGEuX19vYl9fKSB7CiAgICAgICAgdm0uX2RhdGEuX19vYl9fLnZtQ291bnQtLTsKICAgICAgfQogICAgICAvLyBjYWxsIHRoZSBsYXN0IGhvb2suLi4KICAgICAgdm0uX2lzRGVzdHJveWVkID0gdHJ1ZTsKICAgICAgLy8gaW52b2tlIGRlc3Ryb3kgaG9va3Mgb24gY3VycmVudCByZW5kZXJlZCB0cmVlCiAgICAgIHZtLl9fcGF0Y2hfXyh2bS5fdm5vZGUsIG51bGwpOwogICAgICAvLyBmaXJlIGRlc3Ryb3llZCBob29rCiAgICAgIGNhbGxIb29rKHZtLCAnZGVzdHJveWVkJyk7CiAgICAgIC8vIHR1cm4gb2ZmIGFsbCBpbnN0YW5jZSBsaXN0ZW5lcnMuCiAgICAgIHZtLiRvZmYoKTsKICAgICAgLy8gcmVtb3ZlIF9fdnVlX18gcmVmZXJlbmNlCiAgICAgIGlmICh2bS4kZWwpIHsKICAgICAgICB2bS4kZWwuX192dWVfXyA9IG51bGw7CiAgICAgIH0KICAgICAgLy8gcmVsZWFzZSBjaXJjdWxhciByZWZlcmVuY2UgKCM2NzU5KQogICAgICBpZiAodm0uJHZub2RlKSB7CiAgICAgICAgdm0uJHZub2RlLnBhcmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBtb3VudENvbXBvbmVudCAoCiAgICB2bSwKICAgIGVsLAogICAgaHlkcmF0aW5nCiAgKSB7CiAgICB2bS4kZWwgPSBlbDsKICAgIGlmICghdm0uJG9wdGlvbnMucmVuZGVyKSB7CiAgICAgIHZtLiRvcHRpb25zLnJlbmRlciA9IGNyZWF0ZUVtcHR5Vk5vZGU7CiAgICAgIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoKHZtLiRvcHRpb25zLnRlbXBsYXRlICYmIHZtLiRvcHRpb25zLnRlbXBsYXRlLmNoYXJBdCgwKSAhPT0gJyMnKSB8fAogICAgICAgICAgdm0uJG9wdGlvbnMuZWwgfHwgZWwpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICdZb3UgYXJlIHVzaW5nIHRoZSBydW50aW1lLW9ubHkgYnVpbGQgb2YgVnVlIHdoZXJlIHRoZSB0ZW1wbGF0ZSAnICsKICAgICAgICAgICAgJ2NvbXBpbGVyIGlzIG5vdCBhdmFpbGFibGUuIEVpdGhlciBwcmUtY29tcGlsZSB0aGUgdGVtcGxhdGVzIGludG8gJyArCiAgICAgICAgICAgICdyZW5kZXIgZnVuY3Rpb25zLCBvciB1c2UgdGhlIGNvbXBpbGVyLWluY2x1ZGVkIGJ1aWxkLicsCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3YXJuKAogICAgICAgICAgICAnRmFpbGVkIHRvIG1vdW50IGNvbXBvbmVudDogdGVtcGxhdGUgb3IgcmVuZGVyIGZ1bmN0aW9uIG5vdCBkZWZpbmVkLicsCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgY2FsbEhvb2sodm0sICdiZWZvcmVNb3VudCcpOwoKICAgIHZhciB1cGRhdGVDb21wb25lbnQ7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICB1cGRhdGVDb21wb25lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG5hbWUgPSB2bS5fbmFtZTsKICAgICAgICB2YXIgaWQgPSB2bS5fdWlkOwogICAgICAgIHZhciBzdGFydFRhZyA9ICJ2dWUtcGVyZi1zdGFydDoiICsgaWQ7CiAgICAgICAgdmFyIGVuZFRhZyA9ICJ2dWUtcGVyZi1lbmQ6IiArIGlkOwoKICAgICAgICBtYXJrKHN0YXJ0VGFnKTsKICAgICAgICB2YXIgdm5vZGUgPSB2bS5fcmVuZGVyKCk7CiAgICAgICAgbWFyayhlbmRUYWcpOwogICAgICAgIG1lYXN1cmUoKCJ2dWUgIiArIG5hbWUgKyAiIHJlbmRlciIpLCBzdGFydFRhZywgZW5kVGFnKTsKCiAgICAgICAgbWFyayhzdGFydFRhZyk7CiAgICAgICAgdm0uX3VwZGF0ZSh2bm9kZSwgaHlkcmF0aW5nKTsKICAgICAgICBtYXJrKGVuZFRhZyk7CiAgICAgICAgbWVhc3VyZSgoInZ1ZSAiICsgbmFtZSArICIgcGF0Y2giKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB1cGRhdGVDb21wb25lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdm0uX3VwZGF0ZSh2bS5fcmVuZGVyKCksIGh5ZHJhdGluZyk7CiAgICAgIH07CiAgICB9CgogICAgLy8gd2Ugc2V0IHRoaXMgdG8gdm0uX3dhdGNoZXIgaW5zaWRlIHRoZSB3YXRjaGVyJ3MgY29uc3RydWN0b3IKICAgIC8vIHNpbmNlIHRoZSB3YXRjaGVyJ3MgaW5pdGlhbCBwYXRjaCBtYXkgY2FsbCAkZm9yY2VVcGRhdGUgKGUuZy4gaW5zaWRlIGNoaWxkCiAgICAvLyBjb21wb25lbnQncyBtb3VudGVkIGhvb2spLCB3aGljaCByZWxpZXMgb24gdm0uX3dhdGNoZXIgYmVpbmcgYWxyZWFkeSBkZWZpbmVkCiAgICBuZXcgV2F0Y2hlcih2bSwgdXBkYXRlQ29tcG9uZW50LCBub29wLCB7CiAgICAgIGJlZm9yZTogZnVuY3Rpb24gYmVmb3JlICgpIHsKICAgICAgICBpZiAodm0uX2lzTW91bnRlZCAmJiAhdm0uX2lzRGVzdHJveWVkKSB7CiAgICAgICAgICBjYWxsSG9vayh2bSwgJ2JlZm9yZVVwZGF0ZScpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgdHJ1ZSAvKiBpc1JlbmRlcldhdGNoZXIgKi8pOwogICAgaHlkcmF0aW5nID0gZmFsc2U7CgogICAgLy8gbWFudWFsbHkgbW91bnRlZCBpbnN0YW5jZSwgY2FsbCBtb3VudGVkIG9uIHNlbGYKICAgIC8vIG1vdW50ZWQgaXMgY2FsbGVkIGZvciByZW5kZXItY3JlYXRlZCBjaGlsZCBjb21wb25lbnRzIGluIGl0cyBpbnNlcnRlZCBob29rCiAgICBpZiAodm0uJHZub2RlID09IG51bGwpIHsKICAgICAgdm0uX2lzTW91bnRlZCA9IHRydWU7CiAgICAgIGNhbGxIb29rKHZtLCAnbW91bnRlZCcpOwogICAgfQogICAgcmV0dXJuIHZtCiAgfQoKICBmdW5jdGlvbiB1cGRhdGVDaGlsZENvbXBvbmVudCAoCiAgICB2bSwKICAgIHByb3BzRGF0YSwKICAgIGxpc3RlbmVycywKICAgIHBhcmVudFZub2RlLAogICAgcmVuZGVyQ2hpbGRyZW4KICApIHsKICAgIHsKICAgICAgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBkZXRlcm1pbmUgd2hldGhlciBjb21wb25lbnQgaGFzIHNsb3QgY2hpbGRyZW4KICAgIC8vIHdlIG5lZWQgdG8gZG8gdGhpcyBiZWZvcmUgb3ZlcndyaXRpbmcgJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuLgoKICAgIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBkeW5hbWljIHNjb3BlZFNsb3RzIChoYW5kLXdyaXR0ZW4gb3IgY29tcGlsZWQgYnV0IHdpdGgKICAgIC8vIGR5bmFtaWMgc2xvdCBuYW1lcykuIFN0YXRpYyBzY29wZWQgc2xvdHMgY29tcGlsZWQgZnJvbSB0ZW1wbGF0ZSBoYXMgdGhlCiAgICAvLyAiJHN0YWJsZSIgbWFya2VyLgogICAgdmFyIG5ld1Njb3BlZFNsb3RzID0gcGFyZW50Vm5vZGUuZGF0YS5zY29wZWRTbG90czsKICAgIHZhciBvbGRTY29wZWRTbG90cyA9IHZtLiRzY29wZWRTbG90czsKICAgIHZhciBoYXNEeW5hbWljU2NvcGVkU2xvdCA9ICEhKAogICAgICAobmV3U2NvcGVkU2xvdHMgJiYgIW5ld1Njb3BlZFNsb3RzLiRzdGFibGUpIHx8CiAgICAgIChvbGRTY29wZWRTbG90cyAhPT0gZW1wdHlPYmplY3QgJiYgIW9sZFNjb3BlZFNsb3RzLiRzdGFibGUpIHx8CiAgICAgIChuZXdTY29wZWRTbG90cyAmJiB2bS4kc2NvcGVkU2xvdHMuJGtleSAhPT0gbmV3U2NvcGVkU2xvdHMuJGtleSkKICAgICk7CgogICAgLy8gQW55IHN0YXRpYyBzbG90IGNoaWxkcmVuIGZyb20gdGhlIHBhcmVudCBtYXkgaGF2ZSBjaGFuZ2VkIGR1cmluZyBwYXJlbnQncwogICAgLy8gdXBkYXRlLiBEeW5hbWljIHNjb3BlZCBzbG90cyBtYXkgYWxzbyBoYXZlIGNoYW5nZWQuIEluIHN1Y2ggY2FzZXMsIGEgZm9yY2VkCiAgICAvLyB1cGRhdGUgaXMgbmVjZXNzYXJ5IHRvIGVuc3VyZSBjb3JyZWN0bmVzcy4KICAgIHZhciBuZWVkc0ZvcmNlVXBkYXRlID0gISEoCiAgICAgIHJlbmRlckNoaWxkcmVuIHx8ICAgICAgICAgICAgICAgLy8gaGFzIG5ldyBzdGF0aWMgc2xvdHMKICAgICAgdm0uJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuIHx8ICAvLyBoYXMgb2xkIHN0YXRpYyBzbG90cwogICAgICBoYXNEeW5hbWljU2NvcGVkU2xvdAogICAgKTsKCiAgICB2bS4kb3B0aW9ucy5fcGFyZW50Vm5vZGUgPSBwYXJlbnRWbm9kZTsKICAgIHZtLiR2bm9kZSA9IHBhcmVudFZub2RlOyAvLyB1cGRhdGUgdm0ncyBwbGFjZWhvbGRlciBub2RlIHdpdGhvdXQgcmUtcmVuZGVyCgogICAgaWYgKHZtLl92bm9kZSkgeyAvLyB1cGRhdGUgY2hpbGQgdHJlZSdzIHBhcmVudAogICAgICB2bS5fdm5vZGUucGFyZW50ID0gcGFyZW50Vm5vZGU7CiAgICB9CiAgICB2bS4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4gPSByZW5kZXJDaGlsZHJlbjsKCiAgICAvLyB1cGRhdGUgJGF0dHJzIGFuZCAkbGlzdGVuZXJzIGhhc2gKICAgIC8vIHRoZXNlIGFyZSBhbHNvIHJlYWN0aXZlIHNvIHRoZXkgbWF5IHRyaWdnZXIgY2hpbGQgdXBkYXRlIGlmIHRoZSBjaGlsZAogICAgLy8gdXNlZCB0aGVtIGR1cmluZyByZW5kZXIKICAgIHZtLiRhdHRycyA9IHBhcmVudFZub2RlLmRhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3Q7CiAgICB2bS4kbGlzdGVuZXJzID0gbGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0OwoKICAgIC8vIHVwZGF0ZSBwcm9wcwogICAgaWYgKHByb3BzRGF0YSAmJiB2bS4kb3B0aW9ucy5wcm9wcykgewogICAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogICAgICB2YXIgcHJvcHMgPSB2bS5fcHJvcHM7CiAgICAgIHZhciBwcm9wS2V5cyA9IHZtLiRvcHRpb25zLl9wcm9wS2V5cyB8fCBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wS2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXkgPSBwcm9wS2V5c1tpXTsKICAgICAgICB2YXIgcHJvcE9wdGlvbnMgPSB2bS4kb3B0aW9ucy5wcm9wczsgLy8gd3RmIGZsb3c/CiAgICAgICAgcHJvcHNba2V5XSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEsIHZtKTsKICAgICAgfQogICAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7CiAgICAgIC8vIGtlZXAgYSBjb3B5IG9mIHJhdyBwcm9wc0RhdGEKICAgICAgdm0uJG9wdGlvbnMucHJvcHNEYXRhID0gcHJvcHNEYXRhOwogICAgfQoKICAgIC8vIHVwZGF0ZSBsaXN0ZW5lcnMKICAgIGxpc3RlbmVycyA9IGxpc3RlbmVycyB8fCBlbXB0eU9iamVjdDsKICAgIHZhciBvbGRMaXN0ZW5lcnMgPSB2bS4kb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzOwogICAgdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyA9IGxpc3RlbmVyczsKICAgIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMpOwoKICAgIC8vIHJlc29sdmUgc2xvdHMgKyBmb3JjZSB1cGRhdGUgaWYgaGFzIGNoaWxkcmVuCiAgICBpZiAobmVlZHNGb3JjZVVwZGF0ZSkgewogICAgICB2bS4kc2xvdHMgPSByZXNvbHZlU2xvdHMocmVuZGVyQ2hpbGRyZW4sIHBhcmVudFZub2RlLmNvbnRleHQpOwogICAgICB2bS4kZm9yY2VVcGRhdGUoKTsKICAgIH0KCiAgICB7CiAgICAgIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNJbkluYWN0aXZlVHJlZSAodm0pIHsKICAgIHdoaWxlICh2bSAmJiAodm0gPSB2bS4kcGFyZW50KSkgewogICAgICBpZiAodm0uX2luYWN0aXZlKSB7IHJldHVybiB0cnVlIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgZnVuY3Rpb24gYWN0aXZhdGVDaGlsZENvbXBvbmVudCAodm0sIGRpcmVjdCkgewogICAgaWYgKGRpcmVjdCkgewogICAgICB2bS5fZGlyZWN0SW5hY3RpdmUgPSBmYWxzZTsKICAgICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0gZWxzZSBpZiAodm0uX2RpcmVjdEluYWN0aXZlKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKHZtLl9pbmFjdGl2ZSB8fCB2bS5faW5hY3RpdmUgPT09IG51bGwpIHsKICAgICAgdm0uX2luYWN0aXZlID0gZmFsc2U7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm0uJGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bS4kY2hpbGRyZW5baV0pOwogICAgICB9CiAgICAgIGNhbGxIb29rKHZtLCAnYWN0aXZhdGVkJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQgKHZtLCBkaXJlY3QpIHsKICAgIGlmIChkaXJlY3QpIHsKICAgICAgdm0uX2RpcmVjdEluYWN0aXZlID0gdHJ1ZTsKICAgICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KICAgIGlmICghdm0uX2luYWN0aXZlKSB7CiAgICAgIHZtLl9pbmFjdGl2ZSA9IHRydWU7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm0uJGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICAgIH0KICAgICAgY2FsbEhvb2sodm0sICdkZWFjdGl2YXRlZCcpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2FsbEhvb2sgKHZtLCBob29rKSB7CiAgICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgbGlmZWN5Y2xlIGhvb2tzCiAgICBwdXNoVGFyZ2V0KCk7CiAgICB2YXIgaGFuZGxlcnMgPSB2bS4kb3B0aW9uc1tob29rXTsKICAgIHZhciBpbmZvID0gaG9vayArICIgaG9vayI7CiAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBoYW5kbGVycy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhoYW5kbGVyc1tpXSwgdm0sIG51bGwsIHZtLCBpbmZvKTsKICAgICAgfQogICAgfQogICAgaWYgKHZtLl9oYXNIb29rRXZlbnQpIHsKICAgICAgdm0uJGVtaXQoJ2hvb2s6JyArIGhvb2spOwogICAgfQogICAgcG9wVGFyZ2V0KCk7CiAgfQoKICAvKiAgKi8KCiAgdmFyIE1BWF9VUERBVEVfQ09VTlQgPSAxMDA7CgogIHZhciBxdWV1ZSA9IFtdOwogIHZhciBhY3RpdmF0ZWRDaGlsZHJlbiA9IFtdOwogIHZhciBoYXMgPSB7fTsKICB2YXIgY2lyY3VsYXIgPSB7fTsKICB2YXIgd2FpdGluZyA9IGZhbHNlOwogIHZhciBmbHVzaGluZyA9IGZhbHNlOwogIHZhciBpbmRleCA9IDA7CgogIC8qKgogICAqIFJlc2V0IHRoZSBzY2hlZHVsZXIncyBzdGF0ZS4KICAgKi8KICBmdW5jdGlvbiByZXNldFNjaGVkdWxlclN0YXRlICgpIHsKICAgIGluZGV4ID0gcXVldWUubGVuZ3RoID0gYWN0aXZhdGVkQ2hpbGRyZW4ubGVuZ3RoID0gMDsKICAgIGhhcyA9IHt9OwogICAgewogICAgICBjaXJjdWxhciA9IHt9OwogICAgfQogICAgd2FpdGluZyA9IGZsdXNoaW5nID0gZmFsc2U7CiAgfQoKICAvLyBBc3luYyBlZGdlIGNhc2UgIzY1NjYgcmVxdWlyZXMgc2F2aW5nIHRoZSB0aW1lc3RhbXAgd2hlbiBldmVudCBsaXN0ZW5lcnMgYXJlCiAgLy8gYXR0YWNoZWQuIEhvd2V2ZXIsIGNhbGxpbmcgcGVyZm9ybWFuY2Uubm93KCkgaGFzIGEgcGVyZiBvdmVyaGVhZCBlc3BlY2lhbGx5CiAgLy8gaWYgdGhlIHBhZ2UgaGFzIHRob3VzYW5kcyBvZiBldmVudCBsaXN0ZW5lcnMuIEluc3RlYWQsIHdlIHRha2UgYSB0aW1lc3RhbXAKICAvLyBldmVyeSB0aW1lIHRoZSBzY2hlZHVsZXIgZmx1c2hlcyBhbmQgdXNlIHRoYXQgZm9yIGFsbCBldmVudCBsaXN0ZW5lcnMKICAvLyBhdHRhY2hlZCBkdXJpbmcgdGhhdCBmbHVzaC4KICB2YXIgY3VycmVudEZsdXNoVGltZXN0YW1wID0gMDsKCiAgLy8gQXN5bmMgZWRnZSBjYXNlIGZpeCByZXF1aXJlcyBzdG9yaW5nIGFuIGV2ZW50IGxpc3RlbmVyJ3MgYXR0YWNoIHRpbWVzdGFtcC4KICB2YXIgZ2V0Tm93ID0gRGF0ZS5ub3c7CgogIC8vIERldGVybWluZSB3aGF0IGV2ZW50IHRpbWVzdGFtcCB0aGUgYnJvd3NlciBpcyB1c2luZy4gQW5ub3lpbmdseSwgdGhlCiAgLy8gdGltZXN0YW1wIGNhbiBlaXRoZXIgYmUgaGktcmVzIChyZWxhdGl2ZSB0byBwYWdlIGxvYWQpIG9yIGxvdy1yZXMKICAvLyAocmVsYXRpdmUgdG8gVU5JWCBlcG9jaCksIHNvIGluIG9yZGVyIHRvIGNvbXBhcmUgdGltZSB3ZSBoYXZlIHRvIHVzZSB0aGUKICAvLyBzYW1lIHRpbWVzdGFtcCB0eXBlIHdoZW4gc2F2aW5nIHRoZSBmbHVzaCB0aW1lc3RhbXAuCiAgLy8gQWxsIElFIHZlcnNpb25zIHVzZSBsb3ctcmVzIGV2ZW50IHRpbWVzdGFtcHMsIGFuZCBoYXZlIHByb2JsZW1hdGljIGNsb2NrCiAgLy8gaW1wbGVtZW50YXRpb25zICgjOTYzMikKICBpZiAoaW5Ccm93c2VyICYmICFpc0lFKSB7CiAgICB2YXIgcGVyZm9ybWFuY2UgPSB3aW5kb3cucGVyZm9ybWFuY2U7CiAgICBpZiAoCiAgICAgIHBlcmZvcm1hbmNlICYmCiAgICAgIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicgJiYKICAgICAgZ2V0Tm93KCkgPiBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKS50aW1lU3RhbXAKICAgICkgewogICAgICAvLyBpZiB0aGUgZXZlbnQgdGltZXN0YW1wLCBhbHRob3VnaCBldmFsdWF0ZWQgQUZURVIgdGhlIERhdGUubm93KCksIGlzCiAgICAgIC8vIHNtYWxsZXIgdGhhbiBpdCwgaXQgbWVhbnMgdGhlIGV2ZW50IGlzIHVzaW5nIGEgaGktcmVzIHRpbWVzdGFtcCwKICAgICAgLy8gYW5kIHdlIG5lZWQgdG8gdXNlIHRoZSBoaS1yZXMgdmVyc2lvbiBmb3IgZXZlbnQgbGlzdGVuZXIgdGltZXN0YW1wcyBhcwogICAgICAvLyB3ZWxsLgogICAgICBnZXROb3cgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsgfTsKICAgIH0KICB9CgogIC8qKgogICAqIEZsdXNoIGJvdGggcXVldWVzIGFuZCBydW4gdGhlIHdhdGNoZXJzLgogICAqLwogIGZ1bmN0aW9uIGZsdXNoU2NoZWR1bGVyUXVldWUgKCkgewogICAgY3VycmVudEZsdXNoVGltZXN0YW1wID0gZ2V0Tm93KCk7CiAgICBmbHVzaGluZyA9IHRydWU7CiAgICB2YXIgd2F0Y2hlciwgaWQ7CgogICAgLy8gU29ydCBxdWV1ZSBiZWZvcmUgZmx1c2guCiAgICAvLyBUaGlzIGVuc3VyZXMgdGhhdDoKICAgIC8vIDEuIENvbXBvbmVudHMgYXJlIHVwZGF0ZWQgZnJvbSBwYXJlbnQgdG8gY2hpbGQuIChiZWNhdXNlIHBhcmVudCBpcyBhbHdheXMKICAgIC8vICAgIGNyZWF0ZWQgYmVmb3JlIHRoZSBjaGlsZCkKICAgIC8vIDIuIEEgY29tcG9uZW50J3MgdXNlciB3YXRjaGVycyBhcmUgcnVuIGJlZm9yZSBpdHMgcmVuZGVyIHdhdGNoZXIgKGJlY2F1c2UKICAgIC8vICAgIHVzZXIgd2F0Y2hlcnMgYXJlIGNyZWF0ZWQgYmVmb3JlIHRoZSByZW5kZXIgd2F0Y2hlcikKICAgIC8vIDMuIElmIGEgY29tcG9uZW50IGlzIGRlc3Ryb3llZCBkdXJpbmcgYSBwYXJlbnQgY29tcG9uZW50J3Mgd2F0Y2hlciBydW4sCiAgICAvLyAgICBpdHMgd2F0Y2hlcnMgY2FuIGJlIHNraXBwZWQuCiAgICBxdWV1ZS5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLmlkIC0gYi5pZDsgfSk7CgogICAgLy8gZG8gbm90IGNhY2hlIGxlbmd0aCBiZWNhdXNlIG1vcmUgd2F0Y2hlcnMgbWlnaHQgYmUgcHVzaGVkCiAgICAvLyBhcyB3ZSBydW4gZXhpc3Rpbmcgd2F0Y2hlcnMKICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IHF1ZXVlLmxlbmd0aDsgaW5kZXgrKykgewogICAgICB3YXRjaGVyID0gcXVldWVbaW5kZXhdOwogICAgICBpZiAod2F0Y2hlci5iZWZvcmUpIHsKICAgICAgICB3YXRjaGVyLmJlZm9yZSgpOwogICAgICB9CiAgICAgIGlkID0gd2F0Y2hlci5pZDsKICAgICAgaGFzW2lkXSA9IG51bGw7CiAgICAgIHdhdGNoZXIucnVuKCk7CiAgICAgIC8vIGluIGRldiBidWlsZCwgY2hlY2sgYW5kIHN0b3AgY2lyY3VsYXIgdXBkYXRlcy4KICAgICAgaWYgKGhhc1tpZF0gIT0gbnVsbCkgewogICAgICAgIGNpcmN1bGFyW2lkXSA9IChjaXJjdWxhcltpZF0gfHwgMCkgKyAxOwogICAgICAgIGlmIChjaXJjdWxhcltpZF0gPiBNQVhfVVBEQVRFX0NPVU5UKSB7CiAgICAgICAgICB3YXJuKAogICAgICAgICAgICAnWW91IG1heSBoYXZlIGFuIGluZmluaXRlIHVwZGF0ZSBsb29wICcgKyAoCiAgICAgICAgICAgICAgd2F0Y2hlci51c2VyCiAgICAgICAgICAgICAgICA/ICgiaW4gd2F0Y2hlciB3aXRoIGV4cHJlc3Npb24gXCIiICsgKHdhdGNoZXIuZXhwcmVzc2lvbikgKyAiXCIiKQogICAgICAgICAgICAgICAgOiAiaW4gYSBjb21wb25lbnQgcmVuZGVyIGZ1bmN0aW9uLiIKICAgICAgICAgICAgKSwKICAgICAgICAgICAgd2F0Y2hlci52bQogICAgICAgICAgKTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8ga2VlcCBjb3BpZXMgb2YgcG9zdCBxdWV1ZXMgYmVmb3JlIHJlc2V0dGluZyBzdGF0ZQogICAgdmFyIGFjdGl2YXRlZFF1ZXVlID0gYWN0aXZhdGVkQ2hpbGRyZW4uc2xpY2UoKTsKICAgIHZhciB1cGRhdGVkUXVldWUgPSBxdWV1ZS5zbGljZSgpOwoKICAgIHJlc2V0U2NoZWR1bGVyU3RhdGUoKTsKCiAgICAvLyBjYWxsIGNvbXBvbmVudCB1cGRhdGVkIGFuZCBhY3RpdmF0ZWQgaG9va3MKICAgIGNhbGxBY3RpdmF0ZWRIb29rcyhhY3RpdmF0ZWRRdWV1ZSk7CiAgICBjYWxsVXBkYXRlZEhvb2tzKHVwZGF0ZWRRdWV1ZSk7CgogICAgLy8gZGV2dG9vbCBob29rCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChkZXZ0b29scyAmJiBjb25maWcuZGV2dG9vbHMpIHsKICAgICAgZGV2dG9vbHMuZW1pdCgnZmx1c2gnKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbGxVcGRhdGVkSG9va3MgKHF1ZXVlKSB7CiAgICB2YXIgaSA9IHF1ZXVlLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdmFyIHdhdGNoZXIgPSBxdWV1ZVtpXTsKICAgICAgdmFyIHZtID0gd2F0Y2hlci52bTsKICAgICAgaWYgKHZtLl93YXRjaGVyID09PSB3YXRjaGVyICYmIHZtLl9pc01vdW50ZWQgJiYgIXZtLl9pc0Rlc3Ryb3llZCkgewogICAgICAgIGNhbGxIb29rKHZtLCAndXBkYXRlZCcpOwogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKiBRdWV1ZSBhIGtlcHQtYWxpdmUgY29tcG9uZW50IHRoYXQgd2FzIGFjdGl2YXRlZCBkdXJpbmcgcGF0Y2guCiAgICogVGhlIHF1ZXVlIHdpbGwgYmUgcHJvY2Vzc2VkIGFmdGVyIHRoZSBlbnRpcmUgdHJlZSBoYXMgYmVlbiBwYXRjaGVkLgogICAqLwogIGZ1bmN0aW9uIHF1ZXVlQWN0aXZhdGVkQ29tcG9uZW50ICh2bSkgewogICAgLy8gc2V0dGluZyBfaW5hY3RpdmUgdG8gZmFsc2UgaGVyZSBzbyB0aGF0IGEgcmVuZGVyIGZ1bmN0aW9uIGNhbgogICAgLy8gcmVseSBvbiBjaGVja2luZyB3aGV0aGVyIGl0J3MgaW4gYW4gaW5hY3RpdmUgdHJlZSAoZS5nLiByb3V0ZXItdmlldykKICAgIHZtLl9pbmFjdGl2ZSA9IGZhbHNlOwogICAgYWN0aXZhdGVkQ2hpbGRyZW4ucHVzaCh2bSk7CiAgfQoKICBmdW5jdGlvbiBjYWxsQWN0aXZhdGVkSG9va3MgKHF1ZXVlKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIHF1ZXVlW2ldLl9pbmFjdGl2ZSA9IHRydWU7CiAgICAgIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQocXVldWVbaV0sIHRydWUgLyogdHJ1ZSAqLyk7CiAgICB9CiAgfQoKICAvKioKICAgKiBQdXNoIGEgd2F0Y2hlciBpbnRvIHRoZSB3YXRjaGVyIHF1ZXVlLgogICAqIEpvYnMgd2l0aCBkdXBsaWNhdGUgSURzIHdpbGwgYmUgc2tpcHBlZCB1bmxlc3MgaXQncwogICAqIHB1c2hlZCB3aGVuIHRoZSBxdWV1ZSBpcyBiZWluZyBmbHVzaGVkLgogICAqLwogIGZ1bmN0aW9uIHF1ZXVlV2F0Y2hlciAod2F0Y2hlcikgewogICAgdmFyIGlkID0gd2F0Y2hlci5pZDsKICAgIGlmIChoYXNbaWRdID09IG51bGwpIHsKICAgICAgaGFzW2lkXSA9IHRydWU7CiAgICAgIGlmICghZmx1c2hpbmcpIHsKICAgICAgICBxdWV1ZS5wdXNoKHdhdGNoZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGlmIGFscmVhZHkgZmx1c2hpbmcsIHNwbGljZSB0aGUgd2F0Y2hlciBiYXNlZCBvbiBpdHMgaWQKICAgICAgICAvLyBpZiBhbHJlYWR5IHBhc3QgaXRzIGlkLCBpdCB3aWxsIGJlIHJ1biBuZXh0IGltbWVkaWF0ZWx5LgogICAgICAgIHZhciBpID0gcXVldWUubGVuZ3RoIC0gMTsKICAgICAgICB3aGlsZSAoaSA+IGluZGV4ICYmIHF1ZXVlW2ldLmlkID4gd2F0Y2hlci5pZCkgewogICAgICAgICAgaS0tOwogICAgICAgIH0KICAgICAgICBxdWV1ZS5zcGxpY2UoaSArIDEsIDAsIHdhdGNoZXIpOwogICAgICB9CiAgICAgIC8vIHF1ZXVlIHRoZSBmbHVzaAogICAgICBpZiAoIXdhaXRpbmcpIHsKICAgICAgICB3YWl0aW5nID0gdHJ1ZTsKCiAgICAgICAgaWYgKCFjb25maWcuYXN5bmMpIHsKICAgICAgICAgIGZsdXNoU2NoZWR1bGVyUXVldWUoKTsKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICBuZXh0VGljayhmbHVzaFNjaGVkdWxlclF1ZXVlKTsKICAgICAgfQogICAgfQogIH0KCiAgLyogICovCgoKCiAgdmFyIHVpZCQyID0gMDsKCiAgLyoqCiAgICogQSB3YXRjaGVyIHBhcnNlcyBhbiBleHByZXNzaW9uLCBjb2xsZWN0cyBkZXBlbmRlbmNpZXMsCiAgICogYW5kIGZpcmVzIGNhbGxiYWNrIHdoZW4gdGhlIGV4cHJlc3Npb24gdmFsdWUgY2hhbmdlcy4KICAgKiBUaGlzIGlzIHVzZWQgZm9yIGJvdGggdGhlICR3YXRjaCgpIGFwaSBhbmQgZGlyZWN0aXZlcy4KICAgKi8KICB2YXIgV2F0Y2hlciA9IGZ1bmN0aW9uIFdhdGNoZXIgKAogICAgdm0sCiAgICBleHBPckZuLAogICAgY2IsCiAgICBvcHRpb25zLAogICAgaXNSZW5kZXJXYXRjaGVyCiAgKSB7CiAgICB0aGlzLnZtID0gdm07CiAgICBpZiAoaXNSZW5kZXJXYXRjaGVyKSB7CiAgICAgIHZtLl93YXRjaGVyID0gdGhpczsKICAgIH0KICAgIHZtLl93YXRjaGVycy5wdXNoKHRoaXMpOwogICAgLy8gb3B0aW9ucwogICAgaWYgKG9wdGlvbnMpIHsKICAgICAgdGhpcy5kZWVwID0gISFvcHRpb25zLmRlZXA7CiAgICAgIHRoaXMudXNlciA9ICEhb3B0aW9ucy51c2VyOwogICAgICB0aGlzLmxhenkgPSAhIW9wdGlvbnMubGF6eTsKICAgICAgdGhpcy5zeW5jID0gISFvcHRpb25zLnN5bmM7CiAgICAgIHRoaXMuYmVmb3JlID0gb3B0aW9ucy5iZWZvcmU7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRlZXAgPSB0aGlzLnVzZXIgPSB0aGlzLmxhenkgPSB0aGlzLnN5bmMgPSBmYWxzZTsKICAgIH0KICAgIHRoaXMuY2IgPSBjYjsKICAgIHRoaXMuaWQgPSArK3VpZCQyOyAvLyB1aWQgZm9yIGJhdGNoaW5nCiAgICB0aGlzLmFjdGl2ZSA9IHRydWU7CiAgICB0aGlzLmRpcnR5ID0gdGhpcy5sYXp5OyAvLyBmb3IgbGF6eSB3YXRjaGVycwogICAgdGhpcy5kZXBzID0gW107CiAgICB0aGlzLm5ld0RlcHMgPSBbXTsKICAgIHRoaXMuZGVwSWRzID0gbmV3IF9TZXQoKTsKICAgIHRoaXMubmV3RGVwSWRzID0gbmV3IF9TZXQoKTsKICAgIHRoaXMuZXhwcmVzc2lvbiA9IGV4cE9yRm4udG9TdHJpbmcoKTsKICAgIC8vIHBhcnNlIGV4cHJlc3Npb24gZm9yIGdldHRlcgogICAgaWYgKHR5cGVvZiBleHBPckZuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuZ2V0dGVyID0gZXhwT3JGbjsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZ2V0dGVyID0gcGFyc2VQYXRoKGV4cE9yRm4pOwogICAgICBpZiAoIXRoaXMuZ2V0dGVyKSB7CiAgICAgICAgdGhpcy5nZXR0ZXIgPSBub29wOwogICAgICAgIHdhcm4oCiAgICAgICAgICAiRmFpbGVkIHdhdGNoaW5nIHBhdGg6IFwiIiArIGV4cE9yRm4gKyAiXCIgIiArCiAgICAgICAgICAnV2F0Y2hlciBvbmx5IGFjY2VwdHMgc2ltcGxlIGRvdC1kZWxpbWl0ZWQgcGF0aHMuICcgKwogICAgICAgICAgJ0ZvciBmdWxsIGNvbnRyb2wsIHVzZSBhIGZ1bmN0aW9uIGluc3RlYWQuJywKICAgICAgICAgIHZtCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgdGhpcy52YWx1ZSA9IHRoaXMubGF6eQogICAgICA/IHVuZGVmaW5lZAogICAgICA6IHRoaXMuZ2V0KCk7CiAgfTsKCiAgLyoqCiAgICogRXZhbHVhdGUgdGhlIGdldHRlciwgYW5kIHJlLWNvbGxlY3QgZGVwZW5kZW5jaWVzLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldCAoKSB7CiAgICBwdXNoVGFyZ2V0KHRoaXMpOwogICAgdmFyIHZhbHVlOwogICAgdmFyIHZtID0gdGhpcy52bTsKICAgIHRyeSB7CiAgICAgIHZhbHVlID0gdGhpcy5nZXR0ZXIuY2FsbCh2bSwgdm0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICBpZiAodGhpcy51c2VyKSB7CiAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICgiZ2V0dGVyIGZvciB3YXRjaGVyIFwiIiArICh0aGlzLmV4cHJlc3Npb24pICsgIlwiIikpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IGUKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgLy8gInRvdWNoIiBldmVyeSBwcm9wZXJ0eSBzbyB0aGV5IGFyZSBhbGwgdHJhY2tlZCBhcwogICAgICAvLyBkZXBlbmRlbmNpZXMgZm9yIGRlZXAgd2F0Y2hpbmcKICAgICAgaWYgKHRoaXMuZGVlcCkgewogICAgICAgIHRyYXZlcnNlKHZhbHVlKTsKICAgICAgfQogICAgICBwb3BUYXJnZXQoKTsKICAgICAgdGhpcy5jbGVhbnVwRGVwcygpOwogICAgfQogICAgcmV0dXJuIHZhbHVlCiAgfTsKCiAgLyoqCiAgICogQWRkIGEgZGVwZW5kZW5jeSB0byB0aGlzIGRpcmVjdGl2ZS4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5hZGREZXAgPSBmdW5jdGlvbiBhZGREZXAgKGRlcCkgewogICAgdmFyIGlkID0gZGVwLmlkOwogICAgaWYgKCF0aGlzLm5ld0RlcElkcy5oYXMoaWQpKSB7CiAgICAgIHRoaXMubmV3RGVwSWRzLmFkZChpZCk7CiAgICAgIHRoaXMubmV3RGVwcy5wdXNoKGRlcCk7CiAgICAgIGlmICghdGhpcy5kZXBJZHMuaGFzKGlkKSkgewogICAgICAgIGRlcC5hZGRTdWIodGhpcyk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBDbGVhbiB1cCBmb3IgZGVwZW5kZW5jeSBjb2xsZWN0aW9uLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmNsZWFudXBEZXBzID0gZnVuY3Rpb24gY2xlYW51cERlcHMgKCkgewogICAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICB2YXIgZGVwID0gdGhpcy5kZXBzW2ldOwogICAgICBpZiAoIXRoaXMubmV3RGVwSWRzLmhhcyhkZXAuaWQpKSB7CiAgICAgICAgZGVwLnJlbW92ZVN1Yih0aGlzKTsKICAgICAgfQogICAgfQogICAgdmFyIHRtcCA9IHRoaXMuZGVwSWRzOwogICAgdGhpcy5kZXBJZHMgPSB0aGlzLm5ld0RlcElkczsKICAgIHRoaXMubmV3RGVwSWRzID0gdG1wOwogICAgdGhpcy5uZXdEZXBJZHMuY2xlYXIoKTsKICAgIHRtcCA9IHRoaXMuZGVwczsKICAgIHRoaXMuZGVwcyA9IHRoaXMubmV3RGVwczsKICAgIHRoaXMubmV3RGVwcyA9IHRtcDsKICAgIHRoaXMubmV3RGVwcy5sZW5ndGggPSAwOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZXIgaW50ZXJmYWNlLgogICAqIFdpbGwgYmUgY2FsbGVkIHdoZW4gYSBkZXBlbmRlbmN5IGNoYW5nZXMuCiAgICovCiAgV2F0Y2hlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlICgpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAodGhpcy5sYXp5KSB7CiAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgfSBlbHNlIGlmICh0aGlzLnN5bmMpIHsKICAgICAgdGhpcy5ydW4oKTsKICAgIH0gZWxzZSB7CiAgICAgIHF1ZXVlV2F0Y2hlcih0aGlzKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTY2hlZHVsZXIgam9iIGludGVyZmFjZS4KICAgKiBXaWxsIGJlIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIHJ1biAoKSB7CiAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5nZXQoKTsKICAgICAgaWYgKAogICAgICAgIHZhbHVlICE9PSB0aGlzLnZhbHVlIHx8CiAgICAgICAgLy8gRGVlcCB3YXRjaGVycyBhbmQgd2F0Y2hlcnMgb24gT2JqZWN0L0FycmF5cyBzaG91bGQgZmlyZSBldmVuCiAgICAgICAgLy8gd2hlbiB0aGUgdmFsdWUgaXMgdGhlIHNhbWUsIGJlY2F1c2UgdGhlIHZhbHVlIG1heQogICAgICAgIC8vIGhhdmUgbXV0YXRlZC4KICAgICAgICBpc09iamVjdCh2YWx1ZSkgfHwKICAgICAgICB0aGlzLmRlZXAKICAgICAgKSB7CiAgICAgICAgLy8gc2V0IG5ldyB2YWx1ZQogICAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMudmFsdWU7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIGlmICh0aGlzLnVzZXIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMuY2IuY2FsbCh0aGlzLnZtLCB2YWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBoYW5kbGVFcnJvcihlLCB0aGlzLnZtLCAoImNhbGxiYWNrIGZvciB3YXRjaGVyIFwiIiArICh0aGlzLmV4cHJlc3Npb24pICsgIlwiIikpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNiLmNhbGwodGhpcy52bSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBFdmFsdWF0ZSB0aGUgdmFsdWUgb2YgdGhlIHdhdGNoZXIuCiAgICogVGhpcyBvbmx5IGdldHMgY2FsbGVkIGZvciBsYXp5IHdhdGNoZXJzLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUgKCkgewogICAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CiAgfTsKCiAgLyoqCiAgICogRGVwZW5kIG9uIGFsbCBkZXBzIGNvbGxlY3RlZCBieSB0aGlzIHdhdGNoZXIuCiAgICovCiAgV2F0Y2hlci5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gZGVwZW5kICgpIHsKICAgIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdGhpcy5kZXBzW2ldLmRlcGVuZCgpOwogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBzZWxmIGZyb20gYWxsIGRlcGVuZGVuY2llcycgc3Vic2NyaWJlciBsaXN0LgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gdGVhcmRvd24gKCkgewogICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgIC8vIHJlbW92ZSBzZWxmIGZyb20gdm0ncyB3YXRjaGVyIGxpc3QKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IGV4cGVuc2l2ZSBvcGVyYXRpb24gc28gd2Ugc2tpcCBpdAogICAgICAvLyBpZiB0aGUgdm0gaXMgYmVpbmcgZGVzdHJveWVkLgogICAgICBpZiAoIXRoaXMudm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgICByZW1vdmUodGhpcy52bS5fd2F0Y2hlcnMsIHRoaXMpOwogICAgICB9CiAgICAgIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKICAgICAgd2hpbGUgKGktLSkgewogICAgICAgIHRoaXMuZGVwc1tpXS5yZW1vdmVTdWIodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgIH0KICB9OwoKICAvKiAgKi8KCiAgdmFyIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbiA9IHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IG5vb3AsCiAgICBzZXQ6IG5vb3AKICB9OwoKICBmdW5jdGlvbiBwcm94eSAodGFyZ2V0LCBzb3VyY2VLZXksIGtleSkgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IGZ1bmN0aW9uIHByb3h5R2V0dGVyICgpIHsKICAgICAgcmV0dXJuIHRoaXNbc291cmNlS2V5XVtrZXldCiAgICB9OwogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uIHByb3h5U2V0dGVyICh2YWwpIHsKICAgICAgdGhpc1tzb3VyY2VLZXldW2tleV0gPSB2YWw7CiAgICB9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24pOwogIH0KCiAgZnVuY3Rpb24gaW5pdFN0YXRlICh2bSkgewogICAgdm0uX3dhdGNoZXJzID0gW107CiAgICB2YXIgb3B0cyA9IHZtLiRvcHRpb25zOwogICAgaWYgKG9wdHMucHJvcHMpIHsgaW5pdFByb3BzKHZtLCBvcHRzLnByb3BzKTsgfQogICAgaWYgKG9wdHMubWV0aG9kcykgeyBpbml0TWV0aG9kcyh2bSwgb3B0cy5tZXRob2RzKTsgfQogICAgaWYgKG9wdHMuZGF0YSkgewogICAgICBpbml0RGF0YSh2bSk7CiAgICB9IGVsc2UgewogICAgICBvYnNlcnZlKHZtLl9kYXRhID0ge30sIHRydWUgLyogYXNSb290RGF0YSAqLyk7CiAgICB9CiAgICBpZiAob3B0cy5jb21wdXRlZCkgeyBpbml0Q29tcHV0ZWQodm0sIG9wdHMuY29tcHV0ZWQpOyB9CiAgICBpZiAob3B0cy53YXRjaCAmJiBvcHRzLndhdGNoICE9PSBuYXRpdmVXYXRjaCkgewogICAgICBpbml0V2F0Y2godm0sIG9wdHMud2F0Y2gpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdFByb3BzICh2bSwgcHJvcHNPcHRpb25zKSB7CiAgICB2YXIgcHJvcHNEYXRhID0gdm0uJG9wdGlvbnMucHJvcHNEYXRhIHx8IHt9OwogICAgdmFyIHByb3BzID0gdm0uX3Byb3BzID0ge307CiAgICAvLyBjYWNoZSBwcm9wIGtleXMgc28gdGhhdCBmdXR1cmUgcHJvcHMgdXBkYXRlcyBjYW4gaXRlcmF0ZSB1c2luZyBBcnJheQogICAgLy8gaW5zdGVhZCBvZiBkeW5hbWljIG9iamVjdCBrZXkgZW51bWVyYXRpb24uCiAgICB2YXIga2V5cyA9IHZtLiRvcHRpb25zLl9wcm9wS2V5cyA9IFtdOwogICAgdmFyIGlzUm9vdCA9ICF2bS4kcGFyZW50OwogICAgLy8gcm9vdCBpbnN0YW5jZSBwcm9wcyBzaG91bGQgYmUgY29udmVydGVkCiAgICBpZiAoIWlzUm9vdCkgewogICAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogICAgfQogICAgdmFyIGxvb3AgPSBmdW5jdGlvbiAoIGtleSApIHsKICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgIHZhciB2YWx1ZSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BzT3B0aW9ucywgcHJvcHNEYXRhLCB2bSk7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgIHsKICAgICAgICB2YXIgaHlwaGVuYXRlZEtleSA9IGh5cGhlbmF0ZShrZXkpOwogICAgICAgIGlmIChpc1Jlc2VydmVkQXR0cmlidXRlKGh5cGhlbmF0ZWRLZXkpIHx8CiAgICAgICAgICAgIGNvbmZpZy5pc1Jlc2VydmVkQXR0cihoeXBoZW5hdGVkS2V5KSkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgKCJcIiIgKyBoeXBoZW5hdGVkS2V5ICsgIlwiIGlzIGEgcmVzZXJ2ZWQgYXR0cmlidXRlIGFuZCBjYW5ub3QgYmUgdXNlZCBhcyBjb21wb25lbnQgcHJvcC4iKSwKICAgICAgICAgICAgdm0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHByb3BzLCBrZXksIHZhbHVlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoIWlzUm9vdCAmJiAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICAgIkF2b2lkIG11dGF0aW5nIGEgcHJvcCBkaXJlY3RseSBzaW5jZSB0aGUgdmFsdWUgd2lsbCBiZSAiICsKICAgICAgICAgICAgICAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHBhcmVudCBjb21wb25lbnQgcmUtcmVuZGVycy4gIiArCiAgICAgICAgICAgICAgIkluc3RlYWQsIHVzZSBhIGRhdGEgb3IgY29tcHV0ZWQgcHJvcGVydHkgYmFzZWQgb24gdGhlIHByb3AncyAiICsKICAgICAgICAgICAgICAidmFsdWUuIFByb3AgYmVpbmcgbXV0YXRlZDogXCIiICsga2V5ICsgIlwiIiwKICAgICAgICAgICAgICB2bQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vIHN0YXRpYyBwcm9wcyBhcmUgYWxyZWFkeSBwcm94aWVkIG9uIHRoZSBjb21wb25lbnQncyBwcm90b3R5cGUKICAgICAgLy8gZHVyaW5nIFZ1ZS5leHRlbmQoKS4gV2Ugb25seSBuZWVkIHRvIHByb3h5IHByb3BzIGRlZmluZWQgYXQKICAgICAgLy8gaW5zdGFudGlhdGlvbiBoZXJlLgogICAgICBpZiAoIShrZXkgaW4gdm0pKSB7CiAgICAgICAgcHJveHkodm0sICJfcHJvcHMiLCBrZXkpOwogICAgICB9CiAgICB9OwoKICAgIGZvciAodmFyIGtleSBpbiBwcm9wc09wdGlvbnMpIGxvb3AoIGtleSApOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwogIH0KCiAgZnVuY3Rpb24gaW5pdERhdGEgKHZtKSB7CiAgICB2YXIgZGF0YSA9IHZtLiRvcHRpb25zLmRhdGE7CiAgICBkYXRhID0gdm0uX2RhdGEgPSB0eXBlb2YgZGF0YSA9PT0gJ2Z1bmN0aW9uJwogICAgICA/IGdldERhdGEoZGF0YSwgdm0pCiAgICAgIDogZGF0YSB8fCB7fTsKICAgIGlmICghaXNQbGFpbk9iamVjdChkYXRhKSkgewogICAgICBkYXRhID0ge307CiAgICAgIHdhcm4oCiAgICAgICAgJ2RhdGEgZnVuY3Rpb25zIHNob3VsZCByZXR1cm4gYW4gb2JqZWN0OlxuJyArCiAgICAgICAgJ2h0dHBzOi8vdnVlanMub3JnL3YyL2d1aWRlL2NvbXBvbmVudHMuaHRtbCNkYXRhLU11c3QtQmUtYS1GdW5jdGlvbicsCiAgICAgICAgdm0KICAgICAgKTsKICAgIH0KICAgIC8vIHByb3h5IGRhdGEgb24gaW5zdGFuY2UKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZGF0YSk7CiAgICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKICAgIHZhciBtZXRob2RzID0gdm0uJG9wdGlvbnMubWV0aG9kczsKICAgIHZhciBpID0ga2V5cy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICB7CiAgICAgICAgaWYgKG1ldGhvZHMgJiYgaGFzT3duKG1ldGhvZHMsIGtleSkpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICgiTWV0aG9kIFwiIiArIGtleSArICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBkYXRhIHByb3BlcnR5LiIpLAogICAgICAgICAgICB2bQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHByb3BzICYmIGhhc093bihwcm9wcywga2V5KSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAiVGhlIGRhdGEgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIGlzIGFscmVhZHkgZGVjbGFyZWQgYXMgYSBwcm9wLiAiICsKICAgICAgICAgICJVc2UgcHJvcCBkZWZhdWx0IHZhbHVlIGluc3RlYWQuIiwKICAgICAgICAgIHZtCiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgICAgcHJveHkodm0sICJfZGF0YSIsIGtleSk7CiAgICAgIH0KICAgIH0KICAgIC8vIG9ic2VydmUgZGF0YQogICAgb2JzZXJ2ZShkYXRhLCB0cnVlIC8qIGFzUm9vdERhdGEgKi8pOwogIH0KCiAgZnVuY3Rpb24gZ2V0RGF0YSAoZGF0YSwgdm0pIHsKICAgIC8vICM3NTczIGRpc2FibGUgZGVwIGNvbGxlY3Rpb24gd2hlbiBpbnZva2luZyBkYXRhIGdldHRlcnMKICAgIHB1c2hUYXJnZXQoKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiBkYXRhLmNhbGwodm0sIHZtKQogICAgfSBjYXRjaCAoZSkgewogICAgICBoYW5kbGVFcnJvcihlLCB2bSwgImRhdGEoKSIpOwogICAgICByZXR1cm4ge30KICAgIH0gZmluYWxseSB7CiAgICAgIHBvcFRhcmdldCgpOwogICAgfQogIH0KCiAgdmFyIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMgPSB7IGxhenk6IHRydWUgfTsKCiAgZnVuY3Rpb24gaW5pdENvbXB1dGVkICh2bSwgY29tcHV0ZWQpIHsKICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgdmFyIHdhdGNoZXJzID0gdm0uX2NvbXB1dGVkV2F0Y2hlcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgLy8gY29tcHV0ZWQgcHJvcGVydGllcyBhcmUganVzdCBnZXR0ZXJzIGR1cmluZyBTU1IKICAgIHZhciBpc1NTUiA9IGlzU2VydmVyUmVuZGVyaW5nKCk7CgogICAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICAgIHZhciB1c2VyRGVmID0gY29tcHV0ZWRba2V5XTsKICAgICAgdmFyIGdldHRlciA9IHR5cGVvZiB1c2VyRGVmID09PSAnZnVuY3Rpb24nID8gdXNlckRlZiA6IHVzZXJEZWYuZ2V0OwogICAgICBpZiAoZ2V0dGVyID09IG51bGwpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgKCJHZXR0ZXIgaXMgbWlzc2luZyBmb3IgY29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiLiIpLAogICAgICAgICAgdm0KICAgICAgICApOwogICAgICB9CgogICAgICBpZiAoIWlzU1NSKSB7CiAgICAgICAgLy8gY3JlYXRlIGludGVybmFsIHdhdGNoZXIgZm9yIHRoZSBjb21wdXRlZCBwcm9wZXJ0eS4KICAgICAgICB3YXRjaGVyc1trZXldID0gbmV3IFdhdGNoZXIoCiAgICAgICAgICB2bSwKICAgICAgICAgIGdldHRlciB8fCBub29wLAogICAgICAgICAgbm9vcCwKICAgICAgICAgIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMKICAgICAgICApOwogICAgICB9CgogICAgICAvLyBjb21wb25lbnQtZGVmaW5lZCBjb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBhbHJlYWR5IGRlZmluZWQgb24gdGhlCiAgICAgIC8vIGNvbXBvbmVudCBwcm90b3R5cGUuIFdlIG9ubHkgbmVlZCB0byBkZWZpbmUgY29tcHV0ZWQgcHJvcGVydGllcyBkZWZpbmVkCiAgICAgIC8vIGF0IGluc3RhbnRpYXRpb24gaGVyZS4KICAgICAgaWYgKCEoa2V5IGluIHZtKSkgewogICAgICAgIGRlZmluZUNvbXB1dGVkKHZtLCBrZXksIHVzZXJEZWYpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChrZXkgaW4gdm0uJGRhdGEpIHsKICAgICAgICAgIHdhcm4oKCJUaGUgY29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIGlzIGFscmVhZHkgZGVmaW5lZCBpbiBkYXRhLiIpLCB2bSk7CiAgICAgICAgfSBlbHNlIGlmICh2bS4kb3B0aW9ucy5wcm9wcyAmJiBrZXkgaW4gdm0uJG9wdGlvbnMucHJvcHMpIHsKICAgICAgICAgIHdhcm4oKCJUaGUgY29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIGlzIGFscmVhZHkgZGVmaW5lZCBhcyBhIHByb3AuIiksIHZtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGRlZmluZUNvbXB1dGVkICgKICAgIHRhcmdldCwKICAgIGtleSwKICAgIHVzZXJEZWYKICApIHsKICAgIHZhciBzaG91bGRDYWNoZSA9ICFpc1NlcnZlclJlbmRlcmluZygpOwogICAgaWYgKHR5cGVvZiB1c2VyRGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSBzaG91bGRDYWNoZQogICAgICAgID8gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIoa2V5KQogICAgICAgIDogY3JlYXRlR2V0dGVySW52b2tlcih1c2VyRGVmKTsKICAgICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IG5vb3A7CiAgICB9IGVsc2UgewogICAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gdXNlckRlZi5nZXQKICAgICAgICA/IHNob3VsZENhY2hlICYmIHVzZXJEZWYuY2FjaGUgIT09IGZhbHNlCiAgICAgICAgICA/IGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkKICAgICAgICAgIDogY3JlYXRlR2V0dGVySW52b2tlcih1c2VyRGVmLmdldCkKICAgICAgICA6IG5vb3A7CiAgICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSB1c2VyRGVmLnNldCB8fCBub29wOwogICAgfQogICAgaWYgKHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPT09IG5vb3ApIHsKICAgICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgKCJDb21wdXRlZCBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgd2FzIGFzc2lnbmVkIHRvIGJ1dCBpdCBoYXMgbm8gc2V0dGVyLiIpLAogICAgICAgICAgdGhpcwogICAgICAgICk7CiAgICAgIH07CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDb21wdXRlZEdldHRlciAoa2V5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gY29tcHV0ZWRHZXR0ZXIgKCkgewogICAgICB2YXIgd2F0Y2hlciA9IHRoaXMuX2NvbXB1dGVkV2F0Y2hlcnMgJiYgdGhpcy5fY29tcHV0ZWRXYXRjaGVyc1trZXldOwogICAgICBpZiAod2F0Y2hlcikgewogICAgICAgIGlmICh3YXRjaGVyLmRpcnR5KSB7CiAgICAgICAgICB3YXRjaGVyLmV2YWx1YXRlKCk7CiAgICAgICAgfQogICAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgICB3YXRjaGVyLmRlcGVuZCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gd2F0Y2hlci52YWx1ZQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVHZXR0ZXJJbnZva2VyKGZuKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gY29tcHV0ZWRHZXR0ZXIgKCkgewogICAgICByZXR1cm4gZm4uY2FsbCh0aGlzLCB0aGlzKQogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdE1ldGhvZHMgKHZtLCBtZXRob2RzKSB7CiAgICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKICAgIGZvciAodmFyIGtleSBpbiBtZXRob2RzKSB7CiAgICAgIHsKICAgICAgICBpZiAodHlwZW9mIG1ldGhvZHNba2V5XSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIHR5cGUgXCIiICsgKHR5cGVvZiBtZXRob2RzW2tleV0pICsgIlwiIGluIHRoZSBjb21wb25lbnQgZGVmaW5pdGlvbi4gIiArCiAgICAgICAgICAgICJEaWQgeW91IHJlZmVyZW5jZSB0aGUgZnVuY3Rpb24gY29ycmVjdGx5PyIsCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAocHJvcHMgJiYgaGFzT3duKHByb3BzLCBrZXkpKSB7CiAgICAgICAgICB3YXJuKAogICAgICAgICAgICAoIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGFzIGEgcHJvcC4iKSwKICAgICAgICAgICAgdm0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmICgoa2V5IGluIHZtKSAmJiBpc1Jlc2VydmVkKGtleSkpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICJNZXRob2QgXCIiICsga2V5ICsgIlwiIGNvbmZsaWN0cyB3aXRoIGFuIGV4aXN0aW5nIFZ1ZSBpbnN0YW5jZSBtZXRob2QuICIgKwogICAgICAgICAgICAiQXZvaWQgZGVmaW5pbmcgY29tcG9uZW50IG1ldGhvZHMgdGhhdCBzdGFydCB3aXRoIF8gb3IgJC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICB2bVtrZXldID0gdHlwZW9mIG1ldGhvZHNba2V5XSAhPT0gJ2Z1bmN0aW9uJyA/IG5vb3AgOiBiaW5kKG1ldGhvZHNba2V5XSwgdm0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdFdhdGNoICh2bSwgd2F0Y2gpIHsKICAgIGZvciAodmFyIGtleSBpbiB3YXRjaCkgewogICAgICB2YXIgaGFuZGxlciA9IHdhdGNoW2tleV07CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGhhbmRsZXIpKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYW5kbGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjcmVhdGVXYXRjaGVyKHZtLCBrZXksIGhhbmRsZXJbaV0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjcmVhdGVXYXRjaGVyKHZtLCBrZXksIGhhbmRsZXIpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVXYXRjaGVyICgKICAgIHZtLAogICAgZXhwT3JGbiwKICAgIGhhbmRsZXIsCiAgICBvcHRpb25zCiAgKSB7CiAgICBpZiAoaXNQbGFpbk9iamVjdChoYW5kbGVyKSkgewogICAgICBvcHRpb25zID0gaGFuZGxlcjsKICAgICAgaGFuZGxlciA9IGhhbmRsZXIuaGFuZGxlcjsKICAgIH0KICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ3N0cmluZycpIHsKICAgICAgaGFuZGxlciA9IHZtW2hhbmRsZXJdOwogICAgfQogICAgcmV0dXJuIHZtLiR3YXRjaChleHBPckZuLCBoYW5kbGVyLCBvcHRpb25zKQogIH0KCiAgZnVuY3Rpb24gc3RhdGVNaXhpbiAoVnVlKSB7CiAgICAvLyBmbG93IHNvbWVob3cgaGFzIHByb2JsZW1zIHdpdGggZGlyZWN0bHkgZGVjbGFyZWQgZGVmaW5pdGlvbiBvYmplY3QKICAgIC8vIHdoZW4gdXNpbmcgT2JqZWN0LmRlZmluZVByb3BlcnR5LCBzbyB3ZSBoYXZlIHRvIHByb2NlZHVyYWxseSBidWlsZCB1cAogICAgLy8gdGhlIG9iamVjdCBoZXJlLgogICAgdmFyIGRhdGFEZWYgPSB7fTsKICAgIGRhdGFEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcy5fZGF0YSB9OwogICAgdmFyIHByb3BzRGVmID0ge307CiAgICBwcm9wc0RlZi5nZXQgPSBmdW5jdGlvbiAoKSB7IHJldHVybiB0aGlzLl9wcm9wcyB9OwogICAgewogICAgICBkYXRhRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJ0F2b2lkIHJlcGxhY2luZyBpbnN0YW5jZSByb290ICRkYXRhLiAnICsKICAgICAgICAgICdVc2UgbmVzdGVkIGRhdGEgcHJvcGVydGllcyBpbnN0ZWFkLicsCiAgICAgICAgICB0aGlzCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgcHJvcHNEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHdhcm4oIiRwcm9wcyBpcyByZWFkb25seS4iLCB0aGlzKTsKICAgICAgfTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGRhdGEnLCBkYXRhRGVmKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHByb3BzJywgcHJvcHNEZWYpOwoKICAgIFZ1ZS5wcm90b3R5cGUuJHNldCA9IHNldDsKICAgIFZ1ZS5wcm90b3R5cGUuJGRlbGV0ZSA9IGRlbDsKCiAgICBWdWUucHJvdG90eXBlLiR3YXRjaCA9IGZ1bmN0aW9uICgKICAgICAgZXhwT3JGbiwKICAgICAgY2IsCiAgICAgIG9wdGlvbnMKICAgICkgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICBpZiAoaXNQbGFpbk9iamVjdChjYikpIHsKICAgICAgICByZXR1cm4gY3JlYXRlV2F0Y2hlcih2bSwgZXhwT3JGbiwgY2IsIG9wdGlvbnMpCiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIG9wdGlvbnMudXNlciA9IHRydWU7CiAgICAgIHZhciB3YXRjaGVyID0gbmV3IFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMuaW1tZWRpYXRlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNiLmNhbGwodm0sIHdhdGNoZXIudmFsdWUpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlcnJvciwgdm0sICgiY2FsbGJhY2sgZm9yIGltbWVkaWF0ZSB3YXRjaGVyIFwiIiArICh3YXRjaGVyLmV4cHJlc3Npb24pICsgIlwiIikpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gdW53YXRjaEZuICgpIHsKICAgICAgICB3YXRjaGVyLnRlYXJkb3duKCk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKiAgKi8KCiAgdmFyIHVpZCQzID0gMDsKCiAgZnVuY3Rpb24gaW5pdE1peGluIChWdWUpIHsKICAgIFZ1ZS5wcm90b3R5cGUuX2luaXQgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICAvLyBhIHVpZAogICAgICB2bS5fdWlkID0gdWlkJDMrKzsKCiAgICAgIHZhciBzdGFydFRhZywgZW5kVGFnOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgICAgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6IiArICh2bS5fdWlkKTsKICAgICAgICBlbmRUYWcgPSAidnVlLXBlcmYtZW5kOiIgKyAodm0uX3VpZCk7CiAgICAgICAgbWFyayhzdGFydFRhZyk7CiAgICAgIH0KCiAgICAgIC8vIGEgZmxhZyB0byBhdm9pZCB0aGlzIGJlaW5nIG9ic2VydmVkCiAgICAgIHZtLl9pc1Z1ZSA9IHRydWU7CiAgICAgIC8vIG1lcmdlIG9wdGlvbnMKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5faXNDb21wb25lbnQpIHsKICAgICAgICAvLyBvcHRpbWl6ZSBpbnRlcm5hbCBjb21wb25lbnQgaW5zdGFudGlhdGlvbgogICAgICAgIC8vIHNpbmNlIGR5bmFtaWMgb3B0aW9ucyBtZXJnaW5nIGlzIHByZXR0eSBzbG93LCBhbmQgbm9uZSBvZiB0aGUKICAgICAgICAvLyBpbnRlcm5hbCBjb21wb25lbnQgb3B0aW9ucyBuZWVkcyBzcGVjaWFsIHRyZWF0bWVudC4KICAgICAgICBpbml0SW50ZXJuYWxDb21wb25lbnQodm0sIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHZtLiRvcHRpb25zID0gbWVyZ2VPcHRpb25zKAogICAgICAgICAgcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyh2bS5jb25zdHJ1Y3RvciksCiAgICAgICAgICBvcHRpb25zIHx8IHt9LAogICAgICAgICAgdm0KICAgICAgICApOwogICAgICB9CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgIHsKICAgICAgICBpbml0UHJveHkodm0pOwogICAgICB9CiAgICAgIC8vIGV4cG9zZSByZWFsIHNlbGYKICAgICAgdm0uX3NlbGYgPSB2bTsKICAgICAgaW5pdExpZmVjeWNsZSh2bSk7CiAgICAgIGluaXRFdmVudHModm0pOwogICAgICBpbml0UmVuZGVyKHZtKTsKICAgICAgY2FsbEhvb2sodm0sICdiZWZvcmVDcmVhdGUnKTsKICAgICAgaW5pdEluamVjdGlvbnModm0pOyAvLyByZXNvbHZlIGluamVjdGlvbnMgYmVmb3JlIGRhdGEvcHJvcHMKICAgICAgaW5pdFN0YXRlKHZtKTsKICAgICAgaW5pdFByb3ZpZGUodm0pOyAvLyByZXNvbHZlIHByb3ZpZGUgYWZ0ZXIgZGF0YS9wcm9wcwogICAgICBjYWxsSG9vayh2bSwgJ2NyZWF0ZWQnKTsKCiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgICB2bS5fbmFtZSA9IGZvcm1hdENvbXBvbmVudE5hbWUodm0sIGZhbHNlKTsKICAgICAgICBtYXJrKGVuZFRhZyk7CiAgICAgICAgbWVhc3VyZSgoInZ1ZSAiICsgKHZtLl9uYW1lKSArICIgaW5pdCIpLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgfQoKICAgICAgaWYgKHZtLiRvcHRpb25zLmVsKSB7CiAgICAgICAgdm0uJG1vdW50KHZtLiRvcHRpb25zLmVsKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGluaXRJbnRlcm5hbENvbXBvbmVudCAodm0sIG9wdGlvbnMpIHsKICAgIHZhciBvcHRzID0gdm0uJG9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKHZtLmNvbnN0cnVjdG9yLm9wdGlvbnMpOwogICAgLy8gZG9pbmcgdGhpcyBiZWNhdXNlIGl0J3MgZmFzdGVyIHRoYW4gZHluYW1pYyBlbnVtZXJhdGlvbi4KICAgIHZhciBwYXJlbnRWbm9kZSA9IG9wdGlvbnMuX3BhcmVudFZub2RlOwogICAgb3B0cy5wYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKICAgIG9wdHMuX3BhcmVudFZub2RlID0gcGFyZW50Vm5vZGU7CgogICAgdmFyIHZub2RlQ29tcG9uZW50T3B0aW9ucyA9IHBhcmVudFZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgICBvcHRzLnByb3BzRGF0YSA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGE7CiAgICBvcHRzLl9wYXJlbnRMaXN0ZW5lcnMgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMubGlzdGVuZXJzOwogICAgb3B0cy5fcmVuZGVyQ2hpbGRyZW4gPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMuY2hpbGRyZW47CiAgICBvcHRzLl9jb21wb25lbnRUYWcgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMudGFnOwoKICAgIGlmIChvcHRpb25zLnJlbmRlcikgewogICAgICBvcHRzLnJlbmRlciA9IG9wdGlvbnMucmVuZGVyOwogICAgICBvcHRzLnN0YXRpY1JlbmRlckZucyA9IG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyAoQ3RvcikgewogICAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgICBpZiAoQ3Rvci5zdXBlcikgewogICAgICB2YXIgc3VwZXJPcHRpb25zID0gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yLnN1cGVyKTsKICAgICAgdmFyIGNhY2hlZFN1cGVyT3B0aW9ucyA9IEN0b3Iuc3VwZXJPcHRpb25zOwogICAgICBpZiAoc3VwZXJPcHRpb25zICE9PSBjYWNoZWRTdXBlck9wdGlvbnMpIHsKICAgICAgICAvLyBzdXBlciBvcHRpb24gY2hhbmdlZCwKICAgICAgICAvLyBuZWVkIHRvIHJlc29sdmUgbmV3IG9wdGlvbnMuCiAgICAgICAgQ3Rvci5zdXBlck9wdGlvbnMgPSBzdXBlck9wdGlvbnM7CiAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgYXJlIGFueSBsYXRlLW1vZGlmaWVkL2F0dGFjaGVkIG9wdGlvbnMgKCM0OTc2KQogICAgICAgIHZhciBtb2RpZmllZE9wdGlvbnMgPSByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpOwogICAgICAgIC8vIHVwZGF0ZSBiYXNlIGV4dGVuZCBvcHRpb25zCiAgICAgICAgaWYgKG1vZGlmaWVkT3B0aW9ucykgewogICAgICAgICAgZXh0ZW5kKEN0b3IuZXh0ZW5kT3B0aW9ucywgbW9kaWZpZWRPcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgb3B0aW9ucyA9IEN0b3Iub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhzdXBlck9wdGlvbnMsIEN0b3IuZXh0ZW5kT3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubmFtZSkgewogICAgICAgICAgb3B0aW9ucy5jb21wb25lbnRzW29wdGlvbnMubmFtZV0gPSBDdG9yOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG9wdGlvbnMKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVNb2RpZmllZE9wdGlvbnMgKEN0b3IpIHsKICAgIHZhciBtb2RpZmllZDsKICAgIHZhciBsYXRlc3QgPSBDdG9yLm9wdGlvbnM7CiAgICB2YXIgc2VhbGVkID0gQ3Rvci5zZWFsZWRPcHRpb25zOwogICAgZm9yICh2YXIga2V5IGluIGxhdGVzdCkgewogICAgICBpZiAobGF0ZXN0W2tleV0gIT09IHNlYWxlZFtrZXldKSB7CiAgICAgICAgaWYgKCFtb2RpZmllZCkgeyBtb2RpZmllZCA9IHt9OyB9CiAgICAgICAgbW9kaWZpZWRba2V5XSA9IGxhdGVzdFtrZXldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbW9kaWZpZWQKICB9CgogIGZ1bmN0aW9uIFZ1ZSAob3B0aW9ucykgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFZ1ZSkKICAgICkgewogICAgICB3YXJuKCdWdWUgaXMgYSBjb25zdHJ1Y3RvciBhbmQgc2hvdWxkIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkJyk7CiAgICB9CiAgICB0aGlzLl9pbml0KG9wdGlvbnMpOwogIH0KCiAgaW5pdE1peGluKFZ1ZSk7CiAgc3RhdGVNaXhpbihWdWUpOwogIGV2ZW50c01peGluKFZ1ZSk7CiAgbGlmZWN5Y2xlTWl4aW4oVnVlKTsKICByZW5kZXJNaXhpbihWdWUpOwoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdFVzZSAoVnVlKSB7CiAgICBWdWUudXNlID0gZnVuY3Rpb24gKHBsdWdpbikgewogICAgICB2YXIgaW5zdGFsbGVkUGx1Z2lucyA9ICh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zIHx8ICh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zID0gW10pKTsKICAgICAgaWYgKGluc3RhbGxlZFBsdWdpbnMuaW5kZXhPZihwbHVnaW4pID4gLTEpIHsKICAgICAgICByZXR1cm4gdGhpcwogICAgICB9CgogICAgICAvLyBhZGRpdGlvbmFsIHBhcmFtZXRlcnMKICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cywgMSk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzKTsKICAgICAgaWYgKHR5cGVvZiBwbHVnaW4uaW5zdGFsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHBsdWdpbi5pbnN0YWxsLmFwcGx5KHBsdWdpbiwgYXJncyk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHBsdWdpbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgfQogICAgICBpbnN0YWxsZWRQbHVnaW5zLnB1c2gocGx1Z2luKTsKICAgICAgcmV0dXJuIHRoaXMKICAgIH07CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdE1peGluJDEgKFZ1ZSkgewogICAgVnVlLm1peGluID0gZnVuY3Rpb24gKG1peGluKSB7CiAgICAgIHRoaXMub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyh0aGlzLm9wdGlvbnMsIG1peGluKTsKICAgICAgcmV0dXJuIHRoaXMKICAgIH07CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdEV4dGVuZCAoVnVlKSB7CiAgICAvKioKICAgICAqIEVhY2ggaW5zdGFuY2UgY29uc3RydWN0b3IsIGluY2x1ZGluZyBWdWUsIGhhcyBhIHVuaXF1ZQogICAgICogY2lkLiBUaGlzIGVuYWJsZXMgdXMgdG8gY3JlYXRlIHdyYXBwZWQgImNoaWxkCiAgICAgKiBjb25zdHJ1Y3RvcnMiIGZvciBwcm90b3R5cGFsIGluaGVyaXRhbmNlIGFuZCBjYWNoZSB0aGVtLgogICAgICovCiAgICBWdWUuY2lkID0gMDsKICAgIHZhciBjaWQgPSAxOwoKICAgIC8qKgogICAgICogQ2xhc3MgaW5oZXJpdGFuY2UKICAgICAqLwogICAgVnVlLmV4dGVuZCA9IGZ1bmN0aW9uIChleHRlbmRPcHRpb25zKSB7CiAgICAgIGV4dGVuZE9wdGlvbnMgPSBleHRlbmRPcHRpb25zIHx8IHt9OwogICAgICB2YXIgU3VwZXIgPSB0aGlzOwogICAgICB2YXIgU3VwZXJJZCA9IFN1cGVyLmNpZDsKICAgICAgdmFyIGNhY2hlZEN0b3JzID0gZXh0ZW5kT3B0aW9ucy5fQ3RvciB8fCAoZXh0ZW5kT3B0aW9ucy5fQ3RvciA9IHt9KTsKICAgICAgaWYgKGNhY2hlZEN0b3JzW1N1cGVySWRdKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlZEN0b3JzW1N1cGVySWRdCiAgICAgIH0KCiAgICAgIHZhciBuYW1lID0gZXh0ZW5kT3B0aW9ucy5uYW1lIHx8IFN1cGVyLm9wdGlvbnMubmFtZTsKICAgICAgaWYgKG5hbWUpIHsKICAgICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSk7CiAgICAgIH0KCiAgICAgIHZhciBTdWIgPSBmdW5jdGlvbiBWdWVDb21wb25lbnQgKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLl9pbml0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBTdWIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdXBlci5wcm90b3R5cGUpOwogICAgICBTdWIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3ViOwogICAgICBTdWIuY2lkID0gY2lkKys7CiAgICAgIFN1Yi5vcHRpb25zID0gbWVyZ2VPcHRpb25zKAogICAgICAgIFN1cGVyLm9wdGlvbnMsCiAgICAgICAgZXh0ZW5kT3B0aW9ucwogICAgICApOwogICAgICBTdWJbJ3N1cGVyJ10gPSBTdXBlcjsKCiAgICAgIC8vIEZvciBwcm9wcyBhbmQgY29tcHV0ZWQgcHJvcGVydGllcywgd2UgZGVmaW5lIHRoZSBwcm94eSBnZXR0ZXJzIG9uCiAgICAgIC8vIHRoZSBWdWUgaW5zdGFuY2VzIGF0IGV4dGVuc2lvbiB0aW1lLCBvbiB0aGUgZXh0ZW5kZWQgcHJvdG90eXBlLiBUaGlzCiAgICAgIC8vIGF2b2lkcyBPYmplY3QuZGVmaW5lUHJvcGVydHkgY2FsbHMgZm9yIGVhY2ggaW5zdGFuY2UgY3JlYXRlZC4KICAgICAgaWYgKFN1Yi5vcHRpb25zLnByb3BzKSB7CiAgICAgICAgaW5pdFByb3BzJDEoU3ViKTsKICAgICAgfQogICAgICBpZiAoU3ViLm9wdGlvbnMuY29tcHV0ZWQpIHsKICAgICAgICBpbml0Q29tcHV0ZWQkMShTdWIpOwogICAgICB9CgogICAgICAvLyBhbGxvdyBmdXJ0aGVyIGV4dGVuc2lvbi9taXhpbi9wbHVnaW4gdXNhZ2UKICAgICAgU3ViLmV4dGVuZCA9IFN1cGVyLmV4dGVuZDsKICAgICAgU3ViLm1peGluID0gU3VwZXIubWl4aW47CiAgICAgIFN1Yi51c2UgPSBTdXBlci51c2U7CgogICAgICAvLyBjcmVhdGUgYXNzZXQgcmVnaXN0ZXJzLCBzbyBleHRlbmRlZCBjbGFzc2VzCiAgICAgIC8vIGNhbiBoYXZlIHRoZWlyIHByaXZhdGUgYXNzZXRzIHRvby4KICAgICAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICAgIFN1Ylt0eXBlXSA9IFN1cGVyW3R5cGVdOwogICAgICB9KTsKICAgICAgLy8gZW5hYmxlIHJlY3Vyc2l2ZSBzZWxmLWxvb2t1cAogICAgICBpZiAobmFtZSkgewogICAgICAgIFN1Yi5vcHRpb25zLmNvbXBvbmVudHNbbmFtZV0gPSBTdWI7CiAgICAgIH0KCiAgICAgIC8vIGtlZXAgYSByZWZlcmVuY2UgdG8gdGhlIHN1cGVyIG9wdGlvbnMgYXQgZXh0ZW5zaW9uIHRpbWUuCiAgICAgIC8vIGxhdGVyIGF0IGluc3RhbnRpYXRpb24gd2UgY2FuIGNoZWNrIGlmIFN1cGVyJ3Mgb3B0aW9ucyBoYXZlCiAgICAgIC8vIGJlZW4gdXBkYXRlZC4KICAgICAgU3ViLnN1cGVyT3B0aW9ucyA9IFN1cGVyLm9wdGlvbnM7CiAgICAgIFN1Yi5leHRlbmRPcHRpb25zID0gZXh0ZW5kT3B0aW9uczsKICAgICAgU3ViLnNlYWxlZE9wdGlvbnMgPSBleHRlbmQoe30sIFN1Yi5vcHRpb25zKTsKCiAgICAgIC8vIGNhY2hlIGNvbnN0cnVjdG9yCiAgICAgIGNhY2hlZEN0b3JzW1N1cGVySWRdID0gU3ViOwogICAgICByZXR1cm4gU3ViCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaW5pdFByb3BzJDEgKENvbXApIHsKICAgIHZhciBwcm9wcyA9IENvbXAub3B0aW9ucy5wcm9wczsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICBwcm94eShDb21wLnByb3RvdHlwZSwgIl9wcm9wcyIsIGtleSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0Q29tcHV0ZWQkMSAoQ29tcCkgewogICAgdmFyIGNvbXB1dGVkID0gQ29tcC5vcHRpb25zLmNvbXB1dGVkOwogICAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICAgIGRlZmluZUNvbXB1dGVkKENvbXAucHJvdG90eXBlLCBrZXksIGNvbXB1dGVkW2tleV0pOwogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGluaXRBc3NldFJlZ2lzdGVycyAoVnVlKSB7CiAgICAvKioKICAgICAqIENyZWF0ZSBhc3NldCByZWdpc3RyYXRpb24gbWV0aG9kcy4KICAgICAqLwogICAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICBWdWVbdHlwZV0gPSBmdW5jdGlvbiAoCiAgICAgICAgaWQsCiAgICAgICAgZGVmaW5pdGlvbgogICAgICApIHsKICAgICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnNbdHlwZSArICdzJ11baWRdCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgaWYgKHR5cGUgPT09ICdjb21wb25lbnQnKSB7CiAgICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShpZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gJ2NvbXBvbmVudCcgJiYgaXNQbGFpbk9iamVjdChkZWZpbml0aW9uKSkgewogICAgICAgICAgICBkZWZpbml0aW9uLm5hbWUgPSBkZWZpbml0aW9uLm5hbWUgfHwgaWQ7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB0aGlzLm9wdGlvbnMuX2Jhc2UuZXh0ZW5kKGRlZmluaXRpb24pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09ICdkaXJlY3RpdmUnICYmIHR5cGVvZiBkZWZpbml0aW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB7IGJpbmQ6IGRlZmluaXRpb24sIHVwZGF0ZTogZGVmaW5pdGlvbiB9OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXSA9IGRlZmluaXRpb247CiAgICAgICAgICByZXR1cm4gZGVmaW5pdGlvbgogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH0KCiAgLyogICovCgoKCiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZSAob3B0cykgewogICAgcmV0dXJuIG9wdHMgJiYgKG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcpCiAgfQoKICBmdW5jdGlvbiBtYXRjaGVzIChwYXR0ZXJuLCBuYW1lKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShwYXR0ZXJuKSkgewogICAgICByZXR1cm4gcGF0dGVybi5pbmRleE9mKG5hbWUpID4gLTEKICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdHRlcm4gPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBwYXR0ZXJuLnNwbGl0KCcsJykuaW5kZXhPZihuYW1lKSA+IC0xCiAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKHBhdHRlcm4pKSB7CiAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QobmFtZSkKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGZ1bmN0aW9uIHBydW5lQ2FjaGUgKGtlZXBBbGl2ZUluc3RhbmNlLCBmaWx0ZXIpIHsKICAgIHZhciBjYWNoZSA9IGtlZXBBbGl2ZUluc3RhbmNlLmNhY2hlOwogICAgdmFyIGtleXMgPSBrZWVwQWxpdmVJbnN0YW5jZS5rZXlzOwogICAgdmFyIF92bm9kZSA9IGtlZXBBbGl2ZUluc3RhbmNlLl92bm9kZTsKICAgIGZvciAodmFyIGtleSBpbiBjYWNoZSkgewogICAgICB2YXIgY2FjaGVkTm9kZSA9IGNhY2hlW2tleV07CiAgICAgIGlmIChjYWNoZWROb2RlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGNhY2hlZE5vZGUuY29tcG9uZW50T3B0aW9ucyk7CiAgICAgICAgaWYgKG5hbWUgJiYgIWZpbHRlcihuYW1lKSkgewogICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIF92bm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcnVuZUNhY2hlRW50cnkgKAogICAgY2FjaGUsCiAgICBrZXksCiAgICBrZXlzLAogICAgY3VycmVudAogICkgewogICAgdmFyIGNhY2hlZCQkMSA9IGNhY2hlW2tleV07CiAgICBpZiAoY2FjaGVkJCQxICYmICghY3VycmVudCB8fCBjYWNoZWQkJDEudGFnICE9PSBjdXJyZW50LnRhZykpIHsKICAgICAgY2FjaGVkJCQxLmNvbXBvbmVudEluc3RhbmNlLiRkZXN0cm95KCk7CiAgICB9CiAgICBjYWNoZVtrZXldID0gbnVsbDsKICAgIHJlbW92ZShrZXlzLCBrZXkpOwogIH0KCiAgdmFyIHBhdHRlcm5UeXBlcyA9IFtTdHJpbmcsIFJlZ0V4cCwgQXJyYXldOwoKICB2YXIgS2VlcEFsaXZlID0gewogICAgbmFtZTogJ2tlZXAtYWxpdmUnLAogICAgYWJzdHJhY3Q6IHRydWUsCgogICAgcHJvcHM6IHsKICAgICAgaW5jbHVkZTogcGF0dGVyblR5cGVzLAogICAgICBleGNsdWRlOiBwYXR0ZXJuVHlwZXMsCiAgICAgIG1heDogW1N0cmluZywgTnVtYmVyXQogICAgfSwKCiAgICBjcmVhdGVkOiBmdW5jdGlvbiBjcmVhdGVkICgpIHsKICAgICAgdGhpcy5jYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMua2V5cyA9IFtdOwogICAgfSwKCiAgICBkZXN0cm95ZWQ6IGZ1bmN0aW9uIGRlc3Ryb3llZCAoKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNhY2hlKSB7CiAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KHRoaXMuY2FjaGUsIGtleSwgdGhpcy5rZXlzKTsKICAgICAgfQogICAgfSwKCiAgICBtb3VudGVkOiBmdW5jdGlvbiBtb3VudGVkICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICB0aGlzLiR3YXRjaCgnaW5jbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIG1hdGNoZXModmFsLCBuYW1lKTsgfSk7CiAgICAgIH0pOwogICAgICB0aGlzLiR3YXRjaCgnZXhjbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuICFtYXRjaGVzKHZhbCwgbmFtZSk7IH0pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIgKCkgewogICAgICB2YXIgc2xvdCA9IHRoaXMuJHNsb3RzLmRlZmF1bHQ7CiAgICAgIHZhciB2bm9kZSA9IGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoc2xvdCk7CiAgICAgIHZhciBjb21wb25lbnRPcHRpb25zID0gdm5vZGUgJiYgdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgICAgaWYgKGNvbXBvbmVudE9wdGlvbnMpIHsKICAgICAgICAvLyBjaGVjayBwYXR0ZXJuCiAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGNvbXBvbmVudE9wdGlvbnMpOwogICAgICAgIHZhciByZWYgPSB0aGlzOwogICAgICAgIHZhciBpbmNsdWRlID0gcmVmLmluY2x1ZGU7CiAgICAgICAgdmFyIGV4Y2x1ZGUgPSByZWYuZXhjbHVkZTsKICAgICAgICBpZiAoCiAgICAgICAgICAvLyBub3QgaW5jbHVkZWQKICAgICAgICAgIChpbmNsdWRlICYmICghbmFtZSB8fCAhbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSkpIHx8CiAgICAgICAgICAvLyBleGNsdWRlZAogICAgICAgICAgKGV4Y2x1ZGUgJiYgbmFtZSAmJiBtYXRjaGVzKGV4Y2x1ZGUsIG5hbWUpKQogICAgICAgICkgewogICAgICAgICAgcmV0dXJuIHZub2RlCiAgICAgICAgfQoKICAgICAgICB2YXIgcmVmJDEgPSB0aGlzOwogICAgICAgIHZhciBjYWNoZSA9IHJlZiQxLmNhY2hlOwogICAgICAgIHZhciBrZXlzID0gcmVmJDEua2V5czsKICAgICAgICB2YXIga2V5ID0gdm5vZGUua2V5ID09IG51bGwKICAgICAgICAgIC8vIHNhbWUgY29uc3RydWN0b3IgbWF5IGdldCByZWdpc3RlcmVkIGFzIGRpZmZlcmVudCBsb2NhbCBjb21wb25lbnRzCiAgICAgICAgICAvLyBzbyBjaWQgYWxvbmUgaXMgbm90IGVub3VnaCAoIzMyNjkpCiAgICAgICAgICA/IGNvbXBvbmVudE9wdGlvbnMuQ3Rvci5jaWQgKyAoY29tcG9uZW50T3B0aW9ucy50YWcgPyAoIjo6IiArIChjb21wb25lbnRPcHRpb25zLnRhZykpIDogJycpCiAgICAgICAgICA6IHZub2RlLmtleTsKICAgICAgICBpZiAoY2FjaGVba2V5XSkgewogICAgICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjYWNoZVtrZXldLmNvbXBvbmVudEluc3RhbmNlOwogICAgICAgICAgLy8gbWFrZSBjdXJyZW50IGtleSBmcmVzaGVzdAogICAgICAgICAgcmVtb3ZlKGtleXMsIGtleSk7CiAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVba2V5XSA9IHZub2RlOwogICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAvLyBwcnVuZSBvbGRlc3QgZW50cnkKICAgICAgICAgIGlmICh0aGlzLm1heCAmJiBrZXlzLmxlbmd0aCA+IHBhcnNlSW50KHRoaXMubWF4KSkgewogICAgICAgICAgICBwcnVuZUNhY2hlRW50cnkoY2FjaGUsIGtleXNbMF0sIGtleXMsIHRoaXMuX3Zub2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZub2RlLmRhdGEua2VlcEFsaXZlID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdm5vZGUgfHwgKHNsb3QgJiYgc2xvdFswXSkKICAgIH0KICB9OwoKICB2YXIgYnVpbHRJbkNvbXBvbmVudHMgPSB7CiAgICBLZWVwQWxpdmU6IEtlZXBBbGl2ZQogIH07CgogIC8qICAqLwoKICBmdW5jdGlvbiBpbml0R2xvYmFsQVBJIChWdWUpIHsKICAgIC8vIGNvbmZpZwogICAgdmFyIGNvbmZpZ0RlZiA9IHt9OwogICAgY29uZmlnRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGNvbmZpZzsgfTsKICAgIHsKICAgICAgY29uZmlnRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJ0RvIG5vdCByZXBsYWNlIHRoZSBWdWUuY29uZmlnIG9iamVjdCwgc2V0IGluZGl2aWR1YWwgZmllbGRzIGluc3RlYWQuJwogICAgICAgICk7CiAgICAgIH07CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnY29uZmlnJywgY29uZmlnRGVmKTsKCiAgICAvLyBleHBvc2VkIHV0aWwgbWV0aG9kcy4KICAgIC8vIE5PVEU6IHRoZXNlIGFyZSBub3QgY29uc2lkZXJlZCBwYXJ0IG9mIHRoZSBwdWJsaWMgQVBJIC0gYXZvaWQgcmVseWluZyBvbgogICAgLy8gdGhlbSB1bmxlc3MgeW91IGFyZSBhd2FyZSBvZiB0aGUgcmlzay4KICAgIFZ1ZS51dGlsID0gewogICAgICB3YXJuOiB3YXJuLAogICAgICBleHRlbmQ6IGV4dGVuZCwKICAgICAgbWVyZ2VPcHRpb25zOiBtZXJnZU9wdGlvbnMsCiAgICAgIGRlZmluZVJlYWN0aXZlOiBkZWZpbmVSZWFjdGl2ZSQkMQogICAgfTsKCiAgICBWdWUuc2V0ID0gc2V0OwogICAgVnVlLmRlbGV0ZSA9IGRlbDsKICAgIFZ1ZS5uZXh0VGljayA9IG5leHRUaWNrOwoKICAgIC8vIDIuNiBleHBsaWNpdCBvYnNlcnZhYmxlIEFQSQogICAgVnVlLm9ic2VydmFibGUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgIG9ic2VydmUob2JqKTsKICAgICAgcmV0dXJuIG9iagogICAgfTsKCiAgICBWdWUub3B0aW9ucyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIFZ1ZS5vcHRpb25zW3R5cGUgKyAncyddID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0pOwoKICAgIC8vIHRoaXMgaXMgdXNlZCB0byBpZGVudGlmeSB0aGUgImJhc2UiIGNvbnN0cnVjdG9yIHRvIGV4dGVuZCBhbGwgcGxhaW4tb2JqZWN0CiAgICAvLyBjb21wb25lbnRzIHdpdGggaW4gV2VleCdzIG11bHRpLWluc3RhbmNlIHNjZW5hcmlvcy4KICAgIFZ1ZS5vcHRpb25zLl9iYXNlID0gVnVlOwoKICAgIGV4dGVuZChWdWUub3B0aW9ucy5jb21wb25lbnRzLCBidWlsdEluQ29tcG9uZW50cyk7CgogICAgaW5pdFVzZShWdWUpOwogICAgaW5pdE1peGluJDEoVnVlKTsKICAgIGluaXRFeHRlbmQoVnVlKTsKICAgIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpOwogIH0KCiAgaW5pdEdsb2JhbEFQSShWdWUpOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRpc1NlcnZlcicsIHsKICAgIGdldDogaXNTZXJ2ZXJSZW5kZXJpbmcKICB9KTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckc3NyQ29udGV4dCcsIHsKICAgIGdldDogZnVuY3Rpb24gZ2V0ICgpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgcmV0dXJuIHRoaXMuJHZub2RlICYmIHRoaXMuJHZub2RlLnNzckNvbnRleHQKICAgIH0KICB9KTsKCiAgLy8gZXhwb3NlIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0IGZvciBzc3IgcnVudGltZSBoZWxwZXIgaW5zdGFsbGF0aW9uCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZSwgJ0Z1bmN0aW9uYWxSZW5kZXJDb250ZXh0JywgewogICAgdmFsdWU6IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0CiAgfSk7CgogIFZ1ZS52ZXJzaW9uID0gJzIuNi4xMCc7CgogIC8qICAqLwoKICAvLyB0aGVzZSBhcmUgcmVzZXJ2ZWQgZm9yIHdlYiBiZWNhdXNlIHRoZXkgYXJlIGRpcmVjdGx5IGNvbXBpbGVkIGF3YXkKICAvLyBkdXJpbmcgdGVtcGxhdGUgY29tcGlsYXRpb24KICB2YXIgaXNSZXNlcnZlZEF0dHIgPSBtYWtlTWFwKCdzdHlsZSxjbGFzcycpOwoKICAvLyBhdHRyaWJ1dGVzIHRoYXQgc2hvdWxkIGJlIHVzaW5nIHByb3BzIGZvciBiaW5kaW5nCiAgdmFyIGFjY2VwdFZhbHVlID0gbWFrZU1hcCgnaW5wdXQsdGV4dGFyZWEsb3B0aW9uLHNlbGVjdCxwcm9ncmVzcycpOwogIHZhciBtdXN0VXNlUHJvcCA9IGZ1bmN0aW9uICh0YWcsIHR5cGUsIGF0dHIpIHsKICAgIHJldHVybiAoCiAgICAgIChhdHRyID09PSAndmFsdWUnICYmIGFjY2VwdFZhbHVlKHRhZykpICYmIHR5cGUgIT09ICdidXR0b24nIHx8CiAgICAgIChhdHRyID09PSAnc2VsZWN0ZWQnICYmIHRhZyA9PT0gJ29wdGlvbicpIHx8CiAgICAgIChhdHRyID09PSAnY2hlY2tlZCcgJiYgdGFnID09PSAnaW5wdXQnKSB8fAogICAgICAoYXR0ciA9PT0gJ211dGVkJyAmJiB0YWcgPT09ICd2aWRlbycpCiAgICApCiAgfTsKCiAgdmFyIGlzRW51bWVyYXRlZEF0dHIgPSBtYWtlTWFwKCdjb250ZW50ZWRpdGFibGUsZHJhZ2dhYmxlLHNwZWxsY2hlY2snKTsKCiAgdmFyIGlzVmFsaWRDb250ZW50RWRpdGFibGVWYWx1ZSA9IG1ha2VNYXAoJ2V2ZW50cyxjYXJldCx0eXBpbmcscGxhaW50ZXh0LW9ubHknKTsKCiAgdmFyIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpIHx8IHZhbHVlID09PSAnZmFsc2UnCiAgICAgID8gJ2ZhbHNlJwogICAgICAvLyBhbGxvdyBhcmJpdHJhcnkgc3RyaW5nIHZhbHVlIGZvciBjb250ZW50ZWRpdGFibGUKICAgICAgOiBrZXkgPT09ICdjb250ZW50ZWRpdGFibGUnICYmIGlzVmFsaWRDb250ZW50RWRpdGFibGVWYWx1ZSh2YWx1ZSkKICAgICAgICA/IHZhbHVlCiAgICAgICAgOiAndHJ1ZScKICB9OwoKICB2YXIgaXNCb29sZWFuQXR0ciA9IG1ha2VNYXAoCiAgICAnYWxsb3dmdWxsc2NyZWVuLGFzeW5jLGF1dG9mb2N1cyxhdXRvcGxheSxjaGVja2VkLGNvbXBhY3QsY29udHJvbHMsZGVjbGFyZSwnICsKICAgICdkZWZhdWx0LGRlZmF1bHRjaGVja2VkLGRlZmF1bHRtdXRlZCxkZWZhdWx0c2VsZWN0ZWQsZGVmZXIsZGlzYWJsZWQsJyArCiAgICAnZW5hYmxlZCxmb3Jtbm92YWxpZGF0ZSxoaWRkZW4saW5kZXRlcm1pbmF0ZSxpbmVydCxpc21hcCxpdGVtc2NvcGUsbG9vcCxtdWx0aXBsZSwnICsKICAgICdtdXRlZCxub2hyZWYsbm9yZXNpemUsbm9zaGFkZSxub3ZhbGlkYXRlLG5vd3JhcCxvcGVuLHBhdXNlb25leGl0LHJlYWRvbmx5LCcgKwogICAgJ3JlcXVpcmVkLHJldmVyc2VkLHNjb3BlZCxzZWFtbGVzcyxzZWxlY3RlZCxzb3J0YWJsZSx0cmFuc2xhdGUsJyArCiAgICAndHJ1ZXNwZWVkLHR5cGVtdXN0bWF0Y2gsdmlzaWJsZScKICApOwoKICB2YXIgeGxpbmtOUyA9ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJzsKCiAgdmFyIGlzWGxpbmsgPSBmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuIG5hbWUuY2hhckF0KDUpID09PSAnOicgJiYgbmFtZS5zbGljZSgwLCA1KSA9PT0gJ3hsaW5rJwogIH07CgogIHZhciBnZXRYbGlua1Byb3AgPSBmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuIGlzWGxpbmsobmFtZSkgPyBuYW1lLnNsaWNlKDYsIG5hbWUubGVuZ3RoKSA6ICcnCiAgfTsKCiAgdmFyIGlzRmFsc3lBdHRyVmFsdWUgPSBmdW5jdGlvbiAodmFsKSB7CiAgICByZXR1cm4gdmFsID09IG51bGwgfHwgdmFsID09PSBmYWxzZQogIH07CgogIC8qICAqLwoKICBmdW5jdGlvbiBnZW5DbGFzc0ZvclZub2RlICh2bm9kZSkgewogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKICAgIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKICAgIHdoaWxlIChpc0RlZihjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEpIHsKICAgICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoY2hpbGROb2RlLmRhdGEsIGRhdGEpOwogICAgICB9CiAgICB9CiAgICB3aGlsZSAoaXNEZWYocGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50KSkgewogICAgICBpZiAocGFyZW50Tm9kZSAmJiBwYXJlbnROb2RlLmRhdGEpIHsKICAgICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoZGF0YSwgcGFyZW50Tm9kZS5kYXRhKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlbmRlckNsYXNzKGRhdGEuc3RhdGljQ2xhc3MsIGRhdGEuY2xhc3MpCiAgfQoKICBmdW5jdGlvbiBtZXJnZUNsYXNzRGF0YSAoY2hpbGQsIHBhcmVudCkgewogICAgcmV0dXJuIHsKICAgICAgc3RhdGljQ2xhc3M6IGNvbmNhdChjaGlsZC5zdGF0aWNDbGFzcywgcGFyZW50LnN0YXRpY0NsYXNzKSwKICAgICAgY2xhc3M6IGlzRGVmKGNoaWxkLmNsYXNzKQogICAgICAgID8gW2NoaWxkLmNsYXNzLCBwYXJlbnQuY2xhc3NdCiAgICAgICAgOiBwYXJlbnQuY2xhc3MKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckNsYXNzICgKICAgIHN0YXRpY0NsYXNzLAogICAgZHluYW1pY0NsYXNzCiAgKSB7CiAgICBpZiAoaXNEZWYoc3RhdGljQ2xhc3MpIHx8IGlzRGVmKGR5bmFtaWNDbGFzcykpIHsKICAgICAgcmV0dXJuIGNvbmNhdChzdGF0aWNDbGFzcywgc3RyaW5naWZ5Q2xhc3MoZHluYW1pY0NsYXNzKSkKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICByZXR1cm4gJycKICB9CgogIGZ1bmN0aW9uIGNvbmNhdCAoYSwgYikgewogICAgcmV0dXJuIGEgPyBiID8gKGEgKyAnICcgKyBiKSA6IGEgOiAoYiB8fCAnJykKICB9CgogIGZ1bmN0aW9uIHN0cmluZ2lmeUNsYXNzICh2YWx1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHJldHVybiBzdHJpbmdpZnlBcnJheSh2YWx1ZSkKICAgIH0KICAgIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHN0cmluZ2lmeU9iamVjdCh2YWx1ZSkKICAgIH0KICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiB2YWx1ZQogICAgfQogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIHJldHVybiAnJwogIH0KCiAgZnVuY3Rpb24gc3RyaW5naWZ5QXJyYXkgKHZhbHVlKSB7CiAgICB2YXIgcmVzID0gJyc7CiAgICB2YXIgc3RyaW5naWZpZWQ7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBpZiAoaXNEZWYoc3RyaW5naWZpZWQgPSBzdHJpbmdpZnlDbGFzcyh2YWx1ZVtpXSkpICYmIHN0cmluZ2lmaWVkICE9PSAnJykgewogICAgICAgIGlmIChyZXMpIHsgcmVzICs9ICcgJzsgfQogICAgICAgIHJlcyArPSBzdHJpbmdpZmllZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gc3RyaW5naWZ5T2JqZWN0ICh2YWx1ZSkgewogICAgdmFyIHJlcyA9ICcnOwogICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZVtrZXldKSB7CiAgICAgICAgaWYgKHJlcykgeyByZXMgKz0gJyAnOyB9CiAgICAgICAgcmVzICs9IGtleTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgLyogICovCgogIHZhciBuYW1lc3BhY2VNYXAgPSB7CiAgICBzdmc6ICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycsCiAgICBtYXRoOiAnaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCcKICB9OwoKICB2YXIgaXNIVE1MVGFnID0gbWFrZU1hcCgKICAgICdodG1sLGJvZHksYmFzZSxoZWFkLGxpbmssbWV0YSxzdHlsZSx0aXRsZSwnICsKICAgICdhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoMSxoMixoMyxoNCxoNSxoNixoZ3JvdXAsbmF2LHNlY3Rpb24sJyArCiAgICAnZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sZmlndXJlLHBpY3R1cmUsaHIsaW1nLGxpLG1haW4sb2wscCxwcmUsdWwsJyArCiAgICAnYSxiLGFiYnIsYmRpLGJkbyxicixjaXRlLGNvZGUsZGF0YSxkZm4sZW0saSxrYmQsbWFyayxxLHJwLHJ0LHJ0YyxydWJ5LCcgKwogICAgJ3Msc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLCcgKwogICAgJ2VtYmVkLG9iamVjdCxwYXJhbSxzb3VyY2UsY2FudmFzLHNjcmlwdCxub3NjcmlwdCxkZWwsaW5zLCcgKwogICAgJ2NhcHRpb24sY29sLGNvbGdyb3VwLHRhYmxlLHRoZWFkLHRib2R5LHRkLHRoLHRyLCcgKwogICAgJ2J1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sJyArCiAgICAnb3V0cHV0LHByb2dyZXNzLHNlbGVjdCx0ZXh0YXJlYSwnICsKICAgICdkZXRhaWxzLGRpYWxvZyxtZW51LG1lbnVpdGVtLHN1bW1hcnksJyArCiAgICAnY29udGVudCxlbGVtZW50LHNoYWRvdyx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCcKICApOwoKICAvLyB0aGlzIG1hcCBpcyBpbnRlbnRpb25hbGx5IHNlbGVjdGl2ZSwgb25seSBjb3ZlcmluZyBTVkcgZWxlbWVudHMgdGhhdCBtYXkKICAvLyBjb250YWluIGNoaWxkIGVsZW1lbnRzLgogIHZhciBpc1NWRyA9IG1ha2VNYXAoCiAgICAnc3ZnLGFuaW1hdGUsY2lyY2xlLGNsaXBwYXRoLGN1cnNvcixkZWZzLGRlc2MsZWxsaXBzZSxmaWx0ZXIsZm9udC1mYWNlLCcgKwogICAgJ2ZvcmVpZ25PYmplY3QsZyxnbHlwaCxpbWFnZSxsaW5lLG1hcmtlcixtYXNrLG1pc3NpbmctZ2x5cGgscGF0aCxwYXR0ZXJuLCcgKwogICAgJ3BvbHlnb24scG9seWxpbmUscmVjdCxzd2l0Y2gsc3ltYm9sLHRleHQsdGV4dHBhdGgsdHNwYW4sdXNlLHZpZXcnLAogICAgdHJ1ZQogICk7CgogIHZhciBpc1ByZVRhZyA9IGZ1bmN0aW9uICh0YWcpIHsgcmV0dXJuIHRhZyA9PT0gJ3ByZSc7IH07CgogIHZhciBpc1Jlc2VydmVkVGFnID0gZnVuY3Rpb24gKHRhZykgewogICAgcmV0dXJuIGlzSFRNTFRhZyh0YWcpIHx8IGlzU1ZHKHRhZykKICB9OwoKICBmdW5jdGlvbiBnZXRUYWdOYW1lc3BhY2UgKHRhZykgewogICAgaWYgKGlzU1ZHKHRhZykpIHsKICAgICAgcmV0dXJuICdzdmcnCiAgICB9CiAgICAvLyBiYXNpYyBzdXBwb3J0IGZvciBNYXRoTUwKICAgIC8vIG5vdGUgaXQgZG9lc24ndCBzdXBwb3J0IG90aGVyIE1hdGhNTCBlbGVtZW50cyBiZWluZyBjb21wb25lbnQgcm9vdHMKICAgIGlmICh0YWcgPT09ICdtYXRoJykgewogICAgICByZXR1cm4gJ21hdGgnCiAgICB9CiAgfQoKICB2YXIgdW5rbm93bkVsZW1lbnRDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgZnVuY3Rpb24gaXNVbmtub3duRWxlbWVudCAodGFnKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICghaW5Ccm93c2VyKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CiAgICBpZiAoaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgdGFnID0gdGFnLnRvTG93ZXJDYXNlKCk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gIT0gbnVsbCkgewogICAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddCiAgICB9CiAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7CiAgICBpZiAodGFnLmluZGV4T2YoJy0nKSA+IC0xKSB7CiAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI4MjEwMzY0LzEwNzAyNDQKICAgICAgcmV0dXJuICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSAoCiAgICAgICAgZWwuY29uc3RydWN0b3IgPT09IHdpbmRvdy5IVE1MVW5rbm93bkVsZW1lbnQgfHwKICAgICAgICBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxFbGVtZW50CiAgICAgICkpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKHVua25vd25FbGVtZW50Q2FjaGVbdGFnXSA9IC9IVE1MVW5rbm93bkVsZW1lbnQvLnRlc3QoZWwudG9TdHJpbmcoKSkpCiAgICB9CiAgfQoKICB2YXIgaXNUZXh0SW5wdXRUeXBlID0gbWFrZU1hcCgndGV4dCxudW1iZXIscGFzc3dvcmQsc2VhcmNoLGVtYWlsLHRlbCx1cmwnKTsKCiAgLyogICovCgogIC8qKgogICAqIFF1ZXJ5IGFuIGVsZW1lbnQgc2VsZWN0b3IgaWYgaXQncyBub3QgYW4gZWxlbWVudCBhbHJlYWR5LgogICAqLwogIGZ1bmN0aW9uIHF1ZXJ5IChlbCkgewogICAgaWYgKHR5cGVvZiBlbCA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFyIHNlbGVjdGVkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlbCk7CiAgICAgIGlmICghc2VsZWN0ZWQpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJ0Nhbm5vdCBmaW5kIGVsZW1lbnQ6ICcgKyBlbAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGVjdGVkCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZWwKICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50JDEgKHRhZ05hbWUsIHZub2RlKSB7CiAgICB2YXIgZWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICAgIGlmICh0YWdOYW1lICE9PSAnc2VsZWN0JykgewogICAgICByZXR1cm4gZWxtCiAgICB9CiAgICAvLyBmYWxzZSBvciBudWxsIHdpbGwgcmVtb3ZlIHRoZSBhdHRyaWJ1dGUgYnV0IHVuZGVmaW5lZCB3aWxsIG5vdAogICAgaWYgKHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS5hdHRycyAmJiB2bm9kZS5kYXRhLmF0dHJzLm11bHRpcGxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgZWxtLnNldEF0dHJpYnV0ZSgnbXVsdGlwbGUnLCAnbXVsdGlwbGUnKTsKICAgIH0KICAgIHJldHVybiBlbG0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnROUyAobmFtZXNwYWNlLCB0YWdOYW1lKSB7CiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZU1hcFtuYW1lc3BhY2VdLCB0YWdOYW1lKQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUgKHRleHQpIHsKICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQ29tbWVudCAodGV4dCkgewogICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQodGV4dCkKICB9CgogIGZ1bmN0aW9uIGluc2VydEJlZm9yZSAocGFyZW50Tm9kZSwgbmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSkgewogICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVDaGlsZCAobm9kZSwgY2hpbGQpIHsKICAgIG5vZGUucmVtb3ZlQ2hpbGQoY2hpbGQpOwogIH0KCiAgZnVuY3Rpb24gYXBwZW5kQ2hpbGQgKG5vZGUsIGNoaWxkKSB7CiAgICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKICB9CgogIGZ1bmN0aW9uIHBhcmVudE5vZGUgKG5vZGUpIHsKICAgIHJldHVybiBub2RlLnBhcmVudE5vZGUKICB9CgogIGZ1bmN0aW9uIG5leHRTaWJsaW5nIChub2RlKSB7CiAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZwogIH0KCiAgZnVuY3Rpb24gdGFnTmFtZSAobm9kZSkgewogICAgcmV0dXJuIG5vZGUudGFnTmFtZQogIH0KCiAgZnVuY3Rpb24gc2V0VGV4dENvbnRlbnQgKG5vZGUsIHRleHQpIHsKICAgIG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0OwogIH0KCiAgZnVuY3Rpb24gc2V0U3R5bGVTY29wZSAobm9kZSwgc2NvcGVJZCkgewogICAgbm9kZS5zZXRBdHRyaWJ1dGUoc2NvcGVJZCwgJycpOwogIH0KCiAgdmFyIG5vZGVPcHMgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CiAgICBjcmVhdGVFbGVtZW50OiBjcmVhdGVFbGVtZW50JDEsCiAgICBjcmVhdGVFbGVtZW50TlM6IGNyZWF0ZUVsZW1lbnROUywKICAgIGNyZWF0ZVRleHROb2RlOiBjcmVhdGVUZXh0Tm9kZSwKICAgIGNyZWF0ZUNvbW1lbnQ6IGNyZWF0ZUNvbW1lbnQsCiAgICBpbnNlcnRCZWZvcmU6IGluc2VydEJlZm9yZSwKICAgIHJlbW92ZUNoaWxkOiByZW1vdmVDaGlsZCwKICAgIGFwcGVuZENoaWxkOiBhcHBlbmRDaGlsZCwKICAgIHBhcmVudE5vZGU6IHBhcmVudE5vZGUsCiAgICBuZXh0U2libGluZzogbmV4dFNpYmxpbmcsCiAgICB0YWdOYW1lOiB0YWdOYW1lLAogICAgc2V0VGV4dENvbnRlbnQ6IHNldFRleHRDb250ZW50LAogICAgc2V0U3R5bGVTY29wZTogc2V0U3R5bGVTY29wZQogIH0pOwoKICAvKiAgKi8KCiAgdmFyIHJlZiA9IHsKICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlIChfLCB2bm9kZSkgewogICAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgICB9LAogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUgKG9sZFZub2RlLCB2bm9kZSkgewogICAgICBpZiAob2xkVm5vZGUuZGF0YS5yZWYgIT09IHZub2RlLmRhdGEucmVmKSB7CiAgICAgICAgcmVnaXN0ZXJSZWYob2xkVm5vZGUsIHRydWUpOwogICAgICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsKICAgICAgfQogICAgfSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3kgKHZub2RlKSB7CiAgICAgIHJlZ2lzdGVyUmVmKHZub2RlLCB0cnVlKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiByZWdpc3RlclJlZiAodm5vZGUsIGlzUmVtb3ZhbCkgewogICAgdmFyIGtleSA9IHZub2RlLmRhdGEucmVmOwogICAgaWYgKCFpc0RlZihrZXkpKSB7IHJldHVybiB9CgogICAgdmFyIHZtID0gdm5vZGUuY29udGV4dDsKICAgIHZhciByZWYgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSB8fCB2bm9kZS5lbG07CiAgICB2YXIgcmVmcyA9IHZtLiRyZWZzOwogICAgaWYgKGlzUmVtb3ZhbCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZWZzW2tleV0pKSB7CiAgICAgICAgcmVtb3ZlKHJlZnNba2V5XSwgcmVmKTsKICAgICAgfSBlbHNlIGlmIChyZWZzW2tleV0gPT09IHJlZikgewogICAgICAgIHJlZnNba2V5XSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHZub2RlLmRhdGEucmVmSW5Gb3IpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVmc1trZXldKSkgewogICAgICAgICAgcmVmc1trZXldID0gW3JlZl07CiAgICAgICAgfSBlbHNlIGlmIChyZWZzW2tleV0uaW5kZXhPZihyZWYpIDwgMCkgewogICAgICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgICAgICByZWZzW2tleV0ucHVzaChyZWYpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZWZzW2tleV0gPSByZWY7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIFZpcnR1YWwgRE9NIHBhdGNoaW5nIGFsZ29yaXRobSBiYXNlZCBvbiBTbmFiYmRvbSBieQogICAqIFNpbW9uIEZyaWlzIFZpbmR1bSAoQHBhbGRlcGluZCkKICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UKICAgKiBodHRwczovL2dpdGh1Yi5jb20vcGFsZGVwaW5kL3NuYWJiZG9tL2Jsb2IvbWFzdGVyL0xJQ0VOU0UKICAgKgogICAqIG1vZGlmaWVkIGJ5IEV2YW4gWW91IChAeXl4OTkwODAzKQogICAqCiAgICogTm90IHR5cGUtY2hlY2tpbmcgdGhpcyBiZWNhdXNlIHRoaXMgZmlsZSBpcyBwZXJmLWNyaXRpY2FsIGFuZCB0aGUgY29zdAogICAqIG9mIG1ha2luZyBmbG93IHVuZGVyc3RhbmQgaXQgaXMgbm90IHdvcnRoIGl0LgogICAqLwoKICB2YXIgZW1wdHlOb2RlID0gbmV3IFZOb2RlKCcnLCB7fSwgW10pOwoKICB2YXIgaG9va3MgPSBbJ2NyZWF0ZScsICdhY3RpdmF0ZScsICd1cGRhdGUnLCAncmVtb3ZlJywgJ2Rlc3Ryb3knXTsKCiAgZnVuY3Rpb24gc2FtZVZub2RlIChhLCBiKSB7CiAgICByZXR1cm4gKAogICAgICBhLmtleSA9PT0gYi5rZXkgJiYgKAogICAgICAgICgKICAgICAgICAgIGEudGFnID09PSBiLnRhZyAmJgogICAgICAgICAgYS5pc0NvbW1lbnQgPT09IGIuaXNDb21tZW50ICYmCiAgICAgICAgICBpc0RlZihhLmRhdGEpID09PSBpc0RlZihiLmRhdGEpICYmCiAgICAgICAgICBzYW1lSW5wdXRUeXBlKGEsIGIpCiAgICAgICAgKSB8fCAoCiAgICAgICAgICBpc1RydWUoYS5pc0FzeW5jUGxhY2Vob2xkZXIpICYmCiAgICAgICAgICBhLmFzeW5jRmFjdG9yeSA9PT0gYi5hc3luY0ZhY3RvcnkgJiYKICAgICAgICAgIGlzVW5kZWYoYi5hc3luY0ZhY3RvcnkuZXJyb3IpCiAgICAgICAgKQogICAgICApCiAgICApCiAgfQoKICBmdW5jdGlvbiBzYW1lSW5wdXRUeXBlIChhLCBiKSB7CiAgICBpZiAoYS50YWcgIT09ICdpbnB1dCcpIHsgcmV0dXJuIHRydWUgfQogICAgdmFyIGk7CiAgICB2YXIgdHlwZUEgPSBpc0RlZihpID0gYS5kYXRhKSAmJiBpc0RlZihpID0gaS5hdHRycykgJiYgaS50eXBlOwogICAgdmFyIHR5cGVCID0gaXNEZWYoaSA9IGIuZGF0YSkgJiYgaXNEZWYoaSA9IGkuYXR0cnMpICYmIGkudHlwZTsKICAgIHJldHVybiB0eXBlQSA9PT0gdHlwZUIgfHwgaXNUZXh0SW5wdXRUeXBlKHR5cGVBKSAmJiBpc1RleHRJbnB1dFR5cGUodHlwZUIpCiAgfQoKICBmdW5jdGlvbiBjcmVhdGVLZXlUb09sZElkeCAoY2hpbGRyZW4sIGJlZ2luSWR4LCBlbmRJZHgpIHsKICAgIHZhciBpLCBrZXk7CiAgICB2YXIgbWFwID0ge307CiAgICBmb3IgKGkgPSBiZWdpbklkeDsgaSA8PSBlbmRJZHg7ICsraSkgewogICAgICBrZXkgPSBjaGlsZHJlbltpXS5rZXk7CiAgICAgIGlmIChpc0RlZihrZXkpKSB7IG1hcFtrZXldID0gaTsgfQogICAgfQogICAgcmV0dXJuIG1hcAogIH0KCiAgZnVuY3Rpb24gY3JlYXRlUGF0Y2hGdW5jdGlvbiAoYmFja2VuZCkgewogICAgdmFyIGksIGo7CiAgICB2YXIgY2JzID0ge307CgogICAgdmFyIG1vZHVsZXMgPSBiYWNrZW5kLm1vZHVsZXM7CiAgICB2YXIgbm9kZU9wcyA9IGJhY2tlbmQubm9kZU9wczsKCiAgICBmb3IgKGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyArK2kpIHsKICAgICAgY2JzW2hvb2tzW2ldXSA9IFtdOwogICAgICBmb3IgKGogPSAwOyBqIDwgbW9kdWxlcy5sZW5ndGg7ICsraikgewogICAgICAgIGlmIChpc0RlZihtb2R1bGVzW2pdW2hvb2tzW2ldXSkpIHsKICAgICAgICAgIGNic1tob29rc1tpXV0ucHVzaChtb2R1bGVzW2pdW2hvb2tzW2ldXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZW1wdHlOb2RlQXQgKGVsbSkgewogICAgICByZXR1cm4gbmV3IFZOb2RlKG5vZGVPcHMudGFnTmFtZShlbG0pLnRvTG93ZXJDYXNlKCksIHt9LCBbXSwgdW5kZWZpbmVkLCBlbG0pCiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlUm1DYiAoY2hpbGRFbG0sIGxpc3RlbmVycykgewogICAgICBmdW5jdGlvbiByZW1vdmUkJDEgKCkgewogICAgICAgIGlmICgtLXJlbW92ZSQkMS5saXN0ZW5lcnMgPT09IDApIHsKICAgICAgICAgIHJlbW92ZU5vZGUoY2hpbGRFbG0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZW1vdmUkJDEubGlzdGVuZXJzID0gbGlzdGVuZXJzOwogICAgICByZXR1cm4gcmVtb3ZlJCQxCiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZlTm9kZSAoZWwpIHsKICAgICAgdmFyIHBhcmVudCA9IG5vZGVPcHMucGFyZW50Tm9kZShlbCk7CiAgICAgIC8vIGVsZW1lbnQgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQgZHVlIHRvIHYtaHRtbCAvIHYtdGV4dAogICAgICBpZiAoaXNEZWYocGFyZW50KSkgewogICAgICAgIG5vZGVPcHMucmVtb3ZlQ2hpbGQocGFyZW50LCBlbCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50JCQxICh2bm9kZSwgaW5WUHJlKSB7CiAgICAgIHJldHVybiAoCiAgICAgICAgIWluVlByZSAmJgogICAgICAgICF2bm9kZS5ucyAmJgogICAgICAgICEoCiAgICAgICAgICBjb25maWcuaWdub3JlZEVsZW1lbnRzLmxlbmd0aCAmJgogICAgICAgICAgY29uZmlnLmlnbm9yZWRFbGVtZW50cy5zb21lKGZ1bmN0aW9uIChpZ25vcmUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzUmVnRXhwKGlnbm9yZSkKICAgICAgICAgICAgICA/IGlnbm9yZS50ZXN0KHZub2RlLnRhZykKICAgICAgICAgICAgICA6IGlnbm9yZSA9PT0gdm5vZGUudGFnCiAgICAgICAgICB9KQogICAgICAgICkgJiYKICAgICAgICBjb25maWcuaXNVbmtub3duRWxlbWVudCh2bm9kZS50YWcpCiAgICAgICkKICAgIH0KCiAgICB2YXIgY3JlYXRpbmdFbG1JblZQcmUgPSAwOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUVsbSAoCiAgICAgIHZub2RlLAogICAgICBpbnNlcnRlZFZub2RlUXVldWUsCiAgICAgIHBhcmVudEVsbSwKICAgICAgcmVmRWxtLAogICAgICBuZXN0ZWQsCiAgICAgIG93bmVyQXJyYXksCiAgICAgIGluZGV4CiAgICApIHsKICAgICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgICAvLyBUaGlzIHZub2RlIHdhcyB1c2VkIGluIGEgcHJldmlvdXMgcmVuZGVyIQogICAgICAgIC8vIG5vdyBpdCdzIHVzZWQgYXMgYSBuZXcgbm9kZSwgb3ZlcndyaXRpbmcgaXRzIGVsbSB3b3VsZCBjYXVzZQogICAgICAgIC8vIHBvdGVudGlhbCBwYXRjaCBlcnJvcnMgZG93biB0aGUgcm9hZCB3aGVuIGl0J3MgdXNlZCBhcyBhbiBpbnNlcnRpb24KICAgICAgICAvLyByZWZlcmVuY2Ugbm9kZS4gSW5zdGVhZCwgd2UgY2xvbmUgdGhlIG5vZGUgb24tZGVtYW5kIGJlZm9yZSBjcmVhdGluZwogICAgICAgIC8vIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgZm9yIGl0LgogICAgICAgIHZub2RlID0gb3duZXJBcnJheVtpbmRleF0gPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgICAgfQoKICAgICAgdm5vZGUuaXNSb290SW5zZXJ0ID0gIW5lc3RlZDsgLy8gZm9yIHRyYW5zaXRpb24gZW50ZXIgY2hlY2sKICAgICAgaWYgKGNyZWF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkpIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgICB2YXIgY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsKICAgICAgdmFyIHRhZyA9IHZub2RlLnRhZzsKICAgICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgICB7CiAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnByZSkgewogICAgICAgICAgICBjcmVhdGluZ0VsbUluVlByZSsrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5rbm93bkVsZW1lbnQkJDEodm5vZGUsIGNyZWF0aW5nRWxtSW5WUHJlKSkgewogICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICdVbmtub3duIGN1c3RvbSBlbGVtZW50OiA8JyArIHRhZyArICc+IC0gZGlkIHlvdSAnICsKICAgICAgICAgICAgICAncmVnaXN0ZXIgdGhlIGNvbXBvbmVudCBjb3JyZWN0bHk/IEZvciByZWN1cnNpdmUgY29tcG9uZW50cywgJyArCiAgICAgICAgICAgICAgJ21ha2Ugc3VyZSB0byBwcm92aWRlIHRoZSAibmFtZSIgb3B0aW9uLicsCiAgICAgICAgICAgICAgdm5vZGUuY29udGV4dAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdm5vZGUuZWxtID0gdm5vZGUubnMKICAgICAgICAgID8gbm9kZU9wcy5jcmVhdGVFbGVtZW50TlModm5vZGUubnMsIHRhZykKICAgICAgICAgIDogbm9kZU9wcy5jcmVhdGVFbGVtZW50KHRhZywgdm5vZGUpOwogICAgICAgIHNldFNjb3BlKHZub2RlKTsKCiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgewogICAgICAgICAgY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlLS07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzVHJ1ZSh2bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgICAgdm5vZGUuZWxtID0gbm9kZU9wcy5jcmVhdGVDb21tZW50KHZub2RlLnRleHQpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2bm9kZS5lbG0gPSBub2RlT3BzLmNyZWF0ZVRleHROb2RlKHZub2RlLnRleHQpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudCAodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgICAgdmFyIGkgPSB2bm9kZS5kYXRhOwogICAgICBpZiAoaXNEZWYoaSkpIHsKICAgICAgICB2YXIgaXNSZWFjdGl2YXRlZCA9IGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpLmtlZXBBbGl2ZTsKICAgICAgICBpZiAoaXNEZWYoaSA9IGkuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIHsKICAgICAgICAgIGkodm5vZGUsIGZhbHNlIC8qIGh5ZHJhdGluZyAqLyk7CiAgICAgICAgfQogICAgICAgIC8vIGFmdGVyIGNhbGxpbmcgdGhlIGluaXQgaG9vaywgaWYgdGhlIHZub2RlIGlzIGEgY2hpbGQgY29tcG9uZW50CiAgICAgICAgLy8gaXQgc2hvdWxkJ3ZlIGNyZWF0ZWQgYSBjaGlsZCBpbnN0YW5jZSBhbmQgbW91bnRlZCBpdC4gdGhlIGNoaWxkCiAgICAgICAgLy8gY29tcG9uZW50IGFsc28gaGFzIHNldCB0aGUgcGxhY2Vob2xkZXIgdm5vZGUncyBlbG0uCiAgICAgICAgLy8gaW4gdGhhdCBjYXNlIHdlIGNhbiBqdXN0IHJldHVybiB0aGUgZWxlbWVudCBhbmQgYmUgZG9uZS4KICAgICAgICBpZiAoaXNEZWYodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgICAgICAgaWYgKGlzVHJ1ZShpc1JlYWN0aXZhdGVkKSkgewogICAgICAgICAgICByZWFjdGl2YXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdENvbXBvbmVudCAodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgICBpZiAoaXNEZWYodm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KSkgewogICAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoLmFwcGx5KGluc2VydGVkVm5vZGVRdWV1ZSwgdm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KTsKICAgICAgICB2bm9kZS5kYXRhLnBlbmRpbmdJbnNlcnQgPSBudWxsOwogICAgICB9CiAgICAgIHZub2RlLmVsbSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlLiRlbDsKICAgICAgaWYgKGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIHNldFNjb3BlKHZub2RlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBlbXB0eSBjb21wb25lbnQgcm9vdC4KICAgICAgICAvLyBza2lwIGFsbCBlbGVtZW50LXJlbGF0ZWQgbW9kdWxlcyBleGNlcHQgZm9yIHJlZiAoIzM0NTUpCiAgICAgICAgcmVnaXN0ZXJSZWYodm5vZGUpOwogICAgICAgIC8vIG1ha2Ugc3VyZSB0byBpbnZva2UgdGhlIGluc2VydCBob29rCiAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2godm5vZGUpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVhY3RpdmF0ZUNvbXBvbmVudCAodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgICAgdmFyIGk7CiAgICAgIC8vIGhhY2sgZm9yICM0MzM5OiBhIHJlYWN0aXZhdGVkIGNvbXBvbmVudCB3aXRoIGlubmVyIHRyYW5zaXRpb24KICAgICAgLy8gZG9lcyBub3QgdHJpZ2dlciBiZWNhdXNlIHRoZSBpbm5lciBub2RlJ3MgY3JlYXRlZCBob29rcyBhcmUgbm90IGNhbGxlZAogICAgICAvLyBhZ2Fpbi4gSXQncyBub3QgaWRlYWwgdG8gaW52b2x2ZSBtb2R1bGUtc3BlY2lmaWMgbG9naWMgaW4gaGVyZSBidXQKICAgICAgLy8gdGhlcmUgZG9lc24ndCBzZWVtIHRvIGJlIGEgYmV0dGVyIHdheSB0byBkbyBpdC4KICAgICAgdmFyIGlubmVyTm9kZSA9IHZub2RlOwogICAgICB3aGlsZSAoaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgICAgaW5uZXJOb2RlID0gaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKICAgICAgICBpZiAoaXNEZWYoaSA9IGlubmVyTm9kZS5kYXRhKSAmJiBpc0RlZihpID0gaS50cmFuc2l0aW9uKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5hY3RpdmF0ZS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBjYnMuYWN0aXZhdGVbaV0oZW1wdHlOb2RlLCBpbm5lck5vZGUpOwogICAgICAgICAgfQogICAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2goaW5uZXJOb2RlKTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIHVubGlrZSBhIG5ld2x5IGNyZWF0ZWQgY29tcG9uZW50LAogICAgICAvLyBhIHJlYWN0aXZhdGVkIGtlZXAtYWxpdmUgY29tcG9uZW50IGRvZXNuJ3QgaW5zZXJ0IGl0c2VsZgogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5zZXJ0IChwYXJlbnQsIGVsbSwgcmVmJCQxKSB7CiAgICAgIGlmIChpc0RlZihwYXJlbnQpKSB7CiAgICAgICAgaWYgKGlzRGVmKHJlZiQkMSkpIHsKICAgICAgICAgIGlmIChub2RlT3BzLnBhcmVudE5vZGUocmVmJCQxKSA9PT0gcGFyZW50KSB7CiAgICAgICAgICAgIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudCwgZWxtLCByZWYkJDEpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBub2RlT3BzLmFwcGVuZENoaWxkKHBhcmVudCwgZWxtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVDaGlsZHJlbiAodm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgICAgewogICAgICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgICAgY3JlYXRlRWxtKGNoaWxkcmVuW2ldLCBpbnNlcnRlZFZub2RlUXVldWUsIHZub2RlLmVsbSwgbnVsbCwgdHJ1ZSwgY2hpbGRyZW4sIGkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2bm9kZS50ZXh0KSkgewogICAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQodm5vZGUuZWxtLCBub2RlT3BzLmNyZWF0ZVRleHROb2RlKFN0cmluZyh2bm9kZS50ZXh0KSkpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNQYXRjaGFibGUgKHZub2RlKSB7CiAgICAgIHdoaWxlICh2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICAgIHZub2RlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwogICAgICB9CiAgICAgIHJldHVybiBpc0RlZih2bm9kZS50YWcpCiAgICB9CgogICAgZnVuY3Rpb24gaW52b2tlQ3JlYXRlSG9va3MgKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgY2JzLmNyZWF0ZS5sZW5ndGg7ICsraSQxKSB7CiAgICAgICAgY2JzLmNyZWF0ZVtpJDFdKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgICB9CiAgICAgIGkgPSB2bm9kZS5kYXRhLmhvb2s7IC8vIFJldXNlIHZhcmlhYmxlCiAgICAgIGlmIChpc0RlZihpKSkgewogICAgICAgIGlmIChpc0RlZihpLmNyZWF0ZSkpIHsgaS5jcmVhdGUoZW1wdHlOb2RlLCB2bm9kZSk7IH0KICAgICAgICBpZiAoaXNEZWYoaS5pbnNlcnQpKSB7IGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsgfQogICAgICB9CiAgICB9CgogICAgLy8gc2V0IHNjb3BlIGlkIGF0dHJpYnV0ZSBmb3Igc2NvcGVkIENTUy4KICAgIC8vIHRoaXMgaXMgaW1wbGVtZW50ZWQgYXMgYSBzcGVjaWFsIGNhc2UgdG8gYXZvaWQgdGhlIG92ZXJoZWFkCiAgICAvLyBvZiBnb2luZyB0aHJvdWdoIHRoZSBub3JtYWwgYXR0cmlidXRlIHBhdGNoaW5nIHByb2Nlc3MuCiAgICBmdW5jdGlvbiBzZXRTY29wZSAodm5vZGUpIHsKICAgICAgdmFyIGk7CiAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuZm5TY29wZUlkKSkgewogICAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBhbmNlc3RvciA9IHZub2RlOwogICAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgICAgaWYgKGlzRGVmKGkgPSBhbmNlc3Rvci5jb250ZXh0KSAmJiBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkpIHsKICAgICAgICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICAgICAgICB9CiAgICAgICAgICBhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZm9yIHNsb3QgY29udGVudCB0aGV5IHNob3VsZCBhbHNvIGdldCB0aGUgc2NvcGVJZCBmcm9tIHRoZSBob3N0IGluc3RhbmNlLgogICAgICBpZiAoaXNEZWYoaSA9IGFjdGl2ZUluc3RhbmNlKSAmJgogICAgICAgIGkgIT09IHZub2RlLmNvbnRleHQgJiYKICAgICAgICBpICE9PSB2bm9kZS5mbkNvbnRleHQgJiYKICAgICAgICBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkKICAgICAgKSB7CiAgICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhZGRWbm9kZXMgKHBhcmVudEVsbSwgcmVmRWxtLCB2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgICBmb3IgKDsgc3RhcnRJZHggPD0gZW5kSWR4OyArK3N0YXJ0SWR4KSB7CiAgICAgICAgY3JlYXRlRWxtKHZub2Rlc1tzdGFydElkeF0sIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0sIGZhbHNlLCB2bm9kZXMsIHN0YXJ0SWR4KTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZURlc3Ryb3lIb29rICh2bm9kZSkgewogICAgICB2YXIgaSwgajsKICAgICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuZGVzdHJveSkpIHsgaSh2bm9kZSk7IH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIHsgY2JzLmRlc3Ryb3lbaV0odm5vZGUpOyB9CiAgICAgIH0KICAgICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyArK2opIHsKICAgICAgICAgIGludm9rZURlc3Ryb3lIb29rKHZub2RlLmNoaWxkcmVuW2pdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZW1vdmVWbm9kZXMgKHBhcmVudEVsbSwgdm5vZGVzLCBzdGFydElkeCwgZW5kSWR4KSB7CiAgICAgIGZvciAoOyBzdGFydElkeCA8PSBlbmRJZHg7ICsrc3RhcnRJZHgpIHsKICAgICAgICB2YXIgY2ggPSB2bm9kZXNbc3RhcnRJZHhdOwogICAgICAgIGlmIChpc0RlZihjaCkpIHsKICAgICAgICAgIGlmIChpc0RlZihjaC50YWcpKSB7CiAgICAgICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soY2gpOwogICAgICAgICAgICBpbnZva2VEZXN0cm95SG9vayhjaCk7CiAgICAgICAgICB9IGVsc2UgeyAvLyBUZXh0IG5vZGUKICAgICAgICAgICAgcmVtb3ZlTm9kZShjaC5lbG0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2sgKHZub2RlLCBybSkgewogICAgICBpZiAoaXNEZWYocm0pIHx8IGlzRGVmKHZub2RlLmRhdGEpKSB7CiAgICAgICAgdmFyIGk7CiAgICAgICAgdmFyIGxpc3RlbmVycyA9IGNicy5yZW1vdmUubGVuZ3RoICsgMTsKICAgICAgICBpZiAoaXNEZWYocm0pKSB7CiAgICAgICAgICAvLyB3ZSBoYXZlIGEgcmVjdXJzaXZlbHkgcGFzc2VkIGRvd24gcm0gY2FsbGJhY2sKICAgICAgICAgIC8vIGluY3JlYXNlIHRoZSBsaXN0ZW5lcnMgY291bnQKICAgICAgICAgIHJtLmxpc3RlbmVycyArPSBsaXN0ZW5lcnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGRpcmVjdGx5IHJlbW92aW5nCiAgICAgICAgICBybSA9IGNyZWF0ZVJtQ2Iodm5vZGUuZWxtLCBsaXN0ZW5lcnMpOwogICAgICAgIH0KICAgICAgICAvLyByZWN1cnNpdmVseSBpbnZva2UgaG9va3Mgb24gY2hpbGQgY29tcG9uZW50IHJvb3Qgbm9kZQogICAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UpICYmIGlzRGVmKGkgPSBpLl92bm9kZSkgJiYgaXNEZWYoaS5kYXRhKSkgewogICAgICAgICAgcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayhpLCBybSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMucmVtb3ZlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYnMucmVtb3ZlW2ldKHZub2RlLCBybSk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5yZW1vdmUpKSB7CiAgICAgICAgICBpKHZub2RlLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJtKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJlbW92ZU5vZGUodm5vZGUuZWxtKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUNoaWxkcmVuIChwYXJlbnRFbG0sIG9sZENoLCBuZXdDaCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCByZW1vdmVPbmx5KSB7CiAgICAgIHZhciBvbGRTdGFydElkeCA9IDA7CiAgICAgIHZhciBuZXdTdGFydElkeCA9IDA7CiAgICAgIHZhciBvbGRFbmRJZHggPSBvbGRDaC5sZW5ndGggLSAxOwogICAgICB2YXIgb2xkU3RhcnRWbm9kZSA9IG9sZENoWzBdOwogICAgICB2YXIgb2xkRW5kVm5vZGUgPSBvbGRDaFtvbGRFbmRJZHhdOwogICAgICB2YXIgbmV3RW5kSWR4ID0gbmV3Q2gubGVuZ3RoIC0gMTsKICAgICAgdmFyIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFswXTsKICAgICAgdmFyIG5ld0VuZFZub2RlID0gbmV3Q2hbbmV3RW5kSWR4XTsKICAgICAgdmFyIG9sZEtleVRvSWR4LCBpZHhJbk9sZCwgdm5vZGVUb01vdmUsIHJlZkVsbTsKCiAgICAgIC8vIHJlbW92ZU9ubHkgaXMgYSBzcGVjaWFsIGZsYWcgdXNlZCBvbmx5IGJ5IDx0cmFuc2l0aW9uLWdyb3VwPgogICAgICAvLyB0byBlbnN1cmUgcmVtb3ZlZCBlbGVtZW50cyBzdGF5IGluIGNvcnJlY3QgcmVsYXRpdmUgcG9zaXRpb25zCiAgICAgIC8vIGR1cmluZyBsZWF2aW5nIHRyYW5zaXRpb25zCiAgICAgIHZhciBjYW5Nb3ZlID0gIXJlbW92ZU9ubHk7CgogICAgICB7CiAgICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKG5ld0NoKTsKICAgICAgfQoKICAgICAgd2hpbGUgKG9sZFN0YXJ0SWR4IDw9IG9sZEVuZElkeCAmJiBuZXdTdGFydElkeCA8PSBuZXdFbmRJZHgpIHsKICAgICAgICBpZiAoaXNVbmRlZihvbGRTdGFydFZub2RlKSkgewogICAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOyAvLyBWbm9kZSBoYXMgYmVlbiBtb3ZlZCBsZWZ0CiAgICAgICAgfSBlbHNlIGlmIChpc1VuZGVmKG9sZEVuZFZub2RlKSkgewogICAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOwogICAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZEVuZFZub2RlLCBuZXdFbmRWbm9kZSkpIHsKICAgICAgICAgIHBhdGNoVm5vZGUob2xkRW5kVm5vZGUsIG5ld0VuZFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdFbmRJZHgpOwogICAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRTdGFydFZub2RlLCBuZXdFbmRWbm9kZSkpIHsgLy8gVm5vZGUgbW92ZWQgcmlnaHQKICAgICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3RW5kVm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld0VuZElkeCk7CiAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRW5kVm5vZGUuZWxtKSk7CiAgICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsgLy8gVm5vZGUgbW92ZWQgbGVmdAogICAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgY2FuTW92ZSAmJiBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnRFbG0sIG9sZEVuZFZub2RlLmVsbSwgb2xkU3RhcnRWbm9kZS5lbG0pOwogICAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1VuZGVmKG9sZEtleVRvSWR4KSkgeyBvbGRLZXlUb0lkeCA9IGNyZWF0ZUtleVRvT2xkSWR4KG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsgfQogICAgICAgICAgaWR4SW5PbGQgPSBpc0RlZihuZXdTdGFydFZub2RlLmtleSkKICAgICAgICAgICAgPyBvbGRLZXlUb0lkeFtuZXdTdGFydFZub2RlLmtleV0KICAgICAgICAgICAgOiBmaW5kSWR4SW5PbGQobmV3U3RhcnRWbm9kZSwgb2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgICAgICAgaWYgKGlzVW5kZWYoaWR4SW5PbGQpKSB7IC8vIE5ldyBlbGVtZW50CiAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdm5vZGVUb01vdmUgPSBvbGRDaFtpZHhJbk9sZF07CiAgICAgICAgICAgIGlmIChzYW1lVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgICAgICAgcGF0Y2hWbm9kZSh2bm9kZVRvTW92ZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgICAgIG9sZENoW2lkeEluT2xkXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgdm5vZGVUb01vdmUuZWxtLCBvbGRTdGFydFZub2RlLmVsbSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gc2FtZSBrZXkgYnV0IGRpZmZlcmVudCBlbGVtZW50LiB0cmVhdCBhcyBuZXcgZWxlbWVudAogICAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChvbGRTdGFydElkeCA+IG9sZEVuZElkeCkgewogICAgICAgIHJlZkVsbSA9IGlzVW5kZWYobmV3Q2hbbmV3RW5kSWR4ICsgMV0pID8gbnVsbCA6IG5ld0NoW25ld0VuZElkeCArIDFdLmVsbTsKICAgICAgICBhZGRWbm9kZXMocGFyZW50RWxtLCByZWZFbG0sIG5ld0NoLCBuZXdTdGFydElkeCwgbmV3RW5kSWR4LCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9IGVsc2UgaWYgKG5ld1N0YXJ0SWR4ID4gbmV3RW5kSWR4KSB7CiAgICAgICAgcmVtb3ZlVm5vZGVzKHBhcmVudEVsbSwgb2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tEdXBsaWNhdGVLZXlzIChjaGlsZHJlbikgewogICAgICB2YXIgc2VlbktleXMgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciB2bm9kZSA9IGNoaWxkcmVuW2ldOwogICAgICAgIHZhciBrZXkgPSB2bm9kZS5rZXk7CiAgICAgICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgICAgIGlmIChzZWVuS2V5c1trZXldKSB7CiAgICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICAgKCJEdXBsaWNhdGUga2V5cyBkZXRlY3RlZDogJyIgKyBrZXkgKyAiJy4gVGhpcyBtYXkgY2F1c2UgYW4gdXBkYXRlIGVycm9yLiIpLAogICAgICAgICAgICAgIHZub2RlLmNvbnRleHQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlZW5LZXlzW2tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRJZHhJbk9sZCAobm9kZSwgb2xkQ2gsIHN0YXJ0LCBlbmQpIHsKICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpKyspIHsKICAgICAgICB2YXIgYyA9IG9sZENoW2ldOwogICAgICAgIGlmIChpc0RlZihjKSAmJiBzYW1lVm5vZGUobm9kZSwgYykpIHsgcmV0dXJuIGkgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGF0Y2hWbm9kZSAoCiAgICAgIG9sZFZub2RlLAogICAgICB2bm9kZSwKICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLAogICAgICBvd25lckFycmF5LAogICAgICBpbmRleCwKICAgICAgcmVtb3ZlT25seQogICAgKSB7CiAgICAgIGlmIChvbGRWbm9kZSA9PT0gdm5vZGUpIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgICAvLyBjbG9uZSByZXVzZWQgdm5vZGUKICAgICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICAgIH0KCiAgICAgIHZhciBlbG0gPSB2bm9kZS5lbG0gPSBvbGRWbm9kZS5lbG07CgogICAgICBpZiAoaXNUcnVlKG9sZFZub2RlLmlzQXN5bmNQbGFjZWhvbGRlcikpIHsKICAgICAgICBpZiAoaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgaHlkcmF0ZShvbGRWbm9kZS5lbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gcmV1c2UgZWxlbWVudCBmb3Igc3RhdGljIHRyZWVzLgogICAgICAvLyBub3RlIHdlIG9ubHkgZG8gdGhpcyBpZiB0aGUgdm5vZGUgaXMgY2xvbmVkIC0KICAgICAgLy8gaWYgdGhlIG5ldyBub2RlIGlzIG5vdCBjbG9uZWQgaXQgbWVhbnMgdGhlIHJlbmRlciBmdW5jdGlvbnMgaGF2ZSBiZWVuCiAgICAgIC8vIHJlc2V0IGJ5IHRoZSBob3QtcmVsb2FkLWFwaSBhbmQgd2UgbmVlZCB0byBkbyBhIHByb3BlciByZS1yZW5kZXIuCiAgICAgIGlmIChpc1RydWUodm5vZGUuaXNTdGF0aWMpICYmCiAgICAgICAgaXNUcnVlKG9sZFZub2RlLmlzU3RhdGljKSAmJgogICAgICAgIHZub2RlLmtleSA9PT0gb2xkVm5vZGUua2V5ICYmCiAgICAgICAgKGlzVHJ1ZSh2bm9kZS5pc0Nsb25lZCkgfHwgaXNUcnVlKHZub2RlLmlzT25jZSkpCiAgICAgICkgewogICAgICAgIHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHZhciBpOwogICAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5wcmVwYXRjaCkpIHsKICAgICAgICBpKG9sZFZub2RlLCB2bm9kZSk7CiAgICAgIH0KCiAgICAgIHZhciBvbGRDaCA9IG9sZFZub2RlLmNoaWxkcmVuOwogICAgICB2YXIgY2ggPSB2bm9kZS5jaGlsZHJlbjsKICAgICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMudXBkYXRlLmxlbmd0aDsgKytpKSB7IGNicy51cGRhdGVbaV0ob2xkVm5vZGUsIHZub2RlKTsgfQogICAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS51cGRhdGUpKSB7IGkob2xkVm5vZGUsIHZub2RlKTsgfQogICAgICB9CiAgICAgIGlmIChpc1VuZGVmKHZub2RlLnRleHQpKSB7CiAgICAgICAgaWYgKGlzRGVmKG9sZENoKSAmJiBpc0RlZihjaCkpIHsKICAgICAgICAgIGlmIChvbGRDaCAhPT0gY2gpIHsgdXBkYXRlQ2hpbGRyZW4oZWxtLCBvbGRDaCwgY2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSk7IH0KICAgICAgICB9IGVsc2UgaWYgKGlzRGVmKGNoKSkgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2gpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7IG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCAnJyk7IH0KICAgICAgICAgIGFkZFZub2RlcyhlbG0sIG51bGwsIGNoLCAwLCBjaC5sZW5ndGggLSAxLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkQ2gpKSB7CiAgICAgICAgICByZW1vdmVWbm9kZXMoZWxtLCBvbGRDaCwgMCwgb2xkQ2gubGVuZ3RoIC0gMSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRWbm9kZS50ZXh0KSkgewogICAgICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sICcnKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAob2xkVm5vZGUudGV4dCAhPT0gdm5vZGUudGV4dCkgewogICAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCB2bm9kZS50ZXh0KTsKICAgICAgfQogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucG9zdHBhdGNoKSkgeyBpKG9sZFZub2RlLCB2bm9kZSk7IH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZUluc2VydEhvb2sgKHZub2RlLCBxdWV1ZSwgaW5pdGlhbCkgewogICAgICAvLyBkZWxheSBpbnNlcnQgaG9va3MgZm9yIGNvbXBvbmVudCByb290IG5vZGVzLCBpbnZva2UgdGhlbSBhZnRlciB0aGUKICAgICAgLy8gZWxlbWVudCBpcyByZWFsbHkgaW5zZXJ0ZWQKICAgICAgaWYgKGlzVHJ1ZShpbml0aWFsKSAmJiBpc0RlZih2bm9kZS5wYXJlbnQpKSB7CiAgICAgICAgdm5vZGUucGFyZW50LmRhdGEucGVuZGluZ0luc2VydCA9IHF1ZXVlOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHF1ZXVlW2ldLmRhdGEuaG9vay5pbnNlcnQocXVldWVbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHZhciBoeWRyYXRpb25CYWlsZWQgPSBmYWxzZTsKICAgIC8vIGxpc3Qgb2YgbW9kdWxlcyB0aGF0IGNhbiBza2lwIGNyZWF0ZSBob29rIGR1cmluZyBoeWRyYXRpb24gYmVjYXVzZSB0aGV5CiAgICAvLyBhcmUgYWxyZWFkeSByZW5kZXJlZCBvbiB0aGUgY2xpZW50IG9yIGhhcyBubyBuZWVkIGZvciBpbml0aWFsaXphdGlvbgogICAgLy8gTm90ZTogc3R5bGUgaXMgZXhjbHVkZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gaW5pdGlhbCBjbG9uZSBmb3IgZnV0dXJlCiAgICAvLyBkZWVwIHVwZGF0ZXMgKCM3MDYzKS4KICAgIHZhciBpc1JlbmRlcmVkTW9kdWxlID0gbWFrZU1hcCgnYXR0cnMsY2xhc3Msc3RhdGljQ2xhc3Msc3RhdGljU3R5bGUsa2V5Jyk7CgogICAgLy8gTm90ZTogdGhpcyBpcyBhIGJyb3dzZXItb25seSBmdW5jdGlvbiBzbyB3ZSBjYW4gYXNzdW1lIGVsbXMgYXJlIERPTSBub2Rlcy4KICAgIGZ1bmN0aW9uIGh5ZHJhdGUgKGVsbSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgaW5WUHJlKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgdGFnID0gdm5vZGUudGFnOwogICAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICAgIHZhciBjaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgICBpblZQcmUgPSBpblZQcmUgfHwgKGRhdGEgJiYgZGF0YS5wcmUpOwogICAgICB2bm9kZS5lbG0gPSBlbG07CgogICAgICBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkgJiYgaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5KSkgewogICAgICAgIHZub2RlLmlzQXN5bmNQbGFjZWhvbGRlciA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICAvLyBhc3NlcnQgbm9kZSBtYXRjaAogICAgICB7CiAgICAgICAgaWYgKCFhc3NlcnROb2RlTWF0Y2goZWxtLCB2bm9kZSwgaW5WUHJlKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5pbml0KSkgeyBpKHZub2RlLCB0cnVlIC8qIGh5ZHJhdGluZyAqLyk7IH0KICAgICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgICAgLy8gY2hpbGQgY29tcG9uZW50LiBpdCBzaG91bGQgaGF2ZSBoeWRyYXRlZCBpdHMgb3duIHRyZWUuCiAgICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgICBpZiAoaXNEZWYoY2hpbGRyZW4pKSB7CiAgICAgICAgICAvLyBlbXB0eSBlbGVtZW50LCBhbGxvdyBjbGllbnQgdG8gcGljayB1cCBhbmQgcG9wdWxhdGUgY2hpbGRyZW4KICAgICAgICAgIGlmICghZWxtLmhhc0NoaWxkTm9kZXMoKSkgewogICAgICAgICAgICBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB2LWh0bWwgYW5kIGRvbVByb3BzOiBpbm5lckhUTUwKICAgICAgICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhKSAmJiBpc0RlZihpID0gaS5kb21Qcm9wcykgJiYgaXNEZWYoaSA9IGkuaW5uZXJIVE1MKSkgewogICAgICAgICAgICAgIGlmIChpICE9PSBlbG0uaW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgICAgICAgICAgICAgIWh5ZHJhdGlvbkJhaWxlZAogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGh5ZHJhdGlvbkJhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ3NlcnZlciBpbm5lckhUTUw6ICcsIGkpOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ2NsaWVudCBpbm5lckhUTUw6ICcsIGVsbS5pbm5lckhUTUwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGl0ZXJhdGUgYW5kIGNvbXBhcmUgY2hpbGRyZW4gbGlzdHMKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5NYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsbS5maXJzdENoaWxkOwogICAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNoaWxkcmVuLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICAgICAgICAgIGlmICghY2hpbGROb2RlIHx8ICFoeWRyYXRlKGNoaWxkTm9kZSwgY2hpbGRyZW5baSQxXSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpblZQcmUpKSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gaWYgY2hpbGROb2RlIGlzIG5vdCBudWxsLCBpdCBtZWFucyB0aGUgYWN0dWFsIGNoaWxkTm9kZXMgbGlzdCBpcwogICAgICAgICAgICAgIC8vIGxvbmdlciB0aGFuIHRoZSB2aXJ0dWFsIGNoaWxkcmVuIGxpc3QuCiAgICAgICAgICAgICAgaWYgKCFjaGlsZHJlbk1hdGNoIHx8IGNoaWxkTm9kZSkgewogICAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmCiAgICAgICAgICAgICAgICAgICFoeWRyYXRpb25CYWlsZWQKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICBoeWRyYXRpb25CYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BhcmVudDogJywgZWxtKTsKICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNtYXRjaGluZyBjaGlsZE5vZGVzIHZzLiBWTm9kZXM6ICcsIGVsbS5jaGlsZE5vZGVzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgICB2YXIgZnVsbEludm9rZSA9IGZhbHNlOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgaWYgKCFpc1JlbmRlcmVkTW9kdWxlKGtleSkpIHsKICAgICAgICAgICAgICBmdWxsSW52b2tlID0gdHJ1ZTsKICAgICAgICAgICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWZ1bGxJbnZva2UgJiYgZGF0YVsnY2xhc3MnXSkgewogICAgICAgICAgICAvLyBlbnN1cmUgY29sbGVjdGluZyBkZXBzIGZvciBkZWVwIGNsYXNzIGJpbmRpbmdzIGZvciBmdXR1cmUgdXBkYXRlcwogICAgICAgICAgICB0cmF2ZXJzZShkYXRhWydjbGFzcyddKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZWxtLmRhdGEgIT09IHZub2RlLnRleHQpIHsKICAgICAgICBlbG0uZGF0YSA9IHZub2RlLnRleHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBhc3NlcnROb2RlTWF0Y2ggKG5vZGUsIHZub2RlLCBpblZQcmUpIHsKICAgICAgaWYgKGlzRGVmKHZub2RlLnRhZykpIHsKICAgICAgICByZXR1cm4gdm5vZGUudGFnLmluZGV4T2YoJ3Z1ZS1jb21wb25lbnQnKSA9PT0gMCB8fCAoCiAgICAgICAgICAhaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgaW5WUHJlKSAmJgogICAgICAgICAgdm5vZGUudGFnLnRvTG93ZXJDYXNlKCkgPT09IChub2RlLnRhZ05hbWUgJiYgbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgKQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAodm5vZGUuaXNDb21tZW50ID8gOCA6IDMpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gcGF0Y2ggKG9sZFZub2RlLCB2bm9kZSwgaHlkcmF0aW5nLCByZW1vdmVPbmx5KSB7CiAgICAgIGlmIChpc1VuZGVmKHZub2RlKSkgewogICAgICAgIGlmIChpc0RlZihvbGRWbm9kZSkpIHsgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOyB9CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHZhciBpc0luaXRpYWxQYXRjaCA9IGZhbHNlOwogICAgICB2YXIgaW5zZXJ0ZWRWbm9kZVF1ZXVlID0gW107CgogICAgICBpZiAoaXNVbmRlZihvbGRWbm9kZSkpIHsKICAgICAgICAvLyBlbXB0eSBtb3VudCAobGlrZWx5IGFzIGNvbXBvbmVudCksIGNyZWF0ZSBuZXcgcm9vdCBlbGVtZW50CiAgICAgICAgaXNJbml0aWFsUGF0Y2ggPSB0cnVlOwogICAgICAgIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaXNSZWFsRWxlbWVudCA9IGlzRGVmKG9sZFZub2RlLm5vZGVUeXBlKTsKICAgICAgICBpZiAoIWlzUmVhbEVsZW1lbnQgJiYgc2FtZVZub2RlKG9sZFZub2RlLCB2bm9kZSkpIHsKICAgICAgICAgIC8vIHBhdGNoIGV4aXN0aW5nIHJvb3Qgbm9kZQogICAgICAgICAgcGF0Y2hWbm9kZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbnVsbCwgbnVsbCwgcmVtb3ZlT25seSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1JlYWxFbGVtZW50KSB7CiAgICAgICAgICAgIC8vIG1vdW50aW5nIHRvIGEgcmVhbCBlbGVtZW50CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoaXMgaXMgc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQgYW5kIGlmIHdlIGNhbiBwZXJmb3JtCiAgICAgICAgICAgIC8vIGEgc3VjY2Vzc2Z1bCBoeWRyYXRpb24uCiAgICAgICAgICAgIGlmIChvbGRWbm9kZS5ub2RlVHlwZSA9PT0gMSAmJiBvbGRWbm9kZS5oYXNBdHRyaWJ1dGUoU1NSX0FUVFIpKSB7CiAgICAgICAgICAgICAgb2xkVm5vZGUucmVtb3ZlQXR0cmlidXRlKFNTUl9BVFRSKTsKICAgICAgICAgICAgICBoeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1RydWUoaHlkcmF0aW5nKSkgewogICAgICAgICAgICAgIGlmIChoeWRyYXRlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSkgewogICAgICAgICAgICAgICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRWbm9kZQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICAgICAnVGhlIGNsaWVudC1zaWRlIHJlbmRlcmVkIHZpcnR1YWwgRE9NIHRyZWUgaXMgbm90IG1hdGNoaW5nICcgKwogICAgICAgICAgICAgICAgICAnc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSBpbmNvcnJlY3QgJyArCiAgICAgICAgICAgICAgICAgICdIVE1MIG1hcmt1cCwgZm9yIGV4YW1wbGUgbmVzdGluZyBibG9jay1sZXZlbCBlbGVtZW50cyBpbnNpZGUgJyArCiAgICAgICAgICAgICAgICAgICc8cD4sIG9yIG1pc3NpbmcgPHRib2R5Pi4gQmFpbGluZyBoeWRyYXRpb24gYW5kIHBlcmZvcm1pbmcgJyArCiAgICAgICAgICAgICAgICAgICdmdWxsIGNsaWVudC1zaWRlIHJlbmRlci4nCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBlaXRoZXIgbm90IHNlcnZlci1yZW5kZXJlZCwgb3IgaHlkcmF0aW9uIGZhaWxlZC4KICAgICAgICAgICAgLy8gY3JlYXRlIGFuIGVtcHR5IG5vZGUgYW5kIHJlcGxhY2UgaXQKICAgICAgICAgICAgb2xkVm5vZGUgPSBlbXB0eU5vZGVBdChvbGRWbm9kZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmVwbGFjaW5nIGV4aXN0aW5nIGVsZW1lbnQKICAgICAgICAgIHZhciBvbGRFbG0gPSBvbGRWbm9kZS5lbG07CiAgICAgICAgICB2YXIgcGFyZW50RWxtID0gbm9kZU9wcy5wYXJlbnROb2RlKG9sZEVsbSk7CgogICAgICAgICAgLy8gY3JlYXRlIG5ldyBub2RlCiAgICAgICAgICBjcmVhdGVFbG0oCiAgICAgICAgICAgIHZub2RlLAogICAgICAgICAgICBpbnNlcnRlZFZub2RlUXVldWUsCiAgICAgICAgICAgIC8vIGV4dHJlbWVseSByYXJlIGVkZ2UgY2FzZTogZG8gbm90IGluc2VydCBpZiBvbGQgZWxlbWVudCBpcyBpbiBhCiAgICAgICAgICAgIC8vIGxlYXZpbmcgdHJhbnNpdGlvbi4gT25seSBoYXBwZW5zIHdoZW4gY29tYmluaW5nIHRyYW5zaXRpb24gKwogICAgICAgICAgICAvLyBrZWVwLWFsaXZlICsgSE9Dcy4gKCM0NTkwKQogICAgICAgICAgICBvbGRFbG0uX2xlYXZlQ2IgPyBudWxsIDogcGFyZW50RWxtLAogICAgICAgICAgICBub2RlT3BzLm5leHRTaWJsaW5nKG9sZEVsbSkKICAgICAgICAgICk7CgogICAgICAgICAgLy8gdXBkYXRlIHBhcmVudCBwbGFjZWhvbGRlciBub2RlIGVsZW1lbnQsIHJlY3Vyc2l2ZWx5CiAgICAgICAgICBpZiAoaXNEZWYodm5vZGUucGFyZW50KSkgewogICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSB2bm9kZS5wYXJlbnQ7CiAgICAgICAgICAgIHZhciBwYXRjaGFibGUgPSBpc1BhdGNoYWJsZSh2bm9kZSk7CiAgICAgICAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGNicy5kZXN0cm95W2ldKGFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYW5jZXN0b3IuZWxtID0gdm5vZGUuZWxtOwogICAgICAgICAgICAgIGlmIChwYXRjaGFibGUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2kkMSkgewogICAgICAgICAgICAgICAgICBjYnMuY3JlYXRlW2kkMV0oZW1wdHlOb2RlLCBhbmNlc3Rvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAjNjUxMwogICAgICAgICAgICAgICAgLy8gaW52b2tlIGluc2VydCBob29rcyB0aGF0IG1heSBoYXZlIGJlZW4gbWVyZ2VkIGJ5IGNyZWF0ZSBob29rcy4KICAgICAgICAgICAgICAgIC8vIGUuZy4gZm9yIGRpcmVjdGl2ZXMgdGhhdCB1c2VzIHRoZSAiaW5zZXJ0ZWQiIGhvb2suCiAgICAgICAgICAgICAgICB2YXIgaW5zZXJ0ID0gYW5jZXN0b3IuZGF0YS5ob29rLmluc2VydDsKICAgICAgICAgICAgICAgIGlmIChpbnNlcnQubWVyZ2VkKSB7CiAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0IGF0IGluZGV4IDEgdG8gYXZvaWQgcmUtaW52b2tpbmcgY29tcG9uZW50IG1vdW50ZWQgaG9vawogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpJDIgPSAxOyBpJDIgPCBpbnNlcnQuZm5zLmxlbmd0aDsgaSQyKyspIHsKICAgICAgICAgICAgICAgICAgICBpbnNlcnQuZm5zW2kkMl0oKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWdpc3RlclJlZihhbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZGVzdHJveSBvbGQgbm9kZQogICAgICAgICAgaWYgKGlzRGVmKHBhcmVudEVsbSkpIHsKICAgICAgICAgICAgcmVtb3ZlVm5vZGVzKHBhcmVudEVsbSwgW29sZFZub2RlXSwgMCwgMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRhZykpIHsKICAgICAgICAgICAgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpc0luaXRpYWxQYXRjaCk7CiAgICAgIHJldHVybiB2bm9kZS5lbG0KICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgZGlyZWN0aXZlcyA9IHsKICAgIGNyZWF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICAgIHVwZGF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIHVuYmluZERpcmVjdGl2ZXMgKHZub2RlKSB7CiAgICAgIHVwZGF0ZURpcmVjdGl2ZXModm5vZGUsIGVtcHR5Tm9kZSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gdXBkYXRlRGlyZWN0aXZlcyAob2xkVm5vZGUsIHZub2RlKSB7CiAgICBpZiAob2xkVm5vZGUuZGF0YS5kaXJlY3RpdmVzIHx8IHZub2RlLmRhdGEuZGlyZWN0aXZlcykgewogICAgICBfdXBkYXRlKG9sZFZub2RlLCB2bm9kZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfdXBkYXRlIChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBpc0NyZWF0ZSA9IG9sZFZub2RlID09PSBlbXB0eU5vZGU7CiAgICB2YXIgaXNEZXN0cm95ID0gdm5vZGUgPT09IGVtcHR5Tm9kZTsKICAgIHZhciBvbGREaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyQxKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcywgb2xkVm5vZGUuY29udGV4dCk7CiAgICB2YXIgbmV3RGlycyA9IG5vcm1hbGl6ZURpcmVjdGl2ZXMkMSh2bm9kZS5kYXRhLmRpcmVjdGl2ZXMsIHZub2RlLmNvbnRleHQpOwoKICAgIHZhciBkaXJzV2l0aEluc2VydCA9IFtdOwogICAgdmFyIGRpcnNXaXRoUG9zdHBhdGNoID0gW107CgogICAgdmFyIGtleSwgb2xkRGlyLCBkaXI7CiAgICBmb3IgKGtleSBpbiBuZXdEaXJzKSB7CiAgICAgIG9sZERpciA9IG9sZERpcnNba2V5XTsKICAgICAgZGlyID0gbmV3RGlyc1trZXldOwogICAgICBpZiAoIW9sZERpcikgewogICAgICAgIC8vIG5ldyBkaXJlY3RpdmUsIGJpbmQKICAgICAgICBjYWxsSG9vayQxKGRpciwgJ2JpbmQnLCB2bm9kZSwgb2xkVm5vZGUpOwogICAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGRpcnNXaXRoSW5zZXJ0LnB1c2goZGlyKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZXhpc3RpbmcgZGlyZWN0aXZlLCB1cGRhdGUKICAgICAgICBkaXIub2xkVmFsdWUgPSBvbGREaXIudmFsdWU7CiAgICAgICAgZGlyLm9sZEFyZyA9IG9sZERpci5hcmc7CiAgICAgICAgY2FsbEhvb2skMShkaXIsICd1cGRhdGUnLCB2bm9kZSwgb2xkVm5vZGUpOwogICAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuY29tcG9uZW50VXBkYXRlZCkgewogICAgICAgICAgZGlyc1dpdGhQb3N0cGF0Y2gucHVzaChkaXIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChkaXJzV2l0aEluc2VydC5sZW5ndGgpIHsKICAgICAgdmFyIGNhbGxJbnNlcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aEluc2VydC5sZW5ndGg7IGkrKykgewogICAgICAgICAgY2FsbEhvb2skMShkaXJzV2l0aEluc2VydFtpXSwgJ2luc2VydGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGlmIChpc0NyZWF0ZSkgewogICAgICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgY2FsbEluc2VydCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbEluc2VydCgpOwogICAgICB9CiAgICB9CgogICAgaWYgKGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aCkgewogICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjYWxsSG9vayQxKGRpcnNXaXRoUG9zdHBhdGNoW2ldLCAnY29tcG9uZW50VXBkYXRlZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoIWlzQ3JlYXRlKSB7CiAgICAgIGZvciAoa2V5IGluIG9sZERpcnMpIHsKICAgICAgICBpZiAoIW5ld0RpcnNba2V5XSkgewogICAgICAgICAgLy8gbm8gbG9uZ2VyIHByZXNlbnQsIHVuYmluZAogICAgICAgICAgY2FsbEhvb2skMShvbGREaXJzW2tleV0sICd1bmJpbmQnLCBvbGRWbm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB2YXIgZW1wdHlNb2RpZmllcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICBmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzJDEgKAogICAgZGlycywKICAgIHZtCiAgKSB7CiAgICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIGlmICghZGlycykgewogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgcmV0dXJuIHJlcwogICAgfQogICAgdmFyIGksIGRpcjsKICAgIGZvciAoaSA9IDA7IGkgPCBkaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGRpciA9IGRpcnNbaV07CiAgICAgIGlmICghZGlyLm1vZGlmaWVycykgewogICAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICAgIGRpci5tb2RpZmllcnMgPSBlbXB0eU1vZGlmaWVyczsKICAgICAgfQogICAgICByZXNbZ2V0UmF3RGlyTmFtZShkaXIpXSA9IGRpcjsKICAgICAgZGlyLmRlZiA9IHJlc29sdmVBc3NldCh2bS4kb3B0aW9ucywgJ2RpcmVjdGl2ZXMnLCBkaXIubmFtZSwgdHJ1ZSk7CiAgICB9CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIHJldHVybiByZXMKICB9CgogIGZ1bmN0aW9uIGdldFJhd0Rpck5hbWUgKGRpcikgewogICAgcmV0dXJuIGRpci5yYXdOYW1lIHx8ICgoZGlyLm5hbWUpICsgIi4iICsgKE9iamVjdC5rZXlzKGRpci5tb2RpZmllcnMgfHwge30pLmpvaW4oJy4nKSkpCiAgfQoKICBmdW5jdGlvbiBjYWxsSG9vayQxIChkaXIsIGhvb2ssIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KSB7CiAgICB2YXIgZm4gPSBkaXIuZGVmICYmIGRpci5kZWZbaG9va107CiAgICBpZiAoZm4pIHsKICAgICAgdHJ5IHsKICAgICAgICBmbih2bm9kZS5lbG0sIGRpciwgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm5vZGUuY29udGV4dCwgKCJkaXJlY3RpdmUgIiArIChkaXIubmFtZSkgKyAiICIgKyBob29rICsgIiBob29rIikpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgYmFzZU1vZHVsZXMgPSBbCiAgICByZWYsCiAgICBkaXJlY3RpdmVzCiAgXTsKCiAgLyogICovCgogIGZ1bmN0aW9uIHVwZGF0ZUF0dHJzIChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBvcHRzID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgIGlmIChpc0RlZihvcHRzKSAmJiBvcHRzLkN0b3Iub3B0aW9ucy5pbmhlcml0QXR0cnMgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5hdHRycykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmF0dHJzKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBrZXksIGN1ciwgb2xkOwogICAgdmFyIGVsbSA9IHZub2RlLmVsbTsKICAgIHZhciBvbGRBdHRycyA9IG9sZFZub2RlLmRhdGEuYXR0cnMgfHwge307CiAgICB2YXIgYXR0cnMgPSB2bm9kZS5kYXRhLmF0dHJzIHx8IHt9OwogICAgLy8gY2xvbmUgb2JzZXJ2ZWQgb2JqZWN0cywgYXMgdGhlIHVzZXIgcHJvYmFibHkgd2FudHMgdG8gbXV0YXRlIGl0CiAgICBpZiAoaXNEZWYoYXR0cnMuX19vYl9fKSkgewogICAgICBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgPSBleHRlbmQoe30sIGF0dHJzKTsKICAgIH0KCiAgICBmb3IgKGtleSBpbiBhdHRycykgewogICAgICBjdXIgPSBhdHRyc1trZXldOwogICAgICBvbGQgPSBvbGRBdHRyc1trZXldOwogICAgICBpZiAob2xkICE9PSBjdXIpIHsKICAgICAgICBzZXRBdHRyKGVsbSwga2V5LCBjdXIpOwogICAgICB9CiAgICB9CiAgICAvLyAjNDM5MTogaW4gSUU5LCBzZXR0aW5nIHR5cGUgY2FuIHJlc2V0IHZhbHVlIGZvciBpbnB1dFt0eXBlPXJhZGlvXQogICAgLy8gIzY2NjY6IElFL0VkZ2UgZm9yY2VzIHByb2dyZXNzIHZhbHVlIGRvd24gdG8gMSBiZWZvcmUgc2V0dGluZyBhIG1heAogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoKGlzSUUgfHwgaXNFZGdlKSAmJiBhdHRycy52YWx1ZSAhPT0gb2xkQXR0cnMudmFsdWUpIHsKICAgICAgc2V0QXR0cihlbG0sICd2YWx1ZScsIGF0dHJzLnZhbHVlKTsKICAgIH0KICAgIGZvciAoa2V5IGluIG9sZEF0dHJzKSB7CiAgICAgIGlmIChpc1VuZGVmKGF0dHJzW2tleV0pKSB7CiAgICAgICAgaWYgKGlzWGxpbmsoa2V5KSkgewogICAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgICAgICB9IGVsc2UgaWYgKCFpc0VudW1lcmF0ZWRBdHRyKGtleSkpIHsKICAgICAgICAgIGVsbS5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldEF0dHIgKGVsLCBrZXksIHZhbHVlKSB7CiAgICBpZiAoZWwudGFnTmFtZS5pbmRleE9mKCctJykgPiAtMSkgewogICAgICBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKGlzQm9vbGVhbkF0dHIoa2V5KSkgewogICAgICAvLyBzZXQgYXR0cmlidXRlIGZvciBibGFuayB2YWx1ZQogICAgICAvLyBlLmcuIDxvcHRpb24gZGlzYWJsZWQ+U2VsZWN0IG9uZTwvb3B0aW9uPgogICAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0ZWNobmljYWxseSBhbGxvd2Z1bGxzY3JlZW4gaXMgYSBib29sZWFuIGF0dHJpYnV0ZSBmb3IgPGlmcmFtZT4sCiAgICAgICAgLy8gYnV0IEZsYXNoIGV4cGVjdHMgYSB2YWx1ZSBvZiAidHJ1ZSIgd2hlbiB1c2VkIG9uIDxlbWJlZD4gdGFnCiAgICAgICAgdmFsdWUgPSBrZXkgPT09ICdhbGxvd2Z1bGxzY3JlZW4nICYmIGVsLnRhZ05hbWUgPT09ICdFTUJFRCcKICAgICAgICAgID8gJ3RydWUnCiAgICAgICAgICA6IGtleTsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUoa2V5LCB2YWx1ZSkpOwogICAgfSBlbHNlIGlmIChpc1hsaW5rKGtleSkpIHsKICAgICAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlTlMoeGxpbmtOUywgZ2V0WGxpbmtQcm9wKGtleSkpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsLnNldEF0dHJpYnV0ZU5TKHhsaW5rTlMsIGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBiYXNlU2V0QXR0ciAoZWwsIGtleSwgdmFsdWUpIHsKICAgIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vICM3MTM4OiBJRTEwICYgMTEgZmlyZXMgaW5wdXQgZXZlbnQgd2hlbiBzZXR0aW5nIHBsYWNlaG9sZGVyIG9uCiAgICAgIC8vIDx0ZXh0YXJlYT4uLi4gYmxvY2sgdGhlIGZpcnN0IGlucHV0IGV2ZW50IGFuZCByZW1vdmUgdGhlIGJsb2NrZXIKICAgICAgLy8gaW1tZWRpYXRlbHkuCiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoCiAgICAgICAgaXNJRSAmJiAhaXNJRTkgJiYKICAgICAgICBlbC50YWdOYW1lID09PSAnVEVYVEFSRUEnICYmCiAgICAgICAga2V5ID09PSAncGxhY2Vob2xkZXInICYmIHZhbHVlICE9PSAnJyAmJiAhZWwuX19pZXBoCiAgICAgICkgewogICAgICAgIHZhciBibG9ja2VyID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdpbnB1dCcsIGJsb2NrZXIpOwogICAgICAgIH07CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyKTsKICAgICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgICBlbC5fX2llcGggPSB0cnVlOyAvKiBJRSBwbGFjZWhvbGRlciBwYXRjaGVkICovCiAgICAgIH0KICAgICAgZWwuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogICAgfQogIH0KCiAgdmFyIGF0dHJzID0gewogICAgY3JlYXRlOiB1cGRhdGVBdHRycywKICAgIHVwZGF0ZTogdXBkYXRlQXR0cnMKICB9OwoKICAvKiAgKi8KCiAgZnVuY3Rpb24gdXBkYXRlQ2xhc3MgKG9sZFZub2RlLCB2bm9kZSkgewogICAgdmFyIGVsID0gdm5vZGUuZWxtOwogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIG9sZERhdGEgPSBvbGRWbm9kZS5kYXRhOwogICAgaWYgKAogICAgICBpc1VuZGVmKGRhdGEuc3RhdGljQ2xhc3MpICYmCiAgICAgIGlzVW5kZWYoZGF0YS5jbGFzcykgJiYgKAogICAgICAgIGlzVW5kZWYob2xkRGF0YSkgfHwgKAogICAgICAgICAgaXNVbmRlZihvbGREYXRhLnN0YXRpY0NsYXNzKSAmJgogICAgICAgICAgaXNVbmRlZihvbGREYXRhLmNsYXNzKQogICAgICAgICkKICAgICAgKQogICAgKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHZhciBjbHMgPSBnZW5DbGFzc0ZvclZub2RlKHZub2RlKTsKCiAgICAvLyBoYW5kbGUgdHJhbnNpdGlvbiBjbGFzc2VzCiAgICB2YXIgdHJhbnNpdGlvbkNsYXNzID0gZWwuX3RyYW5zaXRpb25DbGFzc2VzOwogICAgaWYgKGlzRGVmKHRyYW5zaXRpb25DbGFzcykpIHsKICAgICAgY2xzID0gY29uY2F0KGNscywgc3RyaW5naWZ5Q2xhc3ModHJhbnNpdGlvbkNsYXNzKSk7CiAgICB9CgogICAgLy8gc2V0IHRoZSBjbGFzcwogICAgaWYgKGNscyAhPT0gZWwuX3ByZXZDbGFzcykgewogICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgY2xzKTsKICAgICAgZWwuX3ByZXZDbGFzcyA9IGNsczsKICAgIH0KICB9CgogIHZhciBrbGFzcyA9IHsKICAgIGNyZWF0ZTogdXBkYXRlQ2xhc3MsCiAgICB1cGRhdGU6IHVwZGF0ZUNsYXNzCiAgfTsKCiAgLyogICovCgogIHZhciB2YWxpZERpdmlzaW9uQ2hhclJFID0gL1tcdykuK1wtXyRcXV0vOwoKICBmdW5jdGlvbiBwYXJzZUZpbHRlcnMgKGV4cCkgewogICAgdmFyIGluU2luZ2xlID0gZmFsc2U7CiAgICB2YXIgaW5Eb3VibGUgPSBmYWxzZTsKICAgIHZhciBpblRlbXBsYXRlU3RyaW5nID0gZmFsc2U7CiAgICB2YXIgaW5SZWdleCA9IGZhbHNlOwogICAgdmFyIGN1cmx5ID0gMDsKICAgIHZhciBzcXVhcmUgPSAwOwogICAgdmFyIHBhcmVuID0gMDsKICAgIHZhciBsYXN0RmlsdGVySW5kZXggPSAwOwogICAgdmFyIGMsIHByZXYsIGksIGV4cHJlc3Npb24sIGZpbHRlcnM7CgogICAgZm9yIChpID0gMDsgaSA8IGV4cC5sZW5ndGg7IGkrKykgewogICAgICBwcmV2ID0gYzsKICAgICAgYyA9IGV4cC5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoaW5TaW5nbGUpIHsKICAgICAgICBpZiAoYyA9PT0gMHgyNyAmJiBwcmV2ICE9PSAweDVDKSB7IGluU2luZ2xlID0gZmFsc2U7IH0KICAgICAgfSBlbHNlIGlmIChpbkRvdWJsZSkgewogICAgICAgIGlmIChjID09PSAweDIyICYmIHByZXYgIT09IDB4NUMpIHsgaW5Eb3VibGUgPSBmYWxzZTsgfQogICAgICB9IGVsc2UgaWYgKGluVGVtcGxhdGVTdHJpbmcpIHsKICAgICAgICBpZiAoYyA9PT0gMHg2MCAmJiBwcmV2ICE9PSAweDVDKSB7IGluVGVtcGxhdGVTdHJpbmcgPSBmYWxzZTsgfQogICAgICB9IGVsc2UgaWYgKGluUmVnZXgpIHsKICAgICAgICBpZiAoYyA9PT0gMHgyZiAmJiBwcmV2ICE9PSAweDVDKSB7IGluUmVnZXggPSBmYWxzZTsgfQogICAgICB9IGVsc2UgaWYgKAogICAgICAgIGMgPT09IDB4N0MgJiYgLy8gcGlwZQogICAgICAgIGV4cC5jaGFyQ29kZUF0KGkgKyAxKSAhPT0gMHg3QyAmJgogICAgICAgIGV4cC5jaGFyQ29kZUF0KGkgLSAxKSAhPT0gMHg3QyAmJgogICAgICAgICFjdXJseSAmJiAhc3F1YXJlICYmICFwYXJlbgogICAgICApIHsKICAgICAgICBpZiAoZXhwcmVzc2lvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAvLyBmaXJzdCBmaWx0ZXIsIGVuZCBvZiBleHByZXNzaW9uCiAgICAgICAgICBsYXN0RmlsdGVySW5kZXggPSBpICsgMTsKICAgICAgICAgIGV4cHJlc3Npb24gPSBleHAuc2xpY2UoMCwgaSkudHJpbSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwdXNoRmlsdGVyKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHN3aXRjaCAoYykgewogICAgICAgICAgY2FzZSAweDIyOiBpbkRvdWJsZSA9IHRydWU7IGJyZWFrICAgICAgICAgLy8gIgogICAgICAgICAgY2FzZSAweDI3OiBpblNpbmdsZSA9IHRydWU7IGJyZWFrICAgICAgICAgLy8gJwogICAgICAgICAgY2FzZSAweDYwOiBpblRlbXBsYXRlU3RyaW5nID0gdHJ1ZTsgYnJlYWsgLy8gYAogICAgICAgICAgY2FzZSAweDI4OiBwYXJlbisrOyBicmVhayAgICAgICAgICAgICAgICAgLy8gKAogICAgICAgICAgY2FzZSAweDI5OiBwYXJlbi0tOyBicmVhayAgICAgICAgICAgICAgICAgLy8gKQogICAgICAgICAgY2FzZSAweDVCOiBzcXVhcmUrKzsgYnJlYWsgICAgICAgICAgICAgICAgLy8gWwogICAgICAgICAgY2FzZSAweDVEOiBzcXVhcmUtLTsgYnJlYWsgICAgICAgICAgICAgICAgLy8gXQogICAgICAgICAgY2FzZSAweDdCOiBjdXJseSsrOyBicmVhayAgICAgICAgICAgICAgICAgLy8gewogICAgICAgICAgY2FzZSAweDdEOiBjdXJseS0tOyBicmVhayAgICAgICAgICAgICAgICAgLy8gfQogICAgICAgIH0KICAgICAgICBpZiAoYyA9PT0gMHgyZikgeyAvLyAvCiAgICAgICAgICB2YXIgaiA9IGkgLSAxOwogICAgICAgICAgdmFyIHAgPSAodm9pZCAwKTsKICAgICAgICAgIC8vIGZpbmQgZmlyc3Qgbm9uLXdoaXRlc3BhY2UgcHJldiBjaGFyCiAgICAgICAgICBmb3IgKDsgaiA+PSAwOyBqLS0pIHsKICAgICAgICAgICAgcCA9IGV4cC5jaGFyQXQoaik7CiAgICAgICAgICAgIGlmIChwICE9PSAnICcpIHsgYnJlYWsgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFwIHx8ICF2YWxpZERpdmlzaW9uQ2hhclJFLnRlc3QocCkpIHsKICAgICAgICAgICAgaW5SZWdleCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKGV4cHJlc3Npb24gPT09IHVuZGVmaW5lZCkgewogICAgICBleHByZXNzaW9uID0gZXhwLnNsaWNlKDAsIGkpLnRyaW0oKTsKICAgIH0gZWxzZSBpZiAobGFzdEZpbHRlckluZGV4ICE9PSAwKSB7CiAgICAgIHB1c2hGaWx0ZXIoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwdXNoRmlsdGVyICgpIHsKICAgICAgKGZpbHRlcnMgfHwgKGZpbHRlcnMgPSBbXSkpLnB1c2goZXhwLnNsaWNlKGxhc3RGaWx0ZXJJbmRleCwgaSkudHJpbSgpKTsKICAgICAgbGFzdEZpbHRlckluZGV4ID0gaSArIDE7CiAgICB9CgogICAgaWYgKGZpbHRlcnMpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGZpbHRlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBleHByZXNzaW9uID0gd3JhcEZpbHRlcihleHByZXNzaW9uLCBmaWx0ZXJzW2ldKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBleHByZXNzaW9uCiAgfQoKICBmdW5jdGlvbiB3cmFwRmlsdGVyIChleHAsIGZpbHRlcikgewogICAgdmFyIGkgPSBmaWx0ZXIuaW5kZXhPZignKCcpOwogICAgaWYgKGkgPCAwKSB7CiAgICAgIC8vIF9mOiByZXNvbHZlRmlsdGVyCiAgICAgIHJldHVybiAoIl9mKFwiIiArIGZpbHRlciArICJcIikoIiArIGV4cCArICIpIikKICAgIH0gZWxzZSB7CiAgICAgIHZhciBuYW1lID0gZmlsdGVyLnNsaWNlKDAsIGkpOwogICAgICB2YXIgYXJncyA9IGZpbHRlci5zbGljZShpICsgMSk7CiAgICAgIHJldHVybiAoIl9mKFwiIiArIG5hbWUgKyAiXCIpKCIgKyBleHAgKyAoYXJncyAhPT0gJyknID8gJywnICsgYXJncyA6IGFyZ3MpKQogICAgfQogIH0KCiAgLyogICovCgoKCiAgLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi8KICBmdW5jdGlvbiBiYXNlV2FybiAobXNnLCByYW5nZSkgewogICAgY29uc29sZS5lcnJvcigoIltWdWUgY29tcGlsZXJdOiAiICsgbXNnKSk7CiAgfQogIC8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi8KCiAgZnVuY3Rpb24gcGx1Y2tNb2R1bGVGdW5jdGlvbiAoCiAgICBtb2R1bGVzLAogICAga2V5CiAgKSB7CiAgICByZXR1cm4gbW9kdWxlcwogICAgICA/IG1vZHVsZXMubWFwKGZ1bmN0aW9uIChtKSB7IHJldHVybiBtW2tleV07IH0pLmZpbHRlcihmdW5jdGlvbiAoXykgeyByZXR1cm4gXzsgfSkKICAgICAgOiBbXQogIH0KCiAgZnVuY3Rpb24gYWRkUHJvcCAoZWwsIG5hbWUsIHZhbHVlLCByYW5nZSwgZHluYW1pYykgewogICAgKGVsLnByb3BzIHx8IChlbC5wcm9wcyA9IFtdKSkucHVzaChyYW5nZVNldEl0ZW0oeyBuYW1lOiBuYW1lLCB2YWx1ZTogdmFsdWUsIGR5bmFtaWM6IGR5bmFtaWMgfSwgcmFuZ2UpKTsKICAgIGVsLnBsYWluID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBhZGRBdHRyIChlbCwgbmFtZSwgdmFsdWUsIHJhbmdlLCBkeW5hbWljKSB7CiAgICB2YXIgYXR0cnMgPSBkeW5hbWljCiAgICAgID8gKGVsLmR5bmFtaWNBdHRycyB8fCAoZWwuZHluYW1pY0F0dHJzID0gW10pKQogICAgICA6IChlbC5hdHRycyB8fCAoZWwuYXR0cnMgPSBbXSkpOwogICAgYXR0cnMucHVzaChyYW5nZVNldEl0ZW0oeyBuYW1lOiBuYW1lLCB2YWx1ZTogdmFsdWUsIGR5bmFtaWM6IGR5bmFtaWMgfSwgcmFuZ2UpKTsKICAgIGVsLnBsYWluID0gZmFsc2U7CiAgfQoKICAvLyBhZGQgYSByYXcgYXR0ciAodXNlIHRoaXMgaW4gcHJlVHJhbnNmb3JtcykKICBmdW5jdGlvbiBhZGRSYXdBdHRyIChlbCwgbmFtZSwgdmFsdWUsIHJhbmdlKSB7CiAgICBlbC5hdHRyc01hcFtuYW1lXSA9IHZhbHVlOwogICAgZWwuYXR0cnNMaXN0LnB1c2gocmFuZ2VTZXRJdGVtKHsgbmFtZTogbmFtZSwgdmFsdWU6IHZhbHVlIH0sIHJhbmdlKSk7CiAgfQoKICBmdW5jdGlvbiBhZGREaXJlY3RpdmUgKAogICAgZWwsCiAgICBuYW1lLAogICAgcmF3TmFtZSwKICAgIHZhbHVlLAogICAgYXJnLAogICAgaXNEeW5hbWljQXJnLAogICAgbW9kaWZpZXJzLAogICAgcmFuZ2UKICApIHsKICAgIChlbC5kaXJlY3RpdmVzIHx8IChlbC5kaXJlY3RpdmVzID0gW10pKS5wdXNoKHJhbmdlU2V0SXRlbSh7CiAgICAgIG5hbWU6IG5hbWUsCiAgICAgIHJhd05hbWU6IHJhd05hbWUsCiAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgYXJnOiBhcmcsCiAgICAgIGlzRHluYW1pY0FyZzogaXNEeW5hbWljQXJnLAogICAgICBtb2RpZmllcnM6IG1vZGlmaWVycwogICAgfSwgcmFuZ2UpKTsKICAgIGVsLnBsYWluID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBwcmVwZW5kTW9kaWZpZXJNYXJrZXIgKHN5bWJvbCwgbmFtZSwgZHluYW1pYykgewogICAgcmV0dXJuIGR5bmFtaWMKICAgICAgPyAoIl9wKCIgKyBuYW1lICsgIixcIiIgKyBzeW1ib2wgKyAiXCIpIikKICAgICAgOiBzeW1ib2wgKyBuYW1lIC8vIG1hcmsgdGhlIGV2ZW50IGFzIGNhcHR1cmVkCiAgfQoKICBmdW5jdGlvbiBhZGRIYW5kbGVyICgKICAgIGVsLAogICAgbmFtZSwKICAgIHZhbHVlLAogICAgbW9kaWZpZXJzLAogICAgaW1wb3J0YW50LAogICAgd2FybiwKICAgIHJhbmdlLAogICAgZHluYW1pYwogICkgewogICAgbW9kaWZpZXJzID0gbW9kaWZpZXJzIHx8IGVtcHR5T2JqZWN0OwogICAgLy8gd2FybiBwcmV2ZW50IGFuZCBwYXNzaXZlIG1vZGlmaWVyCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICgKICAgICAgd2FybiAmJgogICAgICBtb2RpZmllcnMucHJldmVudCAmJiBtb2RpZmllcnMucGFzc2l2ZQogICAgKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ3Bhc3NpdmUgYW5kIHByZXZlbnQgY2FuXCd0IGJlIHVzZWQgdG9nZXRoZXIuICcgKwogICAgICAgICdQYXNzaXZlIGhhbmRsZXIgY2FuXCd0IHByZXZlbnQgZGVmYXVsdCBldmVudC4nLAogICAgICAgIHJhbmdlCiAgICAgICk7CiAgICB9CgogICAgLy8gbm9ybWFsaXplIGNsaWNrLnJpZ2h0IGFuZCBjbGljay5taWRkbGUgc2luY2UgdGhleSBkb24ndCBhY3R1YWxseSBmaXJlCiAgICAvLyB0aGlzIGlzIHRlY2huaWNhbGx5IGJyb3dzZXItc3BlY2lmaWMsIGJ1dCBhdCBsZWFzdCBmb3Igbm93IGJyb3dzZXJzIGFyZQogICAgLy8gdGhlIG9ubHkgdGFyZ2V0IGVudnMgdGhhdCBoYXZlIHJpZ2h0L21pZGRsZSBjbGlja3MuCiAgICBpZiAobW9kaWZpZXJzLnJpZ2h0KSB7CiAgICAgIGlmIChkeW5hbWljKSB7CiAgICAgICAgbmFtZSA9ICIoIiArIG5hbWUgKyAiKT09PSdjbGljayc/J2NvbnRleHRtZW51JzooIiArIG5hbWUgKyAiKSI7CiAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ2NsaWNrJykgewogICAgICAgIG5hbWUgPSAnY29udGV4dG1lbnUnOwogICAgICAgIGRlbGV0ZSBtb2RpZmllcnMucmlnaHQ7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobW9kaWZpZXJzLm1pZGRsZSkgewogICAgICBpZiAoZHluYW1pYykgewogICAgICAgIG5hbWUgPSAiKCIgKyBuYW1lICsgIik9PT0nY2xpY2snPydtb3VzZXVwJzooIiArIG5hbWUgKyAiKSI7CiAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gJ2NsaWNrJykgewogICAgICAgIG5hbWUgPSAnbW91c2V1cCc7CiAgICAgIH0KICAgIH0KCiAgICAvLyBjaGVjayBjYXB0dXJlIG1vZGlmaWVyCiAgICBpZiAobW9kaWZpZXJzLmNhcHR1cmUpIHsKICAgICAgZGVsZXRlIG1vZGlmaWVycy5jYXB0dXJlOwogICAgICBuYW1lID0gcHJlcGVuZE1vZGlmaWVyTWFya2VyKCchJywgbmFtZSwgZHluYW1pYyk7CiAgICB9CiAgICBpZiAobW9kaWZpZXJzLm9uY2UpIHsKICAgICAgZGVsZXRlIG1vZGlmaWVycy5vbmNlOwogICAgICBuYW1lID0gcHJlcGVuZE1vZGlmaWVyTWFya2VyKCd+JywgbmFtZSwgZHluYW1pYyk7CiAgICB9CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChtb2RpZmllcnMucGFzc2l2ZSkgewogICAgICBkZWxldGUgbW9kaWZpZXJzLnBhc3NpdmU7CiAgICAgIG5hbWUgPSBwcmVwZW5kTW9kaWZpZXJNYXJrZXIoJyYnLCBuYW1lLCBkeW5hbWljKTsKICAgIH0KCiAgICB2YXIgZXZlbnRzOwogICAgaWYgKG1vZGlmaWVycy5uYXRpdmUpIHsKICAgICAgZGVsZXRlIG1vZGlmaWVycy5uYXRpdmU7CiAgICAgIGV2ZW50cyA9IGVsLm5hdGl2ZUV2ZW50cyB8fCAoZWwubmF0aXZlRXZlbnRzID0ge30pOwogICAgfSBlbHNlIHsKICAgICAgZXZlbnRzID0gZWwuZXZlbnRzIHx8IChlbC5ldmVudHMgPSB7fSk7CiAgICB9CgogICAgdmFyIG5ld0hhbmRsZXIgPSByYW5nZVNldEl0ZW0oeyB2YWx1ZTogdmFsdWUudHJpbSgpLCBkeW5hbWljOiBkeW5hbWljIH0sIHJhbmdlKTsKICAgIGlmIChtb2RpZmllcnMgIT09IGVtcHR5T2JqZWN0KSB7CiAgICAgIG5ld0hhbmRsZXIubW9kaWZpZXJzID0gbW9kaWZpZXJzOwogICAgfQoKICAgIHZhciBoYW5kbGVycyA9IGV2ZW50c1tuYW1lXTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKEFycmF5LmlzQXJyYXkoaGFuZGxlcnMpKSB7CiAgICAgIGltcG9ydGFudCA/IGhhbmRsZXJzLnVuc2hpZnQobmV3SGFuZGxlcikgOiBoYW5kbGVycy5wdXNoKG5ld0hhbmRsZXIpOwogICAgfSBlbHNlIGlmIChoYW5kbGVycykgewogICAgICBldmVudHNbbmFtZV0gPSBpbXBvcnRhbnQgPyBbbmV3SGFuZGxlciwgaGFuZGxlcnNdIDogW2hhbmRsZXJzLCBuZXdIYW5kbGVyXTsKICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50c1tuYW1lXSA9IG5ld0hhbmRsZXI7CiAgICB9CgogICAgZWwucGxhaW4gPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGdldFJhd0JpbmRpbmdBdHRyICgKICAgIGVsLAogICAgbmFtZQogICkgewogICAgcmV0dXJuIGVsLnJhd0F0dHJzTWFwWyc6JyArIG5hbWVdIHx8CiAgICAgIGVsLnJhd0F0dHJzTWFwWyd2LWJpbmQ6JyArIG5hbWVdIHx8CiAgICAgIGVsLnJhd0F0dHJzTWFwW25hbWVdCiAgfQoKICBmdW5jdGlvbiBnZXRCaW5kaW5nQXR0ciAoCiAgICBlbCwKICAgIG5hbWUsCiAgICBnZXRTdGF0aWMKICApIHsKICAgIHZhciBkeW5hbWljVmFsdWUgPQogICAgICBnZXRBbmRSZW1vdmVBdHRyKGVsLCAnOicgKyBuYW1lKSB8fAogICAgICBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1iaW5kOicgKyBuYW1lKTsKICAgIGlmIChkeW5hbWljVmFsdWUgIT0gbnVsbCkgewogICAgICByZXR1cm4gcGFyc2VGaWx0ZXJzKGR5bmFtaWNWYWx1ZSkKICAgIH0gZWxzZSBpZiAoZ2V0U3RhdGljICE9PSBmYWxzZSkgewogICAgICB2YXIgc3RhdGljVmFsdWUgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCBuYW1lKTsKICAgICAgaWYgKHN0YXRpY1ZhbHVlICE9IG51bGwpIHsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoc3RhdGljVmFsdWUpCiAgICAgIH0KICAgIH0KICB9CgogIC8vIG5vdGU6IHRoaXMgb25seSByZW1vdmVzIHRoZSBhdHRyIGZyb20gdGhlIEFycmF5IChhdHRyc0xpc3QpIHNvIHRoYXQgaXQKICAvLyBkb2Vzbid0IGdldCBwcm9jZXNzZWQgYnkgcHJvY2Vzc0F0dHJzLgogIC8vIEJ5IGRlZmF1bHQgaXQgZG9lcyBOT1QgcmVtb3ZlIGl0IGZyb20gdGhlIG1hcCAoYXR0cnNNYXApIGJlY2F1c2UgdGhlIG1hcCBpcwogIC8vIG5lZWRlZCBkdXJpbmcgY29kZWdlbi4KICBmdW5jdGlvbiBnZXRBbmRSZW1vdmVBdHRyICgKICAgIGVsLAogICAgbmFtZSwKICAgIHJlbW92ZUZyb21NYXAKICApIHsKICAgIHZhciB2YWw7CiAgICBpZiAoKHZhbCA9IGVsLmF0dHJzTWFwW25hbWVdKSAhPSBudWxsKSB7CiAgICAgIHZhciBsaXN0ID0gZWwuYXR0cnNMaXN0OwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGxpc3RbaV0ubmFtZSA9PT0gbmFtZSkgewogICAgICAgICAgbGlzdC5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHJlbW92ZUZyb21NYXApIHsKICAgICAgZGVsZXRlIGVsLmF0dHJzTWFwW25hbWVdOwogICAgfQogICAgcmV0dXJuIHZhbAogIH0KCiAgZnVuY3Rpb24gZ2V0QW5kUmVtb3ZlQXR0ckJ5UmVnZXggKAogICAgZWwsCiAgICBuYW1lCiAgKSB7CiAgICB2YXIgbGlzdCA9IGVsLmF0dHJzTGlzdDsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIGF0dHIgPSBsaXN0W2ldOwogICAgICBpZiAobmFtZS50ZXN0KGF0dHIubmFtZSkpIHsKICAgICAgICBsaXN0LnNwbGljZShpLCAxKTsKICAgICAgICByZXR1cm4gYXR0cgogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByYW5nZVNldEl0ZW0gKAogICAgaXRlbSwKICAgIHJhbmdlCiAgKSB7CiAgICBpZiAocmFuZ2UpIHsKICAgICAgaWYgKHJhbmdlLnN0YXJ0ICE9IG51bGwpIHsKICAgICAgICBpdGVtLnN0YXJ0ID0gcmFuZ2Uuc3RhcnQ7CiAgICAgIH0KICAgICAgaWYgKHJhbmdlLmVuZCAhPSBudWxsKSB7CiAgICAgICAgaXRlbS5lbmQgPSByYW5nZS5lbmQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpdGVtCiAgfQoKICAvKiAgKi8KCiAgLyoqCiAgICogQ3Jvc3MtcGxhdGZvcm0gY29kZSBnZW5lcmF0aW9uIGZvciBjb21wb25lbnQgdi1tb2RlbAogICAqLwogIGZ1bmN0aW9uIGdlbkNvbXBvbmVudE1vZGVsICgKICAgIGVsLAogICAgdmFsdWUsCiAgICBtb2RpZmllcnMKICApIHsKICAgIHZhciByZWYgPSBtb2RpZmllcnMgfHwge307CiAgICB2YXIgbnVtYmVyID0gcmVmLm51bWJlcjsKICAgIHZhciB0cmltID0gcmVmLnRyaW07CgogICAgdmFyIGJhc2VWYWx1ZUV4cHJlc3Npb24gPSAnJCR2JzsKICAgIHZhciB2YWx1ZUV4cHJlc3Npb24gPSBiYXNlVmFsdWVFeHByZXNzaW9uOwogICAgaWYgKHRyaW0pIHsKICAgICAgdmFsdWVFeHByZXNzaW9uID0KICAgICAgICAiKHR5cGVvZiAiICsgYmFzZVZhbHVlRXhwcmVzc2lvbiArICIgPT09ICdzdHJpbmcnIiArCiAgICAgICAgIj8gIiArIGJhc2VWYWx1ZUV4cHJlc3Npb24gKyAiLnRyaW0oKSIgKwogICAgICAgICI6ICIgKyBiYXNlVmFsdWVFeHByZXNzaW9uICsgIikiOwogICAgfQogICAgaWYgKG51bWJlcikgewogICAgICB2YWx1ZUV4cHJlc3Npb24gPSAiX24oIiArIHZhbHVlRXhwcmVzc2lvbiArICIpIjsKICAgIH0KICAgIHZhciBhc3NpZ25tZW50ID0gZ2VuQXNzaWdubWVudENvZGUodmFsdWUsIHZhbHVlRXhwcmVzc2lvbik7CgogICAgZWwubW9kZWwgPSB7CiAgICAgIHZhbHVlOiAoIigiICsgdmFsdWUgKyAiKSIpLAogICAgICBleHByZXNzaW9uOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSksCiAgICAgIGNhbGxiYWNrOiAoImZ1bmN0aW9uICgiICsgYmFzZVZhbHVlRXhwcmVzc2lvbiArICIpIHsiICsgYXNzaWdubWVudCArICJ9IikKICAgIH07CiAgfQoKICAvKioKICAgKiBDcm9zcy1wbGF0Zm9ybSBjb2RlZ2VuIGhlbHBlciBmb3IgZ2VuZXJhdGluZyB2LW1vZGVsIHZhbHVlIGFzc2lnbm1lbnQgY29kZS4KICAgKi8KICBmdW5jdGlvbiBnZW5Bc3NpZ25tZW50Q29kZSAoCiAgICB2YWx1ZSwKICAgIGFzc2lnbm1lbnQKICApIHsKICAgIHZhciByZXMgPSBwYXJzZU1vZGVsKHZhbHVlKTsKICAgIGlmIChyZXMua2V5ID09PSBudWxsKSB7CiAgICAgIHJldHVybiAodmFsdWUgKyAiPSIgKyBhc3NpZ25tZW50KQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICgiJHNldCgiICsgKHJlcy5leHApICsgIiwgIiArIChyZXMua2V5KSArICIsICIgKyBhc3NpZ25tZW50ICsgIikiKQogICAgfQogIH0KCiAgLyoqCiAgICogUGFyc2UgYSB2LW1vZGVsIGV4cHJlc3Npb24gaW50byBhIGJhc2UgcGF0aCBhbmQgYSBmaW5hbCBrZXkgc2VnbWVudC4KICAgKiBIYW5kbGVzIGJvdGggZG90LXBhdGggYW5kIHBvc3NpYmxlIHNxdWFyZSBicmFja2V0cy4KICAgKgogICAqIFBvc3NpYmxlIGNhc2VzOgogICAqCiAgICogLSB0ZXN0CiAgICogLSB0ZXN0W2tleV0KICAgKiAtIHRlc3RbdGVzdDFba2V5XV0KICAgKiAtIHRlc3RbImEiXVtrZXldCiAgICogLSB4eHgudGVzdFthW2FdLnRlc3QxW2tleV1dCiAgICogLSB0ZXN0Lnh4eC5hWyJhc2EiXVt0ZXN0MVtrZXldXQogICAqCiAgICovCgogIHZhciBsZW4sIHN0ciwgY2hyLCBpbmRleCQxLCBleHByZXNzaW9uUG9zLCBleHByZXNzaW9uRW5kUG9zOwoKCgogIGZ1bmN0aW9uIHBhcnNlTW9kZWwgKHZhbCkgewogICAgLy8gRml4IGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUvcHVsbC83NzMwCiAgICAvLyBhbGxvdyB2LW1vZGVsPSJvYmoudmFsICIgKHRyYWlsaW5nIHdoaXRlc3BhY2UpCiAgICB2YWwgPSB2YWwudHJpbSgpOwogICAgbGVuID0gdmFsLmxlbmd0aDsKCiAgICBpZiAodmFsLmluZGV4T2YoJ1snKSA8IDAgfHwgdmFsLmxhc3RJbmRleE9mKCddJykgPCBsZW4gLSAxKSB7CiAgICAgIGluZGV4JDEgPSB2YWwubGFzdEluZGV4T2YoJy4nKTsKICAgICAgaWYgKGluZGV4JDEgPiAtMSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBleHA6IHZhbC5zbGljZSgwLCBpbmRleCQxKSwKICAgICAgICAgIGtleTogJyInICsgdmFsLnNsaWNlKGluZGV4JDEgKyAxKSArICciJwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZXhwOiB2YWwsCiAgICAgICAgICBrZXk6IG51bGwKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzdHIgPSB2YWw7CiAgICBpbmRleCQxID0gZXhwcmVzc2lvblBvcyA9IGV4cHJlc3Npb25FbmRQb3MgPSAwOwoKICAgIHdoaWxlICghZW9mKCkpIHsKICAgICAgY2hyID0gbmV4dCgpOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKGlzU3RyaW5nU3RhcnQoY2hyKSkgewogICAgICAgIHBhcnNlU3RyaW5nKGNocik7CiAgICAgIH0gZWxzZSBpZiAoY2hyID09PSAweDVCKSB7CiAgICAgICAgcGFyc2VCcmFja2V0KGNocik7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICBleHA6IHZhbC5zbGljZSgwLCBleHByZXNzaW9uUG9zKSwKICAgICAga2V5OiB2YWwuc2xpY2UoZXhwcmVzc2lvblBvcyArIDEsIGV4cHJlc3Npb25FbmRQb3MpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBuZXh0ICgpIHsKICAgIHJldHVybiBzdHIuY2hhckNvZGVBdCgrK2luZGV4JDEpCiAgfQoKICBmdW5jdGlvbiBlb2YgKCkgewogICAgcmV0dXJuIGluZGV4JDEgPj0gbGVuCiAgfQoKICBmdW5jdGlvbiBpc1N0cmluZ1N0YXJ0IChjaHIpIHsKICAgIHJldHVybiBjaHIgPT09IDB4MjIgfHwgY2hyID09PSAweDI3CiAgfQoKICBmdW5jdGlvbiBwYXJzZUJyYWNrZXQgKGNocikgewogICAgdmFyIGluQnJhY2tldCA9IDE7CiAgICBleHByZXNzaW9uUG9zID0gaW5kZXgkMTsKICAgIHdoaWxlICghZW9mKCkpIHsKICAgICAgY2hyID0gbmV4dCgpOwogICAgICBpZiAoaXNTdHJpbmdTdGFydChjaHIpKSB7CiAgICAgICAgcGFyc2VTdHJpbmcoY2hyKTsKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICAgIGlmIChjaHIgPT09IDB4NUIpIHsgaW5CcmFja2V0Kys7IH0KICAgICAgaWYgKGNociA9PT0gMHg1RCkgeyBpbkJyYWNrZXQtLTsgfQogICAgICBpZiAoaW5CcmFja2V0ID09PSAwKSB7CiAgICAgICAgZXhwcmVzc2lvbkVuZFBvcyA9IGluZGV4JDE7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcGFyc2VTdHJpbmcgKGNocikgewogICAgdmFyIHN0cmluZ1F1b3RlID0gY2hyOwogICAgd2hpbGUgKCFlb2YoKSkgewogICAgICBjaHIgPSBuZXh0KCk7CiAgICAgIGlmIChjaHIgPT09IHN0cmluZ1F1b3RlKSB7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIH0KCiAgLyogICovCgogIHZhciB3YXJuJDE7CgogIC8vIGluIHNvbWUgY2FzZXMsIHRoZSBldmVudCB1c2VkIGhhcyB0byBiZSBkZXRlcm1pbmVkIGF0IHJ1bnRpbWUKICAvLyBzbyB3ZSB1c2VkIHNvbWUgcmVzZXJ2ZWQgdG9rZW5zIGR1cmluZyBjb21waWxlLgogIHZhciBSQU5HRV9UT0tFTiA9ICdfX3InOwogIHZhciBDSEVDS0JPWF9SQURJT19UT0tFTiA9ICdfX2MnOwoKICBmdW5jdGlvbiBtb2RlbCAoCiAgICBlbCwKICAgIGRpciwKICAgIF93YXJuCiAgKSB7CiAgICB3YXJuJDEgPSBfd2FybjsKICAgIHZhciB2YWx1ZSA9IGRpci52YWx1ZTsKICAgIHZhciBtb2RpZmllcnMgPSBkaXIubW9kaWZpZXJzOwogICAgdmFyIHRhZyA9IGVsLnRhZzsKICAgIHZhciB0eXBlID0gZWwuYXR0cnNNYXAudHlwZTsKCiAgICB7CiAgICAgIC8vIGlucHV0cyB3aXRoIHR5cGU9ImZpbGUiIGFyZSByZWFkIG9ubHkgYW5kIHNldHRpbmcgdGhlIGlucHV0J3MKICAgICAgLy8gdmFsdWUgd2lsbCB0aHJvdyBhbiBlcnJvci4KICAgICAgaWYgKHRhZyA9PT0gJ2lucHV0JyAmJiB0eXBlID09PSAnZmlsZScpIHsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICAiPCIgKyAoZWwudGFnKSArICIgdi1tb2RlbD1cIiIgKyB2YWx1ZSArICJcIiB0eXBlPVwiZmlsZVwiPjpcbiIgKwogICAgICAgICAgIkZpbGUgaW5wdXRzIGFyZSByZWFkIG9ubHkuIFVzZSBhIHYtb246Y2hhbmdlIGxpc3RlbmVyIGluc3RlYWQuIiwKICAgICAgICAgIGVsLnJhd0F0dHJzTWFwWyd2LW1vZGVsJ10KICAgICAgICApOwogICAgICB9CiAgICB9CgogICAgaWYgKGVsLmNvbXBvbmVudCkgewogICAgICBnZW5Db21wb25lbnRNb2RlbChlbCwgdmFsdWUsIG1vZGlmaWVycyk7CiAgICAgIC8vIGNvbXBvbmVudCB2LW1vZGVsIGRvZXNuJ3QgbmVlZCBleHRyYSBydW50aW1lCiAgICAgIHJldHVybiBmYWxzZQogICAgfSBlbHNlIGlmICh0YWcgPT09ICdzZWxlY3QnKSB7CiAgICAgIGdlblNlbGVjdChlbCwgdmFsdWUsIG1vZGlmaWVycyk7CiAgICB9IGVsc2UgaWYgKHRhZyA9PT0gJ2lucHV0JyAmJiB0eXBlID09PSAnY2hlY2tib3gnKSB7CiAgICAgIGdlbkNoZWNrYm94TW9kZWwoZWwsIHZhbHVlLCBtb2RpZmllcnMpOwogICAgfSBlbHNlIGlmICh0YWcgPT09ICdpbnB1dCcgJiYgdHlwZSA9PT0gJ3JhZGlvJykgewogICAgICBnZW5SYWRpb01vZGVsKGVsLCB2YWx1ZSwgbW9kaWZpZXJzKTsKICAgIH0gZWxzZSBpZiAodGFnID09PSAnaW5wdXQnIHx8IHRhZyA9PT0gJ3RleHRhcmVhJykgewogICAgICBnZW5EZWZhdWx0TW9kZWwoZWwsIHZhbHVlLCBtb2RpZmllcnMpOwogICAgfSBlbHNlIGlmICghY29uZmlnLmlzUmVzZXJ2ZWRUYWcodGFnKSkgewogICAgICBnZW5Db21wb25lbnRNb2RlbChlbCwgdmFsdWUsIG1vZGlmaWVycyk7CiAgICAgIC8vIGNvbXBvbmVudCB2LW1vZGVsIGRvZXNuJ3QgbmVlZCBleHRyYSBydW50aW1lCiAgICAgIHJldHVybiBmYWxzZQogICAgfSBlbHNlIHsKICAgICAgd2FybiQxKAogICAgICAgICI8IiArIChlbC50YWcpICsgIiB2LW1vZGVsPVwiIiArIHZhbHVlICsgIlwiPjogIiArCiAgICAgICAgInYtbW9kZWwgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIGVsZW1lbnQgdHlwZS4gIiArCiAgICAgICAgJ0lmIHlvdSBhcmUgd29ya2luZyB3aXRoIGNvbnRlbnRlZGl0YWJsZSwgaXRcJ3MgcmVjb21tZW5kZWQgdG8gJyArCiAgICAgICAgJ3dyYXAgYSBsaWJyYXJ5IGRlZGljYXRlZCBmb3IgdGhhdCBwdXJwb3NlIGluc2lkZSBhIGN1c3RvbSBjb21wb25lbnQuJywKICAgICAgICBlbC5yYXdBdHRyc01hcFsndi1tb2RlbCddCiAgICAgICk7CiAgICB9CgogICAgLy8gZW5zdXJlIHJ1bnRpbWUgZGlyZWN0aXZlIG1ldGFkYXRhCiAgICByZXR1cm4gdHJ1ZQogIH0KCiAgZnVuY3Rpb24gZ2VuQ2hlY2tib3hNb2RlbCAoCiAgICBlbCwKICAgIHZhbHVlLAogICAgbW9kaWZpZXJzCiAgKSB7CiAgICB2YXIgbnVtYmVyID0gbW9kaWZpZXJzICYmIG1vZGlmaWVycy5udW1iZXI7CiAgICB2YXIgdmFsdWVCaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICd2YWx1ZScpIHx8ICdudWxsJzsKICAgIHZhciB0cnVlVmFsdWVCaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICd0cnVlLXZhbHVlJykgfHwgJ3RydWUnOwogICAgdmFyIGZhbHNlVmFsdWVCaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICdmYWxzZS12YWx1ZScpIHx8ICdmYWxzZSc7CiAgICBhZGRQcm9wKGVsLCAnY2hlY2tlZCcsCiAgICAgICJBcnJheS5pc0FycmF5KCIgKyB2YWx1ZSArICIpIiArCiAgICAgICI/X2koIiArIHZhbHVlICsgIiwiICsgdmFsdWVCaW5kaW5nICsgIik+LTEiICsgKAogICAgICAgIHRydWVWYWx1ZUJpbmRpbmcgPT09ICd0cnVlJwogICAgICAgICAgPyAoIjooIiArIHZhbHVlICsgIikiKQogICAgICAgICAgOiAoIjpfcSgiICsgdmFsdWUgKyAiLCIgKyB0cnVlVmFsdWVCaW5kaW5nICsgIikiKQogICAgICApCiAgICApOwogICAgYWRkSGFuZGxlcihlbCwgJ2NoYW5nZScsCiAgICAgICJ2YXIgJCRhPSIgKyB2YWx1ZSArICIsIiArCiAgICAgICAgICAnJCRlbD0kZXZlbnQudGFyZ2V0LCcgKwogICAgICAgICAgIiQkYz0kJGVsLmNoZWNrZWQ/KCIgKyB0cnVlVmFsdWVCaW5kaW5nICsgIik6KCIgKyBmYWxzZVZhbHVlQmluZGluZyArICIpOyIgKwogICAgICAnaWYoQXJyYXkuaXNBcnJheSgkJGEpKXsnICsKICAgICAgICAidmFyICQkdj0iICsgKG51bWJlciA/ICdfbignICsgdmFsdWVCaW5kaW5nICsgJyknIDogdmFsdWVCaW5kaW5nKSArICIsIiArCiAgICAgICAgICAgICckJGk9X2koJCRhLCQkdik7JyArCiAgICAgICAgImlmKCQkZWwuY2hlY2tlZCl7JCRpPDAmJigiICsgKGdlbkFzc2lnbm1lbnRDb2RlKHZhbHVlLCAnJCRhLmNvbmNhdChbJCR2XSknKSkgKyAiKX0iICsKICAgICAgICAiZWxzZXskJGk+LTEmJigiICsgKGdlbkFzc2lnbm1lbnRDb2RlKHZhbHVlLCAnJCRhLnNsaWNlKDAsJCRpKS5jb25jYXQoJCRhLnNsaWNlKCQkaSsxKSknKSkgKyAiKX0iICsKICAgICAgIn1lbHNleyIgKyAoZ2VuQXNzaWdubWVudENvZGUodmFsdWUsICckJGMnKSkgKyAifSIsCiAgICAgIG51bGwsIHRydWUKICAgICk7CiAgfQoKICBmdW5jdGlvbiBnZW5SYWRpb01vZGVsICgKICAgIGVsLAogICAgdmFsdWUsCiAgICBtb2RpZmllcnMKICApIHsKICAgIHZhciBudW1iZXIgPSBtb2RpZmllcnMgJiYgbW9kaWZpZXJzLm51bWJlcjsKICAgIHZhciB2YWx1ZUJpbmRpbmcgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ3ZhbHVlJykgfHwgJ251bGwnOwogICAgdmFsdWVCaW5kaW5nID0gbnVtYmVyID8gKCJfbigiICsgdmFsdWVCaW5kaW5nICsgIikiKSA6IHZhbHVlQmluZGluZzsKICAgIGFkZFByb3AoZWwsICdjaGVja2VkJywgKCJfcSgiICsgdmFsdWUgKyAiLCIgKyB2YWx1ZUJpbmRpbmcgKyAiKSIpKTsKICAgIGFkZEhhbmRsZXIoZWwsICdjaGFuZ2UnLCBnZW5Bc3NpZ25tZW50Q29kZSh2YWx1ZSwgdmFsdWVCaW5kaW5nKSwgbnVsbCwgdHJ1ZSk7CiAgfQoKICBmdW5jdGlvbiBnZW5TZWxlY3QgKAogICAgZWwsCiAgICB2YWx1ZSwKICAgIG1vZGlmaWVycwogICkgewogICAgdmFyIG51bWJlciA9IG1vZGlmaWVycyAmJiBtb2RpZmllcnMubnVtYmVyOwogICAgdmFyIHNlbGVjdGVkVmFsID0gIkFycmF5LnByb3RvdHlwZS5maWx0ZXIiICsKICAgICAgIi5jYWxsKCRldmVudC50YXJnZXQub3B0aW9ucyxmdW5jdGlvbihvKXtyZXR1cm4gby5zZWxlY3RlZH0pIiArCiAgICAgICIubWFwKGZ1bmN0aW9uKG8pe3ZhciB2YWwgPSBcIl92YWx1ZVwiIGluIG8gPyBvLl92YWx1ZSA6IG8udmFsdWU7IiArCiAgICAgICJyZXR1cm4gIiArIChudW1iZXIgPyAnX24odmFsKScgOiAndmFsJykgKyAifSkiOwoKICAgIHZhciBhc3NpZ25tZW50ID0gJyRldmVudC50YXJnZXQubXVsdGlwbGUgPyAkJHNlbGVjdGVkVmFsIDogJCRzZWxlY3RlZFZhbFswXSc7CiAgICB2YXIgY29kZSA9ICJ2YXIgJCRzZWxlY3RlZFZhbCA9ICIgKyBzZWxlY3RlZFZhbCArICI7IjsKICAgIGNvZGUgPSBjb2RlICsgIiAiICsgKGdlbkFzc2lnbm1lbnRDb2RlKHZhbHVlLCBhc3NpZ25tZW50KSk7CiAgICBhZGRIYW5kbGVyKGVsLCAnY2hhbmdlJywgY29kZSwgbnVsbCwgdHJ1ZSk7CiAgfQoKICBmdW5jdGlvbiBnZW5EZWZhdWx0TW9kZWwgKAogICAgZWwsCiAgICB2YWx1ZSwKICAgIG1vZGlmaWVycwogICkgewogICAgdmFyIHR5cGUgPSBlbC5hdHRyc01hcC50eXBlOwoKICAgIC8vIHdhcm4gaWYgdi1iaW5kOnZhbHVlIGNvbmZsaWN0cyB3aXRoIHYtbW9kZWwKICAgIC8vIGV4Y2VwdCBmb3IgaW5wdXRzIHdpdGggdi1iaW5kOnR5cGUKICAgIHsKICAgICAgdmFyIHZhbHVlJDEgPSBlbC5hdHRyc01hcFsndi1iaW5kOnZhbHVlJ10gfHwgZWwuYXR0cnNNYXBbJzp2YWx1ZSddOwogICAgICB2YXIgdHlwZUJpbmRpbmcgPSBlbC5hdHRyc01hcFsndi1iaW5kOnR5cGUnXSB8fCBlbC5hdHRyc01hcFsnOnR5cGUnXTsKICAgICAgaWYgKHZhbHVlJDEgJiYgIXR5cGVCaW5kaW5nKSB7CiAgICAgICAgdmFyIGJpbmRpbmcgPSBlbC5hdHRyc01hcFsndi1iaW5kOnZhbHVlJ10gPyAndi1iaW5kOnZhbHVlJyA6ICc6dmFsdWUnOwogICAgICAgIHdhcm4kMSgKICAgICAgICAgIGJpbmRpbmcgKyAiPVwiIiArIHZhbHVlJDEgKyAiXCIgY29uZmxpY3RzIHdpdGggdi1tb2RlbCBvbiB0aGUgc2FtZSBlbGVtZW50ICIgKwogICAgICAgICAgJ2JlY2F1c2UgdGhlIGxhdHRlciBhbHJlYWR5IGV4cGFuZHMgdG8gYSB2YWx1ZSBiaW5kaW5nIGludGVybmFsbHknLAogICAgICAgICAgZWwucmF3QXR0cnNNYXBbYmluZGluZ10KICAgICAgICApOwogICAgICB9CiAgICB9CgogICAgdmFyIHJlZiA9IG1vZGlmaWVycyB8fCB7fTsKICAgIHZhciBsYXp5ID0gcmVmLmxhenk7CiAgICB2YXIgbnVtYmVyID0gcmVmLm51bWJlcjsKICAgIHZhciB0cmltID0gcmVmLnRyaW07CiAgICB2YXIgbmVlZENvbXBvc2l0aW9uR3VhcmQgPSAhbGF6eSAmJiB0eXBlICE9PSAncmFuZ2UnOwogICAgdmFyIGV2ZW50ID0gbGF6eQogICAgICA/ICdjaGFuZ2UnCiAgICAgIDogdHlwZSA9PT0gJ3JhbmdlJwogICAgICAgID8gUkFOR0VfVE9LRU4KICAgICAgICA6ICdpbnB1dCc7CgogICAgdmFyIHZhbHVlRXhwcmVzc2lvbiA9ICckZXZlbnQudGFyZ2V0LnZhbHVlJzsKICAgIGlmICh0cmltKSB7CiAgICAgIHZhbHVlRXhwcmVzc2lvbiA9ICIkZXZlbnQudGFyZ2V0LnZhbHVlLnRyaW0oKSI7CiAgICB9CiAgICBpZiAobnVtYmVyKSB7CiAgICAgIHZhbHVlRXhwcmVzc2lvbiA9ICJfbigiICsgdmFsdWVFeHByZXNzaW9uICsgIikiOwogICAgfQoKICAgIHZhciBjb2RlID0gZ2VuQXNzaWdubWVudENvZGUodmFsdWUsIHZhbHVlRXhwcmVzc2lvbik7CiAgICBpZiAobmVlZENvbXBvc2l0aW9uR3VhcmQpIHsKICAgICAgY29kZSA9ICJpZigkZXZlbnQudGFyZ2V0LmNvbXBvc2luZylyZXR1cm47IiArIGNvZGU7CiAgICB9CgogICAgYWRkUHJvcChlbCwgJ3ZhbHVlJywgKCIoIiArIHZhbHVlICsgIikiKSk7CiAgICBhZGRIYW5kbGVyKGVsLCBldmVudCwgY29kZSwgbnVsbCwgdHJ1ZSk7CiAgICBpZiAodHJpbSB8fCBudW1iZXIpIHsKICAgICAgYWRkSGFuZGxlcihlbCwgJ2JsdXInLCAnJGZvcmNlVXBkYXRlKCknKTsKICAgIH0KICB9CgogIC8qICAqLwoKICAvLyBub3JtYWxpemUgdi1tb2RlbCBldmVudCB0b2tlbnMgdGhhdCBjYW4gb25seSBiZSBkZXRlcm1pbmVkIGF0IHJ1bnRpbWUuCiAgLy8gaXQncyBpbXBvcnRhbnQgdG8gcGxhY2UgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBpbiB0aGUgYXJyYXkgYmVjYXVzZQogIC8vIHRoZSB3aG9sZSBwb2ludCBpcyBlbnN1cmluZyB0aGUgdi1tb2RlbCBjYWxsYmFjayBnZXRzIGNhbGxlZCBiZWZvcmUKICAvLyB1c2VyLWF0dGFjaGVkIGhhbmRsZXJzLgogIGZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyAob24pIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKG9uW1JBTkdFX1RPS0VOXSkpIHsKICAgICAgLy8gSUUgaW5wdXRbdHlwZT1yYW5nZV0gb25seSBzdXBwb3J0cyBgY2hhbmdlYCBldmVudAogICAgICB2YXIgZXZlbnQgPSBpc0lFID8gJ2NoYW5nZScgOiAnaW5wdXQnOwogICAgICBvbltldmVudF0gPSBbXS5jb25jYXQob25bUkFOR0VfVE9LRU5dLCBvbltldmVudF0gfHwgW10pOwogICAgICBkZWxldGUgb25bUkFOR0VfVE9LRU5dOwogICAgfQogICAgLy8gVGhpcyB3YXMgb3JpZ2luYWxseSBpbnRlbmRlZCB0byBmaXggIzQ1MjEgYnV0IG5vIGxvbmdlciBuZWNlc3NhcnkKICAgIC8vIGFmdGVyIDIuNS4gS2VlcGluZyBpdCBmb3IgYmFja3dhcmRzIGNvbXBhdCB3aXRoIGdlbmVyYXRlZCBjb2RlIGZyb20gPCAyLjQKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXSkpIHsKICAgICAgb24uY2hhbmdlID0gW10uY29uY2F0KG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXSwgb24uY2hhbmdlIHx8IFtdKTsKICAgICAgZGVsZXRlIG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXTsKICAgIH0KICB9CgogIHZhciB0YXJnZXQkMTsKCiAgZnVuY3Rpb24gY3JlYXRlT25jZUhhbmRsZXIkMSAoZXZlbnQsIGhhbmRsZXIsIGNhcHR1cmUpIHsKICAgIHZhciBfdGFyZ2V0ID0gdGFyZ2V0JDE7IC8vIHNhdmUgY3VycmVudCB0YXJnZXQgZWxlbWVudCBpbiBjbG9zdXJlCiAgICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIgKCkgewogICAgICB2YXIgcmVzID0gaGFuZGxlci5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgICAgcmVtb3ZlJDIoZXZlbnQsIG9uY2VIYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KTsKICAgICAgfQogICAgfQogIH0KCiAgLy8gIzk0NDY6IEZpcmVmb3ggPD0gNTMgKGluIHBhcnRpY3VsYXIsIEVTUiA1MikgaGFzIGluY29ycmVjdCBFdmVudC50aW1lU3RhbXAKICAvLyBpbXBsZW1lbnRhdGlvbiBhbmQgZG9lcyBub3QgZmlyZSBtaWNyb3Rhc2tzIGluIGJldHdlZW4gZXZlbnQgcHJvcGFnYXRpb24sIHNvCiAgLy8gc2FmZSB0byBleGNsdWRlLgogIHZhciB1c2VNaWNyb3Rhc2tGaXggPSBpc1VzaW5nTWljcm9UYXNrICYmICEoaXNGRiAmJiBOdW1iZXIoaXNGRlsxXSkgPD0gNTMpOwoKICBmdW5jdGlvbiBhZGQkMSAoCiAgICBuYW1lLAogICAgaGFuZGxlciwKICAgIGNhcHR1cmUsCiAgICBwYXNzaXZlCiAgKSB7CiAgICAvLyBhc3luYyBlZGdlIGNhc2UgIzY1NjY6IGlubmVyIGNsaWNrIGV2ZW50IHRyaWdnZXJzIHBhdGNoLCBldmVudCBoYW5kbGVyCiAgICAvLyBhdHRhY2hlZCB0byBvdXRlciBlbGVtZW50IGR1cmluZyBwYXRjaCwgYW5kIHRyaWdnZXJlZCBhZ2Fpbi4gVGhpcwogICAgLy8gaGFwcGVucyBiZWNhdXNlIGJyb3dzZXJzIGZpcmUgbWljcm90YXNrIHRpY2tzIGJldHdlZW4gZXZlbnQgcHJvcGFnYXRpb24uCiAgICAvLyB0aGUgc29sdXRpb24gaXMgc2ltcGxlOiB3ZSBzYXZlIHRoZSB0aW1lc3RhbXAgd2hlbiBhIGhhbmRsZXIgaXMgYXR0YWNoZWQsCiAgICAvLyBhbmQgdGhlIGhhbmRsZXIgd291bGQgb25seSBmaXJlIGlmIHRoZSBldmVudCBwYXNzZWQgdG8gaXQgd2FzIGZpcmVkCiAgICAvLyBBRlRFUiBpdCB3YXMgYXR0YWNoZWQuCiAgICBpZiAodXNlTWljcm90YXNrRml4KSB7CiAgICAgIHZhciBhdHRhY2hlZFRpbWVzdGFtcCA9IGN1cnJlbnRGbHVzaFRpbWVzdGFtcDsKICAgICAgdmFyIG9yaWdpbmFsID0gaGFuZGxlcjsKICAgICAgaGFuZGxlciA9IG9yaWdpbmFsLl93cmFwcGVyID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICBpZiAoCiAgICAgICAgICAvLyBubyBidWJibGluZywgc2hvdWxkIGFsd2F5cyBmaXJlLgogICAgICAgICAgLy8gdGhpcyBpcyBqdXN0IGEgc2FmZXR5IG5ldCBpbiBjYXNlIGV2ZW50LnRpbWVTdGFtcCBpcyB1bnJlbGlhYmxlIGluCiAgICAgICAgICAvLyBjZXJ0YWluIHdlaXJkIGVudmlyb25tZW50cy4uLgogICAgICAgICAgZS50YXJnZXQgPT09IGUuY3VycmVudFRhcmdldCB8fAogICAgICAgICAgLy8gZXZlbnQgaXMgZmlyZWQgYWZ0ZXIgaGFuZGxlciBhdHRhY2htZW50CiAgICAgICAgICBlLnRpbWVTdGFtcCA+PSBhdHRhY2hlZFRpbWVzdGFtcCB8fAogICAgICAgICAgLy8gYmFpbCBmb3IgZW52aXJvbm1lbnRzIHRoYXQgaGF2ZSBidWdneSBldmVudC50aW1lU3RhbXAgaW1wbGVtZW50YXRpb25zCiAgICAgICAgICAvLyAjOTQ2MiBpT1MgOSBidWc6IGV2ZW50LnRpbWVTdGFtcCBpcyAwIGFmdGVyIGhpc3RvcnkucHVzaFN0YXRlCiAgICAgICAgICAvLyAjOTY4MSBRdFdlYkVuZ2luZSBldmVudC50aW1lU3RhbXAgaXMgbmVnYXRpdmUgdmFsdWUKICAgICAgICAgIGUudGltZVN0YW1wIDw9IDAgfHwKICAgICAgICAgIC8vICM5NDQ4IGJhaWwgaWYgZXZlbnQgaXMgZmlyZWQgaW4gYW5vdGhlciBkb2N1bWVudCBpbiBhIG11bHRpLXBhZ2UKICAgICAgICAgIC8vIGVsZWN0cm9uL253LmpzIGFwcCwgc2luY2UgZXZlbnQudGltZVN0YW1wIHdpbGwgYmUgdXNpbmcgYSBkaWZmZXJlbnQKICAgICAgICAgIC8vIHN0YXJ0aW5nIHJlZmVyZW5jZQogICAgICAgICAgZS50YXJnZXQub3duZXJEb2N1bWVudCAhPT0gZG9jdW1lbnQKICAgICAgICApIHsKICAgICAgICAgIHJldHVybiBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgdGFyZ2V0JDEuYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgbmFtZSwKICAgICAgaGFuZGxlciwKICAgICAgc3VwcG9ydHNQYXNzaXZlCiAgICAgICAgPyB7IGNhcHR1cmU6IGNhcHR1cmUsIHBhc3NpdmU6IHBhc3NpdmUgfQogICAgICAgIDogY2FwdHVyZQogICAgKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZSQyICgKICAgIG5hbWUsCiAgICBoYW5kbGVyLAogICAgY2FwdHVyZSwKICAgIF90YXJnZXQKICApIHsKICAgIChfdGFyZ2V0IHx8IHRhcmdldCQxKS5yZW1vdmVFdmVudExpc3RlbmVyKAogICAgICBuYW1lLAogICAgICBoYW5kbGVyLl93cmFwcGVyIHx8IGhhbmRsZXIsCiAgICAgIGNhcHR1cmUKICAgICk7CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVET01MaXN0ZW5lcnMgKG9sZFZub2RlLCB2bm9kZSkgewogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5vbikgJiYgaXNVbmRlZih2bm9kZS5kYXRhLm9uKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBvbiA9IHZub2RlLmRhdGEub24gfHwge307CiAgICB2YXIgb2xkT24gPSBvbGRWbm9kZS5kYXRhLm9uIHx8IHt9OwogICAgdGFyZ2V0JDEgPSB2bm9kZS5lbG07CiAgICBub3JtYWxpemVFdmVudHMob24pOwogICAgdXBkYXRlTGlzdGVuZXJzKG9uLCBvbGRPbiwgYWRkJDEsIHJlbW92ZSQyLCBjcmVhdGVPbmNlSGFuZGxlciQxLCB2bm9kZS5jb250ZXh0KTsKICAgIHRhcmdldCQxID0gdW5kZWZpbmVkOwogIH0KCiAgdmFyIGV2ZW50cyA9IHsKICAgIGNyZWF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzLAogICAgdXBkYXRlOiB1cGRhdGVET01MaXN0ZW5lcnMKICB9OwoKICAvKiAgKi8KCiAgdmFyIHN2Z0NvbnRhaW5lcjsKCiAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcHMgKG9sZFZub2RlLCB2bm9kZSkgewogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5kb21Qcm9wcykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmRvbVByb3BzKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBrZXksIGN1cjsKICAgIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgICB2YXIgb2xkUHJvcHMgPSBvbGRWbm9kZS5kYXRhLmRvbVByb3BzIHx8IHt9OwogICAgdmFyIHByb3BzID0gdm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsKICAgIC8vIGNsb25lIG9ic2VydmVkIG9iamVjdHMsIGFzIHRoZSB1c2VyIHByb2JhYmx5IHdhbnRzIHRvIG11dGF0ZSBpdAogICAgaWYgKGlzRGVmKHByb3BzLl9fb2JfXykpIHsKICAgICAgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzID0gZXh0ZW5kKHt9LCBwcm9wcyk7CiAgICB9CgogICAgZm9yIChrZXkgaW4gb2xkUHJvcHMpIHsKICAgICAgaWYgKCEoa2V5IGluIHByb3BzKSkgewogICAgICAgIGVsbVtrZXldID0gJyc7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGtleSBpbiBwcm9wcykgewogICAgICBjdXIgPSBwcm9wc1trZXldOwogICAgICAvLyBpZ25vcmUgY2hpbGRyZW4gaWYgdGhlIG5vZGUgaGFzIHRleHRDb250ZW50IG9yIGlubmVySFRNTCwKICAgICAgLy8gYXMgdGhlc2Ugd2lsbCB0aHJvdyBhd2F5IGV4aXN0aW5nIERPTSBub2RlcyBhbmQgY2F1c2UgcmVtb3ZhbCBlcnJvcnMKICAgICAgLy8gb24gc3Vic2VxdWVudCBwYXRjaGVzICgjMzM2MCkKICAgICAgaWYgKGtleSA9PT0gJ3RleHRDb250ZW50JyB8fCBrZXkgPT09ICdpbm5lckhUTUwnKSB7CiAgICAgICAgaWYgKHZub2RlLmNoaWxkcmVuKSB7IHZub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7IH0KICAgICAgICBpZiAoY3VyID09PSBvbGRQcm9wc1trZXldKSB7IGNvbnRpbnVlIH0KICAgICAgICAvLyAjNjYwMSB3b3JrIGFyb3VuZCBDaHJvbWUgdmVyc2lvbiA8PSA1NSBidWcgd2hlcmUgc2luZ2xlIHRleHROb2RlCiAgICAgICAgLy8gcmVwbGFjZWQgYnkgaW5uZXJIVE1ML3RleHRDb250ZW50IHJldGFpbnMgaXRzIHBhcmVudE5vZGUgcHJvcGVydHkKICAgICAgICBpZiAoZWxtLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBlbG0ucmVtb3ZlQ2hpbGQoZWxtLmNoaWxkTm9kZXNbMF0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGtleSA9PT0gJ3ZhbHVlJyAmJiBlbG0udGFnTmFtZSAhPT0gJ1BST0dSRVNTJykgewogICAgICAgIC8vIHN0b3JlIHZhbHVlIGFzIF92YWx1ZSBhcyB3ZWxsIHNpbmNlCiAgICAgICAgLy8gbm9uLXN0cmluZyB2YWx1ZXMgd2lsbCBiZSBzdHJpbmdpZmllZAogICAgICAgIGVsbS5fdmFsdWUgPSBjdXI7CiAgICAgICAgLy8gYXZvaWQgcmVzZXR0aW5nIGN1cnNvciBwb3NpdGlvbiB3aGVuIHZhbHVlIGlzIHRoZSBzYW1lCiAgICAgICAgdmFyIHN0ckN1ciA9IGlzVW5kZWYoY3VyKSA/ICcnIDogU3RyaW5nKGN1cik7CiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVZhbHVlKGVsbSwgc3RyQ3VyKSkgewogICAgICAgICAgZWxtLnZhbHVlID0gc3RyQ3VyOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdpbm5lckhUTUwnICYmIGlzU1ZHKGVsbS50YWdOYW1lKSAmJiBpc1VuZGVmKGVsbS5pbm5lckhUTUwpKSB7CiAgICAgICAgLy8gSUUgZG9lc24ndCBzdXBwb3J0IGlubmVySFRNTCBmb3IgU1ZHIGVsZW1lbnRzCiAgICAgICAgc3ZnQ29udGFpbmVyID0gc3ZnQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHN2Z0NvbnRhaW5lci5pbm5lckhUTUwgPSAiPHN2Zz4iICsgY3VyICsgIjwvc3ZnPiI7CiAgICAgICAgdmFyIHN2ZyA9IHN2Z0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgIHdoaWxlIChlbG0uZmlyc3RDaGlsZCkgewogICAgICAgICAgZWxtLnJlbW92ZUNoaWxkKGVsbS5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKHN2Zy5maXJzdENoaWxkKSB7CiAgICAgICAgICBlbG0uYXBwZW5kQ2hpbGQoc3ZnLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgKICAgICAgICAvLyBza2lwIHRoZSB1cGRhdGUgaWYgb2xkIGFuZCBuZXcgVkRPTSBzdGF0ZSBpcyB0aGUgc2FtZS4KICAgICAgICAvLyBgdmFsdWVgIGlzIGhhbmRsZWQgc2VwYXJhdGVseSBiZWNhdXNlIHRoZSBET00gdmFsdWUgbWF5IGJlIHRlbXBvcmFyaWx5CiAgICAgICAgLy8gb3V0IG9mIHN5bmMgd2l0aCBWRE9NIHN0YXRlIGR1ZSB0byBmb2N1cywgY29tcG9zaXRpb24gYW5kIG1vZGlmaWVycy4KICAgICAgICAvLyBUaGlzICAjNDUyMSBieSBza2lwcGluZyB0aGUgdW5uZWNlc2FycnkgYGNoZWNrZWRgIHVwZGF0ZS4KICAgICAgICBjdXIgIT09IG9sZFByb3BzW2tleV0KICAgICAgKSB7CiAgICAgICAgLy8gc29tZSBwcm9wZXJ0eSB1cGRhdGVzIGNhbiB0aHJvdwogICAgICAgIC8vIGUuZy4gYHZhbHVlYCBvbiA8cHJvZ3Jlc3M+IHcvIG5vbi1maW5pdGUgdmFsdWUKICAgICAgICB0cnkgewogICAgICAgICAgZWxtW2tleV0gPSBjdXI7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgfQogICAgfQogIH0KCiAgLy8gY2hlY2sgcGxhdGZvcm1zL3dlYi91dGlsL2F0dHJzLmpzIGFjY2VwdFZhbHVlCgoKICBmdW5jdGlvbiBzaG91bGRVcGRhdGVWYWx1ZSAoZWxtLCBjaGVja1ZhbCkgewogICAgcmV0dXJuICghZWxtLmNvbXBvc2luZyAmJiAoCiAgICAgIGVsbS50YWdOYW1lID09PSAnT1BUSU9OJyB8fAogICAgICBpc05vdEluRm9jdXNBbmREaXJ0eShlbG0sIGNoZWNrVmFsKSB8fAogICAgICBpc0RpcnR5V2l0aE1vZGlmaWVycyhlbG0sIGNoZWNrVmFsKQogICAgKSkKICB9CgogIGZ1bmN0aW9uIGlzTm90SW5Gb2N1c0FuZERpcnR5IChlbG0sIGNoZWNrVmFsKSB7CiAgICAvLyByZXR1cm4gdHJ1ZSB3aGVuIHRleHRib3ggKC5udW1iZXIgYW5kIC50cmltKSBsb3NlcyBmb2N1cyBhbmQgaXRzIHZhbHVlIGlzCiAgICAvLyBub3QgZXF1YWwgdG8gdGhlIHVwZGF0ZWQgdmFsdWUKICAgIHZhciBub3RJbkZvY3VzID0gdHJ1ZTsKICAgIC8vICM2MTU3CiAgICAvLyB3b3JrIGFyb3VuZCBJRSBidWcgd2hlbiBhY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpbiBhbiBpZnJhbWUKICAgIHRyeSB7IG5vdEluRm9jdXMgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBlbG07IH0gY2F0Y2ggKGUpIHt9CiAgICByZXR1cm4gbm90SW5Gb2N1cyAmJiBlbG0udmFsdWUgIT09IGNoZWNrVmFsCiAgfQoKICBmdW5jdGlvbiBpc0RpcnR5V2l0aE1vZGlmaWVycyAoZWxtLCBuZXdWYWwpIHsKICAgIHZhciB2YWx1ZSA9IGVsbS52YWx1ZTsKICAgIHZhciBtb2RpZmllcnMgPSBlbG0uX3ZNb2RpZmllcnM7IC8vIGluamVjdGVkIGJ5IHYtbW9kZWwgcnVudGltZQogICAgaWYgKGlzRGVmKG1vZGlmaWVycykpIHsKICAgICAgaWYgKG1vZGlmaWVycy5udW1iZXIpIHsKICAgICAgICByZXR1cm4gdG9OdW1iZXIodmFsdWUpICE9PSB0b051bWJlcihuZXdWYWwpCiAgICAgIH0KICAgICAgaWYgKG1vZGlmaWVycy50cmltKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnRyaW0oKSAhPT0gbmV3VmFsLnRyaW0oKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsdWUgIT09IG5ld1ZhbAogIH0KCiAgdmFyIGRvbVByb3BzID0gewogICAgY3JlYXRlOiB1cGRhdGVET01Qcm9wcywKICAgIHVwZGF0ZTogdXBkYXRlRE9NUHJvcHMKICB9OwoKICAvKiAgKi8KCiAgdmFyIHBhcnNlU3R5bGVUZXh0ID0gY2FjaGVkKGZ1bmN0aW9uIChjc3NUZXh0KSB7CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgbGlzdERlbGltaXRlciA9IC87KD8hW14oXSpcKSkvZzsKICAgIHZhciBwcm9wZXJ0eURlbGltaXRlciA9IC86KC4rKS87CiAgICBjc3NUZXh0LnNwbGl0KGxpc3REZWxpbWl0ZXIpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICB2YXIgdG1wID0gaXRlbS5zcGxpdChwcm9wZXJ0eURlbGltaXRlcik7CiAgICAgICAgdG1wLmxlbmd0aCA+IDEgJiYgKHJlc1t0bXBbMF0udHJpbSgpXSA9IHRtcFsxXS50cmltKCkpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXMKICB9KTsKCiAgLy8gbWVyZ2Ugc3RhdGljIGFuZCBkeW5hbWljIHN0eWxlIGRhdGEgb24gdGhlIHNhbWUgdm5vZGUKICBmdW5jdGlvbiBub3JtYWxpemVTdHlsZURhdGEgKGRhdGEpIHsKICAgIHZhciBzdHlsZSA9IG5vcm1hbGl6ZVN0eWxlQmluZGluZyhkYXRhLnN0eWxlKTsKICAgIC8vIHN0YXRpYyBzdHlsZSBpcyBwcmUtcHJvY2Vzc2VkIGludG8gYW4gb2JqZWN0IGR1cmluZyBjb21waWxhdGlvbgogICAgLy8gYW5kIGlzIGFsd2F5cyBhIGZyZXNoIG9iamVjdCwgc28gaXQncyBzYWZlIHRvIG1lcmdlIGludG8gaXQKICAgIHJldHVybiBkYXRhLnN0YXRpY1N0eWxlCiAgICAgID8gZXh0ZW5kKGRhdGEuc3RhdGljU3R5bGUsIHN0eWxlKQogICAgICA6IHN0eWxlCiAgfQoKICAvLyBub3JtYWxpemUgcG9zc2libGUgYXJyYXkgLyBzdHJpbmcgdmFsdWVzIGludG8gT2JqZWN0CiAgZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVCaW5kaW5nIChiaW5kaW5nU3R5bGUpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGJpbmRpbmdTdHlsZSkpIHsKICAgICAgcmV0dXJuIHRvT2JqZWN0KGJpbmRpbmdTdHlsZSkKICAgIH0KICAgIGlmICh0eXBlb2YgYmluZGluZ1N0eWxlID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gcGFyc2VTdHlsZVRleHQoYmluZGluZ1N0eWxlKQogICAgfQogICAgcmV0dXJuIGJpbmRpbmdTdHlsZQogIH0KCiAgLyoqCiAgICogcGFyZW50IGNvbXBvbmVudCBzdHlsZSBzaG91bGQgYmUgYWZ0ZXIgY2hpbGQncwogICAqIHNvIHRoYXQgcGFyZW50IGNvbXBvbmVudCdzIHN0eWxlIGNvdWxkIG92ZXJyaWRlIGl0CiAgICovCiAgZnVuY3Rpb24gZ2V0U3R5bGUgKHZub2RlLCBjaGVja0NoaWxkKSB7CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgc3R5bGVEYXRhOwoKICAgIGlmIChjaGVja0NoaWxkKSB7CiAgICAgIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKICAgICAgd2hpbGUgKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICAgICAgaWYgKAogICAgICAgICAgY2hpbGROb2RlICYmIGNoaWxkTm9kZS5kYXRhICYmCiAgICAgICAgICAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKGNoaWxkTm9kZS5kYXRhKSkKICAgICAgICApIHsKICAgICAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEodm5vZGUuZGF0YSkpKSB7CiAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICB9CgogICAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKICAgIHdoaWxlICgocGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50KSkgewogICAgICBpZiAocGFyZW50Tm9kZS5kYXRhICYmIChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEocGFyZW50Tm9kZS5kYXRhKSkpIHsKICAgICAgICBleHRlbmQocmVzLCBzdHlsZURhdGEpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQoKICAvKiAgKi8KCiAgdmFyIGNzc1ZhclJFID0gL14tLS87CiAgdmFyIGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsKICB2YXIgc2V0UHJvcCA9IGZ1bmN0aW9uIChlbCwgbmFtZSwgdmFsKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChjc3NWYXJSRS50ZXN0KG5hbWUpKSB7CiAgICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbCk7CiAgICB9IGVsc2UgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgewogICAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShoeXBoZW5hdGUobmFtZSksIHZhbC5yZXBsYWNlKGltcG9ydGFudFJFLCAnJyksICdpbXBvcnRhbnQnKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBub3JtYWxpemVkTmFtZSA9IG5vcm1hbGl6ZShuYW1lKTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAgIC8vIFN1cHBvcnQgdmFsdWVzIGFycmF5IGNyZWF0ZWQgYnkgYXV0b3ByZWZpeGVyLCBlLmcuCiAgICAgICAgLy8ge2Rpc3BsYXk6IFsiLXdlYmtpdC1ib3giLCAiLW1zLWZsZXhib3giLCAiZmxleCJdfQogICAgICAgIC8vIFNldCB0aGVtIG9uZSBieSBvbmUsIGFuZCB0aGUgYnJvd3NlciB3aWxsIG9ubHkgc2V0IHRob3NlIGl0IGNhbiByZWNvZ25pemUKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdmFsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBlbC5zdHlsZVtub3JtYWxpemVkTmFtZV0gPSB2YWxbaV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVsLnN0eWxlW25vcm1hbGl6ZWROYW1lXSA9IHZhbDsKICAgICAgfQogICAgfQogIH07CgogIHZhciB2ZW5kb3JOYW1lcyA9IFsnV2Via2l0JywgJ01veicsICdtcyddOwoKICB2YXIgZW1wdHlTdHlsZTsKICB2YXIgbm9ybWFsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChwcm9wKSB7CiAgICBlbXB0eVN0eWxlID0gZW1wdHlTdHlsZSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZTsKICAgIHByb3AgPSBjYW1lbGl6ZShwcm9wKTsKICAgIGlmIChwcm9wICE9PSAnZmlsdGVyJyAmJiAocHJvcCBpbiBlbXB0eVN0eWxlKSkgewogICAgICByZXR1cm4gcHJvcAogICAgfQogICAgdmFyIGNhcE5hbWUgPSBwcm9wLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zbGljZSgxKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmVuZG9yTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG5hbWUgPSB2ZW5kb3JOYW1lc1tpXSArIGNhcE5hbWU7CiAgICAgIGlmIChuYW1lIGluIGVtcHR5U3R5bGUpIHsKICAgICAgICByZXR1cm4gbmFtZQogICAgICB9CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIHVwZGF0ZVN0eWxlIChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICAgIHZhciBvbGREYXRhID0gb2xkVm5vZGUuZGF0YTsKCiAgICBpZiAoaXNVbmRlZihkYXRhLnN0YXRpY1N0eWxlKSAmJiBpc1VuZGVmKGRhdGEuc3R5bGUpICYmCiAgICAgIGlzVW5kZWYob2xkRGF0YS5zdGF0aWNTdHlsZSkgJiYgaXNVbmRlZihvbGREYXRhLnN0eWxlKQogICAgKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIHZhciBjdXIsIG5hbWU7CiAgICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgICB2YXIgb2xkU3RhdGljU3R5bGUgPSBvbGREYXRhLnN0YXRpY1N0eWxlOwogICAgdmFyIG9sZFN0eWxlQmluZGluZyA9IG9sZERhdGEubm9ybWFsaXplZFN0eWxlIHx8IG9sZERhdGEuc3R5bGUgfHwge307CgogICAgLy8gaWYgc3RhdGljIHN0eWxlIGV4aXN0cywgc3R5bGViaW5kaW5nIGFscmVhZHkgbWVyZ2VkIGludG8gaXQgd2hlbiBkb2luZyBub3JtYWxpemVTdHlsZURhdGEKICAgIHZhciBvbGRTdHlsZSA9IG9sZFN0YXRpY1N0eWxlIHx8IG9sZFN0eWxlQmluZGluZzsKCiAgICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcodm5vZGUuZGF0YS5zdHlsZSkgfHwge307CgogICAgLy8gc3RvcmUgbm9ybWFsaXplZCBzdHlsZSB1bmRlciBhIGRpZmZlcmVudCBrZXkgZm9yIG5leHQgZGlmZgogICAgLy8gbWFrZSBzdXJlIHRvIGNsb25lIGl0IGlmIGl0J3MgcmVhY3RpdmUsIHNpbmNlIHRoZSB1c2VyIGxpa2VseSB3YW50cwogICAgLy8gdG8gbXV0YXRlIGl0LgogICAgdm5vZGUuZGF0YS5ub3JtYWxpemVkU3R5bGUgPSBpc0RlZihzdHlsZS5fX29iX18pCiAgICAgID8gZXh0ZW5kKHt9LCBzdHlsZSkKICAgICAgOiBzdHlsZTsKCiAgICB2YXIgbmV3U3R5bGUgPSBnZXRTdHlsZSh2bm9kZSwgdHJ1ZSk7CgogICAgZm9yIChuYW1lIGluIG9sZFN0eWxlKSB7CiAgICAgIGlmIChpc1VuZGVmKG5ld1N0eWxlW25hbWVdKSkgewogICAgICAgIHNldFByb3AoZWwsIG5hbWUsICcnKTsKICAgICAgfQogICAgfQogICAgZm9yIChuYW1lIGluIG5ld1N0eWxlKSB7CiAgICAgIGN1ciA9IG5ld1N0eWxlW25hbWVdOwogICAgICBpZiAoY3VyICE9PSBvbGRTdHlsZVtuYW1lXSkgewogICAgICAgIC8vIGllOSBzZXR0aW5nIHRvIG51bGwgaGFzIG5vIGVmZmVjdCwgbXVzdCB1c2UgZW1wdHkgc3RyaW5nCiAgICAgICAgc2V0UHJvcChlbCwgbmFtZSwgY3VyID09IG51bGwgPyAnJyA6IGN1cik7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBzdHlsZSA9IHsKICAgIGNyZWF0ZTogdXBkYXRlU3R5bGUsCiAgICB1cGRhdGU6IHVwZGF0ZVN0eWxlCiAgfTsKCiAgLyogICovCgogIHZhciB3aGl0ZXNwYWNlUkUgPSAvXHMrLzsKCiAgLyoqCiAgICogQWRkIGNsYXNzIHdpdGggY29tcGF0aWJpbGl0eSBmb3IgU1ZHIHNpbmNlIGNsYXNzTGlzdCBpcyBub3Qgc3VwcG9ydGVkIG9uCiAgICogU1ZHIGVsZW1lbnRzIGluIElFCiAgICovCiAgZnVuY3Rpb24gYWRkQ2xhc3MgKGVsLCBjbHMpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICBpZiAoY2xzLmluZGV4T2YoJyAnKSA+IC0xKSB7CiAgICAgICAgY2xzLnNwbGl0KHdoaXRlc3BhY2VSRSkuZm9yRWFjaChmdW5jdGlvbiAoYykgeyByZXR1cm4gZWwuY2xhc3NMaXN0LmFkZChjKTsgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChjbHMpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgY3VyID0gIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICI7CiAgICAgIGlmIChjdXIuaW5kZXhPZignICcgKyBjbHMgKyAnICcpIDwgMCkgewogICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAoY3VyICsgY2xzKS50cmltKCkpOwogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKiBSZW1vdmUgY2xhc3Mgd2l0aCBjb21wYXRpYmlsaXR5IGZvciBTVkcgc2luY2UgY2xhc3NMaXN0IGlzIG5vdCBzdXBwb3J0ZWQgb24KICAgKiBTVkcgZWxlbWVudHMgaW4gSUUKICAgKi8KICBmdW5jdGlvbiByZW1vdmVDbGFzcyAoZWwsIGNscykgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoIWNscyB8fCAhKGNscyA9IGNscy50cmltKCkpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgIGlmIChjbHMuaW5kZXhPZignICcpID4gLTEpIHsKICAgICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7IHJldHVybiBlbC5jbGFzc0xpc3QucmVtb3ZlKGMpOyB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNscyk7CiAgICAgIH0KICAgICAgaWYgKCFlbC5jbGFzc0xpc3QubGVuZ3RoKSB7CiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgY3VyID0gIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICI7CiAgICAgIHZhciB0YXIgPSAnICcgKyBjbHMgKyAnICc7CiAgICAgIHdoaWxlIChjdXIuaW5kZXhPZih0YXIpID49IDApIHsKICAgICAgICBjdXIgPSBjdXIucmVwbGFjZSh0YXIsICcgJyk7CiAgICAgIH0KICAgICAgY3VyID0gY3VyLnRyaW0oKTsKICAgICAgaWYgKGN1cikgewogICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjdXIpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgICAgfQogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uIChkZWYkJDEpIHsKICAgIGlmICghZGVmJCQxKSB7CiAgICAgIHJldHVybgogICAgfQogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgIGlmICh0eXBlb2YgZGVmJCQxID09PSAnb2JqZWN0JykgewogICAgICB2YXIgcmVzID0ge307CiAgICAgIGlmIChkZWYkJDEuY3NzICE9PSBmYWxzZSkgewogICAgICAgIGV4dGVuZChyZXMsIGF1dG9Dc3NUcmFuc2l0aW9uKGRlZiQkMS5uYW1lIHx8ICd2JykpOwogICAgICB9CiAgICAgIGV4dGVuZChyZXMsIGRlZiQkMSk7CiAgICAgIHJldHVybiByZXMKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZiQkMSA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGF1dG9Dc3NUcmFuc2l0aW9uKGRlZiQkMSkKICAgIH0KICB9CgogIHZhciBhdXRvQ3NzVHJhbnNpdGlvbiA9IGNhY2hlZChmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuIHsKICAgICAgZW50ZXJDbGFzczogKG5hbWUgKyAiLWVudGVyIiksCiAgICAgIGVudGVyVG9DbGFzczogKG5hbWUgKyAiLWVudGVyLXRvIiksCiAgICAgIGVudGVyQWN0aXZlQ2xhc3M6IChuYW1lICsgIi1lbnRlci1hY3RpdmUiKSwKICAgICAgbGVhdmVDbGFzczogKG5hbWUgKyAiLWxlYXZlIiksCiAgICAgIGxlYXZlVG9DbGFzczogKG5hbWUgKyAiLWxlYXZlLXRvIiksCiAgICAgIGxlYXZlQWN0aXZlQ2xhc3M6IChuYW1lICsgIi1sZWF2ZS1hY3RpdmUiKQogICAgfQogIH0pOwoKICB2YXIgaGFzVHJhbnNpdGlvbiA9IGluQnJvd3NlciAmJiAhaXNJRTk7CiAgdmFyIFRSQU5TSVRJT04gPSAndHJhbnNpdGlvbic7CiAgdmFyIEFOSU1BVElPTiA9ICdhbmltYXRpb24nOwoKICAvLyBUcmFuc2l0aW9uIHByb3BlcnR5L2V2ZW50IHNuaWZmaW5nCiAgdmFyIHRyYW5zaXRpb25Qcm9wID0gJ3RyYW5zaXRpb24nOwogIHZhciB0cmFuc2l0aW9uRW5kRXZlbnQgPSAndHJhbnNpdGlvbmVuZCc7CiAgdmFyIGFuaW1hdGlvblByb3AgPSAnYW5pbWF0aW9uJzsKICB2YXIgYW5pbWF0aW9uRW5kRXZlbnQgPSAnYW5pbWF0aW9uZW5kJzsKICBpZiAoaGFzVHJhbnNpdGlvbikgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmCiAgICAgIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZAogICAgKSB7CiAgICAgIHRyYW5zaXRpb25Qcm9wID0gJ1dlYmtpdFRyYW5zaXRpb24nOwogICAgICB0cmFuc2l0aW9uRW5kRXZlbnQgPSAnd2Via2l0VHJhbnNpdGlvbkVuZCc7CiAgICB9CiAgICBpZiAod2luZG93Lm9uYW5pbWF0aW9uZW5kID09PSB1bmRlZmluZWQgJiYKICAgICAgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kICE9PSB1bmRlZmluZWQKICAgICkgewogICAgICBhbmltYXRpb25Qcm9wID0gJ1dlYmtpdEFuaW1hdGlvbic7CiAgICAgIGFuaW1hdGlvbkVuZEV2ZW50ID0gJ3dlYmtpdEFuaW1hdGlvbkVuZCc7CiAgICB9CiAgfQoKICAvLyBiaW5kaW5nIHRvIHdpbmRvdyBpcyBuZWNlc3NhcnkgdG8gbWFrZSBob3QgcmVsb2FkIHdvcmsgaW4gSUUgaW4gc3RyaWN0IG1vZGUKICB2YXIgcmFmID0gaW5Ccm93c2VyCiAgICA/IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLmJpbmQod2luZG93KQogICAgICA6IHNldFRpbWVvdXQKICAgIDogLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8gZnVuY3Rpb24gKGZuKSB7IHJldHVybiBmbigpOyB9OwoKICBmdW5jdGlvbiBuZXh0RnJhbWUgKGZuKSB7CiAgICByYWYoZnVuY3Rpb24gKCkgewogICAgICByYWYoZm4pOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBhZGRUcmFuc2l0aW9uQ2xhc3MgKGVsLCBjbHMpIHsKICAgIHZhciB0cmFuc2l0aW9uQ2xhc3NlcyA9IGVsLl90cmFuc2l0aW9uQ2xhc3NlcyB8fCAoZWwuX3RyYW5zaXRpb25DbGFzc2VzID0gW10pOwogICAgaWYgKHRyYW5zaXRpb25DbGFzc2VzLmluZGV4T2YoY2xzKSA8IDApIHsKICAgICAgdHJhbnNpdGlvbkNsYXNzZXMucHVzaChjbHMpOwogICAgICBhZGRDbGFzcyhlbCwgY2xzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRyYW5zaXRpb25DbGFzcyAoZWwsIGNscykgewogICAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgICByZW1vdmUoZWwuX3RyYW5zaXRpb25DbGFzc2VzLCBjbHMpOwogICAgfQogICAgcmVtb3ZlQ2xhc3MoZWwsIGNscyk7CiAgfQoKICBmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMgKAogICAgZWwsCiAgICBleHBlY3RlZFR5cGUsCiAgICBjYgogICkgewogICAgdmFyIHJlZiA9IGdldFRyYW5zaXRpb25JbmZvKGVsLCBleHBlY3RlZFR5cGUpOwogICAgdmFyIHR5cGUgPSByZWYudHlwZTsKICAgIHZhciB0aW1lb3V0ID0gcmVmLnRpbWVvdXQ7CiAgICB2YXIgcHJvcENvdW50ID0gcmVmLnByb3BDb3VudDsKICAgIGlmICghdHlwZSkgeyByZXR1cm4gY2IoKSB9CiAgICB2YXIgZXZlbnQgPSB0eXBlID09PSBUUkFOU0lUSU9OID8gdHJhbnNpdGlvbkVuZEV2ZW50IDogYW5pbWF0aW9uRW5kRXZlbnQ7CiAgICB2YXIgZW5kZWQgPSAwOwogICAgdmFyIGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwogICAgICBjYigpOwogICAgfTsKICAgIHZhciBvbkVuZCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmIChlLnRhcmdldCA9PT0gZWwpIHsKICAgICAgICBpZiAoKytlbmRlZCA+PSBwcm9wQ291bnQpIHsKICAgICAgICAgIGVuZCgpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBpZiAoZW5kZWQgPCBwcm9wQ291bnQpIHsKICAgICAgICBlbmQoKTsKICAgICAgfQogICAgfSwgdGltZW91dCArIDEpOwogICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwogIH0KCiAgdmFyIHRyYW5zZm9ybVJFID0gL1xiKHRyYW5zZm9ybXxhbGwpKCx8JCkvOwoKICBmdW5jdGlvbiBnZXRUcmFuc2l0aW9uSW5mbyAoZWwsIGV4cGVjdGVkVHlwZSkgewogICAgdmFyIHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsKICAgIC8vIEpTRE9NIG1heSByZXR1cm4gdW5kZWZpbmVkIGZvciB0cmFuc2l0aW9uIHByb3BlcnRpZXMKICAgIHZhciB0cmFuc2l0aW9uRGVsYXlzID0gKHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdEZWxheSddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb25zID0gKHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdEdXJhdGlvbiddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICAgIHZhciB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7CiAgICB2YXIgYW5pbWF0aW9uRGVsYXlzID0gKHN0eWxlc1thbmltYXRpb25Qcm9wICsgJ0RlbGF5J10gfHwgJycpLnNwbGl0KCcsICcpOwogICAgdmFyIGFuaW1hdGlvbkR1cmF0aW9ucyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEdXJhdGlvbiddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICAgIHZhciBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7CgogICAgdmFyIHR5cGU7CiAgICB2YXIgdGltZW91dCA9IDA7CiAgICB2YXIgcHJvcENvdW50ID0gMDsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGV4cGVjdGVkVHlwZSA9PT0gVFJBTlNJVElPTikgewogICAgICBpZiAodHJhbnNpdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgICAgdHlwZSA9IFRSQU5TSVRJT047CiAgICAgICAgdGltZW91dCA9IHRyYW5zaXRpb25UaW1lb3V0OwogICAgICAgIHByb3BDb3VudCA9IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gQU5JTUFUSU9OKSB7CiAgICAgIGlmIChhbmltYXRpb25UaW1lb3V0ID4gMCkgewogICAgICAgIHR5cGUgPSBBTklNQVRJT047CiAgICAgICAgdGltZW91dCA9IGFuaW1hdGlvblRpbWVvdXQ7CiAgICAgICAgcHJvcENvdW50ID0gYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGltZW91dCA9IE1hdGgubWF4KHRyYW5zaXRpb25UaW1lb3V0LCBhbmltYXRpb25UaW1lb3V0KTsKICAgICAgdHlwZSA9IHRpbWVvdXQgPiAwCiAgICAgICAgPyB0cmFuc2l0aW9uVGltZW91dCA+IGFuaW1hdGlvblRpbWVvdXQKICAgICAgICAgID8gVFJBTlNJVElPTgogICAgICAgICAgOiBBTklNQVRJT04KICAgICAgICA6IG51bGw7CiAgICAgIHByb3BDb3VudCA9IHR5cGUKICAgICAgICA/IHR5cGUgPT09IFRSQU5TSVRJT04KICAgICAgICAgID8gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGgKICAgICAgICAgIDogYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aAogICAgICAgIDogMDsKICAgIH0KICAgIHZhciBoYXNUcmFuc2Zvcm0gPQogICAgICB0eXBlID09PSBUUkFOU0lUSU9OICYmCiAgICAgIHRyYW5zZm9ybVJFLnRlc3Qoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ1Byb3BlcnR5J10pOwogICAgcmV0dXJuIHsKICAgICAgdHlwZTogdHlwZSwKICAgICAgdGltZW91dDogdGltZW91dCwKICAgICAgcHJvcENvdW50OiBwcm9wQ291bnQsCiAgICAgIGhhc1RyYW5zZm9ybTogaGFzVHJhbnNmb3JtCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRUaW1lb3V0IChkZWxheXMsIGR1cmF0aW9ucykgewogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIHdoaWxlIChkZWxheXMubGVuZ3RoIDwgZHVyYXRpb25zLmxlbmd0aCkgewogICAgICBkZWxheXMgPSBkZWxheXMuY29uY2F0KGRlbGF5cyk7CiAgICB9CgogICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIGR1cmF0aW9ucy5tYXAoZnVuY3Rpb24gKGQsIGkpIHsKICAgICAgcmV0dXJuIHRvTXMoZCkgKyB0b01zKGRlbGF5c1tpXSkKICAgIH0pKQogIH0KCiAgLy8gT2xkIHZlcnNpb25zIG9mIENocm9taXVtIChiZWxvdyA2MS4wLjMxNjMuMTAwKSBmb3JtYXRzIGZsb2F0aW5nIHBvaW50ZXIgbnVtYmVycwogIC8vIGluIGEgbG9jYWxlLWRlcGVuZGVudCB3YXksIHVzaW5nIGEgY29tbWEgaW5zdGVhZCBvZiBhIGRvdC4KICAvLyBJZiBjb21tYSBpcyBub3QgcmVwbGFjZWQgd2l0aCBhIGRvdCwgdGhlIGlucHV0IHdpbGwgYmUgcm91bmRlZCBkb3duIChpLmUuIGFjdGluZwogIC8vIGFzIGEgZmxvb3IgZnVuY3Rpb24pIGNhdXNpbmcgdW5leHBlY3RlZCBiZWhhdmlvcnMKICBmdW5jdGlvbiB0b01zIChzKSB7CiAgICByZXR1cm4gTnVtYmVyKHMuc2xpY2UoMCwgLTEpLnJlcGxhY2UoJywnLCAnLicpKSAqIDEwMDAKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBlbnRlciAodm5vZGUsIHRvZ2dsZURpc3BsYXkpIHsKICAgIHZhciBlbCA9IHZub2RlLmVsbTsKCiAgICAvLyBjYWxsIGxlYXZlIGNhbGxiYWNrIG5vdwogICAgaWYgKGlzRGVmKGVsLl9sZWF2ZUNiKSkgewogICAgICBlbC5fbGVhdmVDYi5jYW5jZWxsZWQgPSB0cnVlOwogICAgICBlbC5fbGVhdmVDYigpOwogICAgfQoKICAgIHZhciBkYXRhID0gcmVzb2x2ZVRyYW5zaXRpb24odm5vZGUuZGF0YS50cmFuc2l0aW9uKTsKICAgIGlmIChpc1VuZGVmKGRhdGEpKSB7CiAgICAgIHJldHVybgogICAgfQoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKGVsLl9lbnRlckNiKSB8fCBlbC5ub2RlVHlwZSAhPT0gMSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB2YXIgY3NzID0gZGF0YS5jc3M7CiAgICB2YXIgdHlwZSA9IGRhdGEudHlwZTsKICAgIHZhciBlbnRlckNsYXNzID0gZGF0YS5lbnRlckNsYXNzOwogICAgdmFyIGVudGVyVG9DbGFzcyA9IGRhdGEuZW50ZXJUb0NsYXNzOwogICAgdmFyIGVudGVyQWN0aXZlQ2xhc3MgPSBkYXRhLmVudGVyQWN0aXZlQ2xhc3M7CiAgICB2YXIgYXBwZWFyQ2xhc3MgPSBkYXRhLmFwcGVhckNsYXNzOwogICAgdmFyIGFwcGVhclRvQ2xhc3MgPSBkYXRhLmFwcGVhclRvQ2xhc3M7CiAgICB2YXIgYXBwZWFyQWN0aXZlQ2xhc3MgPSBkYXRhLmFwcGVhckFjdGl2ZUNsYXNzOwogICAgdmFyIGJlZm9yZUVudGVyID0gZGF0YS5iZWZvcmVFbnRlcjsKICAgIHZhciBlbnRlciA9IGRhdGEuZW50ZXI7CiAgICB2YXIgYWZ0ZXJFbnRlciA9IGRhdGEuYWZ0ZXJFbnRlcjsKICAgIHZhciBlbnRlckNhbmNlbGxlZCA9IGRhdGEuZW50ZXJDYW5jZWxsZWQ7CiAgICB2YXIgYmVmb3JlQXBwZWFyID0gZGF0YS5iZWZvcmVBcHBlYXI7CiAgICB2YXIgYXBwZWFyID0gZGF0YS5hcHBlYXI7CiAgICB2YXIgYWZ0ZXJBcHBlYXIgPSBkYXRhLmFmdGVyQXBwZWFyOwogICAgdmFyIGFwcGVhckNhbmNlbGxlZCA9IGRhdGEuYXBwZWFyQ2FuY2VsbGVkOwogICAgdmFyIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsKCiAgICAvLyBhY3RpdmVJbnN0YW5jZSB3aWxsIGFsd2F5cyBiZSB0aGUgPHRyYW5zaXRpb24+IGNvbXBvbmVudCBtYW5hZ2luZyB0aGlzCiAgICAvLyB0cmFuc2l0aW9uLiBPbmUgZWRnZSBjYXNlIHRvIGNoZWNrIGlzIHdoZW4gdGhlIDx0cmFuc2l0aW9uPiBpcyBwbGFjZWQKICAgIC8vIGFzIHRoZSByb290IG5vZGUgb2YgYSBjaGlsZCBjb21wb25lbnQuIEluIHRoYXQgY2FzZSB3ZSBuZWVkIHRvIGNoZWNrCiAgICAvLyA8dHJhbnNpdGlvbj4ncyBwYXJlbnQgZm9yIGFwcGVhciBjaGVjay4KICAgIHZhciBjb250ZXh0ID0gYWN0aXZlSW5zdGFuY2U7CiAgICB2YXIgdHJhbnNpdGlvbk5vZGUgPSBhY3RpdmVJbnN0YW5jZS4kdm5vZGU7CiAgICB3aGlsZSAodHJhbnNpdGlvbk5vZGUgJiYgdHJhbnNpdGlvbk5vZGUucGFyZW50KSB7CiAgICAgIGNvbnRleHQgPSB0cmFuc2l0aW9uTm9kZS5jb250ZXh0OwogICAgICB0cmFuc2l0aW9uTm9kZSA9IHRyYW5zaXRpb25Ob2RlLnBhcmVudDsKICAgIH0KCiAgICB2YXIgaXNBcHBlYXIgPSAhY29udGV4dC5faXNNb3VudGVkIHx8ICF2bm9kZS5pc1Jvb3RJbnNlcnQ7CgogICAgaWYgKGlzQXBwZWFyICYmICFhcHBlYXIgJiYgYXBwZWFyICE9PSAnJykgewogICAgICByZXR1cm4KICAgIH0KCiAgICB2YXIgc3RhcnRDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckNsYXNzCiAgICAgID8gYXBwZWFyQ2xhc3MKICAgICAgOiBlbnRlckNsYXNzOwogICAgdmFyIGFjdGl2ZUNsYXNzID0gaXNBcHBlYXIgJiYgYXBwZWFyQWN0aXZlQ2xhc3MKICAgICAgPyBhcHBlYXJBY3RpdmVDbGFzcwogICAgICA6IGVudGVyQWN0aXZlQ2xhc3M7CiAgICB2YXIgdG9DbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhclRvQ2xhc3MKICAgICAgPyBhcHBlYXJUb0NsYXNzCiAgICAgIDogZW50ZXJUb0NsYXNzOwoKICAgIHZhciBiZWZvcmVFbnRlckhvb2sgPSBpc0FwcGVhcgogICAgICA/IChiZWZvcmVBcHBlYXIgfHwgYmVmb3JlRW50ZXIpCiAgICAgIDogYmVmb3JlRW50ZXI7CiAgICB2YXIgZW50ZXJIb29rID0gaXNBcHBlYXIKICAgICAgPyAodHlwZW9mIGFwcGVhciA9PT0gJ2Z1bmN0aW9uJyA/IGFwcGVhciA6IGVudGVyKQogICAgICA6IGVudGVyOwogICAgdmFyIGFmdGVyRW50ZXJIb29rID0gaXNBcHBlYXIKICAgICAgPyAoYWZ0ZXJBcHBlYXIgfHwgYWZ0ZXJFbnRlcikKICAgICAgOiBhZnRlckVudGVyOwogICAgdmFyIGVudGVyQ2FuY2VsbGVkSG9vayA9IGlzQXBwZWFyCiAgICAgID8gKGFwcGVhckNhbmNlbGxlZCB8fCBlbnRlckNhbmNlbGxlZCkKICAgICAgOiBlbnRlckNhbmNlbGxlZDsKCiAgICB2YXIgZXhwbGljaXRFbnRlckR1cmF0aW9uID0gdG9OdW1iZXIoCiAgICAgIGlzT2JqZWN0KGR1cmF0aW9uKQogICAgICAgID8gZHVyYXRpb24uZW50ZXIKICAgICAgICA6IGR1cmF0aW9uCiAgICApOwoKICAgIGlmIChleHBsaWNpdEVudGVyRHVyYXRpb24gIT0gbnVsbCkgewogICAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0RW50ZXJEdXJhdGlvbiwgJ2VudGVyJywgdm5vZGUpOwogICAgfQoKICAgIHZhciBleHBlY3RzQ1NTID0gY3NzICE9PSBmYWxzZSAmJiAhaXNJRTk7CiAgICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZW50ZXJIb29rKTsKCiAgICB2YXIgY2IgPSBlbC5fZW50ZXJDYiA9IG9uY2UoZnVuY3Rpb24gKCkgewogICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgdG9DbGFzcyk7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICAgIH0KICAgICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwogICAgICAgIH0KICAgICAgICBlbnRlckNhbmNlbGxlZEhvb2sgJiYgZW50ZXJDYW5jZWxsZWRIb29rKGVsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhZnRlckVudGVySG9vayAmJiBhZnRlckVudGVySG9vayhlbCk7CiAgICAgIH0KICAgICAgZWwuX2VudGVyQ2IgPSBudWxsOwogICAgfSk7CgogICAgaWYgKCF2bm9kZS5kYXRhLnNob3cpIHsKICAgICAgLy8gcmVtb3ZlIHBlbmRpbmcgbGVhdmUgZWxlbWVudCBvbiBlbnRlciBieSBpbmplY3RpbmcgYW4gaW5zZXJ0IGhvb2sKICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdpbnNlcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IGVsLnBhcmVudE5vZGU7CiAgICAgICAgdmFyIHBlbmRpbmdOb2RlID0gcGFyZW50ICYmIHBhcmVudC5fcGVuZGluZyAmJiBwYXJlbnQuX3BlbmRpbmdbdm5vZGUua2V5XTsKICAgICAgICBpZiAocGVuZGluZ05vZGUgJiYKICAgICAgICAgIHBlbmRpbmdOb2RlLnRhZyA9PT0gdm5vZGUudGFnICYmCiAgICAgICAgICBwZW5kaW5nTm9kZS5lbG0uX2xlYXZlQ2IKICAgICAgICApIHsKICAgICAgICAgIHBlbmRpbmdOb2RlLmVsbS5fbGVhdmVDYigpOwogICAgICAgIH0KICAgICAgICBlbnRlckhvb2sgJiYgZW50ZXJIb29rKGVsLCBjYik7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIHN0YXJ0IGVudGVyIHRyYW5zaXRpb24KICAgIGJlZm9yZUVudGVySG9vayAmJiBiZWZvcmVFbnRlckhvb2soZWwpOwogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICAgIG5leHRGcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKICAgICAgICBpZiAoIWNiLmNhbmNlbGxlZCkgewogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCB0b0NsYXNzKTsKICAgICAgICAgIGlmICghdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgICAgICBpZiAoaXNWYWxpZER1cmF0aW9uKGV4cGxpY2l0RW50ZXJEdXJhdGlvbikpIHsKICAgICAgICAgICAgICBzZXRUaW1lb3V0KGNiLCBleHBsaWNpdEVudGVyRHVyYXRpb24pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdoZW5UcmFuc2l0aW9uRW5kcyhlbCwgdHlwZSwgY2IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAodm5vZGUuZGF0YS5zaG93KSB7CiAgICAgIHRvZ2dsZURpc3BsYXkgJiYgdG9nZ2xlRGlzcGxheSgpOwogICAgICBlbnRlckhvb2sgJiYgZW50ZXJIb29rKGVsLCBjYik7CiAgICB9CgogICAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgIGNiKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsZWF2ZSAodm5vZGUsIHJtKSB7CiAgICB2YXIgZWwgPSB2bm9kZS5lbG07CgogICAgLy8gY2FsbCBlbnRlciBjYWxsYmFjayBub3cKICAgIGlmIChpc0RlZihlbC5fZW50ZXJDYikpIHsKICAgICAgZWwuX2VudGVyQ2IuY2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgZWwuX2VudGVyQ2IoKTsKICAgIH0KCiAgICB2YXIgZGF0YSA9IHJlc29sdmVUcmFuc2l0aW9uKHZub2RlLmRhdGEudHJhbnNpdGlvbik7CiAgICBpZiAoaXNVbmRlZihkYXRhKSB8fCBlbC5ub2RlVHlwZSAhPT0gMSkgewogICAgICByZXR1cm4gcm0oKQogICAgfQoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKGVsLl9sZWF2ZUNiKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB2YXIgY3NzID0gZGF0YS5jc3M7CiAgICB2YXIgdHlwZSA9IGRhdGEudHlwZTsKICAgIHZhciBsZWF2ZUNsYXNzID0gZGF0YS5sZWF2ZUNsYXNzOwogICAgdmFyIGxlYXZlVG9DbGFzcyA9IGRhdGEubGVhdmVUb0NsYXNzOwogICAgdmFyIGxlYXZlQWN0aXZlQ2xhc3MgPSBkYXRhLmxlYXZlQWN0aXZlQ2xhc3M7CiAgICB2YXIgYmVmb3JlTGVhdmUgPSBkYXRhLmJlZm9yZUxlYXZlOwogICAgdmFyIGxlYXZlID0gZGF0YS5sZWF2ZTsKICAgIHZhciBhZnRlckxlYXZlID0gZGF0YS5hZnRlckxlYXZlOwogICAgdmFyIGxlYXZlQ2FuY2VsbGVkID0gZGF0YS5sZWF2ZUNhbmNlbGxlZDsKICAgIHZhciBkZWxheUxlYXZlID0gZGF0YS5kZWxheUxlYXZlOwogICAgdmFyIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsKCiAgICB2YXIgZXhwZWN0c0NTUyA9IGNzcyAhPT0gZmFsc2UgJiYgIWlzSUU5OwogICAgdmFyIHVzZXJXYW50c0NvbnRyb2wgPSBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKGxlYXZlKTsKCiAgICB2YXIgZXhwbGljaXRMZWF2ZUR1cmF0aW9uID0gdG9OdW1iZXIoCiAgICAgIGlzT2JqZWN0KGR1cmF0aW9uKQogICAgICAgID8gZHVyYXRpb24ubGVhdmUKICAgICAgICA6IGR1cmF0aW9uCiAgICApOwoKICAgIGlmIChpc0RlZihleHBsaWNpdExlYXZlRHVyYXRpb24pKSB7CiAgICAgIGNoZWNrRHVyYXRpb24oZXhwbGljaXRMZWF2ZUR1cmF0aW9uLCAnbGVhdmUnLCB2bm9kZSk7CiAgICB9CgogICAgdmFyIGNiID0gZWwuX2xlYXZlQ2IgPSBvbmNlKGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGVsLnBhcmVudE5vZGUgJiYgZWwucGFyZW50Tm9kZS5fcGVuZGluZykgewogICAgICAgIGVsLnBhcmVudE5vZGUuX3BlbmRpbmdbdm5vZGUua2V5XSA9IG51bGw7CiAgICAgIH0KICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsKICAgICAgfQogICAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CiAgICAgICAgfQogICAgICAgIGxlYXZlQ2FuY2VsbGVkICYmIGxlYXZlQ2FuY2VsbGVkKGVsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBybSgpOwogICAgICAgIGFmdGVyTGVhdmUgJiYgYWZ0ZXJMZWF2ZShlbCk7CiAgICAgIH0KICAgICAgZWwuX2xlYXZlQ2IgPSBudWxsOwogICAgfSk7CgogICAgaWYgKGRlbGF5TGVhdmUpIHsKICAgICAgZGVsYXlMZWF2ZShwZXJmb3JtTGVhdmUpOwogICAgfSBlbHNlIHsKICAgICAgcGVyZm9ybUxlYXZlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gcGVyZm9ybUxlYXZlICgpIHsKICAgICAgLy8gdGhlIGRlbGF5ZWQgbGVhdmUgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIGNhbmNlbGxlZAogICAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgLy8gcmVjb3JkIGxlYXZpbmcgZWxlbWVudAogICAgICBpZiAoIXZub2RlLmRhdGEuc2hvdyAmJiBlbC5wYXJlbnROb2RlKSB7CiAgICAgICAgKGVsLnBhcmVudE5vZGUuX3BlbmRpbmcgfHwgKGVsLnBhcmVudE5vZGUuX3BlbmRpbmcgPSB7fSkpWyh2bm9kZS5rZXkpXSA9IHZub2RlOwogICAgICB9CiAgICAgIGJlZm9yZUxlYXZlICYmIGJlZm9yZUxlYXZlKGVsKTsKICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICAgICAgbmV4dEZyYW1lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CiAgICAgICAgICBpZiAoIWNiLmNhbmNlbGxlZCkgewogICAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgICAgICAgIGlmICghdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRHVyYXRpb24oZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgICAgICAgICAgICAgc2V0VGltZW91dChjYiwgZXhwbGljaXRMZWF2ZUR1cmF0aW9uKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBjYik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgbGVhdmUgJiYgbGVhdmUoZWwsIGNiKTsKICAgICAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgICAgY2IoKTsKICAgICAgfQogICAgfQogIH0KCiAgLy8gb25seSB1c2VkIGluIGRldiBtb2RlCiAgZnVuY3Rpb24gY2hlY2tEdXJhdGlvbiAodmFsLCBuYW1lLCB2bm9kZSkgewogICAgaWYgKHR5cGVvZiB2YWwgIT09ICdudW1iZXInKSB7CiAgICAgIHdhcm4oCiAgICAgICAgIjx0cmFuc2l0aW9uPiBleHBsaWNpdCAiICsgbmFtZSArICIgZHVyYXRpb24gaXMgbm90IGEgdmFsaWQgbnVtYmVyIC0gIiArCiAgICAgICAgImdvdCAiICsgKEpTT04uc3RyaW5naWZ5KHZhbCkpICsgIi4iLAogICAgICAgIHZub2RlLmNvbnRleHQKICAgICAgKTsKICAgIH0gZWxzZSBpZiAoaXNOYU4odmFsKSkgewogICAgICB3YXJuKAogICAgICAgICI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIiArIG5hbWUgKyAiIGR1cmF0aW9uIGlzIE5hTiAtICIgKwogICAgICAgICd0aGUgZHVyYXRpb24gZXhwcmVzc2lvbiBtaWdodCBiZSBpbmNvcnJlY3QuJywKICAgICAgICB2bm9kZS5jb250ZXh0CiAgICAgICk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1ZhbGlkRHVyYXRpb24gKHZhbCkgewogICAgcmV0dXJuIHR5cGVvZiB2YWwgPT09ICdudW1iZXInICYmICFpc05hTih2YWwpCiAgfQoKICAvKioKICAgKiBOb3JtYWxpemUgYSB0cmFuc2l0aW9uIGhvb2sncyBhcmd1bWVudCBsZW5ndGguIFRoZSBob29rIG1heSBiZToKICAgKiAtIGEgbWVyZ2VkIGhvb2sgKGludm9rZXIpIHdpdGggdGhlIG9yaWdpbmFsIGluIC5mbnMKICAgKiAtIGEgd3JhcHBlZCBjb21wb25lbnQgbWV0aG9kIChjaGVjayAuX2xlbmd0aCkKICAgKiAtIGEgcGxhaW4gZnVuY3Rpb24gKC5sZW5ndGgpCiAgICovCiAgZnVuY3Rpb24gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aCAoZm4pIHsKICAgIGlmIChpc1VuZGVmKGZuKSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICAgIHZhciBpbnZva2VyRm5zID0gZm4uZm5zOwogICAgaWYgKGlzRGVmKGludm9rZXJGbnMpKSB7CiAgICAgIC8vIGludm9rZXIKICAgICAgcmV0dXJuIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoCiAgICAgICAgQXJyYXkuaXNBcnJheShpbnZva2VyRm5zKQogICAgICAgICAgPyBpbnZva2VyRm5zWzBdCiAgICAgICAgICA6IGludm9rZXJGbnMKICAgICAgKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIChmbi5fbGVuZ3RoIHx8IGZuLmxlbmd0aCkgPiAxCiAgICB9CiAgfQoKICBmdW5jdGlvbiBfZW50ZXIgKF8sIHZub2RlKSB7CiAgICBpZiAodm5vZGUuZGF0YS5zaG93ICE9PSB0cnVlKSB7CiAgICAgIGVudGVyKHZub2RlKTsKICAgIH0KICB9CgogIHZhciB0cmFuc2l0aW9uID0gaW5Ccm93c2VyID8gewogICAgY3JlYXRlOiBfZW50ZXIsCiAgICBhY3RpdmF0ZTogX2VudGVyLAogICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUkJDEgKHZub2RlLCBybSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICBpZiAodm5vZGUuZGF0YS5zaG93ICE9PSB0cnVlKSB7CiAgICAgICAgbGVhdmUodm5vZGUsIHJtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBybSgpOwogICAgICB9CiAgICB9CiAgfSA6IHt9OwoKICB2YXIgcGxhdGZvcm1Nb2R1bGVzID0gWwogICAgYXR0cnMsCiAgICBrbGFzcywKICAgIGV2ZW50cywKICAgIGRvbVByb3BzLAogICAgc3R5bGUsCiAgICB0cmFuc2l0aW9uCiAgXTsKCiAgLyogICovCgogIC8vIHRoZSBkaXJlY3RpdmUgbW9kdWxlIHNob3VsZCBiZSBhcHBsaWVkIGxhc3QsIGFmdGVyIGFsbAogIC8vIGJ1aWx0LWluIG1vZHVsZXMgaGF2ZSBiZWVuIGFwcGxpZWQuCiAgdmFyIG1vZHVsZXMgPSBwbGF0Zm9ybU1vZHVsZXMuY29uY2F0KGJhc2VNb2R1bGVzKTsKCiAgdmFyIHBhdGNoID0gY3JlYXRlUGF0Y2hGdW5jdGlvbih7IG5vZGVPcHM6IG5vZGVPcHMsIG1vZHVsZXM6IG1vZHVsZXMgfSk7CgogIC8qKgogICAqIE5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBsaWtlIGF0dGFjaGluZwogICAqIHByb3BlcnRpZXMgdG8gRWxlbWVudHMuCiAgICovCgogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChpc0lFOSkgewogICAgLy8gaHR0cDovL3d3dy5tYXR0czQxMS5jb20vcG9zdC9pbnRlcm5ldC1leHBsb3Jlci05LW9uaW5wdXQvCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBlbCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CiAgICAgIGlmIChlbCAmJiBlbC52bW9kZWwpIHsKICAgICAgICB0cmlnZ2VyKGVsLCAnaW5wdXQnKTsKICAgICAgfQogICAgfSk7CiAgfQoKICB2YXIgZGlyZWN0aXZlID0gewogICAgaW5zZXJ0ZWQ6IGZ1bmN0aW9uIGluc2VydGVkIChlbCwgYmluZGluZywgdm5vZGUsIG9sZFZub2RlKSB7CiAgICAgIGlmICh2bm9kZS50YWcgPT09ICdzZWxlY3QnKSB7CiAgICAgICAgLy8gIzY5MDMKICAgICAgICBpZiAob2xkVm5vZGUuZWxtICYmICFvbGRWbm9kZS5lbG0uX3ZPcHRpb25zKSB7CiAgICAgICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZGlyZWN0aXZlLmNvbXBvbmVudFVwZGF0ZWQoZWwsIGJpbmRpbmcsIHZub2RlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGVsLl92T3B0aW9ucyA9IFtdLm1hcC5jYWxsKGVsLm9wdGlvbnMsIGdldFZhbHVlKTsKICAgICAgfSBlbHNlIGlmICh2bm9kZS50YWcgPT09ICd0ZXh0YXJlYScgfHwgaXNUZXh0SW5wdXRUeXBlKGVsLnR5cGUpKSB7CiAgICAgICAgZWwuX3ZNb2RpZmllcnMgPSBiaW5kaW5nLm1vZGlmaWVyczsKICAgICAgICBpZiAoIWJpbmRpbmcubW9kaWZpZXJzLmxhenkpIHsKICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbXBvc2l0aW9uc3RhcnQnLCBvbkNvbXBvc2l0aW9uU3RhcnQpOwogICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY29tcG9zaXRpb25lbmQnLCBvbkNvbXBvc2l0aW9uRW5kKTsKICAgICAgICAgIC8vIFNhZmFyaSA8IDEwLjIgJiBVSVdlYlZpZXcgZG9lc24ndCBmaXJlIGNvbXBvc2l0aW9uZW5kIHdoZW4KICAgICAgICAgIC8vIHN3aXRjaGluZyBmb2N1cyBiZWZvcmUgY29uZmlybWluZyBjb21wb3NpdGlvbiBjaG9pY2UKICAgICAgICAgIC8vIHRoaXMgYWxzbyBmaXhlcyB0aGUgaXNzdWUgd2hlcmUgc29tZSBicm93c2VycyBlLmcuIGlPUyBDaHJvbWUKICAgICAgICAgIC8vIGZpcmVzICJjaGFuZ2UiIGluc3RlYWQgb2YgImlucHV0IiBvbiBhdXRvY29tcGxldGUuCiAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBvbkNvbXBvc2l0aW9uRW5kKTsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgaWYgKGlzSUU5KSB7CiAgICAgICAgICAgIGVsLnZtb2RlbCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGNvbXBvbmVudFVwZGF0ZWQ6IGZ1bmN0aW9uIGNvbXBvbmVudFVwZGF0ZWQgKGVsLCBiaW5kaW5nLCB2bm9kZSkgewogICAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICAgIHNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bm9kZS5jb250ZXh0KTsKICAgICAgICAvLyBpbiBjYXNlIHRoZSBvcHRpb25zIHJlbmRlcmVkIGJ5IHYtZm9yIGhhdmUgY2hhbmdlZCwKICAgICAgICAvLyBpdCdzIHBvc3NpYmxlIHRoYXQgdGhlIHZhbHVlIGlzIG91dC1vZi1zeW5jIHdpdGggdGhlIHJlbmRlcmVkIG9wdGlvbnMuCiAgICAgICAgLy8gZGV0ZWN0IHN1Y2ggY2FzZXMgYW5kIGZpbHRlciBvdXQgdmFsdWVzIHRoYXQgbm8gbG9uZ2VyIGhhcyBhIG1hdGNoaW5nCiAgICAgICAgLy8gb3B0aW9uIGluIHRoZSBET00uCiAgICAgICAgdmFyIHByZXZPcHRpb25zID0gZWwuX3ZPcHRpb25zOwogICAgICAgIHZhciBjdXJPcHRpb25zID0gZWwuX3ZPcHRpb25zID0gW10ubWFwLmNhbGwoZWwub3B0aW9ucywgZ2V0VmFsdWUpOwogICAgICAgIGlmIChjdXJPcHRpb25zLnNvbWUoZnVuY3Rpb24gKG8sIGkpIHsgcmV0dXJuICFsb29zZUVxdWFsKG8sIHByZXZPcHRpb25zW2ldKTsgfSkpIHsKICAgICAgICAgIC8vIHRyaWdnZXIgY2hhbmdlIGV2ZW50IGlmCiAgICAgICAgICAvLyBubyBtYXRjaGluZyBvcHRpb24gZm91bmQgZm9yIGF0IGxlYXN0IG9uZSB2YWx1ZQogICAgICAgICAgdmFyIG5lZWRSZXNldCA9IGVsLm11bHRpcGxlCiAgICAgICAgICAgID8gYmluZGluZy52YWx1ZS5zb21lKGZ1bmN0aW9uICh2KSB7IHJldHVybiBoYXNOb01hdGNoaW5nT3B0aW9uKHYsIGN1ck9wdGlvbnMpOyB9KQogICAgICAgICAgICA6IGJpbmRpbmcudmFsdWUgIT09IGJpbmRpbmcub2xkVmFsdWUgJiYgaGFzTm9NYXRjaGluZ09wdGlvbihiaW5kaW5nLnZhbHVlLCBjdXJPcHRpb25zKTsKICAgICAgICAgIGlmIChuZWVkUmVzZXQpIHsKICAgICAgICAgICAgdHJpZ2dlcihlbCwgJ2NoYW5nZScpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIGZ1bmN0aW9uIHNldFNlbGVjdGVkIChlbCwgYmluZGluZywgdm0pIHsKICAgIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzSUUgfHwgaXNFZGdlKSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAgICAgfSwgMCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhY3R1YWxseVNldFNlbGVjdGVkIChlbCwgYmluZGluZywgdm0pIHsKICAgIHZhciB2YWx1ZSA9IGJpbmRpbmcudmFsdWU7CiAgICB2YXIgaXNNdWx0aXBsZSA9IGVsLm11bHRpcGxlOwogICAgaWYgKGlzTXVsdGlwbGUgJiYgIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHdhcm4oCiAgICAgICAgIjxzZWxlY3QgbXVsdGlwbGUgdi1tb2RlbD1cIiIgKyAoYmluZGluZy5leHByZXNzaW9uKSArICJcIj4gIiArCiAgICAgICAgImV4cGVjdHMgYW4gQXJyYXkgdmFsdWUgZm9yIGl0cyBiaW5kaW5nLCBidXQgZ290ICIgKyAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKS5zbGljZSg4LCAtMSkpLAogICAgICAgIHZtCiAgICAgICk7CiAgICAgIHJldHVybgogICAgfQogICAgdmFyIHNlbGVjdGVkLCBvcHRpb247CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGVsLm9wdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIG9wdGlvbiA9IGVsLm9wdGlvbnNbaV07CiAgICAgIGlmIChpc011bHRpcGxlKSB7CiAgICAgICAgc2VsZWN0ZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIGdldFZhbHVlKG9wdGlvbikpID4gLTE7CiAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCAhPT0gc2VsZWN0ZWQpIHsKICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHNlbGVjdGVkOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobG9vc2VFcXVhbChnZXRWYWx1ZShvcHRpb24pLCB2YWx1ZSkpIHsKICAgICAgICAgIGlmIChlbC5zZWxlY3RlZEluZGV4ICE9PSBpKSB7CiAgICAgICAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSBpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoIWlzTXVsdGlwbGUpIHsKICAgICAgZWwuc2VsZWN0ZWRJbmRleCA9IC0xOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaGFzTm9NYXRjaGluZ09wdGlvbiAodmFsdWUsIG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zLmV2ZXJ5KGZ1bmN0aW9uIChvKSB7IHJldHVybiAhbG9vc2VFcXVhbChvLCB2YWx1ZSk7IH0pCiAgfQoKICBmdW5jdGlvbiBnZXRWYWx1ZSAob3B0aW9uKSB7CiAgICByZXR1cm4gJ192YWx1ZScgaW4gb3B0aW9uCiAgICAgID8gb3B0aW9uLl92YWx1ZQogICAgICA6IG9wdGlvbi52YWx1ZQogIH0KCiAgZnVuY3Rpb24gb25Db21wb3NpdGlvblN0YXJ0IChlKSB7CiAgICBlLnRhcmdldC5jb21wb3NpbmcgPSB0cnVlOwogIH0KCiAgZnVuY3Rpb24gb25Db21wb3NpdGlvbkVuZCAoZSkgewogICAgLy8gcHJldmVudCB0cmlnZ2VyaW5nIGFuIGlucHV0IGV2ZW50IGZvciBubyByZWFzb24KICAgIGlmICghZS50YXJnZXQuY29tcG9zaW5nKSB7IHJldHVybiB9CiAgICBlLnRhcmdldC5jb21wb3NpbmcgPSBmYWxzZTsKICAgIHRyaWdnZXIoZS50YXJnZXQsICdpbnB1dCcpOwogIH0KCiAgZnVuY3Rpb24gdHJpZ2dlciAoZWwsIHR5cGUpIHsKICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgIGUuaW5pdEV2ZW50KHR5cGUsIHRydWUsIHRydWUpOwogICAgZWwuZGlzcGF0Y2hFdmVudChlKTsKICB9CgogIC8qICAqLwoKICAvLyByZWN1cnNpdmVseSBzZWFyY2ggZm9yIHBvc3NpYmxlIHRyYW5zaXRpb24gZGVmaW5lZCBpbnNpZGUgdGhlIGNvbXBvbmVudCByb290CiAgZnVuY3Rpb24gbG9jYXRlTm9kZSAodm5vZGUpIHsKICAgIHJldHVybiB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSAmJiAoIXZub2RlLmRhdGEgfHwgIXZub2RlLmRhdGEudHJhbnNpdGlvbikKICAgICAgPyBsb2NhdGVOb2RlKHZub2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZSkKICAgICAgOiB2bm9kZQogIH0KCiAgdmFyIHNob3cgPSB7CiAgICBiaW5kOiBmdW5jdGlvbiBiaW5kIChlbCwgcmVmLCB2bm9kZSkgewogICAgICB2YXIgdmFsdWUgPSByZWYudmFsdWU7CgogICAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgICB2YXIgdHJhbnNpdGlvbiQkMSA9IHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS50cmFuc2l0aW9uOwogICAgICB2YXIgb3JpZ2luYWxEaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5ID0KICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnJyA6IGVsLnN0eWxlLmRpc3BsYXk7CiAgICAgIGlmICh2YWx1ZSAmJiB0cmFuc2l0aW9uJCQxKSB7CiAgICAgICAgdm5vZGUuZGF0YS5zaG93ID0gdHJ1ZTsKICAgICAgICBlbnRlcih2bm9kZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IG9yaWdpbmFsRGlzcGxheTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBvcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICAgIH0KICAgIH0sCgogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUgKGVsLCByZWYsIHZub2RlKSB7CiAgICAgIHZhciB2YWx1ZSA9IHJlZi52YWx1ZTsKICAgICAgdmFyIG9sZFZhbHVlID0gcmVmLm9sZFZhbHVlOwoKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICghdmFsdWUgPT09ICFvbGRWYWx1ZSkgeyByZXR1cm4gfQogICAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgICB2YXIgdHJhbnNpdGlvbiQkMSA9IHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS50cmFuc2l0aW9uOwogICAgICBpZiAodHJhbnNpdGlvbiQkMSkgewogICAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICBlbnRlcih2bm9kZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5OwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxlYXZlKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gZWwuX192T3JpZ2luYWxEaXNwbGF5IDogJ25vbmUnOwogICAgICB9CiAgICB9LAoKICAgIHVuYmluZDogZnVuY3Rpb24gdW5iaW5kICgKICAgICAgZWwsCiAgICAgIGJpbmRpbmcsCiAgICAgIHZub2RlLAogICAgICBvbGRWbm9kZSwKICAgICAgaXNEZXN0cm95CiAgICApIHsKICAgICAgaWYgKCFpc0Rlc3Ryb3kpIHsKICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5OwogICAgICB9CiAgICB9CiAgfTsKCiAgdmFyIHBsYXRmb3JtRGlyZWN0aXZlcyA9IHsKICAgIG1vZGVsOiBkaXJlY3RpdmUsCiAgICBzaG93OiBzaG93CiAgfTsKCiAgLyogICovCgogIHZhciB0cmFuc2l0aW9uUHJvcHMgPSB7CiAgICBuYW1lOiBTdHJpbmcsCiAgICBhcHBlYXI6IEJvb2xlYW4sCiAgICBjc3M6IEJvb2xlYW4sCiAgICBtb2RlOiBTdHJpbmcsCiAgICB0eXBlOiBTdHJpbmcsCiAgICBlbnRlckNsYXNzOiBTdHJpbmcsCiAgICBsZWF2ZUNsYXNzOiBTdHJpbmcsCiAgICBlbnRlclRvQ2xhc3M6IFN0cmluZywKICAgIGxlYXZlVG9DbGFzczogU3RyaW5nLAogICAgZW50ZXJBY3RpdmVDbGFzczogU3RyaW5nLAogICAgbGVhdmVBY3RpdmVDbGFzczogU3RyaW5nLAogICAgYXBwZWFyQ2xhc3M6IFN0cmluZywKICAgIGFwcGVhckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgICBhcHBlYXJUb0NsYXNzOiBTdHJpbmcsCiAgICBkdXJhdGlvbjogW051bWJlciwgU3RyaW5nLCBPYmplY3RdCiAgfTsKCiAgLy8gaW4gY2FzZSB0aGUgY2hpbGQgaXMgYWxzbyBhbiBhYnN0cmFjdCBjb21wb25lbnQsIGUuZy4gPGtlZXAtYWxpdmU+CiAgLy8gd2Ugd2FudCB0byByZWN1cnNpdmVseSByZXRyaWV2ZSB0aGUgcmVhbCBjb21wb25lbnQgdG8gYmUgcmVuZGVyZWQKICBmdW5jdGlvbiBnZXRSZWFsQ2hpbGQgKHZub2RlKSB7CiAgICB2YXIgY29tcE9wdGlvbnMgPSB2bm9kZSAmJiB2bm9kZS5jb21wb25lbnRPcHRpb25zOwogICAgaWYgKGNvbXBPcHRpb25zICYmIGNvbXBPcHRpb25zLkN0b3Iub3B0aW9ucy5hYnN0cmFjdCkgewogICAgICByZXR1cm4gZ2V0UmVhbENoaWxkKGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoY29tcE9wdGlvbnMuY2hpbGRyZW4pKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHZub2RlCiAgICB9CiAgfQoKICBmdW5jdGlvbiBleHRyYWN0VHJhbnNpdGlvbkRhdGEgKGNvbXApIHsKICAgIHZhciBkYXRhID0ge307CiAgICB2YXIgb3B0aW9ucyA9IGNvbXAuJG9wdGlvbnM7CiAgICAvLyBwcm9wcwogICAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMucHJvcHNEYXRhKSB7CiAgICAgIGRhdGFba2V5XSA9IGNvbXBba2V5XTsKICAgIH0KICAgIC8vIGV2ZW50cy4KICAgIC8vIGV4dHJhY3QgbGlzdGVuZXJzIGFuZCBwYXNzIHRoZW0gZGlyZWN0bHkgdG8gdGhlIHRyYW5zaXRpb24gbWV0aG9kcwogICAgdmFyIGxpc3RlbmVycyA9IG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKICAgIGZvciAodmFyIGtleSQxIGluIGxpc3RlbmVycykgewogICAgICBkYXRhW2NhbWVsaXplKGtleSQxKV0gPSBsaXN0ZW5lcnNba2V5JDFdOwogICAgfQogICAgcmV0dXJuIGRhdGEKICB9CgogIGZ1bmN0aW9uIHBsYWNlaG9sZGVyIChoLCByYXdDaGlsZCkgewogICAgaWYgKC9cZC1rZWVwLWFsaXZlJC8udGVzdChyYXdDaGlsZC50YWcpKSB7CiAgICAgIHJldHVybiBoKCdrZWVwLWFsaXZlJywgewogICAgICAgIHByb3BzOiByYXdDaGlsZC5jb21wb25lbnRPcHRpb25zLnByb3BzRGF0YQogICAgICB9KQogICAgfQogIH0KCiAgZnVuY3Rpb24gaGFzUGFyZW50VHJhbnNpdGlvbiAodm5vZGUpIHsKICAgIHdoaWxlICgodm5vZGUgPSB2bm9kZS5wYXJlbnQpKSB7CiAgICAgIGlmICh2bm9kZS5kYXRhLnRyYW5zaXRpb24pIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1NhbWVDaGlsZCAoY2hpbGQsIG9sZENoaWxkKSB7CiAgICByZXR1cm4gb2xkQ2hpbGQua2V5ID09PSBjaGlsZC5rZXkgJiYgb2xkQ2hpbGQudGFnID09PSBjaGlsZC50YWcKICB9CgogIHZhciBpc05vdFRleHROb2RlID0gZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGMudGFnIHx8IGlzQXN5bmNQbGFjZWhvbGRlcihjKTsgfTsKCiAgdmFyIGlzVlNob3dEaXJlY3RpdmUgPSBmdW5jdGlvbiAoZCkgeyByZXR1cm4gZC5uYW1lID09PSAnc2hvdyc7IH07CgogIHZhciBUcmFuc2l0aW9uID0gewogICAgbmFtZTogJ3RyYW5zaXRpb24nLAogICAgcHJvcHM6IHRyYW5zaXRpb25Qcm9wcywKICAgIGFic3RyYWN0OiB0cnVlLAoKICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyIChoKSB7CiAgICAgIHZhciB0aGlzJDEgPSB0aGlzOwoKICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy4kc2xvdHMuZGVmYXVsdDsKICAgICAgaWYgKCFjaGlsZHJlbikgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyBmaWx0ZXIgb3V0IHRleHQgbm9kZXMgKHBvc3NpYmxlIHdoaXRlc3BhY2VzKQogICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuLmZpbHRlcihpc05vdFRleHROb2RlKTsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHdhcm4gbXVsdGlwbGUgZWxlbWVudHMKICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJzx0cmFuc2l0aW9uPiBjYW4gb25seSBiZSB1c2VkIG9uIGEgc2luZ2xlIGVsZW1lbnQuIFVzZSAnICsKICAgICAgICAgICc8dHJhbnNpdGlvbi1ncm91cD4gZm9yIGxpc3RzLicsCiAgICAgICAgICB0aGlzLiRwYXJlbnQKICAgICAgICApOwogICAgICB9CgogICAgICB2YXIgbW9kZSA9IHRoaXMubW9kZTsKCiAgICAgIC8vIHdhcm4gaW52YWxpZCBtb2RlCiAgICAgIGlmIChtb2RlICYmIG1vZGUgIT09ICdpbi1vdXQnICYmIG1vZGUgIT09ICdvdXQtaW4nCiAgICAgICkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAnaW52YWxpZCA8dHJhbnNpdGlvbj4gbW9kZTogJyArIG1vZGUsCiAgICAgICAgICB0aGlzLiRwYXJlbnQKICAgICAgICApOwogICAgICB9CgogICAgICB2YXIgcmF3Q2hpbGQgPSBjaGlsZHJlblswXTsKCiAgICAgIC8vIGlmIHRoaXMgaXMgYSBjb21wb25lbnQgcm9vdCBub2RlIGFuZCB0aGUgY29tcG9uZW50J3MKICAgICAgLy8gcGFyZW50IGNvbnRhaW5lciBub2RlIGFsc28gaGFzIHRyYW5zaXRpb24sIHNraXAuCiAgICAgIGlmIChoYXNQYXJlbnRUcmFuc2l0aW9uKHRoaXMuJHZub2RlKSkgewogICAgICAgIHJldHVybiByYXdDaGlsZAogICAgICB9CgogICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIGRhdGEgdG8gY2hpbGQKICAgICAgLy8gdXNlIGdldFJlYWxDaGlsZCgpIHRvIGlnbm9yZSBhYnN0cmFjdCBjb21wb25lbnRzIGUuZy4ga2VlcC1hbGl2ZQogICAgICB2YXIgY2hpbGQgPSBnZXRSZWFsQ2hpbGQocmF3Q2hpbGQpOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKCFjaGlsZCkgewogICAgICAgIHJldHVybiByYXdDaGlsZAogICAgICB9CgogICAgICBpZiAodGhpcy5fbGVhdmluZykgewogICAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCkKICAgICAgfQoKICAgICAgLy8gZW5zdXJlIGEga2V5IHRoYXQgaXMgdW5pcXVlIHRvIHRoZSB2bm9kZSB0eXBlIGFuZCB0byB0aGlzIHRyYW5zaXRpb24KICAgICAgLy8gY29tcG9uZW50IGluc3RhbmNlLiBUaGlzIGtleSB3aWxsIGJlIHVzZWQgdG8gcmVtb3ZlIHBlbmRpbmcgbGVhdmluZyBub2RlcwogICAgICAvLyBkdXJpbmcgZW50ZXJpbmcuCiAgICAgIHZhciBpZCA9ICJfX3RyYW5zaXRpb24tIiArICh0aGlzLl91aWQpICsgIi0iOwogICAgICBjaGlsZC5rZXkgPSBjaGlsZC5rZXkgPT0gbnVsbAogICAgICAgID8gY2hpbGQuaXNDb21tZW50CiAgICAgICAgICA/IGlkICsgJ2NvbW1lbnQnCiAgICAgICAgICA6IGlkICsgY2hpbGQudGFnCiAgICAgICAgOiBpc1ByaW1pdGl2ZShjaGlsZC5rZXkpCiAgICAgICAgICA/IChTdHJpbmcoY2hpbGQua2V5KS5pbmRleE9mKGlkKSA9PT0gMCA/IGNoaWxkLmtleSA6IGlkICsgY2hpbGQua2V5KQogICAgICAgICAgOiBjaGlsZC5rZXk7CgogICAgICB2YXIgZGF0YSA9IChjaGlsZC5kYXRhIHx8IChjaGlsZC5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gZXh0cmFjdFRyYW5zaXRpb25EYXRhKHRoaXMpOwogICAgICB2YXIgb2xkUmF3Q2hpbGQgPSB0aGlzLl92bm9kZTsKICAgICAgdmFyIG9sZENoaWxkID0gZ2V0UmVhbENoaWxkKG9sZFJhd0NoaWxkKTsKCiAgICAgIC8vIG1hcmsgdi1zaG93CiAgICAgIC8vIHNvIHRoYXQgdGhlIHRyYW5zaXRpb24gbW9kdWxlIGNhbiBoYW5kIG92ZXIgdGhlIGNvbnRyb2wgdG8gdGhlIGRpcmVjdGl2ZQogICAgICBpZiAoY2hpbGQuZGF0YS5kaXJlY3RpdmVzICYmIGNoaWxkLmRhdGEuZGlyZWN0aXZlcy5zb21lKGlzVlNob3dEaXJlY3RpdmUpKSB7CiAgICAgICAgY2hpbGQuZGF0YS5zaG93ID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKAogICAgICAgIG9sZENoaWxkICYmCiAgICAgICAgb2xkQ2hpbGQuZGF0YSAmJgogICAgICAgICFpc1NhbWVDaGlsZChjaGlsZCwgb2xkQ2hpbGQpICYmCiAgICAgICAgIWlzQXN5bmNQbGFjZWhvbGRlcihvbGRDaGlsZCkgJiYKICAgICAgICAvLyAjNjY4NyBjb21wb25lbnQgcm9vdCBpcyBhIGNvbW1lbnQgbm9kZQogICAgICAgICEob2xkQ2hpbGQuY29tcG9uZW50SW5zdGFuY2UgJiYgb2xkQ2hpbGQuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlLmlzQ29tbWVudCkKICAgICAgKSB7CiAgICAgICAgLy8gcmVwbGFjZSBvbGQgY2hpbGQgdHJhbnNpdGlvbiBkYXRhIHdpdGggZnJlc2ggb25lCiAgICAgICAgLy8gaW1wb3J0YW50IGZvciBkeW5hbWljIHRyYW5zaXRpb25zIQogICAgICAgIHZhciBvbGREYXRhID0gb2xkQ2hpbGQuZGF0YS50cmFuc2l0aW9uID0gZXh0ZW5kKHt9LCBkYXRhKTsKICAgICAgICAvLyBoYW5kbGUgdHJhbnNpdGlvbiBtb2RlCiAgICAgICAgaWYgKG1vZGUgPT09ICdvdXQtaW4nKSB7CiAgICAgICAgICAvLyByZXR1cm4gcGxhY2Vob2xkZXIgbm9kZSBhbmQgcXVldWUgdXBkYXRlIHdoZW4gbGVhdmUgZmluaXNoZXMKICAgICAgICAgIHRoaXMuX2xlYXZpbmcgPSB0cnVlOwogICAgICAgICAgbWVyZ2VWTm9kZUhvb2sob2xkRGF0YSwgJ2FmdGVyTGVhdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMkMS5fbGVhdmluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzJDEuJGZvcmNlVXBkYXRlKCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCkKICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdpbi1vdXQnKSB7CiAgICAgICAgICBpZiAoaXNBc3luY1BsYWNlaG9sZGVyKGNoaWxkKSkgewogICAgICAgICAgICByZXR1cm4gb2xkUmF3Q2hpbGQKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZWxheWVkTGVhdmU7CiAgICAgICAgICB2YXIgcGVyZm9ybUxlYXZlID0gZnVuY3Rpb24gKCkgeyBkZWxheWVkTGVhdmUoKTsgfTsKICAgICAgICAgIG1lcmdlVk5vZGVIb29rKGRhdGEsICdhZnRlckVudGVyJywgcGVyZm9ybUxlYXZlKTsKICAgICAgICAgIG1lcmdlVk5vZGVIb29rKGRhdGEsICdlbnRlckNhbmNlbGxlZCcsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgICBtZXJnZVZOb2RlSG9vayhvbGREYXRhLCAnZGVsYXlMZWF2ZScsIGZ1bmN0aW9uIChsZWF2ZSkgeyBkZWxheWVkTGVhdmUgPSBsZWF2ZTsgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmF3Q2hpbGQKICAgIH0KICB9OwoKICAvKiAgKi8KCiAgdmFyIHByb3BzID0gZXh0ZW5kKHsKICAgIHRhZzogU3RyaW5nLAogICAgbW92ZUNsYXNzOiBTdHJpbmcKICB9LCB0cmFuc2l0aW9uUHJvcHMpOwoKICBkZWxldGUgcHJvcHMubW9kZTsKCiAgdmFyIFRyYW5zaXRpb25Hcm91cCA9IHsKICAgIHByb3BzOiBwcm9wcywKCiAgICBiZWZvcmVNb3VudDogZnVuY3Rpb24gYmVmb3JlTW91bnQgKCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIHZhciB1cGRhdGUgPSB0aGlzLl91cGRhdGU7CiAgICAgIHRoaXMuX3VwZGF0ZSA9IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICAgICAgdmFyIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSA9IHNldEFjdGl2ZUluc3RhbmNlKHRoaXMkMSk7CiAgICAgICAgLy8gZm9yY2UgcmVtb3ZpbmcgcGFzcwogICAgICAgIHRoaXMkMS5fX3BhdGNoX18oCiAgICAgICAgICB0aGlzJDEuX3Zub2RlLAogICAgICAgICAgdGhpcyQxLmtlcHQsCiAgICAgICAgICBmYWxzZSwgLy8gaHlkcmF0aW5nCiAgICAgICAgICB0cnVlIC8vIHJlbW92ZU9ubHkgKCFpbXBvcnRhbnQsIGF2b2lkcyB1bm5lY2Vzc2FyeSBtb3ZlcykKICAgICAgICApOwogICAgICAgIHRoaXMkMS5fdm5vZGUgPSB0aGlzJDEua2VwdDsKICAgICAgICByZXN0b3JlQWN0aXZlSW5zdGFuY2UoKTsKICAgICAgICB1cGRhdGUuY2FsbCh0aGlzJDEsIHZub2RlLCBoeWRyYXRpbmcpOwogICAgICB9OwogICAgfSwKCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlciAoaCkgewogICAgICB2YXIgdGFnID0gdGhpcy50YWcgfHwgdGhpcy4kdm5vZGUuZGF0YS50YWcgfHwgJ3NwYW4nOwogICAgICB2YXIgbWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdmFyIHByZXZDaGlsZHJlbiA9IHRoaXMucHJldkNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgICAgdmFyIHJhd0NoaWxkcmVuID0gdGhpcy4kc2xvdHMuZGVmYXVsdCB8fCBbXTsKICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgICB2YXIgdHJhbnNpdGlvbkRhdGEgPSBleHRyYWN0VHJhbnNpdGlvbkRhdGEodGhpcyk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhd0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGMgPSByYXdDaGlsZHJlbltpXTsKICAgICAgICBpZiAoYy50YWcpIHsKICAgICAgICAgIGlmIChjLmtleSAhPSBudWxsICYmIFN0cmluZyhjLmtleSkuaW5kZXhPZignX192bGlzdCcpICE9PSAwKSB7CiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goYyk7CiAgICAgICAgICAgIG1hcFtjLmtleV0gPSBjCiAgICAgICAgICAgIDsoYy5kYXRhIHx8IChjLmRhdGEgPSB7fSkpLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRGF0YTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBvcHRzID0gYy5jb21wb25lbnRPcHRpb25zOwogICAgICAgICAgICB2YXIgbmFtZSA9IG9wdHMgPyAob3B0cy5DdG9yLm9wdGlvbnMubmFtZSB8fCBvcHRzLnRhZyB8fCAnJykgOiBjLnRhZzsKICAgICAgICAgICAgd2FybigoIjx0cmFuc2l0aW9uLWdyb3VwPiBjaGlsZHJlbiBtdXN0IGJlIGtleWVkOiA8IiArIG5hbWUgKyAiPiIpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChwcmV2Q2hpbGRyZW4pIHsKICAgICAgICB2YXIga2VwdCA9IFtdOwogICAgICAgIHZhciByZW1vdmVkID0gW107CiAgICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgcHJldkNoaWxkcmVuLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICAgIHZhciBjJDEgPSBwcmV2Q2hpbGRyZW5baSQxXTsKICAgICAgICAgIGMkMS5kYXRhLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRGF0YTsKICAgICAgICAgIGMkMS5kYXRhLnBvcyA9IGMkMS5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICBpZiAobWFwW2MkMS5rZXldKSB7CiAgICAgICAgICAgIGtlcHQucHVzaChjJDEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVtb3ZlZC5wdXNoKGMkMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMua2VwdCA9IGgodGFnLCBudWxsLCBrZXB0KTsKICAgICAgICB0aGlzLnJlbW92ZWQgPSByZW1vdmVkOwogICAgICB9CgogICAgICByZXR1cm4gaCh0YWcsIG51bGwsIGNoaWxkcmVuKQogICAgfSwKCiAgICB1cGRhdGVkOiBmdW5jdGlvbiB1cGRhdGVkICgpIHsKICAgICAgdmFyIGNoaWxkcmVuID0gdGhpcy5wcmV2Q2hpbGRyZW47CiAgICAgIHZhciBtb3ZlQ2xhc3MgPSB0aGlzLm1vdmVDbGFzcyB8fCAoKHRoaXMubmFtZSB8fCAndicpICsgJy1tb3ZlJyk7CiAgICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoIHx8ICF0aGlzLmhhc01vdmUoY2hpbGRyZW5bMF0uZWxtLCBtb3ZlQ2xhc3MpKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIC8vIHdlIGRpdmlkZSB0aGUgd29yayBpbnRvIHRocmVlIGxvb3BzIHRvIGF2b2lkIG1peGluZyBET00gcmVhZHMgYW5kIHdyaXRlcwogICAgICAvLyBpbiBlYWNoIGl0ZXJhdGlvbiAtIHdoaWNoIGhlbHBzIHByZXZlbnQgbGF5b3V0IHRocmFzaGluZy4KICAgICAgY2hpbGRyZW4uZm9yRWFjaChjYWxsUGVuZGluZ0Nicyk7CiAgICAgIGNoaWxkcmVuLmZvckVhY2gocmVjb3JkUG9zaXRpb24pOwogICAgICBjaGlsZHJlbi5mb3JFYWNoKGFwcGx5VHJhbnNsYXRpb24pOwoKICAgICAgLy8gZm9yY2UgcmVmbG93IHRvIHB1dCBldmVyeXRoaW5nIGluIHBvc2l0aW9uCiAgICAgIC8vIGFzc2lnbiB0byB0aGlzIHRvIGF2b2lkIGJlaW5nIHJlbW92ZWQgaW4gdHJlZS1zaGFraW5nCiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICB0aGlzLl9yZWZsb3cgPSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDsKCiAgICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgICBpZiAoYy5kYXRhLm1vdmVkKSB7CiAgICAgICAgICB2YXIgZWwgPSBjLmVsbTsKICAgICAgICAgIHZhciBzID0gZWwuc3R5bGU7CiAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIG1vdmVDbGFzcyk7CiAgICAgICAgICBzLnRyYW5zZm9ybSA9IHMuV2Via2l0VHJhbnNmb3JtID0gcy50cmFuc2l0aW9uRHVyYXRpb24gPSAnJzsKICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIodHJhbnNpdGlvbkVuZEV2ZW50LCBlbC5fbW92ZUNiID0gZnVuY3Rpb24gY2IgKGUpIHsKICAgICAgICAgICAgaWYgKGUgJiYgZS50YXJnZXQgIT09IGVsKSB7CiAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFlIHx8IC90cmFuc2Zvcm0kLy50ZXN0KGUucHJvcGVydHlOYW1lKSkgewogICAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIodHJhbnNpdGlvbkVuZEV2ZW50LCBjYik7CiAgICAgICAgICAgICAgZWwuX21vdmVDYiA9IG51bGw7CiAgICAgICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBtb3ZlQ2xhc3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBtZXRob2RzOiB7CiAgICAgIGhhc01vdmU6IGZ1bmN0aW9uIGhhc01vdmUgKGVsLCBtb3ZlQ2xhc3MpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoIWhhc1RyYW5zaXRpb24pIHsKICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAodGhpcy5faGFzTW92ZSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2hhc01vdmUKICAgICAgICB9CiAgICAgICAgLy8gRGV0ZWN0IHdoZXRoZXIgYW4gZWxlbWVudCB3aXRoIHRoZSBtb3ZlIGNsYXNzIGFwcGxpZWQgaGFzCiAgICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zLiBTaW5jZSB0aGUgZWxlbWVudCBtYXkgYmUgaW5zaWRlIGFuIGVudGVyaW5nCiAgICAgICAgLy8gdHJhbnNpdGlvbiBhdCB0aGlzIHZlcnkgbW9tZW50LCB3ZSBtYWtlIGEgY2xvbmUgb2YgaXQgYW5kIHJlbW92ZQogICAgICAgIC8vIGFsbCBvdGhlciB0cmFuc2l0aW9uIGNsYXNzZXMgYXBwbGllZCB0byBlbnN1cmUgb25seSB0aGUgbW92ZSBjbGFzcwogICAgICAgIC8vIGlzIGFwcGxpZWQuCiAgICAgICAgdmFyIGNsb25lID0gZWwuY2xvbmVOb2RlKCk7CiAgICAgICAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgICAgICAgZWwuX3RyYW5zaXRpb25DbGFzc2VzLmZvckVhY2goZnVuY3Rpb24gKGNscykgeyByZW1vdmVDbGFzcyhjbG9uZSwgY2xzKTsgfSk7CiAgICAgICAgfQogICAgICAgIGFkZENsYXNzKGNsb25lLCBtb3ZlQ2xhc3MpOwogICAgICAgIGNsb25lLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgdGhpcy4kZWwuYXBwZW5kQ2hpbGQoY2xvbmUpOwogICAgICAgIHZhciBpbmZvID0gZ2V0VHJhbnNpdGlvbkluZm8oY2xvbmUpOwogICAgICAgIHRoaXMuJGVsLnJlbW92ZUNoaWxkKGNsb25lKTsKICAgICAgICByZXR1cm4gKHRoaXMuX2hhc01vdmUgPSBpbmZvLmhhc1RyYW5zZm9ybSkKICAgICAgfQogICAgfQogIH07CgogIGZ1bmN0aW9uIGNhbGxQZW5kaW5nQ2JzIChjKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChjLmVsbS5fbW92ZUNiKSB7CiAgICAgIGMuZWxtLl9tb3ZlQ2IoKTsKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGMuZWxtLl9lbnRlckNiKSB7CiAgICAgIGMuZWxtLl9lbnRlckNiKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZWNvcmRQb3NpdGlvbiAoYykgewogICAgYy5kYXRhLm5ld1BvcyA9IGMuZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlUcmFuc2xhdGlvbiAoYykgewogICAgdmFyIG9sZFBvcyA9IGMuZGF0YS5wb3M7CiAgICB2YXIgbmV3UG9zID0gYy5kYXRhLm5ld1BvczsKICAgIHZhciBkeCA9IG9sZFBvcy5sZWZ0IC0gbmV3UG9zLmxlZnQ7CiAgICB2YXIgZHkgPSBvbGRQb3MudG9wIC0gbmV3UG9zLnRvcDsKICAgIGlmIChkeCB8fCBkeSkgewogICAgICBjLmRhdGEubW92ZWQgPSB0cnVlOwogICAgICB2YXIgcyA9IGMuZWxtLnN0eWxlOwogICAgICBzLnRyYW5zZm9ybSA9IHMuV2Via2l0VHJhbnNmb3JtID0gInRyYW5zbGF0ZSgiICsgZHggKyAicHgsIiArIGR5ICsgInB4KSI7CiAgICAgIHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJzBzJzsKICAgIH0KICB9CgogIHZhciBwbGF0Zm9ybUNvbXBvbmVudHMgPSB7CiAgICBUcmFuc2l0aW9uOiBUcmFuc2l0aW9uLAogICAgVHJhbnNpdGlvbkdyb3VwOiBUcmFuc2l0aW9uR3JvdXAKICB9OwoKICAvKiAgKi8KCiAgLy8gaW5zdGFsbCBwbGF0Zm9ybSBzcGVjaWZpYyB1dGlscwogIFZ1ZS5jb25maWcubXVzdFVzZVByb3AgPSBtdXN0VXNlUHJvcDsKICBWdWUuY29uZmlnLmlzUmVzZXJ2ZWRUYWcgPSBpc1Jlc2VydmVkVGFnOwogIFZ1ZS5jb25maWcuaXNSZXNlcnZlZEF0dHIgPSBpc1Jlc2VydmVkQXR0cjsKICBWdWUuY29uZmlnLmdldFRhZ05hbWVzcGFjZSA9IGdldFRhZ05hbWVzcGFjZTsKICBWdWUuY29uZmlnLmlzVW5rbm93bkVsZW1lbnQgPSBpc1Vua25vd25FbGVtZW50OwoKICAvLyBpbnN0YWxsIHBsYXRmb3JtIHJ1bnRpbWUgZGlyZWN0aXZlcyAmIGNvbXBvbmVudHMKICBleHRlbmQoVnVlLm9wdGlvbnMuZGlyZWN0aXZlcywgcGxhdGZvcm1EaXJlY3RpdmVzKTsKICBleHRlbmQoVnVlLm9wdGlvbnMuY29tcG9uZW50cywgcGxhdGZvcm1Db21wb25lbnRzKTsKCiAgLy8gaW5zdGFsbCBwbGF0Zm9ybSBwYXRjaCBmdW5jdGlvbgogIFZ1ZS5wcm90b3R5cGUuX19wYXRjaF9fID0gaW5Ccm93c2VyID8gcGF0Y2ggOiBub29wOwoKICAvLyBwdWJsaWMgbW91bnQgbWV0aG9kCiAgVnVlLnByb3RvdHlwZS4kbW91bnQgPSBmdW5jdGlvbiAoCiAgICBlbCwKICAgIGh5ZHJhdGluZwogICkgewogICAgZWwgPSBlbCAmJiBpbkJyb3dzZXIgPyBxdWVyeShlbCkgOiB1bmRlZmluZWQ7CiAgICByZXR1cm4gbW91bnRDb21wb25lbnQodGhpcywgZWwsIGh5ZHJhdGluZykKICB9OwoKICAvLyBkZXZ0b29scyBnbG9iYWwgaG9vawogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgaWYgKGluQnJvd3NlcikgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChjb25maWcuZGV2dG9vbHMpIHsKICAgICAgICBpZiAoZGV2dG9vbHMpIHsKICAgICAgICAgIGRldnRvb2xzLmVtaXQoJ2luaXQnLCBWdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXSgKICAgICAgICAgICAgJ0Rvd25sb2FkIHRoZSBWdWUgRGV2dG9vbHMgZXh0ZW5zaW9uIGZvciBhIGJldHRlciBkZXZlbG9wbWVudCBleHBlcmllbmNlOlxuJyArCiAgICAgICAgICAgICdodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVlLWRldnRvb2xzJwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbmZpZy5wcm9kdWN0aW9uVGlwICE9PSBmYWxzZSAmJgogICAgICAgIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJwogICAgICApIHsKICAgICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXSgKICAgICAgICAgICJZb3UgYXJlIHJ1bm5pbmcgVnVlIGluIGRldmVsb3BtZW50IG1vZGUuXG4iICsKICAgICAgICAgICJNYWtlIHN1cmUgdG8gdHVybiBvbiBwcm9kdWN0aW9uIG1vZGUgd2hlbiBkZXBsb3lpbmcgZm9yIHByb2R1Y3Rpb24uXG4iICsKICAgICAgICAgICJTZWUgbW9yZSB0aXBzIGF0IGh0dHBzOi8vdnVlanMub3JnL2d1aWRlL2RlcGxveW1lbnQuaHRtbCIKICAgICAgICApOwogICAgICB9CiAgICB9LCAwKTsKICB9CgogIC8qICAqLwoKICB2YXIgZGVmYXVsdFRhZ1JFID0gL1x7XHsoKD86Lnxccj9cbikrPylcfVx9L2c7CiAgdmFyIHJlZ2V4RXNjYXBlUkUgPSAvWy0uKis/XiR7fSgpfFtcXVwvXFxdL2c7CgogIHZhciBidWlsZFJlZ2V4ID0gY2FjaGVkKGZ1bmN0aW9uIChkZWxpbWl0ZXJzKSB7CiAgICB2YXIgb3BlbiA9IGRlbGltaXRlcnNbMF0ucmVwbGFjZShyZWdleEVzY2FwZVJFLCAnXFwkJicpOwogICAgdmFyIGNsb3NlID0gZGVsaW1pdGVyc1sxXS5yZXBsYWNlKHJlZ2V4RXNjYXBlUkUsICdcXCQmJyk7CiAgICByZXR1cm4gbmV3IFJlZ0V4cChvcGVuICsgJygoPzoufFxcbikrPyknICsgY2xvc2UsICdnJykKICB9KTsKCgoKICBmdW5jdGlvbiBwYXJzZVRleHQgKAogICAgdGV4dCwKICAgIGRlbGltaXRlcnMKICApIHsKICAgIHZhciB0YWdSRSA9IGRlbGltaXRlcnMgPyBidWlsZFJlZ2V4KGRlbGltaXRlcnMpIDogZGVmYXVsdFRhZ1JFOwogICAgaWYgKCF0YWdSRS50ZXN0KHRleHQpKSB7CiAgICAgIHJldHVybgogICAgfQogICAgdmFyIHRva2VucyA9IFtdOwogICAgdmFyIHJhd1Rva2VucyA9IFtdOwogICAgdmFyIGxhc3RJbmRleCA9IHRhZ1JFLmxhc3RJbmRleCA9IDA7CiAgICB2YXIgbWF0Y2gsIGluZGV4LCB0b2tlblZhbHVlOwogICAgd2hpbGUgKChtYXRjaCA9IHRhZ1JFLmV4ZWModGV4dCkpKSB7CiAgICAgIGluZGV4ID0gbWF0Y2guaW5kZXg7CiAgICAgIC8vIHB1c2ggdGV4dCB0b2tlbgogICAgICBpZiAoaW5kZXggPiBsYXN0SW5kZXgpIHsKICAgICAgICByYXdUb2tlbnMucHVzaCh0b2tlblZhbHVlID0gdGV4dC5zbGljZShsYXN0SW5kZXgsIGluZGV4KSk7CiAgICAgICAgdG9rZW5zLnB1c2goSlNPTi5zdHJpbmdpZnkodG9rZW5WYWx1ZSkpOwogICAgICB9CiAgICAgIC8vIHRhZyB0b2tlbgogICAgICB2YXIgZXhwID0gcGFyc2VGaWx0ZXJzKG1hdGNoWzFdLnRyaW0oKSk7CiAgICAgIHRva2Vucy5wdXNoKCgiX3MoIiArIGV4cCArICIpIikpOwogICAgICByYXdUb2tlbnMucHVzaCh7ICdAYmluZGluZyc6IGV4cCB9KTsKICAgICAgbGFzdEluZGV4ID0gaW5kZXggKyBtYXRjaFswXS5sZW5ndGg7CiAgICB9CiAgICBpZiAobGFzdEluZGV4IDwgdGV4dC5sZW5ndGgpIHsKICAgICAgcmF3VG9rZW5zLnB1c2godG9rZW5WYWx1ZSA9IHRleHQuc2xpY2UobGFzdEluZGV4KSk7CiAgICAgIHRva2Vucy5wdXNoKEpTT04uc3RyaW5naWZ5KHRva2VuVmFsdWUpKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGV4cHJlc3Npb246IHRva2Vucy5qb2luKCcrJyksCiAgICAgIHRva2VuczogcmF3VG9rZW5zCiAgICB9CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gdHJhbnNmb3JtTm9kZSAoZWwsIG9wdGlvbnMpIHsKICAgIHZhciB3YXJuID0gb3B0aW9ucy53YXJuIHx8IGJhc2VXYXJuOwogICAgdmFyIHN0YXRpY0NsYXNzID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ2NsYXNzJyk7CiAgICBpZiAoc3RhdGljQ2xhc3MpIHsKICAgICAgdmFyIHJlcyA9IHBhcnNlVGV4dChzdGF0aWNDbGFzcywgb3B0aW9ucy5kZWxpbWl0ZXJzKTsKICAgICAgaWYgKHJlcykgewogICAgICAgIHdhcm4oCiAgICAgICAgICAiY2xhc3M9XCIiICsgc3RhdGljQ2xhc3MgKyAiXCI6ICIgKwogICAgICAgICAgJ0ludGVycG9sYXRpb24gaW5zaWRlIGF0dHJpYnV0ZXMgaGFzIGJlZW4gcmVtb3ZlZC4gJyArCiAgICAgICAgICAnVXNlIHYtYmluZCBvciB0aGUgY29sb24gc2hvcnRoYW5kIGluc3RlYWQuIEZvciBleGFtcGxlLCAnICsKICAgICAgICAgICdpbnN0ZWFkIG9mIDxkaXYgY2xhc3M9Int7IHZhbCB9fSI+LCB1c2UgPGRpdiA6Y2xhc3M9InZhbCI+LicsCiAgICAgICAgICBlbC5yYXdBdHRyc01hcFsnY2xhc3MnXQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGlmIChzdGF0aWNDbGFzcykgewogICAgICBlbC5zdGF0aWNDbGFzcyA9IEpTT04uc3RyaW5naWZ5KHN0YXRpY0NsYXNzKTsKICAgIH0KICAgIHZhciBjbGFzc0JpbmRpbmcgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ2NsYXNzJywgZmFsc2UgLyogZ2V0U3RhdGljICovKTsKICAgIGlmIChjbGFzc0JpbmRpbmcpIHsKICAgICAgZWwuY2xhc3NCaW5kaW5nID0gY2xhc3NCaW5kaW5nOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2VuRGF0YSAoZWwpIHsKICAgIHZhciBkYXRhID0gJyc7CiAgICBpZiAoZWwuc3RhdGljQ2xhc3MpIHsKICAgICAgZGF0YSArPSAic3RhdGljQ2xhc3M6IiArIChlbC5zdGF0aWNDbGFzcykgKyAiLCI7CiAgICB9CiAgICBpZiAoZWwuY2xhc3NCaW5kaW5nKSB7CiAgICAgIGRhdGEgKz0gImNsYXNzOiIgKyAoZWwuY2xhc3NCaW5kaW5nKSArICIsIjsKICAgIH0KICAgIHJldHVybiBkYXRhCiAgfQoKICB2YXIga2xhc3MkMSA9IHsKICAgIHN0YXRpY0tleXM6IFsnc3RhdGljQ2xhc3MnXSwKICAgIHRyYW5zZm9ybU5vZGU6IHRyYW5zZm9ybU5vZGUsCiAgICBnZW5EYXRhOiBnZW5EYXRhCiAgfTsKCiAgLyogICovCgogIGZ1bmN0aW9uIHRyYW5zZm9ybU5vZGUkMSAoZWwsIG9wdGlvbnMpIHsKICAgIHZhciB3YXJuID0gb3B0aW9ucy53YXJuIHx8IGJhc2VXYXJuOwogICAgdmFyIHN0YXRpY1N0eWxlID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3N0eWxlJyk7CiAgICBpZiAoc3RhdGljU3R5bGUpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICB2YXIgcmVzID0gcGFyc2VUZXh0KHN0YXRpY1N0eWxlLCBvcHRpb25zLmRlbGltaXRlcnMpOwogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICJzdHlsZT1cIiIgKyBzdGF0aWNTdHlsZSArICJcIjogIiArCiAgICAgICAgICAgICdJbnRlcnBvbGF0aW9uIGluc2lkZSBhdHRyaWJ1dGVzIGhhcyBiZWVuIHJlbW92ZWQuICcgKwogICAgICAgICAgICAnVXNlIHYtYmluZCBvciB0aGUgY29sb24gc2hvcnRoYW5kIGluc3RlYWQuIEZvciBleGFtcGxlLCAnICsKICAgICAgICAgICAgJ2luc3RlYWQgb2YgPGRpdiBzdHlsZT0ie3sgdmFsIH19Ij4sIHVzZSA8ZGl2IDpzdHlsZT0idmFsIj4uJywKICAgICAgICAgICAgZWwucmF3QXR0cnNNYXBbJ3N0eWxlJ10KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsLnN0YXRpY1N0eWxlID0gSlNPTi5zdHJpbmdpZnkocGFyc2VTdHlsZVRleHQoc3RhdGljU3R5bGUpKTsKICAgIH0KCiAgICB2YXIgc3R5bGVCaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICdzdHlsZScsIGZhbHNlIC8qIGdldFN0YXRpYyAqLyk7CiAgICBpZiAoc3R5bGVCaW5kaW5nKSB7CiAgICAgIGVsLnN0eWxlQmluZGluZyA9IHN0eWxlQmluZGluZzsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlbkRhdGEkMSAoZWwpIHsKICAgIHZhciBkYXRhID0gJyc7CiAgICBpZiAoZWwuc3RhdGljU3R5bGUpIHsKICAgICAgZGF0YSArPSAic3RhdGljU3R5bGU6IiArIChlbC5zdGF0aWNTdHlsZSkgKyAiLCI7CiAgICB9CiAgICBpZiAoZWwuc3R5bGVCaW5kaW5nKSB7CiAgICAgIGRhdGEgKz0gInN0eWxlOigiICsgKGVsLnN0eWxlQmluZGluZykgKyAiKSwiOwogICAgfQogICAgcmV0dXJuIGRhdGEKICB9CgogIHZhciBzdHlsZSQxID0gewogICAgc3RhdGljS2V5czogWydzdGF0aWNTdHlsZSddLAogICAgdHJhbnNmb3JtTm9kZTogdHJhbnNmb3JtTm9kZSQxLAogICAgZ2VuRGF0YTogZ2VuRGF0YSQxCiAgfTsKCiAgLyogICovCgogIHZhciBkZWNvZGVyOwoKICB2YXIgaGUgPSB7CiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZSAoaHRtbCkgewogICAgICBkZWNvZGVyID0gZGVjb2RlciB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgZGVjb2Rlci5pbm5lckhUTUwgPSBodG1sOwogICAgICByZXR1cm4gZGVjb2Rlci50ZXh0Q29udGVudAogICAgfQogIH07CgogIC8qICAqLwoKICB2YXIgaXNVbmFyeVRhZyA9IG1ha2VNYXAoCiAgICAnYXJlYSxiYXNlLGJyLGNvbCxlbWJlZCxmcmFtZSxocixpbWcsaW5wdXQsaXNpbmRleCxrZXlnZW4sJyArCiAgICAnbGluayxtZXRhLHBhcmFtLHNvdXJjZSx0cmFjayx3YnInCiAgKTsKCiAgLy8gRWxlbWVudHMgdGhhdCB5b3UgY2FuLCBpbnRlbnRpb25hbGx5LCBsZWF2ZSBvcGVuCiAgLy8gKGFuZCB3aGljaCBjbG9zZSB0aGVtc2VsdmVzKQogIHZhciBjYW5CZUxlZnRPcGVuVGFnID0gbWFrZU1hcCgKICAgICdjb2xncm91cCxkZCxkdCxsaSxvcHRpb25zLHAsdGQsdGZvb3QsdGgsdGhlYWQsdHIsc291cmNlJwogICk7CgogIC8vIEhUTUw1IHRhZ3MgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvaW5kaWNlcy5odG1sI2VsZW1lbnRzLTMKICAvLyBQaHJhc2luZyBDb250ZW50IGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL2RvbS5odG1sI3BocmFzaW5nLWNvbnRlbnQKICB2YXIgaXNOb25QaHJhc2luZ1RhZyA9IG1ha2VNYXAoCiAgICAnYWRkcmVzcyxhcnRpY2xlLGFzaWRlLGJhc2UsYmxvY2txdW90ZSxib2R5LGNhcHRpb24sY29sLGNvbGdyb3VwLGRkLCcgKwogICAgJ2RldGFpbHMsZGlhbG9nLGRpdixkbCxkdCxmaWVsZHNldCxmaWdjYXB0aW9uLGZpZ3VyZSxmb290ZXIsZm9ybSwnICsKICAgICdoMSxoMixoMyxoNCxoNSxoNixoZWFkLGhlYWRlcixoZ3JvdXAsaHIsaHRtbCxsZWdlbmQsbGksbWVudWl0ZW0sbWV0YSwnICsKICAgICdvcHRncm91cCxvcHRpb24scGFyYW0scnAscnQsc291cmNlLHN0eWxlLHN1bW1hcnksdGJvZHksdGQsdGZvb3QsdGgsdGhlYWQsJyArCiAgICAndGl0bGUsdHIsdHJhY2snCiAgKTsKCiAgLyoqCiAgICogTm90IHR5cGUtY2hlY2tpbmcgdGhpcyBmaWxlIGJlY2F1c2UgaXQncyBtb3N0bHkgdmVuZG9yIGNvZGUuCiAgICovCgogIC8vIFJlZ3VsYXIgRXhwcmVzc2lvbnMgZm9yIHBhcnNpbmcgdGFncyBhbmQgYXR0cmlidXRlcwogIHZhciBhdHRyaWJ1dGUgPSAvXlxzKihbXlxzIic8PlwvPV0rKSg/OlxzKig9KVxzKig/OiIoW14iXSopIit8JyhbXiddKiknK3woW15ccyInPTw+YF0rKSkpPy87CiAgdmFyIGR5bmFtaWNBcmdBdHRyaWJ1dGUgPSAvXlxzKigoPzp2LVtcdy1dKzp8QHw6fCMpXFtbXj1dK1xdW15ccyInPD5cLz1dKikoPzpccyooPSlccyooPzoiKFteIl0qKSIrfCcoW14nXSopJyt8KFteXHMiJz08PmBdKykpKT8vOwogIHZhciBuY25hbWUgPSAiW2EtekEtWl9dW1xcLVxcLjAtOV9hLXpBLVoiICsgKHVuaWNvZGVSZWdFeHAuc291cmNlKSArICJdKiI7CiAgdmFyIHFuYW1lQ2FwdHVyZSA9ICIoKD86IiArIG5jbmFtZSArICJcXDopPyIgKyBuY25hbWUgKyAiKSI7CiAgdmFyIHN0YXJ0VGFnT3BlbiA9IG5ldyBSZWdFeHAoKCJePCIgKyBxbmFtZUNhcHR1cmUpKTsKICB2YXIgc3RhcnRUYWdDbG9zZSA9IC9eXHMqKFwvPyk+LzsKICB2YXIgZW5kVGFnID0gbmV3IFJlZ0V4cCgoIl48XFwvIiArIHFuYW1lQ2FwdHVyZSArICJbXj5dKj4iKSk7CiAgdmFyIGRvY3R5cGUgPSAvXjwhRE9DVFlQRSBbXj5dKz4vaTsKICAvLyAjNzI5ODogZXNjYXBlIC0gdG8gYXZvaWQgYmVpbmcgcGFzZWQgYXMgSFRNTCBjb21tZW50IHdoZW4gaW5saW5lZCBpbiBwYWdlCiAgdmFyIGNvbW1lbnQgPSAvXjwhXC0tLzsKICB2YXIgY29uZGl0aW9uYWxDb21tZW50ID0gL148IVxbLzsKCiAgLy8gU3BlY2lhbCBFbGVtZW50cyAoY2FuIGNvbnRhaW4gYW55dGhpbmcpCiAgdmFyIGlzUGxhaW5UZXh0RWxlbWVudCA9IG1ha2VNYXAoJ3NjcmlwdCxzdHlsZSx0ZXh0YXJlYScsIHRydWUpOwogIHZhciByZUNhY2hlID0ge307CgogIHZhciBkZWNvZGluZ01hcCA9IHsKICAgICcmbHQ7JzogJzwnLAogICAgJyZndDsnOiAnPicsCiAgICAnJnF1b3Q7JzogJyInLAogICAgJyZhbXA7JzogJyYnLAogICAgJyYjMTA7JzogJ1xuJywKICAgICcmIzk7JzogJ1x0JywKICAgICcmIzM5Oyc6ICInIgogIH07CiAgdmFyIGVuY29kZWRBdHRyID0gLyYoPzpsdHxndHxxdW90fGFtcHwjMzkpOy9nOwogIHZhciBlbmNvZGVkQXR0cldpdGhOZXdMaW5lcyA9IC8mKD86bHR8Z3R8cXVvdHxhbXB8IzM5fCMxMHwjOSk7L2c7CgogIC8vICM1OTkyCiAgdmFyIGlzSWdub3JlTmV3bGluZVRhZyA9IG1ha2VNYXAoJ3ByZSx0ZXh0YXJlYScsIHRydWUpOwogIHZhciBzaG91bGRJZ25vcmVGaXJzdE5ld2xpbmUgPSBmdW5jdGlvbiAodGFnLCBodG1sKSB7IHJldHVybiB0YWcgJiYgaXNJZ25vcmVOZXdsaW5lVGFnKHRhZykgJiYgaHRtbFswXSA9PT0gJ1xuJzsgfTsKCiAgZnVuY3Rpb24gZGVjb2RlQXR0ciAodmFsdWUsIHNob3VsZERlY29kZU5ld2xpbmVzKSB7CiAgICB2YXIgcmUgPSBzaG91bGREZWNvZGVOZXdsaW5lcyA/IGVuY29kZWRBdHRyV2l0aE5ld0xpbmVzIDogZW5jb2RlZEF0dHI7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZShyZSwgZnVuY3Rpb24gKG1hdGNoKSB7IHJldHVybiBkZWNvZGluZ01hcFttYXRjaF07IH0pCiAgfQoKICBmdW5jdGlvbiBwYXJzZUhUTUwgKGh0bWwsIG9wdGlvbnMpIHsKICAgIHZhciBzdGFjayA9IFtdOwogICAgdmFyIGV4cGVjdEhUTUwgPSBvcHRpb25zLmV4cGVjdEhUTUw7CiAgICB2YXIgaXNVbmFyeVRhZyQkMSA9IG9wdGlvbnMuaXNVbmFyeVRhZyB8fCBubzsKICAgIHZhciBjYW5CZUxlZnRPcGVuVGFnJCQxID0gb3B0aW9ucy5jYW5CZUxlZnRPcGVuVGFnIHx8IG5vOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBsYXN0LCBsYXN0VGFnOwogICAgd2hpbGUgKGh0bWwpIHsKICAgICAgbGFzdCA9IGh0bWw7CiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgaW4gYSBwbGFpbnRleHQgY29udGVudCBlbGVtZW50IGxpa2Ugc2NyaXB0L3N0eWxlCiAgICAgIGlmICghbGFzdFRhZyB8fCAhaXNQbGFpblRleHRFbGVtZW50KGxhc3RUYWcpKSB7CiAgICAgICAgdmFyIHRleHRFbmQgPSBodG1sLmluZGV4T2YoJzwnKTsKICAgICAgICBpZiAodGV4dEVuZCA9PT0gMCkgewogICAgICAgICAgLy8gQ29tbWVudDoKICAgICAgICAgIGlmIChjb21tZW50LnRlc3QoaHRtbCkpIHsKICAgICAgICAgICAgdmFyIGNvbW1lbnRFbmQgPSBodG1sLmluZGV4T2YoJy0tPicpOwoKICAgICAgICAgICAgaWYgKGNvbW1lbnRFbmQgPj0gMCkgewogICAgICAgICAgICAgIGlmIChvcHRpb25zLnNob3VsZEtlZXBDb21tZW50KSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmNvbW1lbnQoaHRtbC5zdWJzdHJpbmcoNCwgY29tbWVudEVuZCksIGluZGV4LCBpbmRleCArIGNvbW1lbnRFbmQgKyAzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWR2YW5jZShjb21tZW50RW5kICsgMyk7CiAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29uZGl0aW9uYWxfY29tbWVudCNEb3dubGV2ZWwtcmV2ZWFsZWRfY29uZGl0aW9uYWxfY29tbWVudAogICAgICAgICAgaWYgKGNvbmRpdGlvbmFsQ29tbWVudC50ZXN0KGh0bWwpKSB7CiAgICAgICAgICAgIHZhciBjb25kaXRpb25hbEVuZCA9IGh0bWwuaW5kZXhPZignXT4nKTsKCiAgICAgICAgICAgIGlmIChjb25kaXRpb25hbEVuZCA+PSAwKSB7CiAgICAgICAgICAgICAgYWR2YW5jZShjb25kaXRpb25hbEVuZCArIDIpOwogICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBEb2N0eXBlOgogICAgICAgICAgdmFyIGRvY3R5cGVNYXRjaCA9IGh0bWwubWF0Y2goZG9jdHlwZSk7CiAgICAgICAgICBpZiAoZG9jdHlwZU1hdGNoKSB7CiAgICAgICAgICAgIGFkdmFuY2UoZG9jdHlwZU1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CgogICAgICAgICAgLy8gRW5kIHRhZzoKICAgICAgICAgIHZhciBlbmRUYWdNYXRjaCA9IGh0bWwubWF0Y2goZW5kVGFnKTsKICAgICAgICAgIGlmIChlbmRUYWdNYXRjaCkgewogICAgICAgICAgICB2YXIgY3VySW5kZXggPSBpbmRleDsKICAgICAgICAgICAgYWR2YW5jZShlbmRUYWdNYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICBwYXJzZUVuZFRhZyhlbmRUYWdNYXRjaFsxXSwgY3VySW5kZXgsIGluZGV4KTsKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdGFydCB0YWc6CiAgICAgICAgICB2YXIgc3RhcnRUYWdNYXRjaCA9IHBhcnNlU3RhcnRUYWcoKTsKICAgICAgICAgIGlmIChzdGFydFRhZ01hdGNoKSB7CiAgICAgICAgICAgIGhhbmRsZVN0YXJ0VGFnKHN0YXJ0VGFnTWF0Y2gpOwogICAgICAgICAgICBpZiAoc2hvdWxkSWdub3JlRmlyc3ROZXdsaW5lKHN0YXJ0VGFnTWF0Y2gudGFnTmFtZSwgaHRtbCkpIHsKICAgICAgICAgICAgICBhZHZhbmNlKDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgdGV4dCA9ICh2b2lkIDApLCByZXN0ID0gKHZvaWQgMCksIG5leHQgPSAodm9pZCAwKTsKICAgICAgICBpZiAodGV4dEVuZCA+PSAwKSB7CiAgICAgICAgICByZXN0ID0gaHRtbC5zbGljZSh0ZXh0RW5kKTsKICAgICAgICAgIHdoaWxlICgKICAgICAgICAgICAgIWVuZFRhZy50ZXN0KHJlc3QpICYmCiAgICAgICAgICAgICFzdGFydFRhZ09wZW4udGVzdChyZXN0KSAmJgogICAgICAgICAgICAhY29tbWVudC50ZXN0KHJlc3QpICYmCiAgICAgICAgICAgICFjb25kaXRpb25hbENvbW1lbnQudGVzdChyZXN0KQogICAgICAgICAgKSB7CiAgICAgICAgICAgIC8vIDwgaW4gcGxhaW4gdGV4dCwgYmUgZm9yZ2l2aW5nIGFuZCB0cmVhdCBpdCBhcyB0ZXh0CiAgICAgICAgICAgIG5leHQgPSByZXN0LmluZGV4T2YoJzwnLCAxKTsKICAgICAgICAgICAgaWYgKG5leHQgPCAwKSB7IGJyZWFrIH0KICAgICAgICAgICAgdGV4dEVuZCArPSBuZXh0OwogICAgICAgICAgICByZXN0ID0gaHRtbC5zbGljZSh0ZXh0RW5kKTsKICAgICAgICAgIH0KICAgICAgICAgIHRleHQgPSBodG1sLnN1YnN0cmluZygwLCB0ZXh0RW5kKTsKICAgICAgICB9CgogICAgICAgIGlmICh0ZXh0RW5kIDwgMCkgewogICAgICAgICAgdGV4dCA9IGh0bWw7CiAgICAgICAgfQoKICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgYWR2YW5jZSh0ZXh0Lmxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5jaGFycyAmJiB0ZXh0KSB7CiAgICAgICAgICBvcHRpb25zLmNoYXJzKHRleHQsIGluZGV4IC0gdGV4dC5sZW5ndGgsIGluZGV4KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGVuZFRhZ0xlbmd0aCA9IDA7CiAgICAgICAgdmFyIHN0YWNrZWRUYWcgPSBsYXN0VGFnLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgdmFyIHJlU3RhY2tlZFRhZyA9IHJlQ2FjaGVbc3RhY2tlZFRhZ10gfHwgKHJlQ2FjaGVbc3RhY2tlZFRhZ10gPSBuZXcgUmVnRXhwKCcoW1xcc1xcU10qPykoPC8nICsgc3RhY2tlZFRhZyArICdbXj5dKj4pJywgJ2knKSk7CiAgICAgICAgdmFyIHJlc3QkMSA9IGh0bWwucmVwbGFjZShyZVN0YWNrZWRUYWcsIGZ1bmN0aW9uIChhbGwsIHRleHQsIGVuZFRhZykgewogICAgICAgICAgZW5kVGFnTGVuZ3RoID0gZW5kVGFnLmxlbmd0aDsKICAgICAgICAgIGlmICghaXNQbGFpblRleHRFbGVtZW50KHN0YWNrZWRUYWcpICYmIHN0YWNrZWRUYWcgIT09ICdub3NjcmlwdCcpIHsKICAgICAgICAgICAgdGV4dCA9IHRleHQKICAgICAgICAgICAgICAucmVwbGFjZSgvPCFcLS0oW1xzXFNdKj8pLS0+L2csICckMScpIC8vICM3Mjk4CiAgICAgICAgICAgICAgLnJlcGxhY2UoLzwhXFtDREFUQVxbKFtcc1xTXSo/KV1dPi9nLCAnJDEnKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRJZ25vcmVGaXJzdE5ld2xpbmUoc3RhY2tlZFRhZywgdGV4dCkpIHsKICAgICAgICAgICAgdGV4dCA9IHRleHQuc2xpY2UoMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob3B0aW9ucy5jaGFycykgewogICAgICAgICAgICBvcHRpb25zLmNoYXJzKHRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICcnCiAgICAgICAgfSk7CiAgICAgICAgaW5kZXggKz0gaHRtbC5sZW5ndGggLSByZXN0JDEubGVuZ3RoOwogICAgICAgIGh0bWwgPSByZXN0JDE7CiAgICAgICAgcGFyc2VFbmRUYWcoc3RhY2tlZFRhZywgaW5kZXggLSBlbmRUYWdMZW5ndGgsIGluZGV4KTsKICAgICAgfQoKICAgICAgaWYgKGh0bWwgPT09IGxhc3QpIHsKICAgICAgICBvcHRpb25zLmNoYXJzICYmIG9wdGlvbnMuY2hhcnMoaHRtbCk7CiAgICAgICAgaWYgKCFzdGFjay5sZW5ndGggJiYgb3B0aW9ucy53YXJuKSB7CiAgICAgICAgICBvcHRpb25zLndhcm4oKCJNYWwtZm9ybWF0dGVkIHRhZyBhdCBlbmQgb2YgdGVtcGxhdGU6IFwiIiArIGh0bWwgKyAiXCIiKSwgeyBzdGFydDogaW5kZXggKyBodG1sLmxlbmd0aCB9KTsKICAgICAgICB9CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIC8vIENsZWFuIHVwIGFueSByZW1haW5pbmcgdGFncwogICAgcGFyc2VFbmRUYWcoKTsKCiAgICBmdW5jdGlvbiBhZHZhbmNlIChuKSB7CiAgICAgIGluZGV4ICs9IG47CiAgICAgIGh0bWwgPSBodG1sLnN1YnN0cmluZyhuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVN0YXJ0VGFnICgpIHsKICAgICAgdmFyIHN0YXJ0ID0gaHRtbC5tYXRjaChzdGFydFRhZ09wZW4pOwogICAgICBpZiAoc3RhcnQpIHsKICAgICAgICB2YXIgbWF0Y2ggPSB7CiAgICAgICAgICB0YWdOYW1lOiBzdGFydFsxXSwKICAgICAgICAgIGF0dHJzOiBbXSwKICAgICAgICAgIHN0YXJ0OiBpbmRleAogICAgICAgIH07CiAgICAgICAgYWR2YW5jZShzdGFydFswXS5sZW5ndGgpOwogICAgICAgIHZhciBlbmQsIGF0dHI7CiAgICAgICAgd2hpbGUgKCEoZW5kID0gaHRtbC5tYXRjaChzdGFydFRhZ0Nsb3NlKSkgJiYgKGF0dHIgPSBodG1sLm1hdGNoKGR5bmFtaWNBcmdBdHRyaWJ1dGUpIHx8IGh0bWwubWF0Y2goYXR0cmlidXRlKSkpIHsKICAgICAgICAgIGF0dHIuc3RhcnQgPSBpbmRleDsKICAgICAgICAgIGFkdmFuY2UoYXR0clswXS5sZW5ndGgpOwogICAgICAgICAgYXR0ci5lbmQgPSBpbmRleDsKICAgICAgICAgIG1hdGNoLmF0dHJzLnB1c2goYXR0cik7CiAgICAgICAgfQogICAgICAgIGlmIChlbmQpIHsKICAgICAgICAgIG1hdGNoLnVuYXJ5U2xhc2ggPSBlbmRbMV07CiAgICAgICAgICBhZHZhbmNlKGVuZFswXS5sZW5ndGgpOwogICAgICAgICAgbWF0Y2guZW5kID0gaW5kZXg7CiAgICAgICAgICByZXR1cm4gbWF0Y2gKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVTdGFydFRhZyAobWF0Y2gpIHsKICAgICAgdmFyIHRhZ05hbWUgPSBtYXRjaC50YWdOYW1lOwogICAgICB2YXIgdW5hcnlTbGFzaCA9IG1hdGNoLnVuYXJ5U2xhc2g7CgogICAgICBpZiAoZXhwZWN0SFRNTCkgewogICAgICAgIGlmIChsYXN0VGFnID09PSAncCcgJiYgaXNOb25QaHJhc2luZ1RhZyh0YWdOYW1lKSkgewogICAgICAgICAgcGFyc2VFbmRUYWcobGFzdFRhZyk7CiAgICAgICAgfQogICAgICAgIGlmIChjYW5CZUxlZnRPcGVuVGFnJCQxKHRhZ05hbWUpICYmIGxhc3RUYWcgPT09IHRhZ05hbWUpIHsKICAgICAgICAgIHBhcnNlRW5kVGFnKHRhZ05hbWUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHVuYXJ5ID0gaXNVbmFyeVRhZyQkMSh0YWdOYW1lKSB8fCAhIXVuYXJ5U2xhc2g7CgogICAgICB2YXIgbCA9IG1hdGNoLmF0dHJzLmxlbmd0aDsKICAgICAgdmFyIGF0dHJzID0gbmV3IEFycmF5KGwpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBhcmdzID0gbWF0Y2guYXR0cnNbaV07CiAgICAgICAgdmFyIHZhbHVlID0gYXJnc1szXSB8fCBhcmdzWzRdIHx8IGFyZ3NbNV0gfHwgJyc7CiAgICAgICAgdmFyIHNob3VsZERlY29kZU5ld2xpbmVzID0gdGFnTmFtZSA9PT0gJ2EnICYmIGFyZ3NbMV0gPT09ICdocmVmJwogICAgICAgICAgPyBvcHRpb25zLnNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZgogICAgICAgICAgOiBvcHRpb25zLnNob3VsZERlY29kZU5ld2xpbmVzOwogICAgICAgIGF0dHJzW2ldID0gewogICAgICAgICAgbmFtZTogYXJnc1sxXSwKICAgICAgICAgIHZhbHVlOiBkZWNvZGVBdHRyKHZhbHVlLCBzaG91bGREZWNvZGVOZXdsaW5lcykKICAgICAgICB9OwogICAgICAgIGlmIChvcHRpb25zLm91dHB1dFNvdXJjZVJhbmdlKSB7CiAgICAgICAgICBhdHRyc1tpXS5zdGFydCA9IGFyZ3Muc3RhcnQgKyBhcmdzWzBdLm1hdGNoKC9eXHMqLykubGVuZ3RoOwogICAgICAgICAgYXR0cnNbaV0uZW5kID0gYXJncy5lbmQ7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIXVuYXJ5KSB7CiAgICAgICAgc3RhY2sucHVzaCh7IHRhZzogdGFnTmFtZSwgbG93ZXJDYXNlZFRhZzogdGFnTmFtZS50b0xvd2VyQ2FzZSgpLCBhdHRyczogYXR0cnMsIHN0YXJ0OiBtYXRjaC5zdGFydCwgZW5kOiBtYXRjaC5lbmQgfSk7CiAgICAgICAgbGFzdFRhZyA9IHRhZ05hbWU7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnN0YXJ0KSB7CiAgICAgICAgb3B0aW9ucy5zdGFydCh0YWdOYW1lLCBhdHRycywgdW5hcnksIG1hdGNoLnN0YXJ0LCBtYXRjaC5lbmQpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VFbmRUYWcgKHRhZ05hbWUsIHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIHBvcywgbG93ZXJDYXNlZFRhZ05hbWU7CiAgICAgIGlmIChzdGFydCA9PSBudWxsKSB7IHN0YXJ0ID0gaW5kZXg7IH0KICAgICAgaWYgKGVuZCA9PSBudWxsKSB7IGVuZCA9IGluZGV4OyB9CgogICAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IG9wZW5lZCB0YWcgb2YgdGhlIHNhbWUgdHlwZQogICAgICBpZiAodGFnTmFtZSkgewogICAgICAgIGxvd2VyQ2FzZWRUYWdOYW1lID0gdGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGZvciAocG9zID0gc3RhY2subGVuZ3RoIC0gMTsgcG9zID49IDA7IHBvcy0tKSB7CiAgICAgICAgICBpZiAoc3RhY2tbcG9zXS5sb3dlckNhc2VkVGFnID09PSBsb3dlckNhc2VkVGFnTmFtZSkgewogICAgICAgICAgICBicmVhawogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiBubyB0YWcgbmFtZSBpcyBwcm92aWRlZCwgY2xlYW4gc2hvcAogICAgICAgIHBvcyA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChwb3MgPj0gMCkgewogICAgICAgIC8vIENsb3NlIGFsbCB0aGUgb3BlbiBlbGVtZW50cywgdXAgdGhlIHN0YWNrCiAgICAgICAgZm9yICh2YXIgaSA9IHN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gcG9zOyBpLS0pIHsKICAgICAgICAgIGlmIChpID4gcG9zIHx8ICF0YWdOYW1lICYmCiAgICAgICAgICAgIG9wdGlvbnMud2FybgogICAgICAgICAgKSB7CiAgICAgICAgICAgIG9wdGlvbnMud2FybigKICAgICAgICAgICAgICAoInRhZyA8IiArIChzdGFja1tpXS50YWcpICsgIj4gaGFzIG5vIG1hdGNoaW5nIGVuZCB0YWcuIiksCiAgICAgICAgICAgICAgeyBzdGFydDogc3RhY2tbaV0uc3RhcnQsIGVuZDogc3RhY2tbaV0uZW5kIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvcHRpb25zLmVuZCkgewogICAgICAgICAgICBvcHRpb25zLmVuZChzdGFja1tpXS50YWcsIHN0YXJ0LCBlbmQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIHRoZSBvcGVuIGVsZW1lbnRzIGZyb20gdGhlIHN0YWNrCiAgICAgICAgc3RhY2subGVuZ3RoID0gcG9zOwogICAgICAgIGxhc3RUYWcgPSBwb3MgJiYgc3RhY2tbcG9zIC0gMV0udGFnOwogICAgICB9IGVsc2UgaWYgKGxvd2VyQ2FzZWRUYWdOYW1lID09PSAnYnInKSB7CiAgICAgICAgaWYgKG9wdGlvbnMuc3RhcnQpIHsKICAgICAgICAgIG9wdGlvbnMuc3RhcnQodGFnTmFtZSwgW10sIHRydWUsIHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChsb3dlckNhc2VkVGFnTmFtZSA9PT0gJ3AnKSB7CiAgICAgICAgaWYgKG9wdGlvbnMuc3RhcnQpIHsKICAgICAgICAgIG9wdGlvbnMuc3RhcnQodGFnTmFtZSwgW10sIGZhbHNlLCBzdGFydCwgZW5kKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuZW5kKSB7CiAgICAgICAgICBvcHRpb25zLmVuZCh0YWdOYW1lLCBzdGFydCwgZW5kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgb25SRSA9IC9eQHxedi1vbjovOwogIHZhciBkaXJSRSA9IC9edi18XkB8XjovOwogIHZhciBmb3JBbGlhc1JFID0gLyhbXHNcU10qPylccysoPzppbnxvZilccysoW1xzXFNdKikvOwogIHZhciBmb3JJdGVyYXRvclJFID0gLywoW14sXH1cXV0qKSg/OiwoW14sXH1cXV0qKSk/JC87CiAgdmFyIHN0cmlwUGFyZW5zUkUgPSAvXlwofFwpJC9nOwogIHZhciBkeW5hbWljQXJnUkUgPSAvXlxbLipcXSQvOwoKICB2YXIgYXJnUkUgPSAvOiguKikkLzsKICB2YXIgYmluZFJFID0gL146fF5cLnxedi1iaW5kOi87CiAgdmFyIG1vZGlmaWVyUkUgPSAvXC5bXi5cXV0rKD89W15cXV0qJCkvZzsKCiAgdmFyIHNsb3RSRSA9IC9edi1zbG90KDp8JCl8XiMvOwoKICB2YXIgbGluZUJyZWFrUkUgPSAvW1xyXG5dLzsKICB2YXIgd2hpdGVzcGFjZVJFJDEgPSAvXHMrL2c7CgogIHZhciBpbnZhbGlkQXR0cmlidXRlUkUgPSAvW1xzIic8PlwvPV0vOwoKICB2YXIgZGVjb2RlSFRNTENhY2hlZCA9IGNhY2hlZChoZS5kZWNvZGUpOwoKICB2YXIgZW1wdHlTbG90U2NvcGVUb2tlbiA9ICJfZW1wdHlfIjsKCiAgLy8gY29uZmlndXJhYmxlIHN0YXRlCiAgdmFyIHdhcm4kMjsKICB2YXIgZGVsaW1pdGVyczsKICB2YXIgdHJhbnNmb3JtczsKICB2YXIgcHJlVHJhbnNmb3JtczsKICB2YXIgcG9zdFRyYW5zZm9ybXM7CiAgdmFyIHBsYXRmb3JtSXNQcmVUYWc7CiAgdmFyIHBsYXRmb3JtTXVzdFVzZVByb3A7CiAgdmFyIHBsYXRmb3JtR2V0VGFnTmFtZXNwYWNlOwogIHZhciBtYXliZUNvbXBvbmVudDsKCiAgZnVuY3Rpb24gY3JlYXRlQVNURWxlbWVudCAoCiAgICB0YWcsCiAgICBhdHRycywKICAgIHBhcmVudAogICkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogMSwKICAgICAgdGFnOiB0YWcsCiAgICAgIGF0dHJzTGlzdDogYXR0cnMsCiAgICAgIGF0dHJzTWFwOiBtYWtlQXR0cnNNYXAoYXR0cnMpLAogICAgICByYXdBdHRyc01hcDoge30sCiAgICAgIHBhcmVudDogcGFyZW50LAogICAgICBjaGlsZHJlbjogW10KICAgIH0KICB9CgogIC8qKgogICAqIENvbnZlcnQgSFRNTCBzdHJpbmcgdG8gQVNULgogICAqLwogIGZ1bmN0aW9uIHBhcnNlICgKICAgIHRlbXBsYXRlLAogICAgb3B0aW9ucwogICkgewogICAgd2FybiQyID0gb3B0aW9ucy53YXJuIHx8IGJhc2VXYXJuOwoKICAgIHBsYXRmb3JtSXNQcmVUYWcgPSBvcHRpb25zLmlzUHJlVGFnIHx8IG5vOwogICAgcGxhdGZvcm1NdXN0VXNlUHJvcCA9IG9wdGlvbnMubXVzdFVzZVByb3AgfHwgbm87CiAgICBwbGF0Zm9ybUdldFRhZ05hbWVzcGFjZSA9IG9wdGlvbnMuZ2V0VGFnTmFtZXNwYWNlIHx8IG5vOwogICAgdmFyIGlzUmVzZXJ2ZWRUYWcgPSBvcHRpb25zLmlzUmVzZXJ2ZWRUYWcgfHwgbm87CiAgICBtYXliZUNvbXBvbmVudCA9IGZ1bmN0aW9uIChlbCkgeyByZXR1cm4gISFlbC5jb21wb25lbnQgfHwgIWlzUmVzZXJ2ZWRUYWcoZWwudGFnKTsgfTsKCiAgICB0cmFuc2Zvcm1zID0gcGx1Y2tNb2R1bGVGdW5jdGlvbihvcHRpb25zLm1vZHVsZXMsICd0cmFuc2Zvcm1Ob2RlJyk7CiAgICBwcmVUcmFuc2Zvcm1zID0gcGx1Y2tNb2R1bGVGdW5jdGlvbihvcHRpb25zLm1vZHVsZXMsICdwcmVUcmFuc2Zvcm1Ob2RlJyk7CiAgICBwb3N0VHJhbnNmb3JtcyA9IHBsdWNrTW9kdWxlRnVuY3Rpb24ob3B0aW9ucy5tb2R1bGVzLCAncG9zdFRyYW5zZm9ybU5vZGUnKTsKCiAgICBkZWxpbWl0ZXJzID0gb3B0aW9ucy5kZWxpbWl0ZXJzOwoKICAgIHZhciBzdGFjayA9IFtdOwogICAgdmFyIHByZXNlcnZlV2hpdGVzcGFjZSA9IG9wdGlvbnMucHJlc2VydmVXaGl0ZXNwYWNlICE9PSBmYWxzZTsKICAgIHZhciB3aGl0ZXNwYWNlT3B0aW9uID0gb3B0aW9ucy53aGl0ZXNwYWNlOwogICAgdmFyIHJvb3Q7CiAgICB2YXIgY3VycmVudFBhcmVudDsKICAgIHZhciBpblZQcmUgPSBmYWxzZTsKICAgIHZhciBpblByZSA9IGZhbHNlOwogICAgdmFyIHdhcm5lZCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIHdhcm5PbmNlIChtc2csIHJhbmdlKSB7CiAgICAgIGlmICghd2FybmVkKSB7CiAgICAgICAgd2FybmVkID0gdHJ1ZTsKICAgICAgICB3YXJuJDIobXNnLCByYW5nZSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjbG9zZUVsZW1lbnQgKGVsZW1lbnQpIHsKICAgICAgdHJpbUVuZGluZ1doaXRlc3BhY2UoZWxlbWVudCk7CiAgICAgIGlmICghaW5WUHJlICYmICFlbGVtZW50LnByb2Nlc3NlZCkgewogICAgICAgIGVsZW1lbnQgPSBwcm9jZXNzRWxlbWVudChlbGVtZW50LCBvcHRpb25zKTsKICAgICAgfQogICAgICAvLyB0cmVlIG1hbmFnZW1lbnQKICAgICAgaWYgKCFzdGFjay5sZW5ndGggJiYgZWxlbWVudCAhPT0gcm9vdCkgewogICAgICAgIC8vIGFsbG93IHJvb3QgZWxlbWVudHMgd2l0aCB2LWlmLCB2LWVsc2UtaWYgYW5kIHYtZWxzZQogICAgICAgIGlmIChyb290LmlmICYmIChlbGVtZW50LmVsc2VpZiB8fCBlbGVtZW50LmVsc2UpKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrUm9vdENvbnN0cmFpbnRzKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgYWRkSWZDb25kaXRpb24ocm9vdCwgewogICAgICAgICAgICBleHA6IGVsZW1lbnQuZWxzZWlmLAogICAgICAgICAgICBibG9jazogZWxlbWVudAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm5PbmNlKAogICAgICAgICAgICAiQ29tcG9uZW50IHRlbXBsYXRlIHNob3VsZCBjb250YWluIGV4YWN0bHkgb25lIHJvb3QgZWxlbWVudC4gIiArCiAgICAgICAgICAgICJJZiB5b3UgYXJlIHVzaW5nIHYtaWYgb24gbXVsdGlwbGUgZWxlbWVudHMsICIgKwogICAgICAgICAgICAidXNlIHYtZWxzZS1pZiB0byBjaGFpbiB0aGVtIGluc3RlYWQuIiwKICAgICAgICAgICAgeyBzdGFydDogZWxlbWVudC5zdGFydCB9CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY3VycmVudFBhcmVudCAmJiAhZWxlbWVudC5mb3JiaWRkZW4pIHsKICAgICAgICBpZiAoZWxlbWVudC5lbHNlaWYgfHwgZWxlbWVudC5lbHNlKSB7CiAgICAgICAgICBwcm9jZXNzSWZDb25kaXRpb25zKGVsZW1lbnQsIGN1cnJlbnRQYXJlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZWxlbWVudC5zbG90U2NvcGUpIHsKICAgICAgICAgICAgLy8gc2NvcGVkIHNsb3QKICAgICAgICAgICAgLy8ga2VlcCBpdCBpbiB0aGUgY2hpbGRyZW4gbGlzdCBzbyB0aGF0IHYtZWxzZSgtaWYpIGNvbmRpdGlvbnMgY2FuCiAgICAgICAgICAgIC8vIGZpbmQgaXQgYXMgdGhlIHByZXYgbm9kZS4KICAgICAgICAgICAgdmFyIG5hbWUgPSBlbGVtZW50LnNsb3RUYXJnZXQgfHwgJyJkZWZhdWx0IicKICAgICAgICAgICAgOyhjdXJyZW50UGFyZW50LnNjb3BlZFNsb3RzIHx8IChjdXJyZW50UGFyZW50LnNjb3BlZFNsb3RzID0ge30pKVtuYW1lXSA9IGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50UGFyZW50LmNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICAgICAgICBlbGVtZW50LnBhcmVudCA9IGN1cnJlbnRQYXJlbnQ7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBmaW5hbCBjaGlsZHJlbiBjbGVhbnVwCiAgICAgIC8vIGZpbHRlciBvdXQgc2NvcGVkIHNsb3RzCiAgICAgIGVsZW1lbnQuY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuLmZpbHRlcihmdW5jdGlvbiAoYykgeyByZXR1cm4gIShjKS5zbG90U2NvcGU7IH0pOwogICAgICAvLyByZW1vdmUgdHJhaWxpbmcgd2hpdGVzcGFjZSBub2RlIGFnYWluCiAgICAgIHRyaW1FbmRpbmdXaGl0ZXNwYWNlKGVsZW1lbnQpOwoKICAgICAgLy8gY2hlY2sgcHJlIHN0YXRlCiAgICAgIGlmIChlbGVtZW50LnByZSkgewogICAgICAgIGluVlByZSA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChwbGF0Zm9ybUlzUHJlVGFnKGVsZW1lbnQudGFnKSkgewogICAgICAgIGluUHJlID0gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gYXBwbHkgcG9zdC10cmFuc2Zvcm1zCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9zdFRyYW5zZm9ybXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwb3N0VHJhbnNmb3Jtc1tpXShlbGVtZW50LCBvcHRpb25zKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRyaW1FbmRpbmdXaGl0ZXNwYWNlIChlbCkgewogICAgICAvLyByZW1vdmUgdHJhaWxpbmcgd2hpdGVzcGFjZSBub2RlCiAgICAgIGlmICghaW5QcmUpIHsKICAgICAgICB2YXIgbGFzdE5vZGU7CiAgICAgICAgd2hpbGUgKAogICAgICAgICAgKGxhc3ROb2RlID0gZWwuY2hpbGRyZW5bZWwuY2hpbGRyZW4ubGVuZ3RoIC0gMV0pICYmCiAgICAgICAgICBsYXN0Tm9kZS50eXBlID09PSAzICYmCiAgICAgICAgICBsYXN0Tm9kZS50ZXh0ID09PSAnICcKICAgICAgICApIHsKICAgICAgICAgIGVsLmNoaWxkcmVuLnBvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNoZWNrUm9vdENvbnN0cmFpbnRzIChlbCkgewogICAgICBpZiAoZWwudGFnID09PSAnc2xvdCcgfHwgZWwudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgd2Fybk9uY2UoCiAgICAgICAgICAiQ2Fubm90IHVzZSA8IiArIChlbC50YWcpICsgIj4gYXMgY29tcG9uZW50IHJvb3QgZWxlbWVudCBiZWNhdXNlIGl0IG1heSAiICsKICAgICAgICAgICdjb250YWluIG11bHRpcGxlIG5vZGVzLicsCiAgICAgICAgICB7IHN0YXJ0OiBlbC5zdGFydCB9CiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAoZWwuYXR0cnNNYXAuaGFzT3duUHJvcGVydHkoJ3YtZm9yJykpIHsKICAgICAgICB3YXJuT25jZSgKICAgICAgICAgICdDYW5ub3QgdXNlIHYtZm9yIG9uIHN0YXRlZnVsIGNvbXBvbmVudCByb290IGVsZW1lbnQgYmVjYXVzZSAnICsKICAgICAgICAgICdpdCByZW5kZXJzIG11bHRpcGxlIGVsZW1lbnRzLicsCiAgICAgICAgICBlbC5yYXdBdHRyc01hcFsndi1mb3InXQogICAgICAgICk7CiAgICAgIH0KICAgIH0KCiAgICBwYXJzZUhUTUwodGVtcGxhdGUsIHsKICAgICAgd2Fybjogd2FybiQyLAogICAgICBleHBlY3RIVE1MOiBvcHRpb25zLmV4cGVjdEhUTUwsCiAgICAgIGlzVW5hcnlUYWc6IG9wdGlvbnMuaXNVbmFyeVRhZywKICAgICAgY2FuQmVMZWZ0T3BlblRhZzogb3B0aW9ucy5jYW5CZUxlZnRPcGVuVGFnLAogICAgICBzaG91bGREZWNvZGVOZXdsaW5lczogb3B0aW9ucy5zaG91bGREZWNvZGVOZXdsaW5lcywKICAgICAgc2hvdWxkRGVjb2RlTmV3bGluZXNGb3JIcmVmOiBvcHRpb25zLnNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZiwKICAgICAgc2hvdWxkS2VlcENvbW1lbnQ6IG9wdGlvbnMuY29tbWVudHMsCiAgICAgIG91dHB1dFNvdXJjZVJhbmdlOiBvcHRpb25zLm91dHB1dFNvdXJjZVJhbmdlLAogICAgICBzdGFydDogZnVuY3Rpb24gc3RhcnQgKHRhZywgYXR0cnMsIHVuYXJ5LCBzdGFydCQxLCBlbmQpIHsKICAgICAgICAvLyBjaGVjayBuYW1lc3BhY2UuCiAgICAgICAgLy8gaW5oZXJpdCBwYXJlbnQgbnMgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgdmFyIG5zID0gKGN1cnJlbnRQYXJlbnQgJiYgY3VycmVudFBhcmVudC5ucykgfHwgcGxhdGZvcm1HZXRUYWdOYW1lc3BhY2UodGFnKTsKCiAgICAgICAgLy8gaGFuZGxlIElFIHN2ZyBidWcKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoaXNJRSAmJiBucyA9PT0gJ3N2ZycpIHsKICAgICAgICAgIGF0dHJzID0gZ3VhcmRJRVNWR0J1ZyhhdHRycyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUFTVEVsZW1lbnQodGFnLCBhdHRycywgY3VycmVudFBhcmVudCk7CiAgICAgICAgaWYgKG5zKSB7CiAgICAgICAgICBlbGVtZW50Lm5zID0gbnM7CiAgICAgICAgfQoKICAgICAgICB7CiAgICAgICAgICBpZiAob3B0aW9ucy5vdXRwdXRTb3VyY2VSYW5nZSkgewogICAgICAgICAgICBlbGVtZW50LnN0YXJ0ID0gc3RhcnQkMTsKICAgICAgICAgICAgZWxlbWVudC5lbmQgPSBlbmQ7CiAgICAgICAgICAgIGVsZW1lbnQucmF3QXR0cnNNYXAgPSBlbGVtZW50LmF0dHJzTGlzdC5yZWR1Y2UoZnVuY3Rpb24gKGN1bXVsYXRlZCwgYXR0cikgewogICAgICAgICAgICAgIGN1bXVsYXRlZFthdHRyLm5hbWVdID0gYXR0cjsKICAgICAgICAgICAgICByZXR1cm4gY3VtdWxhdGVkCiAgICAgICAgICAgIH0sIHt9KTsKICAgICAgICAgIH0KICAgICAgICAgIGF0dHJzLmZvckVhY2goZnVuY3Rpb24gKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGludmFsaWRBdHRyaWJ1dGVSRS50ZXN0KGF0dHIubmFtZSkpIHsKICAgICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgICAiSW52YWxpZCBkeW5hbWljIGFyZ3VtZW50IGV4cHJlc3Npb246IGF0dHJpYnV0ZSBuYW1lcyBjYW5ub3QgY29udGFpbiAiICsKICAgICAgICAgICAgICAgICJzcGFjZXMsIHF1b3RlcywgPCwgPiwgLyBvciA9LiIsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0OiBhdHRyLnN0YXJ0ICsgYXR0ci5uYW1lLmluZGV4T2YoIlsiKSwKICAgICAgICAgICAgICAgICAgZW5kOiBhdHRyLnN0YXJ0ICsgYXR0ci5uYW1lLmxlbmd0aAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRm9yYmlkZGVuVGFnKGVsZW1lbnQpICYmICFpc1NlcnZlclJlbmRlcmluZygpKSB7CiAgICAgICAgICBlbGVtZW50LmZvcmJpZGRlbiA9IHRydWU7CiAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICdUZW1wbGF0ZXMgc2hvdWxkIG9ubHkgYmUgcmVzcG9uc2libGUgZm9yIG1hcHBpbmcgdGhlIHN0YXRlIHRvIHRoZSAnICsKICAgICAgICAgICAgJ1VJLiBBdm9pZCBwbGFjaW5nIHRhZ3Mgd2l0aCBzaWRlLWVmZmVjdHMgaW4geW91ciB0ZW1wbGF0ZXMsIHN1Y2ggYXMgJyArCiAgICAgICAgICAgICI8IiArIHRhZyArICI+IiArICcsIGFzIHRoZXkgd2lsbCBub3QgYmUgcGFyc2VkLicsCiAgICAgICAgICAgIHsgc3RhcnQ6IGVsZW1lbnQuc3RhcnQgfQogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIC8vIGFwcGx5IHByZS10cmFuc2Zvcm1zCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmVUcmFuc2Zvcm1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBlbGVtZW50ID0gcHJlVHJhbnNmb3Jtc1tpXShlbGVtZW50LCBvcHRpb25zKSB8fCBlbGVtZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpblZQcmUpIHsKICAgICAgICAgIHByb2Nlc3NQcmUoZWxlbWVudCk7CiAgICAgICAgICBpZiAoZWxlbWVudC5wcmUpIHsKICAgICAgICAgICAgaW5WUHJlID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBsYXRmb3JtSXNQcmVUYWcoZWxlbWVudC50YWcpKSB7CiAgICAgICAgICBpblByZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChpblZQcmUpIHsKICAgICAgICAgIHByb2Nlc3NSYXdBdHRycyhlbGVtZW50KTsKICAgICAgICB9IGVsc2UgaWYgKCFlbGVtZW50LnByb2Nlc3NlZCkgewogICAgICAgICAgLy8gc3RydWN0dXJhbCBkaXJlY3RpdmVzCiAgICAgICAgICBwcm9jZXNzRm9yKGVsZW1lbnQpOwogICAgICAgICAgcHJvY2Vzc0lmKGVsZW1lbnQpOwogICAgICAgICAgcHJvY2Vzc09uY2UoZWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXJvb3QpIHsKICAgICAgICAgIHJvb3QgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1Jvb3RDb25zdHJhaW50cyhyb290KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghdW5hcnkpIHsKICAgICAgICAgIGN1cnJlbnRQYXJlbnQgPSBlbGVtZW50OwogICAgICAgICAgc3RhY2sucHVzaChlbGVtZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xvc2VFbGVtZW50KGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGVuZDogZnVuY3Rpb24gZW5kICh0YWcsIHN0YXJ0LCBlbmQkMSkgewogICAgICAgIHZhciBlbGVtZW50ID0gc3RhY2tbc3RhY2subGVuZ3RoIC0gMV07CiAgICAgICAgLy8gcG9wIHN0YWNrCiAgICAgICAgc3RhY2subGVuZ3RoIC09IDE7CiAgICAgICAgY3VycmVudFBhcmVudCA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmIChvcHRpb25zLm91dHB1dFNvdXJjZVJhbmdlKSB7CiAgICAgICAgICBlbGVtZW50LmVuZCA9IGVuZCQxOwogICAgICAgIH0KICAgICAgICBjbG9zZUVsZW1lbnQoZWxlbWVudCk7CiAgICAgIH0sCgogICAgICBjaGFyczogZnVuY3Rpb24gY2hhcnMgKHRleHQsIHN0YXJ0LCBlbmQpIHsKICAgICAgICBpZiAoIWN1cnJlbnRQYXJlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRleHQgPT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgd2Fybk9uY2UoCiAgICAgICAgICAgICAgICAnQ29tcG9uZW50IHRlbXBsYXRlIHJlcXVpcmVzIGEgcm9vdCBlbGVtZW50LCByYXRoZXIgdGhhbiBqdXN0IHRleHQuJywKICAgICAgICAgICAgICAgIHsgc3RhcnQ6IHN0YXJ0IH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgaWYgKCh0ZXh0ID0gdGV4dC50cmltKCkpKSB7CiAgICAgICAgICAgICAgd2Fybk9uY2UoCiAgICAgICAgICAgICAgICAoInRleHQgXCIiICsgdGV4dCArICJcIiBvdXRzaWRlIHJvb3QgZWxlbWVudCB3aWxsIGJlIGlnbm9yZWQuIiksCiAgICAgICAgICAgICAgICB7IHN0YXJ0OiBzdGFydCB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIC8vIElFIHRleHRhcmVhIHBsYWNlaG9sZGVyIGJ1ZwogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgIGlmIChpc0lFICYmCiAgICAgICAgICBjdXJyZW50UGFyZW50LnRhZyA9PT0gJ3RleHRhcmVhJyAmJgogICAgICAgICAgY3VycmVudFBhcmVudC5hdHRyc01hcC5wbGFjZWhvbGRlciA9PT0gdGV4dAogICAgICAgICkgewogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIHZhciBjaGlsZHJlbiA9IGN1cnJlbnRQYXJlbnQuY2hpbGRyZW47CiAgICAgICAgaWYgKGluUHJlIHx8IHRleHQudHJpbSgpKSB7CiAgICAgICAgICB0ZXh0ID0gaXNUZXh0VGFnKGN1cnJlbnRQYXJlbnQpID8gdGV4dCA6IGRlY29kZUhUTUxDYWNoZWQodGV4dCk7CiAgICAgICAgfSBlbHNlIGlmICghY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAvLyByZW1vdmUgdGhlIHdoaXRlc3BhY2Utb25seSBub2RlIHJpZ2h0IGFmdGVyIGFuIG9wZW5pbmcgdGFnCiAgICAgICAgICB0ZXh0ID0gJyc7CiAgICAgICAgfSBlbHNlIGlmICh3aGl0ZXNwYWNlT3B0aW9uKSB7CiAgICAgICAgICBpZiAod2hpdGVzcGFjZU9wdGlvbiA9PT0gJ2NvbmRlbnNlJykgewogICAgICAgICAgICAvLyBpbiBjb25kZW5zZSBtb2RlLCByZW1vdmUgdGhlIHdoaXRlc3BhY2Ugbm9kZSBpZiBpdCBjb250YWlucwogICAgICAgICAgICAvLyBsaW5lIGJyZWFrLCBvdGhlcndpc2UgY29uZGVuc2UgdG8gYSBzaW5nbGUgc3BhY2UKICAgICAgICAgICAgdGV4dCA9IGxpbmVCcmVha1JFLnRlc3QodGV4dCkgPyAnJyA6ICcgJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHQgPSAnICc7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRleHQgPSBwcmVzZXJ2ZVdoaXRlc3BhY2UgPyAnICcgOiAnJzsKICAgICAgICB9CiAgICAgICAgaWYgKHRleHQpIHsKICAgICAgICAgIGlmICghaW5QcmUgJiYgd2hpdGVzcGFjZU9wdGlvbiA9PT0gJ2NvbmRlbnNlJykgewogICAgICAgICAgICAvLyBjb25kZW5zZSBjb25zZWN1dGl2ZSB3aGl0ZXNwYWNlcyBpbnRvIHNpbmdsZSBzcGFjZQogICAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKHdoaXRlc3BhY2VSRSQxLCAnICcpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlczsKICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIGlmICghaW5WUHJlICYmIHRleHQgIT09ICcgJyAmJiAocmVzID0gcGFyc2VUZXh0KHRleHQsIGRlbGltaXRlcnMpKSkgewogICAgICAgICAgICBjaGlsZCA9IHsKICAgICAgICAgICAgICB0eXBlOiAyLAogICAgICAgICAgICAgIGV4cHJlc3Npb246IHJlcy5leHByZXNzaW9uLAogICAgICAgICAgICAgIHRva2VuczogcmVzLnRva2VucywKICAgICAgICAgICAgICB0ZXh0OiB0ZXh0CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKHRleHQgIT09ICcgJyB8fCAhY2hpbGRyZW4ubGVuZ3RoIHx8IGNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aCAtIDFdLnRleHQgIT09ICcgJykgewogICAgICAgICAgICBjaGlsZCA9IHsKICAgICAgICAgICAgICB0eXBlOiAzLAogICAgICAgICAgICAgIHRleHQ6IHRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGlsZCkgewogICAgICAgICAgICBpZiAob3B0aW9ucy5vdXRwdXRTb3VyY2VSYW5nZSkgewogICAgICAgICAgICAgIGNoaWxkLnN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgICAgICAgY2hpbGQuZW5kID0gZW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgY29tbWVudDogZnVuY3Rpb24gY29tbWVudCAodGV4dCwgc3RhcnQsIGVuZCkgewogICAgICAgIC8vIGFkZGluZyBhbnl0aW5nIGFzIGEgc2libGluZyB0byB0aGUgcm9vdCBub2RlIGlzIGZvcmJpZGRlbgogICAgICAgIC8vIGNvbW1lbnRzIHNob3VsZCBzdGlsbCBiZSBhbGxvd2VkLCBidXQgaWdub3JlZAogICAgICAgIGlmIChjdXJyZW50UGFyZW50KSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSB7CiAgICAgICAgICAgIHR5cGU6IDMsCiAgICAgICAgICAgIHRleHQ6IHRleHQsCiAgICAgICAgICAgIGlzQ29tbWVudDogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIGlmIChvcHRpb25zLm91dHB1dFNvdXJjZVJhbmdlKSB7CiAgICAgICAgICAgIGNoaWxkLnN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgICAgIGNoaWxkLmVuZCA9IGVuZDsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRQYXJlbnQuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByb290CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzUHJlIChlbCkgewogICAgaWYgKGdldEFuZFJlbW92ZUF0dHIoZWwsICd2LXByZScpICE9IG51bGwpIHsKICAgICAgZWwucHJlID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NSYXdBdHRycyAoZWwpIHsKICAgIHZhciBsaXN0ID0gZWwuYXR0cnNMaXN0OwogICAgdmFyIGxlbiA9IGxpc3QubGVuZ3RoOwogICAgaWYgKGxlbikgewogICAgICB2YXIgYXR0cnMgPSBlbC5hdHRycyA9IG5ldyBBcnJheShsZW4pOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgYXR0cnNbaV0gPSB7CiAgICAgICAgICBuYW1lOiBsaXN0W2ldLm5hbWUsCiAgICAgICAgICB2YWx1ZTogSlNPTi5zdHJpbmdpZnkobGlzdFtpXS52YWx1ZSkKICAgICAgICB9OwogICAgICAgIGlmIChsaXN0W2ldLnN0YXJ0ICE9IG51bGwpIHsKICAgICAgICAgIGF0dHJzW2ldLnN0YXJ0ID0gbGlzdFtpXS5zdGFydDsKICAgICAgICAgIGF0dHJzW2ldLmVuZCA9IGxpc3RbaV0uZW5kOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmICghZWwucHJlKSB7CiAgICAgIC8vIG5vbiByb290IG5vZGUgaW4gcHJlIGJsb2NrcyB3aXRoIG5vIGF0dHJpYnV0ZXMKICAgICAgZWwucGxhaW4gPSB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0VsZW1lbnQgKAogICAgZWxlbWVudCwKICAgIG9wdGlvbnMKICApIHsKICAgIHByb2Nlc3NLZXkoZWxlbWVudCk7CgogICAgLy8gZGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyBpcyBhIHBsYWluIGVsZW1lbnQgYWZ0ZXIKICAgIC8vIHJlbW92aW5nIHN0cnVjdHVyYWwgYXR0cmlidXRlcwogICAgZWxlbWVudC5wbGFpbiA9ICgKICAgICAgIWVsZW1lbnQua2V5ICYmCiAgICAgICFlbGVtZW50LnNjb3BlZFNsb3RzICYmCiAgICAgICFlbGVtZW50LmF0dHJzTGlzdC5sZW5ndGgKICAgICk7CgogICAgcHJvY2Vzc1JlZihlbGVtZW50KTsKICAgIHByb2Nlc3NTbG90Q29udGVudChlbGVtZW50KTsKICAgIHByb2Nlc3NTbG90T3V0bGV0KGVsZW1lbnQpOwogICAgcHJvY2Vzc0NvbXBvbmVudChlbGVtZW50KTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJhbnNmb3Jtcy5sZW5ndGg7IGkrKykgewogICAgICBlbGVtZW50ID0gdHJhbnNmb3Jtc1tpXShlbGVtZW50LCBvcHRpb25zKSB8fCBlbGVtZW50OwogICAgfQogICAgcHJvY2Vzc0F0dHJzKGVsZW1lbnQpOwogICAgcmV0dXJuIGVsZW1lbnQKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NLZXkgKGVsKSB7CiAgICB2YXIgZXhwID0gZ2V0QmluZGluZ0F0dHIoZWwsICdrZXknKTsKICAgIGlmIChleHApIHsKICAgICAgewogICAgICAgIGlmIChlbC50YWcgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICAgIHdhcm4kMigKICAgICAgICAgICAgIjx0ZW1wbGF0ZT4gY2Fubm90IGJlIGtleWVkLiBQbGFjZSB0aGUga2V5IG9uIHJlYWwgZWxlbWVudHMgaW5zdGVhZC4iLAogICAgICAgICAgICBnZXRSYXdCaW5kaW5nQXR0cihlbCwgJ2tleScpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZWwuZm9yKSB7CiAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBlbC5pdGVyYXRvcjIgfHwgZWwuaXRlcmF0b3IxOwogICAgICAgICAgdmFyIHBhcmVudCA9IGVsLnBhcmVudDsKICAgICAgICAgIGlmIChpdGVyYXRvciAmJiBpdGVyYXRvciA9PT0gZXhwICYmIHBhcmVudCAmJiBwYXJlbnQudGFnID09PSAndHJhbnNpdGlvbi1ncm91cCcpIHsKICAgICAgICAgICAgd2FybiQyKAogICAgICAgICAgICAgICJEbyBub3QgdXNlIHYtZm9yIGluZGV4IGFzIGtleSBvbiA8dHJhbnNpdGlvbi1ncm91cD4gY2hpbGRyZW4sICIgKwogICAgICAgICAgICAgICJ0aGlzIGlzIHRoZSBzYW1lIGFzIG5vdCB1c2luZyBrZXlzLiIsCiAgICAgICAgICAgICAgZ2V0UmF3QmluZGluZ0F0dHIoZWwsICdrZXknKSwKICAgICAgICAgICAgICB0cnVlIC8qIHRpcCAqLwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBlbC5rZXkgPSBleHA7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzUmVmIChlbCkgewogICAgdmFyIHJlZiA9IGdldEJpbmRpbmdBdHRyKGVsLCAncmVmJyk7CiAgICBpZiAocmVmKSB7CiAgICAgIGVsLnJlZiA9IHJlZjsKICAgICAgZWwucmVmSW5Gb3IgPSBjaGVja0luRm9yKGVsKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NGb3IgKGVsKSB7CiAgICB2YXIgZXhwOwogICAgaWYgKChleHAgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1mb3InKSkpIHsKICAgICAgdmFyIHJlcyA9IHBhcnNlRm9yKGV4cCk7CiAgICAgIGlmIChyZXMpIHsKICAgICAgICBleHRlbmQoZWwsIHJlcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2FybiQyKAogICAgICAgICAgKCJJbnZhbGlkIHYtZm9yIGV4cHJlc3Npb246ICIgKyBleHApLAogICAgICAgICAgZWwucmF3QXR0cnNNYXBbJ3YtZm9yJ10KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQoKCgogIGZ1bmN0aW9uIHBhcnNlRm9yIChleHApIHsKICAgIHZhciBpbk1hdGNoID0gZXhwLm1hdGNoKGZvckFsaWFzUkUpOwogICAgaWYgKCFpbk1hdGNoKSB7IHJldHVybiB9CiAgICB2YXIgcmVzID0ge307CiAgICByZXMuZm9yID0gaW5NYXRjaFsyXS50cmltKCk7CiAgICB2YXIgYWxpYXMgPSBpbk1hdGNoWzFdLnRyaW0oKS5yZXBsYWNlKHN0cmlwUGFyZW5zUkUsICcnKTsKICAgIHZhciBpdGVyYXRvck1hdGNoID0gYWxpYXMubWF0Y2goZm9ySXRlcmF0b3JSRSk7CiAgICBpZiAoaXRlcmF0b3JNYXRjaCkgewogICAgICByZXMuYWxpYXMgPSBhbGlhcy5yZXBsYWNlKGZvckl0ZXJhdG9yUkUsICcnKS50cmltKCk7CiAgICAgIHJlcy5pdGVyYXRvcjEgPSBpdGVyYXRvck1hdGNoWzFdLnRyaW0oKTsKICAgICAgaWYgKGl0ZXJhdG9yTWF0Y2hbMl0pIHsKICAgICAgICByZXMuaXRlcmF0b3IyID0gaXRlcmF0b3JNYXRjaFsyXS50cmltKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlcy5hbGlhcyA9IGFsaWFzOwogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0lmIChlbCkgewogICAgdmFyIGV4cCA9IGdldEFuZFJlbW92ZUF0dHIoZWwsICd2LWlmJyk7CiAgICBpZiAoZXhwKSB7CiAgICAgIGVsLmlmID0gZXhwOwogICAgICBhZGRJZkNvbmRpdGlvbihlbCwgewogICAgICAgIGV4cDogZXhwLAogICAgICAgIGJsb2NrOiBlbAogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1lbHNlJykgIT0gbnVsbCkgewogICAgICAgIGVsLmVsc2UgPSB0cnVlOwogICAgICB9CiAgICAgIHZhciBlbHNlaWYgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1lbHNlLWlmJyk7CiAgICAgIGlmIChlbHNlaWYpIHsKICAgICAgICBlbC5lbHNlaWYgPSBlbHNlaWY7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NJZkNvbmRpdGlvbnMgKGVsLCBwYXJlbnQpIHsKICAgIHZhciBwcmV2ID0gZmluZFByZXZFbGVtZW50KHBhcmVudC5jaGlsZHJlbik7CiAgICBpZiAocHJldiAmJiBwcmV2LmlmKSB7CiAgICAgIGFkZElmQ29uZGl0aW9uKHByZXYsIHsKICAgICAgICBleHA6IGVsLmVsc2VpZiwKICAgICAgICBibG9jazogZWwKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB3YXJuJDIoCiAgICAgICAgInYtIiArIChlbC5lbHNlaWYgPyAoJ2Vsc2UtaWY9IicgKyBlbC5lbHNlaWYgKyAnIicpIDogJ2Vsc2UnKSArICIgIiArCiAgICAgICAgInVzZWQgb24gZWxlbWVudCA8IiArIChlbC50YWcpICsgIj4gd2l0aG91dCBjb3JyZXNwb25kaW5nIHYtaWYuIiwKICAgICAgICBlbC5yYXdBdHRyc01hcFtlbC5lbHNlaWYgPyAndi1lbHNlLWlmJyA6ICd2LWVsc2UnXQogICAgICApOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZmluZFByZXZFbGVtZW50IChjaGlsZHJlbikgewogICAgdmFyIGkgPSBjaGlsZHJlbi5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIGlmIChjaGlsZHJlbltpXS50eXBlID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGNoaWxkcmVuW2ldCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGNoaWxkcmVuW2ldLnRleHQgIT09ICcgJykgewogICAgICAgICAgd2FybiQyKAogICAgICAgICAgICAidGV4dCBcIiIgKyAoY2hpbGRyZW5baV0udGV4dC50cmltKCkpICsgIlwiIGJldHdlZW4gdi1pZiBhbmQgdi1lbHNlKC1pZikgIiArCiAgICAgICAgICAgICJ3aWxsIGJlIGlnbm9yZWQuIiwKICAgICAgICAgICAgY2hpbGRyZW5baV0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNoaWxkcmVuLnBvcCgpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGRJZkNvbmRpdGlvbiAoZWwsIGNvbmRpdGlvbikgewogICAgaWYgKCFlbC5pZkNvbmRpdGlvbnMpIHsKICAgICAgZWwuaWZDb25kaXRpb25zID0gW107CiAgICB9CiAgICBlbC5pZkNvbmRpdGlvbnMucHVzaChjb25kaXRpb24pOwogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc09uY2UgKGVsKSB7CiAgICB2YXIgb25jZSQkMSA9IGdldEFuZFJlbW92ZUF0dHIoZWwsICd2LW9uY2UnKTsKICAgIGlmIChvbmNlJCQxICE9IG51bGwpIHsKICAgICAgZWwub25jZSA9IHRydWU7CiAgICB9CiAgfQoKICAvLyBoYW5kbGUgY29udGVudCBiZWluZyBwYXNzZWQgdG8gYSBjb21wb25lbnQgYXMgc2xvdCwKICAvLyBlLmcuIDx0ZW1wbGF0ZSBzbG90PSJ4eHgiPiwgPGRpdiBzbG90LXNjb3BlPSJ4eHgiPgogIGZ1bmN0aW9uIHByb2Nlc3NTbG90Q29udGVudCAoZWwpIHsKICAgIHZhciBzbG90U2NvcGU7CiAgICBpZiAoZWwudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgIHNsb3RTY29wZSA9IGdldEFuZFJlbW92ZUF0dHIoZWwsICdzY29wZScpOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKHNsb3RTY29wZSkgewogICAgICAgIHdhcm4kMigKICAgICAgICAgICJ0aGUgXCJzY29wZVwiIGF0dHJpYnV0ZSBmb3Igc2NvcGVkIHNsb3RzIGhhdmUgYmVlbiBkZXByZWNhdGVkIGFuZCAiICsKICAgICAgICAgICJyZXBsYWNlZCBieSBcInNsb3Qtc2NvcGVcIiBzaW5jZSAyLjUuIFRoZSBuZXcgXCJzbG90LXNjb3BlXCIgYXR0cmlidXRlICIgKwogICAgICAgICAgImNhbiBhbHNvIGJlIHVzZWQgb24gcGxhaW4gZWxlbWVudHMgaW4gYWRkaXRpb24gdG8gPHRlbXBsYXRlPiB0byAiICsKICAgICAgICAgICJkZW5vdGUgc2NvcGVkIHNsb3RzLiIsCiAgICAgICAgICBlbC5yYXdBdHRyc01hcFsnc2NvcGUnXSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICB9CiAgICAgIGVsLnNsb3RTY29wZSA9IHNsb3RTY29wZSB8fCBnZXRBbmRSZW1vdmVBdHRyKGVsLCAnc2xvdC1zY29wZScpOwogICAgfSBlbHNlIGlmICgoc2xvdFNjb3BlID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3Nsb3Qtc2NvcGUnKSkpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmIChlbC5hdHRyc01hcFsndi1mb3InXSkgewogICAgICAgIHdhcm4kMigKICAgICAgICAgICJBbWJpZ3VvdXMgY29tYmluZWQgdXNhZ2Ugb2Ygc2xvdC1zY29wZSBhbmQgdi1mb3Igb24gPCIgKyAoZWwudGFnKSArICI+ICIgKwogICAgICAgICAgIih2LWZvciB0YWtlcyBoaWdoZXIgcHJpb3JpdHkpLiBVc2UgYSB3cmFwcGVyIDx0ZW1wbGF0ZT4gZm9yIHRoZSAiICsKICAgICAgICAgICJzY29wZWQgc2xvdCB0byBtYWtlIGl0IGNsZWFyZXIuIiwKICAgICAgICAgIGVsLnJhd0F0dHJzTWFwWydzbG90LXNjb3BlJ10sCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgfQogICAgICBlbC5zbG90U2NvcGUgPSBzbG90U2NvcGU7CiAgICB9CgogICAgLy8gc2xvdD0ieHh4IgogICAgdmFyIHNsb3RUYXJnZXQgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ3Nsb3QnKTsKICAgIGlmIChzbG90VGFyZ2V0KSB7CiAgICAgIGVsLnNsb3RUYXJnZXQgPSBzbG90VGFyZ2V0ID09PSAnIiInID8gJyJkZWZhdWx0IicgOiBzbG90VGFyZ2V0OwogICAgICBlbC5zbG90VGFyZ2V0RHluYW1pYyA9ICEhKGVsLmF0dHJzTWFwWyc6c2xvdCddIHx8IGVsLmF0dHJzTWFwWyd2LWJpbmQ6c2xvdCddKTsKICAgICAgLy8gcHJlc2VydmUgc2xvdCBhcyBhbiBhdHRyaWJ1dGUgZm9yIG5hdGl2ZSBzaGFkb3cgRE9NIGNvbXBhdAogICAgICAvLyBvbmx5IGZvciBub24tc2NvcGVkIHNsb3RzLgogICAgICBpZiAoZWwudGFnICE9PSAndGVtcGxhdGUnICYmICFlbC5zbG90U2NvcGUpIHsKICAgICAgICBhZGRBdHRyKGVsLCAnc2xvdCcsIHNsb3RUYXJnZXQsIGdldFJhd0JpbmRpbmdBdHRyKGVsLCAnc2xvdCcpKTsKICAgICAgfQogICAgfQoKICAgIC8vIDIuNiB2LXNsb3Qgc3ludGF4CiAgICB7CiAgICAgIGlmIChlbC50YWcgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICAvLyB2LXNsb3Qgb24gPHRlbXBsYXRlPgogICAgICAgIHZhciBzbG90QmluZGluZyA9IGdldEFuZFJlbW92ZUF0dHJCeVJlZ2V4KGVsLCBzbG90UkUpOwogICAgICAgIGlmIChzbG90QmluZGluZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWwuc2xvdFRhcmdldCB8fCBlbC5zbG90U2NvcGUpIHsKICAgICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgICAiVW5leHBlY3RlZCBtaXhlZCB1c2FnZSBvZiBkaWZmZXJlbnQgc2xvdCBzeW50YXhlcy4iLAogICAgICAgICAgICAgICAgZWwKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbC5wYXJlbnQgJiYgIW1heWJlQ29tcG9uZW50KGVsLnBhcmVudCkpIHsKICAgICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgICAiPHRlbXBsYXRlIHYtc2xvdD4gY2FuIG9ubHkgYXBwZWFyIGF0IHRoZSByb290IGxldmVsIGluc2lkZSAiICsKICAgICAgICAgICAgICAgICJ0aGUgcmVjZWl2aW5nIHRoZSBjb21wb25lbnQiLAogICAgICAgICAgICAgICAgZWwKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVmID0gZ2V0U2xvdE5hbWUoc2xvdEJpbmRpbmcpOwogICAgICAgICAgdmFyIG5hbWUgPSByZWYubmFtZTsKICAgICAgICAgIHZhciBkeW5hbWljID0gcmVmLmR5bmFtaWM7CiAgICAgICAgICBlbC5zbG90VGFyZ2V0ID0gbmFtZTsKICAgICAgICAgIGVsLnNsb3RUYXJnZXREeW5hbWljID0gZHluYW1pYzsKICAgICAgICAgIGVsLnNsb3RTY29wZSA9IHNsb3RCaW5kaW5nLnZhbHVlIHx8IGVtcHR5U2xvdFNjb3BlVG9rZW47IC8vIGZvcmNlIGl0IGludG8gYSBzY29wZWQgc2xvdCBmb3IgcGVyZgogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB2LXNsb3Qgb24gY29tcG9uZW50LCBkZW5vdGVzIGRlZmF1bHQgc2xvdAogICAgICAgIHZhciBzbG90QmluZGluZyQxID0gZ2V0QW5kUmVtb3ZlQXR0ckJ5UmVnZXgoZWwsIHNsb3RSRSk7CiAgICAgICAgaWYgKHNsb3RCaW5kaW5nJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFtYXliZUNvbXBvbmVudChlbCkpIHsKICAgICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgICAidi1zbG90IGNhbiBvbmx5IGJlIHVzZWQgb24gY29tcG9uZW50cyBvciA8dGVtcGxhdGU+LiIsCiAgICAgICAgICAgICAgICBzbG90QmluZGluZyQxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWwuc2xvdFNjb3BlIHx8IGVsLnNsb3RUYXJnZXQpIHsKICAgICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgICAiVW5leHBlY3RlZCBtaXhlZCB1c2FnZSBvZiBkaWZmZXJlbnQgc2xvdCBzeW50YXhlcy4iLAogICAgICAgICAgICAgICAgZWwKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbC5zY29wZWRTbG90cykgewogICAgICAgICAgICAgIHdhcm4kMigKICAgICAgICAgICAgICAgICJUbyBhdm9pZCBzY29wZSBhbWJpZ3VpdHksIHRoZSBkZWZhdWx0IHNsb3Qgc2hvdWxkIGFsc28gdXNlICIgKwogICAgICAgICAgICAgICAgIjx0ZW1wbGF0ZT4gc3ludGF4IHdoZW4gdGhlcmUgYXJlIG90aGVyIG5hbWVkIHNsb3RzLiIsCiAgICAgICAgICAgICAgICBzbG90QmluZGluZyQxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gYWRkIHRoZSBjb21wb25lbnQncyBjaGlsZHJlbiB0byBpdHMgZGVmYXVsdCBzbG90CiAgICAgICAgICB2YXIgc2xvdHMgPSBlbC5zY29wZWRTbG90cyB8fCAoZWwuc2NvcGVkU2xvdHMgPSB7fSk7CiAgICAgICAgICB2YXIgcmVmJDEgPSBnZXRTbG90TmFtZShzbG90QmluZGluZyQxKTsKICAgICAgICAgIHZhciBuYW1lJDEgPSByZWYkMS5uYW1lOwogICAgICAgICAgdmFyIGR5bmFtaWMkMSA9IHJlZiQxLmR5bmFtaWM7CiAgICAgICAgICB2YXIgc2xvdENvbnRhaW5lciA9IHNsb3RzW25hbWUkMV0gPSBjcmVhdGVBU1RFbGVtZW50KCd0ZW1wbGF0ZScsIFtdLCBlbCk7CiAgICAgICAgICBzbG90Q29udGFpbmVyLnNsb3RUYXJnZXQgPSBuYW1lJDE7CiAgICAgICAgICBzbG90Q29udGFpbmVyLnNsb3RUYXJnZXREeW5hbWljID0gZHluYW1pYyQxOwogICAgICAgICAgc2xvdENvbnRhaW5lci5jaGlsZHJlbiA9IGVsLmNoaWxkcmVuLmZpbHRlcihmdW5jdGlvbiAoYykgewogICAgICAgICAgICBpZiAoIWMuc2xvdFNjb3BlKSB7CiAgICAgICAgICAgICAgYy5wYXJlbnQgPSBzbG90Q29udGFpbmVyOwogICAgICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2xvdENvbnRhaW5lci5zbG90U2NvcGUgPSBzbG90QmluZGluZyQxLnZhbHVlIHx8IGVtcHR5U2xvdFNjb3BlVG9rZW47CiAgICAgICAgICAvLyByZW1vdmUgY2hpbGRyZW4gYXMgdGhleSBhcmUgcmV0dXJuZWQgZnJvbSBzY29wZWRTbG90cyBub3cKICAgICAgICAgIGVsLmNoaWxkcmVuID0gW107CiAgICAgICAgICAvLyBtYXJrIGVsIG5vbi1wbGFpbiBzbyBkYXRhIGdldHMgZ2VuZXJhdGVkCiAgICAgICAgICBlbC5wbGFpbiA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0U2xvdE5hbWUgKGJpbmRpbmcpIHsKICAgIHZhciBuYW1lID0gYmluZGluZy5uYW1lLnJlcGxhY2Uoc2xvdFJFLCAnJyk7CiAgICBpZiAoIW5hbWUpIHsKICAgICAgaWYgKGJpbmRpbmcubmFtZVswXSAhPT0gJyMnKSB7CiAgICAgICAgbmFtZSA9ICdkZWZhdWx0JzsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuJDIoCiAgICAgICAgICAidi1zbG90IHNob3J0aGFuZCBzeW50YXggcmVxdWlyZXMgYSBzbG90IG5hbWUuIiwKICAgICAgICAgIGJpbmRpbmcKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZHluYW1pY0FyZ1JFLnRlc3QobmFtZSkKICAgICAgLy8gZHluYW1pYyBbbmFtZV0KICAgICAgPyB7IG5hbWU6IG5hbWUuc2xpY2UoMSwgLTEpLCBkeW5hbWljOiB0cnVlIH0KICAgICAgLy8gc3RhdGljIG5hbWUKICAgICAgOiB7IG5hbWU6ICgiXCIiICsgbmFtZSArICJcIiIpLCBkeW5hbWljOiBmYWxzZSB9CiAgfQoKICAvLyBoYW5kbGUgPHNsb3QvPiBvdXRsZXRzCiAgZnVuY3Rpb24gcHJvY2Vzc1Nsb3RPdXRsZXQgKGVsKSB7CiAgICBpZiAoZWwudGFnID09PSAnc2xvdCcpIHsKICAgICAgZWwuc2xvdE5hbWUgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ25hbWUnKTsKICAgICAgaWYgKGVsLmtleSkgewogICAgICAgIHdhcm4kMigKICAgICAgICAgICJga2V5YCBkb2VzIG5vdCB3b3JrIG9uIDxzbG90PiBiZWNhdXNlIHNsb3RzIGFyZSBhYnN0cmFjdCBvdXRsZXRzICIgKwogICAgICAgICAgImFuZCBjYW4gcG9zc2libHkgZXhwYW5kIGludG8gbXVsdGlwbGUgZWxlbWVudHMuICIgKwogICAgICAgICAgIlVzZSB0aGUga2V5IG9uIGEgd3JhcHBpbmcgZWxlbWVudCBpbnN0ZWFkLiIsCiAgICAgICAgICBnZXRSYXdCaW5kaW5nQXR0cihlbCwgJ2tleScpCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0NvbXBvbmVudCAoZWwpIHsKICAgIHZhciBiaW5kaW5nOwogICAgaWYgKChiaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICdpcycpKSkgewogICAgICBlbC5jb21wb25lbnQgPSBiaW5kaW5nOwogICAgfQogICAgaWYgKGdldEFuZFJlbW92ZUF0dHIoZWwsICdpbmxpbmUtdGVtcGxhdGUnKSAhPSBudWxsKSB7CiAgICAgIGVsLmlubGluZVRlbXBsYXRlID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NBdHRycyAoZWwpIHsKICAgIHZhciBsaXN0ID0gZWwuYXR0cnNMaXN0OwogICAgdmFyIGksIGwsIG5hbWUsIHJhd05hbWUsIHZhbHVlLCBtb2RpZmllcnMsIHN5bmNHZW4sIGlzRHluYW1pYzsKICAgIGZvciAoaSA9IDAsIGwgPSBsaXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBuYW1lID0gcmF3TmFtZSA9IGxpc3RbaV0ubmFtZTsKICAgICAgdmFsdWUgPSBsaXN0W2ldLnZhbHVlOwogICAgICBpZiAoZGlyUkUudGVzdChuYW1lKSkgewogICAgICAgIC8vIG1hcmsgZWxlbWVudCBhcyBkeW5hbWljCiAgICAgICAgZWwuaGFzQmluZGluZ3MgPSB0cnVlOwogICAgICAgIC8vIG1vZGlmaWVycwogICAgICAgIG1vZGlmaWVycyA9IHBhcnNlTW9kaWZpZXJzKG5hbWUucmVwbGFjZShkaXJSRSwgJycpKTsKICAgICAgICAvLyBzdXBwb3J0IC5mb28gc2hvcnRoYW5kIHN5bnRheCBmb3IgdGhlIC5wcm9wIG1vZGlmaWVyCiAgICAgICAgaWYgKG1vZGlmaWVycykgewogICAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZShtb2RpZmllclJFLCAnJyk7CiAgICAgICAgfQogICAgICAgIGlmIChiaW5kUkUudGVzdChuYW1lKSkgeyAvLyB2LWJpbmQKICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoYmluZFJFLCAnJyk7CiAgICAgICAgICB2YWx1ZSA9IHBhcnNlRmlsdGVycyh2YWx1ZSk7CiAgICAgICAgICBpc0R5bmFtaWMgPSBkeW5hbWljQXJnUkUudGVzdChuYW1lKTsKICAgICAgICAgIGlmIChpc0R5bmFtaWMpIHsKICAgICAgICAgICAgbmFtZSA9IG5hbWUuc2xpY2UoMSwgLTEpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKAogICAgICAgICAgICB2YWx1ZS50cmltKCkubGVuZ3RoID09PSAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgd2FybiQyKAogICAgICAgICAgICAgICgiVGhlIHZhbHVlIGZvciBhIHYtYmluZCBleHByZXNzaW9uIGNhbm5vdCBiZSBlbXB0eS4gRm91bmQgaW4gXCJ2LWJpbmQ6IiArIG5hbWUgKyAiXCIiKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1vZGlmaWVycykgewogICAgICAgICAgICBpZiAobW9kaWZpZXJzLnByb3AgJiYgIWlzRHluYW1pYykgewogICAgICAgICAgICAgIG5hbWUgPSBjYW1lbGl6ZShuYW1lKTsKICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2lubmVySHRtbCcpIHsgbmFtZSA9ICdpbm5lckhUTUwnOyB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1vZGlmaWVycy5jYW1lbCAmJiAhaXNEeW5hbWljKSB7CiAgICAgICAgICAgICAgbmFtZSA9IGNhbWVsaXplKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtb2RpZmllcnMuc3luYykgewogICAgICAgICAgICAgIHN5bmNHZW4gPSBnZW5Bc3NpZ25tZW50Q29kZSh2YWx1ZSwgIiRldmVudCIpOwogICAgICAgICAgICAgIGlmICghaXNEeW5hbWljKSB7CiAgICAgICAgICAgICAgICBhZGRIYW5kbGVyKAogICAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgICAgKCJ1cGRhdGU6IiArIChjYW1lbGl6ZShuYW1lKSkpLAogICAgICAgICAgICAgICAgICBzeW5jR2VuLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgd2FybiQyLAogICAgICAgICAgICAgICAgICBsaXN0W2ldCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKGh5cGhlbmF0ZShuYW1lKSAhPT0gY2FtZWxpemUobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgYWRkSGFuZGxlcigKICAgICAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgICAgICAoInVwZGF0ZToiICsgKGh5cGhlbmF0ZShuYW1lKSkpLAogICAgICAgICAgICAgICAgICAgIHN5bmNHZW4sCiAgICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB3YXJuJDIsCiAgICAgICAgICAgICAgICAgICAgbGlzdFtpXQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBoYW5kbGVyIHcvIGR5bmFtaWMgZXZlbnQgbmFtZQogICAgICAgICAgICAgICAgYWRkSGFuZGxlcigKICAgICAgICAgICAgICAgICAgZWwsCiAgICAgICAgICAgICAgICAgICgiXCJ1cGRhdGU6XCIrKCIgKyBuYW1lICsgIikiKSwKICAgICAgICAgICAgICAgICAgc3luY0dlbiwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIHdhcm4kMiwKICAgICAgICAgICAgICAgICAgbGlzdFtpXSwKICAgICAgICAgICAgICAgICAgdHJ1ZSAvLyBkeW5hbWljCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKChtb2RpZmllcnMgJiYgbW9kaWZpZXJzLnByb3ApIHx8ICgKICAgICAgICAgICAgIWVsLmNvbXBvbmVudCAmJiBwbGF0Zm9ybU11c3RVc2VQcm9wKGVsLnRhZywgZWwuYXR0cnNNYXAudHlwZSwgbmFtZSkKICAgICAgICAgICkpIHsKICAgICAgICAgICAgYWRkUHJvcChlbCwgbmFtZSwgdmFsdWUsIGxpc3RbaV0sIGlzRHluYW1pYyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhZGRBdHRyKGVsLCBuYW1lLCB2YWx1ZSwgbGlzdFtpXSwgaXNEeW5hbWljKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG9uUkUudGVzdChuYW1lKSkgeyAvLyB2LW9uCiAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKG9uUkUsICcnKTsKICAgICAgICAgIGlzRHluYW1pYyA9IGR5bmFtaWNBcmdSRS50ZXN0KG5hbWUpOwogICAgICAgICAgaWYgKGlzRHluYW1pYykgewogICAgICAgICAgICBuYW1lID0gbmFtZS5zbGljZSgxLCAtMSk7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRIYW5kbGVyKGVsLCBuYW1lLCB2YWx1ZSwgbW9kaWZpZXJzLCBmYWxzZSwgd2FybiQyLCBsaXN0W2ldLCBpc0R5bmFtaWMpOwogICAgICAgIH0gZWxzZSB7IC8vIG5vcm1hbCBkaXJlY3RpdmVzCiAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKGRpclJFLCAnJyk7CiAgICAgICAgICAvLyBwYXJzZSBhcmcKICAgICAgICAgIHZhciBhcmdNYXRjaCA9IG5hbWUubWF0Y2goYXJnUkUpOwogICAgICAgICAgdmFyIGFyZyA9IGFyZ01hdGNoICYmIGFyZ01hdGNoWzFdOwogICAgICAgICAgaXNEeW5hbWljID0gZmFsc2U7CiAgICAgICAgICBpZiAoYXJnKSB7CiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnNsaWNlKDAsIC0oYXJnLmxlbmd0aCArIDEpKTsKICAgICAgICAgICAgaWYgKGR5bmFtaWNBcmdSRS50ZXN0KGFyZykpIHsKICAgICAgICAgICAgICBhcmcgPSBhcmcuc2xpY2UoMSwgLTEpOwogICAgICAgICAgICAgIGlzRHluYW1pYyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGFkZERpcmVjdGl2ZShlbCwgbmFtZSwgcmF3TmFtZSwgdmFsdWUsIGFyZywgaXNEeW5hbWljLCBtb2RpZmllcnMsIGxpc3RbaV0pOwogICAgICAgICAgaWYgKG5hbWUgPT09ICdtb2RlbCcpIHsKICAgICAgICAgICAgY2hlY2tGb3JBbGlhc01vZGVsKGVsLCB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIGxpdGVyYWwgYXR0cmlidXRlCiAgICAgICAgewogICAgICAgICAgdmFyIHJlcyA9IHBhcnNlVGV4dCh2YWx1ZSwgZGVsaW1pdGVycyk7CiAgICAgICAgICBpZiAocmVzKSB7CiAgICAgICAgICAgIHdhcm4kMigKICAgICAgICAgICAgICBuYW1lICsgIj1cIiIgKyB2YWx1ZSArICJcIjogIiArCiAgICAgICAgICAgICAgJ0ludGVycG9sYXRpb24gaW5zaWRlIGF0dHJpYnV0ZXMgaGFzIGJlZW4gcmVtb3ZlZC4gJyArCiAgICAgICAgICAgICAgJ1VzZSB2LWJpbmQgb3IgdGhlIGNvbG9uIHNob3J0aGFuZCBpbnN0ZWFkLiBGb3IgZXhhbXBsZSwgJyArCiAgICAgICAgICAgICAgJ2luc3RlYWQgb2YgPGRpdiBpZD0ie3sgdmFsIH19Ij4sIHVzZSA8ZGl2IDppZD0idmFsIj4uJywKICAgICAgICAgICAgICBsaXN0W2ldCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGFkZEF0dHIoZWwsIG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSwgbGlzdFtpXSk7CiAgICAgICAgLy8gIzY4ODcgZmlyZWZveCBkb2Vzbid0IHVwZGF0ZSBtdXRlZCBzdGF0ZSBpZiBzZXQgdmlhIGF0dHJpYnV0ZQogICAgICAgIC8vIGV2ZW4gaW1tZWRpYXRlbHkgYWZ0ZXIgZWxlbWVudCBjcmVhdGlvbgogICAgICAgIGlmICghZWwuY29tcG9uZW50ICYmCiAgICAgICAgICAgIG5hbWUgPT09ICdtdXRlZCcgJiYKICAgICAgICAgICAgcGxhdGZvcm1NdXN0VXNlUHJvcChlbC50YWcsIGVsLmF0dHJzTWFwLnR5cGUsIG5hbWUpKSB7CiAgICAgICAgICBhZGRQcm9wKGVsLCBuYW1lLCAndHJ1ZScsIGxpc3RbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hlY2tJbkZvciAoZWwpIHsKICAgIHZhciBwYXJlbnQgPSBlbDsKICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgaWYgKHBhcmVudC5mb3IgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudDsKICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgZnVuY3Rpb24gcGFyc2VNb2RpZmllcnMgKG5hbWUpIHsKICAgIHZhciBtYXRjaCA9IG5hbWUubWF0Y2gobW9kaWZpZXJSRSk7CiAgICBpZiAobWF0Y2gpIHsKICAgICAgdmFyIHJldCA9IHt9OwogICAgICBtYXRjaC5mb3JFYWNoKGZ1bmN0aW9uIChtKSB7IHJldFttLnNsaWNlKDEpXSA9IHRydWU7IH0pOwogICAgICByZXR1cm4gcmV0CiAgICB9CiAgfQoKICBmdW5jdGlvbiBtYWtlQXR0cnNNYXAgKGF0dHJzKSB7CiAgICB2YXIgbWFwID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGF0dHJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBpZiAoCiAgICAgICAgbWFwW2F0dHJzW2ldLm5hbWVdICYmICFpc0lFICYmICFpc0VkZ2UKICAgICAgKSB7CiAgICAgICAgd2FybiQyKCdkdXBsaWNhdGUgYXR0cmlidXRlOiAnICsgYXR0cnNbaV0ubmFtZSwgYXR0cnNbaV0pOwogICAgICB9CiAgICAgIG1hcFthdHRyc1tpXS5uYW1lXSA9IGF0dHJzW2ldLnZhbHVlOwogICAgfQogICAgcmV0dXJuIG1hcAogIH0KCiAgLy8gZm9yIHNjcmlwdCAoZS5nLiB0eXBlPSJ4L3RlbXBsYXRlIikgb3Igc3R5bGUsIGRvIG5vdCBkZWNvZGUgY29udGVudAogIGZ1bmN0aW9uIGlzVGV4dFRhZyAoZWwpIHsKICAgIHJldHVybiBlbC50YWcgPT09ICdzY3JpcHQnIHx8IGVsLnRhZyA9PT0gJ3N0eWxlJwogIH0KCiAgZnVuY3Rpb24gaXNGb3JiaWRkZW5UYWcgKGVsKSB7CiAgICByZXR1cm4gKAogICAgICBlbC50YWcgPT09ICdzdHlsZScgfHwKICAgICAgKGVsLnRhZyA9PT0gJ3NjcmlwdCcgJiYgKAogICAgICAgICFlbC5hdHRyc01hcC50eXBlIHx8CiAgICAgICAgZWwuYXR0cnNNYXAudHlwZSA9PT0gJ3RleHQvamF2YXNjcmlwdCcKICAgICAgKSkKICAgICkKICB9CgogIHZhciBpZU5TQnVnID0gL154bWxuczpOU1xkKy87CiAgdmFyIGllTlNQcmVmaXggPSAvXk5TXGQrOi87CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgZnVuY3Rpb24gZ3VhcmRJRVNWR0J1ZyAoYXR0cnMpIHsKICAgIHZhciByZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0cnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGF0dHIgPSBhdHRyc1tpXTsKICAgICAgaWYgKCFpZU5TQnVnLnRlc3QoYXR0ci5uYW1lKSkgewogICAgICAgIGF0dHIubmFtZSA9IGF0dHIubmFtZS5yZXBsYWNlKGllTlNQcmVmaXgsICcnKTsKICAgICAgICByZXMucHVzaChhdHRyKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gY2hlY2tGb3JBbGlhc01vZGVsIChlbCwgdmFsdWUpIHsKICAgIHZhciBfZWwgPSBlbDsKICAgIHdoaWxlIChfZWwpIHsKICAgICAgaWYgKF9lbC5mb3IgJiYgX2VsLmFsaWFzID09PSB2YWx1ZSkgewogICAgICAgIHdhcm4kMigKICAgICAgICAgICI8IiArIChlbC50YWcpICsgIiB2LW1vZGVsPVwiIiArIHZhbHVlICsgIlwiPjogIiArCiAgICAgICAgICAiWW91IGFyZSBiaW5kaW5nIHYtbW9kZWwgZGlyZWN0bHkgdG8gYSB2LWZvciBpdGVyYXRpb24gYWxpYXMuICIgKwogICAgICAgICAgIlRoaXMgd2lsbCBub3QgYmUgYWJsZSB0byBtb2RpZnkgdGhlIHYtZm9yIHNvdXJjZSBhcnJheSBiZWNhdXNlICIgKwogICAgICAgICAgIndyaXRpbmcgdG8gdGhlIGFsaWFzIGlzIGxpa2UgbW9kaWZ5aW5nIGEgZnVuY3Rpb24gbG9jYWwgdmFyaWFibGUuICIgKwogICAgICAgICAgIkNvbnNpZGVyIHVzaW5nIGFuIGFycmF5IG9mIG9iamVjdHMgYW5kIHVzZSB2LW1vZGVsIG9uIGFuIG9iamVjdCBwcm9wZXJ0eSBpbnN0ZWFkLiIsCiAgICAgICAgICBlbC5yYXdBdHRyc01hcFsndi1tb2RlbCddCiAgICAgICAgKTsKICAgICAgfQogICAgICBfZWwgPSBfZWwucGFyZW50OwogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIHByZVRyYW5zZm9ybU5vZGUgKGVsLCBvcHRpb25zKSB7CiAgICBpZiAoZWwudGFnID09PSAnaW5wdXQnKSB7CiAgICAgIHZhciBtYXAgPSBlbC5hdHRyc01hcDsKICAgICAgaWYgKCFtYXBbJ3YtbW9kZWwnXSkgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB2YXIgdHlwZUJpbmRpbmc7CiAgICAgIGlmIChtYXBbJzp0eXBlJ10gfHwgbWFwWyd2LWJpbmQ6dHlwZSddKSB7CiAgICAgICAgdHlwZUJpbmRpbmcgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ3R5cGUnKTsKICAgICAgfQogICAgICBpZiAoIW1hcC50eXBlICYmICF0eXBlQmluZGluZyAmJiBtYXBbJ3YtYmluZCddKSB7CiAgICAgICAgdHlwZUJpbmRpbmcgPSAiKCIgKyAobWFwWyd2LWJpbmQnXSkgKyAiKS50eXBlIjsKICAgICAgfQoKICAgICAgaWYgKHR5cGVCaW5kaW5nKSB7CiAgICAgICAgdmFyIGlmQ29uZGl0aW9uID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtaWYnLCB0cnVlKTsKICAgICAgICB2YXIgaWZDb25kaXRpb25FeHRyYSA9IGlmQ29uZGl0aW9uID8gKCImJigiICsgaWZDb25kaXRpb24gKyAiKSIpIDogIiI7CiAgICAgICAgdmFyIGhhc0Vsc2UgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1lbHNlJywgdHJ1ZSkgIT0gbnVsbDsKICAgICAgICB2YXIgZWxzZUlmQ29uZGl0aW9uID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtZWxzZS1pZicsIHRydWUpOwogICAgICAgIC8vIDEuIGNoZWNrYm94CiAgICAgICAgdmFyIGJyYW5jaDAgPSBjbG9uZUFTVEVsZW1lbnQoZWwpOwogICAgICAgIC8vIHByb2Nlc3MgZm9yIG9uIHRoZSBtYWluIG5vZGUKICAgICAgICBwcm9jZXNzRm9yKGJyYW5jaDApOwogICAgICAgIGFkZFJhd0F0dHIoYnJhbmNoMCwgJ3R5cGUnLCAnY2hlY2tib3gnKTsKICAgICAgICBwcm9jZXNzRWxlbWVudChicmFuY2gwLCBvcHRpb25zKTsKICAgICAgICBicmFuY2gwLnByb2Nlc3NlZCA9IHRydWU7IC8vIHByZXZlbnQgaXQgZnJvbSBkb3VibGUtcHJvY2Vzc2VkCiAgICAgICAgYnJhbmNoMC5pZiA9ICIoIiArIHR5cGVCaW5kaW5nICsgIik9PT0nY2hlY2tib3gnIiArIGlmQ29uZGl0aW9uRXh0cmE7CiAgICAgICAgYWRkSWZDb25kaXRpb24oYnJhbmNoMCwgewogICAgICAgICAgZXhwOiBicmFuY2gwLmlmLAogICAgICAgICAgYmxvY2s6IGJyYW5jaDAKICAgICAgICB9KTsKICAgICAgICAvLyAyLiBhZGQgcmFkaW8gZWxzZS1pZiBjb25kaXRpb24KICAgICAgICB2YXIgYnJhbmNoMSA9IGNsb25lQVNURWxlbWVudChlbCk7CiAgICAgICAgZ2V0QW5kUmVtb3ZlQXR0cihicmFuY2gxLCAndi1mb3InLCB0cnVlKTsKICAgICAgICBhZGRSYXdBdHRyKGJyYW5jaDEsICd0eXBlJywgJ3JhZGlvJyk7CiAgICAgICAgcHJvY2Vzc0VsZW1lbnQoYnJhbmNoMSwgb3B0aW9ucyk7CiAgICAgICAgYWRkSWZDb25kaXRpb24oYnJhbmNoMCwgewogICAgICAgICAgZXhwOiAiKCIgKyB0eXBlQmluZGluZyArICIpPT09J3JhZGlvJyIgKyBpZkNvbmRpdGlvbkV4dHJhLAogICAgICAgICAgYmxvY2s6IGJyYW5jaDEKICAgICAgICB9KTsKICAgICAgICAvLyAzLiBvdGhlcgogICAgICAgIHZhciBicmFuY2gyID0gY2xvbmVBU1RFbGVtZW50KGVsKTsKICAgICAgICBnZXRBbmRSZW1vdmVBdHRyKGJyYW5jaDIsICd2LWZvcicsIHRydWUpOwogICAgICAgIGFkZFJhd0F0dHIoYnJhbmNoMiwgJzp0eXBlJywgdHlwZUJpbmRpbmcpOwogICAgICAgIHByb2Nlc3NFbGVtZW50KGJyYW5jaDIsIG9wdGlvbnMpOwogICAgICAgIGFkZElmQ29uZGl0aW9uKGJyYW5jaDAsIHsKICAgICAgICAgIGV4cDogaWZDb25kaXRpb24sCiAgICAgICAgICBibG9jazogYnJhbmNoMgogICAgICAgIH0pOwoKICAgICAgICBpZiAoaGFzRWxzZSkgewogICAgICAgICAgYnJhbmNoMC5lbHNlID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGVsc2VJZkNvbmRpdGlvbikgewogICAgICAgICAgYnJhbmNoMC5lbHNlaWYgPSBlbHNlSWZDb25kaXRpb247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYnJhbmNoMAogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbG9uZUFTVEVsZW1lbnQgKGVsKSB7CiAgICByZXR1cm4gY3JlYXRlQVNURWxlbWVudChlbC50YWcsIGVsLmF0dHJzTGlzdC5zbGljZSgpLCBlbC5wYXJlbnQpCiAgfQoKICB2YXIgbW9kZWwkMSA9IHsKICAgIHByZVRyYW5zZm9ybU5vZGU6IHByZVRyYW5zZm9ybU5vZGUKICB9OwoKICB2YXIgbW9kdWxlcyQxID0gWwogICAga2xhc3MkMSwKICAgIHN0eWxlJDEsCiAgICBtb2RlbCQxCiAgXTsKCiAgLyogICovCgogIGZ1bmN0aW9uIHRleHQgKGVsLCBkaXIpIHsKICAgIGlmIChkaXIudmFsdWUpIHsKICAgICAgYWRkUHJvcChlbCwgJ3RleHRDb250ZW50JywgKCJfcygiICsgKGRpci52YWx1ZSkgKyAiKSIpLCBkaXIpOwogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGh0bWwgKGVsLCBkaXIpIHsKICAgIGlmIChkaXIudmFsdWUpIHsKICAgICAgYWRkUHJvcChlbCwgJ2lubmVySFRNTCcsICgiX3MoIiArIChkaXIudmFsdWUpICsgIikiKSwgZGlyKTsKICAgIH0KICB9CgogIHZhciBkaXJlY3RpdmVzJDEgPSB7CiAgICBtb2RlbDogbW9kZWwsCiAgICB0ZXh0OiB0ZXh0LAogICAgaHRtbDogaHRtbAogIH07CgogIC8qICAqLwoKICB2YXIgYmFzZU9wdGlvbnMgPSB7CiAgICBleHBlY3RIVE1MOiB0cnVlLAogICAgbW9kdWxlczogbW9kdWxlcyQxLAogICAgZGlyZWN0aXZlczogZGlyZWN0aXZlcyQxLAogICAgaXNQcmVUYWc6IGlzUHJlVGFnLAogICAgaXNVbmFyeVRhZzogaXNVbmFyeVRhZywKICAgIG11c3RVc2VQcm9wOiBtdXN0VXNlUHJvcCwKICAgIGNhbkJlTGVmdE9wZW5UYWc6IGNhbkJlTGVmdE9wZW5UYWcsCiAgICBpc1Jlc2VydmVkVGFnOiBpc1Jlc2VydmVkVGFnLAogICAgZ2V0VGFnTmFtZXNwYWNlOiBnZXRUYWdOYW1lc3BhY2UsCiAgICBzdGF0aWNLZXlzOiBnZW5TdGF0aWNLZXlzKG1vZHVsZXMkMSkKICB9OwoKICAvKiAgKi8KCiAgdmFyIGlzU3RhdGljS2V5OwogIHZhciBpc1BsYXRmb3JtUmVzZXJ2ZWRUYWc7CgogIHZhciBnZW5TdGF0aWNLZXlzQ2FjaGVkID0gY2FjaGVkKGdlblN0YXRpY0tleXMkMSk7CgogIC8qKgogICAqIEdvYWwgb2YgdGhlIG9wdGltaXplcjogd2FsayB0aGUgZ2VuZXJhdGVkIHRlbXBsYXRlIEFTVCB0cmVlCiAgICogYW5kIGRldGVjdCBzdWItdHJlZXMgdGhhdCBhcmUgcHVyZWx5IHN0YXRpYywgaS5lLiBwYXJ0cyBvZgogICAqIHRoZSBET00gdGhhdCBuZXZlciBuZWVkcyB0byBjaGFuZ2UuCiAgICoKICAgKiBPbmNlIHdlIGRldGVjdCB0aGVzZSBzdWItdHJlZXMsIHdlIGNhbjoKICAgKgogICAqIDEuIEhvaXN0IHRoZW0gaW50byBjb25zdGFudHMsIHNvIHRoYXQgd2Ugbm8gbG9uZ2VyIG5lZWQgdG8KICAgKiAgICBjcmVhdGUgZnJlc2ggbm9kZXMgZm9yIHRoZW0gb24gZWFjaCByZS1yZW5kZXI7CiAgICogMi4gQ29tcGxldGVseSBza2lwIHRoZW0gaW4gdGhlIHBhdGNoaW5nIHByb2Nlc3MuCiAgICovCiAgZnVuY3Rpb24gb3B0aW1pemUgKHJvb3QsIG9wdGlvbnMpIHsKICAgIGlmICghcm9vdCkgeyByZXR1cm4gfQogICAgaXNTdGF0aWNLZXkgPSBnZW5TdGF0aWNLZXlzQ2FjaGVkKG9wdGlvbnMuc3RhdGljS2V5cyB8fCAnJyk7CiAgICBpc1BsYXRmb3JtUmVzZXJ2ZWRUYWcgPSBvcHRpb25zLmlzUmVzZXJ2ZWRUYWcgfHwgbm87CiAgICAvLyBmaXJzdCBwYXNzOiBtYXJrIGFsbCBub24tc3RhdGljIG5vZGVzLgogICAgbWFya1N0YXRpYyQxKHJvb3QpOwogICAgLy8gc2Vjb25kIHBhc3M6IG1hcmsgc3RhdGljIHJvb3RzLgogICAgbWFya1N0YXRpY1Jvb3RzKHJvb3QsIGZhbHNlKTsKICB9CgogIGZ1bmN0aW9uIGdlblN0YXRpY0tleXMkMSAoa2V5cykgewogICAgcmV0dXJuIG1ha2VNYXAoCiAgICAgICd0eXBlLHRhZyxhdHRyc0xpc3QsYXR0cnNNYXAscGxhaW4scGFyZW50LGNoaWxkcmVuLGF0dHJzLHN0YXJ0LGVuZCxyYXdBdHRyc01hcCcgKwogICAgICAoa2V5cyA/ICcsJyArIGtleXMgOiAnJykKICAgICkKICB9CgogIGZ1bmN0aW9uIG1hcmtTdGF0aWMkMSAobm9kZSkgewogICAgbm9kZS5zdGF0aWMgPSBpc1N0YXRpYyhub2RlKTsKICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgLy8gZG8gbm90IG1ha2UgY29tcG9uZW50IHNsb3QgY29udGVudCBzdGF0aWMuIHRoaXMgYXZvaWRzCiAgICAgIC8vIDEuIGNvbXBvbmVudHMgbm90IGFibGUgdG8gbXV0YXRlIHNsb3Qgbm9kZXMKICAgICAgLy8gMi4gc3RhdGljIHNsb3QgY29udGVudCBmYWlscyBmb3IgaG90LXJlbG9hZGluZwogICAgICBpZiAoCiAgICAgICAgIWlzUGxhdGZvcm1SZXNlcnZlZFRhZyhub2RlLnRhZykgJiYKICAgICAgICBub2RlLnRhZyAhPT0gJ3Nsb3QnICYmCiAgICAgICAgbm9kZS5hdHRyc01hcFsnaW5saW5lLXRlbXBsYXRlJ10gPT0gbnVsbAogICAgICApIHsKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTsKICAgICAgICBtYXJrU3RhdGljJDEoY2hpbGQpOwogICAgICAgIGlmICghY2hpbGQuc3RhdGljKSB7CiAgICAgICAgICBub2RlLnN0YXRpYyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9kZS5pZkNvbmRpdGlvbnMpIHsKICAgICAgICBmb3IgKHZhciBpJDEgPSAxLCBsJDEgPSBub2RlLmlmQ29uZGl0aW9ucy5sZW5ndGg7IGkkMSA8IGwkMTsgaSQxKyspIHsKICAgICAgICAgIHZhciBibG9jayA9IG5vZGUuaWZDb25kaXRpb25zW2kkMV0uYmxvY2s7CiAgICAgICAgICBtYXJrU3RhdGljJDEoYmxvY2spOwogICAgICAgICAgaWYgKCFibG9jay5zdGF0aWMpIHsKICAgICAgICAgICAgbm9kZS5zdGF0aWMgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIG1hcmtTdGF0aWNSb290cyAobm9kZSwgaXNJbkZvcikgewogICAgaWYgKG5vZGUudHlwZSA9PT0gMSkgewogICAgICBpZiAobm9kZS5zdGF0aWMgfHwgbm9kZS5vbmNlKSB7CiAgICAgICAgbm9kZS5zdGF0aWNJbkZvciA9IGlzSW5Gb3I7CiAgICAgIH0KICAgICAgLy8gRm9yIGEgbm9kZSB0byBxdWFsaWZ5IGFzIGEgc3RhdGljIHJvb3QsIGl0IHNob3VsZCBoYXZlIGNoaWxkcmVuIHRoYXQKICAgICAgLy8gYXJlIG5vdCBqdXN0IHN0YXRpYyB0ZXh0LiBPdGhlcndpc2UgdGhlIGNvc3Qgb2YgaG9pc3Rpbmcgb3V0IHdpbGwKICAgICAgLy8gb3V0d2VpZ2ggdGhlIGJlbmVmaXRzIGFuZCBpdCdzIGJldHRlciBvZmYgdG8ganVzdCBhbHdheXMgcmVuZGVyIGl0IGZyZXNoLgogICAgICBpZiAobm9kZS5zdGF0aWMgJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGggJiYgISgKICAgICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSAmJgogICAgICAgIG5vZGUuY2hpbGRyZW5bMF0udHlwZSA9PT0gMwogICAgICApKSB7CiAgICAgICAgbm9kZS5zdGF0aWNSb290ID0gdHJ1ZTsKICAgICAgICByZXR1cm4KICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlLnN0YXRpY1Jvb3QgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAobm9kZS5jaGlsZHJlbikgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIG1hcmtTdGF0aWNSb290cyhub2RlLmNoaWxkcmVuW2ldLCBpc0luRm9yIHx8ICEhbm9kZS5mb3IpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9kZS5pZkNvbmRpdGlvbnMpIHsKICAgICAgICBmb3IgKHZhciBpJDEgPSAxLCBsJDEgPSBub2RlLmlmQ29uZGl0aW9ucy5sZW5ndGg7IGkkMSA8IGwkMTsgaSQxKyspIHsKICAgICAgICAgIG1hcmtTdGF0aWNSb290cyhub2RlLmlmQ29uZGl0aW9uc1tpJDFdLmJsb2NrLCBpc0luRm9yKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzU3RhdGljIChub2RlKSB7CiAgICBpZiAobm9kZS50eXBlID09PSAyKSB7IC8vIGV4cHJlc3Npb24KICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICBpZiAobm9kZS50eXBlID09PSAzKSB7IC8vIHRleHQKICAgICAgcmV0dXJuIHRydWUKICAgIH0KICAgIHJldHVybiAhIShub2RlLnByZSB8fCAoCiAgICAgICFub2RlLmhhc0JpbmRpbmdzICYmIC8vIG5vIGR5bmFtaWMgYmluZGluZ3MKICAgICAgIW5vZGUuaWYgJiYgIW5vZGUuZm9yICYmIC8vIG5vdCB2LWlmIG9yIHYtZm9yIG9yIHYtZWxzZQogICAgICAhaXNCdWlsdEluVGFnKG5vZGUudGFnKSAmJiAvLyBub3QgYSBidWlsdC1pbgogICAgICBpc1BsYXRmb3JtUmVzZXJ2ZWRUYWcobm9kZS50YWcpICYmIC8vIG5vdCBhIGNvbXBvbmVudAogICAgICAhaXNEaXJlY3RDaGlsZE9mVGVtcGxhdGVGb3Iobm9kZSkgJiYKICAgICAgT2JqZWN0LmtleXMobm9kZSkuZXZlcnkoaXNTdGF0aWNLZXkpCiAgICApKQogIH0KCiAgZnVuY3Rpb24gaXNEaXJlY3RDaGlsZE9mVGVtcGxhdGVGb3IgKG5vZGUpIHsKICAgIHdoaWxlIChub2RlLnBhcmVudCkgewogICAgICBub2RlID0gbm9kZS5wYXJlbnQ7CiAgICAgIGlmIChub2RlLnRhZyAhPT0gJ3RlbXBsYXRlJykgewogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICAgIGlmIChub2RlLmZvcikgewogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgLyogICovCgogIHZhciBmbkV4cFJFID0gL14oW1x3JF9dK3xcKFteKV0qP1wpKVxzKj0+fF5mdW5jdGlvblxzKig/OltcdyRdKyk/XHMqXCgvOwogIHZhciBmbkludm9rZVJFID0gL1woW14pXSo/XCk7KiQvOwogIHZhciBzaW1wbGVQYXRoUkUgPSAvXltBLVphLXpfJF1bXHckXSooPzpcLltBLVphLXpfJF1bXHckXSp8XFsnW14nXSo/J118XFsiW14iXSo/Il18XFtcZCtdfFxbW0EtWmEtel8kXVtcdyRdKl0pKiQvOwoKICAvLyBLZXlib2FyZEV2ZW50LmtleUNvZGUgYWxpYXNlcwogIHZhciBrZXlDb2RlcyA9IHsKICAgIGVzYzogMjcsCiAgICB0YWI6IDksCiAgICBlbnRlcjogMTMsCiAgICBzcGFjZTogMzIsCiAgICB1cDogMzgsCiAgICBsZWZ0OiAzNywKICAgIHJpZ2h0OiAzOSwKICAgIGRvd246IDQwLAogICAgJ2RlbGV0ZSc6IFs4LCA0Nl0KICB9OwoKICAvLyBLZXlib2FyZEV2ZW50LmtleSBhbGlhc2VzCiAgdmFyIGtleU5hbWVzID0gewogICAgLy8gIzc4ODA6IElFMTEgYW5kIEVkZ2UgdXNlIGBFc2NgIGZvciBFc2NhcGUga2V5IG5hbWUuCiAgICBlc2M6IFsnRXNjJywgJ0VzY2FwZSddLAogICAgdGFiOiAnVGFiJywKICAgIGVudGVyOiAnRW50ZXInLAogICAgLy8gIzkxMTI6IElFMTEgdXNlcyBgU3BhY2ViYXJgIGZvciBTcGFjZSBrZXkgbmFtZS4KICAgIHNwYWNlOiBbJyAnLCAnU3BhY2ViYXInXSwKICAgIC8vICM3ODA2OiBJRTExIHVzZXMga2V5IG5hbWVzIHdpdGhvdXQgYEFycm93YCBwcmVmaXggZm9yIGFycm93IGtleXMuCiAgICB1cDogWydVcCcsICdBcnJvd1VwJ10sCiAgICBsZWZ0OiBbJ0xlZnQnLCAnQXJyb3dMZWZ0J10sCiAgICByaWdodDogWydSaWdodCcsICdBcnJvd1JpZ2h0J10sCiAgICBkb3duOiBbJ0Rvd24nLCAnQXJyb3dEb3duJ10sCiAgICAvLyAjOTExMjogSUUxMSB1c2VzIGBEZWxgIGZvciBEZWxldGUga2V5IG5hbWUuCiAgICAnZGVsZXRlJzogWydCYWNrc3BhY2UnLCAnRGVsZXRlJywgJ0RlbCddCiAgfTsKCiAgLy8gIzQ4Njg6IG1vZGlmaWVycyB0aGF0IHByZXZlbnQgdGhlIGV4ZWN1dGlvbiBvZiB0aGUgbGlzdGVuZXIKICAvLyBuZWVkIHRvIGV4cGxpY2l0bHkgcmV0dXJuIG51bGwgc28gdGhhdCB3ZSBjYW4gZGV0ZXJtaW5lIHdoZXRoZXIgdG8gcmVtb3ZlCiAgLy8gdGhlIGxpc3RlbmVyIGZvciAub25jZQogIHZhciBnZW5HdWFyZCA9IGZ1bmN0aW9uIChjb25kaXRpb24pIHsgcmV0dXJuICgiaWYoIiArIGNvbmRpdGlvbiArICIpcmV0dXJuIG51bGw7Iik7IH07CgogIHZhciBtb2RpZmllckNvZGUgPSB7CiAgICBzdG9wOiAnJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOycsCiAgICBwcmV2ZW50OiAnJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7JywKICAgIHNlbGY6IGdlbkd1YXJkKCIkZXZlbnQudGFyZ2V0ICE9PSAkZXZlbnQuY3VycmVudFRhcmdldCIpLAogICAgY3RybDogZ2VuR3VhcmQoIiEkZXZlbnQuY3RybEtleSIpLAogICAgc2hpZnQ6IGdlbkd1YXJkKCIhJGV2ZW50LnNoaWZ0S2V5IiksCiAgICBhbHQ6IGdlbkd1YXJkKCIhJGV2ZW50LmFsdEtleSIpLAogICAgbWV0YTogZ2VuR3VhcmQoIiEkZXZlbnQubWV0YUtleSIpLAogICAgbGVmdDogZ2VuR3VhcmQoIididXR0b24nIGluICRldmVudCAmJiAkZXZlbnQuYnV0dG9uICE9PSAwIiksCiAgICBtaWRkbGU6IGdlbkd1YXJkKCInYnV0dG9uJyBpbiAkZXZlbnQgJiYgJGV2ZW50LmJ1dHRvbiAhPT0gMSIpLAogICAgcmlnaHQ6IGdlbkd1YXJkKCInYnV0dG9uJyBpbiAkZXZlbnQgJiYgJGV2ZW50LmJ1dHRvbiAhPT0gMiIpCiAgfTsKCiAgZnVuY3Rpb24gZ2VuSGFuZGxlcnMgKAogICAgZXZlbnRzLAogICAgaXNOYXRpdmUKICApIHsKICAgIHZhciBwcmVmaXggPSBpc05hdGl2ZSA/ICduYXRpdmVPbjonIDogJ29uOic7CiAgICB2YXIgc3RhdGljSGFuZGxlcnMgPSAiIjsKICAgIHZhciBkeW5hbWljSGFuZGxlcnMgPSAiIjsKICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnRzKSB7CiAgICAgIHZhciBoYW5kbGVyQ29kZSA9IGdlbkhhbmRsZXIoZXZlbnRzW25hbWVdKTsKICAgICAgaWYgKGV2ZW50c1tuYW1lXSAmJiBldmVudHNbbmFtZV0uZHluYW1pYykgewogICAgICAgIGR5bmFtaWNIYW5kbGVycyArPSBuYW1lICsgIiwiICsgaGFuZGxlckNvZGUgKyAiLCI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGljSGFuZGxlcnMgKz0gIlwiIiArIG5hbWUgKyAiXCI6IiArIGhhbmRsZXJDb2RlICsgIiwiOwogICAgICB9CiAgICB9CiAgICBzdGF0aWNIYW5kbGVycyA9ICJ7IiArIChzdGF0aWNIYW5kbGVycy5zbGljZSgwLCAtMSkpICsgIn0iOwogICAgaWYgKGR5bmFtaWNIYW5kbGVycykgewogICAgICByZXR1cm4gcHJlZml4ICsgIl9kKCIgKyBzdGF0aWNIYW5kbGVycyArICIsWyIgKyAoZHluYW1pY0hhbmRsZXJzLnNsaWNlKDAsIC0xKSkgKyAiXSkiCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcHJlZml4ICsgc3RhdGljSGFuZGxlcnMKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlbkhhbmRsZXIgKGhhbmRsZXIpIHsKICAgIGlmICghaGFuZGxlcikgewogICAgICByZXR1cm4gJ2Z1bmN0aW9uKCl7fScKICAgIH0KCiAgICBpZiAoQXJyYXkuaXNBcnJheShoYW5kbGVyKSkgewogICAgICByZXR1cm4gKCJbIiArIChoYW5kbGVyLm1hcChmdW5jdGlvbiAoaGFuZGxlcikgeyByZXR1cm4gZ2VuSGFuZGxlcihoYW5kbGVyKTsgfSkuam9pbignLCcpKSArICJdIikKICAgIH0KCiAgICB2YXIgaXNNZXRob2RQYXRoID0gc2ltcGxlUGF0aFJFLnRlc3QoaGFuZGxlci52YWx1ZSk7CiAgICB2YXIgaXNGdW5jdGlvbkV4cHJlc3Npb24gPSBmbkV4cFJFLnRlc3QoaGFuZGxlci52YWx1ZSk7CiAgICB2YXIgaXNGdW5jdGlvbkludm9jYXRpb24gPSBzaW1wbGVQYXRoUkUudGVzdChoYW5kbGVyLnZhbHVlLnJlcGxhY2UoZm5JbnZva2VSRSwgJycpKTsKCiAgICBpZiAoIWhhbmRsZXIubW9kaWZpZXJzKSB7CiAgICAgIGlmIChpc01ldGhvZFBhdGggfHwgaXNGdW5jdGlvbkV4cHJlc3Npb24pIHsKICAgICAgICByZXR1cm4gaGFuZGxlci52YWx1ZQogICAgICB9CiAgICAgIHJldHVybiAoImZ1bmN0aW9uKCRldmVudCl7IiArIChpc0Z1bmN0aW9uSW52b2NhdGlvbiA/ICgicmV0dXJuICIgKyAoaGFuZGxlci52YWx1ZSkpIDogaGFuZGxlci52YWx1ZSkgKyAifSIpIC8vIGlubGluZSBzdGF0ZW1lbnQKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjb2RlID0gJyc7CiAgICAgIHZhciBnZW5Nb2RpZmllckNvZGUgPSAnJzsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgZm9yICh2YXIga2V5IGluIGhhbmRsZXIubW9kaWZpZXJzKSB7CiAgICAgICAgaWYgKG1vZGlmaWVyQ29kZVtrZXldKSB7CiAgICAgICAgICBnZW5Nb2RpZmllckNvZGUgKz0gbW9kaWZpZXJDb2RlW2tleV07CiAgICAgICAgICAvLyBsZWZ0L3JpZ2h0CiAgICAgICAgICBpZiAoa2V5Q29kZXNba2V5XSkgewogICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2V4YWN0JykgewogICAgICAgICAgdmFyIG1vZGlmaWVycyA9IChoYW5kbGVyLm1vZGlmaWVycyk7CiAgICAgICAgICBnZW5Nb2RpZmllckNvZGUgKz0gZ2VuR3VhcmQoCiAgICAgICAgICAgIFsnY3RybCcsICdzaGlmdCcsICdhbHQnLCAnbWV0YSddCiAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoa2V5TW9kaWZpZXIpIHsgcmV0dXJuICFtb2RpZmllcnNba2V5TW9kaWZpZXJdOyB9KQogICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGtleU1vZGlmaWVyKSB7IHJldHVybiAoIiRldmVudC4iICsga2V5TW9kaWZpZXIgKyAiS2V5Iik7IH0pCiAgICAgICAgICAgICAgLmpvaW4oJ3x8JykKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoa2V5cy5sZW5ndGgpIHsKICAgICAgICBjb2RlICs9IGdlbktleUZpbHRlcihrZXlzKTsKICAgICAgfQogICAgICAvLyBNYWtlIHN1cmUgbW9kaWZpZXJzIGxpa2UgcHJldmVudCBhbmQgc3RvcCBnZXQgZXhlY3V0ZWQgYWZ0ZXIga2V5IGZpbHRlcmluZwogICAgICBpZiAoZ2VuTW9kaWZpZXJDb2RlKSB7CiAgICAgICAgY29kZSArPSBnZW5Nb2RpZmllckNvZGU7CiAgICAgIH0KICAgICAgdmFyIGhhbmRsZXJDb2RlID0gaXNNZXRob2RQYXRoCiAgICAgICAgPyAoInJldHVybiAiICsgKGhhbmRsZXIudmFsdWUpICsgIigkZXZlbnQpIikKICAgICAgICA6IGlzRnVuY3Rpb25FeHByZXNzaW9uCiAgICAgICAgICA/ICgicmV0dXJuICgiICsgKGhhbmRsZXIudmFsdWUpICsgIikoJGV2ZW50KSIpCiAgICAgICAgICA6IGlzRnVuY3Rpb25JbnZvY2F0aW9uCiAgICAgICAgICAgID8gKCJyZXR1cm4gIiArIChoYW5kbGVyLnZhbHVlKSkKICAgICAgICAgICAgOiBoYW5kbGVyLnZhbHVlOwogICAgICByZXR1cm4gKCJmdW5jdGlvbigkZXZlbnQpeyIgKyBjb2RlICsgaGFuZGxlckNvZGUgKyAifSIpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5LZXlGaWx0ZXIgKGtleXMpIHsKICAgIHJldHVybiAoCiAgICAgIC8vIG1ha2Ugc3VyZSB0aGUga2V5IGZpbHRlcnMgb25seSBhcHBseSB0byBLZXlib2FyZEV2ZW50cwogICAgICAvLyAjOTQ0MTogY2FuJ3QgdXNlICdrZXlDb2RlJyBpbiAkZXZlbnQgYmVjYXVzZSBDaHJvbWUgYXV0b2ZpbGwgZmlyZXMgZmFrZQogICAgICAvLyBrZXkgZXZlbnRzIHRoYXQgZG8gbm90IGhhdmUga2V5Q29kZSBwcm9wZXJ0eS4uLgogICAgICAiaWYoISRldmVudC50eXBlLmluZGV4T2YoJ2tleScpJiYiICsKICAgICAgKGtleXMubWFwKGdlbkZpbHRlckNvZGUpLmpvaW4oJyYmJykpICsgIilyZXR1cm4gbnVsbDsiCiAgICApCiAgfQoKICBmdW5jdGlvbiBnZW5GaWx0ZXJDb2RlIChrZXkpIHsKICAgIHZhciBrZXlWYWwgPSBwYXJzZUludChrZXksIDEwKTsKICAgIGlmIChrZXlWYWwpIHsKICAgICAgcmV0dXJuICgiJGV2ZW50LmtleUNvZGUhPT0iICsga2V5VmFsKQogICAgfQogICAgdmFyIGtleUNvZGUgPSBrZXlDb2Rlc1trZXldOwogICAgdmFyIGtleU5hbWUgPSBrZXlOYW1lc1trZXldOwogICAgcmV0dXJuICgKICAgICAgIl9rKCRldmVudC5rZXlDb2RlLCIgKwogICAgICAoSlNPTi5zdHJpbmdpZnkoa2V5KSkgKyAiLCIgKwogICAgICAoSlNPTi5zdHJpbmdpZnkoa2V5Q29kZSkpICsgIiwiICsKICAgICAgIiRldmVudC5rZXksIiArCiAgICAgICIiICsgKEpTT04uc3RyaW5naWZ5KGtleU5hbWUpKSArCiAgICAgICIpIgogICAgKQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIG9uIChlbCwgZGlyKSB7CiAgICBpZiAoZGlyLm1vZGlmaWVycykgewogICAgICB3YXJuKCJ2LW9uIHdpdGhvdXQgYXJndW1lbnQgZG9lcyBub3Qgc3VwcG9ydCBtb2RpZmllcnMuIik7CiAgICB9CiAgICBlbC53cmFwTGlzdGVuZXJzID0gZnVuY3Rpb24gKGNvZGUpIHsgcmV0dXJuICgiX2coIiArIGNvZGUgKyAiLCIgKyAoZGlyLnZhbHVlKSArICIpIik7IH07CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gYmluZCQxIChlbCwgZGlyKSB7CiAgICBlbC53cmFwRGF0YSA9IGZ1bmN0aW9uIChjb2RlKSB7CiAgICAgIHJldHVybiAoIl9iKCIgKyBjb2RlICsgIiwnIiArIChlbC50YWcpICsgIicsIiArIChkaXIudmFsdWUpICsgIiwiICsgKGRpci5tb2RpZmllcnMgJiYgZGlyLm1vZGlmaWVycy5wcm9wID8gJ3RydWUnIDogJ2ZhbHNlJykgKyAoZGlyLm1vZGlmaWVycyAmJiBkaXIubW9kaWZpZXJzLnN5bmMgPyAnLHRydWUnIDogJycpICsgIikiKQogICAgfTsKICB9CgogIC8qICAqLwoKICB2YXIgYmFzZURpcmVjdGl2ZXMgPSB7CiAgICBvbjogb24sCiAgICBiaW5kOiBiaW5kJDEsCiAgICBjbG9hazogbm9vcAogIH07CgogIC8qICAqLwoKCgoKCiAgdmFyIENvZGVnZW5TdGF0ZSA9IGZ1bmN0aW9uIENvZGVnZW5TdGF0ZSAob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMud2FybiA9IG9wdGlvbnMud2FybiB8fCBiYXNlV2FybjsKICAgIHRoaXMudHJhbnNmb3JtcyA9IHBsdWNrTW9kdWxlRnVuY3Rpb24ob3B0aW9ucy5tb2R1bGVzLCAndHJhbnNmb3JtQ29kZScpOwogICAgdGhpcy5kYXRhR2VuRm5zID0gcGx1Y2tNb2R1bGVGdW5jdGlvbihvcHRpb25zLm1vZHVsZXMsICdnZW5EYXRhJyk7CiAgICB0aGlzLmRpcmVjdGl2ZXMgPSBleHRlbmQoZXh0ZW5kKHt9LCBiYXNlRGlyZWN0aXZlcyksIG9wdGlvbnMuZGlyZWN0aXZlcyk7CiAgICB2YXIgaXNSZXNlcnZlZFRhZyA9IG9wdGlvbnMuaXNSZXNlcnZlZFRhZyB8fCBubzsKICAgIHRoaXMubWF5YmVDb21wb25lbnQgPSBmdW5jdGlvbiAoZWwpIHsgcmV0dXJuICEhZWwuY29tcG9uZW50IHx8ICFpc1Jlc2VydmVkVGFnKGVsLnRhZyk7IH07CiAgICB0aGlzLm9uY2VJZCA9IDA7CiAgICB0aGlzLnN0YXRpY1JlbmRlckZucyA9IFtdOwogICAgdGhpcy5wcmUgPSBmYWxzZTsKICB9OwoKCgogIGZ1bmN0aW9uIGdlbmVyYXRlICgKICAgIGFzdCwKICAgIG9wdGlvbnMKICApIHsKICAgIHZhciBzdGF0ZSA9IG5ldyBDb2RlZ2VuU3RhdGUob3B0aW9ucyk7CiAgICB2YXIgY29kZSA9IGFzdCA/IGdlbkVsZW1lbnQoYXN0LCBzdGF0ZSkgOiAnX2MoImRpdiIpJzsKICAgIHJldHVybiB7CiAgICAgIHJlbmRlcjogKCJ3aXRoKHRoaXMpe3JldHVybiAiICsgY29kZSArICJ9IiksCiAgICAgIHN0YXRpY1JlbmRlckZuczogc3RhdGUuc3RhdGljUmVuZGVyRm5zCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5FbGVtZW50IChlbCwgc3RhdGUpIHsKICAgIGlmIChlbC5wYXJlbnQpIHsKICAgICAgZWwucHJlID0gZWwucHJlIHx8IGVsLnBhcmVudC5wcmU7CiAgICB9CgogICAgaWYgKGVsLnN0YXRpY1Jvb3QgJiYgIWVsLnN0YXRpY1Byb2Nlc3NlZCkgewogICAgICByZXR1cm4gZ2VuU3RhdGljKGVsLCBzdGF0ZSkKICAgIH0gZWxzZSBpZiAoZWwub25jZSAmJiAhZWwub25jZVByb2Nlc3NlZCkgewogICAgICByZXR1cm4gZ2VuT25jZShlbCwgc3RhdGUpCiAgICB9IGVsc2UgaWYgKGVsLmZvciAmJiAhZWwuZm9yUHJvY2Vzc2VkKSB7CiAgICAgIHJldHVybiBnZW5Gb3IoZWwsIHN0YXRlKQogICAgfSBlbHNlIGlmIChlbC5pZiAmJiAhZWwuaWZQcm9jZXNzZWQpIHsKICAgICAgcmV0dXJuIGdlbklmKGVsLCBzdGF0ZSkKICAgIH0gZWxzZSBpZiAoZWwudGFnID09PSAndGVtcGxhdGUnICYmICFlbC5zbG90VGFyZ2V0ICYmICFzdGF0ZS5wcmUpIHsKICAgICAgcmV0dXJuIGdlbkNoaWxkcmVuKGVsLCBzdGF0ZSkgfHwgJ3ZvaWQgMCcKICAgIH0gZWxzZSBpZiAoZWwudGFnID09PSAnc2xvdCcpIHsKICAgICAgcmV0dXJuIGdlblNsb3QoZWwsIHN0YXRlKQogICAgfSBlbHNlIHsKICAgICAgLy8gY29tcG9uZW50IG9yIGVsZW1lbnQKICAgICAgdmFyIGNvZGU7CiAgICAgIGlmIChlbC5jb21wb25lbnQpIHsKICAgICAgICBjb2RlID0gZ2VuQ29tcG9uZW50KGVsLmNvbXBvbmVudCwgZWwsIHN0YXRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZGF0YTsKICAgICAgICBpZiAoIWVsLnBsYWluIHx8IChlbC5wcmUgJiYgc3RhdGUubWF5YmVDb21wb25lbnQoZWwpKSkgewogICAgICAgICAgZGF0YSA9IGdlbkRhdGEkMihlbCwgc3RhdGUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNoaWxkcmVuID0gZWwuaW5saW5lVGVtcGxhdGUgPyBudWxsIDogZ2VuQ2hpbGRyZW4oZWwsIHN0YXRlLCB0cnVlKTsKICAgICAgICBjb2RlID0gIl9jKCciICsgKGVsLnRhZykgKyAiJyIgKyAoZGF0YSA/ICgiLCIgKyBkYXRhKSA6ICcnKSArIChjaGlsZHJlbiA/ICgiLCIgKyBjaGlsZHJlbikgOiAnJykgKyAiKSI7CiAgICAgIH0KICAgICAgLy8gbW9kdWxlIHRyYW5zZm9ybXMKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZS50cmFuc2Zvcm1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29kZSA9IHN0YXRlLnRyYW5zZm9ybXNbaV0oZWwsIGNvZGUpOwogICAgICB9CiAgICAgIHJldHVybiBjb2RlCiAgICB9CiAgfQoKICAvLyBob2lzdCBzdGF0aWMgc3ViLXRyZWVzIG91dAogIGZ1bmN0aW9uIGdlblN0YXRpYyAoZWwsIHN0YXRlKSB7CiAgICBlbC5zdGF0aWNQcm9jZXNzZWQgPSB0cnVlOwogICAgLy8gU29tZSBlbGVtZW50cyAodGVtcGxhdGVzKSBuZWVkIHRvIGJlaGF2ZSBkaWZmZXJlbnRseSBpbnNpZGUgb2YgYSB2LXByZQogICAgLy8gbm9kZS4gIEFsbCBwcmUgbm9kZXMgYXJlIHN0YXRpYyByb290cywgc28gd2UgY2FuIHVzZSB0aGlzIGFzIGEgbG9jYXRpb24gdG8KICAgIC8vIHdyYXAgYSBzdGF0ZSBjaGFuZ2UgYW5kIHJlc2V0IGl0IHVwb24gZXhpdGluZyB0aGUgcHJlIG5vZGUuCiAgICB2YXIgb3JpZ2luYWxQcmVTdGF0ZSA9IHN0YXRlLnByZTsKICAgIGlmIChlbC5wcmUpIHsKICAgICAgc3RhdGUucHJlID0gZWwucHJlOwogICAgfQogICAgc3RhdGUuc3RhdGljUmVuZGVyRm5zLnB1c2goKCJ3aXRoKHRoaXMpe3JldHVybiAiICsgKGdlbkVsZW1lbnQoZWwsIHN0YXRlKSkgKyAifSIpKTsKICAgIHN0YXRlLnByZSA9IG9yaWdpbmFsUHJlU3RhdGU7CiAgICByZXR1cm4gKCJfbSgiICsgKHN0YXRlLnN0YXRpY1JlbmRlckZucy5sZW5ndGggLSAxKSArIChlbC5zdGF0aWNJbkZvciA/ICcsdHJ1ZScgOiAnJykgKyAiKSIpCiAgfQoKICAvLyB2LW9uY2UKICBmdW5jdGlvbiBnZW5PbmNlIChlbCwgc3RhdGUpIHsKICAgIGVsLm9uY2VQcm9jZXNzZWQgPSB0cnVlOwogICAgaWYgKGVsLmlmICYmICFlbC5pZlByb2Nlc3NlZCkgewogICAgICByZXR1cm4gZ2VuSWYoZWwsIHN0YXRlKQogICAgfSBlbHNlIGlmIChlbC5zdGF0aWNJbkZvcikgewogICAgICB2YXIga2V5ID0gJyc7CiAgICAgIHZhciBwYXJlbnQgPSBlbC5wYXJlbnQ7CiAgICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgICBpZiAocGFyZW50LmZvcikgewogICAgICAgICAga2V5ID0gcGFyZW50LmtleTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgIH0KICAgICAgaWYgKCFrZXkpIHsKICAgICAgICBzdGF0ZS53YXJuKAogICAgICAgICAgInYtb25jZSBjYW4gb25seSBiZSB1c2VkIGluc2lkZSB2LWZvciB0aGF0IGlzIGtleWVkLiAiLAogICAgICAgICAgZWwucmF3QXR0cnNNYXBbJ3Ytb25jZSddCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gZ2VuRWxlbWVudChlbCwgc3RhdGUpCiAgICAgIH0KICAgICAgcmV0dXJuICgiX28oIiArIChnZW5FbGVtZW50KGVsLCBzdGF0ZSkpICsgIiwiICsgKHN0YXRlLm9uY2VJZCsrKSArICIsIiArIGtleSArICIpIikKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZW5TdGF0aWMoZWwsIHN0YXRlKQogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2VuSWYgKAogICAgZWwsCiAgICBzdGF0ZSwKICAgIGFsdEdlbiwKICAgIGFsdEVtcHR5CiAgKSB7CiAgICBlbC5pZlByb2Nlc3NlZCA9IHRydWU7IC8vIGF2b2lkIHJlY3Vyc2lvbgogICAgcmV0dXJuIGdlbklmQ29uZGl0aW9ucyhlbC5pZkNvbmRpdGlvbnMuc2xpY2UoKSwgc3RhdGUsIGFsdEdlbiwgYWx0RW1wdHkpCiAgfQoKICBmdW5jdGlvbiBnZW5JZkNvbmRpdGlvbnMgKAogICAgY29uZGl0aW9ucywKICAgIHN0YXRlLAogICAgYWx0R2VuLAogICAgYWx0RW1wdHkKICApIHsKICAgIGlmICghY29uZGl0aW9ucy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGFsdEVtcHR5IHx8ICdfZSgpJwogICAgfQoKICAgIHZhciBjb25kaXRpb24gPSBjb25kaXRpb25zLnNoaWZ0KCk7CiAgICBpZiAoY29uZGl0aW9uLmV4cCkgewogICAgICByZXR1cm4gKCIoIiArIChjb25kaXRpb24uZXhwKSArICIpPyIgKyAoZ2VuVGVybmFyeUV4cChjb25kaXRpb24uYmxvY2spKSArICI6IiArIChnZW5JZkNvbmRpdGlvbnMoY29uZGl0aW9ucywgc3RhdGUsIGFsdEdlbiwgYWx0RW1wdHkpKSkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAoIiIgKyAoZ2VuVGVybmFyeUV4cChjb25kaXRpb24uYmxvY2spKSkKICAgIH0KCiAgICAvLyB2LWlmIHdpdGggdi1vbmNlIHNob3VsZCBnZW5lcmF0ZSBjb2RlIGxpa2UgKGEpP19tKDApOl9tKDEpCiAgICBmdW5jdGlvbiBnZW5UZXJuYXJ5RXhwIChlbCkgewogICAgICByZXR1cm4gYWx0R2VuCiAgICAgICAgPyBhbHRHZW4oZWwsIHN0YXRlKQogICAgICAgIDogZWwub25jZQogICAgICAgICAgPyBnZW5PbmNlKGVsLCBzdGF0ZSkKICAgICAgICAgIDogZ2VuRWxlbWVudChlbCwgc3RhdGUpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5Gb3IgKAogICAgZWwsCiAgICBzdGF0ZSwKICAgIGFsdEdlbiwKICAgIGFsdEhlbHBlcgogICkgewogICAgdmFyIGV4cCA9IGVsLmZvcjsKICAgIHZhciBhbGlhcyA9IGVsLmFsaWFzOwogICAgdmFyIGl0ZXJhdG9yMSA9IGVsLml0ZXJhdG9yMSA/ICgiLCIgKyAoZWwuaXRlcmF0b3IxKSkgOiAnJzsKICAgIHZhciBpdGVyYXRvcjIgPSBlbC5pdGVyYXRvcjIgPyAoIiwiICsgKGVsLml0ZXJhdG9yMikpIDogJyc7CgogICAgaWYgKHN0YXRlLm1heWJlQ29tcG9uZW50KGVsKSAmJgogICAgICBlbC50YWcgIT09ICdzbG90JyAmJgogICAgICBlbC50YWcgIT09ICd0ZW1wbGF0ZScgJiYKICAgICAgIWVsLmtleQogICAgKSB7CiAgICAgIHN0YXRlLndhcm4oCiAgICAgICAgIjwiICsgKGVsLnRhZykgKyAiIHYtZm9yPVwiIiArIGFsaWFzICsgIiBpbiAiICsgZXhwICsgIlwiPjogY29tcG9uZW50IGxpc3RzIHJlbmRlcmVkIHdpdGggIiArCiAgICAgICAgInYtZm9yIHNob3VsZCBoYXZlIGV4cGxpY2l0IGtleXMuICIgKwogICAgICAgICJTZWUgaHR0cHM6Ly92dWVqcy5vcmcvZ3VpZGUvbGlzdC5odG1sI2tleSBmb3IgbW9yZSBpbmZvLiIsCiAgICAgICAgZWwucmF3QXR0cnNNYXBbJ3YtZm9yJ10sCiAgICAgICAgdHJ1ZSAvKiB0aXAgKi8KICAgICAgKTsKICAgIH0KCiAgICBlbC5mb3JQcm9jZXNzZWQgPSB0cnVlOyAvLyBhdm9pZCByZWN1cnNpb24KICAgIHJldHVybiAoYWx0SGVscGVyIHx8ICdfbCcpICsgIigoIiArIGV4cCArICIpLCIgKwogICAgICAiZnVuY3Rpb24oIiArIGFsaWFzICsgaXRlcmF0b3IxICsgaXRlcmF0b3IyICsgIil7IiArCiAgICAgICAgInJldHVybiAiICsgKChhbHRHZW4gfHwgZ2VuRWxlbWVudCkoZWwsIHN0YXRlKSkgKwogICAgICAnfSknCiAgfQoKICBmdW5jdGlvbiBnZW5EYXRhJDIgKGVsLCBzdGF0ZSkgewogICAgdmFyIGRhdGEgPSAneyc7CgogICAgLy8gZGlyZWN0aXZlcyBmaXJzdC4KICAgIC8vIGRpcmVjdGl2ZXMgbWF5IG11dGF0ZSB0aGUgZWwncyBvdGhlciBwcm9wZXJ0aWVzIGJlZm9yZSB0aGV5IGFyZSBnZW5lcmF0ZWQuCiAgICB2YXIgZGlycyA9IGdlbkRpcmVjdGl2ZXMoZWwsIHN0YXRlKTsKICAgIGlmIChkaXJzKSB7IGRhdGEgKz0gZGlycyArICcsJzsgfQoKICAgIC8vIGtleQogICAgaWYgKGVsLmtleSkgewogICAgICBkYXRhICs9ICJrZXk6IiArIChlbC5rZXkpICsgIiwiOwogICAgfQogICAgLy8gcmVmCiAgICBpZiAoZWwucmVmKSB7CiAgICAgIGRhdGEgKz0gInJlZjoiICsgKGVsLnJlZikgKyAiLCI7CiAgICB9CiAgICBpZiAoZWwucmVmSW5Gb3IpIHsKICAgICAgZGF0YSArPSAicmVmSW5Gb3I6dHJ1ZSwiOwogICAgfQogICAgLy8gcHJlCiAgICBpZiAoZWwucHJlKSB7CiAgICAgIGRhdGEgKz0gInByZTp0cnVlLCI7CiAgICB9CiAgICAvLyByZWNvcmQgb3JpZ2luYWwgdGFnIG5hbWUgZm9yIGNvbXBvbmVudHMgdXNpbmcgImlzIiBhdHRyaWJ1dGUKICAgIGlmIChlbC5jb21wb25lbnQpIHsKICAgICAgZGF0YSArPSAidGFnOlwiIiArIChlbC50YWcpICsgIlwiLCI7CiAgICB9CiAgICAvLyBtb2R1bGUgZGF0YSBnZW5lcmF0aW9uIGZ1bmN0aW9ucwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZS5kYXRhR2VuRm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGRhdGEgKz0gc3RhdGUuZGF0YUdlbkZuc1tpXShlbCk7CiAgICB9CiAgICAvLyBhdHRyaWJ1dGVzCiAgICBpZiAoZWwuYXR0cnMpIHsKICAgICAgZGF0YSArPSAiYXR0cnM6IiArIChnZW5Qcm9wcyhlbC5hdHRycykpICsgIiwiOwogICAgfQogICAgLy8gRE9NIHByb3BzCiAgICBpZiAoZWwucHJvcHMpIHsKICAgICAgZGF0YSArPSAiZG9tUHJvcHM6IiArIChnZW5Qcm9wcyhlbC5wcm9wcykpICsgIiwiOwogICAgfQogICAgLy8gZXZlbnQgaGFuZGxlcnMKICAgIGlmIChlbC5ldmVudHMpIHsKICAgICAgZGF0YSArPSAoZ2VuSGFuZGxlcnMoZWwuZXZlbnRzLCBmYWxzZSkpICsgIiwiOwogICAgfQogICAgaWYgKGVsLm5hdGl2ZUV2ZW50cykgewogICAgICBkYXRhICs9IChnZW5IYW5kbGVycyhlbC5uYXRpdmVFdmVudHMsIHRydWUpKSArICIsIjsKICAgIH0KICAgIC8vIHNsb3QgdGFyZ2V0CiAgICAvLyBvbmx5IGZvciBub24tc2NvcGVkIHNsb3RzCiAgICBpZiAoZWwuc2xvdFRhcmdldCAmJiAhZWwuc2xvdFNjb3BlKSB7CiAgICAgIGRhdGEgKz0gInNsb3Q6IiArIChlbC5zbG90VGFyZ2V0KSArICIsIjsKICAgIH0KICAgIC8vIHNjb3BlZCBzbG90cwogICAgaWYgKGVsLnNjb3BlZFNsb3RzKSB7CiAgICAgIGRhdGEgKz0gKGdlblNjb3BlZFNsb3RzKGVsLCBlbC5zY29wZWRTbG90cywgc3RhdGUpKSArICIsIjsKICAgIH0KICAgIC8vIGNvbXBvbmVudCB2LW1vZGVsCiAgICBpZiAoZWwubW9kZWwpIHsKICAgICAgZGF0YSArPSAibW9kZWw6e3ZhbHVlOiIgKyAoZWwubW9kZWwudmFsdWUpICsgIixjYWxsYmFjazoiICsgKGVsLm1vZGVsLmNhbGxiYWNrKSArICIsZXhwcmVzc2lvbjoiICsgKGVsLm1vZGVsLmV4cHJlc3Npb24pICsgIn0sIjsKICAgIH0KICAgIC8vIGlubGluZS10ZW1wbGF0ZQogICAgaWYgKGVsLmlubGluZVRlbXBsYXRlKSB7CiAgICAgIHZhciBpbmxpbmVUZW1wbGF0ZSA9IGdlbklubGluZVRlbXBsYXRlKGVsLCBzdGF0ZSk7CiAgICAgIGlmIChpbmxpbmVUZW1wbGF0ZSkgewogICAgICAgIGRhdGEgKz0gaW5saW5lVGVtcGxhdGUgKyAiLCI7CiAgICAgIH0KICAgIH0KICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoLywkLywgJycpICsgJ30nOwogICAgLy8gdi1iaW5kIGR5bmFtaWMgYXJndW1lbnQgd3JhcAogICAgLy8gdi1iaW5kIHdpdGggZHluYW1pYyBhcmd1bWVudHMgbXVzdCBiZSBhcHBsaWVkIHVzaW5nIHRoZSBzYW1lIHYtYmluZCBvYmplY3QKICAgIC8vIG1lcmdlIGhlbHBlciBzbyB0aGF0IGNsYXNzL3N0eWxlL211c3RVc2VQcm9wIGF0dHJzIGFyZSBoYW5kbGVkIGNvcnJlY3RseS4KICAgIGlmIChlbC5keW5hbWljQXR0cnMpIHsKICAgICAgZGF0YSA9ICJfYigiICsgZGF0YSArICIsXCIiICsgKGVsLnRhZykgKyAiXCIsIiArIChnZW5Qcm9wcyhlbC5keW5hbWljQXR0cnMpKSArICIpIjsKICAgIH0KICAgIC8vIHYtYmluZCBkYXRhIHdyYXAKICAgIGlmIChlbC53cmFwRGF0YSkgewogICAgICBkYXRhID0gZWwud3JhcERhdGEoZGF0YSk7CiAgICB9CiAgICAvLyB2LW9uIGRhdGEgd3JhcAogICAgaWYgKGVsLndyYXBMaXN0ZW5lcnMpIHsKICAgICAgZGF0YSA9IGVsLndyYXBMaXN0ZW5lcnMoZGF0YSk7CiAgICB9CiAgICByZXR1cm4gZGF0YQogIH0KCiAgZnVuY3Rpb24gZ2VuRGlyZWN0aXZlcyAoZWwsIHN0YXRlKSB7CiAgICB2YXIgZGlycyA9IGVsLmRpcmVjdGl2ZXM7CiAgICBpZiAoIWRpcnMpIHsgcmV0dXJuIH0KICAgIHZhciByZXMgPSAnZGlyZWN0aXZlczpbJzsKICAgIHZhciBoYXNSdW50aW1lID0gZmFsc2U7CiAgICB2YXIgaSwgbCwgZGlyLCBuZWVkUnVudGltZTsKICAgIGZvciAoaSA9IDAsIGwgPSBkaXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBkaXIgPSBkaXJzW2ldOwogICAgICBuZWVkUnVudGltZSA9IHRydWU7CiAgICAgIHZhciBnZW4gPSBzdGF0ZS5kaXJlY3RpdmVzW2Rpci5uYW1lXTsKICAgICAgaWYgKGdlbikgewogICAgICAgIC8vIGNvbXBpbGUtdGltZSBkaXJlY3RpdmUgdGhhdCBtYW5pcHVsYXRlcyBBU1QuCiAgICAgICAgLy8gcmV0dXJucyB0cnVlIGlmIGl0IGFsc28gbmVlZHMgYSBydW50aW1lIGNvdW50ZXJwYXJ0LgogICAgICAgIG5lZWRSdW50aW1lID0gISFnZW4oZWwsIGRpciwgc3RhdGUud2Fybik7CiAgICAgIH0KICAgICAgaWYgKG5lZWRSdW50aW1lKSB7CiAgICAgICAgaGFzUnVudGltZSA9IHRydWU7CiAgICAgICAgcmVzICs9ICJ7bmFtZTpcIiIgKyAoZGlyLm5hbWUpICsgIlwiLHJhd05hbWU6XCIiICsgKGRpci5yYXdOYW1lKSArICJcIiIgKyAoZGlyLnZhbHVlID8gKCIsdmFsdWU6KCIgKyAoZGlyLnZhbHVlKSArICIpLGV4cHJlc3Npb246IiArIChKU09OLnN0cmluZ2lmeShkaXIudmFsdWUpKSkgOiAnJykgKyAoZGlyLmFyZyA/ICgiLGFyZzoiICsgKGRpci5pc0R5bmFtaWNBcmcgPyBkaXIuYXJnIDogKCJcIiIgKyAoZGlyLmFyZykgKyAiXCIiKSkpIDogJycpICsgKGRpci5tb2RpZmllcnMgPyAoIixtb2RpZmllcnM6IiArIChKU09OLnN0cmluZ2lmeShkaXIubW9kaWZpZXJzKSkpIDogJycpICsgIn0sIjsKICAgICAgfQogICAgfQogICAgaWYgKGhhc1J1bnRpbWUpIHsKICAgICAgcmV0dXJuIHJlcy5zbGljZSgwLCAtMSkgKyAnXScKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlbklubGluZVRlbXBsYXRlIChlbCwgc3RhdGUpIHsKICAgIHZhciBhc3QgPSBlbC5jaGlsZHJlblswXTsKICAgIGlmIChlbC5jaGlsZHJlbi5sZW5ndGggIT09IDEgfHwgYXN0LnR5cGUgIT09IDEpIHsKICAgICAgc3RhdGUud2FybigKICAgICAgICAnSW5saW5lLXRlbXBsYXRlIGNvbXBvbmVudHMgbXVzdCBoYXZlIGV4YWN0bHkgb25lIGNoaWxkIGVsZW1lbnQuJywKICAgICAgICB7IHN0YXJ0OiBlbC5zdGFydCB9CiAgICAgICk7CiAgICB9CiAgICBpZiAoYXN0ICYmIGFzdC50eXBlID09PSAxKSB7CiAgICAgIHZhciBpbmxpbmVSZW5kZXJGbnMgPSBnZW5lcmF0ZShhc3QsIHN0YXRlLm9wdGlvbnMpOwogICAgICByZXR1cm4gKCJpbmxpbmVUZW1wbGF0ZTp7cmVuZGVyOmZ1bmN0aW9uKCl7IiArIChpbmxpbmVSZW5kZXJGbnMucmVuZGVyKSArICJ9LHN0YXRpY1JlbmRlckZuczpbIiArIChpbmxpbmVSZW5kZXJGbnMuc3RhdGljUmVuZGVyRm5zLm1hcChmdW5jdGlvbiAoY29kZSkgeyByZXR1cm4gKCJmdW5jdGlvbigpeyIgKyBjb2RlICsgIn0iKTsgfSkuam9pbignLCcpKSArICJdfSIpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5TY29wZWRTbG90cyAoCiAgICBlbCwKICAgIHNsb3RzLAogICAgc3RhdGUKICApIHsKICAgIC8vIGJ5IGRlZmF1bHQgc2NvcGVkIHNsb3RzIGFyZSBjb25zaWRlcmVkICJzdGFibGUiLCB0aGlzIGFsbG93cyBjaGlsZAogICAgLy8gY29tcG9uZW50cyB3aXRoIG9ubHkgc2NvcGVkIHNsb3RzIHRvIHNraXAgZm9yY2VkIHVwZGF0ZXMgZnJvbSBwYXJlbnQuCiAgICAvLyBidXQgaW4gc29tZSBjYXNlcyB3ZSBoYXZlIHRvIGJhaWwtb3V0IG9mIHRoaXMgb3B0aW1pemF0aW9uCiAgICAvLyBmb3IgZXhhbXBsZSBpZiB0aGUgc2xvdCBjb250YWlucyBkeW5hbWljIG5hbWVzLCBoYXMgdi1pZiBvciB2LWZvciBvbiB0aGVtLi4uCiAgICB2YXIgbmVlZHNGb3JjZVVwZGF0ZSA9IGVsLmZvciB8fCBPYmplY3Qua2V5cyhzbG90cykuc29tZShmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBzbG90ID0gc2xvdHNba2V5XTsKICAgICAgcmV0dXJuICgKICAgICAgICBzbG90LnNsb3RUYXJnZXREeW5hbWljIHx8CiAgICAgICAgc2xvdC5pZiB8fAogICAgICAgIHNsb3QuZm9yIHx8CiAgICAgICAgY29udGFpbnNTbG90Q2hpbGQoc2xvdCkgLy8gaXMgcGFzc2luZyBkb3duIHNsb3QgZnJvbSBwYXJlbnQgd2hpY2ggbWF5IGJlIGR5bmFtaWMKICAgICAgKQogICAgfSk7CgogICAgLy8gIzk1MzQ6IGlmIGEgY29tcG9uZW50IHdpdGggc2NvcGVkIHNsb3RzIGlzIGluc2lkZSBhIGNvbmRpdGlvbmFsIGJyYW5jaCwKICAgIC8vIGl0J3MgcG9zc2libGUgZm9yIHRoZSBzYW1lIGNvbXBvbmVudCB0byBiZSByZXVzZWQgYnV0IHdpdGggZGlmZmVyZW50CiAgICAvLyBjb21waWxlZCBzbG90IGNvbnRlbnQuIFRvIGF2b2lkIHRoYXQsIHdlIGdlbmVyYXRlIGEgdW5pcXVlIGtleSBiYXNlZCBvbgogICAgLy8gdGhlIGdlbmVyYXRlZCBjb2RlIG9mIGFsbCB0aGUgc2xvdCBjb250ZW50cy4KICAgIHZhciBuZWVkc0tleSA9ICEhZWwuaWY7CgogICAgLy8gT1Igd2hlbiBpdCBpcyBpbnNpZGUgYW5vdGhlciBzY29wZWQgc2xvdCBvciB2LWZvciAodGhlIHJlYWN0aXZpdHkgbWF5IGJlCiAgICAvLyBkaXNjb25uZWN0ZWQgZHVlIHRvIHRoZSBpbnRlcm1lZGlhdGUgc2NvcGUgdmFyaWFibGUpCiAgICAvLyAjOTQzOCwgIzk1MDYKICAgIC8vIFRPRE86IHRoaXMgY2FuIGJlIGZ1cnRoZXIgb3B0aW1pemVkIGJ5IHByb3Blcmx5IGFuYWx5emluZyBpbi1zY29wZSBiaW5kaW5ncwogICAgLy8gYW5kIHNraXAgZm9yY2UgdXBkYXRpbmcgb25lcyB0aGF0IGRvIG5vdCBhY3R1YWxseSB1c2Ugc2NvcGUgdmFyaWFibGVzLgogICAgaWYgKCFuZWVkc0ZvcmNlVXBkYXRlKSB7CiAgICAgIHZhciBwYXJlbnQgPSBlbC5wYXJlbnQ7CiAgICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgICBpZiAoCiAgICAgICAgICAocGFyZW50LnNsb3RTY29wZSAmJiBwYXJlbnQuc2xvdFNjb3BlICE9PSBlbXB0eVNsb3RTY29wZVRva2VuKSB8fAogICAgICAgICAgcGFyZW50LmZvcgogICAgICAgICkgewogICAgICAgICAgbmVlZHNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgICBpZiAocGFyZW50LmlmKSB7CiAgICAgICAgICBuZWVkc0tleSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgZ2VuZXJhdGVkU2xvdHMgPSBPYmplY3Qua2V5cyhzbG90cykKICAgICAgLm1hcChmdW5jdGlvbiAoa2V5KSB7IHJldHVybiBnZW5TY29wZWRTbG90KHNsb3RzW2tleV0sIHN0YXRlKTsgfSkKICAgICAgLmpvaW4oJywnKTsKCiAgICByZXR1cm4gKCJzY29wZWRTbG90czpfdShbIiArIGdlbmVyYXRlZFNsb3RzICsgIl0iICsgKG5lZWRzRm9yY2VVcGRhdGUgPyAiLG51bGwsdHJ1ZSIgOiAiIikgKyAoIW5lZWRzRm9yY2VVcGRhdGUgJiYgbmVlZHNLZXkgPyAoIixudWxsLGZhbHNlLCIgKyAoaGFzaChnZW5lcmF0ZWRTbG90cykpKSA6ICIiKSArICIpIikKICB9CgogIGZ1bmN0aW9uIGhhc2goc3RyKSB7CiAgICB2YXIgaGFzaCA9IDUzODE7CiAgICB2YXIgaSA9IHN0ci5sZW5ndGg7CiAgICB3aGlsZShpKSB7CiAgICAgIGhhc2ggPSAoaGFzaCAqIDMzKSBeIHN0ci5jaGFyQ29kZUF0KC0taSk7CiAgICB9CiAgICByZXR1cm4gaGFzaCA+Pj4gMAogIH0KCiAgZnVuY3Rpb24gY29udGFpbnNTbG90Q2hpbGQgKGVsKSB7CiAgICBpZiAoZWwudHlwZSA9PT0gMSkgewogICAgICBpZiAoZWwudGFnID09PSAnc2xvdCcpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICAgIHJldHVybiBlbC5jaGlsZHJlbi5zb21lKGNvbnRhaW5zU2xvdENoaWxkKQogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBmdW5jdGlvbiBnZW5TY29wZWRTbG90ICgKICAgIGVsLAogICAgc3RhdGUKICApIHsKICAgIHZhciBpc0xlZ2FjeVN5bnRheCA9IGVsLmF0dHJzTWFwWydzbG90LXNjb3BlJ107CiAgICBpZiAoZWwuaWYgJiYgIWVsLmlmUHJvY2Vzc2VkICYmICFpc0xlZ2FjeVN5bnRheCkgewogICAgICByZXR1cm4gZ2VuSWYoZWwsIHN0YXRlLCBnZW5TY29wZWRTbG90LCAibnVsbCIpCiAgICB9CiAgICBpZiAoZWwuZm9yICYmICFlbC5mb3JQcm9jZXNzZWQpIHsKICAgICAgcmV0dXJuIGdlbkZvcihlbCwgc3RhdGUsIGdlblNjb3BlZFNsb3QpCiAgICB9CiAgICB2YXIgc2xvdFNjb3BlID0gZWwuc2xvdFNjb3BlID09PSBlbXB0eVNsb3RTY29wZVRva2VuCiAgICAgID8gIiIKICAgICAgOiBTdHJpbmcoZWwuc2xvdFNjb3BlKTsKICAgIHZhciBmbiA9ICJmdW5jdGlvbigiICsgc2xvdFNjb3BlICsgIil7IiArCiAgICAgICJyZXR1cm4gIiArIChlbC50YWcgPT09ICd0ZW1wbGF0ZScKICAgICAgICA/IGVsLmlmICYmIGlzTGVnYWN5U3ludGF4CiAgICAgICAgICA/ICgiKCIgKyAoZWwuaWYpICsgIik/IiArIChnZW5DaGlsZHJlbihlbCwgc3RhdGUpIHx8ICd1bmRlZmluZWQnKSArICI6dW5kZWZpbmVkIikKICAgICAgICAgIDogZ2VuQ2hpbGRyZW4oZWwsIHN0YXRlKSB8fCAndW5kZWZpbmVkJwogICAgICAgIDogZ2VuRWxlbWVudChlbCwgc3RhdGUpKSArICJ9IjsKICAgIC8vIHJldmVyc2UgcHJveHkgdi1zbG90IHdpdGhvdXQgc2NvcGUgb24gdGhpcy4kc2xvdHMKICAgIHZhciByZXZlcnNlUHJveHkgPSBzbG90U2NvcGUgPyAiIiA6ICIscHJveHk6dHJ1ZSI7CiAgICByZXR1cm4gKCJ7a2V5OiIgKyAoZWwuc2xvdFRhcmdldCB8fCAiXCJkZWZhdWx0XCIiKSArICIsZm46IiArIGZuICsgcmV2ZXJzZVByb3h5ICsgIn0iKQogIH0KCiAgZnVuY3Rpb24gZ2VuQ2hpbGRyZW4gKAogICAgZWwsCiAgICBzdGF0ZSwKICAgIGNoZWNrU2tpcCwKICAgIGFsdEdlbkVsZW1lbnQsCiAgICBhbHRHZW5Ob2RlCiAgKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBlbC5jaGlsZHJlbjsKICAgIGlmIChjaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgdmFyIGVsJDEgPSBjaGlsZHJlblswXTsKICAgICAgLy8gb3B0aW1pemUgc2luZ2xlIHYtZm9yCiAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYKICAgICAgICBlbCQxLmZvciAmJgogICAgICAgIGVsJDEudGFnICE9PSAndGVtcGxhdGUnICYmCiAgICAgICAgZWwkMS50YWcgIT09ICdzbG90JwogICAgICApIHsKICAgICAgICB2YXIgbm9ybWFsaXphdGlvblR5cGUgPSBjaGVja1NraXAKICAgICAgICAgID8gc3RhdGUubWF5YmVDb21wb25lbnQoZWwkMSkgPyAiLDEiIDogIiwwIgogICAgICAgICAgOiAiIjsKICAgICAgICByZXR1cm4gKCIiICsgKChhbHRHZW5FbGVtZW50IHx8IGdlbkVsZW1lbnQpKGVsJDEsIHN0YXRlKSkgKyBub3JtYWxpemF0aW9uVHlwZSkKICAgICAgfQogICAgICB2YXIgbm9ybWFsaXphdGlvblR5cGUkMSA9IGNoZWNrU2tpcAogICAgICAgID8gZ2V0Tm9ybWFsaXphdGlvblR5cGUoY2hpbGRyZW4sIHN0YXRlLm1heWJlQ29tcG9uZW50KQogICAgICAgIDogMDsKICAgICAgdmFyIGdlbiA9IGFsdEdlbk5vZGUgfHwgZ2VuTm9kZTsKICAgICAgcmV0dXJuICgiWyIgKyAoY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7IHJldHVybiBnZW4oYywgc3RhdGUpOyB9KS5qb2luKCcsJykpICsgIl0iICsgKG5vcm1hbGl6YXRpb25UeXBlJDEgPyAoIiwiICsgbm9ybWFsaXphdGlvblR5cGUkMSkgOiAnJykpCiAgICB9CiAgfQoKICAvLyBkZXRlcm1pbmUgdGhlIG5vcm1hbGl6YXRpb24gbmVlZGVkIGZvciB0aGUgY2hpbGRyZW4gYXJyYXkuCiAgLy8gMDogbm8gbm9ybWFsaXphdGlvbiBuZWVkZWQKICAvLyAxOiBzaW1wbGUgbm9ybWFsaXphdGlvbiBuZWVkZWQgKHBvc3NpYmxlIDEtbGV2ZWwgZGVlcCBuZXN0ZWQgYXJyYXkpCiAgLy8gMjogZnVsbCBub3JtYWxpemF0aW9uIG5lZWRlZAogIGZ1bmN0aW9uIGdldE5vcm1hbGl6YXRpb25UeXBlICgKICAgIGNoaWxkcmVuLAogICAgbWF5YmVDb21wb25lbnQKICApIHsKICAgIHZhciByZXMgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZWwgPSBjaGlsZHJlbltpXTsKICAgICAgaWYgKGVsLnR5cGUgIT09IDEpIHsKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICAgIGlmIChuZWVkc05vcm1hbGl6YXRpb24oZWwpIHx8CiAgICAgICAgICAoZWwuaWZDb25kaXRpb25zICYmIGVsLmlmQ29uZGl0aW9ucy5zb21lKGZ1bmN0aW9uIChjKSB7IHJldHVybiBuZWVkc05vcm1hbGl6YXRpb24oYy5ibG9jayk7IH0pKSkgewogICAgICAgIHJlcyA9IDI7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgICBpZiAobWF5YmVDb21wb25lbnQoZWwpIHx8CiAgICAgICAgICAoZWwuaWZDb25kaXRpb25zICYmIGVsLmlmQ29uZGl0aW9ucy5zb21lKGZ1bmN0aW9uIChjKSB7IHJldHVybiBtYXliZUNvbXBvbmVudChjLmJsb2NrKTsgfSkpKSB7CiAgICAgICAgcmVzID0gMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gbmVlZHNOb3JtYWxpemF0aW9uIChlbCkgewogICAgcmV0dXJuIGVsLmZvciAhPT0gdW5kZWZpbmVkIHx8IGVsLnRhZyA9PT0gJ3RlbXBsYXRlJyB8fCBlbC50YWcgPT09ICdzbG90JwogIH0KCiAgZnVuY3Rpb24gZ2VuTm9kZSAobm9kZSwgc3RhdGUpIHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIGdlbkVsZW1lbnQobm9kZSwgc3RhdGUpCiAgICB9IGVsc2UgaWYgKG5vZGUudHlwZSA9PT0gMyAmJiBub2RlLmlzQ29tbWVudCkgewogICAgICByZXR1cm4gZ2VuQ29tbWVudChub2RlKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdlblRleHQobm9kZSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlblRleHQgKHRleHQpIHsKICAgIHJldHVybiAoIl92KCIgKyAodGV4dC50eXBlID09PSAyCiAgICAgID8gdGV4dC5leHByZXNzaW9uIC8vIG5vIG5lZWQgZm9yICgpIGJlY2F1c2UgYWxyZWFkeSB3cmFwcGVkIGluIF9zKCkKICAgICAgOiB0cmFuc2Zvcm1TcGVjaWFsTmV3bGluZXMoSlNPTi5zdHJpbmdpZnkodGV4dC50ZXh0KSkpICsgIikiKQogIH0KCiAgZnVuY3Rpb24gZ2VuQ29tbWVudCAoY29tbWVudCkgewogICAgcmV0dXJuICgiX2UoIiArIChKU09OLnN0cmluZ2lmeShjb21tZW50LnRleHQpKSArICIpIikKICB9CgogIGZ1bmN0aW9uIGdlblNsb3QgKGVsLCBzdGF0ZSkgewogICAgdmFyIHNsb3ROYW1lID0gZWwuc2xvdE5hbWUgfHwgJyJkZWZhdWx0Iic7CiAgICB2YXIgY2hpbGRyZW4gPSBnZW5DaGlsZHJlbihlbCwgc3RhdGUpOwogICAgdmFyIHJlcyA9ICJfdCgiICsgc2xvdE5hbWUgKyAoY2hpbGRyZW4gPyAoIiwiICsgY2hpbGRyZW4pIDogJycpOwogICAgdmFyIGF0dHJzID0gZWwuYXR0cnMgfHwgZWwuZHluYW1pY0F0dHJzCiAgICAgID8gZ2VuUHJvcHMoKGVsLmF0dHJzIHx8IFtdKS5jb25jYXQoZWwuZHluYW1pY0F0dHJzIHx8IFtdKS5tYXAoZnVuY3Rpb24gKGF0dHIpIHsgcmV0dXJuICh7CiAgICAgICAgICAvLyBzbG90IHByb3BzIGFyZSBjYW1lbGl6ZWQKICAgICAgICAgIG5hbWU6IGNhbWVsaXplKGF0dHIubmFtZSksCiAgICAgICAgICB2YWx1ZTogYXR0ci52YWx1ZSwKICAgICAgICAgIGR5bmFtaWM6IGF0dHIuZHluYW1pYwogICAgICAgIH0pOyB9KSkKICAgICAgOiBudWxsOwogICAgdmFyIGJpbmQkJDEgPSBlbC5hdHRyc01hcFsndi1iaW5kJ107CiAgICBpZiAoKGF0dHJzIHx8IGJpbmQkJDEpICYmICFjaGlsZHJlbikgewogICAgICByZXMgKz0gIixudWxsIjsKICAgIH0KICAgIGlmIChhdHRycykgewogICAgICByZXMgKz0gIiwiICsgYXR0cnM7CiAgICB9CiAgICBpZiAoYmluZCQkMSkgewogICAgICByZXMgKz0gKGF0dHJzID8gJycgOiAnLG51bGwnKSArICIsIiArIGJpbmQkJDE7CiAgICB9CiAgICByZXR1cm4gcmVzICsgJyknCiAgfQoKICAvLyBjb21wb25lbnROYW1lIGlzIGVsLmNvbXBvbmVudCwgdGFrZSBpdCBhcyBhcmd1bWVudCB0byBzaHVuIGZsb3cncyBwZXNzaW1pc3RpYyByZWZpbmVtZW50CiAgZnVuY3Rpb24gZ2VuQ29tcG9uZW50ICgKICAgIGNvbXBvbmVudE5hbWUsCiAgICBlbCwKICAgIHN0YXRlCiAgKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBlbC5pbmxpbmVUZW1wbGF0ZSA/IG51bGwgOiBnZW5DaGlsZHJlbihlbCwgc3RhdGUsIHRydWUpOwogICAgcmV0dXJuICgiX2MoIiArIGNvbXBvbmVudE5hbWUgKyAiLCIgKyAoZ2VuRGF0YSQyKGVsLCBzdGF0ZSkpICsgKGNoaWxkcmVuID8gKCIsIiArIGNoaWxkcmVuKSA6ICcnKSArICIpIikKICB9CgogIGZ1bmN0aW9uIGdlblByb3BzIChwcm9wcykgewogICAgdmFyIHN0YXRpY1Byb3BzID0gIiI7CiAgICB2YXIgZHluYW1pY1Byb3BzID0gIiI7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBwcm9wID0gcHJvcHNbaV07CiAgICAgIHZhciB2YWx1ZSA9IHRyYW5zZm9ybVNwZWNpYWxOZXdsaW5lcyhwcm9wLnZhbHVlKTsKICAgICAgaWYgKHByb3AuZHluYW1pYykgewogICAgICAgIGR5bmFtaWNQcm9wcyArPSAocHJvcC5uYW1lKSArICIsIiArIHZhbHVlICsgIiwiOwogICAgICB9IGVsc2UgewogICAgICAgIHN0YXRpY1Byb3BzICs9ICJcIiIgKyAocHJvcC5uYW1lKSArICJcIjoiICsgdmFsdWUgKyAiLCI7CiAgICAgIH0KICAgIH0KICAgIHN0YXRpY1Byb3BzID0gInsiICsgKHN0YXRpY1Byb3BzLnNsaWNlKDAsIC0xKSkgKyAifSI7CiAgICBpZiAoZHluYW1pY1Byb3BzKSB7CiAgICAgIHJldHVybiAoIl9kKCIgKyBzdGF0aWNQcm9wcyArICIsWyIgKyAoZHluYW1pY1Byb3BzLnNsaWNlKDAsIC0xKSkgKyAiXSkiKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHN0YXRpY1Byb3BzCiAgICB9CiAgfQoKICAvLyAjMzg5NSwgIzQyNjgKICBmdW5jdGlvbiB0cmFuc2Zvcm1TcGVjaWFsTmV3bGluZXMgKHRleHQpIHsKICAgIHJldHVybiB0ZXh0CiAgICAgIC5yZXBsYWNlKC9cdTIwMjgvZywgJ1xcdTIwMjgnKQogICAgICAucmVwbGFjZSgvXHUyMDI5L2csICdcXHUyMDI5JykKICB9CgogIC8qICAqLwoKCgogIC8vIHRoZXNlIGtleXdvcmRzIHNob3VsZCBub3QgYXBwZWFyIGluc2lkZSBleHByZXNzaW9ucywgYnV0IG9wZXJhdG9ycyBsaWtlCiAgLy8gdHlwZW9mLCBpbnN0YW5jZW9mIGFuZCBpbiBhcmUgYWxsb3dlZAogIHZhciBwcm9oaWJpdGVkS2V5d29yZFJFID0gbmV3IFJlZ0V4cCgnXFxiJyArICgKICAgICdkbyxpZixmb3IsbGV0LG5ldyx0cnksdmFyLGNhc2UsZWxzZSx3aXRoLGF3YWl0LGJyZWFrLGNhdGNoLGNsYXNzLGNvbnN0LCcgKwogICAgJ3N1cGVyLHRocm93LHdoaWxlLHlpZWxkLGRlbGV0ZSxleHBvcnQsaW1wb3J0LHJldHVybixzd2l0Y2gsZGVmYXVsdCwnICsKICAgICdleHRlbmRzLGZpbmFsbHksY29udGludWUsZGVidWdnZXIsZnVuY3Rpb24sYXJndW1lbnRzJwogICkuc3BsaXQoJywnKS5qb2luKCdcXGJ8XFxiJykgKyAnXFxiJyk7CgogIC8vIHRoZXNlIHVuYXJ5IG9wZXJhdG9ycyBzaG91bGQgbm90IGJlIHVzZWQgYXMgcHJvcGVydHkvbWV0aG9kIG5hbWVzCiAgdmFyIHVuYXJ5T3BlcmF0b3JzUkUgPSBuZXcgUmVnRXhwKCdcXGInICsgKAogICAgJ2RlbGV0ZSx0eXBlb2Ysdm9pZCcKICApLnNwbGl0KCcsJykuam9pbignXFxzKlxcKFteXFwpXSpcXCl8XFxiJykgKyAnXFxzKlxcKFteXFwpXSpcXCknKTsKCiAgLy8gc3RyaXAgc3RyaW5ncyBpbiBleHByZXNzaW9ucwogIHZhciBzdHJpcFN0cmluZ1JFID0gLycoPzpbXidcXF18XFwuKSonfCIoPzpbXiJcXF18XFwuKSoifGAoPzpbXmBcXF18XFwuKSpcJFx7fFx9KD86W15gXFxdfFxcLikqYHxgKD86W15gXFxdfFxcLikqYC9nOwoKICAvLyBkZXRlY3QgcHJvYmxlbWF0aWMgZXhwcmVzc2lvbnMgaW4gYSB0ZW1wbGF0ZQogIGZ1bmN0aW9uIGRldGVjdEVycm9ycyAoYXN0LCB3YXJuKSB7CiAgICBpZiAoYXN0KSB7CiAgICAgIGNoZWNrTm9kZShhc3QsIHdhcm4pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hlY2tOb2RlIChub2RlLCB3YXJuKSB7CiAgICBpZiAobm9kZS50eXBlID09PSAxKSB7CiAgICAgIGZvciAodmFyIG5hbWUgaW4gbm9kZS5hdHRyc01hcCkgewogICAgICAgIGlmIChkaXJSRS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmF0dHJzTWFwW25hbWVdOwogICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciByYW5nZSA9IG5vZGUucmF3QXR0cnNNYXBbbmFtZV07CiAgICAgICAgICAgIGlmIChuYW1lID09PSAndi1mb3InKSB7CiAgICAgICAgICAgICAgY2hlY2tGb3Iobm9kZSwgKCJ2LWZvcj1cIiIgKyB2YWx1ZSArICJcIiIpLCB3YXJuLCByYW5nZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob25SRS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgY2hlY2tFdmVudCh2YWx1ZSwgKG5hbWUgKyAiPVwiIiArIHZhbHVlICsgIlwiIiksIHdhcm4sIHJhbmdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGVja0V4cHJlc3Npb24odmFsdWUsIChuYW1lICsgIj1cIiIgKyB2YWx1ZSArICJcIiIpLCB3YXJuLCByYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG5vZGUuY2hpbGRyZW4pIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNoZWNrTm9kZShub2RlLmNoaWxkcmVuW2ldLCB3YXJuKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobm9kZS50eXBlID09PSAyKSB7CiAgICAgIGNoZWNrRXhwcmVzc2lvbihub2RlLmV4cHJlc3Npb24sIG5vZGUudGV4dCwgd2Fybiwgbm9kZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGVja0V2ZW50IChleHAsIHRleHQsIHdhcm4sIHJhbmdlKSB7CiAgICB2YXIgc3RpcHBlZCA9IGV4cC5yZXBsYWNlKHN0cmlwU3RyaW5nUkUsICcnKTsKICAgIHZhciBrZXl3b3JkTWF0Y2ggPSBzdGlwcGVkLm1hdGNoKHVuYXJ5T3BlcmF0b3JzUkUpOwogICAgaWYgKGtleXdvcmRNYXRjaCAmJiBzdGlwcGVkLmNoYXJBdChrZXl3b3JkTWF0Y2guaW5kZXggLSAxKSAhPT0gJyQnKSB7CiAgICAgIHdhcm4oCiAgICAgICAgImF2b2lkIHVzaW5nIEphdmFTY3JpcHQgdW5hcnkgb3BlcmF0b3IgYXMgcHJvcGVydHkgbmFtZTogIiArCiAgICAgICAgIlwiIiArIChrZXl3b3JkTWF0Y2hbMF0pICsgIlwiIGluIGV4cHJlc3Npb24gIiArICh0ZXh0LnRyaW0oKSksCiAgICAgICAgcmFuZ2UKICAgICAgKTsKICAgIH0KICAgIGNoZWNrRXhwcmVzc2lvbihleHAsIHRleHQsIHdhcm4sIHJhbmdlKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrRm9yIChub2RlLCB0ZXh0LCB3YXJuLCByYW5nZSkgewogICAgY2hlY2tFeHByZXNzaW9uKG5vZGUuZm9yIHx8ICcnLCB0ZXh0LCB3YXJuLCByYW5nZSk7CiAgICBjaGVja0lkZW50aWZpZXIobm9kZS5hbGlhcywgJ3YtZm9yIGFsaWFzJywgdGV4dCwgd2FybiwgcmFuZ2UpOwogICAgY2hlY2tJZGVudGlmaWVyKG5vZGUuaXRlcmF0b3IxLCAndi1mb3IgaXRlcmF0b3InLCB0ZXh0LCB3YXJuLCByYW5nZSk7CiAgICBjaGVja0lkZW50aWZpZXIobm9kZS5pdGVyYXRvcjIsICd2LWZvciBpdGVyYXRvcicsIHRleHQsIHdhcm4sIHJhbmdlKTsKICB9CgogIGZ1bmN0aW9uIGNoZWNrSWRlbnRpZmllciAoCiAgICBpZGVudCwKICAgIHR5cGUsCiAgICB0ZXh0LAogICAgd2FybiwKICAgIHJhbmdlCiAgKSB7CiAgICBpZiAodHlwZW9mIGlkZW50ID09PSAnc3RyaW5nJykgewogICAgICB0cnkgewogICAgICAgIG5ldyBGdW5jdGlvbigoInZhciAiICsgaWRlbnQgKyAiPV8iKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB3YXJuKCgiaW52YWxpZCAiICsgdHlwZSArICIgXCIiICsgaWRlbnQgKyAiXCIgaW4gZXhwcmVzc2lvbjogIiArICh0ZXh0LnRyaW0oKSkpLCByYW5nZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoZWNrRXhwcmVzc2lvbiAoZXhwLCB0ZXh0LCB3YXJuLCByYW5nZSkgewogICAgdHJ5IHsKICAgICAgbmV3IEZ1bmN0aW9uKCgicmV0dXJuICIgKyBleHApKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdmFyIGtleXdvcmRNYXRjaCA9IGV4cC5yZXBsYWNlKHN0cmlwU3RyaW5nUkUsICcnKS5tYXRjaChwcm9oaWJpdGVkS2V5d29yZFJFKTsKICAgICAgaWYgKGtleXdvcmRNYXRjaCkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAiYXZvaWQgdXNpbmcgSmF2YVNjcmlwdCBrZXl3b3JkIGFzIHByb3BlcnR5IG5hbWU6ICIgKwogICAgICAgICAgIlwiIiArIChrZXl3b3JkTWF0Y2hbMF0pICsgIlwiXG4gIFJhdyBleHByZXNzaW9uOiAiICsgKHRleHQudHJpbSgpKSwKICAgICAgICAgIHJhbmdlCiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKAogICAgICAgICAgImludmFsaWQgZXhwcmVzc2lvbjogIiArIChlLm1lc3NhZ2UpICsgIiBpblxuXG4iICsKICAgICAgICAgICIgICAgIiArIGV4cCArICJcblxuIiArCiAgICAgICAgICAiICBSYXcgZXhwcmVzc2lvbjogIiArICh0ZXh0LnRyaW0oKSkgKyAiXG4iLAogICAgICAgICAgcmFuZ2UKICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgdmFyIHJhbmdlID0gMjsKCiAgZnVuY3Rpb24gZ2VuZXJhdGVDb2RlRnJhbWUgKAogICAgc291cmNlLAogICAgc3RhcnQsCiAgICBlbmQKICApIHsKICAgIGlmICggc3RhcnQgPT09IHZvaWQgMCApIHN0YXJ0ID0gMDsKICAgIGlmICggZW5kID09PSB2b2lkIDAgKSBlbmQgPSBzb3VyY2UubGVuZ3RoOwoKICAgIHZhciBsaW5lcyA9IHNvdXJjZS5zcGxpdCgvXHI/XG4vKTsKICAgIHZhciBjb3VudCA9IDA7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvdW50ICs9IGxpbmVzW2ldLmxlbmd0aCArIDE7CiAgICAgIGlmIChjb3VudCA+PSBzdGFydCkgewogICAgICAgIGZvciAodmFyIGogPSBpIC0gcmFuZ2U7IGogPD0gaSArIHJhbmdlIHx8IGVuZCA+IGNvdW50OyBqKyspIHsKICAgICAgICAgIGlmIChqIDwgMCB8fCBqID49IGxpbmVzLmxlbmd0aCkgeyBjb250aW51ZSB9CiAgICAgICAgICByZXMucHVzaCgoIiIgKyAoaiArIDEpICsgKHJlcGVhdCQxKCIgIiwgMyAtIFN0cmluZyhqICsgMSkubGVuZ3RoKSkgKyAifCAgIiArIChsaW5lc1tqXSkpKTsKICAgICAgICAgIHZhciBsaW5lTGVuZ3RoID0gbGluZXNbal0ubGVuZ3RoOwogICAgICAgICAgaWYgKGogPT09IGkpIHsKICAgICAgICAgICAgLy8gcHVzaCB1bmRlcmxpbmUKICAgICAgICAgICAgdmFyIHBhZCA9IHN0YXJ0IC0gKGNvdW50IC0gbGluZUxlbmd0aCkgKyAxOwogICAgICAgICAgICB2YXIgbGVuZ3RoID0gZW5kID4gY291bnQgPyBsaW5lTGVuZ3RoIC0gcGFkIDogZW5kIC0gc3RhcnQ7CiAgICAgICAgICAgIHJlcy5wdXNoKCIgICB8ICAiICsgcmVwZWF0JDEoIiAiLCBwYWQpICsgcmVwZWF0JDEoIl4iLCBsZW5ndGgpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaiA+IGkpIHsKICAgICAgICAgICAgaWYgKGVuZCA+IGNvdW50KSB7CiAgICAgICAgICAgICAgdmFyIGxlbmd0aCQxID0gTWF0aC5taW4oZW5kIC0gY291bnQsIGxpbmVMZW5ndGgpOwogICAgICAgICAgICAgIHJlcy5wdXNoKCIgICB8ICAiICsgcmVwZWF0JDEoIl4iLCBsZW5ndGgkMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvdW50ICs9IGxpbmVMZW5ndGggKyAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzLmpvaW4oJ1xuJykKICB9CgogIGZ1bmN0aW9uIHJlcGVhdCQxIChzdHIsIG4pIHsKICAgIHZhciByZXN1bHQgPSAnJzsKICAgIGlmIChuID4gMCkgewogICAgICB3aGlsZSAodHJ1ZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lCiAgICAgICAgaWYgKG4gJiAxKSB7IHJlc3VsdCArPSBzdHI7IH0KICAgICAgICBuID4+Pj0gMTsKICAgICAgICBpZiAobiA8PSAwKSB7IGJyZWFrIH0KICAgICAgICBzdHIgKz0gc3RyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0CiAgfQoKICAvKiAgKi8KCgoKICBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbiAoY29kZSwgZXJyb3JzKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKGNvZGUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgZXJyb3JzLnB1c2goeyBlcnI6IGVyciwgY29kZTogY29kZSB9KTsKICAgICAgcmV0dXJuIG5vb3AKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBpbGVUb0Z1bmN0aW9uRm4gKGNvbXBpbGUpIHsKICAgIHZhciBjYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIGNvbXBpbGVUb0Z1bmN0aW9ucyAoCiAgICAgIHRlbXBsYXRlLAogICAgICBvcHRpb25zLAogICAgICB2bQogICAgKSB7CiAgICAgIG9wdGlvbnMgPSBleHRlbmQoe30sIG9wdGlvbnMpOwogICAgICB2YXIgd2FybiQkMSA9IG9wdGlvbnMud2FybiB8fCB3YXJuOwogICAgICBkZWxldGUgb3B0aW9ucy53YXJuOwoKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICAvLyBkZXRlY3QgcG9zc2libGUgQ1NQIHJlc3RyaWN0aW9uCiAgICAgICAgdHJ5IHsKICAgICAgICAgIG5ldyBGdW5jdGlvbigncmV0dXJuIDEnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoZS50b1N0cmluZygpLm1hdGNoKC91bnNhZmUtZXZhbHxDU1AvKSkgewogICAgICAgICAgICB3YXJuJCQxKAogICAgICAgICAgICAgICdJdCBzZWVtcyB5b3UgYXJlIHVzaW5nIHRoZSBzdGFuZGFsb25lIGJ1aWxkIG9mIFZ1ZS5qcyBpbiBhbiAnICsKICAgICAgICAgICAgICAnZW52aXJvbm1lbnQgd2l0aCBDb250ZW50IFNlY3VyaXR5IFBvbGljeSB0aGF0IHByb2hpYml0cyB1bnNhZmUtZXZhbC4gJyArCiAgICAgICAgICAgICAgJ1RoZSB0ZW1wbGF0ZSBjb21waWxlciBjYW5ub3Qgd29yayBpbiB0aGlzIGVudmlyb25tZW50LiBDb25zaWRlciAnICsKICAgICAgICAgICAgICAncmVsYXhpbmcgdGhlIHBvbGljeSB0byBhbGxvdyB1bnNhZmUtZXZhbCBvciBwcmUtY29tcGlsaW5nIHlvdXIgJyArCiAgICAgICAgICAgICAgJ3RlbXBsYXRlcyBpbnRvIHJlbmRlciBmdW5jdGlvbnMuJwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gY2hlY2sgY2FjaGUKICAgICAgdmFyIGtleSA9IG9wdGlvbnMuZGVsaW1pdGVycwogICAgICAgID8gU3RyaW5nKG9wdGlvbnMuZGVsaW1pdGVycykgKyB0ZW1wbGF0ZQogICAgICAgIDogdGVtcGxhdGU7CiAgICAgIGlmIChjYWNoZVtrZXldKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlW2tleV0KICAgICAgfQoKICAgICAgLy8gY29tcGlsZQogICAgICB2YXIgY29tcGlsZWQgPSBjb21waWxlKHRlbXBsYXRlLCBvcHRpb25zKTsKCiAgICAgIC8vIGNoZWNrIGNvbXBpbGF0aW9uIGVycm9ycy90aXBzCiAgICAgIHsKICAgICAgICBpZiAoY29tcGlsZWQuZXJyb3JzICYmIGNvbXBpbGVkLmVycm9ycy5sZW5ndGgpIHsKICAgICAgICAgIGlmIChvcHRpb25zLm91dHB1dFNvdXJjZVJhbmdlKSB7CiAgICAgICAgICAgIGNvbXBpbGVkLmVycm9ycy5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgd2FybiQkMSgKICAgICAgICAgICAgICAgICJFcnJvciBjb21waWxpbmcgdGVtcGxhdGU6XG5cbiIgKyAoZS5tc2cpICsgIlxuXG4iICsKICAgICAgICAgICAgICAgIGdlbmVyYXRlQ29kZUZyYW1lKHRlbXBsYXRlLCBlLnN0YXJ0LCBlLmVuZCksCiAgICAgICAgICAgICAgICB2bQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2FybiQkMSgKICAgICAgICAgICAgICAiRXJyb3IgY29tcGlsaW5nIHRlbXBsYXRlOlxuXG4iICsgdGVtcGxhdGUgKyAiXG5cbiIgKwogICAgICAgICAgICAgIGNvbXBpbGVkLmVycm9ycy5tYXAoZnVuY3Rpb24gKGUpIHsgcmV0dXJuICgiLSAiICsgZSk7IH0pLmpvaW4oJ1xuJykgKyAnXG4nLAogICAgICAgICAgICAgIHZtCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjb21waWxlZC50aXBzICYmIGNvbXBpbGVkLnRpcHMubGVuZ3RoKSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5vdXRwdXRTb3VyY2VSYW5nZSkgewogICAgICAgICAgICBjb21waWxlZC50aXBzLmZvckVhY2goZnVuY3Rpb24gKGUpIHsgcmV0dXJuIHRpcChlLm1zZywgdm0pOyB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbXBpbGVkLnRpcHMuZm9yRWFjaChmdW5jdGlvbiAobXNnKSB7IHJldHVybiB0aXAobXNnLCB2bSk7IH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gdHVybiBjb2RlIGludG8gZnVuY3Rpb25zCiAgICAgIHZhciByZXMgPSB7fTsKICAgICAgdmFyIGZuR2VuRXJyb3JzID0gW107CiAgICAgIHJlcy5yZW5kZXIgPSBjcmVhdGVGdW5jdGlvbihjb21waWxlZC5yZW5kZXIsIGZuR2VuRXJyb3JzKTsKICAgICAgcmVzLnN0YXRpY1JlbmRlckZucyA9IGNvbXBpbGVkLnN0YXRpY1JlbmRlckZucy5tYXAoZnVuY3Rpb24gKGNvZGUpIHsKICAgICAgICByZXR1cm4gY3JlYXRlRnVuY3Rpb24oY29kZSwgZm5HZW5FcnJvcnMpCiAgICAgIH0pOwoKICAgICAgLy8gY2hlY2sgZnVuY3Rpb24gZ2VuZXJhdGlvbiBlcnJvcnMuCiAgICAgIC8vIHRoaXMgc2hvdWxkIG9ubHkgaGFwcGVuIGlmIHRoZXJlIGlzIGEgYnVnIGluIHRoZSBjb21waWxlciBpdHNlbGYuCiAgICAgIC8vIG1vc3RseSBmb3IgY29kZWdlbiBkZXZlbG9wbWVudCB1c2UKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICBpZiAoKCFjb21waWxlZC5lcnJvcnMgfHwgIWNvbXBpbGVkLmVycm9ycy5sZW5ndGgpICYmIGZuR2VuRXJyb3JzLmxlbmd0aCkgewogICAgICAgICAgd2FybiQkMSgKICAgICAgICAgICAgIkZhaWxlZCB0byBnZW5lcmF0ZSByZW5kZXIgZnVuY3Rpb246XG5cbiIgKwogICAgICAgICAgICBmbkdlbkVycm9ycy5tYXAoZnVuY3Rpb24gKHJlZikgewogICAgICAgICAgICAgIHZhciBlcnIgPSByZWYuZXJyOwogICAgICAgICAgICAgIHZhciBjb2RlID0gcmVmLmNvZGU7CgogICAgICAgICAgICAgIHJldHVybiAoKGVyci50b1N0cmluZygpKSArICIgaW5cblxuIiArIGNvZGUgKyAiXG4iKTsKICAgICAgICAgIH0pLmpvaW4oJ1xuJyksCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIChjYWNoZVtrZXldID0gcmVzKQogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBpbGVyQ3JlYXRvciAoYmFzZUNvbXBpbGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiBjcmVhdGVDb21waWxlciAoYmFzZU9wdGlvbnMpIHsKICAgICAgZnVuY3Rpb24gY29tcGlsZSAoCiAgICAgICAgdGVtcGxhdGUsCiAgICAgICAgb3B0aW9ucwogICAgICApIHsKICAgICAgICB2YXIgZmluYWxPcHRpb25zID0gT2JqZWN0LmNyZWF0ZShiYXNlT3B0aW9ucyk7CiAgICAgICAgdmFyIGVycm9ycyA9IFtdOwogICAgICAgIHZhciB0aXBzID0gW107CgogICAgICAgIHZhciB3YXJuID0gZnVuY3Rpb24gKG1zZywgcmFuZ2UsIHRpcCkgewogICAgICAgICAgKHRpcCA/IHRpcHMgOiBlcnJvcnMpLnB1c2gobXNnKTsKICAgICAgICB9OwoKICAgICAgICBpZiAob3B0aW9ucykgewogICAgICAgICAgaWYgKG9wdGlvbnMub3V0cHV0U291cmNlUmFuZ2UpIHsKICAgICAgICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgICAgICAgIHZhciBsZWFkaW5nU3BhY2VMZW5ndGggPSB0ZW1wbGF0ZS5tYXRjaCgvXlxzKi8pWzBdLmxlbmd0aDsKCiAgICAgICAgICAgIHdhcm4gPSBmdW5jdGlvbiAobXNnLCByYW5nZSwgdGlwKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSB7IG1zZzogbXNnIH07CiAgICAgICAgICAgICAgaWYgKHJhbmdlKSB7CiAgICAgICAgICAgICAgICBpZiAocmFuZ2Uuc3RhcnQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkYXRhLnN0YXJ0ID0gcmFuZ2Uuc3RhcnQgKyBsZWFkaW5nU3BhY2VMZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmFuZ2UuZW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5lbmQgPSByYW5nZS5lbmQgKyBsZWFkaW5nU3BhY2VMZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICh0aXAgPyB0aXBzIDogZXJyb3JzKS5wdXNoKGRhdGEpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgLy8gbWVyZ2UgY3VzdG9tIG1vZHVsZXMKICAgICAgICAgIGlmIChvcHRpb25zLm1vZHVsZXMpIHsKICAgICAgICAgICAgZmluYWxPcHRpb25zLm1vZHVsZXMgPQogICAgICAgICAgICAgIChiYXNlT3B0aW9ucy5tb2R1bGVzIHx8IFtdKS5jb25jYXQob3B0aW9ucy5tb2R1bGVzKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIG1lcmdlIGN1c3RvbSBkaXJlY3RpdmVzCiAgICAgICAgICBpZiAob3B0aW9ucy5kaXJlY3RpdmVzKSB7CiAgICAgICAgICAgIGZpbmFsT3B0aW9ucy5kaXJlY3RpdmVzID0gZXh0ZW5kKAogICAgICAgICAgICAgIE9iamVjdC5jcmVhdGUoYmFzZU9wdGlvbnMuZGlyZWN0aXZlcyB8fCBudWxsKSwKICAgICAgICAgICAgICBvcHRpb25zLmRpcmVjdGl2ZXMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGNvcHkgb3RoZXIgb3B0aW9ucwogICAgICAgICAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKGtleSAhPT0gJ21vZHVsZXMnICYmIGtleSAhPT0gJ2RpcmVjdGl2ZXMnKSB7CiAgICAgICAgICAgICAgZmluYWxPcHRpb25zW2tleV0gPSBvcHRpb25zW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZpbmFsT3B0aW9ucy53YXJuID0gd2FybjsKCiAgICAgICAgdmFyIGNvbXBpbGVkID0gYmFzZUNvbXBpbGUodGVtcGxhdGUudHJpbSgpLCBmaW5hbE9wdGlvbnMpOwogICAgICAgIHsKICAgICAgICAgIGRldGVjdEVycm9ycyhjb21waWxlZC5hc3QsIHdhcm4pOwogICAgICAgIH0KICAgICAgICBjb21waWxlZC5lcnJvcnMgPSBlcnJvcnM7CiAgICAgICAgY29tcGlsZWQudGlwcyA9IHRpcHM7CiAgICAgICAgcmV0dXJuIGNvbXBpbGVkCiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgY29tcGlsZTogY29tcGlsZSwKICAgICAgICBjb21waWxlVG9GdW5jdGlvbnM6IGNyZWF0ZUNvbXBpbGVUb0Z1bmN0aW9uRm4oY29tcGlsZSkKICAgICAgfQogICAgfQogIH0KCiAgLyogICovCgogIC8vIGBjcmVhdGVDb21waWxlckNyZWF0b3JgIGFsbG93cyBjcmVhdGluZyBjb21waWxlcnMgdGhhdCB1c2UgYWx0ZXJuYXRpdmUKICAvLyBwYXJzZXIvb3B0aW1pemVyL2NvZGVnZW4sIGUuZyB0aGUgU1NSIG9wdGltaXppbmcgY29tcGlsZXIuCiAgLy8gSGVyZSB3ZSBqdXN0IGV4cG9ydCBhIGRlZmF1bHQgY29tcGlsZXIgdXNpbmcgdGhlIGRlZmF1bHQgcGFydHMuCiAgdmFyIGNyZWF0ZUNvbXBpbGVyID0gY3JlYXRlQ29tcGlsZXJDcmVhdG9yKGZ1bmN0aW9uIGJhc2VDb21waWxlICgKICAgIHRlbXBsYXRlLAogICAgb3B0aW9ucwogICkgewogICAgdmFyIGFzdCA9IHBhcnNlKHRlbXBsYXRlLnRyaW0oKSwgb3B0aW9ucyk7CiAgICBpZiAob3B0aW9ucy5vcHRpbWl6ZSAhPT0gZmFsc2UpIHsKICAgICAgb3B0aW1pemUoYXN0LCBvcHRpb25zKTsKICAgIH0KICAgIHZhciBjb2RlID0gZ2VuZXJhdGUoYXN0LCBvcHRpb25zKTsKICAgIHJldHVybiB7CiAgICAgIGFzdDogYXN0LAogICAgICByZW5kZXI6IGNvZGUucmVuZGVyLAogICAgICBzdGF0aWNSZW5kZXJGbnM6IGNvZGUuc3RhdGljUmVuZGVyRm5zCiAgICB9CiAgfSk7CgogIC8qICAqLwoKICB2YXIgcmVmJDEgPSBjcmVhdGVDb21waWxlcihiYXNlT3B0aW9ucyk7CiAgdmFyIGNvbXBpbGUgPSByZWYkMS5jb21waWxlOwogIHZhciBjb21waWxlVG9GdW5jdGlvbnMgPSByZWYkMS5jb21waWxlVG9GdW5jdGlvbnM7CgogIC8qICAqLwoKICAvLyBjaGVjayB3aGV0aGVyIGN1cnJlbnQgYnJvd3NlciBlbmNvZGVzIGEgY2hhciBpbnNpZGUgYXR0cmlidXRlIHZhbHVlcwogIHZhciBkaXY7CiAgZnVuY3Rpb24gZ2V0U2hvdWxkRGVjb2RlIChocmVmKSB7CiAgICBkaXYgPSBkaXYgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBkaXYuaW5uZXJIVE1MID0gaHJlZiA/ICI8YSBocmVmPVwiXG5cIi8+IiA6ICI8ZGl2IGE9XCJcblwiLz4iOwogICAgcmV0dXJuIGRpdi5pbm5lckhUTUwuaW5kZXhPZignJiMxMDsnKSA+IDAKICB9CgogIC8vICMzNjYzOiBJRSBlbmNvZGVzIG5ld2xpbmVzIGluc2lkZSBhdHRyaWJ1dGUgdmFsdWVzIHdoaWxlIG90aGVyIGJyb3dzZXJzIGRvbid0CiAgdmFyIHNob3VsZERlY29kZU5ld2xpbmVzID0gaW5Ccm93c2VyID8gZ2V0U2hvdWxkRGVjb2RlKGZhbHNlKSA6IGZhbHNlOwogIC8vICM2ODI4OiBjaHJvbWUgZW5jb2RlcyBjb250ZW50IGluIGFbaHJlZl0KICB2YXIgc2hvdWxkRGVjb2RlTmV3bGluZXNGb3JIcmVmID0gaW5Ccm93c2VyID8gZ2V0U2hvdWxkRGVjb2RlKHRydWUpIDogZmFsc2U7CgogIC8qICAqLwoKICB2YXIgaWRUb1RlbXBsYXRlID0gY2FjaGVkKGZ1bmN0aW9uIChpZCkgewogICAgdmFyIGVsID0gcXVlcnkoaWQpOwogICAgcmV0dXJuIGVsICYmIGVsLmlubmVySFRNTAogIH0pOwoKICB2YXIgbW91bnQgPSBWdWUucHJvdG90eXBlLiRtb3VudDsKICBWdWUucHJvdG90eXBlLiRtb3VudCA9IGZ1bmN0aW9uICgKICAgIGVsLAogICAgaHlkcmF0aW5nCiAgKSB7CiAgICBlbCA9IGVsICYmIHF1ZXJ5KGVsKTsKCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChlbCA9PT0gZG9jdW1lbnQuYm9keSB8fCBlbCA9PT0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkRvIG5vdCBtb3VudCBWdWUgdG8gPGh0bWw+IG9yIDxib2R5PiAtIG1vdW50IHRvIG5vcm1hbCBlbGVtZW50cyBpbnN0ZWFkLiIKICAgICAgKTsKICAgICAgcmV0dXJuIHRoaXMKICAgIH0KCiAgICB2YXIgb3B0aW9ucyA9IHRoaXMuJG9wdGlvbnM7CiAgICAvLyByZXNvbHZlIHRlbXBsYXRlL2VsIGFuZCBjb252ZXJ0IHRvIHJlbmRlciBmdW5jdGlvbgogICAgaWYgKCFvcHRpb25zLnJlbmRlcikgewogICAgICB2YXIgdGVtcGxhdGUgPSBvcHRpb25zLnRlbXBsYXRlOwogICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICBpZiAodHlwZW9mIHRlbXBsYXRlID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKHRlbXBsYXRlLmNoYXJBdCgwKSA9PT0gJyMnKSB7CiAgICAgICAgICAgIHRlbXBsYXRlID0gaWRUb1RlbXBsYXRlKHRlbXBsYXRlKTsKICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICAgKCJUZW1wbGF0ZSBlbGVtZW50IG5vdCBmb3VuZCBvciBpcyBlbXB0eTogIiArIChvcHRpb25zLnRlbXBsYXRlKSksCiAgICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodGVtcGxhdGUubm9kZVR5cGUpIHsKICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUuaW5uZXJIVE1MOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm4oJ2ludmFsaWQgdGVtcGxhdGUgb3B0aW9uOicgKyB0ZW1wbGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChlbCkgewogICAgICAgIHRlbXBsYXRlID0gZ2V0T3V0ZXJIVE1MKGVsKTsKICAgICAgfQogICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgICAgIG1hcmsoJ2NvbXBpbGUnKTsKICAgICAgICB9CgogICAgICAgIHZhciByZWYgPSBjb21waWxlVG9GdW5jdGlvbnModGVtcGxhdGUsIHsKICAgICAgICAgIG91dHB1dFNvdXJjZVJhbmdlOiAiZGV2ZWxvcG1lbnQiICE9PSAncHJvZHVjdGlvbicsCiAgICAgICAgICBzaG91bGREZWNvZGVOZXdsaW5lczogc2hvdWxkRGVjb2RlTmV3bGluZXMsCiAgICAgICAgICBzaG91bGREZWNvZGVOZXdsaW5lc0ZvckhyZWY6IHNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZiwKICAgICAgICAgIGRlbGltaXRlcnM6IG9wdGlvbnMuZGVsaW1pdGVycywKICAgICAgICAgIGNvbW1lbnRzOiBvcHRpb25zLmNvbW1lbnRzCiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgdmFyIHJlbmRlciA9IHJlZi5yZW5kZXI7CiAgICAgICAgdmFyIHN0YXRpY1JlbmRlckZucyA9IHJlZi5zdGF0aWNSZW5kZXJGbnM7CiAgICAgICAgb3B0aW9ucy5yZW5kZXIgPSByZW5kZXI7CiAgICAgICAgb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnMgPSBzdGF0aWNSZW5kZXJGbnM7CgogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgIGlmIChjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICAgICAgbWFyaygnY29tcGlsZSBlbmQnKTsKICAgICAgICAgIG1lYXN1cmUoKCJ2dWUgIiArICh0aGlzLl9uYW1lKSArICIgY29tcGlsZSIpLCAnY29tcGlsZScsICdjb21waWxlIGVuZCcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG1vdW50LmNhbGwodGhpcywgZWwsIGh5ZHJhdGluZykKICB9OwoKICAvKioKICAgKiBHZXQgb3V0ZXJIVE1MIG9mIGVsZW1lbnRzLCB0YWtpbmcgY2FyZQogICAqIG9mIFNWRyBlbGVtZW50cyBpbiBJRSBhcyB3ZWxsLgogICAqLwogIGZ1bmN0aW9uIGdldE91dGVySFRNTCAoZWwpIHsKICAgIGlmIChlbC5vdXRlckhUTUwpIHsKICAgICAgcmV0dXJuIGVsLm91dGVySFRNTAogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWwuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgcmV0dXJuIGNvbnRhaW5lci5pbm5lckhUTUwKICAgIH0KICB9CgogIFZ1ZS5jb21waWxlID0gY29tcGlsZVRvRnVuY3Rpb25zOwoKICByZXR1cm4gVnVlOwoKfSkpOwo="},{"meta":{"name":"xfetch.min.js","url":"https://unpkg.com/xfetch-js@0.3.4/xfetch.min.js","ts":1582701382243,"mimetype":"text/javascript"},"source":"KChhLGIpPT57ImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUoW10sYik6Im9iamVjdCI9PXR5cGVvZiBleHBvcnRzP21vZHVsZS5leHBvcnRzPWIoKTphLnhmPWIoKX0pKHRoaXMsKCk9Pntjb25zdCBhPVsiZ2V0IiwicG9zdCIsInB1dCIsInBhdGNoIiwiZGVsZXRlIiwiaGVhZCJdO2NsYXNzIGIgZXh0ZW5kcyBFcnJvcntjb25zdHJ1Y3RvcihhKXtzdXBlcihhLnN0YXR1c1RleHQpLHRoaXMubmFtZT0iSFRUUEVycm9yIix0aGlzLnJlc3BvbnNlPWF9fWNsYXNzIGMgZXh0ZW5kcyBQcm9taXNle31mb3IoY29uc3QgYSBvZlsiYXJyYXlCdWZmZXIiLCJibG9iIiwiZm9ybURhdGEiLCJqc29uIiwidGV4dCJdKWMucHJvdG90eXBlW2FdPWZ1bmN0aW9uKGIpe3JldHVybiB0aGlzLnRoZW4oYj0+YlthXSgpKS50aGVuKGJ8fChhPT5hKSl9O2NvbnN0e2Fzc2lnbjpkfT1PYmplY3QsZT1hPT5hLnJlZHVjZSgoYSxbYixjXSk9PihhW2JdPWMsYSkse30pLGY9KC4uLmEpPT5iPT5hLnNvbWUoYT0+InN0cmluZyI9PXR5cGVvZiBhP3R5cGVvZiBiPT1hOmIgaW5zdGFuY2VvZiBhKSxnPWYoInN0cmluZyIpLGg9Zigib2JqZWN0IiksaT1hPT5nKGEpfHxoKGEpLGo9YT0+e2lmKCFhLm9rKXRocm93IG5ldyBiKGEpO3JldHVybiBhfSxrPShoPXt9KT0+e2NvbnN0IGw9KGEsYj17fSk9PntkKGIsaCk7Y29uc3Qgaz1hPT5uZXcgYi5VUkxTZWFyY2hQYXJhbXMoYSkudG9TdHJpbmcoKSxsPW5ldyBiLlVSTChhLGIuYmFzZVVSSXx8dm9pZCAwKTtpZihiLmhlYWRlcnM/ZihiLkhlYWRlcnMpKGIuaGVhZGVycykmJihiLmhlYWRlcnM9ZShbLi4uYi5oZWFkZXJzLmVudHJpZXMoKV0pKTpiLmhlYWRlcnM9e30sYi5qc29uKWIuYm9keT1KU09OLnN0cmluZ2lmeShiLmpzb24pLGIuaGVhZGVyc1siQ29udGVudC1UeXBlIl09ImFwcGxpY2F0aW9uL2pzb24iO2Vsc2UgaWYoaShiLnVybGVuY29kZWQpKWIuYm9keT1nKGIudXJsZW5jb2RlZCk/Yi51cmxlbmNvZGVkOmsoYi51cmxlbmNvZGVkKSxiLmhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdPSJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiO2Vsc2UgaWYoZihiLkZvcm1EYXRhLCJvYmplY3QiKShiLmZvcm1EYXRhKSl7aWYoIWYoYi5Gb3JtRGF0YSkoYi5mb3JtRGF0YSkpe2NvbnN0IGE9bmV3IGIuRm9ybURhdGE7Zm9yKGNvbnN0W2MsZF1vZiBPYmplY3QuZW50cmllcyhiLmZvcm1EYXRhKSlhLmFwcGVuZChjLGQpO2IuZm9ybURhdGE9YX1iLmJvZHk9Yi5mb3JtRGF0YX1yZXR1cm4gYi5xcyYmKGcoYi5xcykmJihiLnFzPShhPT5lKFsuLi5uZXcgYi5VUkxTZWFyY2hQYXJhbXMoYSkuZW50cmllcygpXSkpKGIucXMpKSxsLnNlYXJjaD1rKGQoZShbLi4ubC5zZWFyY2hQYXJhbXMuZW50cmllcygpXSksYi5xcykpKSxiLmNyZWRlbnRpYWxzfHwoYi5jcmVkZW50aWFscz0ic2FtZS1vcmlnaW4iKSxjLnJlc29sdmUoYi5mZXRjaChsLGIpLnRoZW4oaikpfTtmb3IoY29uc3QgYiBvZiBhKWxbYl09KGEsYz17fSk9PihjLm1ldGhvZD1iLnRvVXBwZXJDYXNlKCksbChhLGMpKTtyZXR1cm4gbC5leHRlbmQ9YT0+ayhkKHt9LGgsYSkpLGwuSFRUUEVycm9yPWIsbH0sbD0idW5kZWZpbmVkIiE9dHlwZW9mIGRvY3VtZW50LG09InVuZGVmaW5lZCIhPXR5cGVvZiBzZWxmO3JldHVybiBtP2soe2ZldGNoOmZldGNoLmJpbmQoc2VsZiksVVJMLFJlc3BvbnNlLFVSTFNlYXJjaFBhcmFtcyxIZWFkZXJzLEZvcm1EYXRhLGJhc2VVUkk6bD9kb2N1bWVudC5iYXNlVVJJOiIifSk6aygpfSk7"},{"meta":{"name":"ffmpeg.min.js","url":"https://unpkg.com/@ffmpeg/ffmpeg@0.5.2/dist/ffmpeg.min.js","ts":1582701382302,"mimetype":"text/javascript"},"source":"IWZ1bmN0aW9uKGUsdCl7Im9iamVjdCI9PXR5cGVvZiBleHBvcnRzJiYib2JqZWN0Ij09dHlwZW9mIG1vZHVsZT9tb2R1bGUuZXhwb3J0cz10KCk6ImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUoW10sdCk6Im9iamVjdCI9PXR5cGVvZiBleHBvcnRzP2V4cG9ydHMuRkZtcGVnPXQoKTplLkZGbXBlZz10KCl9KHdpbmRvdywoZnVuY3Rpb24oKXtyZXR1cm4gZnVuY3Rpb24oZSl7dmFyIHQ9e307ZnVuY3Rpb24gcihuKXtpZih0W25dKXJldHVybiB0W25dLmV4cG9ydHM7dmFyIG89dFtuXT17aTpuLGw6ITEsZXhwb3J0czp7fX07cmV0dXJuIGVbbl0uY2FsbChvLmV4cG9ydHMsbyxvLmV4cG9ydHMsciksby5sPSEwLG8uZXhwb3J0c31yZXR1cm4gci5tPWUsci5jPXQsci5kPWZ1bmN0aW9uKGUsdCxuKXtyLm8oZSx0KXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7ZW51bWVyYWJsZTohMCxnZXQ6bn0pfSxyLnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sci50PWZ1bmN0aW9uKGUsdCl7aWYoMSZ0JiYoZT1yKGUpKSw4JnQpcmV0dXJuIGU7aWYoNCZ0JiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbj1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHIucihuKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobiwiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImdCYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgbyBpbiBlKXIuZChuLG8sZnVuY3Rpb24odCl7cmV0dXJuIGVbdF19LmJpbmQobnVsbCxvKSk7cmV0dXJuIG59LHIubj1mdW5jdGlvbihlKXt2YXIgdD1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gci5kKHQsImEiLHQpLHR9LHIubz1mdW5jdGlvbihlLHQpe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSx0KX0sci5wPSIiLHIoci5zPTMpfShbZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG87dm9pZCAwPT09KG89ImZ1bmN0aW9uIj09dHlwZW9mKG49ZnVuY3Rpb24oKXtyZXR1cm4gZnVuY3Rpb24oKXt2YXIgZT1hcmd1bWVudHMubGVuZ3RoO2lmKDA9PT1lKXRocm93IG5ldyBFcnJvcigicmVzb2x2ZVVybCByZXF1aXJlcyBhdCBsZWFzdCBvbmUgYXJndW1lbnQ7IGdvdCBub25lLiIpO3ZhciB0PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJhc2UiKTtpZih0LmhyZWY9YXJndW1lbnRzWzBdLDE9PT1lKXJldHVybiB0LmhyZWY7dmFyIHI9ZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTtyLmluc2VydEJlZm9yZSh0LHIuZmlyc3RDaGlsZCk7Zm9yKHZhciBuLG89ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpLGk9MTtpPGU7aSsrKW8uaHJlZj1hcmd1bWVudHNbaV0sbj1vLmhyZWYsdC5ocmVmPW47cmV0dXJuIHIucmVtb3ZlQ2hpbGQodCksbn19KT9uLmNhbGwodCxyLHQsZSk6bil8fChlLmV4cG9ydHM9byl9LGZ1bmN0aW9uKGUsdCl7dmFyIHI9dGhpcyxuPSExO3QubG9nZ2luZz1uLHQuc2V0TG9nZ2luZz1mdW5jdGlvbihlKXtuPWV9LHQubG9nPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsdD1uZXcgQXJyYXkoZSksbz0wO288ZTtvKyspdFtvXT1hcmd1bWVudHNbb107cmV0dXJuIG4/Y29uc29sZS5sb2cuYXBwbHkocix0KTpudWxsfX0sZnVuY3Rpb24oZSx0KXtlLmV4cG9ydHM9ZnVuY3Rpb24oZSx0KXtyZXR1cm4iIi5jb25jYXQoZSwiLSIpLmNvbmNhdCh0LCItIikuY29uY2F0KE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnNsaWNlKDMsOCkpfX0sZnVuY3Rpb24oZSx0LHIpe3IoNCk7dmFyIG49cigxKSxvPW4ubG9nZ2luZyxpPW4uc2V0TG9nZ2luZyxhPXIoNSk7ZS5leHBvcnRzPXtsb2dnaW5nOm8sc2V0TG9nZ2luZzppLGNyZWF0ZVdvcmtlcjphfX0sZnVuY3Rpb24oZSx0LHIpe3ZhciBuPWZ1bmN0aW9uKGUpeyJ1c2Ugc3RyaWN0Ijt2YXIgdCxyPU9iamVjdC5wcm90b3R5cGUsbj1yLmhhc093blByb3BlcnR5LG89ImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbD9TeW1ib2w6e30saT1vLml0ZXJhdG9yfHwiQEBpdGVyYXRvciIsYT1vLmFzeW5jSXRlcmF0b3J8fCJAQGFzeW5jSXRlcmF0b3IiLGM9by50b1N0cmluZ1RhZ3x8IkBAdG9TdHJpbmdUYWciO2Z1bmN0aW9uIHUoZSx0LHIsbil7dmFyIG89dCYmdC5wcm90b3R5cGUgaW5zdGFuY2VvZiB2P3Q6dixpPU9iamVjdC5jcmVhdGUoby5wcm90b3R5cGUpLGE9bmV3IEwobnx8W10pO3JldHVybiBpLl9pbnZva2U9ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPWY7cmV0dXJuIGZ1bmN0aW9uKG8saSl7aWYobj09PXApdGhyb3cgbmV3IEVycm9yKCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBydW5uaW5nIik7aWYobj09PWQpe2lmKCJ0aHJvdyI9PT1vKXRocm93IGk7cmV0dXJuIFMoKX1mb3Ioci5tZXRob2Q9byxyLmFyZz1pOzspe3ZhciBhPXIuZGVsZWdhdGU7aWYoYSl7dmFyIGM9ayhhLHIpO2lmKGMpe2lmKGM9PT1oKWNvbnRpbnVlO3JldHVybiBjfX1pZigibmV4dCI9PT1yLm1ldGhvZClyLnNlbnQ9ci5fc2VudD1yLmFyZztlbHNlIGlmKCJ0aHJvdyI9PT1yLm1ldGhvZCl7aWYobj09PWYpdGhyb3cgbj1kLHIuYXJnO3IuZGlzcGF0Y2hFeGNlcHRpb24oci5hcmcpfWVsc2UicmV0dXJuIj09PXIubWV0aG9kJiZyLmFicnVwdCgicmV0dXJuIixyLmFyZyk7bj1wO3ZhciB1PXMoZSx0LHIpO2lmKCJub3JtYWwiPT09dS50eXBlKXtpZihuPXIuZG9uZT9kOmwsdS5hcmc9PT1oKWNvbnRpbnVlO3JldHVybnt2YWx1ZTp1LmFyZyxkb25lOnIuZG9uZX19InRocm93Ij09PXUudHlwZSYmKG49ZCxyLm1ldGhvZD0idGhyb3ciLHIuYXJnPXUuYXJnKX19fShlLHIsYSksaX1mdW5jdGlvbiBzKGUsdCxyKXt0cnl7cmV0dXJue3R5cGU6Im5vcm1hbCIsYXJnOmUuY2FsbCh0LHIpfX1jYXRjaChlKXtyZXR1cm57dHlwZToidGhyb3ciLGFyZzplfX19ZS53cmFwPXU7dmFyIGY9InN1c3BlbmRlZFN0YXJ0IixsPSJzdXNwZW5kZWRZaWVsZCIscD0iZXhlY3V0aW5nIixkPSJjb21wbGV0ZWQiLGg9e307ZnVuY3Rpb24gdigpe31mdW5jdGlvbiBtKCl7fWZ1bmN0aW9uIGcoKXt9dmFyIHk9e307eVtpXT1mdW5jdGlvbigpe3JldHVybiB0aGlzfTt2YXIgYj1PYmplY3QuZ2V0UHJvdG90eXBlT2Ysdz1iJiZiKGIoRChbXSkpKTt3JiZ3IT09ciYmbi5jYWxsKHcsaSkmJih5PXcpO3ZhciB4PWcucHJvdG90eXBlPXYucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoeSk7ZnVuY3Rpb24gaihlKXtbIm5leHQiLCJ0aHJvdyIsInJldHVybiJdLmZvckVhY2goKGZ1bmN0aW9uKHQpe2VbdF09ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMuX2ludm9rZSh0LGUpfX0pKX1mdW5jdGlvbiBPKGUpe3ZhciB0O3RoaXMuX2ludm9rZT1mdW5jdGlvbihyLG8pe2Z1bmN0aW9uIGkoKXtyZXR1cm4gbmV3IFByb21pc2UoKGZ1bmN0aW9uKHQsaSl7IWZ1bmN0aW9uIHQocixvLGksYSl7dmFyIGM9cyhlW3JdLGUsbyk7aWYoInRocm93IiE9PWMudHlwZSl7dmFyIHU9Yy5hcmcsZj11LnZhbHVlO3JldHVybiBmJiYib2JqZWN0Ij09dHlwZW9mIGYmJm4uY2FsbChmLCJfX2F3YWl0Iik/UHJvbWlzZS5yZXNvbHZlKGYuX19hd2FpdCkudGhlbigoZnVuY3Rpb24oZSl7dCgibmV4dCIsZSxpLGEpfSksKGZ1bmN0aW9uKGUpe3QoInRocm93IixlLGksYSl9KSk6UHJvbWlzZS5yZXNvbHZlKGYpLnRoZW4oKGZ1bmN0aW9uKGUpe3UudmFsdWU9ZSxpKHUpfSksKGZ1bmN0aW9uKGUpe3JldHVybiB0KCJ0aHJvdyIsZSxpLGEpfSkpfWEoYy5hcmcpfShyLG8sdCxpKX0pKX1yZXR1cm4gdD10P3QudGhlbihpLGkpOmkoKX19ZnVuY3Rpb24gayhlLHIpe3ZhciBuPWUuaXRlcmF0b3Jbci5tZXRob2RdO2lmKG49PT10KXtpZihyLmRlbGVnYXRlPW51bGwsInRocm93Ij09PXIubWV0aG9kKXtpZihlLml0ZXJhdG9yLnJldHVybiYmKHIubWV0aG9kPSJyZXR1cm4iLHIuYXJnPXQsayhlLHIpLCJ0aHJvdyI9PT1yLm1ldGhvZCkpcmV0dXJuIGg7ci5tZXRob2Q9InRocm93IixyLmFyZz1uZXcgVHlwZUVycm9yKCJUaGUgaXRlcmF0b3IgZG9lcyBub3QgcHJvdmlkZSBhICd0aHJvdycgbWV0aG9kIil9cmV0dXJuIGh9dmFyIG89cyhuLGUuaXRlcmF0b3Isci5hcmcpO2lmKCJ0aHJvdyI9PT1vLnR5cGUpcmV0dXJuIHIubWV0aG9kPSJ0aHJvdyIsci5hcmc9by5hcmcsci5kZWxlZ2F0ZT1udWxsLGg7dmFyIGk9by5hcmc7cmV0dXJuIGk/aS5kb25lPyhyW2UucmVzdWx0TmFtZV09aS52YWx1ZSxyLm5leHQ9ZS5uZXh0TG9jLCJyZXR1cm4iIT09ci5tZXRob2QmJihyLm1ldGhvZD0ibmV4dCIsci5hcmc9dCksci5kZWxlZ2F0ZT1udWxsLGgpOmk6KHIubWV0aG9kPSJ0aHJvdyIsci5hcmc9bmV3IFR5cGVFcnJvcigiaXRlcmF0b3IgcmVzdWx0IGlzIG5vdCBhbiBvYmplY3QiKSxyLmRlbGVnYXRlPW51bGwsaCl9ZnVuY3Rpb24gUChlKXt2YXIgdD17dHJ5TG9jOmVbMF19OzEgaW4gZSYmKHQuY2F0Y2hMb2M9ZVsxXSksMiBpbiBlJiYodC5maW5hbGx5TG9jPWVbMl0sdC5hZnRlckxvYz1lWzNdKSx0aGlzLnRyeUVudHJpZXMucHVzaCh0KX1mdW5jdGlvbiBFKGUpe3ZhciB0PWUuY29tcGxldGlvbnx8e307dC50eXBlPSJub3JtYWwiLGRlbGV0ZSB0LmFyZyxlLmNvbXBsZXRpb249dH1mdW5jdGlvbiBMKGUpe3RoaXMudHJ5RW50cmllcz1be3RyeUxvYzoicm9vdCJ9XSxlLmZvckVhY2goUCx0aGlzKSx0aGlzLnJlc2V0KCEwKX1mdW5jdGlvbiBEKGUpe2lmKGUpe3ZhciByPWVbaV07aWYocilyZXR1cm4gci5jYWxsKGUpO2lmKCJmdW5jdGlvbiI9PXR5cGVvZiBlLm5leHQpcmV0dXJuIGU7aWYoIWlzTmFOKGUubGVuZ3RoKSl7dmFyIG89LTEsYT1mdW5jdGlvbiByKCl7Zm9yKDsrK288ZS5sZW5ndGg7KWlmKG4uY2FsbChlLG8pKXJldHVybiByLnZhbHVlPWVbb10sci5kb25lPSExLHI7cmV0dXJuIHIudmFsdWU9dCxyLmRvbmU9ITAscn07cmV0dXJuIGEubmV4dD1hfX1yZXR1cm57bmV4dDpTfX1mdW5jdGlvbiBTKCl7cmV0dXJue3ZhbHVlOnQsZG9uZTohMH19cmV0dXJuIG0ucHJvdG90eXBlPXguY29uc3RydWN0b3I9ZyxnLmNvbnN0cnVjdG9yPW0sZ1tjXT1tLmRpc3BsYXlOYW1lPSJHZW5lcmF0b3JGdW5jdGlvbiIsZS5pc0dlbmVyYXRvckZ1bmN0aW9uPWZ1bmN0aW9uKGUpe3ZhciB0PSJmdW5jdGlvbiI9PXR5cGVvZiBlJiZlLmNvbnN0cnVjdG9yO3JldHVybiEhdCYmKHQ9PT1tfHwiR2VuZXJhdG9yRnVuY3Rpb24iPT09KHQuZGlzcGxheU5hbWV8fHQubmFtZSkpfSxlLm1hcms9ZnVuY3Rpb24oZSl7cmV0dXJuIE9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3Quc2V0UHJvdG90eXBlT2YoZSxnKTooZS5fX3Byb3RvX189ZyxjIGluIGV8fChlW2NdPSJHZW5lcmF0b3JGdW5jdGlvbiIpKSxlLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKHgpLGV9LGUuYXdyYXA9ZnVuY3Rpb24oZSl7cmV0dXJue19fYXdhaXQ6ZX19LGooTy5wcm90b3R5cGUpLE8ucHJvdG90eXBlW2FdPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9LGUuQXN5bmNJdGVyYXRvcj1PLGUuYXN5bmM9ZnVuY3Rpb24odCxyLG4sbyl7dmFyIGk9bmV3IE8odSh0LHIsbixvKSk7cmV0dXJuIGUuaXNHZW5lcmF0b3JGdW5jdGlvbihyKT9pOmkubmV4dCgpLnRoZW4oKGZ1bmN0aW9uKGUpe3JldHVybiBlLmRvbmU/ZS52YWx1ZTppLm5leHQoKX0pKX0saih4KSx4W2NdPSJHZW5lcmF0b3IiLHhbaV09ZnVuY3Rpb24oKXtyZXR1cm4gdGhpc30seC50b1N0cmluZz1mdW5jdGlvbigpe3JldHVybiJbb2JqZWN0IEdlbmVyYXRvcl0ifSxlLmtleXM9ZnVuY3Rpb24oZSl7dmFyIHQ9W107Zm9yKHZhciByIGluIGUpdC5wdXNoKHIpO3JldHVybiB0LnJldmVyc2UoKSxmdW5jdGlvbiByKCl7Zm9yKDt0Lmxlbmd0aDspe3ZhciBuPXQucG9wKCk7aWYobiBpbiBlKXJldHVybiByLnZhbHVlPW4sci5kb25lPSExLHJ9cmV0dXJuIHIuZG9uZT0hMCxyfX0sZS52YWx1ZXM9RCxMLnByb3RvdHlwZT17Y29uc3RydWN0b3I6TCxyZXNldDpmdW5jdGlvbihlKXtpZih0aGlzLnByZXY9MCx0aGlzLm5leHQ9MCx0aGlzLnNlbnQ9dGhpcy5fc2VudD10LHRoaXMuZG9uZT0hMSx0aGlzLmRlbGVnYXRlPW51bGwsdGhpcy5tZXRob2Q9Im5leHQiLHRoaXMuYXJnPXQsdGhpcy50cnlFbnRyaWVzLmZvckVhY2goRSksIWUpZm9yKHZhciByIGluIHRoaXMpInQiPT09ci5jaGFyQXQoMCkmJm4uY2FsbCh0aGlzLHIpJiYhaXNOYU4oK3Iuc2xpY2UoMSkpJiYodGhpc1tyXT10KX0sc3RvcDpmdW5jdGlvbigpe3RoaXMuZG9uZT0hMDt2YXIgZT10aGlzLnRyeUVudHJpZXNbMF0uY29tcGxldGlvbjtpZigidGhyb3ciPT09ZS50eXBlKXRocm93IGUuYXJnO3JldHVybiB0aGlzLnJ2YWx9LGRpc3BhdGNoRXhjZXB0aW9uOmZ1bmN0aW9uKGUpe2lmKHRoaXMuZG9uZSl0aHJvdyBlO3ZhciByPXRoaXM7ZnVuY3Rpb24gbyhuLG8pe3JldHVybiBjLnR5cGU9InRocm93IixjLmFyZz1lLHIubmV4dD1uLG8mJihyLm1ldGhvZD0ibmV4dCIsci5hcmc9dCksISFvfWZvcih2YXIgaT10aGlzLnRyeUVudHJpZXMubGVuZ3RoLTE7aT49MDstLWkpe3ZhciBhPXRoaXMudHJ5RW50cmllc1tpXSxjPWEuY29tcGxldGlvbjtpZigicm9vdCI9PT1hLnRyeUxvYylyZXR1cm4gbygiZW5kIik7aWYoYS50cnlMb2M8PXRoaXMucHJldil7dmFyIHU9bi5jYWxsKGEsImNhdGNoTG9jIikscz1uLmNhbGwoYSwiZmluYWxseUxvYyIpO2lmKHUmJnMpe2lmKHRoaXMucHJldjxhLmNhdGNoTG9jKXJldHVybiBvKGEuY2F0Y2hMb2MsITApO2lmKHRoaXMucHJldjxhLmZpbmFsbHlMb2MpcmV0dXJuIG8oYS5maW5hbGx5TG9jKX1lbHNlIGlmKHUpe2lmKHRoaXMucHJldjxhLmNhdGNoTG9jKXJldHVybiBvKGEuY2F0Y2hMb2MsITApfWVsc2V7aWYoIXMpdGhyb3cgbmV3IEVycm9yKCJ0cnkgc3RhdGVtZW50IHdpdGhvdXQgY2F0Y2ggb3IgZmluYWxseSIpO2lmKHRoaXMucHJldjxhLmZpbmFsbHlMb2MpcmV0dXJuIG8oYS5maW5hbGx5TG9jKX19fX0sYWJydXB0OmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPXRoaXMudHJ5RW50cmllcy5sZW5ndGgtMTtyPj0wOy0tcil7dmFyIG89dGhpcy50cnlFbnRyaWVzW3JdO2lmKG8udHJ5TG9jPD10aGlzLnByZXYmJm4uY2FsbChvLCJmaW5hbGx5TG9jIikmJnRoaXMucHJldjxvLmZpbmFsbHlMb2Mpe3ZhciBpPW87YnJlYWt9fWkmJigiYnJlYWsiPT09ZXx8ImNvbnRpbnVlIj09PWUpJiZpLnRyeUxvYzw9dCYmdDw9aS5maW5hbGx5TG9jJiYoaT1udWxsKTt2YXIgYT1pP2kuY29tcGxldGlvbjp7fTtyZXR1cm4gYS50eXBlPWUsYS5hcmc9dCxpPyh0aGlzLm1ldGhvZD0ibmV4dCIsdGhpcy5uZXh0PWkuZmluYWxseUxvYyxoKTp0aGlzLmNvbXBsZXRlKGEpfSxjb21wbGV0ZTpmdW5jdGlvbihlLHQpe2lmKCJ0aHJvdyI9PT1lLnR5cGUpdGhyb3cgZS5hcmc7cmV0dXJuImJyZWFrIj09PWUudHlwZXx8ImNvbnRpbnVlIj09PWUudHlwZT90aGlzLm5leHQ9ZS5hcmc6InJldHVybiI9PT1lLnR5cGU/KHRoaXMucnZhbD10aGlzLmFyZz1lLmFyZyx0aGlzLm1ldGhvZD0icmV0dXJuIix0aGlzLm5leHQ9ImVuZCIpOiJub3JtYWwiPT09ZS50eXBlJiZ0JiYodGhpcy5uZXh0PXQpLGh9LGZpbmlzaDpmdW5jdGlvbihlKXtmb3IodmFyIHQ9dGhpcy50cnlFbnRyaWVzLmxlbmd0aC0xO3Q+PTA7LS10KXt2YXIgcj10aGlzLnRyeUVudHJpZXNbdF07aWYoci5maW5hbGx5TG9jPT09ZSlyZXR1cm4gdGhpcy5jb21wbGV0ZShyLmNvbXBsZXRpb24sci5hZnRlckxvYyksRShyKSxofX0sY2F0Y2g6ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PXRoaXMudHJ5RW50cmllcy5sZW5ndGgtMTt0Pj0wOy0tdCl7dmFyIHI9dGhpcy50cnlFbnRyaWVzW3RdO2lmKHIudHJ5TG9jPT09ZSl7dmFyIG49ci5jb21wbGV0aW9uO2lmKCJ0aHJvdyI9PT1uLnR5cGUpe3ZhciBvPW4uYXJnO0Uocil9cmV0dXJuIG99fXRocm93IG5ldyBFcnJvcigiaWxsZWdhbCBjYXRjaCBhdHRlbXB0Iil9LGRlbGVnYXRlWWllbGQ6ZnVuY3Rpb24oZSxyLG4pe3JldHVybiB0aGlzLmRlbGVnYXRlPXtpdGVyYXRvcjpEKGUpLHJlc3VsdE5hbWU6cixuZXh0TG9jOm59LCJuZXh0Ij09PXRoaXMubWV0aG9kJiYodGhpcy5hcmc9dCksaH19LGV9KGUuZXhwb3J0cyk7dHJ5e3JlZ2VuZXJhdG9yUnVudGltZT1ufWNhdGNoKGUpe0Z1bmN0aW9uKCJyIiwicmVnZW5lcmF0b3JSdW50aW1lID0gciIpKG4pfX0sZnVuY3Rpb24oZSx0LHIpe2Z1bmN0aW9uIG4oZSl7cmV0dXJuIGZ1bmN0aW9uKGUpe2lmKEFycmF5LmlzQXJyYXkoZSkpe2Zvcih2YXIgdD0wLHI9bmV3IEFycmF5KGUubGVuZ3RoKTt0PGUubGVuZ3RoO3QrKylyW3RdPWVbdF07cmV0dXJuIHJ9fShlKXx8ZnVuY3Rpb24oZSl7aWYoU3ltYm9sLml0ZXJhdG9yIGluIE9iamVjdChlKXx8IltvYmplY3QgQXJndW1lbnRzXSI9PT1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZSkpcmV0dXJuIEFycmF5LmZyb20oZSl9KGUpfHxmdW5jdGlvbigpe3Rocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBzcHJlYWQgbm9uLWl0ZXJhYmxlIGluc3RhbmNlIil9KCl9ZnVuY3Rpb24gbyhlLHQscixuLG8saSxhKXt0cnl7dmFyIGM9ZVtpXShhKSx1PWMudmFsdWV9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgcihlKX1jLmRvbmU/dCh1KTpQcm9taXNlLnJlc29sdmUodSkudGhlbihuLG8pfWZ1bmN0aW9uIGkoZSl7cmV0dXJuIGZ1bmN0aW9uKCl7dmFyIHQ9dGhpcyxyPWFyZ3VtZW50cztyZXR1cm4gbmV3IFByb21pc2UoKGZ1bmN0aW9uKG4saSl7dmFyIGE9ZS5hcHBseSh0LHIpO2Z1bmN0aW9uIGMoZSl7byhhLG4saSxjLHUsIm5leHQiLGUpfWZ1bmN0aW9uIHUoZSl7byhhLG4saSxjLHUsInRocm93IixlKX1jKHZvaWQgMCl9KSl9fWZ1bmN0aW9uIGEoZSx0KXt2YXIgcj1PYmplY3Qua2V5cyhlKTtpZihPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKXt2YXIgbj1PYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpO3QmJihuPW4uZmlsdGVyKChmdW5jdGlvbih0KXtyZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLHQpLmVudW1lcmFibGV9KSkpLHIucHVzaC5hcHBseShyLG4pfXJldHVybiByfWZ1bmN0aW9uIGMoZSl7Zm9yKHZhciB0PTE7dDxhcmd1bWVudHMubGVuZ3RoO3QrKyl7dmFyIHI9bnVsbCE9YXJndW1lbnRzW3RdP2FyZ3VtZW50c1t0XTp7fTt0JTI/YShyLCEwKS5mb3JFYWNoKChmdW5jdGlvbih0KXt1KGUsdCxyW3RdKX0pKTpPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycz9PYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHIpKTphKHIpLmZvckVhY2goKGZ1bmN0aW9uKHQpe09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLHQsT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihyLHQpKX0pKX1yZXR1cm4gZX1mdW5jdGlvbiB1KGUsdCxyKXtyZXR1cm4gdCBpbiBlP09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLHQse3ZhbHVlOnIsZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTplW3RdPXIsZX1mdW5jdGlvbiBzKGUsdCl7aWYobnVsbD09ZSlyZXR1cm57fTt2YXIgcixuLG89ZnVuY3Rpb24oZSx0KXtpZihudWxsPT1lKXJldHVybnt9O3ZhciByLG4sbz17fSxpPU9iamVjdC5rZXlzKGUpO2ZvcihuPTA7bjxpLmxlbmd0aDtuKyspcj1pW25dLHQuaW5kZXhPZihyKT49MHx8KG9bcl09ZVtyXSk7cmV0dXJuIG99KGUsdCk7aWYoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyl7dmFyIGk9T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTtmb3Iobj0wO248aS5sZW5ndGg7bisrKXI9aVtuXSx0LmluZGV4T2Yocik+PTB8fE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLHIpJiYob1tyXT1lW3JdKX1yZXR1cm4gb312YXIgZj1yKDYpLGw9cigxKS5sb2cscD1yKDIpLGQ9cig3KSxoPXIoOCksdj1yKDEwKSxtPXYuZGVmYXVsdE9wdGlvbnMsZz12LnNwYXduV29ya2VyLHk9di50ZXJtaW5hdGVXb3JrZXIsYj12Lm9uTWVzc2FnZSx3PXYuc2VuZCx4PXYuZmV0Y2hGaWxlLGo9di5mcyxPPTA7ZS5leHBvcnRzPWZ1bmN0aW9uKCl7dmFyIGU9YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOnt9LHQ9cCgiV29ya2VyIixPKSxyPWgoYyh7fSxtLHt9LGUpKSxvPXIubG9nZ2VyLGE9ci5wcm9ncmVzcyx1PXMocixbImxvZ2dlciIsInByb2dyZXNzIl0pLHY9e30saz17fSxQPWcodSk7Tys9MTt2YXIgRT1mdW5jdGlvbihlLHQpe3ZbZV09dH0sTD1mdW5jdGlvbihlLHQpe2tbZV09dH0sRD1mdW5jdGlvbihlKXt2YXIgcj1lLmlkLG49ZS5hY3Rpb24sbz1lLnBheWxvYWQ7cmV0dXJuIG5ldyBQcm9taXNlKChmdW5jdGlvbihlLGkpe2woIlsiLmNvbmNhdCh0LCJdOiBTdGFydCAiKS5jb25jYXQociwiLCBhY3Rpb249IikuY29uY2F0KG4pKSxFKG4sZSksTChuLGkpLHcoUCx7d29ya2VySWQ6dCxqb2JJZDpyLGFjdGlvbjpuLHBheWxvYWQ6b30pfSkpfSxTPWZ1bmN0aW9uKGUpe3JldHVybiBEKGYoe2lkOmUsYWN0aW9uOiJsb2FkIixwYXlsb2FkOntvcHRpb25zOnV9fSkpfSxGPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIEQoZih7aWQ6dCxhY3Rpb246InN5bmNmcyIscGF5bG9hZDp7cG9wdWxhdGU6ZX19KSl9LFQ9ZnVuY3Rpb24oKXt2YXIgZT1pKHJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKChmdW5jdGlvbiBlKHQscil7cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDpyZXR1cm4gZS5uZXh0PTIsRigpO2Nhc2UgMjpyZXR1cm4gZS50MD1qLGUudDE9dCxlLm5leHQ9Nix4KHIpO2Nhc2UgNjpyZXR1cm4gZS50Mj1lLnNlbnQsZS5uZXh0PTksZS50MC53cml0ZUZpbGUuY2FsbChlLnQwLGUudDEsZS50Mik7Y2FzZSA5OnJldHVybiBlLm5leHQ9MTEsRighMCk7Y2FzZSAxMTpyZXR1cm4gZS5hYnJ1cHQoInJldHVybiIse3BhdGg6Ii9kYXRhLyIuY29uY2F0KHQpfSk7Y2FzZSAxMjpjYXNlImVuZCI6cmV0dXJuIGUuc3RvcCgpfX0pLGUpfSkpKTtyZXR1cm4gZnVuY3Rpb24odCxyKXtyZXR1cm4gZS5hcHBseSh0aGlzLGFyZ3VtZW50cyl9fSgpLEk9ZnVuY3Rpb24oKXt2YXIgZT1pKHJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKChmdW5jdGlvbiBlKHQscil7cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDpyZXR1cm4gZS5uZXh0PTIsRighMCk7Y2FzZSAyOnJldHVybiBlLm5leHQ9NCxqLndyaXRlRmlsZSh0LHIpO2Nhc2UgNDpyZXR1cm4gZS5uZXh0PTYsRighMCk7Y2FzZSA2OnJldHVybiBlLmFicnVwdCgicmV0dXJuIix7cGF0aDoiL2RhdGEvIi5jb25jYXQodCl9KTtjYXNlIDc6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSk7cmV0dXJuIGZ1bmN0aW9uKHQscil7cmV0dXJuIGUuYXBwbHkodGhpcyxhcmd1bWVudHMpfX0oKSxSPWZ1bmN0aW9uKCl7dmFyIGU9aShyZWdlbmVyYXRvclJ1bnRpbWUubWFyaygoZnVuY3Rpb24gZSh0KXt2YXIgcixuLG89YXJndW1lbnRzO3JldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcCgoZnVuY3Rpb24oZSl7Zm9yKDs7KXN3aXRjaChlLnByZXY9ZS5uZXh0KXtjYXNlIDA6cmV0dXJuIHI9IShvLmxlbmd0aD4xJiZ2b2lkIDAhPT1vWzFdKXx8b1sxXSxlLm5leHQ9MyxqLnJlYWRGaWxlKHQpO2Nhc2UgMzppZihuPWUuc2VudCwhcil7ZS5uZXh0PTc7YnJlYWt9cmV0dXJuIGUubmV4dD03LGouZGVsZXRlRmlsZSh0KTtjYXNlIDc6cmV0dXJuIGUuYWJydXB0KCJyZXR1cm4iLHtkYXRhOm59KTtjYXNlIDg6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSk7cmV0dXJuIGZ1bmN0aW9uKHQpe3JldHVybiBlLmFwcGx5KHRoaXMsYXJndW1lbnRzKX19KCksQj1mdW5jdGlvbigpe3ZhciBlPWkocmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoKGZ1bmN0aW9uIGUodCl7cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDpyZXR1cm4gZS5uZXh0PTIsai5kZWxldGVGaWxlKHQpO2Nhc2UgMjpyZXR1cm4gZS5hYnJ1cHQoInJldHVybiIse3BhdGg6Ii9kYXRhLyIuY29uY2F0KHQpfSk7Y2FzZSAzOmNhc2UiZW5kIjpyZXR1cm4gZS5zdG9wKCl9fSksZSl9KSkpO3JldHVybiBmdW5jdGlvbih0KXtyZXR1cm4gZS5hcHBseSh0aGlzLGFyZ3VtZW50cyl9fSgpLEE9ZnVuY3Rpb24oZSl7dmFyIHQ9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOnt9LHI9YXJndW1lbnRzLmxlbmd0aD4yP2FyZ3VtZW50c1syXTp2b2lkIDA7cmV0dXJuIEQoZih7aWQ6cixhY3Rpb246InJ1biIscGF5bG9hZDp7YXJnczplLG9wdGlvbnM6dH19KSl9LF89ZnVuY3Rpb24oZSx0KXt2YXIgcj1hcmd1bWVudHMubGVuZ3RoPjImJnZvaWQgMCE9PWFyZ3VtZW50c1syXT9hcmd1bWVudHNbMl06IiIsbj0hKGFyZ3VtZW50cy5sZW5ndGg+MyYmdm9pZCAwIT09YXJndW1lbnRzWzNdKXx8YXJndW1lbnRzWzNdLG89YXJndW1lbnRzLmxlbmd0aD40P2FyZ3VtZW50c1s0XTp2b2lkIDA7cmV0dXJuIEEoIi1pIC9kYXRhLyIuY29uY2F0KGUsIiAiKS5jb25jYXQociwiICIpLmNvbmNhdCh0KSx7aW5wdXQ6ZSxvdXRwdXQ6dCxkZWw6bn0sbyl9LE09ZnVuY3Rpb24oZSx0LHIsbil7dmFyIG89YXJndW1lbnRzLmxlbmd0aD40JiZ2b2lkIDAhPT1hcmd1bWVudHNbNF0/YXJndW1lbnRzWzRdOiIiLGk9IShhcmd1bWVudHMubGVuZ3RoPjUmJnZvaWQgMCE9PWFyZ3VtZW50c1s1XSl8fGFyZ3VtZW50c1s1XSxhPWFyZ3VtZW50cy5sZW5ndGg+Nj9hcmd1bWVudHNbNl06dm9pZCAwO3JldHVybiBBKCItaSAvZGF0YS8iLmNvbmNhdChlLCIgLXNzICIpLmNvbmNhdChyLCIgLXRvICIpLmNvbmNhdChuLCIgIikuY29uY2F0KG8sIiAiKS5jb25jYXQodCkse2lucHV0OmUsb3V0cHV0OnQsZGVsOml9LGEpfSxXPWZ1bmN0aW9uKCl7dmFyIGU9aShyZWdlbmVyYXRvclJ1bnRpbWUubWFyaygoZnVuY3Rpb24gZSh0LHIpe3ZhciBvLGksYSxjLHU9YXJndW1lbnRzO3JldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcCgoZnVuY3Rpb24oZSl7Zm9yKDs7KXN3aXRjaChlLnByZXY9ZS5uZXh0KXtjYXNlIDA6cmV0dXJuIG89dS5sZW5ndGg+MiYmdm9pZCAwIT09dVsyXT91WzJdOiIiLGk9ISh1Lmxlbmd0aD4zJiZ2b2lkIDAhPT11WzNdKXx8dVszXSxhPXUubGVuZ3RoPjQ/dVs0XTp2b2lkIDAsYz10LnJlZHVjZSgoZnVuY3Rpb24oZSx0KXtyZXR1cm4iIi5jb25jYXQoZSwiXG5maWxlICIpLmNvbmNhdCh0KX0pLCIiKSxlLm5leHQ9NixJKCJjb25jYXRfbGlzdC50eHQiLGMpO2Nhc2UgNjpyZXR1cm4gZS5hYnJ1cHQoInJldHVybiIsQSgiLWYgY29uY2F0IC1zYWZlIDAgLWkgL2RhdGEvY29uY2F0X2xpc3QudHh0IC1jIGNvcHkgIi5jb25jYXQobywiICIpLmNvbmNhdChyKSx7ZGVsOmksb3V0cHV0OnIsaW5wdXQ6W10uY29uY2F0KG4odCksWyJjb25jYXRfbGlzdC50eHQiXSl9LGEpKTtjYXNlIDc6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSk7cmV0dXJuIGZ1bmN0aW9uKHQscil7cmV0dXJuIGUuYXBwbHkodGhpcyxhcmd1bWVudHMpfX0oKSxOPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIEQoZih7aWQ6dCxhY3Rpb246IkZTIixwYXlsb2FkOnttZXRob2Q6InJlYWRkaXIiLGFyZ3M6W2VdfX0pKX0sQz1mdW5jdGlvbigpe3ZhciBlPWkocmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoKGZ1bmN0aW9uIGUodCl7cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDppZihudWxsPT09UCl7ZS5uZXh0PTU7YnJlYWt9cmV0dXJuIGUubmV4dD0zLEQoZih7aWQ6dCxhY3Rpb246InRlcm1pbmF0ZSJ9KSk7Y2FzZSAzOnkoUCksUD1udWxsO2Nhc2UgNTpyZXR1cm4gZS5hYnJ1cHQoInJldHVybiIsUHJvbWlzZS5yZXNvbHZlKCkpO2Nhc2UgNjpjYXNlImVuZCI6cmV0dXJuIGUuc3RvcCgpfX0pLGUpfSkpKTtyZXR1cm4gZnVuY3Rpb24odCl7cmV0dXJuIGUuYXBwbHkodGhpcyxhcmd1bWVudHMpfX0oKTtyZXR1cm4gYihQLChmdW5jdGlvbihlKXt2YXIgdD1lLndvcmtlcklkLHI9ZS5qb2JJZCxuPWUuc3RhdHVzLGk9ZS5hY3Rpb24sdT1lLmRhdGE7aWYoInJlc29sdmUiPT09bil7bCgiWyIuY29uY2F0KHQsIl06IENvbXBsZXRlICIpLmNvbmNhdChyKSk7dmFyIHM9dTtpZigiRlMiPT09aSl7dmFyIGY9dS5tZXRob2QscD11LmRhdGE7cz0icmVhZEZpbGUiPT09Zj9VaW50OEFycmF5LmZyb20oYyh7fSxwLHtsZW5ndGg6T2JqZWN0LmtleXMocCkubGVuZ3RofSkpOnB9dltpXSh7am9iSWQ6cixkYXRhOnN9KX1lbHNle2lmKCJyZWplY3QiPT09bil0aHJvdyBrW2ldKHUpLEVycm9yKHUpOyJwcm9ncmVzcyI9PT1uJiYoZCh1LGEpLG8odSkpfX0pKSx7aWQ6dCx3b3JrZXI6UCxzZXRSZXNvbHZlOkUsc2V0UmVqZWN0OkwsbG9hZDpTLHN5bmNmczpGLHdyaXRlOlQsd3JpdGVUZXh0OkkscmVhZDpSLHJlbW92ZTpCLHJ1bjpBLHRyYW5zY29kZTpfLHRyaW06TSxjb25jYXREZW11eGVyOlcsbHM6Tix0ZXJtaW5hdGU6Q319fSxmdW5jdGlvbihlLHQscil7dmFyIG49cigyKSxvPTA7ZS5leHBvcnRzPWZ1bmN0aW9uKGUpe3ZhciB0PWUuaWQscj1lLmFjdGlvbixpPWUucGF5bG9hZCxhPXZvaWQgMD09PWk/e306aSxjPXQ7cmV0dXJuIHZvaWQgMD09PWMmJihjPW4oIkpvYiIsbyksbys9MSkse2lkOmMsYWN0aW9uOnIscGF5bG9hZDphfX19LGZ1bmN0aW9uKGUsdCl7ZnVuY3Rpb24gcihlLHQpe3JldHVybiBmdW5jdGlvbihlKXtpZihBcnJheS5pc0FycmF5KGUpKXJldHVybiBlfShlKXx8ZnVuY3Rpb24oZSx0KXtpZighKFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QoZSl8fCJbb2JqZWN0IEFyZ3VtZW50c10iPT09T2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGUpKSlyZXR1cm47dmFyIHI9W10sbj0hMCxvPSExLGk9dm9pZCAwO3RyeXtmb3IodmFyIGEsYz1lW1N5bWJvbC5pdGVyYXRvcl0oKTshKG49KGE9Yy5uZXh0KCkpLmRvbmUpJiYoci5wdXNoKGEudmFsdWUpLCF0fHxyLmxlbmd0aCE9PXQpO249ITApO31jYXRjaChlKXtvPSEwLGk9ZX1maW5hbGx5e3RyeXtufHxudWxsPT1jLnJldHVybnx8Yy5yZXR1cm4oKX1maW5hbGx5e2lmKG8pdGhyb3cgaX19cmV0dXJuIHJ9KGUsdCl8fGZ1bmN0aW9uKCl7dGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhdHRlbXB0IHRvIGRlc3RydWN0dXJlIG5vbi1pdGVyYWJsZSBpbnN0YW5jZSIpfSgpfXZhciBuPTAsbz1mdW5jdGlvbihlKXt2YXIgdD1yKGUuc3BsaXQoIjoiKSwzKSxuPXRbMF0sbz10WzFdLGk9dFsyXTtyZXR1cm4gNjAqcGFyc2VGbG9hdChuKSo2MCs2MCpwYXJzZUZsb2F0KG8pK3BhcnNlRmxvYXQoaSl9O2UuZXhwb3J0cz1mdW5jdGlvbihlLHQpe3ZhciByPWUubWVzc2FnZTtpZigic3RyaW5nIj09dHlwZW9mIHIpaWYoci5zdGFydHNXaXRoKCIgIER1cmF0aW9uIikpe3ZhciBpPXIuc3BsaXQoIiwgIilbMF0uc3BsaXQoIjogIilbMV0sYT1vKGkpOygwPT09bnx8bj5hKSYmKG49YSl9ZWxzZSBpZihyLnN0YXJ0c1dpdGgoImZyYW1lIikpe3ZhciBjPXIuc3BsaXQoInRpbWU9IilbMV0uc3BsaXQoIiAiKVswXTt0KHtyYXRpbzpvKGMpL259KX1lbHNlIHIuc3RhcnRzV2l0aCgidmlkZW86IikmJnQoe3JhdGlvOjF9KX19LGZ1bmN0aW9uKGUsdCxyKXtmdW5jdGlvbiBuKGUsdCl7dmFyIHI9T2JqZWN0LmtleXMoZSk7aWYoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyl7dmFyIG49T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTt0JiYobj1uLmZpbHRlcigoZnVuY3Rpb24odCl7cmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSx0KS5lbnVtZXJhYmxlfSkpKSxyLnB1c2guYXBwbHkocixuKX1yZXR1cm4gcn1mdW5jdGlvbiBvKGUsdCxyKXtyZXR1cm4gdCBpbiBlP09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLHQse3ZhbHVlOnIsZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTplW3RdPXIsZX12YXIgaT0iYnJvd3NlciI9PT1yKDkpKCJ0eXBlIik/cigwKTpmdW5jdGlvbihlKXtyZXR1cm4gZX07ZS5leHBvcnRzPWZ1bmN0aW9uKGUpe3ZhciB0PWZ1bmN0aW9uKGUpe2Zvcih2YXIgdD0xO3Q8YXJndW1lbnRzLmxlbmd0aDt0Kyspe3ZhciByPW51bGwhPWFyZ3VtZW50c1t0XT9hcmd1bWVudHNbdF06e307dCUyP24ociwhMCkuZm9yRWFjaCgoZnVuY3Rpb24odCl7byhlLHQsclt0XSl9KSk6T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnM/T2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSxPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhyKSk6bihyKS5mb3JFYWNoKChmdW5jdGlvbih0KXtPYmplY3QuZGVmaW5lUHJvcGVydHkoZSx0LE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iocix0KSl9KSl9cmV0dXJuIGV9KHt9LGUpO3JldHVyblsiY29yZVBhdGgiLCJ3b3JrZXJQYXRoIl0uZm9yRWFjaCgoZnVuY3Rpb24ocil7dm9pZCAwIT09ZVtyXSYmKHRbcl09aSh0W3JdKSl9KSksdH19LGZ1bmN0aW9uKGUsdCl7ZS5leHBvcnRzPWZ1bmN0aW9uKGUpe3ZhciB0PXt0eXBlOiJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93JiZ2b2lkIDAhPT13aW5kb3cuZG9jdW1lbnQ/ImJyb3dzZXIiOiJub2RlIn07cmV0dXJuIHZvaWQgMD09PWU/dDp0W2VdfX0sZnVuY3Rpb24oZSx0LHIpe3ZhciBuPXIoMTEpLG89cigxNSksaT1yKDE2KSxhPXIoMTcpLGM9cigxOCksdT1yKDE5KSxzPXIoMjApO2UuZXhwb3J0cz17ZGVmYXVsdE9wdGlvbnM6bixzcGF3bldvcmtlcjpvLHRlcm1pbmF0ZVdvcmtlcjppLG9uTWVzc2FnZTphLHNlbmQ6YyxmZXRjaEZpbGU6dSxmczpzfX0sZnVuY3Rpb24oZSx0LHIpeyhmdW5jdGlvbih0KXtmdW5jdGlvbiBuKGUsdCl7dmFyIHI9T2JqZWN0LmtleXMoZSk7aWYoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyl7dmFyIG49T2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTt0JiYobj1uLmZpbHRlcigoZnVuY3Rpb24odCl7cmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSx0KS5lbnVtZXJhYmxlfSkpKSxyLnB1c2guYXBwbHkocixuKX1yZXR1cm4gcn1mdW5jdGlvbiBvKGUsdCxyKXtyZXR1cm4gdCBpbiBlP09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLHQse3ZhbHVlOnIsZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTplW3RdPXIsZX12YXIgaT1yKDApLGE9cigxMyksYz1hLnZlcnNpb24sdT1hLmRlcGVuZGVuY2llcyxzPXIoMTQpO2UuZXhwb3J0cz1mdW5jdGlvbihlKXtmb3IodmFyIHQ9MTt0PGFyZ3VtZW50cy5sZW5ndGg7dCsrKXt2YXIgcj1udWxsIT1hcmd1bWVudHNbdF0/YXJndW1lbnRzW3RdOnt9O3QlMj9uKHIsITApLmZvckVhY2goKGZ1bmN0aW9uKHQpe28oZSx0LHJbdF0pfSkpOk9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzP09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMocikpOm4ocikuZm9yRWFjaCgoZnVuY3Rpb24odCl7T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCxPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHIsdCkpfSkpfXJldHVybiBlfSh7fSxzLHt3b3JrZXJQYXRoOnZvaWQgMCE9PXQmJiJkZXZlbG9wbWVudCI9PT10LmVudi5GRk1QRUdfRU5WP2koIi9kaXN0L3dvcmtlci5kZXYuanM/bm9jYWNoZT0iLmNvbmNhdChNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgzKSkpOiJodHRwczovL3VucGtnLmNvbS9AZmZtcGVnL2ZmbXBlZ0B2Ii5jb25jYXQoYywiL2Rpc3Qvd29ya2VyLm1pbi5qcyIpLGNvcmVQYXRoOiJodHRwczovL3VucGtnLmNvbS9AZmZtcGVnL2NvcmVAdiIuY29uY2F0KHVbIkBmZm1wZWcvY29yZSJdLnN1YnN0cmluZygxKSwiL2ZmbXBlZy1jb3JlLmpzIiksd29ya2VyQmxvYlVSTDohMH0pfSkuY2FsbCh0aGlzLHIoMTIpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcixuLG89ZS5leHBvcnRzPXt9O2Z1bmN0aW9uIGkoKXt0aHJvdyBuZXcgRXJyb3IoInNldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBhKCl7dGhyb3cgbmV3IEVycm9yKCJjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBjKGUpe2lmKHI9PT1zZXRUaW1lb3V0KXJldHVybiBzZXRUaW1lb3V0KGUsMCk7aWYoKHI9PT1pfHwhcikmJnNldFRpbWVvdXQpcmV0dXJuIHI9c2V0VGltZW91dCxzZXRUaW1lb3V0KGUsMCk7dHJ5e3JldHVybiByKGUsMCl9Y2F0Y2godCl7dHJ5e3JldHVybiByLmNhbGwobnVsbCxlLDApfWNhdGNoKHQpe3JldHVybiByLmNhbGwodGhpcyxlLDApfX19IWZ1bmN0aW9uKCl7dHJ5e3I9ImZ1bmN0aW9uIj09dHlwZW9mIHNldFRpbWVvdXQ/c2V0VGltZW91dDppfWNhdGNoKGUpe3I9aX10cnl7bj0iZnVuY3Rpb24iPT10eXBlb2YgY2xlYXJUaW1lb3V0P2NsZWFyVGltZW91dDphfWNhdGNoKGUpe249YX19KCk7dmFyIHUscz1bXSxmPSExLGw9LTE7ZnVuY3Rpb24gcCgpe2YmJnUmJihmPSExLHUubGVuZ3RoP3M9dS5jb25jYXQocyk6bD0tMSxzLmxlbmd0aCYmZCgpKX1mdW5jdGlvbiBkKCl7aWYoIWYpe3ZhciBlPWMocCk7Zj0hMDtmb3IodmFyIHQ9cy5sZW5ndGg7dDspe2Zvcih1PXMscz1bXTsrK2w8dDspdSYmdVtsXS5ydW4oKTtsPS0xLHQ9cy5sZW5ndGh9dT1udWxsLGY9ITEsZnVuY3Rpb24oZSl7aWYobj09PWNsZWFyVGltZW91dClyZXR1cm4gY2xlYXJUaW1lb3V0KGUpO2lmKChuPT09YXx8IW4pJiZjbGVhclRpbWVvdXQpcmV0dXJuIG49Y2xlYXJUaW1lb3V0LGNsZWFyVGltZW91dChlKTt0cnl7bihlKX1jYXRjaCh0KXt0cnl7cmV0dXJuIG4uY2FsbChudWxsLGUpfWNhdGNoKHQpe3JldHVybiBuLmNhbGwodGhpcyxlKX19fShlKX19ZnVuY3Rpb24gaChlLHQpe3RoaXMuZnVuPWUsdGhpcy5hcnJheT10fWZ1bmN0aW9uIHYoKXt9by5uZXh0VGljaz1mdW5jdGlvbihlKXt2YXIgdD1uZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aC0xKTtpZihhcmd1bWVudHMubGVuZ3RoPjEpZm9yKHZhciByPTE7cjxhcmd1bWVudHMubGVuZ3RoO3IrKyl0W3ItMV09YXJndW1lbnRzW3JdO3MucHVzaChuZXcgaChlLHQpKSwxIT09cy5sZW5ndGh8fGZ8fGMoZCl9LGgucHJvdG90eXBlLnJ1bj1mdW5jdGlvbigpe3RoaXMuZnVuLmFwcGx5KG51bGwsdGhpcy5hcnJheSl9LG8udGl0bGU9ImJyb3dzZXIiLG8uYnJvd3Nlcj0hMCxvLmVudj17fSxvLmFyZ3Y9W10sby52ZXJzaW9uPSIiLG8udmVyc2lvbnM9e30sby5vbj12LG8uYWRkTGlzdGVuZXI9dixvLm9uY2U9dixvLm9mZj12LG8ucmVtb3ZlTGlzdGVuZXI9dixvLnJlbW92ZUFsbExpc3RlbmVycz12LG8uZW1pdD12LG8ucHJlcGVuZExpc3RlbmVyPXYsby5wcmVwZW5kT25jZUxpc3RlbmVyPXYsby5saXN0ZW5lcnM9ZnVuY3Rpb24oZSl7cmV0dXJuW119LG8uYmluZGluZz1mdW5jdGlvbihlKXt0aHJvdyBuZXcgRXJyb3IoInByb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkIil9LG8uY3dkPWZ1bmN0aW9uKCl7cmV0dXJuIi8ifSxvLmNoZGlyPWZ1bmN0aW9uKGUpe3Rocm93IG5ldyBFcnJvcigicHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkIil9LG8udW1hc2s9ZnVuY3Rpb24oKXtyZXR1cm4gMH19LGZ1bmN0aW9uKGUpe2UuZXhwb3J0cz1KU09OLnBhcnNlKCd7Im5hbWUiOiJAZmZtcGVnL2ZmbXBlZyIsInZlcnNpb24iOiIwLjUuMiIsImRlc2NyaXB0aW9uIjoiRkZtcGVnIFdlYkFzc2VtYmx5IHZlcnNpb24iLCJtYWluIjoic3JjL2luZGV4LmpzIiwiZGlyZWN0b3JpZXMiOnsiZXhhbXBsZSI6ImV4YW1wbGVzIn0sInNjcmlwdHMiOnsic3RhcnQiOiJub2RlIHNjcmlwdHMvc2VydmVyLmpzIiwiYnVpbGQiOiJyaW1yYWYgZGlzdCAmJiB3ZWJwYWNrIC0tY29uZmlnIHNjcmlwdHMvd2VicGFjay5jb25maWcucHJvZC5qcyIsInByZXB1Ymxpc2hPbmx5IjoibnBtIHJ1biBidWlsZCIsImxpbnQiOiJlc2xpbnQgc3JjIiwid2FpdCI6InJpbXJhZiBkaXN0ICYmIHdhaXQtb24gaHR0cDovL2xvY2FsaG9zdDozMDAwL2Rpc3QvZmZtcGVnLmRldi5qcyIsInRlc3QiOiJucG0tcnVuLWFsbCAtcCAtciBzdGFydCB0ZXN0OmFsbCIsInRlc3Q6YWxsIjoibnBtLXJ1bi1hbGwgd2FpdCB0ZXN0Om5vZGU6YWxsIiwidGVzdDpub2RlIjoibnljIG1vY2hhIC0tZXhpdCAtLWJhaWwgLS1yZXF1aXJlIC4vc2NyaXB0cy90ZXN0LWhlbHBlci5qcyIsInRlc3Q6bm9kZTphbGwiOiJucG0gcnVuIHRlc3Q6bm9kZSAtLSAuL3Rlc3RzLyoudGVzdC5qcyIsInRlc3Q6YnJvd3NlciI6Im1vY2hhLWhlYWRsZXNzLWNocm9tZSAtYSBpbmNvZ25pdG8gLWEgbm8tc2FuZGJveCAtYSBkaXNhYmxlLXNldHVpZC1zYW5kYm94IC1hIGRpc2FibGUtbG9nZ2luZyAtdCAzMDAwMDAiLCJ0ZXN0OmJyb3dzZXI6ZmZtcGVnIjoibnBtIHJ1biB0ZXN0OmJyb3dzZXIgLS0gLWYgLi90ZXN0cy9mZm1wZWcudGVzdC5odG1sIn0sImJyb3dzZXIiOnsiLi9zcmMvd29ya2VyL25vZGUvaW5kZXguanMiOiIuL3NyYy93b3JrZXIvYnJvd3Nlci9pbmRleC5qcyJ9LCJyZXBvc2l0b3J5Ijp7InR5cGUiOiJnaXQiLCJ1cmwiOiJnaXQraHR0cHM6Ly9naXRodWIuY29tL2ZmbXBlZ2pzL2ZmbXBlZy5qcy5naXQifSwia2V5d29yZHMiOlsiZmZtcGVnIiwiV2ViQXNzZW1ibHkiLCJ2aWRlbyJdLCJhdXRob3IiOiJKZXJvbWUgV3UgPGplcm9tZXd1c0BnbWFpbC5jb20+IiwibGljZW5zZSI6Ik1JVCIsImJ1Z3MiOnsidXJsIjoiaHR0cHM6Ly9naXRodWIuY29tL2ZmbXBlZ2pzL2ZmbXBlZy5qcy9pc3N1ZXMifSwiaG9tZXBhZ2UiOiJodHRwczovL2dpdGh1Yi5jb20vZmZtcGVnanMvZmZtcGVnLmpzI3JlYWRtZSIsImRlcGVuZGVuY2llcyI6eyJAZmZtcGVnL2NvcmUiOiJeMC41LjAiLCJpZGIiOiJeNC4wLjUiLCJpcy11cmwiOiJeMS4yLjQiLCJub2RlLWZldGNoIjoiXjIuNi4wIiwicmVnZW5lcmF0b3ItcnVudGltZSI6Il4wLjEzLjMiLCJyZXNvbHZlLXVybCI6Il4wLjIuMSJ9LCJkZXZEZXBlbmRlbmNpZXMiOnsiQGJhYmVsL2NvcmUiOiJeNy42LjQiLCJAYmFiZWwvcHJlc2V0LWVudiI6Il43LjYuMyIsImJhYmVsLWxvYWRlciI6Il44LjAuNiIsImNvcnMiOiJeMi44LjUiLCJlc2xpbnQiOiJeNi4xLjAiLCJlc2xpbnQtY29uZmlnLWFpcmJuYi1iYXNlIjoiXjE0LjAuMCIsImVzbGludC1wbHVnaW4taW1wb3J0IjoiXjIuMTguMiIsImV4cGVjdC5qcyI6Il4wLjMuMSIsImV4cHJlc3MiOiJeNC4xNy4xIiwibW9jaGEiOiJeNi4yLjIiLCJtb2NoYS1oZWFkbGVzcy1jaHJvbWUiOiJeMi4wLjMiLCJucG0tcnVuLWFsbCI6Il40LjEuNSIsIm55YyI6Il4xNC4xLjEiLCJ3YWl0LW9uIjoiXjMuMy4wIiwid2VicGFjayI6Il40LjQxLjIiLCJ3ZWJwYWNrLWNsaSI6Il4zLjMuOSIsIndlYnBhY2stZGV2LW1pZGRsZXdhcmUiOiJeMy43LjIifX0nKX0sZnVuY3Rpb24oZSx0KXtlLmV4cG9ydHM9e2xvZ2dlcjpmdW5jdGlvbigpe30scHJvZ3Jlc3M6ZnVuY3Rpb24oKXt9fX0sZnVuY3Rpb24oZSx0KXtlLmV4cG9ydHM9ZnVuY3Rpb24oZSl7dmFyIHQscj1lLndvcmtlclBhdGgsbj1lLndvcmtlckJsb2JVUkw7aWYoQmxvYiYmVVJMJiZuKXt2YXIgbz1uZXcgQmxvYihbJ2ltcG9ydFNjcmlwdHMoIicuY29uY2F0KHIsJyIpOycpXSx7dHlwZToiYXBwbGljYXRpb24vamF2YXNjcmlwdCJ9KTt0PW5ldyBXb3JrZXIoVVJMLmNyZWF0ZU9iamVjdFVSTChvKSl9ZWxzZSB0PW5ldyBXb3JrZXIocik7cmV0dXJuIHR9fSxmdW5jdGlvbihlLHQpe2UuZXhwb3J0cz1mdW5jdGlvbihlKXtlLnRlcm1pbmF0ZSgpfX0sZnVuY3Rpb24oZSx0KXtlLmV4cG9ydHM9ZnVuY3Rpb24oZSx0KXtlLm9ubWVzc2FnZT1mdW5jdGlvbihlKXt2YXIgcj1lLmRhdGE7dChyKX19fSxmdW5jdGlvbihlLHQpe2Z1bmN0aW9uIHIoZSx0LHIsbixvLGksYSl7dHJ5e3ZhciBjPWVbaV0oYSksdT1jLnZhbHVlfWNhdGNoKGUpe3JldHVybiB2b2lkIHIoZSl9Yy5kb25lP3QodSk6UHJvbWlzZS5yZXNvbHZlKHUpLnRoZW4obixvKX1lLmV4cG9ydHM9ZnVuY3Rpb24oKXt2YXIgZSx0PShlPXJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKChmdW5jdGlvbiBlKHQscil7cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDp0LnBvc3RNZXNzYWdlKHIpO2Nhc2UgMTpjYXNlImVuZCI6cmV0dXJuIGUuc3RvcCgpfX0pLGUpfSkpLGZ1bmN0aW9uKCl7dmFyIHQ9dGhpcyxuPWFyZ3VtZW50cztyZXR1cm4gbmV3IFByb21pc2UoKGZ1bmN0aW9uKG8saSl7dmFyIGE9ZS5hcHBseSh0LG4pO2Z1bmN0aW9uIGMoZSl7cihhLG8saSxjLHUsIm5leHQiLGUpfWZ1bmN0aW9uIHUoZSl7cihhLG8saSxjLHUsInRocm93IixlKX1jKHZvaWQgMCl9KSl9KTtyZXR1cm4gZnVuY3Rpb24oZSxyKXtyZXR1cm4gdC5hcHBseSh0aGlzLGFyZ3VtZW50cyl9fSgpfSxmdW5jdGlvbihlLHQscil7ZnVuY3Rpb24gbihlLHQscixuLG8saSxhKXt0cnl7dmFyIGM9ZVtpXShhKSx1PWMudmFsdWV9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgcihlKX1jLmRvbmU/dCh1KTpQcm9taXNlLnJlc29sdmUodSkudGhlbihuLG8pfXZhciBvPXIoMCksaT1mdW5jdGlvbihlKXtyZXR1cm4gbmV3IFByb21pc2UoKGZ1bmN0aW9uKHQscil7dmFyIG49bmV3IEZpbGVSZWFkZXI7bi5vbmxvYWQ9ZnVuY3Rpb24oKXt0KG4ucmVzdWx0KX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3ZhciB0PWUudGFyZ2V0LmVycm9yLmNvZGU7cihFcnJvcigiRmlsZSBjb3VsZCBub3QgYmUgcmVhZCEgQ29kZT0iLmNvbmNhdCh0KSkpfSxuLnJlYWRBc0FycmF5QnVmZmVyKGUpfSkpfTtlLmV4cG9ydHM9ZnVuY3Rpb24oKXt2YXIgZSx0PShlPXJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKChmdW5jdGlvbiBlKHQpe3ZhciByLG47cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDppZihyPXQsdm9pZCAwIT09dCl7ZS5uZXh0PTM7YnJlYWt9cmV0dXJuIGUuYWJydXB0KCJyZXR1cm4iLCJ1bmRlZmluZWQiKTtjYXNlIDM6aWYoInN0cmluZyIhPXR5cGVvZiB0KXtlLm5leHQ9MTY7YnJlYWt9aWYoIS9kYXRhOl9kYXRhXC8oW2EtekEtWl0qKTtiYXNlNjQsKFteIl0qKS8udGVzdCh0KSl7ZS5uZXh0PTg7YnJlYWt9cj1hdG9iKHQuc3BsaXQoIiwiKVsxXSkuc3BsaXQoIiIpLm1hcCgoZnVuY3Rpb24oZSl7cmV0dXJuIGUuY2hhckNvZGVBdCgwKX0pKSxlLm5leHQ9MTQ7YnJlYWs7Y2FzZSA4OnJldHVybiBlLm5leHQ9MTAsZmV0Y2gobyh0KSk7Y2FzZSAxMDpyZXR1cm4gbj1lLnNlbnQsZS5uZXh0PTEzLG4uYXJyYXlCdWZmZXIoKTtjYXNlIDEzOnI9ZS5zZW50O2Nhc2UgMTQ6ZS5uZXh0PTIwO2JyZWFrO2Nhc2UgMTY6aWYoISh0IGluc3RhbmNlb2YgRmlsZXx8dCBpbnN0YW5jZW9mIEJsb2IpKXtlLm5leHQ9MjA7YnJlYWt9cmV0dXJuIGUubmV4dD0xOSxpKHQpO2Nhc2UgMTk6cj1lLnNlbnQ7Y2FzZSAyMDpyZXR1cm4gZS5hYnJ1cHQoInJldHVybiIsbmV3IFVpbnQ4QXJyYXkocikpO2Nhc2UgMjE6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSxmdW5jdGlvbigpe3ZhciB0PXRoaXMscj1hcmd1bWVudHM7cmV0dXJuIG5ldyBQcm9taXNlKChmdW5jdGlvbihvLGkpe3ZhciBhPWUuYXBwbHkodCxyKTtmdW5jdGlvbiBjKGUpe24oYSxvLGksYyx1LCJuZXh0IixlKX1mdW5jdGlvbiB1KGUpe24oYSxvLGksYyx1LCJ0aHJvdyIsZSl9Yyh2b2lkIDApfSkpfSk7cmV0dXJuIGZ1bmN0aW9uKGUpe3JldHVybiB0LmFwcGx5KHRoaXMsYXJndW1lbnRzKX19KCl9LGZ1bmN0aW9uKGUsdCxyKXtmdW5jdGlvbiBuKGUsdCxyKXtyZXR1cm4gdCBpbiBlP09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLHQse3ZhbHVlOnIsZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTplW3RdPXIsZX1mdW5jdGlvbiBvKGUsdCxyLG4sbyxpLGEpe3RyeXt2YXIgYz1lW2ldKGEpLHU9Yy52YWx1ZX1jYXRjaChlKXtyZXR1cm4gdm9pZCByKGUpfWMuZG9uZT90KHUpOlByb21pc2UucmVzb2x2ZSh1KS50aGVuKG4sbyl9ZnVuY3Rpb24gaShlKXtyZXR1cm4gZnVuY3Rpb24oKXt2YXIgdD10aGlzLHI9YXJndW1lbnRzO3JldHVybiBuZXcgUHJvbWlzZSgoZnVuY3Rpb24obixpKXt2YXIgYT1lLmFwcGx5KHQscik7ZnVuY3Rpb24gYyhlKXtvKGEsbixpLGMsdSwibmV4dCIsZSl9ZnVuY3Rpb24gdShlKXtvKGEsbixpLGMsdSwidGhyb3ciLGUpfWModm9pZCAwKX0pKX19dmFyIGEsYyx1LHM9cigyMSkub3BlbkRCLGY9ZnVuY3Rpb24oKXtyZXR1cm4gcygiL2RhdGEiLDIxKX0sbD1mdW5jdGlvbigpe3ZhciBlPWkocmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoKGZ1bmN0aW9uIGUodCl7dmFyIHIsbjtyZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoKGZ1bmN0aW9uKGUpe2Zvcig7Oylzd2l0Y2goZS5wcmV2PWUubmV4dCl7Y2FzZSAwOnJldHVybiBlLm5leHQ9Mix0LmdldCgiRklMRV9EQVRBIiwiL2RhdGEvLkRVTU1ZIik7Y2FzZSAyOnJldHVybiByPWUuc2VudCxuPU9iamVjdC5rZXlzKHIpLmZpbHRlcigoZnVuY3Rpb24oZSl7cmV0dXJuIVsibW9kZSIsInRpbWVzdGFtcCJdLmluY2x1ZGVzKGUpfSkpLnBvcCgpLGUuYWJydXB0KCJyZXR1cm4iLHtkYXRhS2V5Om4sbW9kZTpyLm1vZGV9KTtjYXNlIDU6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSk7cmV0dXJuIGZ1bmN0aW9uKHQpe3JldHVybiBlLmFwcGx5KHRoaXMsYXJndW1lbnRzKX19KCk7ZS5leHBvcnRzPXtyZWFkRmlsZToodT1pKHJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKChmdW5jdGlvbiBlKHQpe3ZhciByLG4sbztyZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoKGZ1bmN0aW9uKGUpe2Zvcig7Oylzd2l0Y2goZS5wcmV2PWUubmV4dCl7Y2FzZSAwOnJldHVybiBlLm5leHQ9MixmKCk7Y2FzZSAyOnJldHVybiByPWUuc2VudCxlLm5leHQ9NSxsKHIpO2Nhc2UgNTpyZXR1cm4gbj1lLnNlbnQsbz1uLmRhdGFLZXksZS5uZXh0PTksci5nZXQoIkZJTEVfREFUQSIsIi9kYXRhLyIuY29uY2F0KHQpKTtjYXNlIDk6cmV0dXJuIGUudDA9byxlLmFicnVwdCgicmV0dXJuIixlLnNlbnRbZS50MF0pO2Nhc2UgMTE6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSksZnVuY3Rpb24oZSl7cmV0dXJuIHUuYXBwbHkodGhpcyxhcmd1bWVudHMpfSksd3JpdGVGaWxlOihjPWkocmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoKGZ1bmN0aW9uIGUodCxyKXt2YXIgbyxpLGEsYyx1O3JldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcCgoZnVuY3Rpb24oZSl7Zm9yKDs7KXN3aXRjaChlLnByZXY9ZS5uZXh0KXtjYXNlIDA6cmV0dXJuIGUubmV4dD0yLGYoKTtjYXNlIDI6cmV0dXJuIGk9ZS5zZW50LGUubmV4dD01LGwoaSk7Y2FzZSA1OnJldHVybiBhPWUuc2VudCxjPWEuZGF0YUtleSx1PWEubW9kZSxlLm5leHQ9MTAsaS5wdXQoIkZJTEVfREFUQSIsKG4obz17fSxjLHIpLG4obywibW9kZSIsdSksbihvLCJ0aW1lc3RhbXAiLG5ldyBEYXRlKSxvKSwiL2RhdGEvIi5jb25jYXQodCkpO2Nhc2UgMTA6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSksZnVuY3Rpb24oZSx0KXtyZXR1cm4gYy5hcHBseSh0aGlzLGFyZ3VtZW50cyl9KSxkZWxldGVGaWxlOihhPWkocmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoKGZ1bmN0aW9uIGUodCl7dmFyIHI7cmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKChmdW5jdGlvbihlKXtmb3IoOzspc3dpdGNoKGUucHJldj1lLm5leHQpe2Nhc2UgMDpyZXR1cm4gZS5uZXh0PTIsZigpO2Nhc2UgMjpyZXR1cm4gcj1lLnNlbnQsZS5uZXh0PTUsci5kZWxldGUoIkZJTEVfREFUQSIsIi9kYXRhLyIuY29uY2F0KHQpKTtjYXNlIDU6Y2FzZSJlbmQiOnJldHVybiBlLnN0b3AoKX19KSxlKX0pKSksZnVuY3Rpb24oZSl7cmV0dXJuIGEuYXBwbHkodGhpcyxhcmd1bWVudHMpfSl9fSxmdW5jdGlvbihlLHQscil7InVzZSBzdHJpY3QiO3Iucih0KTtjb25zdCBuPShlLHQpPT50LnNvbWUodD0+ZSBpbnN0YW5jZW9mIHQpO2xldCBvLGk7Y29uc3QgYT1uZXcgV2Vha01hcCxjPW5ldyBXZWFrTWFwLHU9bmV3IFdlYWtNYXAscz1uZXcgV2Vha01hcCxmPW5ldyBXZWFrTWFwO2xldCBsPXtnZXQoZSx0LHIpe2lmKGUgaW5zdGFuY2VvZiBJREJUcmFuc2FjdGlvbil7aWYoImRvbmUiPT09dClyZXR1cm4gYy5nZXQoZSk7aWYoIm9iamVjdFN0b3JlTmFtZXMiPT09dClyZXR1cm4gZS5vYmplY3RTdG9yZU5hbWVzfHx1LmdldChlKTtpZigic3RvcmUiPT09dClyZXR1cm4gci5vYmplY3RTdG9yZU5hbWVzWzFdP3ZvaWQgMDpyLm9iamVjdFN0b3JlKHIub2JqZWN0U3RvcmVOYW1lc1swXSl9cmV0dXJuIGgoZVt0XSl9LGhhczooZSx0KT0+ZSBpbnN0YW5jZW9mIElEQlRyYW5zYWN0aW9uJiYoImRvbmUiPT09dHx8InN0b3JlIj09PXQpfHx0IGluIGV9O2Z1bmN0aW9uIHAoZSl7cmV0dXJuIGUhPT1JREJEYXRhYmFzZS5wcm90b3R5cGUudHJhbnNhY3Rpb258fCJvYmplY3RTdG9yZU5hbWVzImluIElEQlRyYW5zYWN0aW9uLnByb3RvdHlwZT8oaXx8KGk9W0lEQkN1cnNvci5wcm90b3R5cGUuYWR2YW5jZSxJREJDdXJzb3IucHJvdG90eXBlLmNvbnRpbnVlLElEQkN1cnNvci5wcm90b3R5cGUuY29udGludWVQcmltYXJ5S2V5XSkpLmluY2x1ZGVzKGUpP2Z1bmN0aW9uKC4uLnQpe3JldHVybiBlLmFwcGx5KHYodGhpcyksdCksaChhLmdldCh0aGlzKSl9OmZ1bmN0aW9uKC4uLnQpe3JldHVybiBoKGUuYXBwbHkodih0aGlzKSx0KSl9OmZ1bmN0aW9uKHQsLi4ucil7Y29uc3Qgbj1lLmNhbGwodih0aGlzKSx0LC4uLnIpO3JldHVybiB1LnNldChuLHQuc29ydD90LnNvcnQoKTpbdF0pLGgobil9fWZ1bmN0aW9uIGQoZSl7cmV0dXJuImZ1bmN0aW9uIj09dHlwZW9mIGU/cChlKTooZSBpbnN0YW5jZW9mIElEQlRyYW5zYWN0aW9uJiZmdW5jdGlvbihlKXtpZihjLmhhcyhlKSlyZXR1cm47Y29uc3QgdD1uZXcgUHJvbWlzZSgodCxyKT0+e2NvbnN0IG49KCk9PntlLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNvbXBsZXRlIixvKSxlLnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIixpKSxlLnJlbW92ZUV2ZW50TGlzdGVuZXIoImFib3J0IixpKX0sbz0oKT0+e3QoKSxuKCl9LGk9KCk9PntyKGUuZXJyb3IpLG4oKX07ZS5hZGRFdmVudExpc3RlbmVyKCJjb21wbGV0ZSIsbyksZS5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsaSksZS5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsaSl9KTtjLnNldChlLHQpfShlKSxuKGUsb3x8KG89W0lEQkRhdGFiYXNlLElEQk9iamVjdFN0b3JlLElEQkluZGV4LElEQkN1cnNvcixJREJUcmFuc2FjdGlvbl0pKT9uZXcgUHJveHkoZSxsKTplKX1mdW5jdGlvbiBoKGUpe2lmKGUgaW5zdGFuY2VvZiBJREJSZXF1ZXN0KXJldHVybiBmdW5jdGlvbihlKXtjb25zdCB0PW5ldyBQcm9taXNlKCh0LHIpPT57Y29uc3Qgbj0oKT0+e2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3VjY2VzcyIsbyksZS5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsaSl9LG89KCk9Pnt0KGgoZS5yZXN1bHQpKSxuKCl9LGk9KCk9PntyKGUuZXJyb3IpLG4oKX07ZS5hZGRFdmVudExpc3RlbmVyKCJzdWNjZXNzIixvKSxlLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIixpKX0pO3JldHVybiB0LnRoZW4odD0+e3QgaW5zdGFuY2VvZiBJREJDdXJzb3ImJmEuc2V0KHQsZSl9KS5jYXRjaCgoKT0+e30pLGYuc2V0KHQsZSksdH0oZSk7aWYocy5oYXMoZSkpcmV0dXJuIHMuZ2V0KGUpO2NvbnN0IHQ9ZChlKTtyZXR1cm4gdCE9PWUmJihzLnNldChlLHQpLGYuc2V0KHQsZSkpLHR9Y29uc3Qgdj1lPT5mLmdldChlKTtmdW5jdGlvbiBtKGUsdCx7YmxvY2tlZDpyLHVwZ3JhZGU6bixibG9ja2luZzpvfT17fSl7Y29uc3QgaT1pbmRleGVkREIub3BlbihlLHQpLGE9aChpKTtyZXR1cm4gbiYmaS5hZGRFdmVudExpc3RlbmVyKCJ1cGdyYWRlbmVlZGVkIixlPT57bihoKGkucmVzdWx0KSxlLm9sZFZlcnNpb24sZS5uZXdWZXJzaW9uLGgoaS50cmFuc2FjdGlvbikpfSksciYmaS5hZGRFdmVudExpc3RlbmVyKCJibG9ja2VkIiwoKT0+cigpKSxvJiZhLnRoZW4oZT0+ZS5hZGRFdmVudExpc3RlbmVyKCJ2ZXJzaW9uY2hhbmdlIixvKSkuY2F0Y2goKCk9Pnt9KSxhfWZ1bmN0aW9uIGcoZSx7YmxvY2tlZDp0fT17fSl7Y29uc3Qgcj1pbmRleGVkREIuZGVsZXRlRGF0YWJhc2UoZSk7cmV0dXJuIHQmJnIuYWRkRXZlbnRMaXN0ZW5lcigiYmxvY2tlZCIsKCk9PnQoKSksaChyKS50aGVuKCgpPT52b2lkIDApfXIuZCh0LCJvcGVuREIiLChmdW5jdGlvbigpe3JldHVybiBtfSkpLHIuZCh0LCJkZWxldGVEQiIsKGZ1bmN0aW9uKCl7cmV0dXJuIGd9KSksci5kKHQsInVud3JhcCIsKGZ1bmN0aW9uKCl7cmV0dXJuIHZ9KSksci5kKHQsIndyYXAiLChmdW5jdGlvbigpe3JldHVybiBofSkpO2NvbnN0IHk9WyJnZXQiLCJnZXRLZXkiLCJnZXRBbGwiLCJnZXRBbGxLZXlzIiwiY291bnQiXSxiPVsicHV0IiwiYWRkIiwiZGVsZXRlIiwiY2xlYXIiXSx3PW5ldyBNYXA7ZnVuY3Rpb24geChlLHQpe2lmKCEoZSBpbnN0YW5jZW9mIElEQkRhdGFiYXNlKXx8dCBpbiBlfHwic3RyaW5nIiE9dHlwZW9mIHQpcmV0dXJuO2lmKHcuZ2V0KHQpKXJldHVybiB3LmdldCh0KTtjb25zdCByPXQucmVwbGFjZSgvRnJvbUluZGV4JC8sIiIpLG49dCE9PXIsbz1iLmluY2x1ZGVzKHIpO2lmKCEociBpbihuP0lEQkluZGV4OklEQk9iamVjdFN0b3JlKS5wcm90b3R5cGUpfHwhbyYmIXkuaW5jbHVkZXMocikpcmV0dXJuO2NvbnN0IGk9YXN5bmMgZnVuY3Rpb24oZSwuLi50KXtjb25zdCBpPXRoaXMudHJhbnNhY3Rpb24oZSxvPyJyZWFkd3JpdGUiOiJyZWFkb25seSIpO2xldCBhPWkuc3RvcmU7biYmKGE9YS5pbmRleCh0LnNoaWZ0KCkpKTtjb25zdCBjPWFbcl0oLi4udCk7cmV0dXJuIG8mJmF3YWl0IGkuZG9uZSxjfTtyZXR1cm4gdy5zZXQodCxpKSxpfWw9KGU9Pih7Z2V0Oih0LHIsbik9PngodCxyKXx8ZS5nZXQodCxyLG4pLGhhczoodCxyKT0+ISF4KHQscil8fGUuaGFzKHQscil9KSkobCl9XSl9KSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWZmbXBlZy5taW4uanMubWFw"}]},{"name":"FBSanitizer","options":{"check_for_updates":true,"comment":null,"compatopts_for_requires":true,"compat_wrappedjsobject":false,"compat_metadata":false,"compat_foreach":false,"compat_arrayleft":false,"compat_uW_gmonkey":false,"compat_forvarin":false,"noframes":null,"awareOfChrome":false,"run_at":null,"override":{"use_includes":[],"orig_includes":["*"],"merge_includes":true,"use_matches":[],"orig_matches":[],"merge_matches":true,"use_excludes":[],"orig_excludes":[],"merge_excludes":true,"use_connects":[],"merge_connects":true,"use_blockers":[],"orig_run_at":"document-start","orig_noframes":null,"orig_connects":[]}},"storage":{"ts":1582950305903,"data":{}},"enabled":true,"position":2,"uuid":"678a46de-d523-41d9-a9d5-a734b9ee6321","source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICBGQlNhbml0aXplcgovLyBAbmFtZXNwYWNlICAgIGFyaXN1Lm1sCi8vIEB2ZXJzaW9uICAgICAgMC4xCi8vIEBkZXNjcmlwdGlvbiAgUmVtb3ZlIHRoYXQgc3R1cGlkIGZiY2xpZCBzbyB1IGNhbiBzaGFyZSBsaW5rIHdpdCBoZnJpZW5kcwovLyBAYXV0aG9yICAgICAgIEx5Y2h3ZWUKLy8gQGluY2x1ZGUgICAgICAqCi8vIEBncmFudCAgICAgICAgbm9uZQovLyBAcnVuLWF0IGRvY3VtZW50LXN0YXJ0Ci8vID09L1VzZXJTY3JpcHQ9PQp3aW5kb3cub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICBpZiAod2luZG93LmxvY2F0aW9uLmhyZWYuaW5kZXhPZigidXRtX3NvdXJjZT0iKSAhPSAtMSkgewogICAgICAgIHVybCA9IHVybC5zcGxpdCgidXRtX3NvdXJjZT0iKVswXS5zbGljZSgwLCAtMSk7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICB9CiAgICBpZiAod2luZG93LmxvY2F0aW9uLmhyZWYuaW5kZXhPZigiZmJjbGlkPSIpICE9IC0xKSB7CiAgICAgICAgdXJsID0gdXJsLnNwbGl0KCJmYmNsaWQ9IilbMF0uc2xpY2UoMCwgLTEpOwogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gdXJsOwogICAgfQp9"}]}